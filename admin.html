<!doctype html>
<meta charset="utf-8" />
<title>Admin (RPC)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>

<style>
    :root {
        --card: #ffffff; --muted:#f6f7f9; --line:#e6e8ee; --text:#1b1f23;
        --primary:#0ea5e9; --ok:#16a34a; --warn:#f59e0b;
    }
    * { box-sizing: border-box; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif;
        margin: 0; color: var(--text); background: #fafbfc;
    }
    header {
        position: sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid var(--line);
        padding: 14px 18px; display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .tabs { display:flex; gap:8px; flex-wrap:wrap; }
    .tabbtn {
        padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer;
    }
    .tabbtn.active { background: var(--primary); color:#fff; border-color: var(--primary); }
    main { padding: 18px; max-width: 1100px; margin: 0 auto; }
    .card { background: var(--card); border:1px solid var(--line); border-radius:14px; padding:16px; margin-bottom:16px; }
    .row { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin: 10px 0; }
    input, select, textarea {
        padding:10px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; min-height:40px;
    }
    button { padding:10px 14px; border:1px solid var(--line); border-radius:10px; background:#fff; cursor:pointer; }
    button.primary { background: var(--primary); color:#fff; border-color: var(--primary); }
    button.ghost { background:#fff; }
    .muted { color:#6b7280; font-size: 13px; }
    .grid { display:grid; gap:12px; }
    .grid.catalog { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
    .gamecard { border:1px solid var(--line); border-radius:12px; padding:10px; background:#fff; }
    .gameimg { height:110px; background:var(--muted); border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden; margin-bottom:8px; }
    .gameimg img { max-width:100%; max-height:110px; display:block; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border:1px solid var(--line); padding:8px; text-align:left; }
    th { background: var(--muted); }
    code.inline { background:#f1f5f9; padding:2px 6px; border-radius:6px; border:1px solid var(--line); }
    #qrWrap > div { display:inline-block;margin:8px;padding:8px;border:1px solid var(--line);border-radius:12px;text-align:center;background:#fff; }
</style>

<header>
    <div class="row">
        <strong>Admin</strong>
        <span id="authStatus" class="muted"></span>
        <span id="classBadge" class="muted" style="margin-left:8px"></span> <!-- ğŸ”¸ ì¶”ê°€: í˜„ì¬ ë°˜ ë°°ì§€ -->
        <button id="loginBtn" onclick="signIn()" class="ghost">ë¡œê·¸ì¸</button>
    </div>
    <div class="tabs">
        <button class="tabbtn active" data-tab="tab-class" onclick="showTab('tab-class', this)">ë°˜/QR</button>
        <button class="tabbtn" data-tab="tab-index" onclick="showTab('tab-index', this)">ì¸ë±ìŠ¤/ì¹´íƒˆë¡œê·¸</button>
        <button class="tabbtn" data-tab="tab-launch" onclick="showTab('tab-launch', this)">ì‹œì‘ ë²„íŠ¼ ì„¤ì •</button>
        <button class="tabbtn" data-tab="tab-analytics" onclick="showTab('tab-analytics', this)">ë¶„ì„(ìŠ¤ëƒ…ìƒ·)</button>
    </div>
</header>

<main>
    <!-- ë°˜/QR -->
    <section id="tab-class" class="tab card">
        <h2>ë°˜ ê´€ë¦¬ & í•™ìƒ ì½”ë“œ/QR</h2>
        <div class="row">
            <button onclick="createTempClass()" class="primary">ì„ì‹œ ë°˜ ìƒì„±</button>
            <button onclick="exportCodes()">ì½”ë“œ CSV ì €ì¥</button>
            <span class="muted">ìƒì„± í›„ ì•„ë˜ì—ì„œ ë°˜ ì„ íƒ ê°€ëŠ¥</span>
        </div>

        <div class="row">
            <button onclick="loadMyClasses(true)">ë‚´ ë°˜ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <select id="classSelect" style="min-width:360px"></select>
            <button onclick="chooseSelectedClass()">ì„ íƒí•œ ë°˜ìœ¼ë¡œ ì„¤ì •</button>
            <button onclick="setClassIdManually()">class_id ìˆ˜ë™ ì…ë ¥</button>
        </div>
        <div class="row">í˜„ì¬ class_id: <code class="inline" id="classId"></code></div>

        <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">

        <h3>QR í† í°</h3>
        <div class="row">
            <input id="ttlMin" type="number" value="60" style="width:120px"> ë¶„ ìœ íš¨
            <label><input type="checkbox" id="singleUse"> ì‹±ê¸€ ìœ ì¦ˆ</label>
            <button onclick="issueQRTokens()">QR í† í° ë°œê¸‰</button>
            <button onclick="renderQRTokens()">QR í‘œì‹œ</button>
        </div>
        <div id="qrWrap" class="row"></div>
    </section>

    <!-- ì¸ë±ìŠ¤/ì¹´íƒˆë¡œê·¸ -->
    <section id="tab-index" class="tab card" style="display:none">
        <h2>ë§ì¶¤ ì¸ë±ìŠ¤ (ê²Œì„ ì¹´íƒˆë¡œê·¸ì—ì„œ í† ê¸€ ì„ íƒ)</h2>

        <div class="card" style="background:#fbfdff">
            <div class="row">
                <input id="catalogUrl" style="min-width:520px" placeholder="ê²Œì„ ëª©ë¡ JSON URL (ì˜ˆ: https://.../games.json)">
                <input id="catalogFilter" placeholder="ê²€ìƒ‰(ì œëª©/íƒœê·¸)" oninput="filterCatalog()">
                <button onclick="loadCatalog()" class="primary">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                <button onclick="selectAllGames(true)">ì „ì²´ ì„ íƒ</button>
                <button onclick="selectAllGames(false)">ì „ì²´ í•´ì œ</button>
            </div>
            <div id="catalogGrid" class="grid catalog"></div>
        </div>

        <div class="card">
            <div class="row">
                <input id="idxSlug"  placeholder="ìŠ¬ëŸ¬ê·¸ (ì˜ˆ: week1)">
                <input id="idxTitle" placeholder="ì œëª© (ì˜ˆ: 1ì£¼ì°¨ í™œë™)" style="min-width:320px">
                <button onclick="saveIndexFromSelection()" class="primary">ì„ íƒ í•­ëª©ìœ¼ë¡œ ì¸ë±ìŠ¤ ì €ì¥</button>
                <button onclick="listIndexes()">ë‚´ ì¸ë±ìŠ¤ ë³´ê¸°</button>
            </div>
            <div class="row">
                <select id="idxSelect" style="min-width:360px"></select>
                <button onclick="assignIndexToClass()">í˜„ì¬ ë°˜ ì „ì²´ ë°°ì •</button>
                <button onclick="assignIndexToLabels()">ì„ íƒ í•™ìƒ ë¼ë²¨ ë°°ì •</button>
            </div>
            <p class="muted">* ì €ì¥ ì‹œ DB í…Œì´ë¸” <code class="inline">indexes</code> / <code class="inline">index_assignments</code> ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.</p>
        </div>
        
        <!-- í˜„ì¬ ë°˜ ì•ˆë‚´ + ë¹ ë¥¸ ë°°ì • -->
        <div class="card" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
            <div>í˜„ì¬ ë°˜: <code class="inline" id="classBadgeInline"></code></div>
            <div class="row">
                <select id="idxSelect" style="min-width:260px"></select>
                <button onclick="assignIndexToClass()" title="ìœ„ì—ì„œ ì„ íƒí•œ ì¸ë±ìŠ¤ë¥¼ í˜„ì¬ ë°˜ ì „ì²´ì— ë°°ì •">í˜„ì¬ ë°˜ ì „ì²´ ë°°ì •</button>
                <button onclick="document.querySelector('[data-tab=\\'tab-class\\']').click()">ë°˜ ë°”ê¾¸ê¸°</button>
            </div>
        </div>

        <!-- ì¸ë±ìŠ¤ ì €ì¥ ì§í›„ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="card">
            <div class="row" style="justify-content:space-between">
                <div><strong>ì¸ë±ìŠ¤ ë¯¸ë¦¬ë³´ê¸°</strong> <span class="muted">(* ì €ì¥ í›„ ìë™ ê°±ì‹ )</span></div>
                <label><input type="checkbox" id="autoAssign"> ì €ì¥ í›„ í˜„ì¬ ë°˜ì— ë°”ë¡œ ë°°ì •</label>
            </div>
            <div id="idxPreview" class="grid catalog"></div>
        </div>


    </section>

    <!-- ì‹œì‘ ë²„íŠ¼ ì„¤ì • -->
    <section id="tab-launch" class="tab card" style="display:none">
        <h2>í•™ìƒ í˜ì´ì§€ì˜ â€œê²Œì„ ì‹œì‘â€ ë²„íŠ¼</h2>
        <div class="row">
            <button onclick="loadLaunchSettings()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <input id="launchUrl" placeholder="ê²Œì„ URL (ì˜ˆ: https://.../FlappyBoat.html)" style="min-width:520px">
            <label><input type="checkbox" id="allowLaunch"> ê²Œì„ ì‹œì‘ ë²„íŠ¼ í™œì„±í™”</label>
            <button onclick="saveLaunchSettings()" class="primary">ì„¤ì • ì €ì¥</button>
        </div>
        <p class="muted">* í•™ìƒì€ <code class="inline">student_view.html</code> ì—ì„œ í† í°/ì½”ë“œë¡œ ì ‘ì† ì‹œ, í—ˆìš©ë˜ë©´ í•´ë‹¹ URLë¡œ ë°”ë¡œ ì´ë™í•©ë‹ˆë‹¤.</p>
    </section>

    <!-- ë¶„ì„(ìŠ¤ëƒ…ìƒ·) -->
    <section id="tab-analytics" class="tab card" style="display:none">
        <h2>ë°˜ ìŠ¤ëƒ…ìƒ·</h2>
        <div class="row">
            <button onclick="showSnapshot()" class="primary">ë‚´ ë°˜ ìŠ¤ëƒ…ìƒ· ë³´ê¸°</button>
        </div>
        <canvas id="classRadar" width="360" height="360" style="max-width:420px"></canvas>
        <div class="card">
            <table>
                <thead>
                <tr>
                    <th>í•™ìƒ</th><th>Reaction</th><th>Timing</th><th>Literacy</th><th>Problem</th><th>Strategy</th><th>Persistence</th><th>ê¸°ë¡ì‹œê°</th>
                </tr>
                </thead>
                <tbody id="snapshotBody"></tbody>
            </table>
        </div>

        <pre id="out" style="white-space:pre-wrap"></pre>
    </section>
</main>

<script>
    /** === Supabase ì„¤ì • === **/
    const SUPA_URL = "https://nfkjolrlegftyvxyrpfr.supabase.co";
    const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ma2pvbHJsZWdmdHl2eHlycGZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTI3NzgsImV4cCI6MjA3NTg4ODc3OH0.p2IhcLKDqNdbDWu6w6R_dvsxubvWf6xtNOqlSkWTSpY";
    const supa = supabase.createClient(SUPA_URL, ANON_KEY);
    const DEFAULT_CATALOG_URL = "https://unluckyidiot16.github.io/WebGames/games.json";
    let _catalogLoadedOnce = false;


    /** === ì „ì—­ ìƒíƒœ === **/
    let lastClassId = null;
    let lastCodes = null;        // createTempClass ì‘ë‹µ codes (í•„ìš”ì‹œ ì‚¬ìš©)
    let lastTokens = [];         // [{label, token}]
    let radarChart = null;

    // í•™ìƒ ë·° í˜ì´ì§€(í† í° QR ë§í¬ìš©)
    const STUDENT_VIEW_URL = "https://unluckyidiot16.github.io/WebGames/student_view.html";

    /** === ìœ í‹¸ / íƒ­ === **/
    function showTab(id, btn){
        document.querySelectorAll('.tab').forEach(s => s.style.display='none');
        document.getElementById(id).style.display='block';
        document.querySelectorAll('.tabbtn').forEach(b=>b.classList.remove('active'));
        if (btn) btn.classList.add('active');

        if (id === 'tab-index'){
            syncClassBadges();     // ğŸ”¸ í˜„ì¬ ë°˜ ë°°ì§€ ë™ê¸°í™”
            listIndexes().catch(()=>{});
            if (!_catalogLoadedOnce) {
                const el = document.getElementById('catalogUrl');
                if (el && !el.value) el.value = DEFAULT_CATALOG_URL;
                if (el && el.value) {
                    loadCatalog().catch(()=>{});
                    _catalogLoadedOnce = true;
                }
            }
        }
    }


    // ì²« ë¡œë”© ì‹œ, í˜„ì¬ active íƒ­ ë³´ì´ê¸° ë³´ì¥
    document.addEventListener('DOMContentLoaded', () => {
        const first = document.querySelector('.tabbtn.active')?.dataset.tab || 'tab-class';
        showTab(first, document.querySelector('.tabbtn.active'));
    });

    /** === ë°˜/ì½”ë“œ === **/
    async function createTempClass(){
        const session = (await supa.auth.getSession()).data.session;
        if (!session) return alert("ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.");
        const name = prompt("ë°˜ ì´ë¦„", "Temp Class");
        const count = Number(prompt("í•™ìƒ ìˆ˜", "10"));
        const { data, error } = await supa.rpc('rpc_create_temp_class', { _name: name, _student_count: count });
        if (error) return alert(error.message);

        lastClassId = data.class_id || data.class?.id || null;
        lastCodes   = data.codes || [];
        document.getElementById("classId").textContent = lastClassId || '';
        document.getElementById("out").textContent = JSON.stringify(data, null, 2);
        await loadMyClasses(true);
    }

    async function loadMyClasses(selectNewest=false){
        const session = (await supa.auth.getSession()).data.session;
        if (!session) return alert("ë¨¼ì € ë¡œê·¸ì¸í•˜ì„¸ìš”.");

        const { data, error } = await supa.from('classes').select('id,name,created_at').order('created_at', { ascending: false });
        if (error) return alert(error.message);

        const sel = document.getElementById('classSelect');
        sel.innerHTML = '';
        (data || []).forEach(cls => {
            const opt = document.createElement('option');
            opt.value = cls.id;
            opt.textContent = `${cls.name} â€” ${cls.id}`;
            sel.appendChild(opt);
        });
        if (data?.length){
            if (selectNewest || !lastClassId) lastClassId = data[0].id;
            sel.value = lastClassId;
            document.getElementById("classId").textContent = lastClassId;
        }
    }
    function chooseSelectedClass(){
        const sel = document.getElementById('classSelect');
        if (!sel.value) return alert("ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.");
        lastClassId = sel.value;
        document.getElementById("classId").textContent = lastClassId;
    }
    function setClassIdManually(){
        const id = prompt("class_id ì…ë ¥:"); if (!id) return;
        lastClassId = id.trim();
        document.getElementById("classId").textContent = lastClassId;
    }
    function exportCodes(){
        if (!lastCodes || !lastCodes.length) return alert("ë¨¼ì € ì„ì‹œ ë°˜ì„ ìƒì„±í•˜ì„¸ìš”.");
        const rows = ['code', ...lastCodes];
        const blob = new Blob([rows.join('\n')], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'student_codes.csv'; a.click();
    }

    /** === QR í† í° === **/
    async function issueQRTokens(){
        if (!lastClassId) return alert("ë¨¼ì € ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.");
        const ttl = Number(document.getElementById('ttlMin').value || '60');
        const singleUse = document.getElementById('singleUse').checked;

        const { data, error } = await supa.rpc('rpc_issue_or_renew_qr_tokens', {
            _class_id: lastClassId,
            _ttl_minutes: ttl,
            _single_use: singleUse
        });
        if (error) return alert(error.message);

        lastTokens = (data || []).map(d => ({
            label: d.display_label || '',
            token: d.token,
            expires_at: d.expires_at
        }));

        alert(`ì™„ë£Œ: ${lastTokens.length}ê±´ (í™œì„± í† í°ì´ ìˆìœ¼ë©´ TTL ì—°ì¥, ì—†ìœ¼ë©´ ì‹ ê·œ ë°œê¸‰)`);
        renderQRTokens(); // ë°”ë¡œ í‘œì‹œ
    }

    async function renderQRTokens(){
        if (!lastClassId) return alert("ë¨¼ì € ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.");
        const singleUse = document.getElementById('singleUse').checked;

        if (!lastTokens.length){
            const { data, error } = await supa.rpc('rpc_list_active_qr_tokens', {
                _class_id: lastClassId,
                _single_use: singleUse
            });
            if (error) return alert(error.message);
            lastTokens = (data || []).map(d => ({
                label: d.display_label || '',
                token: d.token,
                expires_at: d.expires_at
            }));
            if (!lastTokens.length) return alert('í™œì„± í† í°ì´ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë°œê¸‰/ì—°ì¥ì„ ì‹¤í–‰í•˜ì„¸ìš”.');
        }

        const box = document.getElementById('qrWrap');
        box.innerHTML = '';
        lastTokens.forEach((row, i) => {
            const url = `${STUDENT_VIEW_URL}?t=${encodeURIComponent(row.token)}`;
            const card = document.createElement('div');
            const ctn = document.createElement('div');
            new QRCode(ctn, { text: url, width: 128, height: 128 });

            const cap = document.createElement('div');
            cap.textContent = row.label || ('S'+String(i+1).padStart(2,'0'));
            cap.style.marginTop = '6px';

            const small = document.createElement('div');
            const exp = row.expires_at ? new Date(row.expires_at).toLocaleString() : '-';
            small.innerHTML = `${url}<br><span class="muted">ë§Œë£Œ: ${exp}</span>`;
            small.style.cssText='font-size:12px;color:#888;max-width:180px;overflow-wrap:anywhere;margin-top:4px;';

            card.appendChild(ctn); card.appendChild(cap); card.appendChild(small);
            box.appendChild(card);
        });
    }


    /** === ì‹œì‘ ë²„íŠ¼ ì„¤ì • === **/
    async function loadLaunchSettings(){
        if (!lastClassId) return alert("ë¨¼ì € ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.");
        const { data, error } = await supa.rpc('rpc_get_class_settings', { _class_id: lastClassId });
        if (error) return alert(error.message);
        const row = (data && data[0]) || {};
        document.getElementById('allowLaunch').checked = !!row.allow_launch;
        document.getElementById('launchUrl').value = row.launch_game_url || '';
    }
    async function saveLaunchSettings(){
        if (!lastClassId) return alert("ë¨¼ì € ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.");
        const allow = document.getElementById('allowLaunch').checked;
        const url   = document.getElementById('launchUrl').value || null;
        const { error } = await supa.rpc('rpc_set_class_launch', { _class_id: lastClassId, _allow: allow, _url: url });
        if (error) return alert(error.message);
        alert('ì €ì¥ ì™„ë£Œ');
    }

    /** === ë¶„ì„(ìŠ¤ëƒ…ìƒ·) === **/
    async function showSnapshot(){
        if (!lastClassId) return alert("ë¨¼ì € ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.");
        const { data, error } = await supa.rpc('rpc_class_snapshot', { _class_id: lastClassId });
        if (error) return alert(error.message);

        const keys = ['reaction','timing','literacy','problem','strategy','persistence'];
        const sums = {reaction:0,timing:0,literacy:0,problem:0,strategy:0,persistence:0}; let cnt=0;
        (data||[]).forEach(r => { if (!r.axes) return; cnt++; keys.forEach(k=> sums[k]+= (r.axes[k]??0)); });
        const avg = keys.map(k => cnt? (sums[k]/cnt) : 0);

        const ctx = document.getElementById('classRadar').getContext('2d');
        if (radarChart) radarChart.destroy();
        radarChart = new Chart(ctx, { type:'radar',
            data:{ labels: ['Reaction','Timing','Literacy','Problem','Strategy','Persistence'], datasets:[{ label:'ë°˜ í‰ê· ', data: avg }] },
            options:{ scales:{ r:{ min:0, max:1, ticks:{ stepSize:0.2 } } }, plugins:{ legend:{ display:false } } }
        });

        const tbody = document.getElementById('snapshotBody'); tbody.innerHTML='';
        (data||[]).forEach(r=>{
            const a=r.axes||{}; const tr=document.createElement('tr');
            tr.innerHTML = `
      <td>${r.display_label ?? ''}</td>
      <td>${(a.reaction ?? 0).toFixed(2)}</td>
      <td>${(a.timing ?? 0).toFixed(2)}</td>
      <td>${(a.literacy ?? 0).toFixed(2)}</td>
      <td>${(a.problem ?? 0).toFixed(2)}</td>
      <td>${(a.strategy ?? 0).toFixed(2)}</td>
      <td>${(a.persistence ?? 0).toFixed(2)}</td>
      <td>${r.created_at ? new Date(r.created_at).toLocaleString() : '-'}</td>`;
            tbody.appendChild(tr);
        });
        document.getElementById('out').textContent = JSON.stringify(data, null, 2);
    }

    /** === ì¸ë±ìŠ¤/ì¹´íƒˆë¡œê·¸ === **/
    let CATALOG = [];                 // ì „ì²´ ê²Œì„ ëª©ë¡
    let CATALOG_VIEW = [];            // í•„í„° ì ìš© í›„
    let SELECTED_SLUGS = new Set();   // ì„ íƒëœ ê²Œì„ slug

    function normalizeGame(g, idx){
        const slug = (g.slug || g.id || (g.title||('game'+idx))).toString()
            .toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-_]/g,'');
        return {
            slug,
            title: g.title || ('Game '+idx),
            url: g.url || '#',
            thumb: g.thumb || g.image || '',
            desc: g.desc || g.description || '',
            tags: Array.isArray(g.tags)? g.tags : (g.tags ? [g.tags] : []),
            updated: g.updated || g.updated_at || ''
        };
    }
    function gameCardHTML(game){
        const checked = SELECTED_SLUGS.has(game.slug) ? 'checked' : '';
        const tags = (game.tags||[]).join(', ');
        return `
  <div class="gamecard">
    <div class="gameimg">${game.thumb ? `<img src="${game.thumb}" alt="">` : '<div class="muted">No image</div>'}</div>
    <div style="font-weight:600">${game.title}</div>
    <div class="muted" style="word-break:break-all">${game.url}</div>
    <div class="muted" style="margin:6px 0">${tags}</div>
    <label class="row" style="margin:6px 0 0">
      <input type="checkbox" data-slug="${game.slug}" ${checked} onchange="toggleSelect(this)">
      ì´ ê²Œì„ í¬í•¨
    </label>
  </div>`;
    }


    function renderCatalog(){
        const grid = document.getElementById('catalogGrid');
        grid.innerHTML = CATALOG_VIEW.map(gameCardHTML).join('');
    }
    function filterCatalog(){
        const q = (document.getElementById('catalogFilter').value||'').toLowerCase().trim();
        if (!q) { CATALOG_VIEW = [...CATALOG]; renderCatalog(); return; }
        CATALOG_VIEW = CATALOG.filter(g => (g.title||'').toLowerCase().includes(q) ||
            (g.tags||[]).join(',').toLowerCase().includes(q));
        renderCatalog();
    }
    function toggleSelect(cb){
        const slug = cb.getAttribute('data-slug');
        if (cb.checked) SELECTED_SLUGS.add(slug); else SELECTED_SLUGS.delete(slug);
    }
    function selectAllGames(on){
        SELECTED_SLUGS = new Set(on ? CATALOG.map(g=>g.slug) : []);
        renderCatalog();
    }

    function gamePreviewCard(g){
    const tags = (g.tags||[]).join(', ');
    return `
  <div class="gamecard">
    <div class="gameimg">${g.thumb ? `<img src="${g.thumb}" alt="">` : '<div class="muted">No image</div>'}</div>
    <div style="font-weight:600">${g.title||''}</div>
    <div class="muted" style="word-break:break-all">${g.url||''}</div>
    <div class="muted" style="margin:6px 0">${tags}</div>
  </div>`;
    }

    function renderIndexPreview(games){
    const box = document.getElementById('idxPreview');
    box.innerHTML = (games && games.length) ? games.map(gamePreviewCard).join('') : '<div class="muted">ì„ íƒ/ì €ì¥ëœ ê²Œì„ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    // í—¤ë” ë°°ì§€ì™€ ì¸ë±ìŠ¤ íƒ­ ë°°ì§€ ë™ê¸°í™”
    function syncClassBadges(){
    document.getElementById('classBadgeInline').textContent = lastClassId || '';
    }


    function setCurrentClass(id){
        lastClassId = id || null;
        document.getElementById("classId").textContent = lastClassId || '';
        const badge = document.getElementById('classBadge');
        badge.textContent = lastClassId ? `í˜„ì¬ ë°˜: ${lastClassId}` : '';
        localStorage.setItem('lastClassId', lastClassId || '');
        syncClassBadges(); // ğŸ”¸ ì¶”ê°€
    }

    // DOMContentLoaded ì‹œ ë¡œì»¬ ë³µêµ¬
    document.addEventListener('DOMContentLoaded', () => {
        const saved = localStorage.getItem('lastClassId');
        if (saved) setCurrentClass(saved);
        const first = document.querySelector('.tabbtn.active')?.dataset.tab || 'tab-class';
        showTab(first, document.querySelector('.tabbtn.active'));
    });

    async function loadCatalog(){
        const url = document.getElementById('catalogUrl').value.trim();
        if (!url) return alert('ê²Œì„ ëª©ë¡ JSON URLì„ ì…ë ¥í•˜ì„¸ìš”.');
        try{
            const res = await fetch(url, { cache:'no-cache' });
            if (!res.ok) throw new Error(await res.text());
            const arr = await res.json();
            if (!Array.isArray(arr)) throw new Error('JSON ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
            CATALOG = arr.map(normalizeGame);
            CATALOG_VIEW = [...CATALOG];
            SELECTED_SLUGS = new Set();
            renderCatalog();
            alert(`ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ${CATALOG.length}ê°œ`);
        }catch(e){ alert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: '+e.message); }
    }

    async function saveIndexFromSelection(){
    const slug  = (document.getElementById('idxSlug').value||'').trim();
    const title = (document.getElementById('idxTitle').value||'').trim();
    if (!slug || !title) return alert('ìŠ¬ëŸ¬ê·¸/ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”.');
    if (!CATALOG.length) return alert('ë¨¼ì € ê²Œì„ ì¹´íƒˆë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì„¸ìš”.');

    const chosen = CATALOG
        .filter(g => SELECTED_SLUGS.has(g.slug))
        .map(g => ({ title:g.title, url:g.url, thumb:g.thumb, desc:g.desc, tags:g.tags, updated:g.updated }));

    if (!chosen.length) return alert('ì„ íƒëœ ê²Œì„ì´ ì—†ìŠµë‹ˆë‹¤.');

    const { error } = await supa.rpc('rpc_upsert_index', { _slug: slug, _title: title, _games: chosen });
    if (error) return alert(error.message);

    // âœ… ì €ì¥ ì§í›„ ë¯¸ë¦¬ë³´ê¸° ë Œë”
    renderIndexPreview(chosen);

    // ì¸ë±ìŠ¤ ì…€ë ‰íŠ¸ ê°±ì‹ 
    await listIndexes();

    // ì˜µì…˜: ìë™ ë°°ì •
    const auto = document.getElementById('autoAssign')?.checked;
    if (auto){
        if (!lastClassId) {
            alert('í˜„ì¬ ë°˜ì´ ì„¤ì •ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ìƒë‹¨ ë°°ì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
        } else {
            const { error: err2 } = await supa.rpc('rpc_assign_index_class', { _class_id: lastClassId, _slug: slug });
            if (err2) return alert('ë°°ì • ì‹¤íŒ¨: ' + err2.message);
            alert('ì¸ë±ìŠ¤ ì €ì¥ ë° í˜„ì¬ ë°˜ì— ë°°ì • ì™„ë£Œ');
        }
    } else {
        alert('ì¸ë±ìŠ¤ ì €ì¥ ì™„ë£Œ');
    }
    }


    async function listIndexes(){
        const { data, error } = await supa.rpc('rpc_list_indexes');
        if (error) return alert(error.message);
        const sel = document.getElementById('idxSelect'); sel.innerHTML='';
        (data||[]).forEach(i => { const opt=document.createElement('option'); opt.value=i.slug; opt.textContent=`${i.title} (${i.slug})`; sel.appendChild(opt); });
    }
    async function assignIndexToClass(){
        if (!lastClassId) return alert('ë¨¼ì € ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.');
        const slug = document.getElementById('idxSelect').value; if (!slug) return alert('ì¸ë±ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        const { error } = await supa.rpc('rpc_assign_index_class', { _class_id: lastClassId, _slug: slug });
        if (error) return alert(error.message);
        alert('ë°˜ ì „ì²´ì— ë°°ì • ì™„ë£Œ');
    }
    async function assignIndexToLabels(){
        if (!lastClassId) return alert('ë¨¼ì € ë°˜ì„ ì„ íƒí•˜ì„¸ìš”.');
        const slug = document.getElementById('idxSelect').value; if (!slug) return alert('ì¸ë±ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        const labels = prompt('ë°°ì •í•  í•™ìƒ ë¼ë²¨ì„ ì‰¼í‘œë¡œ êµ¬ë¶„í•´ ì…ë ¥ (ì˜ˆ: S01,S02,S03)')||'';
        const arr = labels.split(',').map(s=>s.trim()).filter(Boolean);
        const { error } = await supa.rpc('rpc_assign_index_students', { _class_id: lastClassId, _slug: slug, _labels: arr });
        if (error) return alert(error.message);
        alert('ì„ íƒ í•™ìƒ ë°°ì • ì™„ë£Œ');
    }

    async function updateAuthUI(){
        const { data } = await supa.auth.getSession();
        const user = data?.session?.user || null;
        const loginBtn = document.getElementById('loginBtn');
        const authStatus = document.getElementById('authStatus');
        if (user){
            if (loginBtn) loginBtn.style.display = 'none';
            if (authStatus) authStatus.textContent = `âœ… ë¡œê·¸ì¸ë¨: ${user.email || user.user_metadata?.email || user.id}`;
        } else {
            if (loginBtn) loginBtn.style.display = '';
            if (authStatus) authStatus.textContent = '';
        }
    }

    supa.auth.onAuthStateChange(() => { updateAuthUI(); });

    async function signIn(){
        const email = prompt("ì´ë©”ì¼:"); if (!email) return;
        const password = prompt("ë¹„ë°€ë²ˆí˜¸:"); if (!password) return;
        const { error } = await supa.auth.signInWithPassword({ email, password });
        if (error) alert(error.message);
        await updateAuthUI();
    }

    // ì´ˆê¸° 1íšŒ
    updateAuthUI();
    
</script>
