import React, { useState, useEffect } from "react";
import {
Sword,
Map,
BookOpen,
ShoppingBag,
Trophy,
Settings,
ChevronLeft,
Star,
Send,
CheckCircle,
XCircle,
Clock,
Loader,
} from "lucide-react";

/**
* ------------------------------------------------------------------
* ì„¤ì • ë° ë°ì´í„° (Configuration & Data)
* ------------------------------------------------------------------
*/

const POKE_API_BASE =
"https://pokeapi.co/api/v2";
const IMG_BASE_ART =
"https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork";
const IMG_BASE_SPRITE =
"https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon";

const KOREAN_QUIZ_PATH = "/quiz/ko-spell-g1-missing-001.json";

// íƒí—˜ì—ì„œ ì‚¬ìš©í•  í¬ì¼“ëª¬ í’€ (1ì„¸ëŒ€ + 8Â·9ì„¸ëŒ€ ëª‡ ë§ˆë¦¬)
const EXPLORE_SPECIES_POOL = [
// 1ì„¸ëŒ€ 1~151
...Array.from({ length: 151 }, (_, i) => i + 1),
// 8ì„¸ëŒ€ ìŠ¤íƒ€íŒ… & ì¸ê¸° í¬ì¼“ëª¬
810, 811, 812, // ë‚˜ë¬´ì§€ê¸° ê³„ì—´ (ì‹¤ì œëŠ” ë‹¤ë¥¸ ë²ˆí˜¸ì§€ë§Œ ì˜ˆì‹œìš©)
813, 814, 815, // ë¶ˆê½ƒ
816, 817, 818, // ë¬¼
835, 836, // ë©íŒŒì¹˜ ê³„ì—´
// 9ì„¸ëŒ€ ìŠ¤íƒ€íŒ… & ëª‡ ë§ˆë¦¬
906, 907, 908,
909, 910, 911,
912, 913, 914,
921, 922,
];

// ìƒì  ì•„ì´í…œ
const SHOP_ITEMS = [
{
id: "poke_ball",
name: "ëª¬ìŠ¤í„°ë³¼",
price: 10,
type: "ball",
catchRate: 1.0,
icon: "ğŸ”´",
},
{
id: "great_ball",
name: "ìˆ˜í¼ë³¼",
price: 20,
type: "ball",
catchRate: 1.5,
icon: "ğŸ”µ",
},
{
id: "lucky_charm",
name: "í–‰ìš´ë¶€ì ",
price: 50,
type: "buff",
effect: "lucky",
duration: 3, // íƒí—˜ 3íšŒ ë™ì•ˆ
icon: "ğŸ€",
},
{
id: "repel",
name: "ë²Œë ˆê¸°í”¼ì œ",
price: 30,
type: "buff",
effect: "repel",
duration: 3, // íƒí—˜ 3íšŒ ë™ì•ˆ
icon: "ğŸŒ«ï¸",
},
];

/**
* ------------------------------------------------------------------
* ìœ í‹¸ë¦¬í‹°
* ------------------------------------------------------------------
*/

function shuffleArray(arr: any[]) {
return [...arr].sort(() => Math.random() - 0.5);
}

// PEM ìŠ¤íƒ€ì¼ ìˆ˜í•™ ë¬¸ì œ (ë§ì…ˆ + ëº„ì…ˆ)
function genMathProblem() {
const useSubtraction = Math.random() < 0.5;

if (!useSubtraction) {
// ë§ì…ˆ: ê²°ê³¼ 2~20
const s = Math.floor(Math.random() * 19) + 2; // 2~20
const a = Math.floor(Math.random() * (s - 1)) + 1; // 1~(s-1)
const correct = s;

let options = [s, s + 1, s - 1, s + 2].map(String);
options = shuffleArray([...new Set(options)]);
while (options.length < 4) {
const extra = String(Math.floor(Math.random() * 20));
if (!options.includes(extra)) options.push(extra);
}

return {
q: `${a} + ${s - a} = ?`,
answer: String(correct),
options,
};
} else {
// ëº„ì…ˆ
const a = Math.floor(Math.random() * 19) + 1;
const b = Math.floor(Math.random() * a);
const r = a - b;

let options = [r, r + 1, r + 2, Math.abs(r - 1)].map(String);
options = shuffleArray([...new Set(options)]);
while (options.length < 4) {
const extra = String(Math.floor(Math.random() * 20));
if (!options.includes(extra)) options.push(extra);
}

return {
q: `${a} - ${b} = ?`,
answer: String(r),
options,
};
}
}

// ko-spell-g1-missing-001.json í•œ ë¬¸ì œë¥¼ ë‚´ë¶€ í¬ë§·ìœ¼ë¡œ ì •ê·œí™”
function normalizeKoreanItem(item: any) {
const q =
item.q ||
item.question ||
item.prompt ||
item.text;

let options =
item.options ||
item.choices ||
item.choice ||
[];

let answer =
item.a ||
item.answer ||
item.correct ||
null;

if (
!answer &&
typeof item.answerIndex === "number" &&
options[item.answerIndex] != null
) {
answer = options[item.answerIndex];
}
if (
!answer &&
typeof item.answer_index === "number" &&
options[item.answer_index] != null
) {
answer = options[item.answer_index];
}

if (!q || !answer) return null;

if (!options || !options.length) {
const wrong = item.wrong || [];
options = [...wrong, answer];
}

return {
q,
answer: String(answer),
options: shuffleArray(options.map(String)),
};
}

// PokÃ©APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í•œêµ­ì–´ ì´ë¦„ + í‚¤ + ìŠ¤íƒ¯)
async function fetchPokemonData(id: number) {
try {
// 1. ê¸°ë³¸ ì •ë³´ (ìŠ¤íƒ¯, íƒ€ì…)
const res = await fetch(
`${POKE_API_BASE}/pokemon/${id}`
);
const data = await res.json();

// 2. ì¢… ì •ë³´ (í•œêµ­ì–´ ì´ë¦„)
const speciesRes = await fetch(
`${POKE_API_BASE}/pokemon-species/${id}`
);
const speciesData = await speciesRes.json();

const koreanNameEntry = speciesData.names.find(
(n: any) => n.language.name === "ko"
);
const koreanName = koreanNameEntry
? koreanNameEntry.name
: data.name;

const hpStat =
data.stats.find(
(s: any) => s.stat.name === "hp"
)?.base_stat || 45;

return {
id: data.id,
name: koreanName,
type: data.types[0].type.name,
baseHp: hpStat,
height: data.height || 10, // 10dm = 1m ê¸°ì¤€
baseStats: {
hp: hpStat,
atk:
data.stats.find(
(s: any) =>
s.stat.name === "attack"
)?.base_stat || 50,
def:
data.stats.find(
(s: any) =>
s.stat.name === "defense"
)?.base_stat || 50,
spd:
data.stats.find(
(s: any) => s.stat.name === "speed"
)?.base_stat || 50,
},
imgArt: `${IMG_BASE_ART}/${data.id}.png`,
imgSprite: `${IMG_BASE_SPRITE}/${data.id}.png`,
rarity:
speciesData.is_legendary ||
speciesData.is_mythical
? 4
: hpStat > 70
? 3
: hpStat > 50
? 2
: 1,
};
} catch (error) {
console.error(
"Failed to fetch pokemon",
error
);
// ì‹¤íŒ¨ ì‹œ 10ë²ˆ ìºí„°í”¼(ì„ì‹œ)
return {
id: 10,
name: "ìºí„°í”¼(í†µì‹ ì˜¤ë¥˜)",
type: "bug",
baseHp: 40,
height: 3,
baseStats: {
hp: 40,
atk: 30,
def: 35,
spd: 45,
},
imgArt: `${IMG_BASE_ART}/10.png`,
imgSprite: `${IMG_BASE_SPRITE}/10.png`,
rarity: 1,
};
}
}

/**
* ------------------------------------------------------------------
* ë©”ì¸ ì»´í¬ë„ŒíŠ¸
* ------------------------------------------------------------------
*/

export default function App() {
// --- ìƒíƒœ ê´€ë¦¬ ---
const [screen, setScreen] = useState<
| "login"
| "main"
| "training"
| "explore"
| "challenge"
| "shop"
| "pokedex"
| "export"
>("login");
const [user, setUser] = useState<{
name: string;
coins: number;
inventory: Record<string, number>;
}>({
name: "",
coins: 100,
inventory: { poke_ball: 5 },
});
const [pokemons, setPokemons] = useState<any[]>(
[]
); // { uid, speciesId, name, level, xp, hp... }
const [partnerId, setPartnerId] =
useState<number | null>(null);
    const [buffs, setBuffs] = useState<{
    lucky: number;
    repel: number;
    }>({ lucky: 0, repel: 0 });
    const [exportSent, setExportSent] =
    useState(false);

    // êµ­ì–´ ë¬¸ì œ í’€
    const [koreanPool, setKoreanPool] = useState<
    any[]
    >([]);
    const [koreanLoaded, setKoreanLoaded] =
    useState(false);

    // ë¡œë”© ìƒíƒœ
    const [isLoading, setIsLoading] =
    useState(false);
    const [loadingMsg, setLoadingMsg] =
    useState("");

    // ê²Œì„ ì„¸ì…˜ ìƒíƒœ
    const [trainingState, setTrainingState] =
    useState<any | null>(null);
        const [exploreState, setExploreState] =
        useState<any | null>(null);
            const [challengeState, setChallengeState] =
            useState<any | null>(null);

                // --- ì´ˆê¸°í™” & ì €ì¥ ---
                useEffect(() => {
                const saved = localStorage.getItem(
                "pem_pokeapi_v2"
                );
                if (saved) {
                try {
                const parsed = JSON.parse(saved);
                setUser(parsed.user);
                setPokemons(parsed.pokemons || []);
                setPartnerId(parsed.partnerId || null);
                setBuffs(
                parsed.buffs || { lucky: 0, repel: 0 }
                );
                setScreen("main");
                } catch (e) {
                console.error(
                "Failed to parse save",
                e
                );
                }
                }
                }, []);

                // êµ­ì–´ JSON ë¡œë“œ
                useEffect(() => {
                fetch(KOREAN_QUIZ_PATH)
                .then((res) => res.json())
                .then((data) => {
                const normalized = (
                Array.isArray(data)
                ? data
                : data.items || []
                )
                .map(normalizeKoreanItem)
                .filter(Boolean);
                setKoreanPool(normalized);
                setKoreanLoaded(true);
                })
                .catch((err) => {
                console.error(
                "Failed to load korean quiz json",
                err
                );
                setKoreanPool([]);
                setKoreanLoaded(false);
                });
                }, []);

                // ì €ì¥
                useEffect(() => {
                if (user.name && pokemons.length > 0) {
                localStorage.setItem(
                "pem_pokeapi_v2",
                JSON.stringify({
                user,
                pokemons,
                partnerId,
                buffs,
                })
                );
                }
                }, [user, pokemons, partnerId, buffs]);

                // --- ê³µí†µ í—¬í¼ ---
                const addPokemon = (data: any) => {
                const newMon = {
                uid: Date.now() + Math.random(),
                speciesId: data.id,
                name: data.name,
                type: data.type,
                imgArt: data.imgArt,
                imgSprite: data.imgSprite,
                level: 1,
                xp: 0,
                maxXp: 100,
                hp: data.baseHp,
                maxHp: data.baseHp,
                rarity: data.rarity,
                height: data.height || 10,
                baseStats:
                data.baseStats || {
                hp: data.baseHp,
                atk: 50,
                def: 50,
                spd: 50,
                },
                };
                setPokemons((prev) => [...prev, newMon]);
                return newMon;
                };

                const gainXp = (amount: number) => {
                if (!partnerId) return;
                setPokemons((prev) =>
                prev.map((p) => {
                if (p.uid !== partnerId) return p;

                let newXp = p.xp + amount;
                let newLevel = p.level;
                let newMaxXp = p.maxXp;
                let newMaxHp = p.maxHp;

                while (newXp >= newMaxXp) {
                newXp -= newMaxXp;
                newLevel += 1;
                newMaxXp = Math.floor(newMaxXp * 1.2);
                newMaxHp = Math.floor(newMaxHp * 1.1);
                }

                return {
                ...p,
                xp: newXp,
                level: newLevel,
                maxXp: newMaxXp,
                maxHp: newMaxHp,
                hp: newMaxHp,
                };
                })
                );
                };

                const getPartner = () =>
                pokemons.find((p) => p.uid === partnerId) ||
                null;

                // í¬íšìš© ëœë¤ í€´ì¦ˆ (êµ­ì–´ + ìˆ˜í•™ ì„ê¸°)
                const makeCatchQuiz = () => {
                const useKorean =
                koreanLoaded &&
                koreanPool.length > 0 &&
                Math.random() < 0.5;

                if (useKorean) {
                const item =
                koreanPool[
                Math.floor(
                Math.random() * koreanPool.length
                )
                ];
                return {
                q: item.q,
                a: item.answer,
                options: shuffleArray(item.options),
                };
                }
                const m = genMathProblem();
                return {
                q: m.q,
                a: m.answer,
                options: m.options,
                };
                };

                /**
                * ------------------------------------------------------------------
                * íƒí—˜: í¬íš íƒ€ì´ë¨¸ useEffect
                * ------------------------------------------------------------------
                */
                useEffect(() => {
                if (
                !exploreState ||
                exploreState.phase !== "catching"
                )
                return;

                if (exploreState.timer <= 0) {
                // ì‹œê°„ ë -> í˜„ì¬ í™•ë¥ ë¡œ í¬íš ì—¬ë¶€ íŒì •
                const success =
                Math.random() < exploreState.catchRate;
                setExploreState((prev: any) => {
                if (
                !prev ||
                prev.phase !== "catching"
                )
                return prev;
                return {
                ...prev,
                phase: success ? "success" : "fail",
                };
                });
                return;
                }

                const id = setTimeout(() => {
                setExploreState((prev: any) => {
                if (
                !prev ||
                prev.phase !== "catching"
                )
                return prev;
                return {
                ...prev,
                timer: prev.timer - 1,
                };
                });
                }, 1000);

                return () => clearTimeout(id);
                }, [exploreState]);

                /**
                * ------------------------------------------------------------------
                * ë°°í‹€: ìë™ ì „íˆ¬ ë£¨í”„ useEffect
                * ------------------------------------------------------------------
                */
                useEffect(() => {
                if (
                !challengeState ||
                challengeState.phase !== "fighting"
                )
                return;

                const id = setInterval(() => {
                setChallengeState((prev: any) => {
                if (
                !prev ||
                prev.phase !== "fighting"
                )
                return prev;
                const partner = getPartner();
                if (!partner) return prev;

                const myAtk =
                partner.baseStats?.atk || 50;
                const myDef =
                partner.baseStats?.def || 50;
                const enemyAtk =
                prev.enemy.baseStats?.atk || 50;
                const enemyDef =
                prev.enemy.baseStats?.def || 50;

                const isMyTurn = prev.turn % 2 === 0;
                const newLog = [...prev.log];
                let { myHp, enemyHp } = prev;
                let nextPhase = "fighting";

                if (isMyTurn) {
                const rawDmg =
                partner.level * 2 +
                myAtk * 0.5 -
                enemyDef * 0.2 +
                Math.random() * 5;
                const dmg = Math.max(1, Math.floor(rawDmg));
                enemyHp -= dmg;
                newLog.push(
                `ë‚˜ì˜ ê³µê²©! ${dmg} ë°ë¯¸ì§€!`
                );
                if (enemyHp <= 0) {
                enemyHp = 0;
                nextPhase = "win";
                }
                } else {
                const rawDmg =
                prev.enemy.level * 2 +
                enemyAtk * 0.5 -
                myDef * 0.2 +
                Math.random() * 5;
                const dmg = Math.max(1, Math.floor(rawDmg));
                myHp -= dmg;
                newLog.push(
                `ì ì˜ ê³µê²©! ${dmg} ë°ë¯¸ì§€!`
                );
                if (myHp <= 0) {
                myHp = 0;
                nextPhase = "lose";
                }
                }

                return {
                ...prev,
                myHp,
                enemyHp,
                log: newLog.slice(-3),
                turn: prev.turn + 1,
                phase: nextPhase,
                };
                });
                }, 1200);

                return () => clearInterval(id);
                }, [challengeState?.phase]);

                /**
                * ------------------------------------------------------------------
                * í™”ë©´ 1: ë¡œê·¸ì¸ & ìŠ¤íƒ€íŒ… ì„ íƒ
                * ------------------------------------------------------------------
                */
                const renderLogin = () => {
                const starters = [
                { id: 1, name: "ì´ìƒí•´ì”¨" },
                { id: 4, name: "íŒŒì´ë¦¬" },
                { id: 7, name: "ê¼¬ë¶€ê¸°" },
                ];

                const handleStart = async (starterId: number) => {
                if (!user.name.trim())
                return alert("ì´ë¦„ì„ ì¨ì£¼ì„¸ìš”!");

                setIsLoading(true);
                setLoadingMsg(
                "ë°•ì‚¬ë‹˜ì´ í¬ì¼“ëª¬ì„ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤..."
                );
                const data = await fetchPokemonData(
                starterId
                );
                const newMon = addPokemon(data);
                setPartnerId(newMon.uid);
                setIsLoading(false);
                setScreen("main");
                };

                return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-gradient-to-b from-blue-100 to-white p-4">
                    <h1 className="text-3xl font-bold text-blue-800 mb-2 text-center">
                        í¬ì¼“ëª¬ ë§ì¶¤ë²• íƒí—˜ëŒ€
                    </h1>
                    <div className="bg-yellow-400 px-3 py-1 rounded-full text-yellow-900 text-xs font-bold mb-8">
                        PokÃ©API ver.
                    </div>

                    <div className="bg-white p-6 rounded-3xl shadow-xl w-full max-w-md">
                        <label className="block text-lg font-bold mb-2 text-gray-700">
                            íŠ¸ë ˆì´ë„ˆ ì´ë¦„
                        </label>
                        <input
                                className="w-full p-4 text-xl border-2 border-gray-200 rounded-2xl mb-6 focus:border-blue-500 outline-none"
                                placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                                value={user.name}
                                onChange={(e) =>
                        setUser({
                        ...user,
                        name: e.target.value,
                        })
                        }
                        />

                        <p className="text-md font-bold mb-4 text-center text-gray-600">
                            í•¨ê»˜í•  íŒŒíŠ¸ë„ˆë¥¼ ê³¨ë¼ì£¼ì„¸ìš”
                        </p>
                        <div className="grid grid-cols-3 gap-3">
                            {starters.map((s) => (
                            <button
                                    key={s.id}
                                    onClick={() =>
                            handleStart(s.id)
                            }
                            className="flex flex-col items-center p-2 bg-gray-50 rounded-2xl hover:bg-blue-50 border-2 border-transparent hover:border-blue-400 transition-all"
                            >
                            <img
                                    src={`${IMG_BASE_ART}/${s.id}.png`}
                                    alt={s.name}
                                    className="w-20 h-20 object-contain mb-2 drop-shadow-md"
                                    loading="lazy"
                            />
                            <div className="font-bold text-sm text-gray-700">
                                {s.name}
                            </div>
                            </button>
                            ))}
                        </div>
                    </div>

                    {isLoading && (
                    <div className="fixed inset-0 bg-black/50 flex flex-col items-center justify-center text-white z-50">
                        <Loader
                                className="animate-spin mb-4"
                                size={48}
                        />
                        <p className="font-bold text-lg">
                            {loadingMsg}
                        </p>
                    </div>
                    )}
                </div>
                );
                };

                /**
                * ------------------------------------------------------------------
                * í™”ë©´ 2: ë©”ì¸ í—ˆë¸Œ
                * ------------------------------------------------------------------
                */
                const renderMain = () => {
                const partner = getPartner();
                const height = partner?.height || 10;
                const scale = Math.max(
                0.7,
                Math.min(1.3, height / 10)
                );

                return (
                <div className="flex flex-col min-h-screen bg-gray-50 pb-20">
                    {/* ìƒë‹¨ ì¹´ë“œ */}
                    <div className="bg-blue-600 p-6 rounded-b-[2.5rem] shadow-xl relative overflow-hidden text-white">
                        <div className="absolute top-[-20%] right-[-10%] w-48 h-48 bg-white/10 rounded-full blur-2xl"></div>

                        <div className="flex items-center gap-4 relative z-10">
                            <div className="w-24 h-24 bg-white/20 rounded-full flex items-center justify-center shadow-inner border-2 border-white/30">
                                {partner ? (
                                <img
                                        src={partner.imgArt}
                                        alt={partner.name}
                                        className="w-20 h-20 object-contain drop-shadow-lg"
                                        style={{
                                        transform: `scale(${scale})`,
                                        }}
                                />
                                ) : (
                                <div className="text-3xl">
                                    ?
                                </div>
                                )}
                            </div>
                            <div className="flex-1">
                                <div className="text-blue-100 text-sm font-bold">
                                    LV.{partner?.level || 1} íŒŒíŠ¸ë„ˆ
                                </div>
                                <div className="text-2xl font-bold tracking-tight">
                                    {partner?.name ||
                                    "íŒŒíŠ¸ë„ˆ ì—†ìŒ"}
                                </div>

                                {/* ê²½í—˜ì¹˜ ë°” */}
                                <div className="mt-2 h-3 bg-blue-900/40 rounded-full overflow-hidden backdrop-blur-sm border border-white/10">
                                    <div
                                            className="bg-yellow-400 h-full transition-all duration-500 shadow-[0_0_10px_rgba(250,204,21,0.5)]"
                                            style={{
                                            width: `${
                                            partner
                                            ? (partner.xp /
                                    partner.maxXp) *
                                    100
                                    : 0
                                    }%`,
                                    }}
                                    />
                                </div>
                                <div className="flex justify-between text-xs mt-1 text-blue-100/80 font-mono">
                <span>
                  HP{" "}
                  {partner
                    ? partner.hp
                    : "-"}
                </span>
                                    <span>
                  XP{" "}
                  {partner
                    ? `${partner.xp}/${partner.maxXp}`
                    : "-"}
                </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* ë‚´ ì§€ê°‘ */}
                    <div className="mx-6 -mt-4 bg-white p-3 rounded-2xl shadow-lg flex justify-between items-center relative z-20">
          <span className="text-gray-500 font-bold text-sm ml-2">
            ë‚´ ì§€ê°‘
          </span>
                        <span className="text-xl font-bold text-yellow-500 mr-2 flex items-center gap-1">
            <span className="text-sm">ğŸª™</span>{" "}
            {user.coins}
          </span>
                    </div>

                    {/* ë©”ë‰´ ê·¸ë¦¬ë“œ */}
                    <div className="p-6 grid grid-cols-2 gap-4 mt-2">
                        <MenuCard
                                title="í›ˆë ¨í•˜ê¸°"
                                desc="êµ­ì–´ Â· ìˆ˜í•™ ì—°ìŠµ"
                                icon={<BookOpen size={28} />}
                        color="bg-green-500"
                        onClick={() => setScreen("training")}
                        />
                        <MenuCard
                                title="íƒí—˜í•˜ê¸°"
                                desc="í¬ì¼“ëª¬ ì¡ê¸°"
                                icon={<Map size={28} />}
                        color="bg-orange-500"
                        onClick={() => setScreen("explore")}
                        />
                        <MenuCard
                                title="ë„ì „í•˜ê¸°"
                                desc="ë°°í‹€ & ì½”ì¸"
                                icon={<Sword size={28} />}
                        color="bg-red-500"
                        onClick={() =>
                        setScreen("challenge")
                        }
                        />
                        <MenuCard
                                title="ìƒì "
                                desc="í¬íš/ë²„í”„ ì•„ì´í…œ"
                                icon={<ShoppingBag size={28} />}
                        color="bg-purple-500"
                        onClick={() => setScreen("shop")}
                        />
                    </div>

                    {/* í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */}
                    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-2 flex justify-around pb-4 pt-3 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                        <button
                                onClick={() => setScreen("pokedex")}
                        className="flex flex-col items-center text-gray-400 hover:text-blue-600 transition-colors"
                        >
                        <Settings size={24} />
                        <span className="text-[10px] font-bold mt-1">
              ë„ê°/íŒŒíŠ¸ë„ˆ
            </span>
                        </button>
                        <button
                                onClick={() => setScreen("export")}
                        className="flex flex-col items-center text-blue-600"
                        >
                        <div className="bg-blue-100 p-2 rounded-full mb-1">
                            <Send size={20} />
                        </div>
                        <span className="text-[10px] font-bold">
              ì„ ìƒë‹˜ê»˜
            </span>
                        </button>
                    </div>
                </div>
                );
                };

                /**
                * ------------------------------------------------------------------
                * í™”ë©´ 3: í›ˆë ¨ (êµ­ì–´ JSON + PEM ìˆ˜í•™)
                * ------------------------------------------------------------------
                */
                const renderTraining = () => {
                if (!trainingState) {
                const startTraining = (
                type: "korean" | "math"
                ) => {
                if (type === "korean") {
                if (
                !koreanLoaded ||
                koreanPool.length === 0
                ) {
                alert(
                "êµ­ì–´ ë¬¸ì œê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."
                );
                return;
                }
                const picked = shuffleArray(
                koreanPool
                ).slice(0, 5);
                const problems = picked.map(
                (item: any) => ({
                q: item.q,
                a: item.answer,
                options: shuffleArray(
                item.options
                ),
                })
                );
                setTrainingState({
                type,
                current: 0,
                correct: 0,
                problems,
                showResult: false,
                feedback: null,
                });
                } else {
                const problems = Array(5)
                .fill(null)
                .map(() => {
                const m = genMathProblem();
                return {
                q: m.q,
                a: m.answer,
                options: m.options,
                };
                });
                setTrainingState({
                type,
                current: 0,
                correct: 0,
                problems,
                showResult: false,
                feedback: null,
                });
                }
                };

                return (
                <div className="p-4 h-full flex flex-col bg-slate-50">
                    <Header
                            title="í›ˆë ¨ì¥"
                            onBack={() => setScreen("main")}
                    />
                    <div className="flex-1 flex flex-col justify-center gap-4 mt-4">
                        <button
                                onClick={() =>
                        startTraining("korean")
                        }
                        className="group relative overflow-hidden p-8 bg-white rounded-3xl shadow-sm border-2 border-pink-100 hover:border-pink-300 transition-all text-left"
                        >
                        <div className="absolute right-0 top-0 w-32 h-32 bg-pink-50 rounded-full translate-x-8 -translate-y-8 group-hover:bg-pink-100 transition-colors"></div>
                        <h3 className="text-2xl font-bold text-gray-800 relative z-10">
                            êµ­ì–´ í›ˆë ¨
                        </h3>
                        <p className="text-gray-500 relative z-10">
                            ë§ì¶¤ë²•ì„ ë°°ì›Œìš”
                        </p>
                        </button>
                        <button
                                onClick={() =>
                        startTraining("math")
                        }
                        className="group relative overflow-hidden p-8 bg-white rounded-3xl shadow-sm border-2 border-blue-100 hover:border-blue-300 transition-all text-left"
                        >
                        <div className="absolute right-0 top-0 w-32 h-32 bg-blue-50 rounded-full translate-x-8 -translate-y-8 group-hover:bg-blue-100 transition-colors"></div>
                        <h3 className="text-2xl font-bold text-gray-800 relative z-10">
                            ìˆ˜í•™ í›ˆë ¨
                        </h3>
                        <p className="text-gray-500 relative z-10">
                            ê³„ì‚° ì—°ìŠµì„ í•´ìš”
                        </p>
                        </button>
                    </div>
                </div>
                );
                }

                if (trainingState.showResult) {
                const xpGained =
                trainingState.correct * 10;
                return (
                <div className="p-6 h-screen bg-white flex flex-col items-center justify-center text-center">
                    <Trophy
                            size={80}
                            className="text-yellow-400 mb-6 animate-bounce"
                    />
                    <h2 className="text-3xl font-bold mb-2 text-gray-800">
                        í›ˆë ¨ ì™„ë£Œ!
                    </h2>
                    <div className="text-gray-500 mb-8">
                        ì´{" "}
                        <span className="text-blue-600 font-bold text-2xl mx-1">
              {trainingState.correct}
            </span>{" "}
                        ë¬¸ì œë¥¼ ë§í˜”ì–´ìš”
                    </div>

                    <div className="bg-gradient-to-r from-green-400 to-green-600 p-1 rounded-2xl w-full max-w-xs shadow-lg mb-8">
                        <div className="bg-white rounded-xl p-6">
                            <p className="text-gray-500 font-bold text-sm mb-1">
                                íšë“í•œ ê²½í—˜ì¹˜
                            </p>
                            <p className="text-5xl font-bold text-green-600">
                                +{xpGained}
                                <span className="text-xl ml-1">
                  XP
                </span>
                            </p>
                        </div>
                    </div>

                    <button
                            onClick={() => {
                    gainXp(xpGained);
                    setTrainingState(null);
                    }}
                    className="w-full max-w-xs p-4 bg-blue-600 text-white rounded-xl text-xl font-bold shadow-lg hover:bg-blue-700 active:scale-95 transition-all"
                    >
                    í™•ì¸
                    </button>
                </div>
                );
                }

                const problem =
                trainingState.problems[
                trainingState.current
                ];

                const handleAnswer = (ans: string) => {
                const isCorrect = ans === problem.a;
                setTrainingState((prev: any) => ({
                ...prev,
                feedback: isCorrect
                ? "correct"
                : "wrong",
                lastChoice: ans,
                }));

                setTimeout(() => {
                setTrainingState((prev: any) => {
                if (!prev) return prev;
                const next = prev.current + 1;
                const newCorrect = isCorrect
                ? prev.correct + 1
                : prev.correct;
                if (next >= 5) {
                return {
                ...prev,
                correct: newCorrect,
                showResult: true,
                feedback: null,
                };
                }
                return {
                ...prev,
                current: next,
                correct: newCorrect,
                feedback: null,
                };
                });
                }, 800);
                };

                return (
                <div className="flex flex-col h-screen bg-slate-50">
                    <div className="p-6">
                        <div className="flex justify-between items-center mb-6">
            <span className="text-gray-400 font-bold text-sm">
              ë¬¸ì œ{" "}
              {trainingState.current + 1} / 5
            </span>
                            <span className="bg-blue-100 text-blue-700 px-3 py-1 rounded-full text-xs font-bold">
              {trainingState.type === "korean"
                ? "êµ­ì–´"
                : "ìˆ˜í•™"}
            </span>
                        </div>
                        <div className="bg-white p-8 rounded-[2rem] shadow-sm min-h-[160px] flex items-center justify-center text-center border-2 border-slate-100">
                            <h2 className="text-3xl font-bold text-gray-800 leading-snug">
                                {problem.q}
                            </h2>
                        </div>
                    </div>

                    <div className="flex-1 px-6 pb-6">
                        <div className="grid grid-cols-2 gap-4 h-full max-h-[400px]">
                            {problem.options.map(
                            (opt: string, idx: number) => (
                            <button
                                    key={idx}
                                    onClick={() =>
                            !trainingState.feedback &&
                            handleAnswer(opt)
                            }
                            className={`rounded-2xl text-xl font-bold shadow-sm transition-all flex items-center justify-center p-4
                            ${
                            !trainingState.feedback
                            ? "bg-white hover:bg-blue-50 text-gray-700 border-2 border-slate-100 hover:border-blue-200"
                            : opt === problem.a
                            ? "bg-green-500 text-white scale-105 ring-4 ring-green-200"
                            : opt ===
                            trainingState.lastChoice
                            ? "bg-gray-200 text-gray-400"
                            : "bg-white text-gray-400 opacity-70"
                            }`}
                            >
                            {opt}
                            </button>
                            )
                            )}
                        </div>
                    </div>

                    {trainingState.feedback && (
                    <div className="absolute inset-0 flex items-center justify-center bg-black/10 backdrop-blur-[2px] z-50">
                        {trainingState.feedback ===
                        "correct" ? (
                        <CheckCircle
                                size={140}
                                className="text-green-500 bg-white rounded-full p-2 shadow-2xl animate-bounce"
                        />
                        ) : (
                        <XCircle
                                size={140}
                                className="text-red-500 bg-white rounded-full p-2 shadow-2xl animate-pulse"
                        />
                        )}
                    </div>
                    )}
                </div>
                );
                };

                /**
                * ------------------------------------------------------------------
                * í™”ë©´ 4: íƒí—˜ (ì¡°ìš° + í¬íš)
                * ------------------------------------------------------------------
                */
                const renderExplore = () => {
                // ì¤€ë¹„ í™”ë©´
                if (!exploreState) {
                const startExplore = async () => {
                if (!user.inventory.poke_ball) {
                alert(
                "ëª¬ìŠ¤í„°ë³¼ì´ ì—†ì–´ìš”! ìƒì ì—ì„œ ë¨¼ì € ì‚¬ ì£¼ì„¸ìš”."
                );
                return;
                }

                setIsLoading(true);
                setLoadingMsg(
                "ì•¼ìƒì˜ ìˆ²ì„ íƒí—˜í•˜ëŠ” ì¤‘..."
                );

                // ë²„í”„ ìŠ¤ëƒ…ìƒ·
                const currentLucky = buffs.lucky;
                const currentRepel = buffs.repel;

                // íƒí—˜ 1íšŒë‹¹ ë²„í”„ 1íšŒ ì†Œëª¨
                if (currentLucky > 0 || currentRepel > 0) {
                setBuffs((b) => ({
                lucky: Math.max(0, b.lucky - 1),
                repel: Math.max(0, b.repel - 1),
                }));
                }

                // ê¸°ë³¸: í’€ì—ì„œ ëœë¤
                let randomId =
                EXPLORE_SPECIES_POOL[
                Math.floor(
                Math.random() *
                EXPLORE_SPECIES_POOL.length
                )
                ];

                // í–‰ìš´ë¶€ì : í¬ê·€ í¬ì¼“ëª¬ ìš°ì„  ì¶”ì²¨
                if (
                currentLucky > 0 &&
                Math.random() < 0.3
                ) {
                const rareIds = [
                149, 150, 151, // 1ì„¸ëŒ€ ë ˆì–´
                810, 813, 816, // 8ì„¸ëŒ€ ìŠ¤íƒ€íŒ…
                906, 909, 912, // 9ì„¸ëŒ€ ìŠ¤íƒ€íŒ…
                ];
                randomId =
                rareIds[
                Math.floor(
                Math.random() * rareIds.length
                )
                ];
                }

                let targetData = await fetchPokemonData(
                randomId
                );

                // ë²Œë ˆê¸°í”¼ì œ: ê°€ì¥ ë‚®ì€ ë ˆì–´ë„(1)ë©´ í•œ ë²ˆ ì¬ì¶”ì²¨
                if (
                currentRepel > 0 &&
                targetData.rarity === 1
                ) {
                const rerollId =
                EXPLORE_SPECIES_POOL[
                Math.floor(
                Math.random() *
                EXPLORE_SPECIES_POOL.length
                )
                ];
                targetData =
                await fetchPokemonData(rerollId);
                }

                const baseCatchRateByRarity: any = {
                1: 0.35,
                2: 0.25,
                3: 0.15,
                4: 0.05,
                };
                const baseCatchRate =
                baseCatchRateByRarity[
                targetData.rarity
                ] ?? 0.2;

                setExploreState({
                phase: "encounter",
                target: targetData,
                combo: 0,
                timer: 5,
                currentQuiz: null,
                catchRate: baseCatchRate,
                });

                setIsLoading(false);
                };

                return (
                <div className="p-4 h-full flex flex-col bg-green-50">
                    <Header
                            title="íƒí—˜ ì¤€ë¹„"
                            onBack={() => setScreen("main")}
                    />

                    <div className="mt-4 bg-white p-6 rounded-3xl shadow-sm border border-green-100">
                        <h3 className="font-bold text-gray-600 mb-4 text-sm">
                            í˜„ì¬ ì ìš©ëœ ì•„ì´í…œ
                        </h3>
                        <div className="flex gap-3">
                            <div
                                    className={`flex-1 p-4 rounded-2xl border ${
                                    buffs.lucky > 0
                                ? "bg-yellow-50 border-yellow-300"
                                : "bg-gray-50 border-gray-100 opacity-60"
                                }`}
                                >
                                <div className="text-2xl mb-1">
                                    ğŸ€
                                </div>
                                <div className="font-bold text-sm">
                                    í–‰ìš´ë¶€ì 
                                </div>
                                <div className="text-[10px] text-gray-500">
                                    {buffs.lucky}íšŒ ë‚¨ìŒ
                                </div>
                            </div>
                            <div
                                    className={`flex-1 p-4 rounded-2xl border ${
                                    buffs.repel > 0
                                ? "bg-purple-50 border-purple-300"
                                : "bg-gray-50 border-gray-100 opacity-60"
                                }`}
                                >
                                <div className="text-2xl mb-1">
                                    ğŸŒ«ï¸
                                </div>
                                <div className="font-bold text-sm">
                                    ë²Œë ˆê¸°í”¼ì œ
                                </div>
                                <div className="text-[10px] text-gray-500">
                                    {buffs.repel}íšŒ ë‚¨ìŒ
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col items-center justify-center">
                        <div className="w-48 h-48 bg-green-200 rounded-full flex items-center justify-center animate-pulse mb-8 relative">
                            <Map
                                    size={64}
                                    className="text-green-600 opacity-50"
                            />
                            <div className="absolute -bottom-2 bg-white px-4 py-1 rounded-full text-xs font-bold shadow-sm text-gray-600">
                                ëª¬ìŠ¤í„°ë³¼:{" "}
                                {user.inventory.poke_ball || 0}
                                ê°œ
                            </div>
                        </div>

                        <button
                                onClick={startExplore}
                                disabled={!user.inventory.poke_ball}
                                className="w-full py-5 bg-green-600 text-white rounded-2xl text-xl font-bold shadow-xl disabled:opacity-50 disabled:bg-gray-400 active:scale-95 transition-all"
                        >
                            ìˆ²ìœ¼ë¡œ ë– ë‚˜ê¸°
                        </button>
                    </div>

                    {isLoading && (
                    <div className="absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center">
                        <img
                                src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png"
                                className="w-16 h-16 animate-spin mb-4"
                                alt="loading"
                        />
                        <p className="font-bold text-green-800">
                            {loadingMsg}
                        </p>
                    </div>
                    )}
                </div>
                );
                }

                // ì¡°ìš° í™”ë©´
                if (exploreState.phase === "encounter") {
                return (
                <div className="h-screen bg-slate-800 flex flex-col items-center pt-20 pb-10 px-4 relative overflow-hidden">
                    <div className="absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-green-500 via-slate-900 to-slate-900"></div>

                    <div className="relative z-10 text-center w-full">
                        <div className="inline-block bg-yellow-400 text-yellow-900 px-4 py-1 rounded-full font-bold mb-4 animate-bounce shadow-lg">
                            ì•¼ìƒì˜ í¬ì¼“ëª¬ì´ ë‚˜íƒ€ë‚¬ë‹¤!
                        </div>

                        <div className="relative w-64 h-64 mx-auto mb-6">
                            <div className="absolute inset-0 bg-white/10 rounded-full blur-3xl animate-pulse"></div>
                            <img
                                    src={exploreState.target.imgArt}
                                    alt={exploreState.target.name}
                                    className="w-full h-full object-contain drop-shadow-2xl relative z-10 hover:scale-110 transition-transform duration-300"
                            />
                        </div>

                        <h2 className="text-4xl font-bold text-white mb-2">
                            {exploreState.target.name}
                        </h2>
                        <div className="text-slate-400 mb-12">
                            í¬íš ë‚œì´ë„:{" "}
                            {["â­", "â­â­", "â­â­â­", "ğŸ‘‘"][
                            exploreState.target.rarity - 1
                            ]}
                        </div>

                        <button
                                onClick={() => {
                        // ëª¬ìŠ¤í„°ë³¼ 1ê°œ ì†Œë¹„
                        setUser((u) => ({
                        ...u,
                        inventory: {
                        ...u.inventory,
                        poke_ball:
                        (u.inventory.poke_ball ||
                        0) - 1,
                        },
                        }));
                        setExploreState((prev: any) => ({
                        ...prev,
                        phase: "catching",
                        combo: 0,
                        timer: 5,
                        currentQuiz: makeCatchQuiz(),
                        }));
                        }}
                        className="w-full max-w-sm py-4 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-2xl text-xl font-bold border-b-4 border-red-800 shadow-xl flex items-center justify-center gap-3 active:border-b-0 active:translate-y-1 transition-all"
                        >
                        <img
                                src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png"
                                className="w-8 h-8"
                                alt="ball"
                        />
                        ëª¬ìŠ¤í„°ë³¼ ë˜ì§€ê¸°!
                        </button>
                        <button
                                onClick={() => setExploreState(null)}
                        className="mt-6 text-white/50 text-sm hover:text-white underline"
                        >
                        ì¡°ìš©íˆ ë„ë§ê°€ê¸°
                        </button>
                    </div>
                </div>
                );
                }

                // í¬íš ë¯¸ë‹ˆê²Œì„
                if (exploreState.phase === "catching") {
                const handleAnswer = (ans: string) => {
                const isCorrect =
                ans === exploreState.currentQuiz.a;
                if (isCorrect) {
                setExploreState((prev: any) => ({
                ...prev,
                combo: prev.combo + 1,
                // ì½¤ë³´ë§ˆë‹¤ 1.1ë°°
                catchRate: Math.min(
                0.95,
                prev.catchRate * 1.1
                ),
                timer: 5,
                currentQuiz: makeCatchQuiz(),
                }));
                } else {
                const success =
                Math.random() <
                exploreState.catchRate;
                setExploreState((prev: any) => ({
                ...prev,
                phase: success
                ? "success"
                : "fail",
                }));
                }
                };

                return (
                <div className="h-screen bg-slate-900 flex flex-col p-6">
                    <div className="flex justify-between items-end mb-8 text-white">
                        <div>
                            <div className="text-xs text-slate-400 mb-1">
                                í¬íš í™•ë¥ 
                            </div>
                            <div className="text-3xl font-bold text-yellow-400">
                                {(
                                exploreState.catchRate * 100
                                ).toFixed(0)}
                                %
                            </div>
                        </div>
                        <div className="flex flex-col items-end">
                            <div className="text-xs text-slate-400 mb-1">
                                ë‚¨ì€ ì‹œê°„
                            </div>
                            <div className="text-3xl font-bold flex items-center gap-2 text-red-400">
                                <Clock size={24} />{" "}
                                {exploreState.timer}
                            </div>
                        </div>
                    </div>

                    <div className="flex-1 flex flex-col justify-center">
                        <div className="bg-white p-6 rounded-2xl mb-4 text-center shadow-lg min-h-[120px] flex items-center justify-center">
                            <h3 className="text-2xl font-bold text-gray-800">
                                {exploreState.currentQuiz.q}
                            </h3>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            {exploreState.currentQuiz.options.map(
                            (opt: string, idx: number) => (
                            <button
                                    key={idx}
                                    onClick={() =>
                            handleAnswer(opt)
                            }
                            className="p-6 bg-blue-600 text-white rounded-xl text-xl font-bold shadow-lg active:bg-blue-700 transition-colors"
                            >
                            {opt}
                            </button>
                            )
                            )}
                        </div>
                    </div>
                    <div className="text-center text-slate-500 text-sm mt-8">
            <span className="text-yellow-400 font-bold">
              {exploreState.combo} ì½¤ë³´
            </span>{" "}
                        ì¤‘! ê³„ì† ë§íˆì„¸ìš”!
                    </div>
                </div>
                );
                }

                // ê²°ê³¼ í™”ë©´
                if (exploreState.phase === "success") {
                return (
                <div className="h-screen bg-green-50 flex flex-col items-center justify-center text-center p-6">
                    <div className="relative">
                        <div className="absolute inset-0 bg-yellow-300 rounded-full blur-xl opacity-50 animate-pulse"></div>
                        <img
                                src={exploreState.target.imgArt}
                                className="w-48 h-48 object-contain relative z-10 mb-4 animate-bounce"
                                alt="pkmn"
                        />
                    </div>
                    <h2 className="text-3xl font-bold text-green-800 mb-2">
                        í¬íš ì„±ê³µ!
                    </h2>
                    <p className="text-gray-600 mb-8">
            <span className="font-bold">
              {exploreState.target.name}
            </span>
                        ì´(ê°€) ì¹œêµ¬ê°€ ë˜ì—ˆì–´ìš”.
                    </p>
                    <button
                            onClick={() => {
                    addPokemon(exploreState.target);
                    // í¬íš ì„±ê³µ ë³´ë„ˆìŠ¤ ê²½í—˜ì¹˜
                    gainXp(20);
                    setExploreState(null);
                    }}
                    className="w-full max-w-sm p-4 bg-green-600 text-white rounded-xl font-bold text-xl"
                    >
                    í™•ì¸
                    </button>
                </div>
                );
                }

                if (exploreState.phase === "fail") {
                return (
                <div className="h-screen bg-gray-100 flex flex-col items-center justify-center text-center p-6">
                    <img
                            src={exploreState.target.imgArt}
                            className="w-40 h-40 object-contain mb-4 grayscale opacity-40"
                            alt="pkmn"
                    />
                    <h2 className="text-3xl font-bold text-gray-500 mb-2">
                        ë†“ì³¤ë‹¤...
                    </h2>
                    <p className="text-gray-500 mb-8">
                        ë„ˆë¬´ ì¬ë¹ ë¥¸ í¬ì¼“ëª¬ì´ì—ˆì–´ìš”.
                    </p>
                    <button
                            onClick={() => setExploreState(null)}
                    className="w-full max-w-sm p-4 bg-gray-600 text-white rounded-xl font-bold text-xl"
                    >
                    ëŒì•„ê°€ê¸°
                    </button>
                </div>
                );
                }

                return null;
                };

                /**
                * ------------------------------------------------------------------
                * í™”ë©´ 5: ë„ì „ (ìë™ ë°°í‹€)
                * ------------------------------------------------------------------
                */
                const renderChallenge = () => {
                if (!challengeState) {
                const partner = getPartner();
                const startChallenge = async () => {
                if (!partner) return;
                setIsLoading(true);

                const enemyId =
                EXPLORE_SPECIES_POOL[
                Math.floor(
                Math.random() *
                EXPLORE_SPECIES_POOL.length
                )
                ];
                const enemyData = await fetchPokemonData(
                enemyId
                );
                const enemyLevel = Math.max(
                1,
                partner.level +
                Math.floor(Math.random() * 3) -
                1
                );

                setChallengeState({
                phase: "fighting",
                log: [
                `ì•¼ìƒì˜ ${enemyData.name}(Lv.${enemyLevel}) ë“±ì¥!`,
                ],
                myHp: partner.hp,
                enemyHp:
                enemyData.baseHp *
                (1 + enemyLevel * 0.1),
                enemyMaxHp:
                enemyData.baseHp *
                (1 + enemyLevel * 0.1),
                enemy: {
                ...enemyData,
                level: enemyLevel,
                },
                turn: 0,
                });
                setIsLoading(false);
                };

                return (
                <div className="p-4 h-full bg-red-50 flex flex-col">
                    <Header
                            title="ë°°í‹€ íƒ€ì›Œ"
                            onBack={() => setScreen("main")}
                    />
                    <div className="flex-1 flex flex-col items-center justify-center">
                        <div className="bg-white p-8 rounded-full shadow-lg mb-8 relative">
                            <div className="absolute inset-0 bg-red-100 rounded-full animate-ping opacity-20"></div>
                            {getPartner() && (
                            <img
                                    src={getPartner()!.imgArt}
                                    className="w-32 h-32 object-contain"
                                    alt="partner"
                            />
                            )}
                        </div>
                        <h2 className="text-2xl font-bold text-gray-800 mb-2">
                            ë°°í‹€ ì‹œë®¬ë ˆì´ì…˜
                        </h2>
                        <p className="text-gray-500 mb-8">
                            íŒŒíŠ¸ë„ˆê°€ ìë™ìœ¼ë¡œ ì‹¸ì›ë‹ˆë‹¤
                        </p>

                        <button
                                onClick={startChallenge}
                                className="px-10 py-5 bg-red-600 text-white rounded-2xl text-xl font-bold shadow-lg active:scale-95 transition-transform"
                        >
                            ë°°í‹€ ì‹œì‘!
                        </button>
                    </div>

                    {isLoading && (
                    <div className="absolute inset-0 bg-white/80 z-50 flex items-center justify-center">
              <span className="font-bold text-red-500">
                ëŒ€ê²° ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘...
              </span>
                    </div>
                    )}
                </div>
                );
                }

                if (challengeState.phase === "fighting") {
                const partner = getPartner();
                if (!partner) {
                return (
                <div className="p-4">
                    <Header
                            title="ë°°í‹€ íƒ€ì›Œ"
                            onBack={() => {
                    setChallengeState(null);
                    setScreen("main");
                    }}
                    />
                    <div className="p-4 text-center">
                        íŒŒíŠ¸ë„ˆê°€ ì—†ì–´ìš”.
                    </div>
                </div>
                );
                }
                return (
                <div className="h-screen bg-slate-900 text-white p-4 flex flex-col overflow-hidden relative">
                    {/* ë°°í‹€ ë°°ê²½ */}
                    <div className="absolute inset-0 opacity-10 bg-gradient-to-br from-slate-700 via-slate-900 to-black" />

                    {/* ìƒë‹¨: ì  */}
                    <div className="flex justify-end mb-4 relative z-10 pt-4 px-4">
                        <div className="text-right">
                            <div className="flex items-center justify-end gap-2 mb-1">
                <span className="font-bold text-lg">
                  {challengeState.enemy.name}
                </span>
                                <span className="text-sm text-yellow-400">
                  Lv.{challengeState.enemy.level}
                </span>
                            </div>
                            <img
                                    src={challengeState.enemy.imgArt}
                                    className="w-28 h-28 object-contain ml-auto animate-pulse"
                                    alt="enemy"
                            />
                            <div className="w-32 h-3 bg-gray-700 rounded-full mt-2 ml-auto overflow-hidden border border-white/20">
                                <div
                                        className="h-full bg-red-500 transition-all duration-500"
                                        style={{
                                        width: `${
                                        (challengeState.enemyHp /
                                challengeState.enemyMaxHp) *
                                100
                                }%`,
                                }}
                                />
                            </div>
                        </div>
                    </div>

                    {/* ì¤‘ì•™: ë¡œê·¸ (PEM ìŠ¤íƒ€ì¼ í•˜ë‹¨ ë©”ì‹œì§€ ë°•ìŠ¤ ëŠë‚Œ) */}
                    <div className="flex-1 flex items-end mb-4">
                        <div className="w-full bg-black/60 backdrop-blur-md rounded-2xl p-3 border border-white/10">
                            {challengeState.log.map(
                            (l: string, i: number) => (
                            <div
                                    key={i}
                                    className={`${
                                    i ===
                                    challengeState.log.length - 1
                                    ? "text-white font-bold text-lg"
                            : "text-gray-400 text-sm"
                            }`}
                            >
                            {l}
                        </div>
                        )
                        )}
                    </div>
                </div>

                {/* í•˜ë‹¨: ë‚´ í¬ì¼“ëª¬ */}
                <div className="flex justify-start relative z-10 pb-4 px-4">
                    <div>
                        <div className="flex items-center gap-2 mb-1">
                <span className="font-bold text-lg">
                  {partner.name}
                </span>
                            <span className="text-sm text-yellow-400">
                  Lv.{partner.level}
                </span>
                        </div>
                        <img
                                src={partner.imgArt}
                                className="w-32 h-32 object-contain"
                                alt="me"
                        />
                        <div className="w-32 h-3 bg-gray-700 rounded-full mt-2 overflow-hidden border border-white/20">
                            <div
                                    className="h-full bg-green-500 transition-all duration-500"
                                    style={{
                                    width: `${
                                    (challengeState.myHp /
                            partner.maxHp) *
                            100
                            }%`,
                            }}
                            />
                        </div>
                        <div className="text-xs mt-1 text-gray-400">
                            {Math.floor(
                            Math.max(
                            0,
                            challengeState.myHp
                            )
                            )}{" "}
                            HP
                        </div>
                    </div>
                </div>
                </div>
                );
                }

                // ê²°ê³¼
                const isWin =
                challengeState.phase === "win";
                return (
                <div
                        className={`h-screen flex flex-col items-center justify-center p-6 text-center ${
                        isWin ? "bg-yellow-50" : "bg-gray-100"
                }`}
                >
                <div className="text-6xl mb-4">
                    {isWin ? "ğŸ†" : "ğŸ¤•"}
                </div>
                <h2
                        className={`text-3xl font-bold mb-4 ${
                        isWin
                        ? "text-yellow-800"
                : "text-gray-700"
                }`}
                >
                {isWin ? "ìŠ¹ë¦¬!" : "íŒ¨ë°°..."}
                </h2>
                <p className="text-gray-600 mb-8">
                    {isWin
                    ? "ëŒ€ë‹¨í•œ ì‹¤ë ¥ì´ì—ìš”!"
                    : "íŒŒíŠ¸ë„ˆê°€ ì§€ì³¤ì–´ìš”."}
                </p>
                <div className="text-3xl font-bold mb-8 text-yellow-600">
                    {isWin ? "+20 ì½”ì¸" : "+5 ì½”ì¸"}
                </div>
                <button
                        onClick={() => {
                setUser((u) => ({
                ...u,
                coins:
                u.coins +
                (isWin ? 20 : 5),
                }));
                gainXp(isWin ? 15 : 5);
                setChallengeState(null);
                }}
                className={`w-full max-w-sm p-4 text-white rounded-xl font-bold text-xl ${
                isWin
                ? "bg-yellow-500"
                : "bg-gray-600"
                }`}
                >
                ëŒì•„ê°€ê¸°
                </button>
                </div>
                );
                };

                /**
                * ------------------------------------------------------------------
                * í™”ë©´ 6: ìƒì 
                * ------------------------------------------------------------------
                */
                const renderShop = () => {
                const buyItem = (item: any) => {
                if (user.coins < item.price) {
                alert("ëˆì´ ë¶€ì¡±í•´ìš”!");
                return;
                }

                setUser((u) => {
                const newInv = { ...u.inventory };
                if (item.type === "ball") {
                newInv[item.id] =
                (newInv[item.id] || 0) + 1;
                } else {
                if (item.id === "lucky_charm") {
                setBuffs((b) => ({
                ...b,
                lucky: b.lucky + item.duration,
                }));
                }
                if (item.id === "repel") {
                setBuffs((b) => ({
                ...b,
                repel: b.repel + item.duration,
                }));
                }
                }
                return {
                ...u,
                coins: u.coins - item.price,
                inventory: newInv,
                };
                });
                };

                return (
                <div className="p-4 h-full bg-purple-50 flex flex-col">
                    <Header
                            title="í¬ì¼“ìƒì "
                            onBack={() => setScreen("main")}
                    />
                    <div className="bg-white p-4 rounded-2xl shadow-sm mb-4 flex justify-between items-center border border-purple-100">
          <span className="font-bold text-gray-600">
            ë‚´ ì§€ê°‘
          </span>
                        <span className="text-2xl font-bold text-yellow-500">
            ğŸª™ {user.coins}
          </span>
                    </div>

                    <div className="grid grid-cols-1 gap-3 overflow-y-auto pb-8">
                        {SHOP_ITEMS.map((item) => (
                        <button
                                key={item.id}
                                onClick={() => buyItem(item)}
                        className="bg-white p-4 rounded-xl shadow-sm flex items-center gap-4 active:scale-95 transition-transform border border-transparent hover:border-purple-200"
                        >
                        <div className="text-3xl bg-gray-50 p-2 rounded-lg">
                            {item.icon}
                        </div>
                        <div className="flex-1 text-left">
                            <div className="font-bold text-gray-800">
                                {item.name}
                            </div>
                            <div className="text-xs text-purple-400">
                                {item.type === "ball"
                                ? "í¬íš í™•ë¥  UP!"
                                : `${item.duration}íšŒ íš¨ê³¼ ì§€ì†`}
                            </div>
                        </div>
                        <div className="font-bold text-purple-600 bg-purple-100 px-3 py-1 rounded-lg text-sm">
                            {item.price}ì›
                        </div>
                        </button>
                        ))}
                    </div>
                </div>
                );
                };

                /**
                * ------------------------------------------------------------------
                * í™”ë©´ 7: ë„ê° (íŒŒíŠ¸ë„ˆ ì„ íƒ)
                * ------------------------------------------------------------------
                */
                const renderPokedex = () => {
                return (
                <div className="p-4 h-full bg-gray-50 flex flex-col">
                    <Header
                            title="ë‚´ í¬ì¼“ëª¬"
                            onBack={() => setScreen("main")}
                    />
                    <div className="grid grid-cols-3 gap-3 mt-2 overflow-y-auto pb-20">
                        {pokemons.map((p) => {
                        const isPartner =
                        p.uid === partnerId;
                        return (
                        <div
                                key={p.uid}
                                onClick={() =>
                        setPartnerId(p.uid)
                        }
                        className={`bg-white p-2 rounded-xl border-2 relative flex flex-col items-center shadow-sm cursor-pointer transition-all
                        ${
                        isPartner
                        ? "border-blue-500 ring-2 ring-blue-100 bg-blue-50"
                        : "border-transparent hover:border-gray-200"
                        }`}
                        >
                        {isPartner && (
                        <div className="absolute top-1 right-1 text-blue-500">
                            <Star
                                    size={12}
                                    fill="currentColor"
                            />
                        </div>
                        )}
                        <img
                                src={
                                p.imgSprite ||
                                p.imgArt
                                }
                                className="w-16 h-16 object-contain"
                                alt={p.name}
                                loading="lazy"
                        />
                        <div className="font-bold text-xs text-center text-gray-800 truncate w-full mt-1">
                            {p.name}
                        </div>
                        <div className="text-[10px] text-gray-400">
                            Lv.{p.level}
                        </div>
                    </div>
                    );
                    })}
                </div>
                </div>
                );
                };

                /**
                * ------------------------------------------------------------------
                * í™”ë©´ 8: ì¶œì „ (êµì‚¬ì—ê²Œ ì „ì†¡)
                * ------------------------------------------------------------------
                */
                const renderExport = () => {
                const partner = getPartner();
                if (!partner) {
                return (
                <div className="p-4">
                    <Header
                            title="ì¶œì „í•˜ê¸°"
                            onBack={() => setScreen("main")}
                    />
                    <div className="p-4 text-center">
                        ë¨¼ì € íŒŒíŠ¸ë„ˆ í¬ì¼“ëª¬ì„
                        ì„ íƒí•´ì£¼ì„¸ìš”.
                    </div>
                </div>
                );
                }

                const height = partner.height || 10;
                const scale = Math.max(
                0.7,
                Math.min(1.3, height / 10)
                );

                const sendData = () => {
                // TODO: ì„œë²„/êµì‚¬ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ì†¡ ë¡œì§
                setExportSent(true);
                };

                if (exportSent) {
                return (
                <div className="h-screen bg-blue-500 flex flex-col items-center justify-center text-white p-8 text-center">
                    <CheckCircle
                            size={80}
                            className="mb-6 animate-bounce text-white"
                    />
                    <h2 className="text-3xl font-bold mb-4">
                        ì œì¶œ ì™„ë£Œ!
                    </h2>
                    <p className="text-lg opacity-90 mb-8">
                        ì„ ìƒë‹˜ ì»´í“¨í„°ë¡œ
                        <br />
                        ë‚´ í¬ì¼“ëª¬ì´ ë‚ ì•„ê°”ì–´ìš” âœˆï¸
                    </p>
                    <button
                            onClick={() => {
                    setExportSent(false);
                    setScreen("main");
                    }}
                    className="bg-white text-blue-600 px-8 py-3 rounded-full font-bold shadow-lg"
                    >
                    ëŒì•„ê°€ê¸°
                    </button>
                </div>
                );
                }

                return (
                <div className="p-4 h-full flex flex-col bg-slate-50">
                    <Header
                            title="ì¶œì „í•˜ê¸°"
                            onBack={() => setScreen("main")}
                    />
                    <div className="flex-1 flex flex-col justify-center items-center p-6">
                        <div className="bg-white p-6 rounded-3xl shadow-lg w-full mb-8 text-center border-2 border-blue-50">
                            <h3 className="text-gray-400 font-bold mb-4 text-xs tracking-widest uppercase">
                                My Partner
                            </h3>
                            <img
                                    src={partner.imgArt}
                                    alt={partner.name}
                                    className="w-20 h-20 object-contain drop-shadow-lg"
                                    style={{
                                    transform: `scale(${scale})`,
                                    }}
                            />
                            <div className="text-2xl font-bold text-gray-800">
                                {partner.name}
                            </div>
                            <div className="text-blue-500 font-bold text-xl mt-1">
                                Lv.{partner.level}
                            </div>

                            <div className="mt-6 p-4 bg-gray-100 rounded-xl text-left text-xs text-gray-500 font-mono">
                                ID: {user.name}_2024
                                <br />
                                SPECIES: {partner.speciesId}
                                <br />
                                EXP: {partner.xp} / {partner.maxXp}
                            </div>
                        </div>

                        <button
                                onClick={sendData}
                                className="w-full py-5 bg-blue-600 text-white rounded-2xl text-xl font-bold shadow-xl flex items-center justify-center gap-3 hover:bg-blue-700 transition-colors"
                        >
                            <Send /> ì„ ìƒë‹˜ê»˜ ë³´ë‚´ê¸°
                        </button>
                    </div>
                </div>
                );
                };

                /**
                * ------------------------------------------------------------------
                * ë¼ìš°í„°
                * ------------------------------------------------------------------
                */
                return (
                <div className="max-w-md mx-auto min-h-screen bg-white shadow-2xl overflow-hidden font-sans select-none relative">
                    {screen === "login" && renderLogin()}
                    {screen === "main" && renderMain()}
                    {screen === "training" && renderTraining()}
                    {screen === "explore" && renderExplore()}
                    {screen === "challenge" && renderChallenge()}
                    {screen === "shop" && renderShop()}
                    {screen === "pokedex" && renderPokedex()}
                    {screen === "export" && renderExport()}
                </div>
                );
                }

                /**
                * ------------------------------------------------------------------
                * ê³µí†µ ì»´í¬ë„ŒíŠ¸
                * ------------------------------------------------------------------
                */

                function MenuCard({
                title,
                desc,
                icon,
                color,
                onClick,
                }: {
                title: string;
                desc: string;
                icon: React.ReactNode;
                color: string;
                onClick: () => void;
                }) {
                return (
                <button
                        onClick={onClick}
                        className={`${color} text-white p-5 rounded-[1.5rem] shadow-lg shadow-gray-200 flex flex-col items-start justify-between h-32 active:scale-95 transition-all group overflow-hidden relative`}
                >
                    <div className="absolute right-[-20px] bottom-[-20px] opacity-20 scale-150 group-hover:scale-125 transition-transform">
                        {icon}
                    </div>
                    <div className="bg-white/20 p-2 rounded-xl backdrop-blur-sm">
                        {icon}
                    </div>
                    <div>
                        <div className="font-bold text-lg">
                            {title}
                        </div>
                        <div className="text-xs opacity-80 font-medium">
                            {desc}
                        </div>
                    </div>
                </button>
                );
                }

                function Header({
                title,
                onBack,
                }: {
                title: string;
                onBack: () => void;
                }) {
                return (
                <div className="flex items-center gap-4 mb-2">
                    <button
                            onClick={onBack}
                            className="p-2 bg-white rounded-full shadow-sm text-gray-600 hover:bg-gray-100"
                    >
                        <ChevronLeft />
                    </button>
                    <h1 className="text-xl font-bold text-gray-800">
                        {title}
                    </h1>
                </div>
                );
                }
