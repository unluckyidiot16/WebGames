<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë©´ì—­ ë””íœìŠ¤: ì„¸í¬ vs ë°”ì´ëŸ¬ìŠ¤</title>
    <style>
        body {
            background-color: #2c3e50;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: white;
            overflow: hidden;
        }
        #game-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        canvas {
            background-color: #ffefff; /* ì—°í•œ ë¶„í™ìƒ‰ (ì‹ ì²´ ë‚´ë¶€ ëŠë‚Œ) */
            border-radius: 4px;
            cursor: crosshair;
        }
        /* UI ì˜¤ë²„ë ˆì´ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 4px;
            z-index: 10;
        }
        .hidden { display: none !important; }

        h1 { margin-bottom: 20px; color: #ff6b81; font-size: 3em; text-shadow: 2px 2px #000; }
        h2 { color: #7bed9f; margin-bottom: 10px; }
        p { font-size: 1.2em; margin-bottom: 20px; text-align: center; max-width: 600px; line-height: 1.5; }

        .btn {
            padding: 15px 40px;
            font-size: 1.5em;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
            margin: 10px;
        }
        .btn:hover { transform: scale(1.05); background: #ff6b81; }
        .btn:active { transform: scale(0.95); }

        /* ìƒì  ìŠ¤íƒ€ì¼ */
        #shop-ui { align-items: stretch; padding: 40px; }
        .shop-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .upgrade-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .upgrade-info h3 { margin: 0 0 5px 0; color: #70a1ff; }
        .upgrade-info span { font-size: 0.9em; color: #dfe6e9; }
        .buy-btn {
            background: #2ed573;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.9em;
        }
        .buy-btn:disabled { background: #555; cursor: not-allowed; }

        /* HUD */
        #hud {
            position: absolute;
            top: 0; left: 0; width: 100%;
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: space-between;
            pointer-events: none; /* í´ë¦­ í†µê³¼ */
            font-size: 1.2em;
            font-weight: bold;
            color: #2f3542;
            text-shadow: 1px 1px 0px #fff;
        }
        .stat-box { background: rgba(255,255,255,0.7); padding: 5px 15px; border-radius: 20px; }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas" width="900" height="600"></canvas>

    <div id="hud" class="hidden">
        <div class="stat-box">ğŸ§¬ DNA: <span id="dna-display">0</span></div>
        <div class="stat-box">âš¡ ìì›: <span id="resource-display">100</span> (ì´ˆë‹¹ +<span id="regen-display">1</span>)</div>
        <div class="stat-box">Stage: <span id="stage-display">1</span>/5</div>
        <div class="stat-box">Score: <span id="score-display">0</span></div>
    </div>

    <div id="start-screen" class="overlay">
        <h1>ë©´ì—­ ë””íœìŠ¤</h1>
        <p>ë°”ì´ëŸ¬ìŠ¤ë¡œë¶€í„° ì‹ ì²´ë¥¼ ë³´í˜¸í•˜ì„¸ìš”!<br>ìì›ì„ ëª¨ì•„ ì„¸í¬ë¥¼ ë°°ì¹˜í•˜ê³ , íšë“í•œ DNAë¡œ ì§„í™”í•˜ì„¸ìš”.</p>
        <button class="btn" onclick="startGame()">ì „íˆ¬ ì‹œì‘</button>
    </div>

    <div id="shop-screen" class="overlay hidden">
        <h2 id="result-title" style="color:#ff4757; font-size:2.5em;">ë°©ì–´ ì‹¤íŒ¨!</h2>
        <p>íšë“í•œ DNA: <span id="earned-dna" style="color:#7bed9f; font-weight:bold;">0</span></p>
        <p>í˜„ì¬ ë³´ìœ  DNA: <span id="current-dna" style="color:#7bed9f; font-weight:bold;">0</span></p>

        <div class="shop-grid">
            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h3>ì´ˆê¸° ìì› ì¦ê°€</h3>
                    <span id="upg-start-desc">Lv.1 (ì‹œì‘ 50)</span>
                </div>
                <button class="btn buy-btn" onclick="buyUpgrade('startResource')">ê°•í™” (<span id="cost-start">100</span> DNA)</button>
            </div>
            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h3>ìì› ìƒì„± ì†ë„</h3>
                    <span id="upg-regen-desc">Lv.1 (ëŠë¦¼)</span>
                </div>
                <button class="btn buy-btn" onclick="buyUpgrade('regenSpeed')">ê°•í™” (<span id="cost-regen">150</span> DNA)</button>
            </div>
            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h3>ì„¸í¬ ê³µê²©ë ¥</h3>
                    <span id="upg-dmg-desc">Lv.1 (+0%)</span>
                </div>
                <button class="btn buy-btn" onclick="buyUpgrade('damage')">ê°•í™” (<span id="cost-dmg">200</span> DNA)</button>
            </div>
            <div class="upgrade-card">
                <div class="upgrade-info">
                    <h3>ì²˜ì¹˜ ë³´ìƒ ì¦ê°€</h3>
                    <span id="upg-reward-desc">Lv.1 (ê¸°ë³¸)</span>
                </div>
                <button class="btn buy-btn" onclick="buyUpgrade('reward')">ê°•í™” (<span id="cost-reward">120</span> DNA)</button>
            </div>
        </div>

        <button class="btn" onclick="startGame()">ë‹¤ì‹œ ë„ì „</button>
    </div>

    <div id="clear-screen" class="overlay hidden">
        <h1 style="color:#7bed9f;">ë©´ì—­ ì²´ê³„ ìŠ¹ë¦¬!</h1>
        <p>ëª¨ë“  ë°”ì´ëŸ¬ìŠ¤ë¥¼ ë§‰ì•„ëƒˆìŠµë‹ˆë‹¤.<br>ë‹¹ì‹ ì˜ ë©´ì—­ë ¥ì€ ì™„ë²½í•©ë‹ˆë‹¤!</p>
        <p>ìµœì¢… íšë“ DNA: <span id="final-dna">0</span></p>
        <button class="btn" onclick="openShop(true)">ìƒì ìœ¼ë¡œ</button>
    </div>
</div>

<script>
    /**
     * ê²Œì„ ì„¤ì • ë° ìƒìˆ˜
     */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const GRID_W = 90;
    const GRID_H = 100;
    const COLS = 9;
    const ROWS = 5;
    const TOP_OFFSET = 100; // ì¹´ë“œ ì„ íƒ ì˜ì—­ ê³µê°„

    // ì´ë¯¸ì§€ ìì‚° ë¡œë“œ
    const images = {};
    const imageSources = {
        'cell0': 'cell0.png',
        'cell1': 'cell1.png',
        'cell2': 'cell2.png',
        'cell3': 'cell3.png',
        'cell4': 'cell4.png',
        'cell5': 'cell5.png',
        'virus0': 'virus0.png',
        'virus1': 'virus1.png',
        'virus2': 'virus2.png',
        'virus3': 'virus3.png',
    };

    // ìœ ë‹› ì •ì˜ (ì„¸í¬)
    const CELL_TYPES = [
        { id: 0, name: "ëŒ€ì‹ì„¸í¬", cost: 50,  hp: 100, dmg: 20, range: 9, rate: 60, desc: "ê¸°ë³¸ ì›ê±°ë¦¬ ê³µê²©", img: 'cell0' },
        { id: 1, name: "ì„¸í¬ë²½",   cost: 50,  hp: 800, dmg: 0,  range: 0, rate: 0,  desc: "ë†’ì€ ì²´ë ¥, ê³µê²© ë¶ˆê°€", img: 'cell1' },
        { id: 2, name: "Tì„¸í¬",    cost: 150, hp: 150, dmg: 80, range: 9, rate: 120, desc: "ëŠë¦¬ì§€ë§Œ ê°•ë ¥í•œ í•œë°©", img: 'cell2' },
        { id: 3, name: "NKì„¸í¬",   cost: 100, hp: 200, dmg: 10, range: 1, rate: 20,  desc: "ì‚¬ê±°ë¦¬ê°€ ì§§ì§€ë§Œ ë§¤ìš° ë¹ ë¦„", img: 'cell3' },
        { id: 4, name: "í˜•ì§ˆì„¸í¬", cost: 250, hp: 150, dmg: 20, range: 9, rate: 60,  desc: "ë‘ ë²ˆ ì—°ì† ë°œì‚¬", img: 'cell4', double: true },
        { id: 5, name: "ë°±í˜ˆêµ¬ì¥", cost: 400, hp: 300, dmg: 30, range: 9, rate: 50,  desc: "ê´€í†µ ê³µê²©", img: 'cell5', pierce: true }
    ];

    // ì  ì •ì˜ (ë°”ì´ëŸ¬ìŠ¤)
    const VIRUS_TYPES = [
        { id: 0, hp: 100, speed: 0.3, dmg: 1, score: 1, img: 'virus0' }, // ê¸°ë³¸
        { id: 1, hp: 60,  speed: 0.7, dmg: 1, score: 2, img: 'virus1' }, // ë¹ ë¦„
        { id: 2, hp: 300, speed: 0.2, dmg: 2, score: 3, img: 'virus2' }, // íŠ¼íŠ¼
        { id: 3, hp: 1000,speed: 0.15,dmg: 5, score: 10, img: 'virus3'}  // ë³´ìŠ¤
    ];

    // ì˜êµ¬ ì—…ê·¸ë ˆì´ë“œ ìƒíƒœ (localStorage ì €ì¥ìš©)
    let playerStats = JSON.parse(localStorage.getItem('immuneGameStats')) || {
        dna: 0,
        startResourceLv: 1, // ë ˆë²¨ë‹¹ ì‹œì‘ ìì› +25
        regenSpeedLv: 1,    // ë ˆë²¨ë‹¹ ìƒì„± ì¿¨íƒ€ì„ ê°ì†Œ
        damageLv: 1,        // ë ˆë²¨ë‹¹ ë°ë¯¸ì§€ 10% ì¦ê°€
        rewardLv: 1         // ë ˆë²¨ë‹¹ í‚¬ ë³´ìƒ(ìì›) ì¦ê°€
    };

    // ê²Œì„ ëŸ°íƒ€ì„ ë³€ìˆ˜
    let gameState = 'START'; // START, PLAYING, GAMEOVER, CLEAR
    let resources = 100;
    let stage = 1;
    let frame = 0;
    let score = 0; // ì´ë²ˆ íŒ ì¡ì€ ë°”ì´ëŸ¬ìŠ¤ ìˆ˜ (DNA í™˜ì‚°ìš©)
    let cells = [];
    let viruses = [];
    let projectiles = [];
    let explosions = []; // ì‹œê° íš¨ê³¼
    let selectedCellType = 0;
    let resourceTimer = 0;
    let spawnTimer = 0;
    let stageProgress = 0; // ìŠ¤í…Œì´ì§€ ì§„í–‰ë„

    // ì—…ê·¸ë ˆì´ë“œ ë¹„ìš© ê³„ì‚°
    const getCost = (lv) => Math.floor(100 * Math.pow(1.5, lv - 1));

    // ì´ë¯¸ì§€ ë¡œë”© ì²˜ë¦¬
    let imagesLoaded = 0;
    const totalImages = Object.keys(imageSources).length;
    for(let key in imageSources) {
        images[key] = new Image();
        images[key].src = imageSources[key];
        images[key].onload = () => imagesLoaded++;
        // ì—ëŸ¬ë‚˜ë„ ê²Œì„ì€ ë˜ê²Œ ì²˜ë¦¬
        images[key].onerror = () => imagesLoaded++;
    }

    /**
     * ê²Œì„ ë£¨í”„ ë° ë¡œì§
     */
    function init() {
        canvas.addEventListener('mousedown', handleInput);
        updateShopUI();
        // ì²« ì‹¤í–‰ ì‹œ ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥
        saveStats();
        gameLoop();
    }

    function saveStats() {
        localStorage.setItem('immuneGameStats', JSON.stringify(playerStats));
    }

    function startGame() {
        // ê²Œì„ ì´ˆê¸°í™”
        stage = 1;
        score = 0;

        // ì—…ê·¸ë ˆì´ë“œ ì ìš©
        resources = 50 + (playerStats.startResourceLv - 1) * 25;

        resetStage();

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('shop-screen').classList.add('hidden');
        document.getElementById('clear-screen').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');

        gameState = 'PLAYING';
    }

    function resetStage() {
        cells = [];
        viruses = [];
        projectiles = [];
        frame = 0;
        spawnTimer = 0;
        stageProgress = 0;
        updateHUD();
    }

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        if (gameState === 'PLAYING') {
            update();
            draw();
        } else if (gameState === 'START') {
            // ë°°ê²½ë§Œ ê·¸ë¦¼
            drawBackground();
        }

        requestAnimationFrame(gameLoop);
    }

    function update() {
        frame++;

        // 1. ìì› ìƒì„± (ì‹œê°„ ë¹„ë¡€)
        // ê¸°ë³¸ 300í”„ë ˆì„(ì•½ 5ì´ˆ) -> ë ˆë²¨ì—…ë§ˆë‹¤ 10%ì”© ë‹¨ì¶•
        let regenTime = Math.max(60, Math.floor(300 * Math.pow(0.9, playerStats.regenSpeedLv - 1)));
        resourceTimer++;
        if (resourceTimer >= regenTime) {
            resources += 25;
            resourceTimer = 0;
            createFloatingText(canvas.width/2, 50, "+25", "#f1c40f");
        }

        // 2. ë°”ì´ëŸ¬ìŠ¤ ìŠ¤í° ë¡œì§
        spawnViruses();

        // 3. ìœ ë‹› ì—…ë°ì´íŠ¸
        cells.forEach(cell => cell.update());
        viruses.forEach((virus, idx) => {
            virus.update();
            if (virus.x < 0) {
                gameOver();
            }
            if (virus.hp <= 0) {
                // ì²˜ì¹˜ ë³´ìƒ
                let reward = 10 + (playerStats.rewardLv - 1) * 2;
                resources += reward;
                score += virus.type.score; // ì ìˆ˜ ëˆ„ì 
                viruses.splice(idx, 1);
            }
        });

        // 4. íˆ¬ì‚¬ì²´ ì—…ë°ì´íŠ¸
        projectiles.forEach((proj, idx) => {
            proj.update();
            if (proj.remove) projectiles.splice(idx, 1);
        });

        // 5. ì£½ì€ ì„¸í¬ ì œê±°
        cells = cells.filter(cell => cell.hp > 0);

        updateHUD();
    }

    function spawnViruses() {
        spawnTimer++;
        // ìŠ¤í…Œì´ì§€ê°€ ë†’ì„ìˆ˜ë¡ ìŠ¤í° ì£¼ê¸° ë¹¨ë¼ì§
        let spawnRate = Math.max(60, 400 - (stage * 50));

        if (spawnTimer > spawnRate) {
            spawnTimer = 0;
            let lane = Math.floor(Math.random() * ROWS);

            // ìŠ¤í…Œì´ì§€ë³„ ë“±ì¥ ë°”ì´ëŸ¬ìŠ¤ ë° í™•ë¥ 
            let typeId = 0;
            let rand = Math.random();

            if (stage === 1) { typeId = 0; }
            else if (stage === 2) { typeId = rand < 0.3 ? 1 : 0; } // 30% í™•ë¥ ë¡œ ë¹ ë¥¸ë†ˆ
            else if (stage === 3) { typeId = rand < 0.2 ? 2 : (rand < 0.5 ? 1 : 0); } // 20% íƒ±ì»¤
            else if (stage === 4) { typeId = rand < 0.3 ? 2 : (rand < 0.6 ? 1 : 0); }
            else if (stage === 5) { typeId = rand < 0.1 ? 3 : (rand < 0.4 ? 2 : 1); } // ë³´ìŠ¤ ë“±ì¥

            // ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì¡°ê±´ (ì„ì‹œ: í”„ë ˆì„ ê¸°ë°˜ ë˜ëŠ” ì²˜ì¹˜ ìˆ˜)
            // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì¼ì • ì‹œê°„ ë²„í‹°ë©´ ë‹¤ìŒ ìŠ¤í…Œì´ì§€ë¡œ
            stageProgress++;
            if (stageProgress > 10 + (stage * 5)) { // ì›¨ì´ë¸Œ ìˆ˜
                if (viruses.length === 0) {
                    nextStage();
                    return;
                }
            } else {
                viruses.push(new Virus(lane, typeId));
            }
        }
    }

    function nextStage() {
        if (stage >= 5) {
            gameClear();
        } else {
            stage++;
            createFloatingText(canvas.width/2, canvas.height/2, `STAGE ${stage} START!`, "#fff", 40);
            resetStage(); // ìœ ë‹›ì€ ìœ ì§€? ë³´í†µì€ ìœ ì§€í•¨. ì—¬ê¸°ì„œëŠ” ìœ ì§€.
            // resetStage() í•¨ìˆ˜ì—ì„œ cells = []ë¥¼ ë¹¼ì•¼ ìœ ì§€ë¨. 
            // ìˆ˜ì •: ìŠ¤í…Œì´ì§€ ë„˜ì–´ê°€ë„ ë°°ì¹˜ëœ ì„¸í¬ ìœ ì§€í•˜ë„ë¡ cells ì´ˆê¸°í™” ì œê±°
            spawnTimer = 0;
            stageProgress = 0;
        }
    }

    function gameOver() {
        gameState = 'GAMEOVER';
        let earnedDNA = score;
        playerStats.dna += earnedDNA;
        saveStats();

        document.getElementById('result-title').innerText = "ë°©ì–´ ì‹¤íŒ¨!";
        document.getElementById('earned-dna').innerText = `+${earnedDNA}`;
        openShop(false);
    }

    function gameClear() {
        gameState = 'CLEAR';
        let earnedDNA = score + 100; // í´ë¦¬ì–´ ë³´ë„ˆìŠ¤
        playerStats.dna += earnedDNA;
        saveStats();

        document.getElementById('final-dna').innerText = earnedDNA;
        document.getElementById('clear-screen').classList.remove('hidden');
        document.getElementById('hud').classList.add('hidden');
    }

    function openShop(isClear) {
        updateShopUI();
        if(isClear) document.getElementById('clear-screen').classList.add('hidden');
        document.getElementById('shop-screen').classList.remove('hidden');
        document.getElementById('hud').classList.add('hidden');
    }

    function updateShopUI() {
        document.getElementById('current-dna').innerText = playerStats.dna;
        document.getElementById('dna-display').innerText = playerStats.dna;

        // UI ì—…ë°ì´íŠ¸ í—¬í¼
        const updateCard = (key, name, descFn) => {
            let lv = playerStats[key + 'Lv'];
            let cost = getCost(lv);
            document.getElementById(`upg-${key}-desc`).innerText = descFn(lv);
            let btn = document.querySelector(`button[onclick="buyUpgrade('${key}')"]`);
            btn.innerHTML = `ê°•í™” (${cost} DNA)`;
            btn.disabled = playerStats.dna < cost;
        };

        updateCard('start', 'ì‹œì‘ ìì›', lv => `Lv.${lv} (ì‹œì‘ ${50 + (lv-1)*25})`);
        updateCard('regen', 'ìƒì„± ì†ë„', lv => `Lv.${lv} (ì¿¨íƒ€ì„ ${Math.floor(300 * Math.pow(0.9, lv-1))}F)`);
        updateCard('damage', 'ê³µê²©ë ¥', lv => `Lv.${lv} (ë°ë¯¸ì§€ x${(1 + (lv-1)*0.1).toFixed(1)})`);
        updateCard('reward', 'ë³´ìƒ', lv => `Lv.${lv} (ì²˜ì¹˜ì‹œ +${10 + (lv-1)*2})`);
    }

    function buyUpgrade(type) {
        let key = type;
        if(type === 'startResource') key = 'startResource'; // ë§¤í•‘ í™•ì¸

        let lvKey = type + 'Lv';
        let cost = getCost(playerStats[lvKey]);

        if (playerStats.dna >= cost) {
            playerStats.dna -= cost;
            playerStats[lvKey]++;
            saveStats();
            updateShopUI();
        }
    }

    /**
     * ê·¸ë¦¬ê¸° ê´€ë ¨
     */
    function draw() {
        drawBackground();

        // ê·¸ë¦¬ë“œ í•˜ì´ë¼ì´íŠ¸ (ë§ˆìš°ìŠ¤ ì˜¤ë²„)
        // ìƒëµ ê°€ëŠ¥

        // ë°°ì¹˜ëœ ì„¸í¬
        cells.forEach(cell => cell.draw());

        // ë°”ì´ëŸ¬ìŠ¤
        viruses.forEach(virus => virus.draw());

        // íˆ¬ì‚¬ì²´
        projectiles.forEach(proj => proj.draw());

        // ì¹´ë“œ UI (ìƒë‹¨)
        drawCardUI();
    }

    function drawBackground() {
        // ë°°ê²½
        ctx.fillStyle = "#ffefff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // ê·¸ë¦¬ë“œ ë¼ì¸
        ctx.strokeStyle = "rgba(0,0,0,0.1)";
        ctx.lineWidth = 1;

        // ê°€ë¡œì¤„ (ë ˆì¸)
        for (let i = 0; i <= ROWS; i++) {
            let y = TOP_OFFSET + i * GRID_H;
            ctx.beginPath();
            ctx.moveTo(0, y);
            ctx.lineTo(canvas.width, y);
            ctx.stroke();
        }
        // ì„¸ë¡œì¤„
        for (let i = 0; i <= COLS; i++) {
            let x = i * GRID_W;
            ctx.beginPath();
            ctx.moveTo(x, TOP_OFFSET);
            ctx.lineTo(x, canvas.height);
            ctx.stroke();
        }

        // ë ˆì¸ ë°°ê²½ (êµì°¨ ìƒ‰ìƒ)
        for (let r=0; r<ROWS; r++) {
            if(r%2 === 1) {
                ctx.fillStyle = "rgba(255, 200, 200, 0.1)";
                ctx.fillRect(0, TOP_OFFSET + r*GRID_H, canvas.width, GRID_H);
            }
        }
    }

    function drawCardUI() {
        // ìƒë‹¨ ì¹´ë“œ ì˜ì—­
        ctx.fillStyle = "#34495e";
        ctx.fillRect(0, 0, canvas.width, TOP_OFFSET);

        CELL_TYPES.forEach((type, idx) => {
            let x = 10 + idx * 85;
            let y = 10;
            let w = 75;
            let h = 80;

            // ì„ íƒëœ ì¹´ë“œ í•˜ì´ë¼ì´íŠ¸
            if (selectedCellType === idx) {
                ctx.fillStyle = "#f1c40f";
                ctx.fillRect(x-2, y-2, w+4, h+4);
            }

            // ì¹´ë“œ ë°°ê²½
            ctx.fillStyle = resources >= type.cost ? "#ecf0f1" : "#7f8c8d";
            ctx.fillRect(x, y, w, h);

            // ì´ë¯¸ì§€
            let img = images[type.img];
            if (img && img.complete && img.naturalWidth !== 0) {
                ctx.drawImage(img, x+10, y+5, 55, 55);
            } else {
                ctx.fillStyle = getCellColor(idx);
                ctx.fillRect(x+15, y+15, 45, 45);
            }

            // ë¹„ìš© í…ìŠ¤íŠ¸
            ctx.fillStyle = "#2c3e50";
            ctx.font = "bold 14px Arial";
            ctx.fillText(type.cost, x + 5, y + 75);
        });
    }

    // ì´ë¯¸ì§€ ì—†ì„ ë•Œ ëŒ€ì²´ ìƒ‰ìƒ
    function getCellColor(id) {
        const colors = ['#e84393', '#74b9ff', '#6c5ce7', '#00cec9', '#fdcb6e', '#d63031'];
        return colors[id % colors.length];
    }

    /**
     * í´ë˜ìŠ¤ ì •ì˜
     */
    class Cell {
        constructor(c, r, typeId) {
            this.c = c;
            this.r = r;
            this.x = c * GRID_W;
            this.y = TOP_OFFSET + r * GRID_H;
            this.type = CELL_TYPES[typeId];
            this.hp = this.type.hp;
            this.cooldown = 0;

            // ì—…ê·¸ë ˆì´ë“œ ì ìš©ëœ ë°ë¯¸ì§€
            let dmgMult = 1 + (playerStats.damageLv - 1) * 0.1;
            this.damage = this.type.dmg * dmgMult;
        }

        update() {
            if (this.cooldown > 0) this.cooldown--;

            // ê³µê²© ë¡œì§ (ì„¸í¬ë²½ ì œì™¸)
            if (this.type.dmg > 0 && this.cooldown <= 0) {
                // ê°™ì€ ë¼ì¸ì˜ ë°”ì´ëŸ¬ìŠ¤ ê°ì§€
                let targets = viruses.filter(v =>
                    v.r === this.r &&
                    v.x > this.x &&
                    v.x < this.x + (this.type.range + 1) * GRID_W
                );

                if (targets.length > 0) {
                    this.shoot();
                    this.cooldown = this.type.rate;
                }
            }
        }

        shoot() {
            // íˆ¬ì‚¬ì²´ ìƒì„±
            let pType = this.type.pierce ? 'pierce' : 'normal';
            projectiles.push(new Projectile(this.x + 60, this.y + 50, this.r, this.damage, pType));

            if (this.type.double) {
                setTimeout(() => {
                    projectiles.push(new Projectile(this.x + 60, this.y + 50, this.r, this.damage, pType));
                }, 200); // 0.2ì´ˆ í›„ ë°œì‚¬
            }
        }

        draw() {
            let img = images[this.type.img];
            if (img && img.complete && img.naturalWidth !== 0) {
                ctx.drawImage(img, this.x + 10, this.y + 10, 70, 80);
            } else {
                ctx.fillStyle = getCellColor(this.type.id);
                ctx.beginPath();
                ctx.arc(this.x + 45, this.y + 50, 30, 0, Math.PI*2);
                ctx.fill();
            }

            // ì²´ë ¥ë°” (ë°ë¯¸ì§€ ì…ì—ˆì„ ë•Œë§Œ)
            if (this.hp < this.type.hp) {
                ctx.fillStyle = "red";
                ctx.fillRect(this.x + 15, this.y + 5, 60, 5);
                ctx.fillStyle = "#00b894";
                ctx.fillRect(this.x + 15, this.y + 5, 60 * (this.hp / this.type.hp), 5);
            }
        }
    }

    class Virus {
        constructor(r, typeId) {
            this.r = r;
            this.type = VIRUS_TYPES[typeId];
            this.x = canvas.width;
            this.y = TOP_OFFSET + r * GRID_H;
            this.hp = this.type.hp;
            this.maxHp = this.type.hp;
            this.speed = this.type.speed;
            this.eating = false;
            this.eatCooldown = 0;
        }

        update() {
            this.eating = false;

            // ì¶©ëŒ ì²´í¬ (ì„¸í¬ì™€)
            for (let cell of cells) {
                if (cell.r === this.r &&
                    this.x < cell.x + GRID_W - 20 &&
                    this.x + 50 > cell.x + 20) {

                    this.eating = true;
                    if (this.eatCooldown <= 0) {
                        cell.hp -= this.type.dmg;
                        this.eatCooldown = 60; // 1ì´ˆì— 1ë²ˆ ê³µê²© (í”„ë ˆì„ 60ê¸°ì¤€)
                    }
                    break;
                }
            }

            if (this.eating) {
                this.eatCooldown--;
            } else {
                this.x -= this.speed;
            }
        }

        draw() {
            let img = images[this.type.img];
            if (img && img.complete && img.naturalWidth !== 0) {
                ctx.drawImage(img, this.x, this.y + 10, 70, 80);
            } else {
                ctx.fillStyle = "#555";
                ctx.fillRect(this.x, this.y + 20, 60, 60);
            }

            // ì²´ë ¥ë°”
            ctx.fillStyle = "red";
            ctx.fillRect(this.x + 10, this.y, 50, 5);
            ctx.fillStyle = "#00b894";
            ctx.fillRect(this.x + 10, this.y, 50 * (this.hp / this.maxHp), 5);
        }
    }

    class Projectile {
        constructor(x, y, r, damage, pType) {
            this.x = x;
            this.y = y;
            this.r = r;
            this.damage = damage;
            this.speed = 5;
            this.remove = false;
            this.pType = pType; // 'normal' or 'pierce'
        }

        update() {
            this.x += this.speed;
            if (this.x > canvas.width) this.remove = true;

            // ì¶©ëŒ ì²´í¬
            for (let virus of viruses) {
                if (virus.r === this.r &&
                    this.x > virus.x + 20 &&
                    this.x < virus.x + 60) {

                    virus.hp -= this.damage;

                    if (this.pType !== 'pierce') {
                        this.remove = true;
                    }
                    break; // í•œ ë²ˆì— í•œ ë†ˆë§Œ (ê´€í†µ ì•„ë‹ ë•Œ)
                }
            }
        }

        draw() {
            ctx.fillStyle = this.pType === 'pierce' ? "#ff0000" : "#fdcb6e";
            ctx.beginPath();
            ctx.arc(this.x, this.y, 6, 0, Math.PI*2);
            ctx.fill();
        }
    }

    /**
     * ì…ë ¥ ì²˜ë¦¬
     */
    function handleInput(e) {
        if (gameState !== 'PLAYING') return;

        const rect = canvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        // ì¹´ë“œ ì„ íƒ ì˜ì—­ í´ë¦­
        if (mouseY < TOP_OFFSET) {
            let idx = Math.floor((mouseX - 10) / 85);
            if (idx >= 0 && idx < CELL_TYPES.length) {
                selectedCellType = idx;
            }
            return;
        }

        // ê·¸ë¦¬ë“œ í´ë¦­ (ì„¸í¬ ë°°ì¹˜)
        let c = Math.floor(mouseX / GRID_W);
        let r = Math.floor((mouseY - TOP_OFFSET) / GRID_H);

        if (c >= 0 && c < COLS && r >= 0 && r < ROWS) {
            // ì´ë¯¸ ìˆëŠ”ì§€ í™•ì¸
            if (cells.some(cell => cell.c === c && cell.r === r)) return;

            // ë¹„ìš© í™•ì¸
            let type = CELL_TYPES[selectedCellType];
            if (resources >= type.cost) {
                resources -= type.cost;
                cells.push(new Cell(c, r, selectedCellType));
                updateHUD();
            }
        }
    }

    function updateHUD() {
        document.getElementById('resource-display').innerText = resources;
        document.getElementById('stage-display').innerText = `${stage}/5`;
        document.getElementById('score-display').innerText = score;
        // ì¬ìƒì„± ì‹œê°„ í‘œì‹œ ì—…ë°ì´íŠ¸
        let regenTime = Math.max(60, Math.floor(300 * Math.pow(0.9, playerStats.regenSpeedLv - 1)));
        let perSec = (60 / regenTime * 25).toFixed(1);
        document.getElementById('regen-display').innerText = perSec;
    }

    function createFloatingText(x, y, text, color, size=20) {
        // ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ íš¨ê³¼ (ì‹¤ì œ êµ¬í˜„ì€ ë³µì¡í•´ì§ˆ ìˆ˜ ìˆì–´ ì½˜ì†” ë¡œê·¸ë¡œ ëŒ€ì²´í•˜ê±°ë‚˜ ìƒëµ)
        // ì—¬ê¸°ì„œëŠ” ê°œë…ì ìœ¼ë¡œë§Œ ë‚¨ê¹€
    }

    // ì´ˆê¸°í™” ì‹œì‘
    init();

</script>

</body>
</html>