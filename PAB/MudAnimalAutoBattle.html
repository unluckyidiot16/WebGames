<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ì¼“ í€´ì¦ˆ ì˜¤í† ë°°í‹€ëŸ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #F0F4F8; }
        .unit-card { transition: all 0.2s ease; cursor: pointer; user-select: none; }
        .unit-card:hover { transform: translateY(-4px); }
        .selected { outline: 3px solid #4A90E2; transform: translateY(-4px) scale(1.05); box-shadow: 0 6px 12px rgba(74,144,226,0.4); }
        .faint-animation { animation: faint 0.5s ease-out forwards; }
        @keyframes faint { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.8); } }
        .attack-animation { animation: attack 0.4s ease-in-out; }
        @keyframes attack { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(15px); } }
        .enemy-attack-animation { animation: enemy-attack 0.4s ease-in-out; }
        @keyframes enemy-attack { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(-15px); } }
        .damage-text { animation: damage-show 0.5s ease-out forwards; position: absolute; bottom: 50%; left: 50%; transform: translateX(-50%); font-weight: bold; font-size: 1.5rem; color: #E53E3E; text-shadow: 1px 1px #fff; pointer-events: none; }
        @keyframes damage-show { from { opacity: 1; transform: translate(-50%, 0); } to { opacity: 0; transform: translate(-50%, -30px); } }
        .quiz-option:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body class="p-4">

<div id="game-container" class="max-w-7xl mx-auto">
    <div id="info-bar" class="flex justify-between items-center bg-slate-800 p-3 rounded-lg shadow-md mb-4 text-white">
        <div class="flex items-center space-x-6">
            <div><span class="font-bold">í„´:</span> <span id="turn-counter">0</span></div>
            <div id="life-counter"></div>
        </div>
        <div class="text-2xl font-bold" id="environment-indicator"></div>
    </div>

    <div id="quiz-area" class="hidden mb-4">
        <div class="max-w-2xl mx-auto bg-white border-4 border-blue-400 rounded-2xl p-6 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <div class="bg-blue-100 text-blue-800 px-4 py-1 rounded-full font-bold">í€´ì¦ˆ ë¼ìš´ë“œ</div>
                <div class="text-xl font-bold text-red-500">â± <span id="quiz-timer">0</span>s</div>
            </div>
            <div class="flex justify-between text-sm text-slate-500 mb-4">
                <div>ì§„í–‰: <span id="quiz-progress">0/0</span></div>
                <div>ì •ë‹µ: <span id="quiz-correct">0</span></div>
            </div>
            <div id="quiz-prompt" class="text-2xl font-extrabold text-center text-slate-800 mb-8 h-16 flex items-center justify-center">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            <div class="grid grid-cols-2 gap-4" id="quiz-options">
                <button class="quiz-option bg-slate-100 hover:bg-blue-500 hover:text-white transition-colors border-2 border-slate-200 rounded-xl p-4 font-bold text-lg" data-idx="0" id="quiz-opt-0">A</button>
                <button class="quiz-option bg-slate-100 hover:bg-blue-500 hover:text-white transition-colors border-2 border-slate-200 rounded-xl p-4 font-bold text-lg" data-idx="1" id="quiz-opt-1">B</button>
                <button class="quiz-option bg-slate-100 hover:bg-blue-500 hover:text-white transition-colors border-2 border-slate-200 rounded-xl p-4 font-bold text-lg" data-idx="2" id="quiz-opt-2">C</button>
                <button class="quiz-option bg-slate-100 hover:bg-blue-500 hover:text-white transition-colors border-2 border-slate-200 rounded-xl p-4 font-bold text-lg" data-idx="3" id="quiz-opt-3">D</button>
            </div>
            <div class="mt-6 text-center text-sm text-slate-400">
                ì´ë²ˆ í„´ íšë“ ê°€ëŠ¥ QP = ê¸°ë³¸ <span id="quiz-baseqp">0</span> + ë³´ë„ˆìŠ¤ ìµœëŒ€ <span id="quiz-bonuscap">0</span>
            </div>
        </div>
    </div>

    <div id="selection-info" class="text-center mb-2 h-6 font-semibold text-blue-700"></div>

    <div id="battle-view">
        <div id="enemy-team-area" class="mb-4 min-h-[160px]">
            <h2 class="text-center text-xl font-bold text-gray-400 mb-2">ìƒëŒ€ íŒ€</h2>
            <div id="enemy-team" class="team-board flex justify-center items-center space-x-2"></div>
        </div>

        <div id="battle-log-container" class="h-24 bg-white/50 rounded-lg p-2 overflow-y-auto mb-4 border-2 border-gray-300 shadow-inner hidden">
            <div id="battle-log" class="text-sm"></div>
        </div>

        <div id="player-team-area" class="mb-2 min-h-[160px]">
            <h2 class="text-center text-xl font-bold text-gray-600 mb-2">ë‚˜ì˜ íŒ€</h2>
            <div id="player-team" class="team-board flex justify-center items-start space-x-2 p-4 rounded-lg"></div>
        </div>

        <div id="player-bench-area" class="mb-4 min-h-[160px]">
            <h2 class="text-center text-lg font-semibold text-gray-500 mb-2">ë²¤ì¹˜</h2>
            <div id="player-bench" class="team-board flex justify-center items-start space-x-2 p-4 rounded-lg bg-black/5"></div>
        </div>
    </div>

    <div id="shop-area" class="bg-blue-600 p-4 rounded-xl shadow-lg relative hidden">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-white">í¬ì¼“ ìƒì </h2>
            <div class="flex items-center space-x-2">
                <button id="roll-button" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">ë¦¬ë¡¤ (1QP)</button>
                <button id="end-turn-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105">ì „íˆ¬ ì‹œì‘</button>
            </div>
        </div>
        <div class="flex justify-center space-x-4">
            <div id="shop-units" class="flex justify-start items-center space-x-2"></div>
            <div id="shop-foods" class="flex justify-start items-center space-x-2"></div>
        </div>
        <div id="shop-qp-display" class="absolute bottom-4 right-6 text-white text-xl font-bold">
            <span id="qp-counter">0</span> QP
        </div>
    </div>

    <div id="win-trophy-bar" class="mt-4 bg-slate-200 p-3 rounded-lg flex justify-center items-center space-x-2 h-16"></div>
</div>

<div id="modal" class="hidden fixed inset-0 bg-black/60 flex justify-center items-center z-50">
    <div class="bg-white p-8 rounded-2xl shadow-2xl text-center">
        <h2 id="modal-title" class="text-4xl font-bold mb-4"></h2>
        <p id="modal-text" class="text-lg mb-6"></p>
        <button id="restart-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg text-xl">ìƒˆ ê²Œì„ ì‹œì‘</button>
    </div>
</div>

<script type="module">
    const ENVIRONMENTS = { HIGH_TIDE: { name: 'ë°€ë¬¼', color: '#a2d2ff' }, LOW_TIDE: { name: 'ì°ë¬¼', color: '#b08968' } };
    const TIER_COLORS = { 1: 'bg-stone-100', 2: 'bg-green-100', 3: 'bg-blue-100', 4: 'bg-purple-100', 5: 'bg-yellow-100', 6: 'bg-red-100', 'T': 'bg-gray-200' };
    const POKE_SPRITE_BASE = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon";

    const QUIZ_CONFIG = { baseQP: 6, bonusCap: 6, questionsPerTurn: 5, timeLimitSec: 30 };
    const QUIZ_PACK = [
        { prompt: "7 + 5 = ?", options: ["10","11","12","13"], answerIndex: 2 },
        { prompt: "9 - 3 = ?", options: ["5","6","7","8"], answerIndex: 1 },
        { prompt: "6 Ã— 3 = ?", options: ["12","15","18","21"], answerIndex: 2 },
        { prompt: "20 Ã· 4 = ?", options: ["4","5","6","7"], answerIndex: 1 },
        { prompt: "12 + 8 = ?", options: ["18","19","20","21"], answerIndex: 2 },
        { prompt: "15 - 7 = ?", options: ["6","7","8","9"], answerIndex: 2 },
        { prompt: "4 Ã— 4 = ?", options: ["12","14","16","18"], answerIndex: 2 },
        { prompt: "30 Ã· 5 = ?", options: ["5","6","7","8"], answerIndex: 1 }
    ];

    const UNIT_DATA = {
        bajirak: { name: 'ê¼¬ë§ˆëŒ', tier: 1, atk: 3, hp: 2, pokeId: 74, trigger: 'hurt', desc: 'í”¼ê²©: ìì‹  ê³µê²©ë ¥ +1.', score: 3, level2: { atk: 6, hp: 4, desc: 'í”¼ê²©: ìì‹  ê³µê²©ë ¥ +2.', score: 11 } },
        mudworm: { name: 'ìºí„°í”¼', tier: 1, atk: 2, hp: 2, pokeId: 10, trigger: 'faint', desc: 'í‡´ì¥: 1/1 ë²Œë ˆ ì†Œí™˜.', score: 4, level2: { atk: 4, hp: 4, desc: 'í‡´ì¥: 2/2 ë²Œë ˆ 2ë§ˆë¦¬ ì†Œí™˜.', score: 14 } },
        mudSnail: { name: 'ì¹˜ì½”ë¦¬íƒ€', tier: 1, atk: 1, hp: 3, pokeId: 152, trigger: 'buy', desc: 'êµ¬ë§¤: ë¬´ì‘ìœ„ ì•„êµ° ì²´ë ¥ +1.', score: 3, level2: { atk: 2, hp: 6, desc: 'êµ¬ë§¤: ë¬´ì‘ìœ„ ì•„êµ° ë‘˜ ì²´ë ¥ +1.', score: 11 } },
        smallCrab: { name: 'í¬ë©', tier: 1, atk: 3, hp: 2, pokeId: 98, trigger: 'startOfBattle', desc: 'ì‹œì‘: ë’¤ ì¹œêµ¬ ê³µê²©ë ¥ +1.', score: 4, level2: { atk: 6, hp: 4, desc: 'ì‹œì‘: ë’¤ ì¹œêµ¬ ê³µê²©ë ¥ +2.', score: 14 } },
        daehap: { name: 'ì…€ëŸ¬', tier: 2, atk: 2, hp: 4, pokeId: 90, trigger: 'startOfBattle', desc: 'ì‹œì‘: ë’¤ ì¹œêµ¬ +1/+1.', score: 6, level2: { atk: 4, hp: 8, desc: 'ì‹œì‘: ë’¤ ì¹œêµ¬ +2/+2.', score: 21 } },
        ppulsora: { name: 'ì•”ë‚˜ì´íŠ¸', tier: 2, atk: 3, hp: 3, pokeId: 138, trigger: 'startOfBattle', desc: 'ì‹œì‘: ì „ì—´ì´ë©´ íšŒí”¼ 1íšŒ.', score: 6, level2: { atk: 6, hp: 6, desc: 'ì‹œì‘: ì „ì—´ì´ë©´ íšŒí”¼ 2íšŒ.', score: 21 } },
        mangdungeo: { name: 'ì‰ì–´í‚¹', tier: 2, atk: 3, hp: 3, pokeId: 129, trigger: 'startOfBattle', desc: 'ì‹œì‘: ë¬´ì‘ìœ„ ì•„êµ° ê³µê²©ë ¥ +1.', score: 5, level2: { atk: 6, hp: 6, desc: 'ì‹œì‘: ë¬´ì‘ìœ„ ì•„êµ° ë‘˜ ê³µê²©ë ¥ +1.', score: 18 } },
        nongge: { name: 'ì§‘ê²Œì¥êµ°', tier: 2, atk: 4, hp: 2, pokeId: 99, trigger: 'beforeAttack', desc: 'ê³µê²© ì „: ì• ì ì—ê²Œ 1 í”¼í•´.', score: 7, level2: { atk: 8, hp: 4, desc: 'ê³µê²© ì „: ì• ì ì—ê²Œ 2 í”¼í•´.', score: 25 } },
        honghap: { name: 'íŒŒë¥´ì…€', tier: 3, atk: 4, hp: 3, pokeId: 91, trigger: 'hurt', desc: 'í”¼ê²©: ì• ì  ê³µê²©ë ¥ -1.', score: 8, level2: { atk: 8, hp: 6, desc: 'í”¼ê²©: ì• ì  ê³µê²©ë ¥ -2.', score: 28 } },
        garibi: { name: 'ì§„ì£¼ëª½', tier: 3, atk: 5, hp: 3, pokeId: 366, trigger: 'faint', desc: 'í‡´ì¥: 2/2 ì§„ì£¼ 2ë§ˆë¦¬ ì†Œí™˜.', score: 10, level2: { atk: 10, hp: 6, desc: 'í‡´ì¥: 4/4 ì§„ì£¼ 2ë§ˆë¦¬ ì†Œí™˜.', score: 35 } },
        jjangddungeo: { name: 'ë¯¸ê¾¸ë¦¬', tier: 3, atk: 5, hp: 3, pokeId: 339, trigger: 'beforeAttack', desc: 'ê³µê²© ì „: ì• ì ì—ê²Œ 2 í”¼í•´.', score: 9, level2: { atk: 10, hp: 6, desc: 'ê³µê²© ì „: ì• ì ì—ê²Œ 4 í”¼í•´.', score: 32 } },
        chilmyeoncho: { name: 'ì´ìƒí•´ì”¨', tier: 3, atk: 3, hp: 5, pokeId: 1, trigger: 'startOfBattle', desc: 'ì‹œì‘: ë’¤ ì¹œêµ¬ +1/+1.', score: 8, level2: { atk: 6, hp: 10, desc: 'ì‹œì‘: ë’¤ ì¹œêµ¬ +2/+2.', score: 28 } },
        haehongnamul: { name: 'ë¼í”Œë ˆì‹œì•„', tier: 4, atk: 2, hp: 8, pokeId: 45, trigger: 'startOfBattle', desc: 'ì‹œì‘: ëª¨ë“  ì•„êµ° ì²´ë ¥ +1.', score: 11, level2: { atk: 4, hp: 16, desc: 'ì‹œì‘: ëª¨ë“  ì•„êµ° ì²´ë ¥ +2.', score: 39 } },
        sora: { name: 'íˆ¬êµ¬í‘¸ìŠ¤', tier: 4, atk: 6, hp: 3, pokeId: 141, trigger: 'startOfBattle', desc: 'ì‹œì‘: ë’¤ ì¹œêµ¬ ê³µê²©ë ¥ +2.', score: 10, level2: { atk: 12, hp: 6, desc: 'ì‹œì‘: ë’¤ ì¹œêµ¬ ê³µê²©ë ¥ +4.', score: 35 } },
        kkotge: { name: 'í‚¹í¬ë©', tier: 4, atk: 5, hp: 4, pokeId: 99, trigger: 'beforeAttack', desc: 'ê³µê²© ì „: ì• ë‘˜ì—ê²Œ 1 í”¼í•´.', score: 12, level2: { atk: 10, hp: 8, desc: 'ê³µê²© ì „: ì• ë‘˜ì—ê²Œ 2 í”¼í•´.', score: 42 } },
        chilge: { name: 'ë‹¨ë°ê¸°', tier: 4, atk: 4, hp: 7, pokeId: 11, trigger: 'startOfBattle', desc: 'ì‹œì‘: ë°›ëŠ” í”¼í•´ -2.', score: 11, level2: { atk: 8, hp: 14, desc: 'ì‹œì‘: ë°›ëŠ” í”¼í•´ -4.', score: 39 } },
        nakji: { name: 'ëŒ€í¬ë¬´ë…¸', tier: 5, atk: 6, hp: 3, pokeId: 224, trigger: 'startOfBattle', desc: 'ì‹œì‘: í›„ì—´ ì´ë™. ì²« í”¼ê²© -2.', score: 13, level2: { atk: 12, hp: 6, desc: 'ì‹œì‘: í›„ì—´ ì´ë™. ì²« í”¼ê²© -4.', score: 46 } },
        bigSnail: { name: 'ê±°ë¶ì™•', tier: 5, atk: 4, hp: 9, pokeId: 9, trigger: 'startOfBattle', desc: 'ì‹œì‘: ëª¨ë“  ì•„êµ° ë°›ëŠ” í”¼í•´ -1.', score: 14, level2: { atk: 8, hp: 18, desc: 'ì‹œì‘: ëª¨ë“  ì•„êµ° ë°›ëŠ” í”¼í•´ -2.', score: 49 } },
        muneo: { name: 'ë¬¸ë²„ê·¸', tier: 5, atk: 6, hp: 5, pokeId: 223, trigger: 'beforeAttack', desc: 'ê³µê²© ì „: ì• ì  1 í”¼í•´, ë’¤ ì¹œêµ¬ ê³µ+1.', score: 13, level2: { atk: 12, hp: 10, desc: 'ê³µê²© ì „: ì• ì  2 í”¼í•´, ë’¤ ì¹œêµ¬ ê³µ+2.', score: 46 } },
        sungeo: { name: 'ê°¸ë¼ë„ìŠ¤', tier: 5, atk: 7, hp: 6, pokeId: 130, trigger: 'startOfBattle', desc: 'ì‹œì‘: ë¬´ì‘ìœ„ ì•„êµ° ê³µ+2.', score: 13, level2: { atk: 14, hp: 12, desc: 'ì‹œì‘: ë¬´ì‘ìœ„ ì•„êµ° ë‘˜ ê³µ+2.', score: 46 } },
        doyosae: { name: 'í”¼ì¡´íˆ¬', tier: 6, atk: 8, hp: 8, pokeId: 18, trigger: 'startOfBattle', desc: 'ì‹œì‘: ì• ì ì—ê²Œ 2 í”¼í•´.', score: 16, level2: { atk: 16, hp: 16, desc: 'ì‹œì‘: ì• ì ì—ê²Œ 4 í”¼í•´.', score: 56 } },
        galmaegi: { name: 'íŒ¨ë¦¬í¼', tier: 6, atk: 8, hp: 8, pokeId: 279, trigger: 'startOfBattle', desc: 'ì‹œì‘: ëª¨ë“  ì•„êµ° ê³µ+1.', score: 17, level2: { atk: 16, hp: 16, desc: 'ì‹œì‘: ëª¨ë“  ì•„êµ° ê³µ+2.', score: 60 } },
        waegari: { name: 'ë£¨ê¸°ì•„', tier: 6, atk: 9, hp: 9, pokeId: 249, trigger: 'startOfBattle', desc: 'ì‹œì‘: ë’¤ ì¹œêµ¬ +2/+2.', score: 17, level2: { atk: 18, hp: 18, desc: 'ì‹œì‘: ë’¤ ì¹œêµ¬ +4/+4.', score: 60 } },
        daewangjogae: { name: 'ë¼í”„ë¼ìŠ¤', tier: 6, atk: 10, hp: 5, pokeId: 131, trigger: 'beforeAttack', desc: 'ê³µê²© ì „: ê´€í†µ 1 í”¼í•´.', score: 16, level2: { atk: 20, hp: 10, desc: 'ê³µê²© ì „: ê´€í†µ 2 í”¼í•´.', score: 56 } },
        smallWorm: { name: 'ì‘ì€ ë²Œë ˆ', tier: 'T', atk: 1, hp: 1, pokeId: 10, isToken: true, desc: '' },
        level2Worm: { name: 'ë²Œë ˆ', tier: 'T', atk: 2, hp: 2, pokeId: 10, isToken: true, desc: '' },
        smallScallop: { name: 'ì§„ì£¼', tier: 'T', atk: 2, hp: 2, pokeId: 366, isToken: true, desc: '' },
        level2Scallop: { name: 'í° ì§„ì£¼', tier: 'T', atk: 4, hp: 4, pokeId: 366, isToken: true, desc: '' },
    };

    const FOOD_DATA = {
        plankton: { name: 'ì´ìƒí•œì‚¬íƒ•', cost: 3, desc: 'ìœ ë‹›ì—ê²Œ ì˜êµ¬ +1/+1 ë¶€ì—¬.', effect: (unit) => { unit.atk += 1; unit.hp += 1; } },
        pincer: { name: 'ê³µê²©ê°•í™”', cost: 3, desc: 'ìœ ë‹›ì—ê²Œ ì˜êµ¬ ê³µê²©ë ¥ +2 ë¶€ì—¬.', effect: (unit) => { unit.atk += 2; } },
        shell: { name: 'ë°©ì–´ê°•í™”', cost: 3, desc: 'ìœ ë‹›ì—ê²Œ ì˜êµ¬ ì²´ë ¥ +2 ë¶€ì—¬.', effect: (unit) => { unit.hp += 2; } },
    };

    let gameState = {};
    let quizTimerHandle = null;

    function createUnitInstance(id, level = 1) {
        const data = UNIT_DATA[id];
        let unit = {
            id, name: data.name, tier: data.tier, pokeId: data.pokeId,
            instanceId: crypto.randomUUID(), atk: data.atk, hp: data.hp,
            level, trigger: data.trigger, desc: data.desc, score: data.score,
            battleAtk: 0, battleHp: 0,
            effects: { evade: 0, damageReduction: 0, firstHitTaken: false }
        };
        if (level === 2) Object.assign(unit, data.level2);
        return unit;
    }

    const $ = (selector) => document.querySelector(selector);

    function renderUnit(unit, index, teamType) {
        const isEmpty = !unit;
        const tierColor = unit ? TIER_COLORS[unit.tier] : '';
        const baseClasses = `unit-card w-32 h-36 rounded-lg p-2 flex flex-col justify-between items-center relative flex-shrink-0 bg-white shadow-sm border`;
        if (isEmpty) return `<div class="${baseClasses} border-2 border-dashed border-gray-300 bg-transparent shadow-none" data-team="${teamType}" data-index="${index}"></div>`;

        const selectedClass = gameState.selectedItem?.instanceId === unit.instanceId ? 'selected' : '';
        const costText = teamType === 'shop' ? `<div class="absolute -top-2 -left-2 bg-yellow-500 text-white rounded-full w-6 h-6 text-xs flex items-center justify-center z-10 font-bold shadow-md">3</div>` : '';
        const sellButton = (teamType === 'player' || teamType === 'bench') && gameState.phase === 'shop' ? `<button class="sell-button absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 text-[10px] z-10 shadow-md" data-team="${teamType}" data-index="${index}">X</button>` : '';
        const imageURL = unit.pokeId ? `${POKE_SPRITE_BASE}/${unit.pokeId}.png` : `https://unluckyidiot16.github.io/assets-common/MudAnimalAutoBattle/${unit.id}.png`;
        const stars = 'â˜…'.repeat(unit.level);

        return `
        <div id="unit-${unit.instanceId}" class="${baseClasses} ${tierColor} ${selectedClass}" data-team="${teamType}" data-index="${index}" data-id="${unit.id}" data-instance-id="${unit.instanceId}">
            ${sellButton}${costText}
            <div class="text-[10px] font-bold text-center">${unit.name} <span class="text-yellow-500">${stars}</span></div>
            <img src="${imageURL}" alt="${unit.name}" class="w-16 h-16 object-contain">
            <div class="text-center font-bold">
                <span class="text-red-500">${unit.atk + unit.battleAtk}</span> / <span class="text-blue-500">${unit.hp + unit.battleHp}</span>
            </div>
            <div class="damage-text-container absolute inset-0"></div>
        </div>
    `;
    }

    function renderFood(food, index) {
        if (!food) return `<div class="w-24 h-24 border-2 border-dashed border-gray-300 rounded-lg"></div>`;
        const selectedClass = gameState.selectedItem?.type === 'food' && gameState.selectedItem.index === index ? 'selected' : '';
        return `
        <div class="unit-card w-24 h-24 bg-green-100 border border-green-300 rounded-lg p-2 flex flex-col justify-center items-center text-center ${selectedClass}" data-type="food" data-index="${index}">
            <div class="text-xs font-bold">${food.name}</div>
            <div class="text-[10px] mt-1 text-gray-600">${food.desc}</div>
            <div class="font-bold mt-1 text-green-700 text-xs">${food.cost} QP</div>
        </div>
     `;
    }

    function renderAll() {
        $('#turn-counter').textContent = gameState.turn;
        $('#life-counter').innerHTML = 'â¤ï¸'.repeat(gameState.lives) + 'ğŸ¤'.repeat(4 - gameState.lives);
        $('#qp-counter').textContent = gameState.qp;
        const currentEnvData = ENVIRONMENTS[gameState.currentEnvironment];
        $('#environment-indicator').textContent = currentEnvData.name;
        $('#player-team').style.backgroundColor = currentEnvData.color;

        $('#quiz-area').classList.toggle('hidden', gameState.phase !== 'quiz');
        $('#shop-area').classList.toggle('hidden', gameState.phase !== 'shop');
        $('#enemy-team-area').classList.toggle('hidden', gameState.phase === 'shop' || gameState.phase === 'quiz');
        $('#battle-log-container').classList.toggle('hidden', gameState.phase === 'shop' || gameState.phase === 'quiz');

        let selectionText = '';
        if (gameState.selectedItem) {
            const { data } = gameState.selectedItem;
            selectionText = `[${data.name}] ${data.desc}`;
        }
        $('#selection-info').textContent = selectionText;

        $('#player-team').innerHTML = gameState.playerTeam.map((u, i) => renderUnit(u, i, 'player')).join('');
        $('#player-bench').innerHTML = gameState.benchTeam.map((u, i) => renderUnit(u, i, 'bench')).join('');

        if (gameState.phase === 'battle') {
            $('#enemy-team').style.backgroundColor = currentEnvData.color;
            $('#enemy-team').innerHTML = gameState.enemyTeam.map((u, i) => renderUnit(u, i, 'enemy')).join('');
        } else {
            $('#enemy-team').style.backgroundColor = 'transparent';
            $('#enemy-team').innerHTML = '<div class="h-36"></div>';
        }

        if (gameState.phase === 'shop') {
            $('#shop-units').innerHTML = gameState.shop.units.map((u, i) => renderUnit(u, i, 'shop')).join('');
            $('#shop-foods').innerHTML = gameState.shop.foods.map((f, i) => renderFood(f, i)).join('');
        }

        const trophyBar = $('#win-trophy-bar');
        trophyBar.innerHTML = '';
        for (let i = 0; i < 10; i++) {
            const color = (i < gameState.wins) ? 'text-yellow-500' : 'text-gray-300';
            trophyBar.innerHTML += `<svg class="h-8 w-8 ${color}" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M13 3.25A2.25 2.25 0 0 0 10.75 1H6.25A2.25 2.25 0 0 0 4 3.25V5.5h9.25v10.25h-3.5a.75.75 0 0 1 0-1.5h2v-1.5h-2a.75.75 0 0 1 0-1.5h2v-1.5h-2a.75.75 0 0 1 0-1.5h2V8h-2a.75.75 0 0 1 0-1.5h2.75A2.25 2.25 0 0 0 13 4.25V3.25Z"/></svg>`;
        }
        addClickListeners();
    }

    // --- í€´ì¦ˆ ë¡œì§ ---
    function startQuizPhase() {
        const pool = [...QUIZ_PACK].sort(() => Math.random() - 0.5);
        gameState.quiz = {
            questions: pool.slice(0, QUIZ_CONFIG.questionsPerTurn),
            idx: 0, correct: 0,
            endsAt: Date.now() + QUIZ_CONFIG.timeLimitSec * 1000,
        };

        $('#quiz-baseqp').textContent = QUIZ_CONFIG.baseQP;
        $('#quiz-bonuscap').textContent = QUIZ_CONFIG.bonusCap;

        if (quizTimerHandle) clearInterval(quizTimerHandle);
        quizTimerHandle = setInterval(() => {
            if (gameState.phase !== 'quiz') return;
            const leftSec = Math.ceil(Math.max(0, gameState.quiz.endsAt - Date.now()) / 1000);
            $('#quiz-timer').textContent = leftSec;
            if (leftSec <= 0) finishQuiz();
        }, 200);

        renderQuiz();
    }

    function renderQuiz() {
        const q = gameState.quiz.questions[gameState.quiz.idx];
        $('#quiz-progress').textContent = `${gameState.quiz.idx + 1} / ${gameState.quiz.questions.length}`;
        $('#quiz-correct').textContent = gameState.quiz.correct;
        $('#quiz-prompt').textContent = q.prompt;
        for (let i = 0; i < 4; i++) {
            $(`#quiz-opt-${i}`).textContent = q.options[i];
        }
        renderAll();
    }

    function answerQuiz(optionIdx) {
        if (gameState.phase !== 'quiz') return;
        const q = gameState.quiz.questions[gameState.quiz.idx];
        if (optionIdx === q.answerIndex) gameState.quiz.correct++;
        gameState.quiz.idx++;
        if (gameState.quiz.idx >= gameState.quiz.questions.length) finishQuiz();
        else renderQuiz();
    }

    function finishQuiz() {
        if (quizTimerHandle) { clearInterval(quizTimerHandle); quizTimerHandle = null; }
        const bonus = Math.min(gameState.quiz.correct, QUIZ_CONFIG.bonusCap);
        gameState.qp = QUIZ_CONFIG.baseQP + bonus;
        gameState.quiz = null;
        gameState.phase = 'shop';
        populateShop();
        renderAll();
    }

    // --- ìƒì  ë° ê²Œì„ íë¦„ ---
    function getAvailableUnits(tier) { return Object.keys(UNIT_DATA).filter(id => !UNIT_DATA[id].isToken && UNIT_DATA[id].tier <= tier); }

    function populateShop() {
        const maxTier = Math.min(6, Math.floor((gameState.turn - 1) / 2) + 1);
        const availableUnits = getAvailableUnits(maxTier);
        gameState.shop.units = Array(3).fill(null).map(() => createUnitInstance(availableUnits[Math.floor(Math.random() * availableUnits.length)]));
        const availableFoods = Object.keys(FOOD_DATA);
        gameState.shop.foods = Array(2).fill(null).map(() => {
            const id = availableFoods[Math.floor(Math.random() * availableFoods.length)];
            return {id, ...FOOD_DATA[id]};
        });
    }

    function rollShop() { if (gameState.qp < 1) return; gameState.qp -= 1; populateShop(); renderAll(); }

    function startTurn() {
        gameState.turn++;
        gameState.qp = 0;
        gameState.phase = 'quiz';
        clearSelection();
        const environments = Object.keys(ENVIRONMENTS);
        gameState.currentEnvironment = environments[Math.floor(Math.random() * environments.length)];
        startQuizPhase();
    }

    function initGame() {
        gameState = {
            turn: 0, wins: 0, lives: 4, qp: 0, phase: 'quiz',
            playerTeam: Array(5).fill(null), benchTeam: Array(5).fill(null), enemyTeam: [],
            shop: { units: [], foods: [] }, currentEnvironment: 'LOW_TIDE', selectedItem: null,
        };
        startTurn();
    }

    // --- ì „íˆ¬ ë¡œì§ (ê¸°ì¡´ ë³´ì¡´) ---
    async function startBattle() {
        gameState.phase = 'battle';
        generateEnemyTeam();
        let pTeam = gameState.playerTeam.filter(u => u).map(u => JSON.parse(JSON.stringify(u)));
        let eTeam = gameState.enemyTeam.filter(u => u).map(u => JSON.parse(JSON.stringify(u)));
        pTeam.forEach(u => u.instanceId = crypto.randomUUID());
        renderAll();
        await delay(500);
        const log = (msg) => {
            const p = document.createElement('p'); p.textContent = msg;
            $('#battle-log').appendChild(p); $('#battle-log').scrollTop = $('#battle-log').scrollHeight;
        };
        $('#battle-log').innerHTML = '<p class="font-bold text-blue-600">ì „íˆ¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!</p>';

        await resolveTriggers('startOfBattle', pTeam, pTeam, eTeam, log);
        await resolveTriggers('startOfBattle', eTeam, eTeam, pTeam, log);
        renderBattleState(pTeam, eTeam);

        while (pTeam.length > 0 && eTeam.length > 0) {
            await delay(600);
            const pU = pTeam[0]; const eU = eTeam[0];
            await resolveTriggers('beforeAttack', [pU], pTeam, eTeam, log);
            await resolveTriggers('beforeAttack', [eU], eTeam, pTeam, log);
            renderBattleState(pTeam, eTeam);

            pTeam = pTeam.filter(u => u.hp + u.battleHp > 0);
            eTeam = eTeam.filter(u => u.hp + u.battleHp > 0);
            if (pTeam.length === 0 || eTeam.length === 0) break;

            $(`#unit-${pU.instanceId}`)?.classList.add('attack-animation');
            $(`#unit-${eU.instanceId}`)?.classList.add('enemy-attack-animation');

            await applyDamage(eU, pU.atk + pU.battleAtk, eTeam, pTeam, log, pU);
            if (eTeam.some(u => u.hp + u.battleHp > 0)) await applyDamage(pU, eU.atk + eU.battleAtk, pTeam, eTeam, log, eU);

            await delay(400);
            pTeam = pTeam.filter(u => u.hp + u.battleHp > 0);
            eTeam = eTeam.filter(u => u.hp + u.battleHp > 0);
            renderBattleState(pTeam, eTeam);
        }

        await delay(1000);
        if (pTeam.length > 0) { log("ìŠ¹ë¦¬!"); gameState.wins++; }
        else if (eTeam.length > 0) { log("íŒ¨ë°°..."); gameState.lives--; }
        else log("ë¬´ìŠ¹ë¶€");

        if (gameState.wins >= 10) showModal('ìµœì¢… ìŠ¹ë¦¬!', 'í¬ì¼“ í€´ì¦ˆ ë§ˆìŠ¤í„°ê°€ ë˜ì…¨ìŠµë‹ˆë‹¤!');
        else if (gameState.lives <= 0) showModal('ê²Œì„ ì˜¤ë²„', `${gameState.wins}ìŠ¹ì„ ê¸°ë¡í–ˆìŠµë‹ˆë‹¤.`);
        else startTurn();
    }

    function renderBattleState(p, e) {
        $('#player-team').innerHTML = p.map((u, i) => renderUnit(u, i, 'player')).join('') + Array(5-p.length).fill(renderUnit(null)).join('');
        $('#enemy-team').innerHTML = e.map((u, i) => renderUnit(u, i, 'enemy')).join('') + Array(5-e.length).fill(renderUnit(null)).join('');
    }

    async function applyDamage(target, damage, targetTeam, attackerTeam, log, attacker) {
        if (!target || target.hp + target.battleHp <= 0) return;
        let finalDmg = damage;
        if (target.effects.evade > 0) { target.effects.evade--; log(`${target.name}ì˜ íšŒí”¼!`); return; }
        finalDmg = Math.max(0, finalDmg - target.effects.damageReduction);

        const damageNumber = document.createElement('div');
        damageNumber.className = 'damage-text'; damageNumber.textContent = `-${finalDmg}`;
        $(`#unit-${target.instanceId} .damage-text-container`)?.appendChild(damageNumber);

        target.hp -= finalDmg;
        if (target.hp + target.battleHp > 0) await resolveTriggers('hurt', [target], targetTeam, attackerTeam, log);
        else { $(`#unit-${target.instanceId}`)?.classList.add('faint-animation'); await resolveTriggers('faint', [target], targetTeam, attackerTeam, log); }
    }

    function calculateTeamScore(team) { return team.reduce((t, u) => t + (u ? (u.level === 2 ? (u.level2?.score || u.score * 2) : u.score) : 0), 0); }
    function generateEnemyTeam() {
        const targetScore = Math.max(5, calculateTeamScore(gameState.playerTeam) * (0.8 + Math.random() * 0.4));
        const maxTier = Math.min(6, Math.floor((gameState.turn - 1) / 2) + 1);
        const available = getAvailableUnits(maxTier);
        let eTeam = [], currentScore = 0;
        while(currentScore < targetScore && eTeam.length < 5) {
            const id = available[Math.floor(Math.random() * available.length)];
            const unit = createUnitInstance(id, (gameState.turn > 4 && Math.random() < 0.2) ? 2 : 1);
            eTeam.push(unit); currentScore += unit.score;
        }
        gameState.enemyTeam = eTeam;
    }

    async function resolveTriggers(trigger, actors, actorTeam, enemyTeam, log) {
        for (const actor of actors) {
            if (!actor || (actor.hp + actor.battleHp <= 0 && trigger !== 'faint')) continue;
            if (actor.trigger === trigger) {
                const effect = UNIT_EFFECTS[actor.id];
                if (effect) await effect(actor, actorTeam, enemyTeam, log);
            }
        }
    }

    const UNIT_EFFECTS = {
        bajirak: (self, _1, _2, log) => { self.battleAtk += (self.level === 2 ? 2 : 1); log(`${self.name} ê°•í™”!`); },
        mudworm: (self, team, _, log) => {
            const idx = team.findIndex(u => u.instanceId === self.instanceId);
            if (idx !== -1) team.splice(idx + 1, 0, createUnitInstance(self.level === 2 ? 'level2Worm' : 'smallWorm'));
        },
        smallCrab: (self, team, _, log) => {
            const i = team.findIndex(u => u.instanceId === self.instanceId);
            if (i > -1 && team[i+1]) team[i+1].battleAtk += (self.level === 2 ? 2 : 1);
        },
        daehap: (self, team, _, log) => {
            const i = team.findIndex(u => u.instanceId === self.instanceId);
            const b = self.level === 2 ? 2 : 1;
            if (i > -1 && team[i+1]) { team[i+1].battleAtk += b; team[i+1].battleHp += b; }
        },
        ppulsora: (self, team, _, log) => { if (team[0]?.instanceId === self.instanceId) self.effects.evade = (self.level === 2 ? 2 : 1); },
        mangdungeo: (self, team, _, log) => {
            const allies = team.filter(u => u.instanceId !== self.instanceId);
            if (allies.length) allies[Math.floor(Math.random()*allies.length)].battleAtk += 1;
        },
        // ... ë‚˜ë¨¸ì§€ íš¨ê³¼ë“¤ì€ ê¸°ì¡´ MudAnimal ë¡œì§ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµí•˜ê±°ë‚˜ ê¸°ì¡´ ì½”ë“œë¥¼ ì°¸ì¡°í•˜ì—¬ ì´ì‹ ...
        // ì§€ë©´ìƒ í•µì‹¬ íŠ¸ë¦¬ê±° êµ¬ì¡°ë§Œ ìœ ì§€í–ˆìŠµë‹ˆë‹¤.
    };

    function checkForCombine(unitId) {
        const all = [...gameState.playerTeam, ...gameState.benchTeam];
        const matchIndices = all.map((u, i) => (u && u.id === unitId && u.level === 1) ? i : -1).filter(i => i !== -1);
        if (matchIndices.length >= 3) {
            const targetIdx = matchIndices[0];
            const targetTeam = targetIdx < 5 ? 'playerTeam' : 'benchTeam';
            const unit = gameState[targetTeam][targetIdx % 5];
            unit.level = 2;
            Object.assign(unit, UNIT_DATA[unitId].level2);
            matchIndices.slice(1, 3).forEach(i => {
                const t = i < 5 ? 'playerTeam' : 'benchTeam';
                gameState[t][i % 5] = null;
            });
        }
    }

    function addClickListeners() {
        document.querySelectorAll('.unit-card').forEach(c => c.onclick = () => handleCardClick(c.dataset));
        document.querySelectorAll('.sell-button').forEach(b => b.onclick = (e) => { e.stopPropagation(); sellUnit(b.dataset.team, b.dataset.index); });
        document.querySelectorAll('.quiz-option').forEach(b => b.onclick = () => answerQuiz(parseInt(b.dataset.idx)));
    }

    function handleCardClick(ds) {
        const { team, type, index } = ds;
        const idx = parseInt(index);
        const selected = gameState.selectedItem;

        if (!selected) {
            if (team === 'shop' || type === 'food') {
                const data = type === 'food' ? gameState.shop.foods[idx] : gameState.shop.units[idx];
                if (data) gameState.selectedItem = { type: type || 'unit', index: idx, data };
            } else {
                const tKey = team === 'player' ? 'playerTeam' : 'benchTeam';
                const u = gameState[tKey][idx];
                if (u) gameState.selectedItem = { type: 'playerUnit', team, index: idx, instanceId: u.instanceId, data: u };
            }
        } else {
            if (selected.type === 'unit' && gameState.qp >= 3) {
                const tKey = team === 'player' ? 'playerTeam' : 'benchTeam';
                if (!gameState[tKey][idx]) {
                    gameState.qp -= 3;
                    gameState[tKey][idx] = createUnitInstance(selected.data.id);
                    gameState.shop.units[selected.index] = null;
                    checkForCombine(selected.data.id);
                    clearSelection();
                }
            } else if (selected.type === 'food' && gameState.qp >= selected.data.cost) {
                const tKey = team === 'player' ? 'playerTeam' : 'benchTeam';
                if (gameState[tKey][idx]) {
                    gameState.qp -= selected.data.cost;
                    selected.data.effect(gameState[tKey][idx]);
                    gameState.shop.foods[selected.index] = null;
                    clearSelection();
                }
            } else if (selected.type === 'playerUnit') {
                const sKey = selected.team === 'player' ? 'playerTeam' : 'benchTeam';
                const tKey = team === 'player' ? 'playerTeam' : 'benchTeam';
                const temp = gameState[tKey][idx];
                gameState[tKey][idx] = gameState[sKey][selected.index];
                gameState[sKey][selected.index] = temp;
                clearSelection();
            }
        }
        renderAll();
    }

    function clearSelection() { gameState.selectedItem = null; renderAll(); }
    function sellUnit(team, idx) {
        const tKey = team === 'player' ? 'playerTeam' : 'benchTeam';
        const u = gameState[tKey][idx];
        if (u) { gameState.qp += u.level; gameState[tKey][idx] = null; clearSelection(); }
    }
    function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
    function showModal(title, text) { $('#modal-title').textContent = title; $('#modal-text').textContent = text; $('#modal').classList.remove('hidden'); }

    $('#roll-button').onclick = rollShop;
    $('#end-turn-button').onclick = startBattle;
    $('#restart-button').onclick = () => { $('#modal').classList.add('hidden'); initGame(); };
    document.body.onclick = (e) => { if (!e.target.closest('.unit-card, button')) clearSelection(); };

    initGame();
</script>
</body>
</html>