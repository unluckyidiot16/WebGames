<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- 보안 보강 -->
    <meta name="referrer" content="no-referrer" />
    <meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' 'unsafe-inline';
  style-src  'self' 'unsafe-inline';
  img-src    'self' https://unluckyidiot16.github.io https://api.qrserver.com data:;
  font-src   'self';
  connect-src 'self' https://nfkjolrlegftyvxyrpfr.supabase.co;
  frame-src  'self';
  object-src 'none';
  base-uri   'self';
  form-action 'none';
  upgrade-insecure-requests;
">
    <title>WebGames | unluckyidiot16</title>
    <meta name="description" content="안재형의 웹게임 모음. 수업/프로토타입/미니게임을 한 곳에서 플레이!" />
    <meta property="og:title" content="WebGames | unluckyidiot16" />
    <meta property="og:description" content="안재형의 웹게임 모음. 수업/프로토타입/미니게임을 한 곳에서 플레이!" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://unluckyidiot16.github.io/WebGames/" />
    <meta name="color-scheme" content="light dark" />
    <style>
        :root{
            --bg:#0b0f14; --fg:#e8eef4; --muted:#9db1c1; --card:#121821; --accent:#61d3ff; --accent-2:#a4ff9b;
            --border: color-mix(in oklab, var(--fg) 10%, transparent);
            --shadow: 0 4px 14px rgba(0,0,0,.25);
        }
        *{ box-sizing: border-box }
        html,body{ height:100% }
        body{
            margin:0; background:linear-gradient(180deg, #0b0f14, #0e1620);
            color:var(--fg); font:14px/1.6 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif;
        }
        a{ color:inherit; text-decoration:none }
        .wrap{ max-width:1080px; margin:0 auto; padding:18px 16px 32px; }
        header{ display:flex; gap:10px; align-items:center; margin-bottom:16px; }
        .title{ font-size:20px; font-weight:800; letter-spacing:.2px; }
        .muted{ color:var(--muted) }

        .toolbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0 16px; }
        .search{ flex:1; display:flex; gap:8px; align-items:center; padding:8px 12px; background:var(--card); border:1px solid var(--border); border-radius:12px; }
        .search svg{ width:18px; height:18px; fill:var(--muted) }
        .search input{ flex:1; border:0; outline:0; background:transparent; color:var(--fg); font-size:15px; }
        .select{ padding:10px 12px; background:var(--card); border:1px solid var(--border); border-radius:12px; color:var(--fg); }

        .filters{ display:flex; gap:8px; flex-wrap:wrap; margin:8px 0 18px; }
        .chip{ padding:6px 10px; border:1px solid var(--border); border-radius:999px; background:transparent; cursor:pointer; font-size:13px; color:var(--muted); }
        .chip.active{ background:linear-gradient(135deg, color-mix(in oklab, var(--accent) 18%, transparent), color-mix(in oklab, var(--accent-2) 12%, transparent)); color:var(--fg); border-color: color-mix(in oklab, var(--accent) 40%, var(--border)); }

        .grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:14px; }
        .card{ background:var(--card); border:1px solid var(--border); border-radius:14px; box-shadow:var(--shadow); overflow:hidden; display:flex; flex-direction:column; min-height:280px; }
        .thumb{ aspect-ratio: 16 / 9; width:100%; background:linear-gradient(180deg, #111923, #0d141d); display:grid; place-items:center; color:#9fb2c8; font-weight:600; letter-spacing:0.3px; }
        .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
        .card-body{ padding:14px; display:flex; flex-direction:column; gap:8px; }
        .title{ font-size:16px; font-weight:700; margin:0; }
        .desc{ color:var(--muted); font-size:13.5px; margin:0; }
        .meta{ display:flex; justify-content:space-between; align-items:center; font-size:12px; color:var(--muted); }
        .tags{ display:flex; gap:6px; flex-wrap:wrap; }
        .tag{ font-size:11px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); }
        .actions{ display:flex; gap:8px; margin-top:8px; }
        .play{ flex:1; text-align:center; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:linear-gradient(135deg, color-mix(in oklab, var(--accent) 18%, transparent), color-mix(in oklab, var(--accent-2) 12%, transparent)); font-weight:700; }
        /* QR 버튼 스타일 추가 */
        .actions .qr{ padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:transparent; color:var(--fg); cursor:pointer; }
        .actions .qr:hover{ border-color: color-mix(in oklab, var(--accent) 40%, var(--border)); }

        .empty{ text-align:center; color:var(--muted); padding:60px 10px; }
        footer{ margin-top:24px; color:var(--muted); font-size:12px; display:flex; justify-content:space-between; gap:8px; flex-wrap:wrap; }

        /* --- Popup help toast --- */
        .toast {
            position: fixed; left: 16px; right: 16px; bottom: 16px;
            background: var(--card); color: var(--fg);
            border: 1px solid var(--border); border-radius: 12px;
            padding: 12px 14px; box-shadow: var(--shadow);
            display: flex; gap: 10px; align-items: center; z-index: 9999;
        }
        .toast .msg { flex: 1; }
        .toast .x {
            background: none; border: 0; color: var(--muted);
            font-size: 18px; cursor: pointer; padding: 4px 8px;
        }
        .toast .btn {
            padding: 8px 10px; border: 1px solid var(--border);
            border-radius: 10px; background: transparent; color: var(--fg); cursor: pointer;
        }
        .toast .btn.primary {
            background: linear-gradient(135deg,
            color-mix(in oklab, var(--accent) 18%, transparent),
            color-mix(in oklab, var(--accent-2) 12%, transparent));
            font-weight: 700;
        }

        /* --- Inline QR overlay (fallback) --- */
        .qr-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,.55);
            display: grid; place-items: center; z-index: 10000;
        }
        .qr-panel {
            background: var(--card); border: 1px solid var(--border);
            border-radius: 14px; padding: 16px;
        }
        .qr-panel img { width: 512px; height: 512px; display: block; }
        .qr-panel .close {
            margin-top: 10px; width: 100%; padding: 10px 12px;
            border: 1px solid var(--border); border-radius: 10px;
            background: transparent; color: var(--fg); cursor: pointer;
        }
    </style>
</head>
<body>
<div class="wrap">
    <header>
        <div class="title">WebGames</div>
        <div class="muted">총 <span id="count">0</span>개</div>
    </header>

    <div class="toolbar">
        <label class="search" style="min-width:240px">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path></svg>
            <input id="q" type="search" placeholder="게임 제목/태그 검색…" />
        </label>

        <select id="sort" class="select" aria-label="정렬">
            <option value="updated-desc">최신 업데이트</option>
            <option value="title-asc">제목 가나다</option>
            <option value="title-desc">제목 역순</option>
        </select>
    </div>

    <div id="filters" class="filters"></div>
    <div id="grid" class="grid" aria-busy="true"></div>
    <div id="empty" class="empty" hidden>검색 결과가 없어요.</div>

    <footer>
        <div>© unluckyidiot16</div>
        <div><a href="https://github.com/unluckyidiot16/WebGames" target="_blank" rel="noopener noreferrer">GitHub</a></div>
    </footer>
</div>

<script>
    // --- Security: URL whitelist & helpers ---
    const ALLOWED_HOSTS = ['unluckyidiot16.github.io'];
    const ALLOWED_PATH_PREFIXES = ['/WebGames/', '/assets-common/'];

    const SUPA_URL = "https://nfkjolrlegftyvxyrpfr.supabase.co";
    const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ma2pvbHJsZWdmdHl2eHlycGZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTI3NzgsImV4cCI6MjA3NTg4ODc3OH0.p2IhcLKDqNdbDWu6w6R_dvsxubvWf6xtNOqlSkWTSpY";

    function qp(k){ return new URLSearchParams(location.search).get(k); }

    async function load(){
        const t = qp('t');         // 토큰으로 열렸는지?
        const code = qp('code');   // 코드로 열렸는지?

        // 1) 개인 인덱스 우선: REST RPC 호출
        if (t || code){
            try{
                const rpc = t ? 'rpc_student_index_games_by_token' : 'rpc_student_index_games_by_code';
                const body = t ? { _token: t } : { _code: code };
                const res = await fetch(`${SUPA_URL}/rest/v1/rpc/${rpc}`, {
                    method: 'POST',
                    headers: {
                        'apikey': ANON_KEY,
                        'Authorization': `Bearer ${ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                if (res.ok){
                    const arr = await res.json();            // JSON 배열 기대
                    if (Array.isArray(arr) && arr.length){
                        all = arr.map(g => ({
                            title: g.title||'', url: g.url||'#', thumb: g.thumb||'',
                            tags: Array.isArray(g.tags)?g.tags:[], updated: g.updated||'', desc: g.desc||''
                        }));
                        buildFilterChips();
                        render();
                        return; // 개인 인덱스 렌더 완료
                    }
                }
            }catch(e){ console.warn('개인 인덱스 로드 실패, 기본 목록으로 폴백', e); }
        }

        // 2) 폴백: 기존 games.json
        let data = DEFAULT_GAMES;
        try{
            const res = await fetch('games.json', {cache:'no-cache'});
            if (res.ok) data = await res.json();
        }catch(e){ console.warn('games.json 불러오기 실패, 기본 목록 사용', e); }
        all = data.map(g => ({
            title: g.title||'', url: g.url||'#', thumb: g.thumb||'',
            tags: Array.isArray(g.tags)?g.tags:[], updated: g.updated||'', desc: g.desc||''
        }));
        buildFilterChips();
        render();
    }

    function validateGameUrl(raw){
        try{
            const u = new URL(raw, location.origin);
            if (u.protocol !== 'https:') return null;
            if (!ALLOWED_HOSTS.includes(u.hostname)) return null;
            if (!ALLOWED_PATH_PREFIXES.some(p => u.pathname.startsWith(p))) return null;
            if (/[<>\\"'(){}]/.test(u.search + u.hash)) return null;
            return u.href;
        }catch{ return null; }
    }
    function safeHref(raw){ return validateGameUrl(raw) ?? '#'; }

    // --- QR code popup (512x512) with fallback ---
    function openQrWindow(url){
        const href = safeHref(url);
        if (href === '#'){ showPopupHelp(''); return; }
        const w = window.open('', '_blank', 'noopener,noreferrer,width=560,height=640');
        if (!w){ showPopupHelp(href); return; }
        const esc = (s)=>String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
        w.document.write(`<!doctype html><html lang="ko"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>게임 QR 코드</title>
<style>
  :root{--bg:#0b0f14; --fg:#e8eef4; --muted:#9db1c1; --card:#121821; --border: #2a3240;}
  html,body{height:100%;}
  body{margin:0;background:var(--bg);color:var(--fg);display:flex;align-items:center;justify-content:center;font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;}
  .wrap{display:flex;flex-direction:column;align-items:center;gap:12px;padding:16px;}
  .info{color:var(--muted);max-width:90%;text-align:center;word-break:break-all;}
  .box{padding:8px;border:1px solid var(--border);border-radius:12px;background:var(--card);}
  #qrcode>img, #qrcode>canvas{width:512px;height:512px;display:block;}
</style>
</head><body>
  <div class="wrap">
    <div class="box"><div id="qrcode" aria-label="QR for ${esc(href)}"></div></div>
    <div class="info">${esc(href)}</div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"><\/script>
  <script>
    new QRCode(document.getElementById('qrcode'), {text: "${href.replace(/"/g,'%22')}", width:512, height:512, correctLevel: QRCode.CorrectLevel.M});
  <\/script>
</body></html>`);
        w.document.close();
        w.focus();
    }

    function attachActionHandlers(){
        document.querySelectorAll('.card .actions .qr').forEach(btn=>{
            btn.addEventListener('click', (e)=>{
                e.preventDefault();
                const url = btn.dataset.url || '';
                openQrWindow(url);
            });
        });
    }

    const $q = document.getElementById('q');
    const $sort = document.getElementById('sort');
    const $grid = document.getElementById('grid');
    const $filters = document.getElementById('filters');
    const $empty = document.getElementById('empty');
    const $count = document.getElementById('count');

    let all = [];
    let current = [];
    let activeTag = null;

    const DEFAULT_GAMES = []; // games.json 없을 때 폴백

    function placeholderSVG(t="Game"){
        const svg = `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 640 360'>
  <defs>
    <linearGradient id='g' x1='0' x2='0' y1='0' y2='1'>
      <stop offset='0%' stop-color='#253041'/>
      <stop offset='100%' stop-color='#151c24'/>
    </linearGradient>
  </defs>
  <rect width='640' height='360' fill='url(#g)'/>
  <g fill='#6d84a0'>
    <rect x='80' y='120' width='200' height='120' rx='16'/>
    <rect x='360' y='120' width='200' height='120' rx='16'/>
  </g>
  <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#9fb2c8' font-family='system-ui, Noto Sans KR' font-size='42' font-weight='700'>${t}</text>
</svg>`;
        return `data:image/svg+xml;utf8,${svg}`;
    }

    function cardTemplate(g){
        const tags = (g.tags||[]).map(t => `<span class='tag'>#${escapeHtml(t)}</span>`).join('');
        const updated = g.updated ? new Date(g.updated).toLocaleDateString('ko-KR') : '';
        const img = g.thumb || placeholderSVG(g.title || 'Game');
        return `
        <article class="card">
          <div class="thumb"><img alt="${escapeHtml(g.title||'게임 썸네일')}" loading="lazy" referrerpolicy="no-referrer" /></div>
          <div class="card-body">
            <h3 class="title">${escapeHtml(g.title||'제목 미정')}</h3>
            <p class="desc">${escapeHtml(g.desc||'설명이 아직 없습니다.')}</p>
            <div class="meta">
              <div class="tags">${tags}</div>
              <div>${updated?`업데이트 ${updated}`:''}</div>
            </div>
            <div class="actions">
              <a class="play" href="${safeHref(g.url||'#')}" target="_blank" rel="noopener noreferrer">▶ 플레이</a>
              <button class="qr" type="button" data-url="${escapeAttr(g.url||'')}">QR 코드</button>
            </div>
          </div>
        </article>`;
    }

    function escapeHtml(s){
        return String(s).replace(/[&<>\\"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','\\"':'&quot;',"'":"&#39;"}[c] || c));
    }
    function escapeAttr(s){
        return String(s).replace(/\\"/g,'&quot;');
    }

    function applyImages(){
        document.querySelectorAll('.card .thumb img').forEach((imgEl, i) => {
            const g = current[i];
            const src = (g && g.thumb) ? g.thumb : placeholderSVG(g?.title||'Game');
            imgEl.src = src;
            imgEl.onerror = () => { imgEl.src = placeholderSVG(g?.title||'Game'); };
        });
    }

    function render(){
        const q = ($q.value||'').trim().toLowerCase();
        const sort = $sort.value;
        let items = all.filter(g=>{
            const inTag = activeTag ? (g.tags||[]).includes(activeTag) : true;
            const inText = q ? (
                (g.title||'').toLowerCase().includes(q) ||
                (g.desc||'').toLowerCase().includes(q) ||
                (g.tags||[]).some(t => (t||'').toLowerCase().includes(q))
            ) : true;
            return inTag && inText;
        });

        items.sort((a,b)=>{
            if (sort==='updated-desc'){
                return new Date(b.updated||'1970-01-01') - new Date(a.updated||'1970-01-01');
            }
            if (sort==='title-asc'){
                return String(a.title||'').localeCompare(String(b.title||''), 'ko');
            }
            if (sort==='title-desc'){
                return String(b.title||'').localeCompare(String(a.title||''), 'ko');
            }
            return 0;
        });

        current = items;
        $count.textContent = String(items.length);
        $grid.innerHTML = items.map(cardTemplate).join('');
        $grid.setAttribute('aria-busy','false');
        $empty.hidden = items.length > 0;
        applyImages();
        attachActionHandlers();
    }

    function buildFilterChips(){
        const tagSet = new Set();
        all.forEach(g => (g.tags||[]).forEach(t => t && tagSet.add(t)));
        const tags = Array.from(tagSet).sort((a,b)=> a.localeCompare(b,'ko'));
        $filters.innerHTML = ['전체', ...tags].map(tag=>{
            const isAll = tag==='전체';
            const active = isAll ? (activeTag===null) : (activeTag===tag);
            return `<button class="chip ${active?'active':''}" data-tag="${isAll?"":escapeAttr(tag)}">${tag}</button>`;
        }).join('');

        $filters.querySelectorAll('button').forEach(btn => {
            btn.addEventListener('click', () => {
                const t = btn.dataset.tag;
                activeTag = t ? t : null; // 빈 문자열이면 전체
                $filters.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
                btn.classList.add('active');
                render();
            });
        });
    }

    async function load(){
        let data = DEFAULT_GAMES;
        try{
            const res = await fetch('games.json', {cache:'no-cache'});
            if (res.ok){
                data = await res.json();
            }
        }catch(e){
            console.warn('games.json 불러오기 실패, 기본 목록 사용', e);
        }
        all = data.map(g => ({
            title: g.title||'', url: g.url||'#', thumb: g.thumb||'', tags: Array.isArray(g.tags)?g.tags:[],
            updated: g.updated||'', desc: g.desc||''
        }));
        buildFilterChips();
        render();
    }

    $q.addEventListener('input', render);
    $sort.addEventListener('change', render);

    // --- Popup help toast + inline QR fallback ---
    function showPopupHelp(url) {
        // 토스트 중복 방지
        const old = document.getElementById('popup-help-toast');
        if (old) old.remove();

        const t = document.createElement('div');
        t.className = 'toast';
        t.id = 'popup-help-toast';
        t.innerHTML = `
      <div class="msg">팝업이 차단되어 있습니다. 주소창 오른쪽 <b>팝업 차단</b> 아이콘을 눌러 <b>항상 허용</b> 후 새로고침하세요.</div>
      ${url ? '<button class="btn" id="btn-qr-inline">현재 탭에서 QR 보기</button>' : ''}
      ${url ? '<button class="btn primary" id="btn-try-popup">다시 시도</button>' : ''}
      <button class="x" aria-label="닫기">×</button>
    `;
        document.body.appendChild(t);

        // 닫기(X)
        t.querySelector('.x').addEventListener('click', ()=> t.remove());

        if (url) {
            // 다시 시도 → 허용 후 재시도 시 정상 팝업
            t.querySelector('#btn-try-popup').addEventListener('click', ()=>{
                t.remove();
                openQrWindow(url);
            });

            // 인페이지 QR 대체: 오버레이로 512x512 QR 이미지를 바로 보여줌
            t.querySelector('#btn-qr-inline').addEventListener('click', ()=>{
                t.remove();
                showInlineQr(url);
            });
        }
    }

    function showInlineQr(url) {
        const old = document.getElementById('qr-overlay');
        if (old) old.remove();

        const overlay = document.createElement('div');
        overlay.className = 'qr-overlay';
        overlay.id = 'qr-overlay';

        const panel = document.createElement('div');
        panel.className = 'qr-panel';
        panel.innerHTML = `
      <img alt="QR Code" src="https://api.qrserver.com/v1/create-qr-code/?size=512x512&data=${encodeURIComponent(url)}" referrerpolicy="no-referrer">
      <button class="close">닫기</button>
    `;

        overlay.appendChild(panel);
        document.body.appendChild(overlay);

        overlay.addEventListener('click', (e)=>{
            if (e.target === overlay) overlay.remove();
        });
        panel.querySelector('.close').addEventListener('click', ()=> overlay.remove());
    }

    load();
</script>
</body>
</html>
