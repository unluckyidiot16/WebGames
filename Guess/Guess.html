<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>í”½ì…€ ì»¬ëŸ¬ë§ & ê·œì¹™ í¼ì¦ V5</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui; touch-action: manipulation; -webkit-user-select:none; user-select:none; oversizer-behavior: contain; }
        .view { display: none; width: 100%; min-height: 100vh; }
        .view.active { display: flex; }
        canvas { display:block; image-rendering: pixelated; cursor: pointer; background:#fff; }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ - ìƒ‰ì¹  ì™„ë£Œ ì‹œ í…Œë‘ë¦¬ ê°•ì¡° */
        .card { border:2px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#fff; cursor:pointer; transition:.2s; position: relative; }
        .card:active { transform: scale(0.95); }

        .card.colored { border-width: 4px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card.colored.rarity-C { border-color:#9ca3af; }
        .card.colored.rarity-R { border-color:#60a5fa; }
        .card.colored.rarity-SR { border-color:#fbbf24; }
        .card.colored.rarity-H { border-color:#ec4899; }

        .card img { width:100%; aspect-ratio:1/1; object-fit:contain; background:#f9fafb; image-rendering: pixelated; }
        .locked { filter:grayscale(1) opacity(.6); }
        .locked::after{ content:"ğŸ”’"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:24px; background:rgba(0,0,0,0.1); }

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal { display:none; position:fixed; inset:0; z-index:2000; background:rgba(0,0,0,.6); justify-content:center; align-items:center; }
        .modal-content { background:#fff; width:90%; max-width:480px; padding:24px; border-radius:16px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1); text-align:center; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }

        .shake { animation:shake .3s; }
        @keyframes shake { 0%,100%{transform:translate(0,0)} 25%{transform:translate(-5px,0)} 75%{transform:translate(5px,0)} }

        /* ê·œì¹™ í¼ì¦ ìŠ¤íƒ€ì¼ */
        .puzzle-box { background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .puzzle-box:hover { border-color: #0ea5e9; }
        .puzzle-box.selected { border-color: #3b82f6; box-shadow: 0 0 0 2px #3b82f6; }
        .question-mark { display:flex; align-items:center; justify-content:center; font-size:32px; font-weight:bold; color:#9ca3af; background:#f9fafb; border:2px dashed #d1d5db; border-radius:8px; }

        /* ìƒ‰ì¹  ê²Œì„ UI */
        .composite { display:flex; justify-content:center; overflow:hidden; border:3px solid #374151; border-radius:14px; background: #eee; position: relative; }
        .grid-2x2 { display:inline-grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr; gap:1px; background:#ccc; width: 100%; aspect-ratio: 1/1; }
        .grid-2x2 > div { width: 100%; height: 100%; overflow: hidden; position: relative; background: #fff; }
        .grid-2x2 canvas { width: 100% !important; height: 100% !important; }

        /* íŒ”ë ˆíŠ¸ */
        #paletteContainer, #zoomPalette {
            display:flex; gap:8px; overflow-x:auto; padding:8px 4px; width:100%; scrollbar-width:none;
        }
        .palette-button {
            flex: 0 0 42px; height:42px; border-radius:8px; border:2px solid #ddd;
            font-weight:bold; color:#fff; text-shadow:0 0 2px #000;
            display:flex; align-items:center; justify-content:center;
            transition: transform 0.1s, border-color 0.1s;
        }
        .palette-button.selected { transform:scale(1.15); border-color:#3b82f6; box-shadow:0 4px 6px rgba(0,0,0,0.2); z-index: 10; }

        /* ì¤Œ ì˜¤ë²„ë ˆì´ */
        #zoomOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; z-index:1500; flex-direction: column; }
        #zoomCard { background:#fff; padding:10px; border-radius:12px; display:flex; flex-direction:column; gap:10px; align-items:center; width: 95vw; max-height: 90vh; }
        #zoomCanvasWrapper { overflow: auto; max-width: 100%; max-height: 60vh; border: 1px solid #ccc; display: flex; justify-content: center; background: #eee; }
        #zoomCanvas { display: block; }

        /* ê°€ì±  ê²°ê³¼ */
        .rarity-tag { position:absolute; top:4px; left:4px; font-size:10px; font-weight:800; color:#fff; padding:2px 6px; border-radius:4px; text-shadow:0 1px 2px rgba(0,0,0,.3); z-index: 10; }
        .rarity-C .rarity-tag { background:#9ca3af; }
        .rarity-R .rarity-tag { background:#60a5fa; }
        .rarity-SR .rarity-tag { background:#f59e0b; }
        .rarity-H .rarity-tag { background:#ec4899; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

<!-- ================= 1. íƒ€ì´í‹€ í™”ë©´ ================= -->
<div id="titleScreen" class="view active flex-col items-center justify-center p-6 bg-gradient-to-br from-indigo-50 to-blue-100">
    <div class="text-center mb-10">
        <h1 class="text-5xl md:text-7xl font-extrabold text-indigo-600 mb-4 drop-shadow-sm tracking-tight">PIXEL<br>PUZZLE</h1>
        <p class="text-gray-600 text-lg">ê·œì¹™ì„ ì°¾ê³ , ë„ê°ì„ ì±„ìš°ê³ , ìƒ‰ì¹ í•˜ì„¸ìš”!</p>
    </div>
    <button id="startButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-12 rounded-full text-xl shadow-xl transition transform hover:scale-105">
        ê²Œì„ ì‹œì‘
    </button>
</div>

<!-- ================= 2. ë¡œë¹„ í™”ë©´ ================= -->
<div id="lobbyScreen" class="view flex-col items-center p-6 bg-gray-50">
    <header class="w-full max-w-lg flex justify-between items-center mb-8 bg-white p-4 rounded-xl shadow-sm">
        <div class="flex flex-col">
            <span class="text-xs text-gray-500 font-bold">MY POINT</span>
            <span class="text-2xl font-black text-indigo-600" id="lobbyPoints">0 P</span>
        </div>
        <div class="flex flex-col text-right">
            <span class="text-xs text-gray-500 font-bold">CHALLENGE TICKET</span>
            <span class="text-xl font-bold text-rose-500" id="lobbyCoupons">0</span>
        </div>
    </header>

    <div class="grid grid-cols-1 gap-5 w-full max-w-lg">
        <!-- 1. ë„ê° & ìƒ‰ì¹  -->
        <button id="goBookBtn" class="flex items-center p-6 bg-white rounded-2xl shadow-md border border-gray-100 hover:border-gray-300 transition group">
            <div class="w-14 h-14 bg-blue-50 rounded-full flex items-center justify-center text-3xl mr-5 group-hover:scale-110 transition">ğŸ¨</div>
            <div class="text-left">
                <h2 class="text-xl font-bold text-gray-800">ë„ê° & ìƒ‰ì¹ í•˜ê¸°</h2>
                <p class="text-xs text-gray-400 mt-1">ìˆ˜ì§‘í•œ í”½ì…€ì„ ìƒ‰ì¹ í•˜ì—¬ ì™„ì„±í•˜ì„¸ìš”</p>
            </div>
        </button>

        <!-- 2. ê·œì¹™ í¼ì¦ (ì¼ë°˜) -->
        <button id="goPuzzleBtn" class="flex items-center p-6 bg-white rounded-2xl shadow-md border border-emerald-50 hover:border-emerald-300 transition group">
            <div class="w-14 h-14 bg-emerald-50 rounded-full flex items-center justify-center text-3xl mr-5 group-hover:scale-110 transition">ğŸ§©</div>
            <div class="text-left">
                <h2 class="text-xl font-bold text-emerald-700">ê·œì¹™ í¼ì¦ (ì¼ë°˜)</h2>
                <p class="text-xs text-gray-400 mt-1">í¬ì¸íŠ¸ë¥¼ ëª¨ìœ¼ì„¸ìš”! (10íšŒ ì„±ê³µì‹œ í‹°ì¼“ ì§€ê¸‰)</p>
            </div>
        </button>

        <!-- 3. ë„ì „ í¼ì¦ (ì¿ í°) -->
        <button id="goChallengeBtn" class="flex items-center p-6 bg-white rounded-2xl shadow-md border-2 border-rose-100 hover:border-rose-400 transition group relative overflow-hidden">
            <div class="absolute top-0 right-0 bg-rose-500 text-white text-[10px] px-2 py-1 font-bold">í‹°ì¼“ 1ì¥ ì†Œëª¨</div>
            <div class="w-14 h-14 bg-rose-50 rounded-full flex items-center justify-center text-3xl mr-5 group-hover:scale-110 transition">ğŸ†</div>
            <div class="text-left">
                <h2 class="text-xl font-bold text-rose-600">ë„ì „ í¼ì¦ (ì–´ë ¤ì›€)</h2>
                <p class="text-xs text-gray-400 mt-1">10íšŒ ì„±ê³µ ì‹œ <span class="font-bold text-rose-500">ìŠ¤í˜ì…œ ê°€ì± </span> ì§€ê¸‰!</p>
            </div>
        </button>

        <!-- 4. ë½‘ê¸° ì¡´ -->
        <div class="bg-white rounded-2xl shadow-md border border-indigo-50 p-4">
            <div class="flex items-center mb-3">
                <div class="w-10 h-10 bg-indigo-50 rounded-full flex items-center justify-center text-xl mr-3">ğŸ</div>
                <h2 class="text-lg font-bold text-indigo-700">í”½ì…€ ë½‘ê¸°</h2>
            </div>
            <div class="flex gap-2">
                <button id="gacha1Btn" class="flex-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-bold py-3 rounded-xl transition">
                    1íšŒ ë½‘ê¸°<br><span class="text-xs font-normal">100 P</span>
                </button>
                <button id="gacha10Btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-lg">
                    10íšŒ ë½‘ê¸°<br><span class="text-xs font-normal opacity-80">1,000 P</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ================= 3. ë„ê°(Book) í™”ë©´ ================= -->
<div id="bookScreen" class="view flex-col items-center p-4 bg-gray-50">
    <div class="w-full max-w-6xl flex flex-col gap-4 h-full">
        <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
        <div class="flex flex-wrap items-center justify-between gap-3 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <button id="backToLobbyFromBook" class="text-gray-500 font-bold px-3 py-1 hover:bg-gray-100 rounded-lg">â† ë¡œë¹„</button>
            <div class="flex gap-4 text-sm font-semibold">
                <span>í¬ì¸íŠ¸: <b class="text-indigo-600" id="bookPoints">0</b></span>
                <span>ìˆ˜ì§‘ë¥ : <b class="text-gray-700" id="collectionRate">0%</b></span>
            </div>
            <button id="quickGachaBtn" class="bg-indigo-600 text-white text-xs px-4 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 transition">10íšŒ ë½‘ê¸°</button>
        </div>

        <!-- ë„ê° ê·¸ë¦¬ë“œ -->
        <div id="bookGrid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-3 overflow-y-auto pb-10 content-start flex-1 p-1">
            <!-- JSë¡œ ì¹´ë“œ ìƒì„±ë¨ -->
        </div>
    </div>
</div>

<!-- ================= 4. ìƒ‰ì¹  ê²Œì„ í™”ë©´ ================= -->
<div id="gameScreen" class="view flex-col items-center p-4 bg-gray-100">
    <div class="w-full max-w-3xl bg-white rounded-xl shadow-lg p-4 flex flex-col gap-4">
        <div class="flex justify-between items-center border-b pb-2">
            <button id="exitGameBtn" class="text-gray-500 font-bold hover:text-gray-800">â† ë‚˜ê°€ê¸°</button>
            <h2 class="text-lg font-bold" id="gameTitle">No.1</h2>
            <div class="text-xs bg-gray-100 px-3 py-1 rounded-full font-mono" id="gameProgress">0%</div>
        </div>

        <div id="loadingSpinner" class="hidden text-center py-10 text-gray-500">
            <p class="mb-2">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</p>
            <p class="text-xs text-blue-500 mt-1">â€» í´ë”ëª… 'png' í™•ì¸</p>
        </div>

        <div class="composite aspect-square w-full max-w-[500px] mx-auto relative shadow-inner">
            <div id="quadGrid" class="grid-2x2"></div>
        </div>

        <div>
            <p class="text-xs text-gray-400 mb-2 text-center">â–¼ ìƒ‰ìƒì„ ì„ íƒí•˜ê³  ì˜ì—­ì„ í´ë¦­í•˜ì„¸ìš” (í™•ëŒ€ ê°€ëŠ¥)</p>
            <div id="paletteContainer"></div>
        </div>
    </div>
</div>

<!-- ================= 5. í¼ì¦ ê²Œì„ ëª¨ë‹¬ ================= -->
<div id="puzzleModal" class="view flex-col items-center justify-center bg-gray-900/95 fixed inset-0 z-50">
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        <!-- í—¤ë” -->
        <div class="bg-gradient-to-r from-emerald-500 to-teal-500 p-4 text-white flex justify-between items-center" id="puzzleHeader">
            <div>
                <h2 class="text-xl font-bold" id="puzzleTitle">ê·œì¹™ ì°¾ê¸°</h2>
                <p class="text-xs opacity-90" id="puzzleSubText">ê·œì¹™ì„ ì°¾ì•„ë³´ì„¸ìš”</p>
            </div>
            <div class="text-right">
                <div class="text-2xl font-black tracking-tighter" id="puzzleCombo">0 Combo</div>
                <div class="text-[10px] opacity-80" id="puzzleMaxCombo">MAX: 0</div>
            </div>
        </div>

        <!-- ë¬¸ì œ ì˜ì—­ -->
        <div class="p-6 bg-gray-50 flex flex-col items-center gap-8 flex-1 overflow-y-auto">
            <!-- íƒ€ì´ë¨¸ ë°” -->
            <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
                <div id="puzzleTimerBar" class="bg-emerald-400 h-full w-full"></div>
            </div>

            <!-- ë¬¸ì œ ì‹œí€€ìŠ¤ -->
            <div class="flex items-center gap-2 md:gap-4 w-full justify-center overflow-x-auto py-2">
                <div class="flex gap-2 shrink-0" id="questionContainer"></div>
                <div class="text-gray-300 text-2xl font-bold animate-pulse">â–¶</div>
                <div class="question-mark w-16 h-16 md:w-20 md:h-20 bg-white shadow-inner text-4xl text-gray-300 shrink-0">?</div>
            </div>

            <!-- ì •ë‹µ ì„ íƒì§€ -->
            <div class="w-full">
                <div class="grid grid-cols-4 gap-3" id="answerContainer"></div>
            </div>
        </div>

        <!-- í‘¸í„° -->
        <div class="p-4 border-t flex justify-between items-center bg-white">
            <button id="exitPuzzleBtn" class="text-gray-400 hover:text-red-500 font-bold px-4 text-sm">ê·¸ë§Œí•˜ê¸°</button>
            <span class="text-xs text-gray-400" id="puzzleInfoText"></span>
        </div>
    </div>
</div>

<!-- ================= 6. ì¤Œ ì˜¤ë²„ë ˆì´ ================= -->
<div id="zoomOverlay">
    <div id="zoomCard">
        <div class="flex justify-between w-full mb-1">
            <span class="font-bold text-gray-700">í™•ëŒ€ ëª¨ë“œ</span>
            <button id="zoomCloseBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded text-sm">ë‹«ê¸°</button>
        </div>
        <div id="zoomCanvasWrapper">
            <canvas id="zoomCanvas"></canvas>
        </div>
        <div class="w-full mt-2">
            <div id="zoomPalette"></div>
        </div>
    </div>
</div>

<!-- ================= 7. ê°€ì±  ê²°ê³¼ ëª¨ë‹¬ ================= -->
<div id="gachaModal" class="modal">
    <div class="modal-content max-w-2xl w-full">
        <h2 class="text-2xl font-bold mb-4 text-indigo-600" id="gachaTitle">íšë“ ê²°ê³¼</h2>
        <div id="gachaGrid" class="grid grid-cols-5 gap-2 mb-4 max-h-[50vh] overflow-y-auto p-2"></div>
        <p id="gachaSummary" class="text-sm text-gray-500 mb-4 bg-gray-100 p-2 rounded"></p>
        <button id="gachaCloseBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl w-full hover:bg-indigo-700 shadow-lg">í™•ì¸</button>
    </div>
</div>

<!-- ================= 8. ë©”ì‹œì§€ ëª¨ë‹¬ ================= -->
<div id="msgModal" class="modal">
    <div class="modal-content">
        <h3 id="msgTitle" class="text-xl font-bold mb-2">ì•Œë¦¼</h3>
        <p id="msgBody" class="text-gray-600 mb-6 whitespace-pre-wrap leading-relaxed"></p>
        <button id="msgOkBtn" class="bg-gray-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">í™•ì¸</button>
    </div>
</div>

<script>
    /**
     * ========================================================
     * 1. ì„¤ì • ë° ì „ì—­ ìƒíƒœ
     * ========================================================
     */
    const CONFIG = {
        // âš ï¸ ì´ë¯¸ì§€ í´ë” ì´ë¦„ ì†Œë¬¸ì 'png' ê³ ì •
        basePath: './png/',
        hiddenPath: 'https://unluckyidiot16.github.io/WebGames/Pixel/Hidden/',
        maxNormal: 300,
        maxHidden: 40,

        // ê²Œì„ ë°¸ëŸ°ìŠ¤
        gachaCost: 100,
        puzzleReward: 30,
        puzzleComboBonus: 10,
        puzzleTime: 20,
        challengeGoal: 10
    };

    const State = {
        points: 0, coupons: 0, owned: new Set(), hiddenOwned: new Set(), colored: new Set(),
        normalList: [], hiddenList: [],
        puzzle: {
            mode: 'NORMAL', score: 0, combo: 0, maxCombo: 0,
            timer: null, isPlaying: false, currentAnswerIdx: -1, timeLeft: 0, wrongCount: 0
        }
    };

    const LS_KEY = {
        points: 'px_points', owned: 'px_owned', hidden: 'px_hidden',
        colored: 'px_colored', coupons: 'px_coupons', progress: 'px_prog_'
    };

    /**
     * ========================================================
     * 2. ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ
     * ========================================================
     */
    function initGame() {
        loadSaveData();
        generateImageLists();
        bindEvents();
        updateUI();
    }

    function loadSaveData() {
        State.points = parseInt(localStorage.getItem(LS_KEY.points) || '0');
        State.coupons = parseInt(localStorage.getItem(LS_KEY.coupons) || '0');
        try { State.owned = new Set(JSON.parse(localStorage.getItem(LS_KEY.owned) || '[]')); } catch(e){ State.owned = new Set(); }
        try { State.hiddenOwned = new Set(JSON.parse(localStorage.getItem(LS_KEY.hidden) || '[]')); } catch(e){ State.hiddenOwned = new Set(); }
        try { State.colored = new Set(JSON.parse(localStorage.getItem(LS_KEY.colored) || '[]')); } catch(e){ State.colored = new Set(); }
    }

    function saveData() {
        localStorage.setItem(LS_KEY.points, State.points);
        localStorage.setItem(LS_KEY.coupons, State.coupons);
        localStorage.setItem(LS_KEY.owned, JSON.stringify([...State.owned]));
        localStorage.setItem(LS_KEY.hidden, JSON.stringify([...State.hiddenOwned]));
        localStorage.setItem(LS_KEY.colored, JSON.stringify([...State.colored]));
        updateUI();
    }

    function generateImageLists() {
        for(let i=1; i<=CONFIG.maxNormal; i++) State.normalList.push({ id: i, url: `${CONFIG.basePath}${i}.png`, type: 'N' });
        for(let i=1; i<=CONFIG.maxHidden; i++) State.hiddenList.push({ id: i, url: `${CONFIG.hiddenPath}${i}.png`, type: 'H' });
    }

    function getRarity(id) {
        if (id > 200) return 'SR';
        if (id > 100) return 'R';
        return 'C';
    }

    /**
     * ========================================================
     * 3. UI
     * ========================================================
     */
    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'bookScreen') renderBook();
        if(id === 'lobbyScreen') updateUI();
    }

    function updateUI() {
        ['lobbyPoints', 'bookPoints'].forEach(id => {
            const el = document.getElementById(id);
            if(el) el.textContent = `${State.points.toLocaleString()} P`;
        });
        const coupEl = document.getElementById('lobbyCoupons');
        if(coupEl) coupEl.textContent = State.coupons;
        const colEl = document.getElementById('collectionRate');
        if(colEl) {
            const total = State.normalList.length;
            const have = State.owned.size;
            const pct = Math.floor((have/total)*100);
            colEl.textContent = `${pct}%`;
        }
    }

    function showMessage(title, msg, callback) {
        document.getElementById('msgTitle').textContent = title;
        document.getElementById('msgBody').textContent = msg;
        const modal = document.getElementById('msgModal');
        modal.style.display = 'flex';
        const btn = document.getElementById('msgOkBtn');
        btn.onclick = () => {
            modal.style.display = 'none';
            if(callback) callback();
        };
    }

    /**
     * ========================================================
     * 4. ê·œì¹™ í¼ì¦ ê²Œì„ ì—”ì§„ (ìˆ˜ì •ëœ ë¡œì§)
     * ========================================================
     */
    const PuzzleSystem = {
        EasyRules: ['PATTERN', 'SIZE', 'COLOR'],
        HardRules: ['ROTATE', 'FLIP'],

        start(mode) {
            if (mode === 'CHALLENGE') {
                if (State.coupons < 1) {
                    showMessage("ì¿ í° ë¶€ì¡±", "ë„ì „ ì¿ í°ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    return;
                }
                State.coupons--;
                saveData();
            }
            State.puzzle.mode = mode;
            State.puzzle.score = 0;
            State.puzzle.combo = 0;
            State.puzzle.maxCombo = 0;
            State.puzzle.wrongCount = 0;
            State.puzzle.isPlaying = true;

            const header = document.getElementById('puzzleHeader');
            const title = document.getElementById('puzzleTitle');
            const info = document.getElementById('puzzleInfoText');

            if (mode === 'CHALLENGE') {
                header.className = "bg-gradient-to-r from-rose-500 to-pink-500 p-4 text-white flex justify-between items-center";
                title.textContent = "ğŸ† ë„ì „ í¼ì¦";
                info.textContent = "10ë¬¸ì œ ì„±ê³µ ì‹œ ìŠ¤í˜ì…œ ê°€ì± !";
            } else {
                header.className = "bg-gradient-to-r from-emerald-500 to-teal-500 p-4 text-white flex justify-between items-center";
                title.textContent = "ê·œì¹™ í¼ì¦";
                info.textContent = "10ì½¤ë³´ ì´ìƒ ì‹œ ë„ì „ í‹°ì¼“ íšë“!";
            }
            showView('puzzleModal');
            this.nextLevel();
        },

        stop() {
            State.puzzle.isPlaying = false;
            clearInterval(State.puzzle.timer);
            showView('lobbyScreen');
            let msg = `ìµœì¢… ì½¤ë³´: ${State.puzzle.maxCombo}\níšë“ í¬ì¸íŠ¸: ${State.puzzle.score} P`;
            if (State.puzzle.mode === 'NORMAL' && State.puzzle.maxCombo >= 10) {
                State.coupons++;
                msg += `\nğŸ 10ì½¤ë³´ ë‹¬ì„±! ë„ì „ í‹°ì¼“ 1ì¥ íšë“!`;
            }
            if(State.puzzle.score > 0) {
                State.points += State.puzzle.score;
                saveData();
                showMessage('ê²Œì„ ì¢…ë£Œ', msg);
            }
        },

        nextLevel() {
            if(!State.puzzle.isPlaying) return;
            let puzzleData;
            if (State.puzzle.mode === 'CHALLENGE') {
                puzzleData = this.generateChallengePuzzle();
            } else {
                puzzleData = this.generateNormalPuzzle(State.puzzle.combo);
            }
            if (!puzzleData) {
                this.handleWrong('ë¬¸ì œë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤ (ì´ë¯¸ì§€ ë¶€ì¡±)');
                return;
            }
            this.renderUI(puzzleData);
            this.startTimer();
        },

        startTimer() {
            clearInterval(State.puzzle.timer);
            State.puzzle.timeLeft = CONFIG.puzzleTime;
            const bar = document.getElementById('puzzleTimerBar');
            bar.style.transition = 'none';
            bar.style.width = '100%';
            void bar.offsetWidth;
            bar.style.transition = `width ${CONFIG.puzzleTime}s linear`;
            bar.style.width = '0%';
            State.puzzle.timer = setInterval(() => {
                State.puzzle.timeLeft -= 1;
                if(State.puzzle.timeLeft < 0) {
                    clearInterval(State.puzzle.timer);
                    this.handleWrong('ì‹œê°„ ì´ˆê³¼!');
                }
            }, 1000);
        },

        // ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•œ í•µì‹¬ ë¡œì§
        isDuplicate(choice, existingList) {
            return existingList.some(ex =>
                ex.src === choice.src &&
                ex.r === choice.r &&
                ex.fx === choice.fx &&
                ex.scale === choice.scale &&
                ex.gray === choice.gray
            );
        },

        generateNormalPuzzle(combo) {
            const allImages = [...State.normalList, ...State.hiddenList];
            if(allImages.length < 3) return null;

            const isHard = combo >= 5;
            const rulePool = isHard ? this.HardRules : this.EasyRules;
            const rule = rulePool[Math.floor(Math.random() * rulePool.length)];
            const baseImg = allImages[Math.floor(Math.random() * allImages.length)];

            let sequence = [];
            let answer = {};
            const def = { r:0, fx:1, scale:1, gray:false };

            switch(rule) {
                case 'PATTERN':
                    let otherImg = baseImg;
                    // íŒ¨í„´: ë¬´ì¡°ê±´ ë‹¤ë¥¸ ì´ë¯¸ì§€ ì‚¬ìš©
                    for(let k=0; k<20; k++) {
                        otherImg = allImages[Math.floor(Math.random() * allImages.length)];
                        if(otherImg.url !== baseImg.url) break;
                    }
                    // A-B-A sequence
                    for(let i=0; i<3; i++) {
                        sequence.push({ ...def, src: (i%2===0) ? baseImg.url : otherImg.url });
                    }
                    answer = { ...def, src: otherImg.url, isCorrect: true };
                    break;

                case 'SIZE':
                case 'COLOR':
                    let altImg = baseImg;
                    if (rule === 'PATTERN') { // should not happen but logic safe
                        for(let k=0; k<10; k++) {
                            altImg = allImages[Math.floor(Math.random() * allImages.length)];
                            if(altImg.url !== baseImg.url) break;
                        }
                    }
                    for(let i=0; i<3; i++) {
                        let item = { ...def, src: (i%2===0) ? baseImg.url : altImg.url };
                        if(rule === 'SIZE') item.scale = (i%2===0) ? 1.0 : 0.5;
                        if(rule === 'COLOR') item.gray = (i%2!==0); // Gray is B
                        sequence.push(item);
                    }
                    answer = { ...def, src: baseImg.url, isCorrect: true };
                    if(rule === 'SIZE') answer.scale = 0.5; // A(Big)-B(Small)-A(Big) -> B(Small)
                    if(rule === 'COLOR') answer.gray = true; // A(Col)-B(Gry)-A(Col) -> B(Gry)
                    break;

                case 'ROTATE':
                case 'FLIP':
                    for(let i=0; i<3; i++) {
                        let item = { ...def, src: baseImg.url };
                        if(rule === 'ROTATE') item.r = (i * 90) % 360;
                        if(rule === 'FLIP') item.fx = (i%2===0) ? 1 : -1;
                        sequence.push(item);
                    }
                    answer = { ...def, src: baseImg.url, isCorrect: true };
                    if(rule === 'ROTATE') answer.r = 270;
                    if(rule === 'FLIP') answer.fx = -1;
                    break;
            }

            const choices = this.makeChoices(answer, allImages, rule);
            return { sequence, choices, rule };
        },

        generateChallengePuzzle() {
            const allImages = [...State.normalList, ...State.hiddenList];
            if(allImages.length < 3) return null;

            let imgs = [];
            while(imgs.length < 3) {
                const pick = allImages[Math.floor(Math.random() * allImages.length)];
                if(!imgs.some(x => x.url === pick.url)) imgs.push(pick);
            }

            const def = { r:0, fx:1, scale:1, gray:false };
            let sequence = [];

            for(let i=0; i<5; i++) sequence.push({ ...def, src: imgs[i % 3].url });
            let answer = { ...def, src: imgs[2].url, isCorrect: true };

            return { sequence, choices: this.makeChoices(answer, allImages, 'PATTERN'), rule: 'CHALLENGE' };
        },

        // [ì¤‘ìš” ìˆ˜ì •] ë³´ê¸° ìƒì„± ì‹œ ì¤‘ë³µ/ì˜¤ë‹µ ê²€ì¦ ê°•í™”
        makeChoices(answer, pool, rule) {
            let choices = [answer];
            const def = { r:0, fx:1, scale:1, gray:false, src: answer.src };

            let safetyCounter = 0;
            while(choices.length < 4 && safetyCounter < 100) {
                safetyCounter++;
                let distractor = { ...def, isCorrect: false };

                // ê·œì¹™ë³„ë¡œ ì˜¤ë‹µì„ "í™•ì‹¤í•˜ê²Œ" ë‹¤ë¥´ê²Œ ìƒì„±
                if(rule === 'PATTERN' || rule === 'CHALLENGE') {
                    // ì´ë¯¸ì§€ê°€ ë¬´ì¡°ê±´ ë‹¬ë¼ì•¼ í•¨
                    let rndImg = pool[Math.floor(Math.random()*pool.length)];
                    distractor.src = rndImg.url;
                }
                else if(rule === 'ROTATE') {
                    // ê°ë„ê°€ ë¬´ì¡°ê±´ ë‹¬ë¼ì•¼ í•¨ (ê°™ì€ ì´ë¯¸ì§€ ì‚¬ìš©)
                    distractor.r = (Math.floor(Math.random()*4)*90) % 360;
                }
                else if(rule === 'FLIP') {
                    // ë’¤ì§‘í˜ì´ ë¬´ì¡°ê±´ ë‹¬ë¼ì•¼ í•¨ (ê°™ì€ ì´ë¯¸ì§€ ì‚¬ìš©)
                    distractor.fx = Math.random() > 0.5 ? 1 : -1;
                }
                else if(rule === 'SIZE' || rule === 'COLOR') {
                    // ì´ì§„ ìƒíƒœ(í¬/ì‘, í‘/ë°±)ë§Œìœ¼ë¡œëŠ” ë³´ê¸°ê°€ 2ê°œë¿ì´ë¼ ì¤‘ë³µ í•„ì—°ì 
                    // -> ë‹¤ë¥¸ ì´ë¯¸ì§€ë¥¼ ì„ì–´ì„œ ë³´ê¸°ë¥¼ ì±„ì›€
                    if(Math.random() > 0.3) {
                        distractor.src = pool[Math.floor(Math.random()*pool.length)].url;
                    }
                    if(rule === 'SIZE') distractor.scale = Math.random()>0.5 ? 1.0 : 0.5;
                    if(rule === 'COLOR') distractor.gray = Math.random()>0.5;
                }

                // ì •ë‹µ ë° ê¸°ì¡´ ë³´ê¸°ë“¤ê³¼ ì‹œê°ì ìœ¼ë¡œ ê²¹ì¹˜ëŠ”ì§€ í™•ì¸
                if(!this.isDuplicate(distractor, choices)) {
                    choices.push(distractor);
                }
            }

            return choices.sort(() => Math.random() - 0.5);
        },

        async renderUI(data) {
            document.getElementById('puzzleCombo').textContent = `${State.puzzle.combo} Combo`;
            document.getElementById('puzzleMaxCombo').textContent = `MAX: ${State.puzzle.maxCombo}`;

            const subText = State.puzzle.mode === 'CHALLENGE'
                ? `ë„ì „ ì§„í–‰ ì¤‘ (${State.puzzle.combo}/${CONFIG.challengeGoal})`
                : `ê·œì¹™: ${this.getRuleName(data.rule)}`;
            document.getElementById('puzzleSubText').textContent = subText;

            const qContainer = document.getElementById('questionContainer');
            const aContainer = document.getElementById('answerContainer');
            qContainer.innerHTML = '';
            aContainer.innerHTML = '';

            for(let item of data.sequence) {
                const cvs = this.createCanvas(64);
                cvs.className = "border-2 border-gray-300 rounded bg-white shadow-sm shrink-0";
                qContainer.appendChild(cvs);
                await this.drawImageOnCanvas(cvs, item);
            }

            data.choices.forEach((item, idx) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'puzzle-box flex items-center justify-center aspect-square';
                const cvs = this.createCanvas(64);
                wrapper.appendChild(cvs);
                // ì •ë‹µ ì²´í¬ ì‹œ Indexê°€ ì•„ë‹Œ Objectì˜ ì†ì„±ì„ í™•ì¸ (ë” ì•ˆì „í•¨)
                wrapper.onclick = () => this.checkAnswer(item, wrapper);
                aContainer.appendChild(wrapper);
                this.drawImageOnCanvas(cvs, item);
            });
        },

        createCanvas(size) {
            const c = document.createElement('canvas');
            c.width = size; c.height = size;
            c.style.width = `${size}px`; c.style.height = `${size}px`;
            return c;
        },

        drawImageOnCanvas(canvas, item) {
            return new Promise(resolve => {
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = false;
                const img = new Image();
                img.src = item.src;
                img.onload = () => {
                    const w = canvas.width;
                    const h = canvas.height;
                    ctx.save();
                    ctx.translate(w/2, h/2);
                    // íšŒì „ ì •ê·œí™”
                    const deg = (item.r || 0) % 360;
                    ctx.rotate(deg * Math.PI / 180);
                    const s = item.scale || 1.0;
                    ctx.scale((item.fx || 1) * s, s);

                    if(item.gray) ctx.filter = 'grayscale(100%)';
                    ctx.drawImage(img, -w/2, -h/2, w, h);
                    ctx.restore();
                    resolve();
                };
                img.onerror = resolve;
            });
        },

        // Index ëŒ€ì‹  Item ê°ì²´ ì§ì ‘ ì „ë‹¬
        checkAnswer(item, el) {
            if(!State.puzzle.isPlaying) return;
            clearInterval(State.puzzle.timer);

            if(item.isCorrect) {
                el.classList.add('selected');
                el.style.backgroundColor = '#d1fae5';
                State.puzzle.combo++;
                if(State.puzzle.combo > State.puzzle.maxCombo) State.puzzle.maxCombo = State.puzzle.combo;
                State.puzzle.score += (CONFIG.puzzleReward + (State.puzzle.combo * CONFIG.puzzleComboBonus));

                if (State.puzzle.mode === 'CHALLENGE' && State.puzzle.combo >= CONFIG.challengeGoal) {
                    setTimeout(() => this.winChallenge(), 500);
                } else {
                    setTimeout(() => this.nextLevel(), 400);
                }
            } else {
                el.classList.add('shake');
                el.style.backgroundColor = '#fee2e2';
                if (State.puzzle.mode === 'CHALLENGE') {
                    State.puzzle.wrongCount++;
                    if (State.puzzle.wrongCount >= 1) {
                        setTimeout(() => this.handleWrong('ë„ì „ ì‹¤íŒ¨!'), 500);
                        return;
                    }
                }
                setTimeout(() => this.handleWrong('í‹€ë ¸ìŠµë‹ˆë‹¤!'), 400);
            }
        },

        winChallenge() {
            State.puzzle.isPlaying = false;
            showView('lobbyScreen');
            showMessage("ë„ì „ ì„±ê³µ!", "10ë¬¸ì œë¥¼ ëª¨ë‘ ë§ì·„ìŠµë‹ˆë‹¤!\në³´ìƒìœ¼ë¡œ ìŠ¤í˜ì…œ ê°€ì± ê°€ ì§„í–‰ë©ë‹ˆë‹¤.", () => {
                doSpecialGacha();
            });
        },

        handleWrong(msg) {
            showMessage('ê²Œì„ ì˜¤ë²„', `${msg}\nìµœì¢… ì½¤ë³´: ${State.puzzle.maxCombo}`);
            this.stop();
        },

        getRuleName(code) {
            const names = { 'PATTERN':'íŒ¨í„´ ë°˜ë³µ', 'ROTATE':'ì‹œê³„ íšŒì „', 'FLIP':'ì¢Œìš° ë°˜ì „', 'SIZE':'í¬ê¸° ë³€í™”', 'COLOR':'í‘ë°±/ì»¬ëŸ¬', 'CHALLENGE':'3ë‹¨ íŒ¨í„´' };
            return names[code] || '';
        }
    };

    /**
     * ========================================================
     * 5. ë„ê° ë° ê°€ì±  ì‹œìŠ¤í…œ
     * ========================================================
     */
    function renderBook() {
        const grid = document.getElementById('bookGrid');
        grid.innerHTML = '';
        State.normalList.forEach(item => {
            const isOwned = State.owned.has(item.id);
            const isColored = State.colored.has(item.id);
            grid.appendChild(createCard(item, isOwned, isColored, getRarity(item.id)));
        });
        State.hiddenList.forEach(item => {
            if(State.hiddenOwned.has(item.id)) {
                const isColored = State.colored.has(-item.id);
                grid.appendChild(createCard(item, true, isColored, 'H'));
            }
        });
    }

    function createCard(item, isOwned, isColored, rarity) {
        const div = document.createElement('div');
        div.className = `card ${isColored ? 'colored rarity-'+rarity : ''}`;
        const img = document.createElement('img');
        img.src = item.url;
        if(!isOwned) img.className = 'locked';
        const label = document.createElement('div');
        label.className = 'absolute bottom-0 w-full bg-white/90 text-center text-[10px] py-1 font-bold text-gray-600 truncate';
        label.textContent = item.type==='H' ? `H-${item.id}` : `No.${item.id}`;
        div.appendChild(img);
        div.appendChild(label);
        if(isOwned) div.onclick = () => startGame(item);
        return div;
    }

    function doGacha(count) {
        const cost = count * CONFIG.gachaCost;
        if(State.points < cost) {
            showMessage('í¬ì¸íŠ¸ ë¶€ì¡±', `${cost}Pê°€ í•„ìš”í•©ë‹ˆë‹¤.`);
            return;
        }
        State.points -= cost;
        runGacha(count, false);
    }

    function doSpecialGacha() {
        const results = [];
        const rand = Math.random();
        let rarity = rand < 0.5 ? 'SR' : 'H';
        let pool = [];
        if(rarity === 'H') pool = State.hiddenList;
        else pool = State.normalList.filter(x => x.id > 200);
        if(pool.length === 0) pool = State.normalList;
        const pick = pool[Math.floor(Math.random()*pool.length)];
        let isNew = false;
        let refund = 0;
        if(rarity === 'H') {
            if(State.hiddenOwned.has(pick.id)) refund = 300;
            else { State.hiddenOwned.add(pick.id); isNew = true; }
        } else {
            if(State.owned.has(pick.id)) refund = 100;
            else { State.owned.add(pick.id); isNew = true; }
        }
        if(refund > 0) State.points += refund;
        saveData();
        const grid = document.getElementById('gachaGrid');
        grid.innerHTML = '';
        document.getElementById('gachaTitle').textContent = "âœ¨ ìŠ¤í˜ì…œ ê°€ì±  ê²°ê³¼ âœ¨";
        const d = document.createElement('div');
        d.className = `card rarity-${rarity} relative animate-pulse border-4 border-yellow-400`;
        d.innerHTML = `<div class="rarity-tag" style="background:#f59e0b">SPECIAL</div><img src="${pick.url}" class="bg-gray-100">${isNew?'<span class="absolute bottom-0 right-0 bg-red-500 text-white text-[9px] px-1">NEW</span>':''}`;
        grid.appendChild(d);
        document.getElementById('gachaSummary').textContent = refund > 0 ? `ì¤‘ë³µ ë³´ìƒ: ${refund}P` : `ìƒˆë¡œìš´ ${rarity} ë“±ê¸‰ íšë“!`;
        document.getElementById('gachaModal').style.display = 'flex';
    }

    function runGacha(count, isSpecial) {
        const results = [];
        let refund = 0;
        for(let i=0; i<count; i++) {
            const rand = Math.random();
            let rarity = 'C';
            if(rand < 0.05) rarity = 'SR';
            else if(rand < 0.25) rarity = 'R';
            let pool = [];
            if(rarity === 'C') pool = State.normalList.filter(x => x.id <= 100);
            else if(rarity === 'R') pool = State.normalList.filter(x => x.id > 100 && x.id <= 200);
            else pool = State.normalList.filter(x => x.id > 200);
            if(!pool.length) pool = State.normalList;
            const pick = pool[Math.floor(Math.random()*pool.length)];
            let isNew = false;
            if(State.owned.has(pick.id)) refund += 50;
            else { State.owned.add(pick.id); isNew = true; }
            results.push({...pick, isNew, rarity});
        }
        if(refund > 0) State.points += refund;
        saveData();
        const grid = document.getElementById('gachaGrid');
        grid.innerHTML = '';
        document.getElementById('gachaTitle').textContent = "íšë“ ê²°ê³¼";
        results.forEach(r => {
            const d = document.createElement('div');
            d.className = `card rarity-${r.rarity} relative animate-pulse border-2`;
            d.innerHTML = `<div class="rarity-tag">${r.rarity}</div><img src="${r.url}" class="bg-gray-100">${r.isNew?'<span class="absolute bottom-0 right-0 bg-red-500 text-white text-[9px] px-1">NEW</span>':''}`;
            grid.appendChild(d);
        });
        document.getElementById('gachaSummary').textContent = `í™˜ê¸‰: ${refund}P`;
        document.getElementById('gachaModal').style.display = 'flex';
    }

    /**
     * ========================================================
     * 6. ìƒ‰ì¹  ê²Œì„ (ë¡œì§ ìœ ì§€)
     * ========================================================
     */
    const GAME_CONST = { CELL_SCALE: 15 };
    let GameSession = {
        imgWidth: 0, imgHeight: 0,
        paletteMap: [null], numberGrid: [], completedGrid: [],
        totalCells: 0, completedCells: 0, selectedColorIdx: 0,
        quadrants: [], stageId: 0, zoomQuad: null
    };

    function initQuadGrid() {
        const grid = document.getElementById('quadGrid');
        grid.innerHTML = '';
        GameSession.quadrants = [];
        for(let i=0; i<4; i++) {
            const wrap = document.createElement('div');
            const c = document.createElement('canvas');
            wrap.appendChild(c);
            grid.appendChild(wrap);
            const ctx = c.getContext('2d');
            ctx.imageSmoothingEnabled = false;
            const q = { id:i, canvas:c, ctx:ctx, x:0, y:0, w:0, h:0 };
            c.onclick = () => openZoom(q);
            GameSession.quadrants.push(q);
        }
    }

    async function startGame(item) {
        const stageId = (item.type === 'H') ? -item.id : item.id;
        GameSession.stageId = stageId;
        showView('gameScreen');
        document.getElementById('gameTitle').textContent = item.type === 'H' ? `Hidden ${item.id}` : `No.${item.id}`;
        document.getElementById('loadingSpinner').style.display = 'block';
        document.getElementById('quadGrid').style.opacity = '0';
        initQuadGrid();
        try {
            await processImage(item.url);
            restoreProgress(stageId);
            updateGameProgressUI();
            renderAllQuads();
            renderPalette();
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('quadGrid').style.opacity = '1';
        } catch(e) {
            console.error(e);
            if (e.name === 'SecurityError' || e.message.includes('tainted')) {
                showMessage("ì‹¤í–‰ í™˜ê²½ ì˜¤ë¥˜", "ë¡œì»¬ íŒŒì¼ ë³´ì•ˆ ë¬¸ì œ. ì›¹ ì„œë²„ì—ì„œ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
            } else {
                showMessage("ì˜¤ë¥˜", "ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
            showView('bookScreen');
        }
    }

    function processImage(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'Anonymous';
            img.src = url;
            img.onload = () => {
                const w = img.width; const h = img.height;
                GameSession.imgWidth = w; GameSession.imgHeight = h;
                const cvs = document.createElement('canvas');
                cvs.width = w; cvs.height = h;
                const ctx = cvs.getContext('2d');
                ctx.drawImage(img, 0, 0);
                try {
                    const data = ctx.getImageData(0,0,w,h).data;
                    GameSession.numberGrid = []; GameSession.completedGrid = [];
                    GameSession.paletteMap = [null];
                    let paletteDict = {}; let colorCount = 1;
                    GameSession.totalCells = 0; GameSession.completedCells = 0;
                    for(let y=0; y<h; y++) {
                        GameSession.numberGrid[y] = []; GameSession.completedGrid[y] = [];
                        for(let x=0; x<w; x++) {
                            const i = (y*w + x)*4; const a = data[i+3];
                            if(a < 128) {
                                GameSession.numberGrid[y][x] = 0; GameSession.completedGrid[y][x] = true;
                            } else {
                                const rgba = `rgba(${data[i]},${data[i+1]},${data[i+2]},${(a/255).toFixed(2)})`;
                                if(!paletteDict[rgba]) { paletteDict[rgba] = colorCount; GameSession.paletteMap[colorCount] = rgba; colorCount++; }
                                GameSession.numberGrid[y][x] = paletteDict[rgba]; GameSession.completedGrid[y][x] = false;
                                GameSession.totalCells++;
                            }
                        }
                    }
                    const halfW = Math.floor(w/2); const halfH = Math.floor(h/2);
                    const geoms = [{x:0, y:0, w:halfW, h:halfH},{x:halfW, y:0, w:w-halfW, h:halfH},{x:0, y:halfH, w:halfW, h:h-halfH},{x:halfW, y:halfH, w:w-halfW, h:h-halfH}];
                    geoms.forEach((g, idx) => {
                        const q = GameSession.quadrants[idx];
                        q.x = g.x; q.y = g.y; q.w = g.w; q.h = g.h;
                        q.canvas.width = g.w * GAME_CONST.CELL_SCALE;
                        q.canvas.height = g.h * GAME_CONST.CELL_SCALE;
                    });
                    resolve();
                } catch (err) { reject(err); }
            };
            img.onerror = () => reject(new Error("ë¡œë“œ ì‹¤íŒ¨"));
        });
    }

    function renderAllQuads() { GameSession.quadrants.forEach(q => drawQuad(q)); }
    function drawQuad(q) {
        const scale = GAME_CONST.CELL_SCALE;
        const ctx = q.ctx;
        ctx.clearRect(0, 0, q.canvas.width, q.canvas.height);
        for(let y=0; y<q.h; y++) {
            for(let x=0; x<q.w; x++) {
                const gy = q.y + y; const gx = q.x + x;
                const idx = GameSession.numberGrid[gy][gx];
                if(idx === 0) continue;
                if(GameSession.completedGrid[gy][gx]) {
                    ctx.fillStyle = GameSession.paletteMap[idx]; ctx.fillRect(x*scale, y*scale, scale, scale);
                } else {
                    ctx.fillStyle = '#fff'; ctx.fillRect(x*scale, y*scale, scale, scale);
                    ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1; ctx.strokeRect(x*scale, y*scale, scale, scale);
                    if(scale > 8) { ctx.fillStyle = '#9ca3af'; ctx.font = 'bold 9px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(idx, x*scale+scale/2, y*scale+scale/2+1); }
                }
            }
        }
    }
    function renderPalette() {
        const con = document.getElementById('paletteContainer');
        con.innerHTML = '';
        for(let i=1; i<GameSession.paletteMap.length; i++) {
            const btn = document.createElement('button');
            btn.className = 'palette-button';
            btn.style.backgroundColor = GameSession.paletteMap[i];
            btn.textContent = i;
            btn.onclick = () => selectPaletteColor(i);
            con.appendChild(btn);
        }
    }
    function selectPaletteColor(idx) {
        GameSession.selectedColorIdx = idx;
        [document.getElementById('paletteContainer'), document.getElementById('zoomPalette')].forEach(con => {
            if(!con) return;
            Array.from(con.children).forEach(b => {
                if(parseInt(b.textContent) === idx) b.classList.add('selected'); else b.classList.remove('selected');
            });
        });
    }
    function openZoom(q) {
        GameSession.zoomQuad = q;
        document.getElementById('zoomOverlay').style.display = 'flex';
        const zCvs = document.getElementById('zoomCanvas');
        const zScale = GAME_CONST.CELL_SCALE * 2;
        zCvs.width = q.w * zScale; zCvs.height = q.h * zScale;
        drawZoomCanvas(zCvs, q, zScale);
        const zp = document.getElementById('zoomPalette');
        zp.innerHTML = document.getElementById('paletteContainer').innerHTML;
        Array.from(zp.children).forEach((btn, i) => btn.onclick = () => selectPaletteColor(i+1));
        if(GameSession.selectedColorIdx) selectPaletteColor(GameSession.selectedColorIdx);
        zCvs.onclick = (e) => handleZoomClick(e, q, zScale);
    }
    function drawZoomCanvas(cvs, q, scale) {
        const ctx = cvs.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        ctx.clearRect(0,0,cvs.width,cvs.height);
        for(let y=0; y<q.h; y++) {
            for(let x=0; x<q.w; x++) {
                const gy = q.y + y; const gx = q.x + x;
                const idx = GameSession.numberGrid[gy][gx];
                if(idx === 0) continue;
                if(GameSession.completedGrid[gy][gx]) {
                    ctx.fillStyle = GameSession.paletteMap[idx]; ctx.fillRect(x*scale, y*scale, scale, scale);
                } else {
                    ctx.fillStyle = '#fff'; ctx.fillRect(x*scale, y*scale, scale, scale);
                    ctx.strokeStyle = '#d1d5db'; ctx.strokeRect(x*scale, y*scale, scale, scale);
                    ctx.fillStyle = '#6b7280'; ctx.font = 'bold 16px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(idx, x*scale+scale/2, y*scale+scale/2+1);
                }
            }
        }
    }
    function handleZoomClick(e, q, scale) {
        if(!GameSession.selectedColorIdx) return;
        const rect = e.target.getBoundingClientRect();
        const x = Math.floor(((e.clientX - rect.left) * (e.target.width/rect.width)) / scale);
        const y = Math.floor(((e.clientY - rect.top) * (e.target.height/rect.height)) / scale);
        const gx = q.x + x; const gy = q.y + y;
        if(gx >= 0 && gx < GameSession.imgWidth && gy >= 0 && gy < GameSession.imgHeight) {
            if(GameSession.completedGrid[gy][gx]) return;
            if(GameSession.numberGrid[gy][gx] === GameSession.selectedColorIdx) {
                GameSession.completedGrid[gy][gx] = true; GameSession.completedCells++;
                drawZoomCanvas(e.target, q, scale); drawQuad(q);
                saveProgress(); updateGameProgressUI(); checkCompletion();
            } else if (GameSession.numberGrid[gy][gx] !== 0) {
                e.target.classList.add('shake'); setTimeout(()=>e.target.classList.remove('shake'),300);
            }
        }
    }
    function saveProgress() { localStorage.setItem(LS_KEY.progress + GameSession.stageId, JSON.stringify(GameSession.completedGrid)); }
    function restoreProgress(stageId) {
        const saved = localStorage.getItem(LS_KEY.progress + stageId);
        if(saved) {
            try { const grid = JSON.parse(saved);
                if(grid.length===GameSession.imgHeight && grid[0].length===GameSession.imgWidth) {
                    GameSession.completedGrid = grid;
                    let done=0; for(let y=0;y<GameSession.imgHeight;y++) for(let x=0;x<GameSession.imgWidth;x++) if(GameSession.numberGrid[y][x]!==0 && GameSession.completedGrid[y][x]) done++;
                    GameSession.completedCells=done;
                }
            } catch(e){}
        }
    }
    function updateGameProgressUI() {
        const pct = Math.floor((GameSession.completedCells / GameSession.totalCells) * 100) || 0;
        document.getElementById('gameProgress').textContent = `${pct}%`;
    }
    function checkCompletion() {
        if(GameSession.completedCells >= GameSession.totalCells) {
            if(!State.colored.has(GameSession.stageId)) {
                State.colored.add(GameSession.stageId);
                State.points += 500; State.coupons += 1; saveData();
                showMessage("ì¶•í•˜í•©ë‹ˆë‹¤!", "ì‘í’ˆì„ ì™„ì„±í–ˆìŠµë‹ˆë‹¤!\n500Pì™€ ë„ì „ í‹°ì¼“ 1ì¥ì„ íšë“í–ˆìŠµë‹ˆë‹¤.");
            }
        }
    }

    /**
     * ========================================================
     * 7. ì´ë²¤íŠ¸ ë°”ì¸ë”©
     * ========================================================
     */
    function bindEvents() {
        document.getElementById('startButton').onclick = () => showView('lobbyScreen');
        document.getElementById('goBookBtn').onclick = () => showView('bookScreen');

        document.getElementById('goPuzzleBtn').onclick = () => PuzzleSystem.start('NORMAL');
        document.getElementById('goChallengeBtn').onclick = () => PuzzleSystem.start('CHALLENGE');

        document.getElementById('gacha1Btn').onclick = () => doGacha(1);
        document.getElementById('gacha10Btn').onclick = () => doGacha(10);
        document.getElementById('backToLobbyFromBook').onclick = () => showView('lobbyScreen');
        document.getElementById('quickGachaBtn').onclick = () => doGacha(10);
        document.getElementById('exitGameBtn').onclick = () => { showView('bookScreen'); renderBook(); };
        document.getElementById('gachaCloseBtn').onclick = () => document.getElementById('gachaModal').style.display = 'none';
        document.getElementById('msgOkBtn').onclick = () => document.getElementById('msgModal').style.display = 'none';
        document.getElementById('zoomCloseBtn').onclick = () => document.getElementById('zoomOverlay').style.display = 'none';
        document.getElementById('exitPuzzleBtn').onclick = () => PuzzleSystem.stop();
    }

    window.onload = initGame;
</script>
</body>
</html>