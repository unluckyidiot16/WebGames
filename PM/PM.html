<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>í”½ì…€ & ìˆ˜í•™ íŠ¸ë ˆì´ë‹ V6 (Guaranteed Gacha)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: ui-sans-serif, system-ui; touch-action: manipulation; -webkit-user-select:none; user-select:none; oversizer-behavior: contain; }
        .view { display: none; width: 100%; min-height: 100vh; }
        .view.active { display: flex; }
        canvas { display:block; image-rendering: pixelated; cursor: pointer; background:#fff; }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { border:2px solid #e5e7eb; border-radius:10px; overflow:hidden; background:#fff; cursor:pointer; transition:.2s; position: relative; }
        .card:active { transform: scale(0.95); }
        .card.colored { border-width: 4px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .card.colored.rarity-C { border-color:#9ca3af; }
        .card.colored.rarity-R { border-color:#60a5fa; }
        .card.colored.rarity-SR { border-color:#fbbf24; }
        .card.colored.rarity-H { border-color:#ec4899; }
        .card img { width:100%; aspect-ratio:1/1; object-fit:contain; background:#f9fafb; image-rendering: pixelated; }
        .locked { filter:grayscale(1) opacity(.6); }
        .locked::after{ content:"ğŸ”’"; position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-size:24px; background:rgba(0,0,0,0.1); }

        /* ëª¨ë‹¬ */
        .modal { display:none; position:fixed; inset:0; z-index:2000; background:rgba(0,0,0,.6); justify-content:center; align-items:center; }
        .modal-content { background:#fff; width:90%; max-width:480px; padding:24px; border-radius:16px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1); text-align:center; animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popUp { from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        .shake { animation:shake .3s; }
        @keyframes shake { 0%,100%{transform:translate(0,0)} 25%{transform:translate(-5px,0)} 75%{transform:translate(5px,0)} }

        /* í¼ì¦ ë²„íŠ¼ */
        .puzzle-box { background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 12px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: #374151; }
        .puzzle-box:hover { border-color: #0ea5e9; background: #e0f2fe; }
        .puzzle-box.selected { border-color: #3b82f6; box-shadow: 0 0 0 2px #3b82f6; background: #dbeafe; }

        /* ìˆ˜í•™ ë¬¸ì œ ì˜ì—­ */
        #mathQuestionArea { width: 100%; text-align: center; font-size: 2.5rem; font-weight: 800; padding: 30px 10px; background: #fff; border-radius: 16px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); border: 1px solid #e5e7eb; margin-bottom: 20px; line-height: 1.3; color: #1f2937; }

        /* ìƒ‰ì¹  ê²Œì„ UI */
        .composite { display:flex; justify-content:center; overflow:hidden; border:3px solid #374151; border-radius:14px; background: #eee; position: relative; }
        .grid-2x2 { display:inline-grid; grid-template-columns:1fr 1fr; grid-template-rows:1fr 1fr; gap:1px; background:#ccc; width: 100%; aspect-ratio: 1/1; }
        .grid-2x2 > div { width: 100%; height: 100%; overflow: hidden; position: relative; background: #fff; }
        .grid-2x2 canvas { width: 100% !important; height: 100% !important; }

        #paletteContainer, #zoomPalette { display:flex; gap:8px; overflow-x:auto; padding:8px 4px; width:100%; scrollbar-width:none; }
        .palette-button { flex: 0 0 42px; height:42px; border-radius:8px; border:2px solid #ddd; font-weight:bold; color:#fff; text-shadow:0 0 2px #000; display:flex; align-items:center; justify-content:center; transition: transform 0.1s, border-color 0.1s; }
        .palette-button.selected { transform:scale(1.15); border-color:#3b82f6; box-shadow:0 4px 6px rgba(0,0,0,0.2); z-index: 10; }

        #zoomOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:none; align-items:center; justify-content:center; z-index:1500; flex-direction: column; }
        #zoomCard { background:#fff; padding:10px; border-radius:12px; display:flex; flex-direction:column; gap:10px; align-items:center; width: 95vw; max-height: 90vh; }
        #zoomCanvasWrapper { overflow: auto; max-width: 100%; max-height: 60vh; border: 1px solid #ccc; display: flex; justify-content: center; background: #eee; }
        #zoomCanvas { display: block; }

        .rarity-tag { position:absolute; top:4px; left:4px; font-size:10px; font-weight:800; color:#fff; padding:2px 6px; border-radius:4px; text-shadow:0 1px 2px rgba(0,0,0,.3); z-index: 10; }
        .rarity-C .rarity-tag { background:#9ca3af; }
        .rarity-R .rarity-tag { background:#60a5fa; }
        .rarity-SR .rarity-tag { background:#f59e0b; }
        .rarity-H .rarity-tag { background:#ec4899; }

        /* ì—…ì  ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .achievement-item { display:flex; align-items:center; justify-content:between; padding:12px; border:1px solid #e5e7eb; border-radius:12px; margin-bottom:8px; background:#fff; }
        .achievement-item.claimed { background:#f3f4f6; opacity:0.7; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen text-gray-800">

<div id="titleScreen" class="view active flex-col items-center justify-center p-6 bg-gradient-to-br from-indigo-50 to-blue-100">
    <div class="text-center mb-10">
        <h1 class="text-5xl md:text-7xl font-extrabold text-indigo-600 mb-4 drop-shadow-sm tracking-tight">PIXEL<br>& MATH</h1>
        <p class="text-gray-600 text-lg">ìˆ˜í•™ í’€ê³  í”½ì…€ ë„ê° ì™„ì„±í•˜ê¸°</p>
    </div>
    <button id="startButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-4 px-12 rounded-full text-xl shadow-xl transition transform hover:scale-105">
        ê²Œì„ ì‹œì‘
    </button>
</div>

<div id="lobbyScreen" class="view flex-col items-center p-6 bg-gray-50 overflow-y-auto">
    <header class="w-full max-w-lg flex justify-between items-center mb-6 bg-white p-4 rounded-xl shadow-sm shrink-0">
        <div class="flex flex-col">
            <span class="text-xs text-gray-500 font-bold">MY POINT</span>
            <span class="text-2xl font-black text-indigo-600" id="lobbyPoints">0 P</span>
        </div>
        <div class="flex gap-3 text-right">
            <div class="flex flex-col items-end">
                <span class="text-xs text-gray-400 font-bold">RARE</span>
                <span class="text-lg font-bold text-amber-500" id="lobbyRareTickets">0ì¥</span>
            </div>
            <div class="flex flex-col items-end">
                <span class="text-xs text-gray-400 font-bold">GUARANTEED</span>
                <span class="text-lg font-bold text-purple-600" id="lobbyGuaranteedTickets">0ì¥</span>
            </div>
        </div>
    </header>

    <div class="grid grid-cols-1 gap-4 w-full max-w-lg pb-10">
        <button id="achievementBtn" class="flex items-center p-4 bg-white rounded-2xl shadow-md border border-gray-100 hover:border-gray-300 transition relative">
            <div class="w-10 h-10 bg-purple-50 rounded-full flex items-center justify-center text-xl mr-3">ğŸ†</div>
            <div class="text-left flex-1">
                <h2 class="text-lg font-bold text-gray-800">ì—…ì  & ë³´ìƒ</h2>
                <p class="text-xs text-gray-400">ë³´ìƒ: <span class="text-purple-600 font-bold">í™•ì • ë½‘ê¸° í‹°ì¼“</span></p>
            </div>
            <div id="achievementBadge" class="hidden absolute top-4 right-4 bg-red-500 text-white text-[10px] font-bold px-2 py-0.5 rounded-full animate-bounce">N</div>
        </button>

        <button id="goBookBtn" class="flex items-center p-5 bg-white rounded-2xl shadow-md border border-gray-100 hover:border-gray-300 transition group">
            <div class="w-12 h-12 bg-blue-50 rounded-full flex items-center justify-center text-2xl mr-4">ğŸ¨</div>
            <div class="text-left">
                <h2 class="text-lg font-bold text-gray-800">ë„ê° & ìƒ‰ì¹ í•˜ê¸°</h2>
                <p class="text-xs text-gray-400">ìˆ˜ì§‘í•œ í”½ì…€ ì™„ì„±í•˜ê¸°</p>
            </div>
        </button>

        <div class="bg-white rounded-2xl shadow-md border border-gray-100 p-5 mt-2">
            <h2 class="text-lg font-bold text-gray-800 mb-3 flex items-center">
                <span class="mr-2">ğŸ§®</span>ìˆ˜í•™ íŠ¸ë ˆì´ë‹
                <span class="ml-2 text-xs bg-indigo-100 text-indigo-600 px-2 py-1 rounded-full">ì½¤ë³´ ì‹œ ë ˆì–´í‹°ì¼“ ì§€ê¸‰</span>
            </h2>
            <div class="grid grid-cols-3 gap-3">
                <button id="goMulBtn" class="flex flex-col items-center justify-center p-4 bg-orange-50 rounded-xl border border-orange-100 hover:bg-orange-100 transition">
                    <div class="text-3xl mb-1">âœ–ï¸</div>
                    <div class="font-bold text-orange-700">ê³±ì…ˆ</div>
                </button>
                <button id="goDivBtn" class="flex flex-col items-center justify-center p-4 bg-cyan-50 rounded-xl border border-cyan-100 hover:bg-cyan-100 transition">
                    <div class="text-3xl mb-1">â—</div>
                    <div class="font-bold text-cyan-700">ë‚˜ëˆ—ì…ˆ</div>
                </button>
                <button id="goFracBtn" class="flex flex-col items-center justify-center p-4 bg-purple-50 rounded-xl border border-purple-100 hover:bg-purple-100 transition">
                    <div class="text-3xl mb-1">Â½</div>
                    <div class="font-bold text-purple-700">ë¶„ìˆ˜</div>
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-md border border-indigo-50 p-4 mt-2">
            <div class="flex items-center mb-2">
                <div class="w-8 h-8 bg-indigo-50 rounded-full flex items-center justify-center text-lg mr-2">ğŸ</div>
                <h2 class="text-base font-bold text-indigo-700">í”½ì…€ ë½‘ê¸°</h2>
            </div>
            <div class="flex gap-2 mb-2">
                <button id="gacha1Btn" class="flex-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-800 font-bold py-2 rounded-xl transition text-xs">ì¼ë°˜ 1íšŒ(100P)</button>
                <button id="gacha10Btn" class="flex-1 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 rounded-xl transition shadow-lg text-xs">ì¼ë°˜ 10íšŒ(1000P)</button>
            </div>
            <div class="flex gap-2">
                <button id="rareGachaBtn" class="flex-1 bg-gradient-to-r from-amber-400 to-yellow-500 hover:from-amber-500 hover:to-yellow-600 text-white font-bold py-3 rounded-xl transition shadow-md text-xs flex flex-col items-center justify-center">
                    <span>ğŸ‘‘ ë ˆì–´ (Râ†‘)</span>
                    <span class="opacity-80 text-[10px]">ë ˆì–´í‹°ì¼“ 1ì¥</span>
                </button>
                <button id="guaranteedGachaBtn" class="flex-1 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white font-bold py-3 rounded-xl transition shadow-md text-xs flex flex-col items-center justify-center">
                    <span>ğŸ’ ë¯¸ë³´ìœ  í™•ì •</span>
                    <span class="opacity-80 text-[10px]">í™•ì •í‹°ì¼“ 1ì¥</span>
                </button>
            </div>
        </div>
    </div>
</div>

<div id="bookScreen" class="view flex-col items-center p-4 bg-gray-50">
    <div class="w-full max-w-6xl flex flex-col gap-4 h-full">
        <div class="flex flex-wrap items-center justify-between gap-3 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <button id="backToLobbyFromBook" class="text-gray-500 font-bold px-3 py-1 hover:bg-gray-100 rounded-lg">â† ë¡œë¹„</button>
            <div class="flex gap-4 text-sm font-semibold">
                <span>í¬ì¸íŠ¸: <b class="text-indigo-600" id="bookPoints">0</b></span>
                <span>ìˆ˜ì§‘ë¥ : <b class="text-gray-700" id="collectionRate">0%</b></span>
            </div>
            <button id="quickGachaBtn" class="bg-indigo-600 text-white text-xs px-4 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 transition">10íšŒ ë½‘ê¸°</button>
        </div>
        <div id="bookGrid" class="grid grid-cols-4 sm:grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-3 overflow-y-auto pb-10 content-start flex-1 p-1"></div>
    </div>
</div>

<div id="gameScreen" class="view flex-col items-center p-4 bg-gray-100">
    <div class="w-full max-w-3xl bg-white rounded-xl shadow-lg p-4 flex flex-col gap-4">
        <div class="flex justify-between items-center border-b pb-2">
            <button id="exitGameBtn" class="text-gray-500 font-bold hover:text-gray-800">â† ë‚˜ê°€ê¸°</button>
            <h2 class="text-lg font-bold" id="gameTitle">No.1</h2>
            <div class="text-xs bg-gray-100 px-3 py-1 rounded-full font-mono" id="gameProgress">0%</div>
        </div>
        <div id="loadingSpinner" class="hidden text-center py-10 text-gray-500">
            <p class="mb-2">ì´ë¯¸ì§€ ë¶„ì„ ì¤‘...</p>
        </div>
        <div class="composite aspect-square w-full max-w-[500px] mx-auto relative shadow-inner">
            <div id="quadGrid" class="grid-2x2"></div>
        </div>
        <div>
            <p class="text-xs text-gray-400 mb-2 text-center">â–¼ ìƒ‰ìƒì„ ì„ íƒí•˜ê³  ì˜ì—­ì„ í´ë¦­í•˜ì„¸ìš”</p>
            <div id="paletteContainer"></div>
        </div>
    </div>
</div>

<div id="puzzleModal" class="view flex-col items-center justify-center bg-gray-900/95 fixed inset-0 z-50">
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
        <div class="bg-gradient-to-r from-indigo-500 to-blue-500 p-4 text-white flex justify-between items-center" id="puzzleHeader">
            <div>
                <h2 class="text-xl font-bold" id="puzzleTitle">ìˆ˜í•™ ë¬¸ì œ</h2>
                <p class="text-xs opacity-90" id="puzzleSubText">ì •ë‹µì„ ë§í˜€ì£¼ì„¸ìš”</p>
            </div>
            <div class="text-right">
                <div class="text-2xl font-black tracking-tighter" id="puzzleCombo">0 Combo</div>
                <div class="text-xs opacity-80" id="puzzleLevelTag">ë‚œì´ë„: í•˜</div>
            </div>
        </div>

        <div class="p-6 bg-gray-50 flex flex-col items-center gap-6 flex-1 overflow-y-auto w-full">
            <div class="w-full bg-gray-200 h-2 rounded-full overflow-hidden">
                <div id="puzzleTimerBar" class="bg-emerald-400 h-full w-full"></div>
            </div>

            <div id="mathQuestionArea"></div>

            <div class="w-full">
                <div class="grid grid-cols-2 gap-4" id="answerContainer"></div>
            </div>
        </div>

        <div class="p-4 border-t flex justify-between items-center bg-white">
            <button id="exitPuzzleBtn" class="text-gray-400 hover:text-red-500 font-bold px-4 text-sm">ê·¸ë§Œí•˜ê¸°</button>
            <span class="text-xs text-gray-400">10ì½¤ë³´ ë‹¨ìœ„ë¡œ ë ˆì–´ í‹°ì¼“ì´ ì§€ê¸‰ë©ë‹ˆë‹¤!</span>
        </div>
    </div>
</div>

<div id="achievementModal" class="modal">
    <div class="modal-content max-w-lg w-full">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-gray-800">ì—…ì  ë³´ìƒ</h2>
            <button id="closeAchievementBtn" class="text-gray-400 hover:text-gray-600 font-bold text-xl">âœ•</button>
        </div>
        <div id="achievementList" class="overflow-y-auto max-h-[60vh] text-left"></div>
    </div>
</div>

<div id="zoomOverlay">
    <div id="zoomCard">
        <div class="flex justify-between w-full mb-1">
            <span class="font-bold text-gray-700">í™•ëŒ€ ëª¨ë“œ</span>
            <button id="zoomCloseBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-1 px-3 rounded text-sm">ë‹«ê¸°</button>
        </div>
        <div id="zoomCanvasWrapper"><canvas id="zoomCanvas"></canvas></div>
        <div class="w-full mt-2"><div id="zoomPalette"></div></div>
    </div>
</div>

<div id="gachaModal" class="modal">
    <div class="modal-content max-w-2xl w-full">
        <h2 class="text-2xl font-bold mb-4 text-indigo-600" id="gachaTitle">íšë“ ê²°ê³¼</h2>
        <div id="gachaGrid" class="grid grid-cols-5 gap-2 mb-4 max-h-[50vh] overflow-y-auto p-2"></div>
        <p id="gachaSummary" class="text-sm text-gray-500 mb-4 bg-gray-100 p-2 rounded"></p>
        <button id="gachaCloseBtn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-xl w-full hover:bg-indigo-700 shadow-lg">í™•ì¸</button>
    </div>
</div>
<div id="msgModal" class="modal">
    <div class="modal-content">
        <h3 id="msgTitle" class="text-xl font-bold mb-2">ì•Œë¦¼</h3>
        <p id="msgBody" class="text-gray-600 mb-6 whitespace-pre-wrap leading-relaxed"></p>
        <button id="msgOkBtn" class="bg-gray-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-700">í™•ì¸</button>
    </div>
</div>

<script>
    const CONFIG = {
        basePath: './png/',
        hiddenPath: 'https://unluckyidiot16.github.io/WebGames/Pixel/Hidden/',
        maxNormal: 350, maxHidden: 40,
        gachaCost: 100, puzzleReward: 30, puzzleComboBonus: 10,
        puzzleTime: 60,
    };

    const State = {
        points: 0,
        rareTickets: 0,
        guaranteedTickets: 0, // [NEW] í™•ì • ë½‘ê¸° í‹°ì¼“
        maxComboRecord: 0,
        owned: new Set(), hiddenOwned: new Set(), colored: new Set(),
        claimedAchievements: new Set(),
        normalList: [], hiddenList: [],
        puzzle: {
            mode: 'MUL', difficulty: 0, mathCount: 0,
            score: 0, combo: 0, maxCombo: 0,
            timer: null, isPlaying: false, timeLeft: 0
        }
    };

    const LS_KEY = {
        points: 'px_points',
        rareTickets: 'px_rare_tickets',
        guaranteedTickets: 'px_guaranteed_tickets',
        maxCombo: 'px_max_combo',
        owned: 'px_owned', hidden: 'px_hidden', colored: 'px_colored',
        achievements: 'px_achievements',
        progress: 'px_prog_'
    };

    // --- ì—…ì  ë°ì´í„°: ë³´ìƒì´ í™•ì • í‹°ì¼“ìœ¼ë¡œ ë³€ê²½ë¨ ---
    const ACHIEVEMENTS = [
        { id: 'combo_10', title: 'ì´ˆë³´ ê³„ì‚°ì™•', desc: 'ìµœëŒ€ 10ì½¤ë³´ ë‹¬ì„±', type: 'COMBO', target: 10, reward: 1 },
        { id: 'combo_20', title: 'ìˆ™ë ¨ëœ ê³„ì‚°ì™•', desc: 'ìµœëŒ€ 20ì½¤ë³´ ë‹¬ì„±', type: 'COMBO', target: 20, reward: 1 },
        { id: 'combo_30', title: 'ì—˜ë¦¬íŠ¸ ê³„ì‚°ì™•', desc: 'ìµœëŒ€ 30ì½¤ë³´ ë‹¬ì„±', type: 'COMBO', target: 30, reward: 1 },
        { id: 'combo_40', title: 'ë§ˆìŠ¤í„° ê³„ì‚°ì™•', desc: 'ìµœëŒ€ 40ì½¤ë³´ ë‹¬ì„±', type: 'COMBO', target: 40, reward: 1 },
        { id: 'combo_50', title: 'ì „ì„¤ì˜ ê³„ì‚°ì™•', desc: 'ìµœëŒ€ 50ì½¤ë³´ ë‹¬ì„±', type: 'COMBO', target: 50, reward: 1 },
        { id: 'col_10', title: 'ìˆ˜ì§‘ì˜ ì‹œì‘', desc: 'ë„ê° ìˆ˜ì§‘ë¥  10% ë‹¬ì„±', type: 'COLLECT', target: 10, reward: 1 },
        { id: 'col_30', title: 'ë³¸ê²©ì ì¸ ìˆ˜ì§‘', desc: 'ë„ê° ìˆ˜ì§‘ë¥  30% ë‹¬ì„±', type: 'COLLECT', target: 30, reward: 1 },
        { id: 'col_50', title: 'ë„ê°ì˜ ì ˆë°˜', desc: 'ë„ê° ìˆ˜ì§‘ë¥  50% ë‹¬ì„±', type: 'COLLECT', target: 50, reward: 1 },
        { id: 'col_80', title: 'í¬ì¼“ëª¬ ë§ˆìŠ¤í„°', desc: 'ë„ê° ìˆ˜ì§‘ë¥  80% ë‹¬ì„±', type: 'COLLECT', target: 80, reward: 1 },
        { id: 'col_100', title: 'ì „ì„¤ì˜ ì™„ì„±', desc: 'ë„ê° ìˆ˜ì§‘ë¥  100% ë‹¬ì„±', type: 'COLLECT', target: 100, reward: 1 },
    ];

    function initGame() {
        loadSaveData();
        generateImageLists();
        bindEvents();
        updateUI();
        AchievementSystem.check();
    }
    function loadSaveData() {
        State.points = parseInt(localStorage.getItem(LS_KEY.points) || '0');
        State.rareTickets = parseInt(localStorage.getItem(LS_KEY.rareTickets) || '0');
        State.guaranteedTickets = parseInt(localStorage.getItem(LS_KEY.guaranteedTickets) || '0');
        State.maxComboRecord = parseInt(localStorage.getItem(LS_KEY.maxCombo) || '0');
        try { State.owned = new Set(JSON.parse(localStorage.getItem(LS_KEY.owned) || '[]')); } catch(e){ State.owned = new Set(); }
        try { State.hiddenOwned = new Set(JSON.parse(localStorage.getItem(LS_KEY.hidden) || '[]')); } catch(e){ State.hiddenOwned = new Set(); }
        try { State.colored = new Set(JSON.parse(localStorage.getItem(LS_KEY.colored) || '[]')); } catch(e){ State.colored = new Set(); }
        try { State.claimedAchievements = new Set(JSON.parse(localStorage.getItem(LS_KEY.achievements) || '[]')); } catch(e){ State.claimedAchievements = new Set(); }
    }
    function saveData() {
        localStorage.setItem(LS_KEY.points, State.points);
        localStorage.setItem(LS_KEY.rareTickets, State.rareTickets);
        localStorage.setItem(LS_KEY.guaranteedTickets, State.guaranteedTickets);
        localStorage.setItem(LS_KEY.maxCombo, State.maxComboRecord);
        localStorage.setItem(LS_KEY.owned, JSON.stringify([...State.owned]));
        localStorage.setItem(LS_KEY.hidden, JSON.stringify([...State.hiddenOwned]));
        localStorage.setItem(LS_KEY.colored, JSON.stringify([...State.colored]));
        localStorage.setItem(LS_KEY.achievements, JSON.stringify([...State.claimedAchievements]));
        updateUI();
        AchievementSystem.check();
    }
    function generateImageLists() {
        for(let i=1; i<=CONFIG.maxNormal; i++) State.normalList.push({ id: i, url: `${CONFIG.basePath}${i}.png`, type: 'N' });
        for(let i=1; i<=CONFIG.maxHidden; i++) State.hiddenList.push({ id: i, url: `${CONFIG.hiddenPath}${i}.png`, type: 'H' });
    }

    const LEGENDARY_IDS = new Set([144, 145, 146, 150, 243, 244, 245, 249, 250]);
    const MYTHICAL_IDS  = new Set([151, 251]);
    const POPULARITY_TOP5 = new Set([6, 94, 1, 25, 133, 197, 248, 249, 157, 212, 282, 330, 254, 257]);
    const POPULARITY_TOP10 = new Set([...POPULARITY_TOP5, 149, 151, 150, 59, 131, 181, 196, 155, 245, 158, 258, 350]);
    const POPULARITY_TOP30 = new Set([...POPULARITY_TOP10, 143, 38, 7, 9, 134, 89, 4, 132, 79, 34, 137, 37, 54, 26, 127, 135, 148, 3, 144, 81, 169, 162, 251, 152, 250, 160, 214, 177, 172, 229, 175, 195, 244, 156, 233, 194, 200, 213, 202, 230, 260, 304, 306, 303, 286, 255, 253, 252, 302, 272, 292, 262]);

    const GACHA_RATES = { H: 0.001, SR: 0.05, R: 0.20, C: 0.749 };
    const RARE_GACHA_RATES = { H: 0.02, SR: 0.28, R: 0.70, C: 0 };
    const DUP_REFUND = { C: 30, R: 60, SR: 120, H: 300 };

    function getRarity(id) {
        if (MYTHICAL_IDS.has(id) || POPULARITY_TOP5.has(id)) return 'H';
        if (LEGENDARY_IDS.has(id) || POPULARITY_TOP10.has(id)) return 'SR';
        if (POPULARITY_TOP30.has(id)) return 'R';
        if (id > 200) return 'SR';
        if (id > 100) return 'R';
        return 'C';
    }

    function updateUI() {
        ['lobbyPoints', 'bookPoints'].forEach(id => { const el = document.getElementById(id); if(el) el.textContent = `${State.points.toLocaleString()} P`; });
        const tickEl = document.getElementById('lobbyRareTickets'); if(tickEl) tickEl.textContent = `${State.rareTickets}ì¥`;
        const gTickEl = document.getElementById('lobbyGuaranteedTickets'); if(gTickEl) gTickEl.textContent = `${State.guaranteedTickets}ì¥`;

        const colEl = document.getElementById('collectionRate'); if(colEl) {
            colEl.textContent = `${Math.floor((State.owned.size/State.normalList.length)*100)}%`;
        }
    }
    function showView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        if(id === 'bookScreen') renderBook();
        if(id === 'lobbyScreen') updateUI();
    }
    function showMessage(title, msg, callback) {
        document.getElementById('msgTitle').textContent = title;
        document.getElementById('msgBody').textContent = msg;
        const modal = document.getElementById('msgModal');
        modal.style.display = 'flex';
        document.getElementById('msgOkBtn').onclick = () => { modal.style.display = 'none'; if(callback) callback(); };
    }

    // --- ì—…ì  ì‹œìŠ¤í…œ ---
    const AchievementSystem = {
        check() {
            let hasUnclaimed = false;
            const collectionPct = Math.floor((State.owned.size / State.normalList.length) * 100);

            ACHIEVEMENTS.forEach(ac => {
                let passed = false;
                if(ac.type === 'COMBO') passed = State.maxComboRecord >= ac.target;
                if(ac.type === 'COLLECT') passed = collectionPct >= ac.target;
                if(passed && !State.claimedAchievements.has(ac.id)) hasUnclaimed = true;
            });

            const badge = document.getElementById('achievementBadge');
            if(hasUnclaimed) badge.classList.remove('hidden'); else badge.classList.add('hidden');
        },
        open() {
            const list = document.getElementById('achievementList');
            list.innerHTML = '';
            const collectionPct = Math.floor((State.owned.size / State.normalList.length) * 100);

            ACHIEVEMENTS.forEach(ac => {
                const el = document.createElement('div');
                let passed = false;
                if(ac.type === 'COMBO') passed = State.maxComboRecord >= ac.target;
                if(ac.type === 'COLLECT') passed = collectionPct >= ac.target;
                const claimed = State.claimedAchievements.has(ac.id);

                el.className = `achievement-item ${claimed ? 'claimed' : ''}`;

                let btnHtml = '';
                if(claimed) btnHtml = `<span class="text-sm font-bold text-gray-400">ì™„ë£Œ</span>`;
                else if(passed) btnHtml = `<button onclick="AchievementSystem.claim('${ac.id}')" class="bg-purple-600 hover:bg-purple-700 text-white text-xs px-3 py-1.5 rounded-lg font-bold shadow-sm animate-pulse">í™•ì •í‹°ì¼“ ë°›ê¸°</button>`;
                else btnHtml = `<span class="text-xs text-gray-400 bg-gray-100 px-2 py-1 rounded">${ac.type==='COMBO' ? `${State.maxComboRecord}/${ac.target}` : `${collectionPct}%/${ac.target}%`}</span>`;

                el.innerHTML = `
                    <div class="flex items-center">
                        <div class="text-2xl mr-3">${ac.type === 'COMBO' ? 'ğŸ”¥' : 'ğŸ“–'}</div>
                        <div>
                            <div class="font-bold text-gray-800 text-sm">${ac.title}</div>
                            <div class="text-xs text-gray-500">${ac.desc}</div>
                        </div>
                    </div>
                    <div>${btnHtml}</div>
                `;
                list.appendChild(el);
            });
            document.getElementById('achievementModal').style.display = 'flex';
        },
        claim(id) {
            const ac = ACHIEVEMENTS.find(a => a.id === id);
            if(!ac || State.claimedAchievements.has(id)) return;
            State.claimedAchievements.add(id);
            State.guaranteedTickets += ac.reward; // í™•ì • í‹°ì¼“ ì§€ê¸‰
            saveData();
            this.open();
            updateUI();
        }
    };

    // --- ìˆ˜í•™ ë¡œì§ ---
    const MathLogic = {
        rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; },
        makeOptions(answer, type, generatorFn) {
            let options = new Set([answer]);
            let safety = 0;
            while(options.size < 4 && safety < 50) { safety++; let wrong = generatorFn(); if(wrong !== answer) options.add(wrong); }
            while(options.size < 4) { if (typeof answer === 'number') options.add(answer + Math.floor(Math.random()*10) + 1); else options.add(answer + " "); }
            return Array.from(options).sort(() => Math.random() - 0.5);
        },
        generate(mode, diff) {
            if (mode === 'MUL') return this.mul(diff);
            if (mode === 'DIV') return this.div(diff);
            if (mode === 'FRAC') return this.frac(diff);
        },
        mul(diff) {
            let a, b;
            if (diff === 0) { a = this.rand(1, 9) * 100; b = this.rand(1, 9); }
            else if (diff === 1) { a = this.rand(1, 9) * 10; b = this.rand(1, 9) * 10; }
            else if (diff === 2) { a = this.rand(10, 99); b = this.rand(1, 9) * 10; }
            else if (diff === 3) { a = this.rand(10, 99); b = this.rand(10, 99); }
            else if (diff === 4) { a = this.rand(10, 99) * 10; b = this.rand(1, 9) * 10; }
            else if (diff === 5) { a = this.rand(10, 99) * 10; b = this.rand(10, 99); }
            else { a = this.rand(100, 999); b = this.rand(10, 99); }
            let ans = a * b;
            return { q: `${a} Ã— ${b} = ?`, choices: this.makeOptions(ans, 'NUM', () => ans + (Math.random()>0.5?1:-1)*(Math.random()>0.5?10:1)*this.rand(1,5)), ans };
        },
        div(diff) {
            let a, b, qStr, ansStr;
            if (diff === 0) { b = this.rand(2, 9); let q = this.rand(4, 11); a = b * q; while(a < 10) { q = this.rand(4, 11); a = b * q; } ansStr = `${q}`; qStr = `${a} Ã· ${b} = ?`; }
            else if (diff === 1) { b = this.rand(2, 9); a = this.rand(11, 99); while (a % b === 0) a++; let q = Math.floor(a / b); let r = a % b; ansStr = `${q} Â·Â·Â· ${r}`; qStr = `${a} Ã· ${b} = ?`; }
            else { b = this.rand(2, 9); let q = this.rand(12, 110); a = b * q + this.rand(0, b-1); q = Math.floor(a/b); let r = a%b; ansStr = r === 0 ? `${q}` : `${q} Â·Â·Â· ${r}`; qStr = `${a} Ã· ${b} = ?`; }
            const choices = this.makeOptions(ansStr, 'STR', () => { let q=parseInt(ansStr.split(' ')[0])+this.rand(-3,3); if(q<1)q=1; return `${q} Â·Â·Â· ${this.rand(1,b-1)}`; });
            return { q: qStr, choices, ans: ansStr };
        },
        frac(diff) {
            if (diff === 0) {
                let den = this.rand(2, 9); let whole = this.rand(1, 4); let num = this.rand(1, den - 1);
                return { q: `ê°€ë¶„ìˆ˜ [ ${whole*den+num}/${den} ]ë¥¼\nëŒ€ë¶„ìˆ˜ë¡œ ë°”ê¾¸ë©´?`, choices: this.makeOptions(`${whole}ê³¼ ${num}/${den}`, 'STR', ()=>`${whole+this.rand(-1,2)}ê³¼ ${this.rand(1,den-1)}/${den}`), ans: `${whole}ê³¼ ${num}/${den}` };
            } else if (diff === 1) {
                let den = this.rand(3, 15); let n1 = this.rand(1, den*2); let n2 = n1; while(n2===n1) n2=this.rand(1, den*2);
                return { q: `ë¹ˆì¹¸ì— ì•Œë§ì€ ê¸°í˜¸ëŠ”?\n${n1}/${den} â–¡ ${n2}/${den}`, choices: ['>', '<', '=', '?'].sort(()=>Math.random()-0.5), ans: n1>n2?'>':'<' };
            } else {
                let den = this.rand(3, 12); let n1 = this.rand(1, den-1); let n2 = this.rand(1, den-1); let sum = n1+n2;
                return { q: `${n1}/${den} + ${n2}/${den} = ?`, choices: this.makeOptions(`${sum}/${den}`, 'STR', ()=>`${sum+this.rand(-2,2)}/${den}`), ans: `${sum}/${den}` };
            }
        }
    };

    // --- í¼ì¦ ì‹œìŠ¤í…œ ---
    const PuzzleSystem = {
        start(mode) {
            State.puzzle.mode = mode; State.puzzle.score = 0; State.puzzle.combo = 0; State.puzzle.maxCombo = 0;
            State.puzzle.isPlaying = true; State.puzzle.difficulty = 0; State.puzzle.mathCount = 0;
            const title = document.getElementById('puzzleTitle');
            const info = document.getElementById('puzzleLevelTag');
            if (mode === 'MUL') { title.textContent = "âœ–ï¸ ê³±ì…ˆ íŠ¸ë ˆì´ë‹"; info.textContent = "ë‚œì´ë„: 1ë‹¨ê³„"; }
            else if (mode === 'DIV') { title.textContent = "â— ë‚˜ëˆ—ì…ˆ íŠ¸ë ˆì´ë‹"; info.textContent = "ë‚œì´ë„: í•˜"; }
            else { title.textContent = "Â½ ë¶„ìˆ˜ íŠ¸ë ˆì´ë‹"; info.textContent = "ë‚œì´ë„: í•˜"; }
            showView('puzzleModal'); this.nextLevel();
        },
        stop() {
            State.puzzle.isPlaying = false; clearInterval(State.puzzle.timer);
            showView('lobbyScreen');

            // ì½¤ë³´ ë ˆì–´ í‹°ì¼“ ë³´ìƒ ê³„ì‚° (ì‚¼ê°ìˆ˜ì—´: 10->1, 20->3, 30->6, 40->10...)
            const comboStep = Math.floor(State.puzzle.maxCombo / 10);
            const rareReward = (comboStep * (comboStep + 1)) / 2;

            if (State.puzzle.maxCombo > State.maxComboRecord) {
                State.maxComboRecord = State.puzzle.maxCombo;
            }

            let msg = `ìµœì¢… ì½¤ë³´: ${State.puzzle.maxCombo}\níšë“ í¬ì¸íŠ¸: ${State.puzzle.score} P`;
            if (rareReward > 0) {
                State.rareTickets += rareReward;
                msg += `\n\nğŸ‰ ì½¤ë³´ ë³´ë„ˆìŠ¤: ë ˆì–´ í‹°ì¼“ +${rareReward}ì¥!`;
            }

            showMessage("ê²Œì„ ì¢…ë£Œ", msg);

            if(State.puzzle.score > 0) { State.points += State.puzzle.score; }
            saveData();
        },
        nextLevel() {
            if(!State.puzzle.isPlaying) return;
            State.puzzle.mathCount++;
            if (State.puzzle.mode === 'MUL') {
                let levelIndex = Math.floor((State.puzzle.mathCount - 1) / 6);
                if (levelIndex > 6) levelIndex = 6;
                State.puzzle.difficulty = levelIndex;
                document.getElementById('puzzleLevelTag').textContent = `ë‚œì´ë„: ${levelIndex + 1}ë‹¨ê³„`;
            } else {
                if (State.puzzle.mathCount > 12) State.puzzle.difficulty = 2;
                else if (State.puzzle.mathCount > 6) State.puzzle.difficulty = 1;
                else State.puzzle.difficulty = 0;
                document.getElementById('puzzleLevelTag').textContent = `ë‚œì´ë„: ${['í•˜','ì¤‘','ìƒ'][State.puzzle.difficulty]}`;
            }
            const mathData = MathLogic.generate(State.puzzle.mode, State.puzzle.difficulty);
            this.renderUI({ text: mathData.q, choices: mathData.choices.map(c => ({ text: String(c), isCorrect: String(c) === String(mathData.ans) })) });
            this.startTimer();
        },
        startTimer() {
            clearInterval(State.puzzle.timer); State.puzzle.timeLeft = CONFIG.puzzleTime;
            const bar = document.getElementById('puzzleTimerBar');
            bar.style.transition = 'none'; bar.style.width = '100%'; void bar.offsetWidth;
            bar.style.transition = `width ${CONFIG.puzzleTime}s linear`; bar.style.width = '0%';
            State.puzzle.timer = setInterval(() => {
                State.puzzle.timeLeft -= 1;
                if(State.puzzle.timeLeft < 0) { clearInterval(State.puzzle.timer); this.handleWrong('ì‹œê°„ ì´ˆê³¼!'); }
            }, 1000);
        },
        renderUI(data) {
            document.getElementById('puzzleCombo').textContent = `${State.puzzle.combo} Combo`;
            document.getElementById('mathQuestionArea').innerHTML = data.text.replace(/\n/g, '<br>');
            const ac = document.getElementById('answerContainer'); ac.innerHTML = '';
            data.choices.forEach((item) => {
                const wrapper = document.createElement('div'); wrapper.className = 'puzzle-box';
                wrapper.style.aspectRatio = 'auto'; wrapper.style.padding = '20px'; wrapper.textContent = item.text;
                wrapper.onclick = () => this.checkAnswer(item, wrapper);
                ac.appendChild(wrapper);
            });
        },
        checkAnswer(item, el) {
            if(!State.puzzle.isPlaying) return; clearInterval(State.puzzle.timer);
            if(item.isCorrect) {
                el.classList.add('selected'); el.style.backgroundColor = '#d1fae5';
                State.puzzle.combo++;
                if(State.puzzle.combo > State.puzzle.maxCombo) State.puzzle.maxCombo = State.puzzle.combo;
                State.puzzle.score += (CONFIG.puzzleReward + (State.puzzle.combo * CONFIG.puzzleComboBonus));
                setTimeout(() => this.nextLevel(), 400);
            } else {
                el.classList.add('shake'); el.style.backgroundColor = '#fee2e2';
                setTimeout(() => this.handleWrong('í‹€ë ¸ìŠµë‹ˆë‹¤!'), 400);
            }
        },
        handleWrong(msg) { showMessage('ê²Œì„ ì˜¤ë²„', `${msg}\nìµœì¢… ì½¤ë³´: ${State.puzzle.maxCombo}`); this.stop(); }
    };

    // --- ìƒ‰ì¹  ê²Œì„ ---
    const GAME_CONST = { CELL_SCALE: 15 };
    let GameSession = { imgWidth: 0, imgHeight: 0, paletteMap: [null], numberGrid: [], completedGrid: [], totalCells: 0, completedCells: 0, selectedColorIdx: 0, quadrants: [], stageId: 0, zoomQuad: null };

    async function startGame(item) {
        GameSession.stageId = (item.type === 'H') ? -item.id : item.id;
        showView('gameScreen'); document.getElementById('gameTitle').textContent = item.type === 'H' ? `Hidden ${item.id}` : `No.${item.id}`;
        document.getElementById('loadingSpinner').style.display = 'block'; document.getElementById('quadGrid').style.opacity = '0';
        initQuadGrid();
        try {
            await processImage(item.url); restoreProgress(GameSession.stageId); updateGameProgressUI(); renderAllQuads(); renderPalette();
            document.getElementById('loadingSpinner').style.display = 'none'; document.getElementById('quadGrid').style.opacity = '1';
        } catch(e) { showMessage("ì˜¤ë¥˜", "ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨"); showView('bookScreen'); }
    }
    function initQuadGrid() {
        const grid = document.getElementById('quadGrid'); grid.innerHTML = ''; GameSession.quadrants = [];
        for(let i=0; i<4; i++) {
            const wrap = document.createElement('div'); const c = document.createElement('canvas');
            wrap.appendChild(c); grid.appendChild(wrap);
            const ctx = c.getContext('2d'); ctx.imageSmoothingEnabled = false;
            const q = { id:i, canvas:c, ctx:ctx, x:0, y:0, w:0, h:0 };
            c.onclick = () => openZoom(q); GameSession.quadrants.push(q);
        }
    }
    function processImage(url) {
        return new Promise((resolve, reject) => {
            const img = new Image(); img.crossOrigin = 'Anonymous'; img.src = url;
            img.onload = () => {
                const w = img.width; const h = img.height; GameSession.imgWidth = w; GameSession.imgHeight = h;
                const cvs = document.createElement('canvas'); cvs.width = w; cvs.height = h;
                const ctx = cvs.getContext('2d'); ctx.drawImage(img, 0, 0);
                const data = ctx.getImageData(0,0,w,h).data;
                GameSession.numberGrid = []; GameSession.completedGrid = []; GameSession.paletteMap = [null];
                let paletteDict = {}; let colorCount = 1; GameSession.totalCells = 0; GameSession.completedCells = 0;
                for(let y=0; y<h; y++) {
                    GameSession.numberGrid[y] = []; GameSession.completedGrid[y] = [];
                    for(let x=0; x<w; x++) {
                        const i = (y*w + x)*4;
                        if(data[i+3] < 128) { GameSession.numberGrid[y][x] = 0; GameSession.completedGrid[y][x] = true; }
                        else {
                            const rgba = `rgba(${data[i]},${data[i+1]},${data[i+2]},${(data[i+3]/255).toFixed(2)})`;
                            if(!paletteDict[rgba]) { paletteDict[rgba] = colorCount; GameSession.paletteMap[colorCount] = rgba; colorCount++; }
                            GameSession.numberGrid[y][x] = paletteDict[rgba]; GameSession.completedGrid[y][x] = false; GameSession.totalCells++;
                        }
                    }
                }
                const halfW = Math.floor(w/2); const halfH = Math.floor(h/2);
                const geoms = [{x:0, y:0, w:halfW, h:halfH},{x:halfW, y:0, w:w-halfW, h:halfH},{x:0, y:halfH, w:halfW, h:h-halfH},{x:halfW, y:halfH, w:w-halfW, h:h-halfH}];
                geoms.forEach((g, idx) => {
                    const q = GameSession.quadrants[idx]; q.x=g.x; q.y=g.y; q.w=g.w; q.h=g.h;
                    q.canvas.width = g.w * GAME_CONST.CELL_SCALE; q.canvas.height = g.h * GAME_CONST.CELL_SCALE;
                });
                resolve();
            };
            img.onerror = () => reject();
        });
    }
    function drawQuad(q) {
        const scale = GAME_CONST.CELL_SCALE; const ctx = q.ctx; ctx.clearRect(0, 0, q.canvas.width, q.canvas.height);
        for(let y=0; y<q.h; y++) {
            for(let x=0; x<q.w; x++) {
                const gy = q.y + y; const gx = q.x + x; const idx = GameSession.numberGrid[gy][gx];
                if(idx === 0) continue;
                if(GameSession.completedGrid[gy][gx]) { ctx.fillStyle = GameSession.paletteMap[idx]; ctx.fillRect(x*scale, y*scale, scale, scale); }
                else { ctx.fillStyle = '#fff'; ctx.fillRect(x*scale, y*scale, scale, scale); ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth = 1; ctx.strokeRect(x*scale, y*scale, scale, scale); if(scale > 8) { ctx.fillStyle = '#9ca3af'; ctx.font = 'bold 9px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(idx, x*scale+scale/2, y*scale+scale/2+1); } }
            }
        }
    }
    function renderAllQuads() { GameSession.quadrants.forEach(q => drawQuad(q)); }
    function renderPalette() {
        const con = document.getElementById('paletteContainer'); con.innerHTML = '';
        for(let i=1; i<GameSession.paletteMap.length; i++) {
            const btn = document.createElement('button'); btn.className = 'palette-button';
            btn.style.backgroundColor = GameSession.paletteMap[i]; btn.textContent = i;
            btn.onclick = () => selectPaletteColor(i); con.appendChild(btn);
        }
    }
    function selectPaletteColor(idx) {
        GameSession.selectedColorIdx = idx;
        [document.getElementById('paletteContainer'), document.getElementById('zoomPalette')].forEach(con => {
            if(!con) return; Array.from(con.children).forEach(b => { if(parseInt(b.textContent) === idx) b.classList.add('selected'); else b.classList.remove('selected'); });
        });
    }
    function openZoom(q) {
        GameSession.zoomQuad = q; document.getElementById('zoomOverlay').style.display = 'flex';
        const zCvs = document.getElementById('zoomCanvas'); const zScale = GAME_CONST.CELL_SCALE * 2;
        zCvs.width = q.w * zScale; zCvs.height = q.h * zScale;
        drawZoomCanvas(zCvs, q, zScale);
        const zp = document.getElementById('zoomPalette'); zp.innerHTML = document.getElementById('paletteContainer').innerHTML;
        Array.from(zp.children).forEach((btn, i) => btn.onclick = () => selectPaletteColor(i+1));
        if(GameSession.selectedColorIdx) selectPaletteColor(GameSession.selectedColorIdx);
        zCvs.onclick = (e) => handleZoomClick(e, q, zScale);
    }
    function drawZoomCanvas(cvs, q, scale) {
        const ctx = cvs.getContext('2d'); ctx.imageSmoothingEnabled = false; ctx.clearRect(0,0,cvs.width,cvs.height);
        for(let y=0; y<q.h; y++) {
            for(let x=0; x<q.w; x++) {
                const gy = q.y + y; const gx = q.x + x; const idx = GameSession.numberGrid[gy][gx];
                if(idx === 0) continue;
                if(GameSession.completedGrid[gy][gx]) { ctx.fillStyle = GameSession.paletteMap[idx]; ctx.fillRect(x*scale, y*scale, scale, scale); }
                else { ctx.fillStyle = '#fff'; ctx.fillRect(x*scale, y*scale, scale, scale); ctx.strokeStyle = '#d1d5db'; ctx.strokeRect(x*scale, y*scale, scale, scale); ctx.fillStyle = '#6b7280'; ctx.font = 'bold 16px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(idx, x*scale+scale/2, y*scale+scale/2+1); }
            }
        }
    }
    function handleZoomClick(e, q, scale) {
        if(!GameSession.selectedColorIdx) return;
        const rect = e.target.getBoundingClientRect();
        const x = Math.floor(((e.clientX - rect.left) * (e.target.width/rect.width)) / scale);
        const y = Math.floor(((e.clientY - rect.top) * (e.target.height/rect.height)) / scale);
        const gx = q.x + x; const gy = q.y + y;
        if(gx >= 0 && gx < GameSession.imgWidth && gy >= 0 && gy < GameSession.imgHeight) {
            if(GameSession.completedGrid[gy][gx]) return;
            if(GameSession.numberGrid[gy][gx] === GameSession.selectedColorIdx) {
                GameSession.completedGrid[gy][gx] = true; GameSession.completedCells++;
                drawZoomCanvas(e.target, q, scale); drawQuad(q); saveProgress(); updateGameProgressUI(); checkCompletion();
            } else if (GameSession.numberGrid[gy][gx] !== 0) {
                e.target.classList.add('shake'); setTimeout(()=>e.target.classList.remove('shake'),300);
            }
        }
    }
    function saveProgress() { localStorage.setItem(LS_KEY.progress + GameSession.stageId, JSON.stringify(GameSession.completedGrid)); }
    function restoreProgress(stageId) {
        const saved = localStorage.getItem(LS_KEY.progress + stageId);
        if(saved) {
            try { const grid = JSON.parse(saved); if(grid.length===GameSession.imgHeight && grid[0].length===GameSession.imgWidth) { GameSession.completedGrid = grid; let done=0; for(let y=0;y<GameSession.imgHeight;y++) for(let x=0;x<GameSession.imgWidth;x++) if(GameSession.numberGrid[y][x]!==0 && GameSession.completedGrid[y][x]) done++; GameSession.completedCells=done; } } catch(e){}
        }
    }
    function updateGameProgressUI() {
        const pct = Math.floor((GameSession.completedCells / GameSession.totalCells) * 100) || 0;
        document.getElementById('gameProgress').textContent = `${pct}%`;
    }

    function checkCompletion() {
        if(GameSession.completedCells >= GameSession.totalCells) {
            if(!State.colored.has(GameSession.stageId)) {
                State.colored.add(GameSession.stageId);
                State.points += 500;
                showMessage("ì‘í’ˆ ì™„ì„±!", "500Pë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.\n(í™•ì • í‹°ì¼“ì€ 'ì—…ì ' ë©”ë‰´ì—ì„œ íšë“ ê°€ëŠ¥)");
                saveData();
            }
        }
    }

    // --- ê°€ì±  ì‹œìŠ¤í…œ ---
    function renderBook() { const grid = document.getElementById('bookGrid'); grid.innerHTML=''; State.normalList.forEach(item => grid.appendChild(createCard(item, State.owned.has(item.id), State.colored.has(item.id), getRarity(item.id)))); State.hiddenList.forEach(item => { if(State.hiddenOwned.has(item.id)) grid.appendChild(createCard(item, true, State.colored.has(-item.id), 'H')); }); }
    function createCard(item, isOwned, isColored, rarity) { const div = document.createElement('div'); div.className = `card ${isColored ? 'colored rarity-'+rarity : ''}`; const img = document.createElement('img'); img.src = item.url; if(!isOwned) img.className = 'locked'; const label = document.createElement('div'); label.className = 'absolute bottom-0 w-full bg-white/90 text-center text-[10px] py-1 font-bold text-gray-600 truncate'; label.textContent = item.type==='H' ? `H-${item.id}` : `No.${item.id}`; div.appendChild(img); div.appendChild(label); if(isOwned) div.onclick = () => startGame(item); return div; }

    // ì¼ë°˜ ê°€ì± 
    function doGacha(count) {
        const cost = count * CONFIG.gachaCost;
        if(State.points < cost) { showMessage('í¬ì¸íŠ¸ ë¶€ì¡±', `${cost}Pê°€ í•„ìš”í•©ë‹ˆë‹¤.`); return; }
        State.points -= cost;
        runGachaAlgorithm(count, false);
    }

    // ë ˆì–´ ê°€ì±  (R ì´ìƒë§Œ ë“±ì¥)
    function doRareGacha() {
        if(State.rareTickets < 1) { showMessage('í‹°ì¼“ ë¶€ì¡±', 'ë ˆì–´ í‹°ì¼“ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\nìˆ˜í•™ ë¬¸ì œë¥¼ í’€ì–´ ì½¤ë³´ë¥¼ ë‹¬ì„±í•˜ì„¸ìš”!'); return; }
        State.rareTickets -= 1;
        runGachaAlgorithm(1, true);
    }

    // [NEW] í™•ì • ê°€ì±  (ë¯¸ë³´ìœ  ìºë¦­í„° í™•ì •)
    function doGuaranteedGacha() {
        if(State.guaranteedTickets < 1) { showMessage('í‹°ì¼“ ë¶€ì¡±', 'í™•ì • í‹°ì¼“ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.\nì—…ì  ë³´ìƒìœ¼ë¡œ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!'); return; }
        State.guaranteedTickets -= 1;

        // ë¯¸ë³´ìœ  ëª©ë¡ í•„í„°ë§
        const unowned = State.normalList.filter(p => !State.owned.has(p.id));

        let pick;
        if(unowned.length === 0) {
            // ì´ë¯¸ ë‹¤ ëª¨ì•˜ìœ¼ë©´? -> í™˜ê¸‰ + ë ˆì–´í‹°ì¼“ìœ¼ë¡œ ëŒ€ì²´
            showMessage("ì•Œë¦¼", "ëª¨ë“  í”½ì…€ì„ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤!\në ˆì–´ í‹°ì¼“ 3ì¥ìœ¼ë¡œ ëŒ€ì²´ë©ë‹ˆë‹¤.");
            State.rareTickets += 3;
            saveData();
            return;
        } else {
            // ë¯¸ë³´ìœ  ì¤‘ ëœë¤ í•˜ë‚˜ ì„ íƒ
            pick = unowned[Math.floor(Math.random() * unowned.length)];
        }

        State.owned.add(pick.id);
        const rarity = getRarity(pick.id);

        saveData();

        // ê²°ê³¼ì°½ í‘œì‹œ
        const grid = document.getElementById('gachaGrid');
        grid.innerHTML = '';
        document.getElementById('gachaTitle').textContent = "ğŸ’ ë¯¸ë³´ìœ  í™•ì • íšë“ ğŸ’";
        const d = document.createElement('div');
        d.className = `card rarity-${rarity} relative animate-pulse border-2`;
        d.innerHTML = `
            <div class="rarity-tag">${rarity}</div>
            <img class="w-full h-full object-contain" src="${pick.url}" alt="No.${pick.id}" />
            <div class="text-center text-[11px] mt-1">No.${pick.id}</div>
            <span class="absolute top-0 right-0 bg-red-500 text-white text-[9px] px-1">NEW</span>
        `;
        grid.appendChild(d);
        document.getElementById('gachaSummary').textContent = "ìƒˆë¡œìš´ í”½ì…€ì„ íšë“í–ˆìŠµë‹ˆë‹¤!";
        document.getElementById('gachaModal').style.display = 'flex';
    }

    function runGachaAlgorithm(count, isRare) {
        const results = [];
        let refund = 0;

        const pools = { C: [], R: [], SR: [], H: [] };
        State.normalList.forEach(p => {
            const r = getRarity(p.id);
            if (isRare && r === 'C') return;
            (pools[r] ?? pools.C).push(p);
        });

        const rates = isRare ? RARE_GACHA_RATES : GACHA_RATES;

        for (let i = 0; i < count; i++) {
            const rarity = rollRarityWithFallback(pools, rates);
            const pool = pools[rarity];
            const pick = pool[Math.floor(Math.random() * pool.length)];

            let isNew = false;
            if (State.owned.has(pick.id)) refund += (DUP_REFUND[rarity] ?? 50);
            else { State.owned.add(pick.id); isNew = true; }

            results.push({ ...pick, isNew, rarity });
        }

        if (refund > 0) State.points += refund;
        saveData();

        const grid = document.getElementById('gachaGrid');
        grid.innerHTML = '';
        document.getElementById('gachaTitle').textContent = isRare ? "âœ¨ ë ˆì–´ ê°€ì±  ê²°ê³¼ âœ¨" : "íšë“ ê²°ê³¼";
        results.forEach(r => {
            const d = document.createElement('div');
            d.className = `card rarity-${r.rarity} relative animate-pulse border-2`;
            d.innerHTML = `
                <div class="rarity-tag">${r.rarity}</div>
                <img class="w-full h-full object-contain" src="${r.url}" alt="No.${r.id}" />
                <div class="text-center text-[11px] mt-1">No.${r.id}</div>
                ${r.isNew ? '<span class="absolute top-0 right-0 bg-red-500 text-white text-[9px] px-1">NEW</span>' : ''}
            `;
            grid.appendChild(d);
        });
        document.getElementById('gachaSummary').textContent = `í™˜ê¸‰: ${refund}P`;
        document.getElementById('gachaModal').style.display = 'flex';
    }

    function rollRarityWithFallback(pools, rates) {
        const order = ['H', 'SR', 'R', 'C'];
        let r = Math.random();
        let cum = 0;
        let chosen = 'C';
        for (const k of order) {
            cum += (rates[k] ?? 0);
            if (r < cum) { chosen = k; break; }
        }
        const startIdx = order.indexOf(chosen);
        for (let i = startIdx; i < order.length; i++) {
            const k = order[i];
            if (pools[k] && pools[k].length) return k;
        }
        for (let i = order.length - 1; i >= 0; i--) {
            const k = order[i];
            if (pools[k] && pools[k].length) return k;
        }
        return 'C';
    }

    function bindEvents() {
        document.getElementById('startButton').onclick = () => showView('lobbyScreen');
        document.getElementById('goBookBtn').onclick = () => showView('bookScreen');
        document.getElementById('goMulBtn').onclick = () => PuzzleSystem.start('MUL');
        document.getElementById('goDivBtn').onclick = () => PuzzleSystem.start('DIV');
        document.getElementById('goFracBtn').onclick = () => PuzzleSystem.start('FRAC');

        document.getElementById('gacha1Btn').onclick = () => doGacha(1);
        document.getElementById('gacha10Btn').onclick = () => doGacha(10);
        document.getElementById('rareGachaBtn').onclick = () => doRareGacha();
        document.getElementById('guaranteedGachaBtn').onclick = () => doGuaranteedGacha();

        document.getElementById('quickGachaBtn').onclick = () => doGacha(10);
        document.getElementById('backToLobbyFromBook').onclick = () => showView('lobbyScreen');
        document.getElementById('exitGameBtn').onclick = () => { showView('bookScreen'); renderBook(); };
        document.getElementById('exitPuzzleBtn').onclick = () => PuzzleSystem.stop();
        document.getElementById('msgOkBtn').onclick = () => document.getElementById('msgModal').style.display = 'none';
        document.getElementById('gachaCloseBtn').onclick = () => document.getElementById('gachaModal').style.display = 'none';
        document.getElementById('zoomCloseBtn').onclick = () => document.getElementById('zoomOverlay').style.display = 'none';

        document.getElementById('achievementBtn').onclick = () => AchievementSystem.open();
        document.getElementById('closeAchievementBtn').onclick = () => document.getElementById('achievementModal').style.display = 'none';
    }

    window.onload = initGame;
</script>
</body>
</html>