<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>í¬ì¼“ëª¬ ë§ì¶¤ë²• íƒí—˜ëŒ€</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        /* í°íŠ¸: ê·€ì—¬ìš´ 'Jua' í°íŠ¸ ì‚¬ìš© */
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        /* --- ê¸°ë³¸ ì„¤ì • ë° ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ --- */
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¸°ê¸° (ëª¨ë“  ë¸Œë¼ìš°ì €) */
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        body {
            margin: 0;
            font-family: 'Jua', sans-serif;
            background: linear-gradient(180deg, #bae6fd 0%, #e0f2fe 100%); /* í™”ì‚¬í•œ í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
            color: #334155;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.4); /* ë°˜íˆ¬ëª… í°ìƒ‰ */
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- ê³µí†µ ìœ í‹¸ --- */
        .hidden { display: none !important; }
        .view {
            flex: 1;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
            position: absolute;
            top: 0; left: 0;
            transition: opacity 0.3s;
        }

        /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ (ì…ì²´ê°) */
        .btn-3d {
            border: none;
            border-radius: 20px;
            font-family: 'Jua', sans-serif;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.15); /* ê·¸ë¦¼ì */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: white;
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.15);
        }

        /* --- 1. ë¡œë¹„ í™”ë©´ --- */
        #view-lobby {
            justify-content: center;
            gap: 25px;
        }
        .lobby-title {
            font-size: 42px;
            color: #0284c7; /* ì§„í•œ íŒŒë‘ */
            text-shadow: 3px 3px 0 #fff;
            margin-bottom: 10px;
            text-align: center;
            line-height: 1.2;
        }
        .lobby-stats {
            background: #fff;
            padding: 10px 25px;
            border-radius: 30px;
            font-size: 20px;
            color: #f59e0b;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid #fef3c7;
        }

        .menu-btn { width: 100%; max-width: 280px; height: 75px; font-size: 26px; gap: 12px; }
        .btn-explore { background: #4ade80; color: #064e3b; } /* ë°ì€ ì´ˆë¡ */
        .btn-shop { background: #60a5fa; color: #1e3a8a; } /* ë°ì€ íŒŒë‘ */
        .btn-dex { background: #fbbf24; color: #78350f; } /* ë°ì€ ë…¸ë‘ */

        /* --- 2. ê²Œì„(íƒí—˜) í™”ë©´ --- */
        #view-game { padding: 15px; padding-bottom: 30px; background: #ecfccb; /* ì—°ë‘ìƒ‰ ë°°ê²½ */ }

        .game-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: #fff;
            padding: 12px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .stat-badge { font-size: 18px; font-weight: bold; color: #57534e; }
        .stat-badge span { font-size: 24px; margin-left: 5px; }

        /* ê·¸ë¦¬ë“œ (ë§µ) */
        .grid-container {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1/1;
            position: relative;
            background: #86efac; /* í’€ìƒ‰ */
            border-radius: 20px;
            overflow: hidden;
            border: 4px solid #fff;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: 100%; height: 100%;
        }
        .tile {
            position: relative;
            background-size: cover;
        }
        /* íƒ€ì¼ êµ¬ë¶„ì„  ì‚´ì§ */
        .tile::before {
            content:''; position: absolute; inset:0;
            border: 0.5px solid rgba(255,255,255,0.2);
        }

        /* ì‹¤ë£¨ì—£ íš¨ê³¼ */
        .tile.silhouette::after {
            content: ""; position: absolute;
            width: 200%; height: 200%;
            top: -50%; left: -50%;
            background-size: contain; background-position: center; background-repeat: no-repeat;
            filter: brightness(0) invert(1) drop-shadow(0 0 5px rgba(255,255,255,0.8));
            opacity: 0.9;
            animation: bounce 1.5s infinite;
            z-index: 5;
        }
        @keyframes bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }

        #player {
            position: absolute; top:0; left:0;
            width: calc(100%/9); height: calc(100%/9);
            z-index: 10;
            transition: transform 0.2s linear;
        }
        .player-img {
            width: 100%; height: 100%;
            background: url('./png/character.png') no-repeat;
            background-size: 1200% 100%;
            image-rendering: pixelated;
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.2)); /* ìºë¦­í„° ê·¸ë¦¼ì */
        }

        /* ì»¨íŠ¸ë¡¤ëŸ¬ */
        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            gap: 8px;
            margin-top: auto;
        }
        .d-btn {
            width: 70px; height: 65px;
            background: #fff;
            border: 2px solid #cbd5e1;
            border-radius: 15px;
            color: #64748b; font-size: 30px;
            box-shadow: 0 4px 0 #cbd5e1;
            cursor: pointer;
        }
        .d-btn:active { transform: translateY(4px); box-shadow: none; background: #f1f5f9; }
        .d-btn.up { grid-column: 2; }
        .d-btn.left { grid-column: 1; grid-row: 2; }
        .d-btn.down { grid-column: 2; grid-row: 2; }
        .d-btn.right { grid-column: 3; grid-row: 2; }

        /* --- 3. ê²°ê³¼ í™”ë©´ --- */
        #view-result { text-align: center; justify-content: center; background: rgba(255,255,255,0.9); }
        .result-card {
            background: #fff;
            border-radius: 30px;
            padding: 30px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 4px solid #bae6fd;
        }
        .result-list {
            display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;
            margin: 20px 0;
            max-height: 200px; overflow-y: auto;
            background: #f8fafc; padding: 10px; border-radius: 15px;
        }
        .result-poke img { width: 60px; height: 60px; background: #fff; border-radius: 50%; border: 2px solid #e2e8f0; }

        /* --- 4. ìƒì  í™”ë©´ --- */
        #view-shop { background: #fdf4ff; /* ì—°í•œ í•‘í¬ ë°°ê²½ */ }
        .shop-header { display: flex; align-items: center; width: 100%; margin-bottom: 20px; }
        .shop-section { width: 100%; margin-bottom: 25px; }
        .shop-section h3 {
            color: #db2777; font-size: 20px; margin-bottom: 10px;
            background: #fff; display: inline-block; padding: 5px 15px; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .shop-item {
            background: #fff; padding: 15px; border-radius: 20px;
            text-align: center; border: 2px solid #fce7f3;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 4px 0 #fbcfe8;
        }
        .shop-price { color: #f59e0b; font-weight: bold; font-size: 18px; margin: 8px 0; }
        .buy-btn {
            background: #3b82f6; color: white; border: none; padding: 10px;
            border-radius: 12px; cursor: pointer; font-family: inherit; font-size: 16px;
            box-shadow: 0 3px 0 #2563eb;
        }
        .buy-btn:active { transform: translateY(3px); box-shadow: none; }

        /* --- 5. ë„ê° í™”ë©´ --- */
        #view-dex { background: #fffbeb; /* ì—°í•œ ë…¸ë‘ */ }

        /* ëª¨ë‹¬ (íŒì—…) */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px);
            z-index: 50; display: flex; justify-content: center; align-items: center;
        }
        .modal-box {
            background: #fff; width: 90%; max-width: 340px;
            border-radius: 25px; padding: 25px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: 4px solid #bae6fd;
        }
        .poke-img-lg { width: 140px; height: 140px; image-rendering: pixelated; margin: 0 auto; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }

        .ball-select { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .ball-opt {
            background: #f8fafc; border: 2px solid #cbd5e1; color: #334155;
            padding: 12px; border-radius: 15px; font-size: 15px; font-family: inherit; cursor: pointer;
        }
        .ball-opt:active { background: #e2e8f0; }
        .ball-opt:disabled { opacity: 0.5; cursor: not-allowed; }

        .back-btn {
            background: #fff; border: 2px solid #cbd5e1;
            font-size: 24px; cursor: pointer; border-radius: 50%;
            width: 45px; height: 45px; margin-right: 15px;
            box-shadow: 0 3px 0 #cbd5e1;
        }
        .back-btn:active { transform: translateY(3px); box-shadow: none; }

        /* í€´ì¦ˆ ë²„íŠ¼ */
        .quiz-btn {
            padding: 15px; background: #fff; border: 2px solid #cbd5e1;
            color: #334155; border-radius: 15px; font-size: 20px;
            font-family: inherit; cursor: pointer; width: 100%;
            box-shadow: 0 4px 0 #cbd5e1; transition: 0.1s;
        }
        .quiz-btn:active { transform: translateY(4px); box-shadow: none; background: #f1f5f9; }

    </style>
</head>
<body>

<div class="app-container">

    <div id="view-lobby" class="view">
        <h1 class="lobby-title">PokÃ©mon<br>ë§ì¶¤ë²• íƒí—˜ëŒ€</h1>

        <div class="lobby-stats">
            ë³´ìœ  í¬ì¸íŠ¸ ğŸ’° <span id="lobby-points">0</span>
        </div>

        <button class="btn-3d menu-btn btn-explore" onclick="startExploration()">
            ğŸ§­ íƒí—˜ ë– ë‚˜ê¸°
        </button>
        <button class="btn-3d menu-btn btn-shop" onclick="switchView('view-shop')">
            ğŸ›’ ìƒì  ê°€ê¸°
        </button>
        <button class="btn-3d menu-btn btn-dex" onclick="switchView('view-dex')">
            ğŸ“– í¬ì¼“ëª¬ ë„ê°
        </button>
    </div>

    <div id="view-game" class="view hidden">
        <div class="game-header">
            <div class="stat-badge">ë‚¨ì€ ê±¸ìŒ ğŸ‘£ <span id="game-steps" style="color:#ef4444">30</span></div>
            <div class="stat-badge">ë³¼ ê°œìˆ˜ ğŸ”´ <span id="game-balls" style="color:#3b82f6">10</span></div>
        </div>

        <div class="grid-container">
            <div id="grid" class="grid"></div>
            <div id="player"><div class="player-img" id="playerSprite"></div></div>
        </div>

        <div style="text-align:center; color:#57534e; font-size:16px; margin-bottom:10px; background:#fff; padding:5px 15px; border-radius:15px;">
            ë°©í–¥í‚¤ë¥¼ ëˆŒëŸ¬ì„œ í¬ì¼“ëª¬ì„ ì°¾ì•„ë³´ì„¸ìš”!
        </div>

        <div class="d-pad">
            <button class="d-btn up" onclick="move('up')">â–²</button>
            <button class="d-btn left" onclick="move('left')">â—€</button>
            <button class="d-btn down" onclick="move('down')">â–¼</button>
            <button class="d-btn right" onclick="move('right')">â–¶</button>
        </div>
    </div>

    <div id="view-result" class="view hidden">
        <div class="result-card">
            <h2 style="margin:0; font-size:32px; color:#334155;">íƒí—˜ ë!</h2>
            <p style="color:#64748b; font-size:18px; margin-top:5px;" id="end-reason">ë°œê±¸ìŒì„ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”</p>

            <div style="background:#fef3c7; padding:15px; border-radius:20px; margin:20px 0; border:2px solid #fcd34d;">
                <div style="font-size:16px; color:#92400e;">íšë“í•œ í¬ì¸íŠ¸</div>
                <div style="font-size:40px; color:#d97706; font-weight:bold;">+<span id="result-points">0</span></div>
            </div>

            <p style="text-align:left; margin-bottom:5px; font-weight:bold; color:#475569;">ì´ë²ˆì— ì¡ì€ í¬ì¼“ëª¬:</p>
            <div class="result-list" id="result-list">
            </div>

            <button class="btn-3d btn-explore" style="width:100%; height:60px; margin-top:10px;" onclick="switchView('view-lobby')">
                ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°
            </button>
        </div>
    </div>

    <div id="view-shop" class="view hidden">
        <div class="shop-header">
            <button class="back-btn" onclick="switchView('view-lobby')">ğŸ”™</button>
            <h2 style="margin:0; font-size:24px; color:#86198f;">ìƒì </h2>
        </div>
        <div style="width:100%; text-align:right; margin-bottom:10px; font-size:18px;">
            ë‚´ ì§€ê°‘: <span class="highlight" id="shop-points" style="font-weight:bold; color:#d97706;">0</span> P
        </div>

        <div class="shop-section">
            <h3>ğŸ”´ ëª¬ìŠ¤í„°ë³¼ êµ¬ë§¤</h3>
            <div class="shop-grid">
                <div class="shop-item">
                    <div>ëª¬ìŠ¤í„°ë³¼</div><div class="shop-price">50 P</div>
                    <button class="buy-btn" onclick="buyItem('ball', 'monster', 50)">êµ¬ë§¤í•˜ê¸°</button>
                </div>
                <div class="shop-item">
                    <div>ìŠˆí¼ë³¼</div><div class="shop-price">100 P</div>
                    <button class="buy-btn" onclick="buyItem('ball', 'super', 100)">êµ¬ë§¤í•˜ê¸°</button>
                </div>
                <div class="shop-item">
                    <div>í•˜ì´í¼ë³¼</div><div class="shop-price">150 P</div>
                    <button class="buy-btn" onclick="buyItem('ball', 'hyper', 150)">êµ¬ë§¤í•˜ê¸°</button>
                </div>
                <div class="shop-item">
                    <div>ë§ˆìŠ¤í„°ë³¼</div><div class="shop-price">300 P</div>
                    <button class="buy-btn" onclick="buyItem('ball', 'master', 300)">êµ¬ë§¤í•˜ê¸°</button>
                </div>
            </div>
        </div>

        <div class="shop-section">
            <h3>âš¡ ëŠ¥ë ¥ ê°•í™”í•˜ê¸°</h3>
            <div class="shop-grid">
                <div class="shop-item">
                    <div>ğŸ‘Ÿ íŠ¼íŠ¼í•œ ì‹ ë°œ<br><span style="font-size:12px; color:#94a3b8;" id="lv-steps">Lv.0</span></div>
                    <div class="shop-price">500 P</div>
                    <div style="font-size:13px; color:#64748b; margin-bottom:4px;">ë°œê±¸ìŒ +10</div>
                    <button class="buy-btn" onclick="buyUpgrade('maxSteps', 500)">ê°•í™”í•˜ê¸°</button>
                </div>
                <div class="shop-item">
                    <div>ğŸ’ ë„‰ë„‰í•œ ê°€ë°©<br><span style="font-size:12px; color:#94a3b8;" id="lv-balls">Lv.0</span></div>
                    <div class="shop-price">500 P</div>
                    <div style="font-size:13px; color:#64748b; margin-bottom:4px;">ì‹œì‘ ë³¼ +2</div>
                    <button class="buy-btn" onclick="buyUpgrade('startBalls', 500)">ê°•í™”í•˜ê¸°</button>
                </div>
                <div class="shop-item">
                    <div>ğŸ€ í–‰ìš´ì˜ ë¶€ì <br><span style="font-size:12px; color:#94a3b8;" id="lv-rate">Lv.0</span></div>
                    <div class="shop-price">800 P</div>
                    <div style="font-size:13px; color:#64748b; margin-bottom:4px;">í¬íšë¥  +10%</div>
                    <button class="buy-btn" onclick="buyUpgrade('catchRate', 800)">ê°•í™”í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-dex" class="view hidden">
        <div class="shop-header">
            <button class="back-btn" onclick="switchView('view-lobby')">ğŸ”™</button>
            <h2 style="margin:0; font-size:24px; color:#92400e;">í¬ì¼“ëª¬ ë„ê°</h2>
        </div>
        <p style="font-size:18px; margin-bottom:15px;">
            ëª¨ì€ í¬ì¼“ëª¬: <span id="dex-count" style="font-weight:bold; color:#d97706;">0</span> / 151
        </p>
        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; width:100%; padding-bottom:50px;" id="dex-grid"></div>
    </div>

</div>

<div id="modal-layer" class="modal-overlay hidden">

    <div id="modal-encounter" class="modal-box hidden">
        <h3 style="color:#ef4444; font-size:24px; margin:0 0 10px 0;">ì•¼ìƒì˜ í¬ì¼“ëª¬!</h3>
        <img id="enc-img" src="" class="poke-img-lg" />
        <h2 id="enc-name" style="font-size:28px; margin:10px 0;">???</h2>
        <p style="font-size:16px; color:#f59e0b; font-weight:bold; margin:0;">ì„±ê³µ í™•ë¥ : <span id="enc-rate"></span>%</p>

        <div class="ball-select">
            <button class="ball-opt" id="btn-use-monster" onclick="tryCatch('monster')">
                ğŸ”´ ëª¬ìŠ¤í„°ë³¼<br>x<span id="qty-monster">0</span>
            </button>
            <button class="ball-opt" id="btn-use-super" onclick="tryCatch('super')">
                ğŸ”µ ìŠˆí¼ë³¼<br>x<span id="qty-super">0</span>
            </button>
            <button class="ball-opt" id="btn-use-hyper" onclick="tryCatch('hyper')">
                ğŸŸ¡ í•˜ì´í¼ë³¼<br>x<span id="qty-hyper">0</span>
            </button>
            <button class="ball-opt" id="btn-use-master" onclick="tryCatch('master')">
                ğŸŸ£ ë§ˆìŠ¤í„°ë³¼<br>x<span id="qty-master">0</span>
            </button>
        </div>
        <button style="margin-top:20px; background:#94a3b8; padding:12px; border:none; color:white; border-radius:15px; width:100%; font-size:18px; font-family:inherit; cursor:pointer;" onclick="runAway()">
            ğŸƒ ë„ë§ê°€ê¸°
        </button>
    </div>

    <div id="modal-quiz" class="modal-box hidden">
        <h3 style="color:#0ea5e9; font-size:24px; margin-top:0;">ë§ì¶¤ë²• í€´ì¦ˆ</h3>
        <p id="quiz-txt" style="font-size:22px; margin:20px 0; font-weight:bold; color:#334155; word-break: keep-all;"></p>
        <div id="quiz-opts" style="display:flex; flex-direction:column; gap:12px;"></div>
    </div>

    <div id="modal-msg" class="modal-box hidden">
        <h2 id="msg-title" style="font-size:32px; margin:10px 0;">ê²°ê³¼</h2>
        <img id="msg-img" src="" style="width:100px; height:100px; image-rendering:pixelated;" />
        <p id="msg-desc" style="font-size:18px; color:#475569; margin:15px 0; line-height:1.4;"></p>
        <button onclick="closeMsgModal()" style="background:#4ade80; padding:15px; width:100%; border:none; color:#064e3b; border-radius:15px; font-weight:bold; font-size:20px; cursor:pointer;">í™•ì¸</button>
    </div>
</div>

<script>
    // --- ë°ì´í„° ë° ìƒíƒœ ---
    const TILE_IMGS = ["./png/Tile0.png", "./png/Tile1.png", "./png/Tile2.png", "./png/Tile3.png"];
    const QUIZ_URL = "./quiz/quiz.json"; // ìš”ì²­í•˜ì‹  ê²½ë¡œ

    // ì˜êµ¬ ë°ì´í„°
    let user = {
        points: 0,
        inventory: { monster: 0, super: 0, hyper: 0, master: 0 },
        dex: new Set(),
        upgrades: { maxSteps: 0, startBalls: 0, catchRate: 0 }
    };

    // ì„¸ì…˜ ë°ì´í„°
    let session = {
        active: false,
        steps: 0,
        caught: [],
        earnedPoints: 0
    };

    // ê²Œì„ ëŸ°íƒ€ì„ ë³€ìˆ˜
    let player = { x: 4, y: 4 };
    let tileMap = [];
    let currentPokemon = null;
    let silhouettePos = { x: -1, y: -1 };
    let isMoving = false;
    let quizList = [];
    let selectedBall = null;
    let currentQuiz = null;

    // --- ì´ˆê¸°í™” ---
    async function init() {
        await loadQuiz();
        updateLobbyUI();
    }

    // í€´ì¦ˆ íŒŒì¼ ë¡œë“œ ë° ëœë¤ ì…”í”Œ
    async function loadQuiz() {
        try {
            const res = await fetch(QUIZ_URL);
            const data = await res.json();
            let qArr = data.questions || [];

            // Fisher-Yates Shuffle (ëœë¤ ì„ê¸°)
            for (let i = qArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [qArr[i], qArr[j]] = [qArr[j], qArr[i]];
            }

            quizList = qArr;
            console.log("í€´ì¦ˆ ë¡œë“œ ì™„ë£Œ:", quizList.length, "ê°œ");
        } catch(e) {
            console.error("í€´ì¦ˆ ë¡œë“œ ì‹¤íŒ¨", e);
            // ë”ë¯¸ ë°ì´í„°
            quizList = [{prompt:"'ë‚˜ë¬´'ì˜ ì˜¬ë°”ë¥¸ í‘œê¸°ëŠ”?", choices:["ë‚˜ë¬´","ë‚˜ëª¨"], answerIndex:0}];
        }
    }

    // --- ë·° ê´€ë¦¬ ---
    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');

        if(viewId === 'view-shop') updateShopUI();
        if(viewId === 'view-dex') renderDex();
        if(viewId === 'view-lobby') updateLobbyUI();
    }

    function updateLobbyUI() {
        document.getElementById('lobby-points').textContent = user.points;
    }

    // --- íƒí—˜ ì‹œì‘ ---
    function startExploration() {
        const baseSteps = 30 + (user.upgrades.maxSteps * 10);
        const bonusBalls = 10 + (user.upgrades.startBalls * 2);

        session = {
            active: true,
            steps: baseSteps,
            caught: [],
            earnedPoints: 0
        };

        // ì´ë²ˆ íƒí—˜ìš© ë¬´ë£Œ ë³¼ ì§€ê¸‰
        user.inventory.monster += bonusBalls;

        generateMap();
        player = { x: 4, y: 4 };
        updatePlayerPos();
        updateGameHeader();
        switchView('view-game');

        // ì‹¤ë£¨ì—£ ì´ˆê¸°í™” í›„ ìŠ¤í°
        removeSilhouette();
        spawnPokemon();
    }

    function endExploration(reason) {
        session.active = false;

        const reasonText = reason === 'steps' ? "ë°œê±¸ìŒì„ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”!" : "í¬ì¼“ë³¼ì´ ë‹¤ ë–¨ì–´ì¡Œì–´ìš”!";
        document.getElementById('end-reason').textContent = reasonText;
        document.getElementById('result-points').textContent = session.earnedPoints;

        const listEl = document.getElementById('result-list');
        listEl.innerHTML = "";
        if(session.caught.length === 0) listEl.innerHTML = "<p style='width:100%; text-align:center; font-size:14px; color:#94a3b8;'>ì•„ë¬´ê²ƒë„ ëª» ì¡ì•˜ì–´ìš”...</p>";

        session.caught.forEach(p => {
            const div = document.createElement('div');
            div.className = 'result-poke';
            div.innerHTML = `<img src="${p.sprite}">`;
            listEl.appendChild(div);
        });

        switchView('view-result');
    }

    // --- ê²Œì„ ë¡œì§ ---
    function generateMap() {
        const grid = document.getElementById('grid');
        grid.innerHTML = "";
        tileMap = [];
        for(let y=0; y<9; y++){
            let row = [];
            for(let x=0; x<9; x++){
                const t = Math.floor(Math.random()*4);
                row.push(t);
                const div = document.createElement('div');
                div.className = 'tile';
                div.style.backgroundImage = `url('${TILE_IMGS[t]}')`;
                div.dataset.x = x; div.dataset.y = y;
                grid.appendChild(div);
            }
            tileMap.push(row);
        }
    }

    function move(dir) {
        if(!session.active || isMoving) return;

        let nx = player.x, ny = player.y;
        if(dir === 'up') ny--;
        if(dir === 'down') ny++;
        if(dir === 'left') nx--;
        if(dir === 'right') nx++;

        if(nx < 0 || nx >= 9 || ny < 0 || ny >= 9) return;

        isMoving = true;
        player.x = nx; player.y = ny;
        session.steps--;

        const frames = { up:[6,7,8], down:[0,1,2], left:[9,10,11], right:[3,4,5] };
        animateSprite(frames[dir] || frames.down);
        updatePlayerPos();
        updateGameHeader();

        setTimeout(() => {
            isMoving = false;
            if(session.steps <= 0) {
                endExploration('steps');
                return;
            }
            if(player.x === silhouettePos.x && player.y === silhouettePos.y) {
                startEncounter();
            }
        }, 300);
    }

    function updateGameHeader() {
        document.getElementById('game-steps').textContent = session.steps;
        const totalBalls = user.inventory.monster + user.inventory.super + user.inventory.hyper + user.inventory.master;
        document.getElementById('game-balls').textContent = totalBalls;
    }

    function animateSprite(frames) {
        let idx = 0;
        const interval = setInterval(() => {
            const frame = frames[idx % 3];
            const pct = (frame / 11) * 100;
            document.getElementById('playerSprite').style.backgroundPosition = `${pct}% 50%`;
            idx++;
        }, 100);
        setTimeout(() => clearInterval(interval), 300);
    }

    function updatePlayerPos() {
        document.getElementById('player').style.transform = `translate(${player.x*100}%, ${player.y*100}%)`;
    }

    // --- ìŠ¤í° ë° ì¸ì¹´ìš´í„° ---

    // ì‹¤ë£¨ì—£ ì œê±° í•¨ìˆ˜ (ë²„ê·¸ ìˆ˜ì •ìš©)
    function removeSilhouette() {
        document.querySelectorAll('.tile').forEach(t => {
            t.classList.remove('silhouette');
            const styleTag = t.querySelector('style');
            if(styleTag) styleTag.remove();
        });
        silhouettePos = { x: -1, y: -1 };
    }

    async function spawnPokemon() {
        // ê¸°ì¡´ ì‹¤ë£¨ì—£ í™•ì‹¤íˆ ì œê±°
        removeSilhouette();

        let x, y;
        do {
            x = Math.floor(Math.random()*9);
            y = Math.floor(Math.random()*9);
        } while(x === player.x && y === player.y);

        silhouettePos = {x, y};
        currentPokemon = null;

        const targetTile = document.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`);
        if(targetTile) targetTile.classList.add('silhouette');

        // ëœë¤ ID
        const id = Math.floor(Math.random()*151)+1;
        try {
            const res = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`);
            const data = await res.json();
            const name = data.names.find(n=>n.language.name==='ko')?.name || data.name;
            const sprite = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;

            currentPokemon = { id, name, rate: data.capture_rate, sprite };

            const style = document.createElement('style');
            style.innerHTML = `.tile[data-x="${x}"][data-y="${y}"].silhouette::after { background-image: url("${sprite}"); }`;
            targetTile.appendChild(style);

        } catch(e) {
            console.error(e);
        }
    }

    function startEncounter() {
        if(!currentPokemon) return;

        const total = user.inventory.monster + user.inventory.super + user.inventory.hyper + user.inventory.master;
        if(total <= 0) {
            endExploration('balls');
            return;
        }

        document.getElementById('modal-layer').classList.remove('hidden');
        document.getElementById('modal-encounter').classList.remove('hidden');

        document.getElementById('enc-img').src = currentPokemon.sprite;
        document.getElementById('enc-name').textContent = currentPokemon.name;

        let baseRate = (currentPokemon.rate / 255);
        baseRate += (user.upgrades.catchRate * 0.1);
        if(baseRate > 0.95) baseRate = 0.95;
        document.getElementById('enc-rate').textContent = Math.floor(baseRate*100);

        updateBallBtns();
    }

    function updateBallBtns() {
        ['monster','super','hyper','master'].forEach(type => {
            const qty = user.inventory[type];
            document.getElementById(`qty-${type}`).textContent = qty;
            document.getElementById(`btn-use-${type}`).disabled = (qty <= 0);
        });
    }

    function tryCatch(ballType) {
        if(user.inventory[ballType] <= 0) return;
        selectedBall = ballType;

        document.getElementById('modal-encounter').classList.add('hidden');
        document.getElementById('modal-quiz').classList.remove('hidden');

        // í€´ì¦ˆ ëœë¤ ì„ íƒ (ë¡œë”© ì‹œ ì„ì–´ë’€ìœ¼ë¯€ë¡œ ìˆœì°¨ì  í˜¹ì€ ì¬ëœë¤)
        currentQuiz = quizList[Math.floor(Math.random()*quizList.length)];

        document.getElementById('quiz-txt').textContent = currentQuiz.prompt;

        const optsDiv = document.getElementById('quiz-opts');
        optsDiv.innerHTML = "";

        // ë³´ê¸° ìƒì„±
        currentQuiz.choices.forEach((c, idx) => {
            const btn = document.createElement('button');
            btn.className = 'quiz-btn';
            btn.textContent = c;
            btn.onclick = () => solveQuiz(idx === currentQuiz.answerIndex);
            optsDiv.appendChild(btn);
        });
    }

    function solveQuiz(isCorrect) {
        user.inventory[selectedBall]--;
        updateGameHeader();

        let rate = currentPokemon.rate / 255;
        const ballBonus = { monster:1, super:1.5, hyper:2.0, master:255 }[selectedBall];
        const quizBonus = isCorrect ? 1.5 : 0.5;
        const upgradeBonus = 1 + (user.upgrades.catchRate * 0.1);

        let p = rate * ballBonus * quizBonus * upgradeBonus;
        if(selectedBall === 'master') p = 1;

        const success = Math.random() < p;

        document.getElementById('modal-quiz').classList.add('hidden');
        document.getElementById('modal-msg').classList.remove('hidden');
        document.getElementById('msg-img').src = currentPokemon.sprite;

        const titleEl = document.getElementById('msg-title');
        const descEl = document.getElementById('msg-desc');

        if(success) {
            titleEl.textContent = "ì¡ì•˜ë‹¤!";
            titleEl.style.color = "#4ade80";

            let pts = 100;
            if(user.dex.has(currentPokemon.id)) {
                pts = 50;
                descEl.innerHTML = `${currentPokemon.name}!<br><span style='font-size:14px; color:#94a3b8;'>ë˜ ì¡ì•˜ë„¤ìš” (+50P)</span>`;
            } else {
                user.dex.add(currentPokemon.id);
                descEl.innerHTML = `${currentPokemon.name}!<br><span style='font-size:14px; color:#f59e0b;'>ìƒˆë¡œìš´ ì¹œêµ¬! (+100P)</span>`;
            }

            user.points += pts;
            session.earnedPoints += pts;
            session.caught.push({ name: currentPokemon.name, sprite: currentPokemon.sprite });

        } else {
            titleEl.textContent = "ë†“ì³¤ë‹¤...";
            titleEl.style.color = "#f87171";
            descEl.textContent = `${currentPokemon.name}ì´(ê°€) ë„ë§ê°”ì–´ìš”.`;
        }

        descEl.innerHTML += isCorrect ? "<br><br>â­• ì •ë‹µì…ë‹ˆë‹¤!" : "<br><br>âŒ í‹€ë ¸ì–´ìš”...";
    }

    function closeMsgModal() {
        document.getElementById('modal-layer').classList.add('hidden');
        document.getElementById('modal-msg').classList.add('hidden');

        // ì‹¤ë£¨ì—£ ì œê±° (ë²„ê·¸ ìˆ˜ì •: í™•ì‹¤í•˜ê²Œ ì œê±°)
        removeSilhouette();

        // ë³¼ í™•ì¸
        const total = user.inventory.monster + user.inventory.super + user.inventory.hyper + user.inventory.master;
        if(total <= 0) {
            endExploration('balls');
        } else {
            spawnPokemon();
        }
    }

    function runAway() {
        document.getElementById('modal-layer').classList.add('hidden');
        document.getElementById('modal-encounter').classList.add('hidden');

        removeSilhouette();
        spawnPokemon();
    }

    // --- ìƒì  ê¸°ëŠ¥ ---
    function updateShopUI() {
        document.getElementById('shop-points').textContent = user.points;
        document.getElementById('lv-steps').textContent = `Lv.${user.upgrades.maxSteps}`;
        document.getElementById('lv-balls').textContent = `Lv.${user.upgrades.startBalls}`;
        document.getElementById('lv-rate').textContent = `Lv.${user.upgrades.catchRate}`;
    }

    function buyItem(cat, type, cost) {
        if(user.points < cost) {
            alert("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•´ìš”!");
            return;
        }
        user.points -= cost;
        user.inventory[type]++;
        updateShopUI();
        // alert ìƒëµ: ë²„íŠ¼ ëˆŒë¦¬ëŠ” ëŠë‚Œìœ¼ë¡œ ëŒ€ì²´í•˜ê±°ë‚˜ ê°„ë‹¨í•œ í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ì¢‹ìŒ
    }

    function buyUpgrade(key, cost) {
        if(user.points < cost) {
            alert("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•´ìš”!");
            return;
        }
        user.points -= cost;
        user.upgrades[key]++;
        updateShopUI();
    }

    // --- ë„ê° ë Œë”ë§ ---
    function renderDex() {
        document.getElementById('dex-count').textContent = user.dex.size;
        const grid = document.getElementById('dex-grid');
        grid.innerHTML = "";

        for(let i=1; i<=151; i++) {
            const d = document.createElement('div');
            // ë„ê° ìŠ¤íƒ€ì¼ ì˜ˆì˜ê²Œ
            d.style.cssText = "aspect-ratio:1; background:#fff; border-radius:15px; display:flex; justify-content:center; align-items:center; border:2px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05);";

            if(user.dex.has(i)) {
                d.innerHTML = `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${i}.png" style="width:80%; image-rendering:pixelated;">`;
                d.style.borderColor = "#4ade80";
                d.style.background = "#f0fdf4";
            } else {
                d.textContent = i;
                d.style.color = "#cbd5e1";
                d.style.fontSize = "14px";
                d.style.fontWeight = "bold";
            }
            grid.appendChild(d);
        }
    }

    init();
</script>
</body>
</html>