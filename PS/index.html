<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>í¬ì¼“ëª¬ ë§ì¶¤ë²• íƒí—˜ëŒ€ (ëª¨ë°”ì¼ ìµœì í™” ver)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <style>
        /* í°íŠ¸: ê·€ì—¬ìš´ 'Jua' í°íŠ¸ ì‚¬ìš© */
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        /* --- ê¸°ë³¸ ì„¤ì • ë° ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ --- */
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        body {
            margin: 0;
            font-family: 'Jua', sans-serif;
            background: linear-gradient(180deg, #bae6fd 0%, #e0f2fe 100%);
            color: #334155;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            /* ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ë†’ì´ ì´ìŠˆ ëŒ€ì‘ */
            height: 100dvh;
            background: rgba(255, 255, 255, 0.4);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- ê³µí†µ ìœ í‹¸ --- */
        .hidden { display: none !important; }
        .view {
            flex: 1;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            /* í•˜ë‹¨ íŒ¨ë”© ë„‰ë„‰í•˜ê²Œ */
            padding-bottom: 40px;
            overflow-y: auto;
            position: absolute;
            top: 0; left: 0;
            transition: opacity 0.3s;
        }

        /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ (ì…ì²´ê°) */
        .btn-3d {
            border: none;
            border-radius: 20px;
            font-family: 'Jua', sans-serif;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: white;
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.15);
        }

        /* --- ë¡œë¹„ í™”ë©´ --- */
        #view-lobby { justify-content: center; gap: 25px; }
        .lobby-title {
            font-size: 42px;
            color: #0284c7;
            text-shadow: 3px 3px 0 #fff;
            margin-bottom: 10px;
            text-align: center;
            line-height: 1.2;
        }
        .lobby-stats {
            background: #fff;
            padding: 10px 25px;
            border-radius: 30px;
            font-size: 20px;
            color: #f59e0b;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid #fef3c7;
        }

        .menu-btn { width: 100%; max-width: 280px; height: 75px; font-size: 26px; gap: 12px; }
        .btn-explore { background: #4ade80; color: #064e3b; }
        .btn-shop { background: #60a5fa; color: #1e3a8a; }
        .btn-dex { background: #fbbf24; color: #78350f; }

        /* --- ê²Œì„(íƒí—˜) í™”ë©´ --- */
        #view-game {
            padding: 15px;
            /* í•˜ë‹¨ ê³µê°„ í™•ë³´ */
            padding-bottom: 50px;
            background: #ecfccb;
        }
        .game-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: #fff;
            padding: 12px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .stat-badge { font-size: 18px; font-weight: bold; color: #57534e; }
        .stat-badge span { font-size: 24px; margin-left: 5px; }

        /* ë§µ ê·¸ë¦¬ë“œ */
        .grid-container {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1/1;
            position: relative;
            background: #86efac;
            border-radius: 20px;
            overflow: hidden;
            border: 4px solid #fff;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: 100%; height: 100%;
        }
        .tile { position: relative; background-size: cover; }
        .tile::before {
            content:''; position: absolute; inset:0;
            border: 0.5px solid rgba(255,255,255,0.2);
        }

        /* ì‹¤ë£¨ì—£ íš¨ê³¼ */
        .tile.silhouette .silhouette-img {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            object-fit: contain;
            image-rendering: pixelated;
            filter: brightness(0) invert(1) drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
            opacity: 0.9;
            animation: bounce 1.5s infinite;
            z-index: 5;
            pointer-events: none;
        }
        .tile.silhouette.legendary .silhouette-img {
            filter: brightness(0) drop-shadow(0 0 8px #ef4444);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50%      { transform: translateY(-8px); }
        }

        #player {
            position: absolute; top:0; left:0;
            width: calc(100%/9); height: calc(100%/9);
            z-index: 10;
            transition: transform 0.2s linear;
        }
        .player-img {
            width: 100%; height: 100%;
            background: url('./png/character.png') no-repeat;
            background-size: 1200% 100%;
            image-rendering: pixelated;
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.2));
        }

        /* --- [ìˆ˜ì •ë¨] ì»¨íŠ¸ë¡¤ëŸ¬ (ë°©í–¥í‚¤) --- */
        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            gap: 8px;
            /* í™”ë©´ í•˜ë‹¨ë¶€ë¡œ ë°€ì–´ë‚´ê¸° */
            margin-top: auto;
            /* í•˜ë‹¨ íŒ¨ë”© ì¶”ê°€í•˜ì—¬ í´ë¦­ ì˜ì—­ í™•ë³´ */
            margin-bottom: 20px;
            padding-bottom: env(safe-area-inset-bottom); /* ì•„ì´í° í™ˆ ë°” ëŒ€ì‘ */
        }
        .d-btn {
            width: 70px; height: 65px;
            background: #fff;
            border: 2px solid #cbd5e1;
            border-radius: 15px;
            color: #64748b; font-size: 30px;
            box-shadow: 0 4px 0 #cbd5e1;
            cursor: pointer;
            /* í„°ì¹˜ ë°˜ì‘ ì†ë„ ê°œì„  */
            touch-action: manipulation;
        }
        .d-btn:active { transform: translateY(4px); box-shadow: none; background: #f1f5f9; }
        .d-btn.up { grid-column: 2; }
        .d-btn.left { grid-column: 1; grid-row: 2; }
        .d-btn.down { grid-column: 2; grid-row: 2; }
        .d-btn.right { grid-column: 3; grid-row: 2; }

        /* --- ê²°ê³¼ í™”ë©´ --- */
        #view-result { text-align: center; justify-content: center; background: rgba(255,255,255,0.9); }
        .result-card {
            background: #fff;
            border-radius: 30px;
            padding: 30px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 4px solid #bae6fd;
        }
        .result-list {
            display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;
            margin: 20px 0;
            max-height: 200px; overflow-y: auto;
            background: #f8fafc; padding: 10px; border-radius: 15px;
        }
        .result-poke img { width: 60px; height: 60px; background: #fff; border-radius: 50%; border: 2px solid #e2e8f0; }

        /* --- ìƒì  í™”ë©´ --- */
        #view-shop { background: #fdf4ff; }
        .shop-header { display: flex; align-items: center; width: 100%; margin-bottom: 20px; }
        .shop-section { width: 100%; margin-bottom: 25px; }
        .shop-section h3 {
            color: #db2777; font-size: 20px; margin-bottom: 10px;
            background: #fff; display: inline-block; padding: 5px 15px; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .shop-item {
            background: #fff; padding: 15px; border-radius: 20px;
            text-align: center; border: 2px solid #fce7f3;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 4px 0 #fbcfe8;
        }
        .shop-price { color: #f59e0b; font-weight: bold; font-size: 18px; margin: 8px 0; }
        .buy-btn {
            background: #3b82f6; color: white; border: none; padding: 10px;
            border-radius: 12px; cursor: pointer; font-family: inherit; font-size: 16px;
            box-shadow: 0 3px 0 #2563eb;
        }
        .buy-btn:active { transform: translateY(3px); box-shadow: none; }

        /* --- ë„ê° í™”ë©´ --- */
        #view-dex { background: #fffbeb; }
        .back-btn {
            background: #fff; border: 2px solid #cbd5e1;
            font-size: 24px; cursor: pointer; border-radius: 50%;
            width: 45px; height: 45px; margin-right: 15px;
            box-shadow: 0 3px 0 #cbd5e1;
        }
        .back-btn:active { transform: translateY(3px); box-shadow: none; }

        /* --- ëª¨ë‹¬ --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px);
            z-index: 50; display: flex; justify-content: center; align-items: center;
        }
        .modal-box {
            background: #fff; width: 90%; max-width: 340px;
            border-radius: 25px; padding: 25px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: 4px solid #bae6fd;
            position: relative;
        }
        .poke-img-lg { width: 140px; height: 140px; image-rendering: pixelated; margin: 0 auto; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }

        .ball-select { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .ball-opt {
            background: #f8fafc; border: 2px solid #cbd5e1; color: #334155;
            padding: 12px; border-radius: 15px; font-size: 15px; font-family: inherit; cursor: pointer;
        }
        .ball-opt:active { background: #e2e8f0; }
        .ball-opt:disabled { opacity: 0.5; cursor: not-allowed; }
        .ball-opt img { width: 40px; height: 40px; image-rendering: pixelated; display: block; margin: 0 auto 4px; }

        .quiz-btn {
            padding: 15px; background: #fff; border: 2px solid #cbd5e1;
            color: #334155; border-radius: 15px; font-size: 20px;
            font-family: inherit; cursor: pointer; width: 100%;
            box-shadow: 0 4px 0 #cbd5e1; transition: 0.1s;
        }
        .quiz-btn:active { transform: translateY(4px); box-shadow: none; background: #f1f5f9; }

        /* ì• ë‹ˆë©”ì´ì…˜ ì˜ì—­ */
        .throw-scene-area {
            position: relative; width: 100%; height: 160px; margin-top: 10px; overflow: hidden; z-index: 120;
        }
        .throw-ball-img {
            position: absolute; left: 50%; bottom: 0;
            width: 80px; height: 96px;
            transform: translate(-50%, 160px) scale(0.9);
            image-rendering: pixelated; z-index: 130;
        }
        #throw-poke-img { position: relative; z-index: 110; }

        @keyframes ballThrowUp { 0% { transform: translate(-50%, 160px); } 100% { transform: translate(-50%, -64px); } }
        @keyframes ballDrop { 0% { transform: translate(-50%, -64px); } 100% { transform: translate(-50%, 0px); } }
        @keyframes ballShake {
            0% { transform: translate(-50%, 0px) rotate(0deg); filter:brightness(1); }
            25% { transform: translate(-50%, 0px) rotate(-15deg); }
            50% { transform: translate(-50%, 0px) rotate(15deg); }
            75% { transform: translate(-50%, 0px) rotate(-10deg); }
            100% { transform: translate(-50%, 0px) rotate(0deg); filter:brightness(0.6); }
        }
        @keyframes pokeDescendShrink {
            0% { transform: translateY(0px) scale(1); opacity: 1; }
            100% { transform: translateY(60px) scale(0); opacity: 0; }
        }

        .ball-throw-up { animation: ballThrowUp 0.35s ease-out forwards; }
        .ball-drop     { animation: ballDrop     0.25s ease-in  forwards; }
        .ball-shake    { animation: ballShake    0.40s ease-in-out 0s 3 forwards; }
        .poke-descend-shrink { animation: pokeDescendShrink 0.35s ease-in forwards; }
        .poke-hidden { opacity: 0; }

        /* í¬ê·€ë„ ë°°ì§€ */
        .rarity-badge {
            display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 14px; font-weight: bold; margin-bottom: 5px; color: white;
        }
        /* --- [ì¶”ê°€ë¨] ë¡œë¹„ íŒŒíŠ¸ë„ˆ í¬ì¼“ëª¬ ìŠ¤íƒ€ì¼ --- */
        .lobby-partner-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            z-index: -1; /* ë²„íŠ¼ë“¤ ë’¤ì— ë°°ì¹˜ */
            opacity: 0.8; /* ë°°ê²½ì²˜ëŸ¼ ì€ì€í•˜ê²Œ */
            pointer-events: none;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .lobby-partner-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            image-rendering: pixelated; /* ë„íŠ¸ ê¹¨ì§ ë°©ì§€ */
            animation: floating 3s ease-in-out infinite;
            filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1));
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-15px) scale(1.05); }
        }

        /* --- [ì¶”ê°€ë¨] ë„ê° ì„ íƒ íš¨ê³¼ --- */
        .dex-item {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .dex-item:active { transform: scale(0.95); }
        .dex-item.selected-partner {
            border: 3px solid #f59e0b !important;
            background: #fffbeb !important;
            box-shadow: 0 0 15px #f59e0b;
            position: relative;
        }
        .dex-item.selected-partner::after {
            content: 'ğŸ‘‘';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 24px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        
    </style>
</head>
<body>

<div class="app-container">

    <div id="view-lobby" class="view">
        <div id="lobby-partner" class="lobby-partner-container hidden">
            <img id="lobby-partner-img" class="lobby-partner-img" src="" />
        </div>

        <h1 class="lobby-title">PokÃ©mon<br>ë§ì¶¤ë²• íƒí—˜ëŒ€<br><span style="font-size:20px; color:#f59e0b;">(ëª¨ë°”ì¼ ìµœì í™”)</span></h1>
        <div class="lobby-stats">ë³´ìœ  í¬ì¸íŠ¸ ğŸ’° <span id="lobby-points">0</span></div>

        <button class="btn-3d menu-btn btn-explore" onclick="startExploration()">ğŸ§­ íƒí—˜ ë– ë‚˜ê¸°</button>
        <button class="btn-3d menu-btn btn-shop" onclick="switchView('view-shop')">ğŸ›’ ìƒì  ê°€ê¸°</button>
        <button class="btn-3d menu-btn btn-dex" onclick="switchView('view-dex')">ğŸ“– í¬ì¼“ëª¬ ë„ê°</button>
    </div>

    <div id="view-game" class="view hidden">
        <div class="game-header">
            <div class="stat-badge">ë‚¨ì€ ê±¸ìŒ ğŸ¾ <span id="game-steps" style="color:#ef4444">30</span></div>
            <div class="stat-badge">ë³¼ ê°œìˆ˜ ğŸ”´ <span id="game-balls" style="color:#3b82f6">10</span></div>
        </div>
        <div class="grid-container">
            <div id="grid" class="grid"></div>
            <div id="player"><div class="player-img" id="playerSprite"></div></div>
        </div>
        <div style="text-align:center; color:#57534e; font-size:16px; margin-bottom:10px; background:#fff; padding:5px 15px; border-radius:15px;">
            ë°©í–¥í‚¤ë¥¼ ëˆŒëŸ¬ì„œ í¬ì¼“ëª¬ì„ ì°¾ì•„ë³´ì„¸ìš”!
        </div>

        <div class="d-pad">
            <button class="d-btn up" onclick="move('up')">â–²</button>
            <button class="d-btn left" onclick="move('left')">â—€</button>
            <button class="d-btn down" onclick="move('down')">â–¼</button>
            <button class="d-btn right" onclick="move('right')">â–¶</button>
        </div>
    </div>

    <div id="view-result" class="view hidden">
        <div class="result-card">
            <h2 style="margin:0; font-size:32px; color:#334155;">íƒí—˜ ë!</h2>
            <p style="color:#64748b; font-size:18px; margin-top:5px;" id="end-reason">ë°œê±¸ìŒì„ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”</p>
            <div style="background:#fef3c7; padding:15px; border-radius:20px; margin:20px 0; border:2px solid #fcd34d;">
                <div style="font-size:16px; color:#92400e;">íšë“í•œ í¬ì¸íŠ¸</div>
                <div style="font-size:40px; color:#d97706; font-weight:bold;">+<span id="result-points">0</span></div>
            </div>
            <p style="text-align:left; margin-bottom:5px; font-weight:bold; color:#475569;">ì´ë²ˆì— ì¡ì€ í¬ì¼“ëª¬:</p>
            <div class="result-list" id="result-list"></div>
            <button class="btn-3d btn-explore" style="width:100%; height:60px; margin-top:10px;" onclick="switchView('view-lobby')">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <div id="view-shop" class="view hidden">
        <div class="shop-header">
            <button class="back-btn" onclick="switchView('view-lobby')">ğŸ”™</button>
            <h2 style="margin:0; font-size:24px; color:#86198f;">ìƒì </h2>
        </div>
        <div style="width:100%; text-align:right; margin-bottom:10px; font-size:18px;">
            ë‚´ ì§€ê°‘: <span class="highlight" id="shop-points" style="font-weight:bold; color:#d97706;">0</span> P
        </div>
        <div class="shop-section">
            <h3>ğŸ”´ ëª¬ìŠ¤í„°ë³¼ êµ¬ë§¤</h3>
            <div class="shop-grid">
                <div class="shop-item"><div>ëª¬ìŠ¤í„°ë³¼</div><div class="shop-price">50 P</div><button class="buy-btn" onclick="buyItem('ball', 'monster', 50)">êµ¬ë§¤í•˜ê¸°</button></div>
                <div class="shop-item"><div>ìŠˆí¼ë³¼</div><div class="shop-price">100 P</div><button class="buy-btn" onclick="buyItem('ball', 'super', 100)">êµ¬ë§¤í•˜ê¸°</button></div>
                <div class="shop-item"><div>í•˜ì´í¼ë³¼</div><div class="shop-price">150 P</div><button class="buy-btn" onclick="buyItem('ball', 'hyper', 150)">êµ¬ë§¤í•˜ê¸°</button></div>
                <div class="shop-item"><div>ë§ˆìŠ¤í„°ë³¼</div><div class="shop-price">300 P</div><button class="buy-btn" onclick="buyItem('ball', 'master', 300)">êµ¬ë§¤í•˜ê¸°</button></div>
            </div>
        </div>
        <div class="shop-section">
            <h3>âš¡ ëŠ¥ë ¥ ê°•í™”í•˜ê¸°</h3>
            <div class="shop-grid">
                <div class="shop-item"><div>ğŸ‘Ÿ íŠ¼íŠ¼í•œ ì‹ ë°œ<br><span style="font-size:12px; color:#94a3b8;" id="lv-steps">Lv.0</span></div><div class="shop-price">500 P</div><button class="buy-btn" onclick="buyUpgrade('maxSteps', 500)">ê°•í™”í•˜ê¸°</button></div>
                <div class="shop-item"><div>ğŸ’ ë„‰ë„‰í•œ ê°€ë°©<br><span style="font-size:12px; color:#94a3b8;" id="lv-balls">Lv.0</span></div><div class="shop-price">500 P</div><button class="buy-btn" onclick="buyUpgrade('startBalls', 500)">ê°•í™”í•˜ê¸°</button></div>
                <div class="shop-item"><div>ğŸ€ í–‰ìš´ì˜ ë¶€ì <br><span style="font-size:12px; color:#94a3b8;" id="lv-rate">Lv.0</span></div><div class="shop-price">800 P</div><button class="buy-btn" onclick="buyUpgrade('catchRate', 800)">ê°•í™”í•˜ê¸°</button></div>
            </div>
        </div>
    </div>

    <div id="view-dex" class="view hidden">
        <div class="shop-header">
            <button class="back-btn" onclick="switchView('view-lobby')">ğŸ”™</button>
            <h2 style="margin:0; font-size:24px; color:#92400e;">í¬ì¼“ëª¬ ë„ê°</h2>
        </div>
        <p style="font-size:18px; margin-bottom:15px;">ëª¨ì€ í¬ì¼“ëª¬: <span id="dex-count" style="font-weight:bold; color:#d97706;">0</span> / <span id="dex-total">1025</span></p>
        <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; width:100%; padding-bottom:50px;" id="dex-grid"></div>
    </div>

</div>

<div id="modal-layer" class="modal-overlay hidden">
    <div id="modal-encounter" class="modal-box hidden">
        <div id="enc-badge-area"></div>
        <h3 style="color:#ef4444; font-size:24px; margin:0 0 10px 0;">ì•¼ìƒì˜ í¬ì¼“ëª¬!</h3>
        <img id="enc-img" src="" class="poke-img-lg" />
        <h2 id="enc-name" style="font-size:28px; margin:10px 0;">???</h2>
        <p style="font-size:16px; color:#f59e0b; font-weight:bold; margin:0;">í¬íš í™•ë¥ : <span id="enc-rate"></span>%</p>

        <div class="ball-select">
            <button class="ball-opt" id="btn-use-monster" onclick="tryCatch('monster')"><img src="./png/pb.png">ëª¬ìŠ¤í„°ë³¼<br>x<span id="qty-monster">0</span></button>
            <button class="ball-opt" id="btn-use-super" onclick="tryCatch('super')"><img src="./png/gb.png">ìŠˆí¼ë³¼<br>x<span id="qty-super">0</span></button>
            <button class="ball-opt" id="btn-use-hyper" onclick="tryCatch('hyper')"><img src="./png/ub.png">í•˜ì´í¼ë³¼<br>x<span id="qty-hyper">0</span></button>
            <button class="ball-opt" id="btn-use-master" onclick="tryCatch('master')"><img src="./png/mb.png">ë§ˆìŠ¤í„°ë³¼<br>x<span id="qty-master">0</span></button>
        </div>
        <button style="margin-top:20px; background:#94a3b8; padding:12px; border:none; color:white; border-radius:15px; width:100%; font-size:18px; font-family:inherit; cursor:pointer;" onclick="runAway()">ğŸƒ ë„ë§ê°€ê¸°</button>
    </div>

    <div id="modal-quiz" class="modal-box hidden">
        <h3 style="color:#0ea5e9; font-size:24px; margin-top:0;">ë§ì¶¤ë²• í€´ì¦ˆ</h3>
        <p id="quiz-txt" style="font-size:22px; margin:20px 0; font-weight:bold; color:#334155; word-break: keep-all;"></p>
        <div id="quiz-opts" style="display:flex; flex-direction:column; gap:12px;"></div>
    </div>

    <div id="modal-throw" class="modal-box hidden">
        <h3 style="color:#f97316; font-size:24px; margin-top:0;">í¬ì¼“ë³¼ì„ ë˜ì¡Œë‹¤!</h3>
        <img id="throw-poke-img" src="" class="poke-img-lg" />
        <div class="throw-scene-area"><img id="throw-ball-img" class="throw-ball-img" /></div>
        <p style="font-size:16px; color:#64748b; margin-top:10px;">í¬ì¼“ë³¼ì´ í”ë“¤ë¦¬ê³  ìˆì–´ìš”...</p>
    </div>

    <div id="modal-msg" class="modal-box hidden">
        <h2 id="msg-title" style="font-size:32px; margin:10px 0;">ê²°ê³¼</h2>
        <img id="msg-img" src="" style="width:100px; height:100px; image-rendering:pixelated;" />
        <p id="msg-desc" style="font-size:18px; color:#475569; margin:15px 0; line-height:1.4;"></p>
        <button onclick="closeMsgModal()" style="background:#4ade80; padding:15px; width:100%; border:none; color:#064e3b; border-radius:15px; font-weight:bold; font-size:20px; cursor:pointer;">í™•ì¸</button>
    </div>
</div>

<script>
    const TILE_IMGS = ["./png/Tile0.png", "./png/Tile1.png", "./png/Tile2.png", "./png/Tile3.png"];
    const QUIZ_URL = "./quiz/quiz.json";
    const MAX_POKEMON_ID = 1025;

    // --- [ì¤‘ìš”] í¬ê·€ í¬ì¼“ëª¬ ë¦¬ìŠ¤íŠ¸ ---
    const LEGENDARY_IDS = [
        144,145,146,150,151, // 1ì„¸ëŒ€
        243,244,245,249,250,251, // 2ì„¸ëŒ€
        382,383,384,385,386, // 3ì„¸ëŒ€
        483,484,487,491,492,493, // 4ì„¸ëŒ€
        643,644,646,649, // 5ì„¸ëŒ€
        716,717,718, // 6ì„¸ëŒ€
        785,786,787,788,800,801,802,807, // 7ì„¸ëŒ€
        888,889,890,891,892,898, // 8ì„¸ëŒ€
        1007,1008,1017,1024,1025 // 9ì„¸ëŒ€
    ];

    const RARE_IDS = [
        1,4,7, 25, 133, 143, 149, // 1ì„¸ëŒ€ (í”¼ì¹´ì¸„, ì´ë¸Œì´, ë§ë‚˜ë‡½ ë“±)
        152,155,158, 212, 248, // 2ì„¸ëŒ€ (í•«ì‚¼, ë§ˆê¸°ë¼ìŠ¤)
        252,255,258, 282, 373, 376, 445, 448, // 3~4ì„¸ëŒ€ (ë³´ë§Œë‹¤, ë©”íƒ€ê·¸ë¡œìŠ¤, í•œì¹´ë¦¬ì•„ìŠ¤, ë£¨ì¹´ë¦¬ì˜¤)
        495,498,501, 635, 650, 653, // 5~6ì„¸ëŒ€ (ì‚¼ì‚¼ë“œë˜ ë“±)
        722,725,728, 810,813,816, 887, // 7~8ì„¸ëŒ€ (ë“œë˜í„íŠ¸ ë“±)
        906,909,912, 996, 997, 998 // 9ì„¸ëŒ€ (ë“œë‹ë ˆì´ë¸Œ ë“±)
    ];

    const BALL_SPRITES = { monster: "./png/pb.png", super: "./png/gb.png", hyper: "./png/ub.png", master: "./png/mb.png" };
    const BALL_OPEN_SPRITES = { monster: "./png/pb_open.png", super: "./png/gb_open.png", hyper: "./png/ub_open.png", master: "./png/mb_open.png" };
    const BALL_OPENING_SPRITES = { monster: "./png/pb_opening.png", super: "./png/gb_opening.png", hyper: "./png/ub_opening.png", master: "./png/mb_opening.png" };

    let user = {
        points: 0,
        inventory: { monster: 0, super: 0, hyper: 0, master: 0 },
        dex: new Set(),
        upgrades: { maxSteps: 0, startBalls: 0, catchRate: 0 },
        partnerId: null // [ì¶”ê°€ë¨] íŒŒíŠ¸ë„ˆ í¬ì¼“ëª¬ ID ì €ì¥
    };
    let session = { active: false, steps: 0, caught: [], earnedPoints: 0 };
    let player = { x: 4, y: 4 };
    let tileMap = [];
    let currentPokemon = null;
    let silhouettePos = { x: -1, y: -1 };
    let isMoving = false;
    let quizList = [];
    let selectedBall = null;
    let currentQuiz = null;
    let lastCapture = null;

    async function init() {
        await loadQuiz();
        updateLobbyUI();
    }

    async function loadQuiz() {
        try {
            const res = await fetch(QUIZ_URL);
            const data = await res.json();
            let qArr = data.questions || [];
            for (let i = qArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [qArr[i], qArr[j]] = [qArr[j], qArr[i]];
            }
            quizList = qArr;
        } catch(e) {
            quizList = [{prompt:"'ë‚˜ë¬´'ì˜ ì˜¬ë°”ë¥¸ í‘œê¸°ëŠ”?", choices:["ë‚˜ë¬´","ë‚˜ëª¨"], answerIndex:0}];
        }
    }

    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');
        if(viewId === 'view-shop') updateShopUI();
        if(viewId === 'view-dex') renderDex();
        if(viewId === 'view-lobby') updateLobbyUI();
    }

    // [ì¶”ê°€ë¨] íŒŒíŠ¸ë„ˆ ì„¤ì • í•¨ìˆ˜
    function setPartner(id) {
        if(user.partnerId === id) {
            // ì´ë¯¸ íŒŒíŠ¸ë„ˆë¼ë©´ í•´ì œ
            user.partnerId = null;
            alert("íŒŒíŠ¸ë„ˆ ì„¤ì •ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            // ìƒˆë¡œìš´ íŒŒíŠ¸ë„ˆ ì„¤ì •
            user.partnerId = id;
            alert("ë¡œë¹„ íŒŒíŠ¸ë„ˆë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }
        renderDex(); // ë„ê° UI ê°±ì‹  (ì™•ê´€ í‘œì‹œ)
    }

    // [ìˆ˜ì •ë¨] ë¡œë¹„ UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateLobbyUI() {
        document.getElementById('lobby-points').textContent = user.points;

        // íŒŒíŠ¸ë„ˆ ì´ë¯¸ì§€ ì²˜ë¦¬
        const partnerContainer = document.getElementById('lobby-partner');
        const partnerImg = document.getElementById('lobby-partner-img');

        if (user.partnerId) {
            partnerContainer.classList.remove('hidden');
            partnerImg.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${user.partnerId}.png`;
        } else {
            partnerContainer.classList.add('hidden');
            partnerImg.src = "";
        }
    }
    function startExploration() {
        const baseSteps = 30 + (user.upgrades.maxSteps * 10);
        const bonusBalls = 10 + (user.upgrades.startBalls * 2);
        session = { active: true, steps: baseSteps, caught: [], earnedPoints: 0 };
        if (user.inventory.monster < bonusBalls) user.inventory.monster = bonusBalls;

        generateMap();
        player = { x: 4, y: 4 };
        updatePlayerPos();
        updateGameHeader();
        switchView('view-game');
        removeSilhouette();
        spawnPokemon();
    }

    function endExploration(reason) {
        session.active = false;
        document.getElementById('end-reason').textContent = reason === 'steps' ? "ë°œê±¸ìŒì„ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”!" : "í¬ì¼“ë³¼ì´ ë‹¤ ë–¨ì–´ì¡Œì–´ìš”!";
        document.getElementById('result-points').textContent = session.earnedPoints;
        const listEl = document.getElementById('result-list');
        listEl.innerHTML = "";
        if(session.caught.length === 0) listEl.innerHTML = "<p style='width:100%; text-align:center; font-size:14px; color:#94a3b8;'>ì•„ë¬´ê²ƒë„ ëª» ì¡ì•˜ì–´ìš”...</p>";
        session.caught.forEach(p => {
            const div = document.createElement('div');
            div.className = 'result-poke';
            div.innerHTML = `<img src="${p.sprite}">`;
            listEl.appendChild(div);
        });
        switchView('view-result');
    }

    function generateMap() {
        const grid = document.getElementById('grid');
        grid.innerHTML = "";
        tileMap = [];
        for(let y=0; y<9; y++){
            let row = [];
            for(let x=0; x<9; x++){
                const t = Math.floor(Math.random()*4);
                row.push(t);
                const div = document.createElement('div');
                div.className = 'tile';
                div.style.backgroundImage = `url('${TILE_IMGS[t]}')`;
                div.dataset.x = x; div.dataset.y = y;
                grid.appendChild(div);
            }
            tileMap.push(row);
        }
    }

    function move(dir) {
        if(!session.active || isMoving) return;
        let nx = player.x, ny = player.y;
        if(dir === 'up') ny--;
        if(dir === 'down') ny++;
        if(dir === 'left') nx--;
        if(dir === 'right') nx++;
        if(nx < 0 || nx >= 9 || ny < 0 || ny >= 9) return;

        isMoving = true;
        player.x = nx; player.y = ny;
        session.steps--;
        const frames = { up:[6,7,8], down:[0,1,2], left:[9,10,11], right:[3,4,5] };
        animateSprite(frames[dir] || frames.down);
        updatePlayerPos();
        updateGameHeader();
        setTimeout(() => {
            isMoving = false;
            if(session.steps <= 0) { endExploration('steps'); return; }
            if(player.x === silhouettePos.x && player.y === silhouettePos.y) startEncounter();
        }, 300);
    }

    function updateGameHeader() {
        document.getElementById('game-steps').textContent = session.steps;
        document.getElementById('game-balls').textContent = user.inventory.monster + user.inventory.super + user.inventory.hyper + user.inventory.master;
    }

    function animateSprite(frames) {
        let idx = 0;
        const interval = setInterval(() => {
            const frame = frames[idx % 3];
            document.getElementById('playerSprite').style.backgroundPosition = `${(frame / 11) * 100}% 50%`;
            idx++;
        }, 100);
        setTimeout(() => clearInterval(interval), 300);
    }

    function updatePlayerPos() {
        document.getElementById('player').style.transform = `translate(${player.x*100}%, ${player.y*100}%)`;
    }

    function removeSilhouette() {
        document.querySelectorAll('.tile.silhouette').forEach(t => {
            t.classList.remove('silhouette', 'legendary');
            const img = t.querySelector('.silhouette-img');
            if (img) img.remove();
        });
        silhouettePos = { x: -1, y: -1 };
    }

    // --- í™•ë¥  ê¸°ë°˜ ID ì¶”ì¶œ í•¨ìˆ˜ ---
    function getWeightedRandomId() {
        const roll = Math.random();
        if(roll < 0.02) {
            return { id: LEGENDARY_IDS[Math.floor(Math.random() * LEGENDARY_IDS.length)], rarity: 'legendary' };
        } else if (roll < 0.15) {
            return { id: RARE_IDS[Math.floor(Math.random() * RARE_IDS.length)], rarity: 'rare' };
        } else {
            return { id: Math.floor(Math.random() * MAX_POKEMON_ID) + 1, rarity: 'common' };
        }
    }

    async function spawnPokemon() {
        removeSilhouette();
        let x, y;
        do { x = Math.floor(Math.random() * 9); y = Math.floor(Math.random() * 9); } while (x === player.x && y === player.y);
        silhouettePos = { x, y };
        currentPokemon = null;
        const targetTile = document.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`);

        const spawnData = getWeightedRandomId();
        const id = spawnData.id;
        const rarity = spawnData.rarity;

        try {
            const res = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`);
            const data = await res.json();
            const name = data.names.find((n) => n.language.name === "ko")?.name || data.name;
            const sprite = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;

            currentPokemon = { id, name, rate: data.capture_rate, sprite, rarity };

            if (targetTile) {
                targetTile.classList.add("silhouette");
                if(rarity === 'legendary') targetTile.classList.add("legendary");

                const oldImg = targetTile.querySelector(".silhouette-img");
                if (oldImg) oldImg.remove();
                const img = document.createElement("img");
                img.className = "silhouette-img";
                img.src = sprite;
                targetTile.appendChild(img);
            }
        } catch (e) { console.error(e); }
    }

    function startEncounter() {
        if(!currentPokemon) return;
        if((user.inventory.monster + user.inventory.super + user.inventory.hyper + user.inventory.master) <= 0) {
            endExploration('balls'); return;
        }
        document.getElementById('modal-layer').classList.remove('hidden');
        document.getElementById('modal-encounter').classList.remove('hidden');
        document.getElementById('enc-img').src = currentPokemon.sprite;
        document.getElementById('enc-name').textContent = currentPokemon.name;

        const badgeArea = document.getElementById('enc-badge-area');
        badgeArea.innerHTML = "";
        if(currentPokemon.rarity === 'legendary') {
            badgeArea.innerHTML = `<span class="rarity-badge" style="background:#ef4444;">ğŸŒŸ ì „ì„¤/í™˜ìƒ</span>`;
        } else if (currentPokemon.rarity === 'rare') {
            badgeArea.innerHTML = `<span class="rarity-badge" style="background:#3b82f6;">âœ¨ í¬ê·€</span>`;
        }

        let baseRate = (currentPokemon.rate / 255);
        if (!baseRate) baseRate = 0.1;

        baseRate = baseRate * 2.5; // ë°¸ëŸ°ìŠ¤ íŒ¨ì¹˜
        baseRate += (user.upgrades.catchRate * 0.1);

        if(baseRate > 0.95) baseRate = 0.95;
        if(baseRate < 0.1) baseRate = 0.1;

        document.getElementById('enc-rate').textContent = Math.floor(baseRate*100);
        updateBallBtns();
    }

    function updateBallBtns() {
        ['monster','super','hyper','master'].forEach(type => {
            const qty = user.inventory[type];
            document.getElementById(`qty-${type}`).textContent = qty;
            document.getElementById(`btn-use-${type}`).disabled = (qty <= 0);
        });
    }

    function tryCatch(ballType) {
        if(user.inventory[ballType] <= 0) return;
        selectedBall = ballType;
        document.getElementById('modal-encounter').classList.add('hidden');
        document.getElementById('modal-quiz').classList.remove('hidden');
        currentQuiz = quizList[Math.floor(Math.random()*quizList.length)];
        document.getElementById('quiz-txt').textContent = currentQuiz.prompt;
        const optsDiv = document.getElementById('quiz-opts');
        optsDiv.innerHTML = "";
        currentQuiz.choices.forEach((c, idx) => {
            const btn = document.createElement('button');
            btn.className = 'quiz-btn';
            btn.textContent = c;
            btn.onclick = () => solveQuiz(idx === currentQuiz.answerIndex);
            optsDiv.appendChild(btn);
        });
    }

    function solveQuiz(isCorrect) {
        user.inventory[selectedBall]--;
        updateGameHeader();

        let rate = currentPokemon.rate / 255;
        if(!rate) rate = 0.1;

        const ballBonus = { monster:1, super:1.5, hyper:2.0, master:255 }[selectedBall];
        const quizBonus = isCorrect ? 1.5 : 0.8;
        const upgradeBonus = 1 + (user.upgrades.catchRate * 0.1);
        const balancePatchMultiplier = 2.5;

        let p = rate * ballBonus * quizBonus * upgradeBonus * balancePatchMultiplier;

        if (p < 0.15 && isCorrect) p = 0.15;

        if(selectedBall === 'master') p = 1;

        const success = Math.random() < p;
        let titleText, titleColor, descHtml;

        if(success) {
            titleText = "ì¡ì•˜ë‹¤!";
            titleColor = "#4ade80";
            let pts = 100;
            if(currentPokemon.rarity === 'legendary') pts = 500;
            else if(currentPokemon.rarity === 'rare') pts = 200;

            if(user.dex.has(currentPokemon.id)) {
                pts = Math.floor(pts / 2);
                descHtml = `${currentPokemon.name}!<br><span style='font-size:14px; color:#94a3b8;'>ë˜ ì¡ì•˜ë„¤ìš” (+${pts}P)</span>`;
            } else {
                user.dex.add(currentPokemon.id);
                descHtml = `${currentPokemon.name}!<br><span style='font-size:14px; color:#f59e0b;'>ìƒˆë¡œìš´ ì¹œêµ¬! (+${pts}P)</span>`;
            }
            user.points += pts;
            session.earnedPoints += pts;
            session.caught.push({ name: currentPokemon.name, sprite: currentPokemon.sprite });
        } else {
            titleText = "ë†“ì³¤ë‹¤...";
            titleColor = "#f87171";
            descHtml = `${currentPokemon.name}ì´(ê°€) ë„ë§ê°”ì–´ìš”.`;
        }
        descHtml += isCorrect ? "<br><br>â­• ì •ë‹µì…ë‹ˆë‹¤!" : "<br><br>âŒ í‹€ë ¸ì–´ìš”...";
        lastCapture = { success, isCorrect, titleText, titleColor, descHtml };
        removeSilhouette();
        document.getElementById('modal-quiz').classList.add('hidden');
        showThrowAnimation();
    }

    function showThrowAnimation() {
        const layer = document.getElementById("modal-layer");
        const throwModal = document.getElementById("modal-throw");
        const pokeImg = document.getElementById("throw-poke-img");
        const ballImg = document.getElementById("throw-ball-img");
        layer.classList.remove("hidden");
        throwModal.classList.remove("hidden");
        pokeImg.src = currentPokemon.sprite;
        pokeImg.classList.remove("poke-descend-shrink", "poke-hidden");
        pokeImg.style.transform = "";
        pokeImg.style.opacity = "1";
        const closedSprite = BALL_SPRITES[selectedBall];
        const openSprite = BALL_OPEN_SPRITES[selectedBall];
        const openingSprite = BALL_OPENING_SPRITES[selectedBall];
        ballImg.src = closedSprite;
        ballImg.classList.remove("ball-throw-up", "ball-drop", "ball-shake");
        void ballImg.offsetWidth;
        ballImg.classList.add("ball-throw-up");
        ballImg.onanimationend = (e) => {
            if (e.animationName === "ballThrowUp") {
                ballImg.src = openSprite;
                pokeImg.classList.remove("poke-descend-shrink", "poke-hidden");
                pokeImg.style.transform = ""; pokeImg.style.opacity = "1"; void pokeImg.offsetWidth;
                pokeImg.classList.add("poke-descend-shrink");
                pokeImg.onanimationend = () => {
                    pokeImg.classList.add("poke-hidden");
                    ballImg.src = openSprite;
                    setTimeout(() => {
                        ballImg.src = openingSprite;
                        setTimeout(() => {
                            ballImg.src = closedSprite;
                            ballImg.classList.remove("ball-throw-up"); void ballImg.offsetWidth;
                            ballImg.classList.add("ball-drop");
                        }, 80);
                    }, 80);
                };
            } else if (e.animationName === "ballDrop") {
                ballImg.classList.remove("ball-drop"); void ballImg.offsetWidth;
                ballImg.classList.add("ball-shake");
            } else if (e.animationName === "ballShake") {
                ballImg.onanimationend = null;
                throwModal.classList.add("hidden");
                showResultModal();
            }
        };
    }

    function showResultModal() {
        const layer = document.getElementById('modal-layer');
        const msgModal = document.getElementById('modal-msg');
        layer.classList.remove('hidden');
        msgModal.classList.remove('hidden');
        document.getElementById('msg-img').src = currentPokemon.sprite;
        if (lastCapture) {
            const titleEl = document.getElementById('msg-title');
            titleEl.textContent = lastCapture.titleText;
            titleEl.style.color = lastCapture.titleColor;
            document.getElementById('msg-desc').innerHTML = lastCapture.descHtml;
        }
    }

    function closeMsgModal() {
        document.getElementById('modal-layer').classList.add('hidden');
        document.getElementById('modal-msg').classList.add('hidden');
        removeSilhouette();
        if((user.inventory.monster + user.inventory.super + user.inventory.hyper + user.inventory.master) <= 0) endExploration('balls');
        else spawnPokemon();
    }

    function runAway() {
        document.getElementById('modal-layer').classList.add('hidden');
        document.getElementById('modal-encounter').classList.add('hidden');
        removeSilhouette();
        spawnPokemon();
    }

    function updateShopUI() {
        document.getElementById('shop-points').textContent = user.points;
        document.getElementById('lv-steps').textContent = `Lv.${user.upgrades.maxSteps}`;
        document.getElementById('lv-balls').textContent = `Lv.${user.upgrades.startBalls}`;
        document.getElementById('lv-rate').textContent = `Lv.${user.upgrades.catchRate}`;
    }

    function buyItem(cat, type, cost) {
        if(user.points < cost) { alert("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•´ìš”!"); return; }
        user.points -= cost;
        user.inventory[type]++;
        updateShopUI();
    }

    function buyUpgrade(key, cost) {
        if(user.points < cost) { alert("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•´ìš”!"); return; }
        user.points -= cost;
        user.upgrades[key]++;
        updateShopUI();
    }

    function renderDex() {
        document.getElementById('dex-count').textContent = user.dex.size;
        document.getElementById('dex-total').textContent = MAX_POKEMON_ID;
        const grid = document.getElementById('dex-grid');
        grid.innerHTML = "";

        // ë„ê° ì„¤ëª… í…ìŠ¤íŠ¸ ì¶”ê°€
        const hint = document.createElement('p');
        hint.style.cssText = "grid-column: 1 / -1; text-align: center; color: #64748b; font-size: 14px; margin-bottom: 10px;";
        hint.textContent = "í¬ì¼“ëª¬ì„ í„°ì¹˜í•˜ì—¬ ë¡œë¹„ íŒŒíŠ¸ë„ˆë¡œ ì„¤ì •í•´ë³´ì„¸ìš”! ğŸ‘‘";
        grid.appendChild(hint);

        for(let i=1; i<=MAX_POKEMON_ID; i++) {
            const d = document.createElement('div');
            d.className = 'dex-item'; // CSS í´ë˜ìŠ¤ ì¶”ê°€
            d.style.cssText = "aspect-ratio:1; background:#fff; border-radius:15px; display:flex; justify-content:center; align-items:center; border:2px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;";

            if(user.dex.has(i)) {
                d.innerHTML = `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${i}.png" style="width:80%; image-rendering:pixelated;" loading="lazy">`;
                d.style.borderColor = "#4ade80";
                d.style.background = "#f0fdf4";

                // [ì¶”ê°€ë¨] íŒŒíŠ¸ë„ˆ ì„ íƒ ê¸°ëŠ¥
                if(user.partnerId === i) {
                    d.classList.add('selected-partner');
                }
                d.onclick = () => setPartner(i);

            } else {
                d.textContent = i;
                d.style.color = "#cbd5e1";
                d.style.fontSize = "14px";
                d.style.fontWeight = "bold";
            }
            grid.appendChild(d);
        }
    }

    init();
</script>
</body>
</html>