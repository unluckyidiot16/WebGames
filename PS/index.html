<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>í¬ì¼“ëª¬ íƒí—˜ëŒ€ (ë°ì´í„° ë³´ì¡´ ver)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <style>
        /* í°íŠ¸: ê·€ì—¬ìš´ 'Jua' í°íŠ¸ ì‚¬ìš© */
        @import url('https://fonts.googleapis.com/css2?family=Jua&display=swap');

        /* --- ê¸°ë³¸ ì„¤ì • ë° ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ --- */
        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }
        * { -ms-overflow-style: none; scrollbar-width: none; }

        body {
            margin: 0;
            font-family: 'Jua', sans-serif;
            background: linear-gradient(180deg, #bae6fd 0%, #e0f2fe 100%);
            color: #334155;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            overflow: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            height: 100dvh;
            background: rgba(255, 255, 255, 0.4);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* --- ê³µí†µ ìœ í‹¸ --- */
        .hidden { display: none !important; }
        .view {
            flex: 1;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            padding-bottom: 40px;
            overflow-y: auto;
            position: absolute;
            top: 0; left: 0;
            transition: opacity 0.3s;
        }

        /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ (ì…ì²´ê°) */
        .btn-3d {
            border: none;
            border-radius: 20px;
            font-family: 'Jua', sans-serif;
            cursor: pointer;
            transition: transform 0.1s;
            box-shadow: 0 6px 0 rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: white;
        }
        .btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 2px 0 rgba(0,0,0,0.15);
        }

        /* --- ë¡œë¹„ í™”ë©´ --- */
        #view-lobby { justify-content: center; gap: 25px; }

        .title-wrapper {
            position: relative;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 10px;
            z-index: 10;
        }

        .lobby-title {
            font-size: 42px;
            color: #0284c7;
            text-shadow: 3px 3px 0 #fff;
            margin: 0;
            text-align: center;
            line-height: 1.2;
            position: relative;
            z-index: 2;
        }

        .lobby-stats {
            background: #fff;
            padding: 10px 25px;
            border-radius: 30px;
            font-size: 20px;
            color: #f59e0b;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border: 2px solid #fef3c7;
        }

        .menu-btn { width: 100%; max-width: 280px; height: 75px; font-size: 26px; gap: 12px; }
        .btn-explore { background: #4ade80; color: #064e3b; }
        .btn-shop { background: #60a5fa; color: #1e3a8a; }
        .btn-dex { background: #fbbf24; color: #78350f; }

        /* --- ê²Œì„(íƒí—˜) í™”ë©´ --- */
        #view-game {
            padding: 15px;
            padding-bottom: 50px;
            background: #ecfccb;
        }
        .game-header {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            background: #fff;
            padding: 12px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .stat-badge { font-size: 18px; font-weight: bold; color: #57534e; }
        .stat-badge span { font-size: 24px; margin-left: 5px; }

        /* ë§µ ê·¸ë¦¬ë“œ */
        .grid-container {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1/1;
            position: relative;
            background: #86efac;
            border-radius: 20px;
            overflow: hidden;
            border: 4px solid #fff;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: 100%; height: 100%;
        }
        .tile { position: relative; background-size: cover; }
        .tile::before {
            content:''; position: absolute; inset:0;
            border: 0.5px solid rgba(255,255,255,0.2);
        }

        /* ì‹¤ë£¨ì—£ íš¨ê³¼ */
        .tile.silhouette .silhouette-img {
            position: absolute;
            width: 200%;
            height: 200%;
            top: -50%;
            left: -50%;
            object-fit: contain;
            image-rendering: pixelated;
            filter: brightness(0) invert(1) drop-shadow(0 0 5px rgba(255, 255, 255, 0.8));
            opacity: 0.9;
            animation: bounce 1.5s infinite;
            z-index: 5;
            pointer-events: none;
        }
        .tile.silhouette.legendary .silhouette-img {
            filter: brightness(0) drop-shadow(0 0 8px #ef4444);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50%      { transform: translateY(-8px); }
        }

        #player {
            position: absolute; top:0; left:0;
            width: calc(100%/9); height: calc(100%/9);
            z-index: 10;
            transition: transform 0.2s linear;
        }
        .player-img {
            width: 100%; height: 100%;
            background: url('./png/character.png') no-repeat;
            background-size: 1200% 100%;
            image-rendering: pixelated;
            filter: drop-shadow(0 4px 2px rgba(0,0,0,0.2));
        }

        /* ì»¨íŠ¸ë¡¤ëŸ¬ */
        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 70px);
            gap: 8px;
            margin-top: auto;
            margin-bottom: 20px;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .d-btn {
            width: 70px; height: 65px;
            background: #fff;
            border: 2px solid #cbd5e1;
            border-radius: 15px;
            color: #64748b; font-size: 30px;
            box-shadow: 0 4px 0 #cbd5e1;
            cursor: pointer;
            touch-action: manipulation;
        }
        .d-btn:active { transform: translateY(4px); box-shadow: none; background: #f1f5f9; }
        .d-btn.up { grid-column: 2; }
        .d-btn.left { grid-column: 1; grid-row: 2; }
        .d-btn.down { grid-column: 2; grid-row: 2; }
        .d-btn.right { grid-column: 3; grid-row: 2; }

        /* --- ê²°ê³¼ í™”ë©´ --- */
        #view-result { text-align: center; justify-content: center; background: rgba(255,255,255,0.9); }
        .result-card {
            background: #fff;
            border-radius: 30px;
            padding: 30px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border: 4px solid #bae6fd;
        }
        .result-list {
            display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;
            margin: 20px 0;
            max-height: 200px; overflow-y: auto;
            background: #f8fafc; padding: 10px; border-radius: 15px;
        }
        .result-poke img { width: 60px; height: 60px; background: #fff; border-radius: 50%; border: 2px solid #e2e8f0; }

        /* --- ìƒì  í™”ë©´ --- */
        #view-shop { background: #fdf4ff; }
        .shop-header { display: flex; align-items: center; width: 100%; margin-bottom: 20px; }
        .shop-section { width: 100%; margin-bottom: 25px; }
        .shop-section h3 {
            color: #db2777; font-size: 20px; margin-bottom: 10px;
            background: #fff; display: inline-block; padding: 5px 15px; border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .shop-item {
            background: #fff; padding: 15px; border-radius: 20px;
            text-align: center; border: 2px solid #fce7f3;
            display: flex; flex-direction: column; justify-content: space-between;
            box-shadow: 0 4px 0 #fbcfe8;
        }
        .shop-price { color: #f59e0b; font-weight: bold; font-size: 18px; margin: 8px 0; }
        .buy-btn {
            background: #3b82f6; color: white; border: none; padding: 10px;
            border-radius: 12px; cursor: pointer; font-family: inherit; font-size: 16px;
            box-shadow: 0 3px 0 #2563eb;
        }
        .buy-btn:active { transform: translateY(3px); box-shadow: none; }
        .buy-btn:disabled { background: #94a3b8; box-shadow: none; transform: translateY(3px); cursor: not-allowed; }

        /* --- ë„ê° í™”ë©´ --- */
        #view-dex {
            background: #fffbeb;
            padding-top: 0;
        }
        .back-btn {
            background: #fff; border: 2px solid #cbd5e1;
            font-size: 24px; cursor: pointer; border-radius: 50%;
            width: 45px; height: 45px; margin-right: 15px;
            box-shadow: 0 3px 0 #cbd5e1;
        }
        .back-btn:active { transform: translateY(3px); box-shadow: none; }

        .sticky-header-group {
            position: sticky;
            top: 0;
            z-index: 100;
            background: #fffbeb;
            width: 100%;
            padding: 20px 20px 10px 20px;
            border-bottom: 2px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .filter-toggle-btn {
            width: 100%;
            padding: 10px;
            background: #fff;
            border: 2px solid #cbd5e1;
            border-radius: 15px;
            color: #475569;
            font-family: 'Jua', sans-serif;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .filter-toggle-btn:active { background: #f1f5f9; }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            background: #fff;
            padding: 10px;
            border-radius: 15px;
            border: 2px solid #e2e8f0;
            margin-bottom: 5px;
        }

        .filter-grid.collapsed { display: none; }

        .filter-btn {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 10px;
            padding: 8px 4px;
            font-family: 'Jua', sans-serif;
            font-size: 13px;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }
        .filter-btn:active { transform: translateY(2px); }
        .filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
            font-weight: bold;
        }

        .dex-content-area { width: 100%; padding: 0 20px 50px 20px; }

        .lobby-partner-container {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 300px; height: 300px;
            z-index: 1;
            opacity: 0.5;
            pointer-events: none;
            display: flex; justify-content: center; align-items: center;
        }

        .lobby-partner-img {
            width: 100%; height: 100%;
            object-fit: contain;
            image-rendering: pixelated;
            animation: floating 3s ease-in-out infinite;
            filter: drop-shadow(0 0 20px rgba(255,255,255,0.8));
        }

        /* --- ëª¨ë‹¬ --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6);
            backdrop-filter: blur(3px);
            z-index: 150;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-box {
            background: #fff; width: 90%; max-width: 340px;
            border-radius: 25px; padding: 25px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            border: 4px solid #bae6fd;
            position: relative;
        }
        .poke-img-lg { width: 140px; height: 140px; image-rendering: pixelated; margin: 0 auto; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.2)); }

        .ball-select { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .ball-opt {
            background: #f8fafc; border: 2px solid #cbd5e1; color: #334155;
            padding: 12px; border-radius: 15px; font-size: 15px; font-family: inherit; cursor: pointer;
        }
        .ball-opt:active { background: #e2e8f0; }
        .ball-opt:disabled { opacity: 0.5; cursor: not-allowed; }
        .ball-opt img { width: 40px; height: 40px; image-rendering: pixelated; display: block; margin: 0 auto 4px; }

        .quiz-btn {
            padding: 15px; background: #fff; border: 2px solid #cbd5e1;
            color: #334155; border-radius: 15px; font-size: 20px;
            font-family: inherit; cursor: pointer; width: 100%;
            box-shadow: 0 4px 0 #cbd5e1; transition: 0.1s;
        }
        .quiz-btn:active { transform: translateY(4px); box-shadow: none; background: #f1f5f9; }

        /* ì½¤ë³´ UI ìŠ¤íƒ€ì¼ */
        .combo-container {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px; padding: 10px;
            background: #eff6ff; border-radius: 15px;
            border: 2px solid #dbeafe;
        }
        .combo-badge { font-size: 18px; font-weight: bold; color: #2563eb; }
        .rate-badge { font-size: 18px; font-weight: bold; color: #d97706; }

        .timer-badge {
            background: #fee2e2; color: #ef4444;
            padding: 5px 12px; border-radius: 20px; font-weight: bold;
            font-size: 16px; border: 2px solid #fecaca;
        }

        .pop-anim {
            animation: popEffect 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block;
        }
        @keyframes popEffect {
            0% { transform: scale(1); }
            50% { transform: scale(1.6); color: #ef4444; }
            100% { transform: scale(1); }
        }

        .stop-btn {
            margin-top: 15px; background: #fca5a5; color: #991b1b;
            border: none; padding: 10px; border-radius: 12px; width: 100%;
            font-family: inherit; font-size: 16px; cursor: pointer;
            box-shadow: 0 3px 0 #f87171;
        }
        .stop-btn:active { transform: translateY(3px); box-shadow: none; }


        /* ì• ë‹ˆë©”ì´ì…˜ ì˜ì—­ */
        .throw-scene-area {
            position: relative; width: 100%; height: 160px; margin-top: 10px; overflow: hidden; z-index: 120;
        }
        .throw-ball-img {
            position: absolute; left: 50%; bottom: 0;
            width: 80px; height: 96px;
            transform: translate(-50%, 160px) scale(0.9);
            image-rendering: pixelated; z-index: 130;
        }
        #throw-poke-img { position: relative; z-index: 110; }

        @keyframes ballThrowUp { 0% { transform: translate(-50%, 160px); } 100% { transform: translate(-50%, -64px); } }
        @keyframes ballDrop { 0% { transform: translate(-50%, -64px); } 100% { transform: translate(-50%, 0px); } }
        @keyframes ballShake {
            0% { transform: translate(-50%, 0px) rotate(0deg); filter:brightness(1); }
            25% { transform: translate(-50%, 0px) rotate(-15deg); }
            50% { transform: translate(-50%, 0px) rotate(15deg); }
            75% { transform: translate(-50%, 0px) rotate(-10deg); }
            100% { transform: translate(-50%, 0px) rotate(0deg); filter:brightness(0.6); }
        }
        @keyframes pokeDescendShrink {
            0% { transform: translateY(0px) scale(1); opacity: 1; }
            100% { transform: translateY(60px) scale(0); opacity: 0; }
        }

        .ball-throw-up { animation: ballThrowUp 0.35s ease-out forwards; }
        .ball-drop     { animation: ballDrop     0.25s ease-in  forwards; }
        .ball-shake    { animation: ballShake    0.40s ease-in-out 0s 3 forwards; }
        .poke-descend-shrink { animation: pokeDescendShrink 0.35s ease-in forwards; }
        .poke-hidden { opacity: 0; }

        .rarity-badge {
            display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 14px; font-weight: bold; margin-bottom: 5px; color: white;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-15px) scale(1.05); }
        }

        .dex-item {
            cursor: pointer;
            transition: transform 0.2s;
        }
        .dex-item:active { transform: scale(0.95); }
        .dex-item.selected-partner {
            border: 3px solid #f59e0b !important;
            background: #fffbeb !important;
            box-shadow: 0 0 15px #f59e0b;
            position: relative;
        }
        .dex-item.selected-partner::after {
            content: 'ğŸ‘‘';
            position: absolute;
            top: -10px;
            right: -10px;
            font-size: 24px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .reset-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.5);
            border: 1px solid #94a3b8;
            border-radius: 10px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            color: #64748b;
            z-index: 100;
        }
    </style>
</head>
<body>

<div class="app-container">

    <div id="view-lobby" class="view">
        <button class="reset-btn" onclick="resetGameData()">ğŸ”„ ë°ì´í„° ì´ˆê¸°í™”</button>

        <div class="title-wrapper">
            <div id="lobby-partner" class="lobby-partner-container hidden">
                <img id="lobby-partner-img" class="lobby-partner-img" src="" />
            </div>
            <h1 class="lobby-title">PokÃ©mon<br>ìˆ˜í•™ íƒí—˜ëŒ€<br><span style="font-size:20px; color:#f59e0b;">(ë°ì´í„° ë³´ì¡´ ver)</span></h1>
        </div>

        <div class="lobby-stats">ë³´ìœ  í¬ì¸íŠ¸ ğŸ’° <span id="lobby-points">0</span></div>

        <button class="btn-3d menu-btn btn-explore" onclick="startExploration()">ğŸ§­ íƒí—˜ ë– ë‚˜ê¸°</button>
        <button class="btn-3d menu-btn btn-shop" onclick="switchView('view-shop')">ğŸ›’ ìƒì  ê°€ê¸°</button>
        <button class="btn-3d menu-btn btn-dex" onclick="switchView('view-dex')">ğŸ“– í¬ì¼“ëª¬ ë„ê°</button>
    </div>

    <div id="view-game" class="view hidden">
        <div class="game-header">
            <div class="stat-badge">ë‚¨ì€ ê±¸ìŒ ğŸ¾ <span id="game-steps" style="color:#ef4444">30</span></div>
            <div class="stat-badge">ë³¼ ê°œìˆ˜ ğŸ”´ <span id="game-balls" style="color:#3b82f6">10</span></div>
        </div>
        <div class="grid-container">
            <div id="grid" class="grid"></div>
            <div id="player"><div class="player-img" id="playerSprite"></div></div>
        </div>
        <div style="text-align:center; color:#57534e; font-size:16px; margin-bottom:10px; background:#fff; padding:5px 15px; border-radius:15px;">
            ë°©í–¥í‚¤ë¥¼ ëˆŒëŸ¬ì„œ í¬ì¼“ëª¬ì„ ì°¾ì•„ë³´ì„¸ìš”!
        </div>

        <div class="d-pad">
            <button class="d-btn up" onclick="move('up')">â–²</button>
            <button class="d-btn left" onclick="move('left')">â—€</button>
            <button class="d-btn down" onclick="move('down')">â–¼</button>
            <button class="d-btn right" onclick="move('right')">â–¶</button>
        </div>
    </div>

    <div id="view-result" class="view hidden">
        <div class="result-card">
            <h2 style="margin:0; font-size:32px; color:#334155;">íƒí—˜ ë!</h2>
            <p style="color:#64748b; font-size:18px; margin-top:5px;" id="end-reason">ë°œê±¸ìŒì„ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”</p>
            <div style="background:#fef3c7; padding:15px; border-radius:20px; margin:20px 0; border:2px solid #fcd34d;">
                <div style="font-size:16px; color:#92400e;">íšë“í•œ í¬ì¸íŠ¸</div>
                <div style="font-size:40px; color:#d97706; font-weight:bold;">+<span id="result-points">0</span></div>
            </div>
            <p style="text-align:left; margin-bottom:5px; font-weight:bold; color:#475569;">ì´ë²ˆì— ì¡ì€ í¬ì¼“ëª¬:</p>
            <div class="result-list" id="result-list"></div>
            <button class="btn-3d btn-explore" style="width:100%; height:60px; margin-top:10px;" onclick="switchView('view-lobby')">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <div id="view-shop" class="view hidden">
        <div class="shop-header">
            <button class="back-btn" onclick="switchView('view-lobby')">ğŸ”™</button>
            <h2 style="margin:0; font-size:24px; color:#86198f;">ìƒì </h2>
        </div>
        <div style="width:100%; text-align:right; margin-bottom:10px; font-size:18px;">
            ë‚´ ì§€ê°‘: <span class="highlight" id="shop-points" style="font-weight:bold; color:#d97706;">0</span> P
        </div>
        <div class="shop-section">
            <h3>ğŸ”´ ëª¬ìŠ¤í„°ë³¼ êµ¬ë§¤</h3>
            <div class="shop-grid">
                <div class="shop-item"><div>ëª¬ìŠ¤í„°ë³¼</div><div class="shop-price">50 P</div><button class="buy-btn" onclick="buyItem('ball', 'monster', 50)">êµ¬ë§¤í•˜ê¸°</button></div>
                <div class="shop-item"><div>ìŠˆí¼ë³¼</div><div class="shop-price">100 P</div><button class="buy-btn" onclick="buyItem('ball', 'super', 100)">êµ¬ë§¤í•˜ê¸°</button></div>
                <div class="shop-item"><div>í•˜ì´í¼ë³¼</div><div class="shop-price">150 P</div><button class="buy-btn" onclick="buyItem('ball', 'hyper', 150)">êµ¬ë§¤í•˜ê¸°</button></div>
                <div class="shop-item"><div>ë§ˆìŠ¤í„°ë³¼</div><div class="shop-price">3000 P</div><button class="buy-btn" onclick="buyItem('ball', 'master', 3000)">êµ¬ë§¤í•˜ê¸°</button></div>
            </div>
        </div>
        <div class="shop-section">
            <h3>âš¡ ëŠ¥ë ¥ ê°•í™”í•˜ê¸°</h3>
            <div class="shop-grid">
                <div class="shop-item"><div>ğŸ‘Ÿ íŠ¼íŠ¼í•œ ì‹ ë°œ<br><span style="font-size:12px; color:#94a3b8;" id="lv-steps">Lv.0</span></div><div class="shop-price">500 P</div><button class="buy-btn" onclick="buyUpgrade('maxSteps', 500)">ê°•í™”í•˜ê¸°</button></div>

                <div class="shop-item"><div>ğŸ—‚ï¸ ë„ê° í™•ì¥<br><span style="font-size:12px; color:#94a3b8;" id="lv-dex">Lv.0</span></div><div class="shop-price">100 P</div><button class="buy-btn" onclick="buyUpgrade('dexLimit', 100)">í™•ì¥í•˜ê¸°</button></div>

                <div class="shop-item"><div>ğŸ€ í–‰ìš´ì˜ ë¶€ì <br><span style="font-size:12px; color:#94a3b8;" id="lv-rate">Lv.0 (Max 10)</span></div><div class="shop-price">800 P</div><button class="buy-btn" id="btn-buy-rate" onclick="buyUpgrade('catchRate', 800)">ê°•í™”í•˜ê¸°</button></div>
            </div>
        </div>
    </div>

    <div id="view-dex" class="view hidden">
        <div class="sticky-header-group">
            <div class="shop-header">
                <button class="back-btn" onclick="switchView('view-lobby')">ğŸ”™</button>
                <h2 style="margin:0; font-size:24px; color:#92400e;">í¬ì¼“ëª¬ ë„ê°</h2>
            </div>

            <button class="filter-toggle-btn" onclick="toggleFilterGrid()">
                <span>ğŸ” í•„í„° ì˜µì…˜</span>
                <span id="toggle-icon">ğŸ”½</span>
            </button>
            <div id="dex-filter-container" class="filter-grid">
            </div>
        </div>

        <div class="dex-content-area">
            <p style="font-size:18px; margin:15px 0;">
                ë“±ë¡ëœ í¬ì¼“ëª¬: <span id="dex-count" style="font-weight:bold; color:#d97706;">0</span> / <span id="dex-limit-display">30</span>
            </p>
            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; width:100%;" id="dex-grid"></div>
        </div>
    </div>

</div>

<div id="modal-layer" class="modal-overlay hidden">
    <div id="modal-encounter" class="modal-box hidden">
        <div id="enc-badge-area"></div>
        <h3 style="color:#ef4444; font-size:24px; margin:0 0 10px 0;">ì•¼ìƒì˜ í¬ì¼“ëª¬!</h3>
        <img id="enc-img" src="" class="poke-img-lg" />
        <h2 id="enc-name" style="font-size:28px; margin:10px 0;">???</h2>
        <p style="font-size:16px; color:#f59e0b; font-weight:bold; margin:0;">ê¸°ë³¸ í™•ë¥ : <span id="enc-rate"></span>%</p>

        <div class="ball-select">
            <button class="ball-opt" id="btn-use-monster" onclick="tryCatch('monster')"><img src="./png/pb.png">ëª¬ìŠ¤í„°ë³¼<br>x<span id="qty-monster">0</span></button>
            <button class="ball-opt" id="btn-use-super" onclick="tryCatch('super')"><img src="./png/gb.png">ìŠˆí¼ë³¼<br>x<span id="qty-super">0</span></button>
            <button class="ball-opt" id="btn-use-hyper" onclick="tryCatch('hyper')"><img src="./png/ub.png">í•˜ì´í¼ë³¼<br>x<span id="qty-hyper">0</span></button>
            <button class="ball-opt" id="btn-use-master" onclick="tryCatch('master')"><img src="./png/mb.png">ë§ˆìŠ¤í„°ë³¼<br>x<span id="qty-master">0</span></button>
        </div>
        <button style="margin-top:20px; background:#94a3b8; padding:12px; border:none; color:white; border-radius:15px; width:100%; font-size:18px; font-family:inherit; cursor:pointer;" onclick="runAway()">ğŸƒ ë„ë§ê°€ê¸°</button>
    </div>

    <div id="modal-quiz" class="modal-box hidden">
        <div class="combo-container">
            <div class="combo-badge">Combo: <span id="quiz-combo-val">0</span>/10</div>
            <div class="timer-badge" id="quiz-timer">â³ 10</div>
            <div class="rate-badge">í™•ë¥ : <span id="quiz-prob-val">0</span>%</div>
        </div>

        <h3 style="color:#0ea5e9; font-size:24px; margin-top:0;">êµ¬êµ¬ë‹¨ ë¯¸ì…˜!</h3>
        <p id="quiz-txt" style="font-size:32px; margin:20px 0; font-weight:bold; color:#334155;"></p>
        <div id="quiz-opts" style="display:flex; flex-direction:column; gap:12px;"></div>

        <button class="stop-btn" onclick="finishComboAndThrow()">âœ‹ ë©ˆì¶”ê³  ì§€ê¸ˆ ë˜ì§€ê¸°!</button>
    </div>

    <div id="modal-throw" class="modal-box hidden">
        <h3 style="color:#f97316; font-size:24px; margin-top:0;">í¬ì¼“ë³¼ì„ ë˜ì¡Œë‹¤!</h3>
        <img id="throw-poke-img" src="" class="poke-img-lg" />
        <div class="throw-scene-area"><img id="throw-ball-img" class="throw-ball-img" /></div>
        <p style="font-size:16px; color:#64748b; margin-top:10px;">í¬ì¼“ë³¼ì´ í”ë“¤ë¦¬ê³  ìˆì–´ìš”...</p>
    </div>

    <div id="modal-msg" class="modal-box hidden">
        <h2 id="msg-title" style="font-size:32px; margin:10px 0;">ê²°ê³¼</h2>
        <img id="msg-img" src="" style="width:100px; height:100px; image-rendering:pixelated;" />
        <p id="msg-desc" style="font-size:18px; color:#475569; margin:15px 0; line-height:1.4;"></p>
        <button onclick="closeMsgModal()" style="background:#4ade80; padding:15px; width:100%; border:none; color:#064e3b; border-radius:15px; font-weight:bold; font-size:20px; cursor:pointer;">í™•ì¸</button>
    </div>

    <div id="modal-step-buy" class="modal-box hidden">
        <h3 style="color:#eab308; font-size:26px; margin-top:0;">ë°œê±¸ìŒ ë¶€ì¡±!</h3>
        <p style="font-size:18px; color:#475569; margin:15px 0;">
            ë” ì´ìƒ ê±¸ì„ ìˆ˜ ì—†ì–´ìš” ğŸ’¦<br>
            <span style="font-weight:bold; color:#d97706;">100í¬ì¸íŠ¸</span>ë¡œ<br>
            <span style="font-weight:bold; color:#16a34a;">10ê±¸ìŒ</span>ì„ ì¶©ì „í•˜ì‹œê² ì–´ìš”?
        </p>
        <div style="display:flex; gap:10px;">
            <button onclick="endExploration('steps')" style="flex:1; background:#94a3b8; color:white; border:none; padding:12px; border-radius:15px; font-size:18px;">ì¢…ë£Œí•˜ê¸°</button>
            <button onclick="buySteps()" style="flex:1; background:#16a34a; color:white; border:none; padding:12px; border-radius:15px; font-size:18px;">ì¶©ì „í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    const TILE_IMGS = ["./png/Tile0.png", "./png/Tile1.png", "./png/Tile2.png", "./png/Tile3.png"];
    const MAX_POKEMON_ID = 1025;

    // --- [ì¤‘ìš”] ë°ì´í„° ë²„ì „ ê´€ë¦¬ ---
    const SAVE_KEY = "poke_spell_game_data_v4"; // í˜„ì¬ ë²„ì „
    const PREVIOUS_KEYS = ["poke_spell_game_data_v3", "poke_spell_game_data_v2"]; // ë§ˆì´ê·¸ë ˆì´ì…˜ ëŒ€ìƒ

    // --- [ì¤‘ìš”] í¬ê·€ í¬ì¼“ëª¬ ë¦¬ìŠ¤íŠ¸ ---
    const LEGENDARY_IDS = [
        144,145,146,150,151, 243,244,245,249,250,251, 382,383,384,385,386,
        483,484,487,491,492,493, 643,644,646,649, 716,717,718,
        785,786,787,788,800,801,802,807, 888,889,890,891,892,898,
        1007,1008,1017,1024,1025
    ];

    const RARE_IDS = [
        1,4,7, 25, 133, 143, 149, 152,155,158, 212, 248,
        252,255,258, 282, 373, 376, 445, 448, 495,498,501, 635, 650, 653,
        722,725,728, 810,813,816, 887, 906,909,912, 996, 997, 998
    ];

    const BALL_SPRITES = { monster: "./png/pb.png", super: "./png/gb.png", hyper: "./png/ub.png", master: "./png/mb.png" };
    const BALL_OPEN_SPRITES = { monster: "./png/pb_open.png", super: "./png/gb_open.png", hyper: "./png/ub_open.png", master: "./png/mb_open.png" };
    const BALL_OPENING_SPRITES = { monster: "./png/pb_opening.png", super: "./png/gb_opening.png", hyper: "./png/ub_opening.png", master: "./png/mb_opening.png" };

    let user = {
        points: 0,
        inventory: { monster: 0, super: 0, hyper: 0, master: 0 },
        dex: new Set(),
        upgrades: { maxSteps: 0, dexLimit: 0, catchRate: 0 },
        partnerId: null
    };
    let session = { active: false, steps: 0, caught: [], earnedPoints: 0 };
    let player = { x: 4, y: 4 };
    let tileMap = [];
    let currentPokemon = null;
    let silhouettePos = { x: -1, y: -1 };
    let isMoving = false;

    // í€´ì¦ˆ ê´€ë ¨ ë³€ìˆ˜
    let selectedBall = null;
    let currentQuiz = null;
    let currentCombo = 0;
    const MAX_COMBO = 10;
    let lastCapture = null;

    // íƒ€ì´ë¨¸ ê´€ë ¨
    let quizTimerInterval = null;
    const QUIZ_TIME_LIMIT = 10; // ì´ˆ

    // í•„í„° ë³€ìˆ˜
    let currentFilter = 'owned';
    let isFilterCollapsed = false;

    async function init() {
        loadGame();
        initDexFilter();
        updateLobbyUI();
    }

    function initDexFilter() {
        const container = document.getElementById('dex-filter-container');
        container.innerHTML = "";
        createFilterBtn(container, 'owned', 'âœ… ë³´ìœ ');
        for (let i = 0; i < 11; i++) {
            const start = i * 100 + 1;
            const end = (i + 1) * 100;
            if (start > MAX_POKEMON_ID) break;
            const label = `${start}~${end}`;
            const value = `${start}-${end}`;
            createFilterBtn(container, value, label);
        }
    }

    function createFilterBtn(container, value, label) {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        if (value === currentFilter) btn.classList.add('active');
        btn.textContent = label;
        btn.onclick = (e) => {
            currentFilter = value;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            renderDex();
        };
        container.appendChild(btn);
    }

    function toggleFilterGrid(forceClose = false) {
        const grid = document.getElementById('dex-filter-container');
        const icon = document.getElementById('toggle-icon');
        if (forceClose || !isFilterCollapsed) {
            grid.classList.add('collapsed');
            icon.textContent = 'â—€';
            isFilterCollapsed = true;
        } else {
            grid.classList.remove('collapsed');
            icon.textContent = 'ğŸ”½';
            isFilterCollapsed = false;
        }
    }

    function saveGame() {
        try {
            const data = { ...user, dex: Array.from(user.dex) };
            localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        } catch(e) { console.error("Save failed", e); }
    }

    function loadGame() {
        try {
            // 1. í˜„ì¬ ë²„ì „ ë°ì´í„° ë¡œë“œ ì‹œë„
            let saved = localStorage.getItem(SAVE_KEY);

            // 2. í˜„ì¬ ë²„ì „ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì´ì „ ë²„ì „ì—ì„œ ì°¾ê¸° (ë§ˆì´ê·¸ë ˆì´ì…˜)
            if (!saved) {
                for (let oldKey of PREVIOUS_KEYS) {
                    const oldData = localStorage.getItem(oldKey);
                    if (oldData) {
                        console.log(`[Migration] Found old data in ${oldKey}. Migrating to ${SAVE_KEY}...`);
                        saved = oldData;
                        // ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ (ìƒˆ í‚¤ì— ì €ì¥)
                        localStorage.setItem(SAVE_KEY, saved);
                        break; // ê°€ì¥ ìµœì‹  êµ¬ë²„ì „ì„ ì°¾ìœ¼ë©´ ì¤‘ë‹¨
                    }
                }
            }

            // 3. ë°ì´í„° íŒŒì‹±
            if(saved) {
                const parsed = JSON.parse(saved);
                user = { ...user, ...parsed, dex: new Set(parsed.dex || []) };
                // í˜¸í™˜ì„± ì²˜ë¦¬
                if(user.upgrades.startBalls !== undefined) delete user.upgrades.startBalls;
                if(user.upgrades.dexLimit === undefined) user.upgrades.dexLimit = 0;

                console.log("Game loaded successfully!");
            }
        } catch(e) { console.error("Load failed", e); }
    }

    function resetGameData() {
        if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem(SAVE_KEY);
            location.reload();
        }
    }

    // --- [êµ¬êµ¬ë‹¨ ë¬¸ì œ ìƒì„±ê¸°] ---
    function generateGuGuDan() {
        const num1 = Math.floor(Math.random() * 8) + 2;
        const num2 = Math.floor(Math.random() * 9) + 1;
        const ans = num1 * num2;

        let choices = new Set();
        choices.add(ans);
        while(choices.size < 4) {
            let wrong;
            if (Math.random() < 0.5) wrong = ans + (Math.floor(Math.random() * 10) - 5) * 2;
            else wrong = (Math.floor(Math.random() * 8) + 2) * (Math.floor(Math.random() * 9) + 1);
            if (wrong > 0 && wrong !== ans) choices.add(wrong);
        }

        let finalChoices = Array.from(choices);
        for (let i = finalChoices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [finalChoices[i], finalChoices[j]] = [finalChoices[j], finalChoices[i]];
        }

        return {
            prompt: `${num1} Ã— ${num2} = ?`,
            choices: finalChoices,
            answerIndex: finalChoices.indexOf(ans)
        };
    }

    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');
        if(viewId === 'view-shop') updateShopUI();
        if(viewId === 'view-dex') renderDex();
        if(viewId === 'view-lobby') updateLobbyUI();
    }

    function setPartner(id) {
        if(user.partnerId === id) {
            user.partnerId = null;
            alert("íŒŒíŠ¸ë„ˆ ì„¤ì •ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            user.partnerId = id;
            alert("ë¡œë¹„ íŒŒíŠ¸ë„ˆë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }
        saveGame();
        renderDex();
    }

    function updateLobbyUI() {
        document.getElementById('lobby-points').textContent = user.points;
        const partnerContainer = document.getElementById('lobby-partner');
        const partnerImg = document.getElementById('lobby-partner-img');
        if (user.partnerId) {
            partnerContainer.classList.remove('hidden');
            partnerImg.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${user.partnerId}.png`;
        } else {
            partnerContainer.classList.add('hidden');
            partnerImg.src = "";
        }
    }

    function startExploration() {
        const baseSteps = 30 + (user.upgrades.maxSteps * 10);
        const bonusBalls = 10;
        session = { active: true, steps: baseSteps, caught: [], earnedPoints: 0 };
        if (user.inventory.monster < bonusBalls) {
            user.inventory.monster = bonusBalls;
            saveGame();
        }
        generateMap();
        player = { x: 4, y: 4 };
        updatePlayerPos();
        updateGameHeader();
        switchView('view-game');
        removeSilhouette();
        spawnPokemon();
    }

    function endExploration(reason) {
        if (reason === 'steps' && document.getElementById('modal-step-buy').classList.contains('hidden')) {
            showStepBuyModal();
            return;
        }

        session.active = false;
        document.getElementById('end-reason').textContent = reason === 'steps' ? "ë°œê±¸ìŒì„ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”!" : "í¬ì¼“ë³¼ì´ ë‹¤ ë–¨ì–´ì¡Œì–´ìš”!";
        document.getElementById('result-points').textContent = session.earnedPoints;
        const listEl = document.getElementById('result-list');
        listEl.innerHTML = "";
        if(session.caught.length === 0) listEl.innerHTML = "<p style='width:100%; text-align:center; font-size:14px; color:#94a3b8;'>ì•„ë¬´ê²ƒë„ ëª» ì¡ì•˜ì–´ìš”...</p>";
        session.caught.forEach(p => {
            const div = document.createElement('div');
            div.className = 'result-poke';
            div.innerHTML = `<img src="${p.sprite}">`;
            listEl.appendChild(div);
        });

        document.getElementById('modal-layer').classList.add('hidden');
        document.getElementById('modal-step-buy').classList.add('hidden');

        switchView('view-result');
        saveGame();
    }

    function generateMap() {
        const grid = document.getElementById('grid');
        grid.innerHTML = "";
        tileMap = [];
        for(let y=0; y<9; y++){
            let row = [];
            for(let x=0; x<9; x++){
                const t = Math.floor(Math.random()*4);
                row.push(t);
                const div = document.createElement('div');
                div.className = 'tile';
                div.style.backgroundImage = `url('${TILE_IMGS[t]}')`;
                div.dataset.x = x; div.dataset.y = y;
                grid.appendChild(div);
            }
            tileMap.push(row);
        }
    }

    function move(dir) {
        if(!session.active || isMoving) return;
        let nx = player.x, ny = player.y;
        if(dir === 'up') ny--;
        if(dir === 'down') ny++;
        if(dir === 'left') nx--;
        if(dir === 'right') nx++;
        if(nx < 0 || nx >= 9 || ny < 0 || ny >= 9) return;

        isMoving = true;
        player.x = nx; player.y = ny;
        session.steps--;
        const frames = { up:[6,7,8], down:[0,1,2], left:[9,10,11], right:[3,4,5] };
        animateSprite(frames[dir] || frames.down);
        updatePlayerPos();
        updateGameHeader();
        setTimeout(() => {
            isMoving = false;
            if(session.steps <= 0) { endExploration('steps'); return; }
            if(player.x === silhouettePos.x && player.y === silhouettePos.y) startEncounter();
        }, 300);
    }

    function updateGameHeader() {
        document.getElementById('game-steps').textContent = session.steps;
        document.getElementById('game-balls').textContent = user.inventory.monster + user.inventory.super + user.inventory.hyper + user.inventory.master;
    }

    function animateSprite(frames) {
        let idx = 0;
        const interval = setInterval(() => {
            const frame = frames[idx % 3];
            document.getElementById('playerSprite').style.backgroundPosition = `${(frame / 11) * 100}% 50%`;
            idx++;
        }, 100);
        setTimeout(() => clearInterval(interval), 300);
    }

    function updatePlayerPos() {
        document.getElementById('player').style.transform = `translate(${player.x*100}%, ${player.y*100}%)`;
    }

    function removeSilhouette() {
        document.querySelectorAll('.tile.silhouette').forEach(t => {
            t.classList.remove('silhouette', 'legendary');
            const img = t.querySelector('.silhouette-img');
            if (img) img.remove();
        });
        silhouettePos = { x: -1, y: -1 };
    }

    function getWeightedRandomId() {
        const roll = Math.random();
        if(roll < 0.02) return { id: LEGENDARY_IDS[Math.floor(Math.random() * LEGENDARY_IDS.length)], rarity: 'legendary' };
        else if (roll < 0.15) return { id: RARE_IDS[Math.floor(Math.random() * RARE_IDS.length)], rarity: 'rare' };
        else return { id: Math.floor(Math.random() * MAX_POKEMON_ID) + 1, rarity: 'common' };
    }

    async function spawnPokemon() {
        removeSilhouette();
        let x, y;
        do { x = Math.floor(Math.random() * 9); y = Math.floor(Math.random() * 9); } while (x === player.x && y === player.y);
        silhouettePos = { x, y };
        currentPokemon = null;
        const targetTile = document.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`);
        const spawnData = getWeightedRandomId();
        const id = spawnData.id;
        const rarity = spawnData.rarity;

        try {
            const res = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`);
            const data = await res.json();
            const name = data.names.find((n) => n.language.name === "ko")?.name || data.name;
            const spriteUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;
            const backupUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;

            currentPokemon = { id, name, rate: data.capture_rate, sprite: spriteUrl, rarity };

            if (targetTile) {
                targetTile.classList.add("silhouette");
                if(rarity === 'legendary') targetTile.classList.add("legendary");
                const img = document.createElement("img");
                img.className = "silhouette-img";
                img.onerror = function() {
                    if (this.src === spriteUrl) this.src = backupUrl;
                    else if (this.src === backupUrl) { this.src = "./png/pb.png"; this.style.filter = "none"; }
                };
                img.src = spriteUrl;
                targetTile.appendChild(img);
            }
        } catch (e) { console.error("Spawn Error", e); }
    }

    function startEncounter() {
        if(!currentPokemon) return;
        if((user.inventory.monster + user.inventory.super + user.inventory.hyper + user.inventory.master) <= 0) {
            endExploration('balls'); return;
        }
        document.getElementById('modal-layer').classList.remove('hidden');
        document.getElementById('modal-encounter').classList.remove('hidden');
        document.getElementById('enc-img').src = currentPokemon.sprite;
        document.getElementById('enc-name').textContent = currentPokemon.name;

        const badgeArea = document.getElementById('enc-badge-area');
        badgeArea.innerHTML = "";
        if(currentPokemon.rarity === 'legendary') badgeArea.innerHTML = `<span class="rarity-badge" style="background:#ef4444;">ğŸŒŸ ì „ì„¤/í™˜ìƒ</span>`;
        else if (currentPokemon.rarity === 'rare') badgeArea.innerHTML = `<span class="rarity-badge" style="background:#3b82f6;">âœ¨ í¬ê·€</span>`;

        let baseRate = (currentPokemon.rate / 255);
        if (!baseRate) baseRate = 0.1;
        baseRate = baseRate * 2.5;
        baseRate += (user.upgrades.catchRate * 0.005);
        if(baseRate > 0.95) baseRate = 0.95;
        if(baseRate < 0.05) baseRate = 0.05;

        document.getElementById('enc-rate').textContent = Math.floor(baseRate*100);
        updateBallBtns();
    }

    function updateBallBtns() {
        ['monster','super','hyper','master'].forEach(type => {
            const qty = user.inventory[type];
            document.getElementById(`qty-${type}`).textContent = qty;
            document.getElementById(`btn-use-${type}`).disabled = (qty <= 0);
        });
    }

    function tryCatch(ballType) {
        if(user.inventory[ballType] <= 0) return;
        selectedBall = ballType;
        user.inventory[selectedBall]--;
        updateGameHeader();

        document.getElementById('modal-encounter').classList.add('hidden');
        document.getElementById('modal-quiz').classList.remove('hidden');

        currentCombo = 0;
        nextQuizStep();
    }

    function nextQuizStep() {
        updateComboUI();
        if(currentCombo >= MAX_COMBO) {
            finishComboAndThrow();
            return;
        }

        currentQuiz = generateGuGuDan();
        document.getElementById('quiz-txt').textContent = currentQuiz.prompt;

        const optsDiv = document.getElementById('quiz-opts');
        optsDiv.innerHTML = "";
        currentQuiz.choices.forEach((c, idx) => {
            const btn = document.createElement('button');
            btn.className = 'quiz-btn';
            btn.textContent = c;
            btn.onclick = () => handleAnswer(idx === currentQuiz.answerIndex);
            optsDiv.appendChild(btn);
        });

        startQuizTimer();
    }

    function startQuizTimer() {
        if(quizTimerInterval) clearInterval(quizTimerInterval);
        let timeLeft = QUIZ_TIME_LIMIT;
        document.getElementById('quiz-timer').textContent = `â³ ${timeLeft}`;

        quizTimerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('quiz-timer').textContent = `â³ ${timeLeft}`;
            if (timeLeft <= 0) {
                clearInterval(quizTimerInterval);
                handleAnswer(false);
            }
        }, 1000);
    }

    function updateComboUI() {
        const comboEl = document.getElementById('quiz-combo-val');
        const probEl = document.getElementById('quiz-prob-val');

        const p = calculateCatchProb();
        comboEl.textContent = currentCombo;
        probEl.textContent = Math.floor(p * 100);

        triggerPopAnim(comboEl);
        triggerPopAnim(probEl);
    }

    function triggerPopAnim(element) {
        element.classList.remove('pop-anim');
        void element.offsetWidth;
        element.classList.add('pop-anim');
    }

    function calculateCatchProb() {
        let rate = currentPokemon.rate / 255;
        if(!rate) rate = 0.1;

        const ballBonus = { monster:1, super:1.5, hyper:2.0, master:255 }[selectedBall];
        const upgradeBonus = 1 + (user.upgrades.catchRate * 0.005);
        const balancePatchMultiplier = 2.5;
        const comboBonus = 1 + (currentCombo * 0.1);
        const DIFFICULTY_NERF = 0.65;

        let p = rate * ballBonus * upgradeBonus * balancePatchMultiplier * comboBonus * DIFFICULTY_NERF;

        if(selectedBall === 'master') p = 1;
        if(p > 1) p = 1;

        return p;
    }

    function handleAnswer(isCorrect) {
        if(quizTimerInterval) clearInterval(quizTimerInterval);

        if (isCorrect) {
            currentCombo++;
            nextQuizStep();
        } else {
            currentCombo = 0;
            alert("í‹€ë ¸ê±°ë‚˜ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤! ì½¤ë³´ê°€ ì´ˆê¸°í™”ë˜ì–´ ë³¼ì´ ë˜ì ¸ì§‘ë‹ˆë‹¤!");
            finishComboAndThrow(false);
        }
    }

    function finishComboAndThrow(isSuccessFlow = true) {
        if(quizTimerInterval) clearInterval(quizTimerInterval);
        document.getElementById('modal-quiz').classList.add('hidden');

        const finalProb = calculateCatchProb();
        const isCaught = Math.random() < finalProb;

        let titleText, titleColor, descHtml;

        if(isCaught) {
            titleText = "ì¡ì•˜ë‹¤!";
            titleColor = "#4ade80";
            let pts = 100;
            if(currentPokemon.rarity === 'legendary') pts = 500;
            else if(currentPokemon.rarity === 'rare') pts = 200;

            const dexLimit = 30 + (user.upgrades.dexLimit * 10);
            const isNew = !user.dex.has(currentPokemon.id);
            const isFull = user.dex.size >= dexLimit;

            if(isNew) {
                if(isFull) {
                    descHtml = `${currentPokemon.name}!<br><span style='font-size:14px; color:#ef4444;'>ë„ê°ì´ ê°€ë“ ì°¨ì„œ í¬ì¸íŠ¸ë§Œ ë°›ìŠµë‹ˆë‹¤. (+${pts}P)</span>`;
                    user.points += pts;
                } else {
                    user.dex.add(currentPokemon.id);
                    descHtml = `${currentPokemon.name}!<br><span style='font-size:14px; color:#f59e0b;'>ìƒˆë¡œìš´ ì¹œêµ¬! (+${pts}P)</span>`;
                    user.points += pts;
                }
            } else {
                pts = Math.floor(pts / 2);
                descHtml = `${currentPokemon.name}!<br><span style='font-size:14px; color:#94a3b8;'>ë˜ ì¡ì•˜ë„¤ìš” (+${pts}P)</span>`;
                user.points += pts;
            }
            session.earnedPoints += pts;
            session.caught.push({ name: currentPokemon.name, sprite: currentPokemon.sprite });
        } else {
            titleText = "ë†“ì³¤ë‹¤...";
            titleColor = "#f87171";
            descHtml = `${currentPokemon.name}ì´(ê°€) ë„ë§ê°”ì–´ìš”.`;
        }

        saveGame();
        descHtml += `<br><br><span style="font-size:14px; color:#64748b;">(ì½¤ë³´: ${currentCombo}, í™•ë¥ : ${Math.floor(finalProb*100)}%)</span>`;

        lastCapture = { titleText, titleColor, descHtml };
        removeSilhouette();
        showThrowAnimation();
    }

    function showThrowAnimation() {
        const layer = document.getElementById("modal-layer");
        const throwModal = document.getElementById("modal-throw");
        const pokeImg = document.getElementById("throw-poke-img");
        const ballImg = document.getElementById("throw-ball-img");

        layer.classList.remove("hidden");
        throwModal.classList.remove("hidden");

        pokeImg.src = currentPokemon.sprite;
        pokeImg.classList.remove("poke-descend-shrink", "poke-hidden");
        pokeImg.style.transform = "";
        pokeImg.style.opacity = "1";

        const closedSprite = BALL_SPRITES[selectedBall];
        const openSprite = BALL_OPEN_SPRITES[selectedBall];
        const openingSprite = BALL_OPENING_SPRITES[selectedBall];

        ballImg.src = closedSprite;
        ballImg.classList.remove("ball-throw-up", "ball-drop", "ball-shake");
        void ballImg.offsetWidth;
        ballImg.classList.add("ball-throw-up");

        ballImg.onanimationend = (e) => {
            if (e.animationName === "ballThrowUp") {
                ballImg.src = openSprite;
                pokeImg.classList.remove("poke-descend-shrink", "poke-hidden");
                pokeImg.style.transform = ""; pokeImg.style.opacity = "1"; void pokeImg.offsetWidth;
                pokeImg.classList.add("poke-descend-shrink");
                pokeImg.onanimationend = () => {
                    pokeImg.classList.add("poke-hidden");
                    ballImg.src = openSprite;
                    setTimeout(() => {
                        ballImg.src = openingSprite;
                        setTimeout(() => {
                            ballImg.src = closedSprite;
                            ballImg.classList.remove("ball-throw-up"); void ballImg.offsetWidth;
                            ballImg.classList.add("ball-drop");
                        }, 80);
                    }, 80);
                };
            } else if (e.animationName === "ballDrop") {
                ballImg.classList.remove("ball-drop"); void ballImg.offsetWidth;
                ballImg.classList.add("ball-shake");
            } else if (e.animationName === "ballShake") {
                ballImg.onanimationend = null;
                throwModal.classList.add("hidden");
                showResultModal();
            }
        };
    }

    function showResultModal() {
        const layer = document.getElementById('modal-layer');
        const msgModal = document.getElementById('modal-msg');
        layer.classList.remove('hidden');
        msgModal.classList.remove('hidden');
        document.getElementById('msg-img').src = currentPokemon.sprite;
        if (lastCapture) {
            const titleEl = document.getElementById('msg-title');
            titleEl.textContent = lastCapture.titleText;
            titleEl.style.color = lastCapture.titleColor;
            document.getElementById('msg-desc').innerHTML = lastCapture.descHtml;
        }
    }

    function closeMsgModal() {
        document.getElementById('modal-layer').classList.add('hidden');
        document.getElementById('modal-msg').classList.add('hidden');
        removeSilhouette();
        if((user.inventory.monster + user.inventory.super + user.inventory.hyper + user.inventory.master) <= 0) endExploration('balls');
        else spawnPokemon();
    }

    function runAway() {
        document.getElementById('modal-layer').classList.add('hidden');
        document.getElementById('modal-encounter').classList.add('hidden');
        removeSilhouette();
        spawnPokemon();
    }

    function updateShopUI() {
        document.getElementById('shop-points').textContent = user.points;
        document.getElementById('lv-steps').textContent = `Lv.${user.upgrades.maxSteps}`;
        document.getElementById('lv-dex').textContent = `Lv.${user.upgrades.dexLimit} (í˜„ì¬ ${30 + user.upgrades.dexLimit * 10}ë§ˆë¦¬)`;
        const rateLv = user.upgrades.catchRate;
        document.getElementById('lv-rate').textContent = `Lv.${rateLv} (í™•ë¥  +${(rateLv * 0.5).toFixed(1)}%)`;
        const rateBtn = document.getElementById('btn-buy-rate');
        if(rateLv >= 10) {
            rateBtn.disabled = true;
            rateBtn.textContent = "Max Level";
        } else {
            rateBtn.disabled = false;
            rateBtn.textContent = "ê°•í™”í•˜ê¸°";
        }
    }

    function buyItem(cat, type, cost) {
        if(user.points < cost) { alert("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•´ìš”!"); return; }
        user.points -= cost;
        user.inventory[type]++;
        saveGame();
        updateShopUI();
    }

    function buyUpgrade(key, cost) {
        if(user.points < cost) { alert("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•´ìš”!"); return; }
        if(key === 'catchRate' && user.upgrades.catchRate >= 10) {
            alert("ì´ë¯¸ ìµœê³  ë ˆë²¨ì…ë‹ˆë‹¤!"); return;
        }
        user.points -= cost;
        user.upgrades[key]++;
        saveGame();
        updateShopUI();
    }

    function renderDex() {
        const dexLimit = 30 + (user.upgrades.dexLimit * 10);
        document.getElementById('dex-count').textContent = user.dex.size;
        document.getElementById('dex-limit-display').textContent = dexLimit;

        const grid = document.getElementById('dex-grid');
        grid.innerHTML = "";
        const hint = document.createElement('p');
        hint.style.cssText = "grid-column: 1 / -1; text-align: center; color: #64748b; font-size: 14px; margin-bottom: 10px;";
        hint.textContent = `ë„ê° ìš©ëŸ‰: ${dexLimit}ë§ˆë¦¬ (ìƒì ì—ì„œ í™•ì¥ ê°€ëŠ¥)`;
        grid.appendChild(hint);

        const filterVal = currentFilter;
        let start = 1, end = MAX_POKEMON_ID;
        let showOnlyOwned = false;

        if (filterVal === 'owned') showOnlyOwned = true;
        else {
            const parts = filterVal.split('-');
            start = parseInt(parts[0]);
            end = parseInt(parts[1]);
        }

        if (showOnlyOwned) {
            const ownedIds = Array.from(user.dex).sort((a,b)=>a-b);
            if (ownedIds.length === 0) {
                const msg = document.createElement('div');
                msg.textContent = "ì•„ì§ ì¡ì€ í¬ì¼“ëª¬ì´ ì—†ì–´ìš”!";
                msg.style.cssText = "grid-column: 1/-1; text-align:center; color:#94a3b8; margin-top:20px;";
                grid.appendChild(msg);
                return;
            }
            ownedIds.forEach(id => createDexCard(id, true));
        } else {
            for(let i=start; i<=end; i++) {
                if(i > MAX_POKEMON_ID) break;
                const has = user.dex.has(i);
                createDexCard(i, has);
            }
        }

        function createDexCard(id, has) {
            const d = document.createElement('div');
            d.className = 'dex-item';
            d.style.cssText = "aspect-ratio:1; background:#fff; border-radius:15px; display:flex; justify-content:center; align-items:center; border:2px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;";
            if(has) {
                d.innerHTML = `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png'" style="width:80%; image-rendering:pixelated;" loading="lazy">`;
                d.style.borderColor = "#4ade80";
                d.style.background = "#f0fdf4";
                if(user.partnerId === id) d.classList.add('selected-partner');
                d.onclick = () => setPartner(id);
            } else {
                d.textContent = id;
                d.style.color = "#cbd5e1";
                d.style.fontSize = "14px";
                d.style.fontWeight = "bold";
            }
            grid.appendChild(d);
        }
    }

    function showStepBuyModal() {
        document.getElementById('modal-layer').classList.remove('hidden');
        document.getElementById('modal-step-buy').classList.remove('hidden');
    }

    function buySteps() {
        if (user.points >= 100) {
            user.points -= 100;
            session.steps += 10;
            saveGame();
            updateGameHeader();
            document.getElementById('modal-layer').classList.add('hidden');
            document.getElementById('modal-step-buy').classList.add('hidden');
            alert("10ê±¸ìŒì´ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤! íƒí—˜ì„ ê³„ì†í•˜ì„¸ìš”.");
        } else {
            alert("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤...");
            endExploration('steps');
        }
    }

    init();
</script>
</body>
</html>