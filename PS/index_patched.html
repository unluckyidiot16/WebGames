<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>í¬ì¼“ëª¬ íƒí—˜ëŒ€ (ìŠ¤í”¼ë“œë³¼ ì¶”ê°€ ver)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <script>window.location.href = "https://unluckyidiot16.github.io/WebGames/PTG/index_patched.html";</script>
</head>
<body>

<div class="app-container">

    <div id="view-lobby" class="view">
        <button class="reset-btn" onclick="resetGameData()">ğŸ”„ ë°ì´í„° ì´ˆê¸°í™”</button>

        <div class="title-wrapper">
            <div id="lobby-partner" class="lobby-partner-container hidden">
                <img id="lobby-partner-img" class="lobby-partner-img" src="" />
            </div>
            <h1 class="lobby-title">PokÃ©mon<br>í€´ì¦ˆ íƒí—˜ëŒ€<br><span style="font-size:20px; color:#f59e0b;">(ìŠ¤í”¼ë“œë³¼ ì¶”ê°€ ver)</span></h1>
        </div>

        <div class="lobby-stats">ë³´ìœ  í¬ì¸íŠ¸ ğŸ’° <span id="lobby-points">0</span></div>

        <button class="btn-3d menu-btn btn-explore" onclick="startExploration()">ğŸ§­ íƒí—˜ ë– ë‚˜ê¸°</button>
        <button class="btn-3d menu-btn btn-shop" onclick="switchView('view-shop')">ğŸ›’ ìƒì  ê°€ê¸°</button>
        <button class="btn-3d menu-btn btn-dex" onclick="switchView('view-dex')">ğŸ“– í¬ì¼“ëª¬ ë„ê°</button>
        <button class="btn-3d menu-btn btn-pixel" onclick="goToPixel()">ğŸ¨ ìƒ‰ì¹ í•˜ëŸ¬ ê°€ê¸°</button>
    </div>

    <div id="view-game" class="view hidden">
        <div class="game-header">
            <div class="stat-badge">ë‚¨ì€ ê±¸ìŒ ğŸ¾ <span id="game-steps" style="color:#ef4444">30</span></div>
            <div class="stat-badge">ë³¼ ê°œìˆ˜ ğŸ”´ <span id="game-balls" style="color:#3b82f6">10</span></div>
        </div>
        <div class="grid-container">
            <div id="grid" class="grid"></div>
            <div id="player"><div class="player-img" id="playerSprite"></div></div>
        </div>
        <div style="text-align:center; color:#57534e; font-size:16px; margin-bottom:10px; background:#fff; padding:5px 15px; border-radius:15px;">
            ë°©í–¥í‚¤ë¡œë„ ì´ë™í•  ìˆ˜ ìˆì–´ìš”!
        </div>

        <div class="d-pad">
            <button class="d-btn up" onclick="move('up')">â–²</button>
            <button class="d-btn left" onclick="move('left')">â—€</button>
            <button class="d-btn down" onclick="move('down')">â–¼</button>
            <button class="d-btn right" onclick="move('right')">â–¶</button>
        </div>
    </div>

    <div id="view-result" class="view hidden">
        <div class="result-card">
            <h2 style="margin:0; font-size:32px; color:#334155;">íƒí—˜ ë!</h2>
            <p style="color:#64748b; font-size:18px; margin-top:5px;" id="end-reason">ë°œê±¸ìŒì„ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”</p>
            <div style="background:#fef3c7; padding:15px; border-radius:20px; margin:20px 0; border:2px solid #fcd34d;">
                <div style="font-size:16px; color:#92400e;">íšë“í•œ í¬ì¸íŠ¸</div>
                <div style="font-size:40px; color:#d97706; font-weight:bold;">+<span id="result-points">0</span></div>
            </div>
            <p style="text-align:left; margin-bottom:5px; font-weight:bold; color:#475569;">ì´ë²ˆì— ì¡ì€ í¬ì¼“ëª¬:</p>
            <div class="result-list" id="result-list"></div>
            <button class="btn-3d btn-explore" style="width:100%; height:60px; margin-top:10px;" onclick="switchView('view-lobby')">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
    </div>

    <div id="view-shop" class="view hidden">
        <div class="shop-header">
            <button class="back-btn" onclick="switchView('view-lobby')">ğŸ”™</button>
            <h2 style="margin:0; font-size:24px; color:#86198f;">ìƒì </h2>
        </div>
        <div style="width:100%; text-align:right; margin-bottom:10px; font-size:18px;">
            ë‚´ ì§€ê°‘: <span class="highlight" id="shop-points" style="font-weight:bold; color:#d97706;">0</span> P
        </div>
        <div class="shop-section">
            <h3>ğŸ”´ ëª¬ìŠ¤í„°ë³¼ êµ¬ë§¤</h3>
            <div class="shop-grid">
                <div class="shop-item"><div>ìŠˆí¼ë³¼</div><div class="shop-price">100 P</div><button class="buy-btn" onclick="buyItem('ball', 'super', 100)">êµ¬ë§¤í•˜ê¸°</button></div>
                <div class="shop-item"><div>í•˜ì´í¼ë³¼</div><div class="shop-price">150 P</div><button class="buy-btn" onclick="buyItem('ball', 'hyper', 150)">êµ¬ë§¤í•˜ê¸°</button></div>

                <div class="shop-item">
                    <div>âš¡ ìŠ¤í”¼ë“œë³¼<br><span style="font-size:12px; color:#64748b;">(í™•ë¥  10ë°° / 10ì´ˆ ì œí•œ)</span></div>
                    <div class="shop-price">500 P</div>
                    <button class="buy-btn" onclick="buyItem('ball', 'special', 500)">êµ¬ë§¤í•˜ê¸°</button>
                </div>
                
                <div class="shop-item"><div>ë§ˆìŠ¤í„°ë³¼</div><div class="shop-price">3000 P</div><button class="buy-btn" onclick="buyItem('ball', 'master', 3000)">êµ¬ë§¤í•˜ê¸°</button></div>
            </div>
        </div>
        <div class="shop-section">
            <h3>âš¡ ëŠ¥ë ¥ ê°•í™”í•˜ê¸°</h3>
            <div class="shop-grid">
                <div class="shop-item"><div>ğŸ‘Ÿ íŠ¼íŠ¼í•œ ì‹ ë°œ<br><span style="font-size:12px; color:#94a3b8;" id="lv-steps">Lv.0</span></div><div class="shop-price">500 P</div><button class="buy-btn" onclick="buyUpgrade('maxSteps', 500)">ê°•í™”í•˜ê¸°</button></div>

                <div class="shop-item"><div>ğŸ—‚ï¸ ë„ê° í™•ì¥<br><span style="font-size:12px; color:#94a3b8;" id="lv-dex">Lv.0</span></div><div class="shop-price">100 P</div><button class="buy-btn" onclick="buyUpgrade('dexLimit', 100)">í™•ì¥í•˜ê¸°</button></div>

                <div class="shop-item"><div>ğŸ€ í–‰ìš´ì˜ ë¶€ì <br><span style="font-size:12px; color:#94a3b8;" id="lv-rate">Lv.0 (Max 10)</span></div><div class="shop-price">800 P</div><button class="buy-btn" id="btn-buy-rate" onclick="buyUpgrade('catchRate', 800)">ê°•í™”í•˜ê¸°</button></div>

                <div class="shop-item">
                    <div>âœ¨ ë¹›ë‚˜ëŠ” ë¶€ì <br><span style="font-size:12px; color:#94a3b8;" id="lv-rare-rate">Lv.0 (Max 10)</span></div>
                    <div class="shop-price">1200 P</div>
                    <button class="buy-btn" id="btn-buy-rare" onclick="buyUpgrade('rareRate', 1200)">ê°•í™”í•˜ê¸°</button>
                </div>
                
                <div class="shop-item">
                    <div>â³ ì‹œê°„ ì—°ì¥<br>
                        <span style="font-size:12px; color:#94a3b8;" id="lv-timer">Lv.0</span>
                    </div>
                    <div class="shop-price">100 P</div>
                    <button class="buy-btn" id="btn-buy-timer" onclick="buyUpgrade('timerLevel', 300)">ê°•í™”í•˜ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <div id="view-dex" class="view hidden">
        <div class="sticky-header-group">
            <div class="shop-header">
                <button class="back-btn" onclick="switchView('view-lobby')">ğŸ”™</button>
                <h2 style="margin:0; font-size:24px; color:#92400e;">í¬ì¼“ëª¬ ë„ê°</h2>
                <div style="margin-left:auto; display:flex; gap:8px; align-items:center;">
                    <button class="btn-3d" style="padding:10px 14px; font-size:16px; border-radius:14px;" onclick="goToPixel()">ğŸ¨ ìƒ‰ì¹ í•˜ê¸°</button>
                    <button class="btn-3d" style="padding:10px 14px; font-size:16px; border-radius:14px;" onclick="exportDexToPRL()">ğŸ“¤ ë‚´ë³´ë‚´ê¸°</button>
                </div>
            </div>

            <button class="filter-toggle-btn" onclick="toggleFilterGrid()">
                <span>ğŸ” í•„í„° ì˜µì…˜</span>
                <span id="toggle-icon">ğŸ”½</span>
            </button>
            <div id="dex-filter-container" class="filter-grid">
            </div>
        </div>

        <div class="dex-content-area">
            <p style="font-size:18px; margin:15px 0;">
                ë“±ë¡ëœ í¬ì¼“ëª¬: <span id="dex-count" style="font-weight:bold; color:#d97706;">0</span> / <span id="dex-limit-display">30</span>
            </p>
            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:10px; width:100%;" id="dex-grid"></div>
        </div>
    </div>

</div>

<div id="modal-layer" class="modal-overlay hidden">
    <div id="modal-encounter" class="modal-box hidden">
        <div id="enc-badge-area"></div>
        <h3 style="color:#ef4444; font-size:24px; margin:0 0 10px 0;">ì•¼ìƒì˜ í¬ì¼“ëª¬!</h3>
        <img id="enc-img" src="" class="poke-img-lg" />
        <h2 id="enc-name" style="font-size:28px; margin:10px 0;">???</h2>
        <p style="font-size:16px; color:#f59e0b; font-weight:bold; margin:0;">ê¸°ë³¸ í™•ë¥ : <span id="enc-rate"></span>%</p>

        <div class="ball-select">
            <button class="ball-opt" id="btn-use-super" onclick="tryCatch('super')"><img src="./png/gb.png">ìŠˆí¼ë³¼<br>x<span id="qty-super">0</span></button>
            <button class="ball-opt" id="btn-use-hyper" onclick="tryCatch('hyper')"><img src="./png/ub.png">í•˜ì´í¼ë³¼<br>x<span id="qty-hyper">0</span></button>

            <button class="ball-opt" id="btn-use-special" onclick="tryCatch('special')">
                <img src="./png/lb.png">ìŠ¤í”¼ë“œë³¼<br>x<span id="qty-special">0</span>
            </button>

            <button class="ball-opt" id="btn-use-master" onclick="tryCatch('master')"><img src="./png/mb.png">ë§ˆìŠ¤í„°ë³¼<br>x<span id="qty-master">0</span></button>
        </div>
        <button style="margin-top:20px; background:#94a3b8; padding:12px; border:none; color:white; border-radius:15px; width:100%; font-size:18px; font-family:inherit; cursor:pointer;" onclick="runAway()">ğŸƒ ë„ë§ê°€ê¸°</button>
    </div>

    <div id="modal-quiz" class="modal-box hidden">
        <div class="combo-container">
            <div class="combo-badge">Combo: <span id="quiz-combo-val">0</span>/10</div>
            <div class="rate-badge">í™•ë¥ : <span id="quiz-prob-val">0</span>%</div>
        </div>

        <div class="timer-container">
            <div id="quiz-timer-fill" class="timer-bar-fill"></div>
        </div>

        <div class="ball-info-badge" id="quiz-ball-info">
            <img id="quiz-ball-img" src="" style="width:24px;height:24px;">
            <span id="quiz-ball-text"></span>
        </div>

        <h3 style="color:#0ea5e9; font-size:24px; margin-top:0;">ë¬¸ì œ!</h3>
        <p id="quiz-txt" style="font-size:32px; margin:10px 0; font-weight:bold; color:#334155;"></p>
        <p id="quiz-desc" style="font-size:18px; color:#64748b; margin-top:-10px; margin-bottom:15px;"></p>
        <div id="quiz-opts" style="display:flex; flex-direction:column; gap:12px;"></div>

        <button class="stop-btn" onclick="finishComboAndThrow()">âœ‹ ë©ˆì¶”ê³  ì§€ê¸ˆ ë˜ì§€ê¸°!</button>
    </div>

    <div id="modal-throw" class="modal-box hidden">
        <h3 style="color:#f97316; font-size:24px; margin-top:0;">í¬ì¼“ë³¼ì„ ë˜ì¡Œë‹¤!</h3>
        <img id="throw-poke-img" src="" class="poke-img-lg" />
        <div class="throw-scene-area"><img id="throw-ball-img" class="throw-ball-img" /></div>
        <p style="font-size:16px; color:#64748b; margin-top:10px;">í¬ì¼“ë³¼ì´ í”ë“¤ë¦¬ê³  ìˆì–´ìš”...</p>
    </div>

    <div id="modal-msg" class="modal-box hidden">
        <h2 id="msg-title" style="font-size:32px; margin:10px 0;">ê²°ê³¼</h2>
        <img id="msg-img" src="" style="width:100px; height:100px; image-rendering:pixelated;" />
        <p id="msg-desc" style="font-size:18px; color:#475569; margin:15px 0; line-height:1.4;"></p>
        <button onclick="closeMsgModal()" style="background:#4ade80; padding:15px; width:100%; border:none; color:#064e3b; border-radius:15px; font-weight:bold; font-size:20px; cursor:pointer;">í™•ì¸</button>
    </div>

    <div id="modal-step-buy" class="modal-box hidden">
        <h3 style="color:#eab308; font-size:26px; margin-top:0;">ë°œê±¸ìŒ ë¶€ì¡±!</h3>
        <p style="font-size:18px; color:#475569; margin:15px 0;">
            ë” ì´ìƒ ê±¸ì„ ìˆ˜ ì—†ì–´ìš” ğŸ’¦<br>
            <span style="font-weight:bold; color:#d97706;">100í¬ì¸íŠ¸</span>ë¡œ<br>
            <span style="font-weight:bold; color:#16a34a;">10ê±¸ìŒ</span>ì„ ì¶©ì „í•˜ì‹œê² ì–´ìš”?
        </p>
        <div style="display:flex; gap:10px;">
            <button onclick="endExploration('steps')" style="flex:1; background:#94a3b8; color:white; border:none; padding:12px; border-radius:15px; font-size:18px;">ì¢…ë£Œí•˜ê¸°</button>
            <button onclick="buySteps()" style="flex:1; background:#16a34a; color:white; border:none; padding:12px; border-radius:15px; font-size:18px;">ì¶©ì „í•˜ê¸°</button>
        </div>
    </div>
</div>

<script>
    // --- PokeDB (poke_db.json) : buildPokeDb.cjsë¡œ ìƒì„±í•œ DBë¥¼ ë¸Œë¼ìš°ì €ì—ì„œ ì½ì–´ì˜¨ë‹¤ ---
    let pokeDbMap = new Map();
    let pokeDbLoaded = false;
    let pokeDbLoading = null;

    async function ensurePokeDb() {
        if (pokeDbLoaded) return pokeDbMap;
        if (pokeDbLoading) return pokeDbLoading;

        pokeDbLoading = (async () => {
            try {
                const res = await fetch("./poke_db.json", { cache: "force-cache" });
                if (!res.ok) throw new Error(`poke_db.json load failed: ${res.status}`);
                const json = await res.json();

                // ì§€ì›: { pokemon:[...] } / { items:[...] } / [...] í˜•íƒœ
                const arr = Array.isArray(json) ? json : (json.pokemon || json.items || []);
                const map = new Map();
                for (const it of arr) {
                    if (it && typeof it.id === "number") map.set(it.id, it);
                }
                pokeDbMap = map;
                pokeDbLoaded = true;
                return pokeDbMap;
            } catch (e) {
                console.warn("[PokeDB] local poke_db.json load failed. Falling back to live PokeAPI only.", e);
                pokeDbMap = new Map();
                pokeDbLoaded = true;
                return pokeDbMap;
            }
        })();

        return pokeDbLoading;
    }

    // --- sprite URL í›„ë³´ ëª©ë¡ (ì„±ê³µí•˜ëŠ” ê±¸ë¡œ ìë™ êµì²´) ---
    const SPRITE_SOURCES = {
        pixel: [
            (id) => `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`,
            (id) => `https://github.com/PokeAPI/sprites/raw/master/sprites/pokemon/${id}.png`,
        ],
        artwork: [
            (id) => `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`,
            (id) => `https://github.com/PokeAPI/sprites/raw/master/sprites/pokemon/other/official-artwork/${id}.png`,
        ],
    };

    function buildSpriteCandidates(id) {
        const urls = [];
        try {
            // poke_db.jsonì— URLì´ ìˆìœ¼ë©´ ìµœìš°ì„  (ë‚˜ì¤‘ì— ë¡œì»¬ ìŠ¤í”„ë¼ì´íŠ¸ë¡œ ë°”ê¿”ë„ ê·¸ëŒ€ë¡œ)
            const entry = (pokeDbMap && pokeDbMap.get) ? pokeDbMap.get(id) : null;
            if (entry && entry.sprite_pixel) urls.push(entry.sprite_pixel);
            if (entry && entry.sprite_artwork) urls.push(entry.sprite_artwork);
        } catch (e) {}

        for (const fn of SPRITE_SOURCES.pixel) urls.push(fn(id));
        for (const fn of SPRITE_SOURCES.artwork) urls.push(fn(id));

        return Array.from(new Set(urls)).filter(Boolean);
    }

    function setImgWithFallback(img, urls, finalFallback = "./png/pb.png", onFinalFallback) {
        if (!img || !urls || urls.length === 0) {
            if (img) img.src = finalFallback;
            return;
        }
        let i = 0;
        img.onerror = () => {
            i += 1;
            if (i < urls.length) {
                img.src = urls[i];
                return;
            }
            img.onerror = null;
            img.src = finalFallback;
            if (onFinalFallback) onFinalFallback(img);
        };
        img.src = urls[0];
    }



    // --- íƒí—˜ ìŠ¤í° í”„ë¦¬ë¡œë“œ(ë‹¤ìŒ 1~3ë§ˆë¦¬) ---
    // ì›ì¹™: "ì „ì²´ í”„ë¦¬ë¡œë“œ"ëŠ” ë¬´ê²ë‹¤. ëŒ€ì‹  "ë‹¤ìŒ í›„ë³´"ë§Œ ë¯¸ë¦¬ ì´ë¯¸ì§€ ìºì‹œì— ì˜¬ë ¤ì„œ ìŠ¤í° ìˆœê°„ ë¹ˆì¹¸ì„ ì¤„ì¸ë‹¤.
    const SPAWN_PREFETCH_SIZE = 3; // 1~3 ê¶Œì¥ (ê¸°ë³¸ 3)

    let spawnQueue = []; // [{id, rarity}]
    const spritePreloadCache = new Map(); // id -> { url: string|null, ok: boolean, at: number }
    const spritePreloadInflight = new Map(); // id -> Promise<string|null>

    function getNextSpawnData() {
        const next = spawnQueue.length ? spawnQueue.shift() : null;
        return next || getWeightedRandomId();
    }

    function normalizeCandidatesWithCache(id, candidates) {
        const cached = spritePreloadCache.get(id);
        if (cached && cached.ok && cached.url && candidates.includes(cached.url)) {
            return [cached.url, ...candidates.filter((u) => u !== cached.url)];
        }
        return candidates;
    }

    function preloadUrl(url) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            img.onload = () => resolve(url);
            img.onerror = () => reject(new Error("img load failed"));
            // ìºì‹œ íŒíŠ¸(ë¸Œë¼ìš°ì €ê°€ ë¬´ì‹œí•  ìˆ˜ ìˆìŒ)
            img.decoding = "async";
            img.loading = "eager";
            img.src = url;
        });
    }

    async function preloadFirstSuccessful(urls) {
        for (const u of (urls || [])) {
            try {
                await preloadUrl(u);
                return u;
            } catch (e) {
                // try next
            }
        }
        return null;
    }

    async function preloadPokemonSprite(id) {
        if (spritePreloadCache.has(id) && spritePreloadCache.get(id)?.ok) {
            return spritePreloadCache.get(id).url || null;
        }
        if (spritePreloadInflight.has(id)) return spritePreloadInflight.get(id);

        const p = (async () => {
            try {
                await ensurePokeDb();
                let candidates = buildSpriteCandidates(id);
                candidates = normalizeCandidatesWithCache(id, candidates);
                const okUrl = await preloadFirstSuccessful(candidates);
                spritePreloadCache.set(id, { url: okUrl, ok: !!okUrl, at: Date.now() });
                return okUrl;
            } catch (e) {
                spritePreloadCache.set(id, { url: null, ok: false, at: Date.now() });
                return null;
            } finally {
                spritePreloadInflight.delete(id);
            }
        })();

        spritePreloadInflight.set(id, p);
        return p;
    }

    function refillSpawnQueue() {
        while (spawnQueue.length < SPAWN_PREFETCH_SIZE) {
            const sd = getWeightedRandomId();
            spawnQueue.push(sd);
            // fire-and-forget
            preloadPokemonSprite(sd.id);
        }
    }

    async function primeSpawnQueue(n = SPAWN_PREFETCH_SIZE, opts = { awaitFirst: false }) {
        spawnQueue = [];
        const firstPreloadPromises = [];
        for (let i = 0; i < n; i++) {
            const sd = getWeightedRandomId();
            spawnQueue.push(sd);
            const pr = preloadPokemonSprite(sd.id);
            firstPreloadPromises.push(pr);
        }
        // ì˜µì…˜: ì²« ìŠ¤í°(1ë§ˆë¦¬)ë§Œí¼ì€ "ë¯¸ë¦¬ ë¡œë“œ ì™„ë£Œ"ë¥¼ ê¸°ë‹¤ë ¤ì„œ, ì‹œì‘ ì§í›„ ë¹ˆì¹¸ ì²´ê°ì„ ì¤„ì¸ë‹¤.
        if (opts && opts.awaitFirst) {
            try { await firstPreloadPromises[0]; } catch (e) {}
        }
        return true;
    }


    const TILE_IMGS = ["./png/Tile0.png", "./png/Tile1.png", "./png/Tile2.png", "./png/Tile3.png"];
    const MAX_POKEMON_ID = 1025;

    // --- [ì¤‘ìš”] ë°ì´í„° ë²„ì „ ê´€ë¦¬ ---
    const SAVE_KEY = "poke_spell_game_data_v7";
    // Pixel(ìƒ‰ì¹ )ë¡œ ì´ë™: indexì™€ ë™ì¼ ì˜¤ë¦¬ì§„ì´ë©´ localStorageë¥¼ ìë™ ê³µìœ 
    const PIXEL_URL = new URL("../Pixel/Pixel_patched_auto_link.html", location.href).href;
    // v7ìœ¼ë¡œ ì—…ë°ì´íŠ¸ (ì¸ë²¤í† ë¦¬ êµ¬ì¡° ë³€ê²½ ë•Œë¬¸)
    const PREVIOUS_KEYS = ["poke_spell_game_data_v6", "poke_spell_game_data_v5", "poke_spell_game_data_v4"];

    // --- [ì¤‘ìš”] í¬ê·€ í¬ì¼“ëª¬ ë¦¬ìŠ¤íŠ¸ ---
    const LEGENDARY_IDS = [
        144,145,146,150,151, 243,244,245,249,250,251, 382,383,384,385,386,
        483,484,487,491,492,493, 643,644,646,649, 716,717,718,
        785,786,787,788,800,801,802,807, 888,889,890,891,892,898,
        1007,1008,1017,1024,1025
    ];

    const RARE_IDS = [
        1,4,7, 25, 133, 143, 149, 152,155,158, 212, 248,
        252,255,258, 282, 373, 376, 445, 448, 495,498,501, 635, 650, 653,
        722,725,728, 810,813,816, 887, 906,909,912, 996, 997, 998
    ];

    // [ë³€ê²½] ë³¼ ìŠ¤í”„ë¼ì´íŠ¸ ëª©ë¡ (monster ì‚­ì œ, special ì¶”ê°€, special ì´ë¯¸ì§€ ê²½ë¡œ ë³€ê²½)
    const BALL_SPRITES = {
        super: "./png/gb.png",
        hyper: "./png/ub.png",
        special: "./png/lb.png",
        master: "./png/mb.png"
    };

    // ì˜¤í”ˆ ì• ë‹ˆë©”ì´ì…˜ì€ ê¸°ì¡´ ë¦¬ì†ŒìŠ¤ í™œìš© (ìŠ¤í”¼ë“œë³¼ì€ ë§ˆìŠ¤í„°ë³¼ ì• ë‹ˆë©”ì´ì…˜ í™œìš©)
    const BALL_OPEN_SPRITES = {
        super: "./png/gb_open.png",
        hyper: "./png/ub_open.png",
        special: "./png/mb_open.png",
        master: "./png/mb_open.png"
    };
    const BALL_OPENING_SPRITES = {
        super: "./png/gb_opening.png",
        hyper: "./png/ub_opening.png",
        special: "./png/mb_opening.png",
        master: "./png/mb_opening.png"
    };

    let user = {
        points: 0,
        // [ë³€ê²½] inventory êµ¬ì¡°ì—ì„œ monster ì œê±°, special ì¶”ê°€
        inventory: { super: 0, hyper: 0, special: 0, master: 0 },
        dex: new Set(),
        upgrades: { maxSteps: 0, dexLimit: 0, catchRate: 0, timerLevel: 0, rareRate: 0 }, // rareRate ì¶”ê°€
        partnerId: null
    };
    let session = { active: false, steps: 0, caught: [], earnedPoints: 0 };
    let player = { x: 4, y: 4 };
    let tileMap = [];
    let currentPokemon = null;
    let silhouettePos = { x: -1, y: -1 };
    let isMoving = false;

    // í€´ì¦ˆ ê´€ë ¨ ë³€ìˆ˜
    let selectedBall = null;
    let currentQuiz = null;
    let currentCombo = 0;
    const MAX_COMBO = 10;
    let lastCapture = null;
    let externalQuizList = []; // ì™¸ë¶€ í€´ì¦ˆ ì €ì¥

    // íƒ€ì´ë¨¸ ê´€ë ¨
    let quizTimerInterval = null;
    const QUIZ_TIME_LIMIT = 200; // 0.1ì´ˆ ë‹¨ìœ„ x 100 = 10ì´ˆ

    // í•„í„° ë³€ìˆ˜
    let currentFilter = 'owned';
    let isFilterCollapsed = false;

    async function init() {
        loadGame();
        // DBë¥¼ ë¯¸ë¦¬ ë‹¹ê²¨ì„œ íƒí—˜ ìŠ¤í°/í‘œì‹œ ì§€ì—°ì„ ì¤„ì¸ë‹¤ (ì‹¤íŒ¨í•´ë„ fallback)
        ensurePokeDb();
        await loadQuizData();
        initDexFilter();
        updateLobbyUI();
    }

    async function loadQuizData() {
        try {
            // [ìºì‹œ ë°©ì§€] íƒ€ì„ìŠ¤íƒ¬í”„ + í—¤ë”
            const timestamp = new Date().getTime();
            const res = await fetch(`./quiz/quiz.json?v=${timestamp}`, {
                cache: "no-store",
                headers: {
                    'Pragma': 'no-cache',
                    'Cache-Control': 'no-cache'
                }
            });
            if(!res.ok) throw new Error("JSON Fetch Failed");
            const data = await res.json();
            if(data && data.questions && data.questions.length > 0) {
                externalQuizList = data.questions;
                console.log(`Loaded ${externalQuizList.length} questions from quiz.json`);
            } else {
                console.warn("Quiz JSON is empty. Using Fallback.");
                externalQuizList = [];
            }
        } catch(e) {
            console.warn("Quiz load error (using fallback):", e);
            externalQuizList = [];
        }
    }

    function initDexFilter() {
        const container = document.getElementById('dex-filter-container');
        container.innerHTML = "";
        createFilterBtn(container, 'owned', 'âœ… ë³´ìœ ');
        for (let i = 0; i < 11; i++) {
            const start = i * 100 + 1;
            const end = (i + 1) * 100;
            if (start > MAX_POKEMON_ID) break;
            const label = `${start}~${end}`;
            const value = `${start}-${end}`;
            createFilterBtn(container, value, label);
        }
    }

    function createFilterBtn(container, value, label) {
        const btn = document.createElement('button');
        btn.className = 'filter-btn';
        if (value === currentFilter) btn.classList.add('active');
        btn.textContent = label;
        btn.onclick = (e) => {
            currentFilter = value;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            renderDex();
        };
        container.appendChild(btn);
    }

    function toggleFilterGrid(forceClose = false) {
        const grid = document.getElementById('dex-filter-container');
        const icon = document.getElementById('toggle-icon');
        if (forceClose || !isFilterCollapsed) {
            grid.classList.add('collapsed');
            icon.textContent = 'â—€';
            isFilterCollapsed = true;
        } else {
            grid.classList.remove('collapsed');
            icon.textContent = 'ğŸ”½';
            isFilterCollapsed = false;
        }
    }

    function saveGame() {
        try {
            const data = { ...user, dex: Array.from(user.dex) };
            localStorage.setItem(SAVE_KEY, JSON.stringify(data));
        } catch(e) { console.error("Save failed", e); }
    }


    /* =========================================
     * PRL(ì „íˆ¬/ìœ¡ì„±)ë¡œ ë‚´ë³´ë‚´ê¸°
     * - GitHub Pages ë™ì¼ ì˜¤ë¦¬ì§„ì´ë©´ localStorageë¡œ ìë™ ì „ë‹¬
     * - í˜¹ì‹œ ëª°ë¼ URL hash(import=...)ë¡œë„ í•¨ê»˜ ì „ë‹¬
     * ========================================= */
    const PRL_TRANSFER_KEY = "classhub_index_export_to_prl_v1";
    const PRL_RECEIVER_URL = "https://unluckyidiot16.github.io/WebGames/PRL/RPL.html";

    function _b64UrlEncodeUtf8(str) {
        const bytes = new TextEncoder().encode(str);
        let bin = "";
        // btoa ì…ë ¥ì€ latin1ë§Œ í—ˆìš©ì´ë¼, Uint8 -> binary string ë³€í™˜
        for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
        const b64 = btoa(bin);
        return b64.replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
    }

    // [ìˆ˜ì •ë¨] í´ë¦½ë³´ë“œ ë³µì‚¬ í›„ ì´ë™í•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ë³€ê²½
    // Pixel(ìƒ‰ì¹ )ë¡œ ì´ë™
    function goToPixel() {
        const dexCount = Array.from(user.dex || []).length;
        if (dexCount <= 0) {
            const ok = confirm("ì•„ì§ ì¡ì€ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.\n\nê·¸ë˜ë„ Pixel(ìƒ‰ì¹ )ë¡œ ì´ë™í• ê¹Œìš”?");
            if (!ok) return;
        }
        window.location.href = PIXEL_URL;
    }
    function openPixelForPokemon(pokeId) {
        const id = parseInt(String(pokeId), 10);
        if (!Number.isFinite(id) || id <= 0) return;
        try {
            const u = new URL(PIXEL_URL, location.href);
            u.searchParams.set('poke', String(id));
            window.location.href = u.href;
        } catch (e) {
            // fallback: naive concat
            window.location.href = `${PIXEL_URL}${PIXEL_URL.includes('?') ? '&' : '?'}poke=${id}`;
        }
    }

    // âœ… ë„ê°(ë³´ìœ  í¬ì¼“ëª¬)ì—ì„œ íƒ­í•˜ë©´: íŒŒíŠ¸ë„ˆë¡œ ì§€ì • + Pixelì—ì„œ í•´ë‹¹ í¬ì¼“ëª¬ ë°”ë¡œ ì—´ê¸°
    function setPartnerAndOpenPixel(pokeId) {
        const id = parseInt(String(pokeId), 10);
        if (!Number.isFinite(id) || id <= 0) return;
        if (!user.dex || !user.dex.has(id)) {
            alert("ì•„ì§ ì¡ì§€ ì•Šì€ í¬ì¼“ëª¬ì…ë‹ˆë‹¤.");
            return;
        }
        user.partnerId = id;      // í† ê¸€ ì—†ì´ 'ì§€ì •'ë§Œ
        saveGame();
        updateLobbyUI();
        renderDex();
        openPixelForPokemon(id);
    }


    async function exportDexToPRL() {
        const dexIds = Array.from(user.dex || []);
        const partnerId = user.partnerId ?? null;

        if (dexIds.length <= 0) {
            alert("ë‚´ë³´ë‚¼ í¬ì¼“ëª¬ì´ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € í¬ì¼“ëª¬ì„ ì¡ì•„ ë„ê°ì— ë“±ë¡í•´ ì£¼ì„¸ìš”!");
            return;
        }

        const payload = {
            v: 1,
            source: "index",
            ts: Date.now(),
            dexIds,
            partnerId,
        };

        // í† í° ìƒì„±
        const token = _b64UrlEncodeUtf8(JSON.stringify(payload));

        // ì´ë™í•  ì£¼ì†Œ (í•´ì‹œ ì—†ì´ ê¹”ë”í•œ ì£¼ì†Œ)
        const targetUrl = "https://unluckyidiot16.github.io/WebGames/PRL/PRL.html";

        try {
            // í´ë¦½ë³´ë“œì— í† í° ë³µì‚¬ ì‹œë„
            await navigator.clipboard.writeText(token);

            if(confirm("âœ… ë°ì´í„°ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n[í™•ì¸]ì„ ëˆ„ë¥´ë©´ PRL ê²Œì„ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.\nì´ë™ í›„ ë¡œë¹„ ìƒë‹¨ì˜ [ğŸ“¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.")) {
                window.location.href = targetUrl;
            }
        } catch (err) {
            // í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨ ì‹œ (ë³´ì•ˆ ì„¤ì • ë“±) ìˆ˜ë™ ë³µì‚¬ ìœ ë„
            console.error('Clipboard failed', err);
            prompt("ìë™ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì•„ë˜ ì½”ë“œë¥¼ ì „ì²´ ì„ íƒ(Ctrl+A) í›„ ë³µì‚¬(Ctrl+C)í•˜ì„¸ìš”:", token);
            window.location.href = targetUrl;
        }
    }

    function loadGame() {
        try {
            let saved = localStorage.getItem(SAVE_KEY);
            if (!saved) {
                for (let oldKey of PREVIOUS_KEYS) {
                    const oldData = localStorage.getItem(oldKey);
                    if (oldData) {
                        console.log(`[Migration] Found old data in ${oldKey}. Migrating to ${SAVE_KEY}...`);
                        saved = oldData;
                        localStorage.setItem(SAVE_KEY, saved);
                        break;
                    }
                }
            }
            if(saved) {
                const parsed = JSON.parse(saved);
                user = { ...user, ...parsed, dex: new Set(parsed.dex || []) };
                if(user.upgrades.rareRate === undefined) user.upgrades.rareRate = 0;

                // [ë§ˆì´ê·¸ë ˆì´ì…˜] ì¸ë²¤í† ë¦¬ êµ¬ì¡° ë³€ê²½ ëŒ€ì‘ (monster -> superë¡œ êµì²´í•˜ê±°ë‚˜ ì‚­ì œ)
                if(user.inventory.monster !== undefined) {
                    user.inventory.super += user.inventory.monster; // ê¸°ì¡´ ëª¬ìŠ¤í„°ë³¼ì„ ìŠˆí¼ë³¼ë¡œ í†µí•© ë³´ìƒ
                    delete user.inventory.monster;
                }
                if(user.inventory.special === undefined) user.inventory.special = 0;

                if(user.upgrades.startBalls !== undefined) delete user.upgrades.startBalls;
                if(user.upgrades.dexLimit === undefined) user.upgrades.dexLimit = 0;
                if(user.upgrades.timerLevel === undefined) user.upgrades.timerLevel = 0;
            }
        } catch(e) { console.error("Load failed", e); }
    }

    function resetGameData() {
        if(confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            localStorage.removeItem(SAVE_KEY);
            location.reload();
        }
    }

    function generateGuGuDan() {
        // 10, 20, 30, ..., 90 ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒ
        const num1 = (Math.floor(Math.random() * 9) + 1) * 10;
        const num2 = (Math.floor(Math.random() * 9) + 1) * 10;
        const ans = num1 * num2;

        let choices = new Set();
        choices.add(ans);

        while(choices.size < 4) {
            let wrong;
            const coinFlip = Math.random();

            if (coinFlip < 0.4) {
                // 1. ì •ë‹µì—ì„œ 100ì´ë‚˜ 200 ì •ë„ ì°¨ì´ ë‚˜ëŠ” ìˆ«ì ìƒì„±
                const offset = (Math.floor(Math.random() * 5) - 2) * 100;
                wrong = ans + (offset === 0 ? 100 : offset);
            } else if (coinFlip < 0.7) {
                // 2. ë‹¤ë¥¸ 10ë‹¨ ë‹¨ìœ„ì˜ ë¬´ì‘ìœ„ ê³±ì…ˆ ê²°ê³¼ ìƒì„±
                const w1 = (Math.floor(Math.random() * 9) + 1) * 10;
                const w2 = (Math.floor(Math.random() * 9) + 1) * 10;
                wrong = w1 * w2;
            } else {
                // 3. ìˆ«ìê°€ ë¹„ìŠ·í•´ ë³´ì´ë„ë¡ ì •ë‹µì— 10ì„ ë”í•˜ê±°ë‚˜ ëº€ ê²°ê³¼
                wrong = ans + (Math.random() < 0.5 ? 10 : -10);
            }

            if (wrong > 0 && wrong !== ans) {
                choices.add(wrong);
            }
        }

        let finalChoices = Array.from(choices);
        // ë³´ê¸° ì„ê¸°
        for (let i = finalChoices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [finalChoices[i], finalChoices[j]] = [finalChoices[j], finalChoices[i]];
        }

        return {
            prompt: `${num1} Ã— ${num2} = ?`,
            promptExplain: "í° ìˆ˜ì˜ ê³±ì…ˆì„ í•´ë³´ì!",
            choices: finalChoices,
            answerIndex: finalChoices.indexOf(ans)
        };
    }

    function getExternalQuiz() {
        const rawQ = externalQuizList[Math.floor(Math.random() * externalQuizList.length)];
        const originalChoices = rawQ.choices.map((val, idx) => ({ val: val, isAns: idx === rawQ.answerIndex }));
        for (let i = originalChoices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [originalChoices[i], originalChoices[j]] = [originalChoices[j], originalChoices[i]];
        }
        const shuffledChoices = originalChoices.map(obj => obj.val);
        const newAnswerIndex = originalChoices.findIndex(obj => obj.isAns);

        return {
            prompt: rawQ.prompt,
            promptExplain: rawQ.promptExplain,
            choices: shuffledChoices,
            answerIndex: newAnswerIndex
        };
    }

    function switchView(viewId) {
        document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
        document.getElementById(viewId).classList.remove('hidden');
        if(viewId === 'view-shop') updateShopUI();
        if(viewId === 'view-dex') renderDex();
        if(viewId === 'view-lobby') updateLobbyUI();
    }

    function setPartner(id) {
        if(user.partnerId === id) {
            user.partnerId = null;
            alert("íŒŒíŠ¸ë„ˆ ì„¤ì •ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            user.partnerId = id;
            alert("ë¡œë¹„ íŒŒíŠ¸ë„ˆë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
        }
        saveGame();
        renderDex();
    }

    function updateLobbyUI() {
        document.getElementById('lobby-points').textContent = user.points;
        const partnerContainer = document.getElementById('lobby-partner');
        const partnerImg = document.getElementById('lobby-partner-img');
        if (user.partnerId) {
            partnerContainer.classList.remove('hidden');
            setImgWithFallback(partnerImg, buildSpriteCandidates(user.partnerId), './png/pb.png');
            // íƒ­í•˜ë©´ íŒŒíŠ¸ë„ˆ í•´ì œ (Pixel ì´ë™ ë°©ì§€ìš©)
            partnerContainer.onclick = () => {
                const ok = confirm("íŒŒíŠ¸ë„ˆë¥¼ í•´ì œí• ê¹Œìš”?");
                if (!ok) return;
                user.partnerId = null;
                saveGame();
                updateLobbyUI();
                renderDex();
            };

        } else {
            partnerContainer.classList.add('hidden');
            partnerImg.src = "";
            partnerContainer.onclick = null;

        }
    }

    async function startExploration() {
        const baseSteps = 30 + (user.upgrades.maxSteps * 10);
        const bonusBalls = 10;
        session = { active: true, steps: baseSteps, caught: [], earnedPoints: 0 };
        // [ë³€ê²½] ê¸°ë³¸ ë³¼ ì§€ê¸‰ ë¡œì§: ìŠˆí¼ë³¼ 10ê°œ ë¯¸ë§Œì¼ ë•Œ ì±„ì›Œì¤Œ
        if (user.inventory.super < bonusBalls) {
            user.inventory.super = bonusBalls;
            saveGame();
        }
        generateMap();
        player = { x: 4, y: 4 };
        updatePlayerPos();
        updateGameHeader();
        switchView('view-game');

        // âœ… ë‹¤ìŒ ìŠ¤í° í›„ë³´ 1~3ë§ˆë¦¬ ì„ (å…ˆ)í”„ë¦¬ë¡œë“œ (ìµœëŒ€ 3ë§ˆë¦¬)
        // ì²« 1ë§ˆë¦¬ëŠ” ë¡œë“œ ì™„ë£Œë¥¼ ê¸°ë‹¤ë ¤ì„œ ì‹œì‘ ì§í›„ "ì•ˆ ë³´ì„" ì²´ê°ì„ ì¤„ì¸ë‹¤.
        await primeSpawnQueue(SPAWN_PREFETCH_SIZE, { awaitFirst: true });

        removeSilhouette();
        spawnPokemon();
    }

    function endExploration(reason) {
        if (reason === 'steps' && document.getElementById('modal-step-buy').classList.contains('hidden')) {
            showStepBuyModal();
            return;
        }

        session.active = false;
        document.getElementById('end-reason').textContent = reason === 'steps' ? "ë°œê±¸ìŒì„ ëª¨ë‘ ì‚¬ìš©í–ˆì–´ìš”!" : "í¬ì¼“ë³¼ì´ ë‹¤ ë–¨ì–´ì¡Œì–´ìš”!";
        document.getElementById('result-points').textContent = session.earnedPoints;
        const listEl = document.getElementById('result-list');
        listEl.innerHTML = "";
        if(session.caught.length === 0) listEl.innerHTML = "<p style='width:100%; text-align:center; font-size:14px; color:#94a3b8;'>ì•„ë¬´ê²ƒë„ ëª» ì¡ì•˜ì–´ìš”...</p>";
        session.caught.forEach(p => {
            const div = document.createElement('div');
            div.className = 'result-poke';
            div.innerHTML = `<img src="${p.sprite}">`;
            listEl.appendChild(div);
        });

        document.getElementById('modal-layer').classList.add('hidden');
        document.getElementById('modal-step-buy').classList.add('hidden');

        switchView('view-result');
        saveGame();
    }

    function generateMap() {
        const grid = document.getElementById('grid');
        grid.innerHTML = "";
        tileMap = [];
        for(let y=0; y<9; y++){
            let row = [];
            for(let x=0; x<9; x++){
                const t = Math.floor(Math.random()*4);
                row.push(t);
                const div = document.createElement('div');
                div.className = 'tile';
                div.style.backgroundImage = `url('${TILE_IMGS[t]}')`;
                div.dataset.x = x; div.dataset.y = y;
                grid.appendChild(div);
            }
            tileMap.push(row);
        }
    }

    function move(dir) {
        if(!session.active || isMoving) return;
        let nx = player.x, ny = player.y;
        if(dir === 'up') ny--;
        if(dir === 'down') ny++;
        if(dir === 'left') nx--;
        if(dir === 'right') nx++;
        if(nx < 0 || nx >= 9 || ny < 0 || ny >= 9) return;

        isMoving = true;
        player.x = nx; player.y = ny;
        session.steps--;
        const frames = { up:[6,7,8], down:[0,1,2], left:[9,10,11], right:[3,4,5] };
        animateSprite(frames[dir] || frames.down);
        updatePlayerPos();
        updateGameHeader();
        setTimeout(() => {
            isMoving = false;
            if(session.steps <= 0) { endExploration('steps'); return; }
            if(player.x === silhouettePos.x && player.y === silhouettePos.y) startEncounter();
        }, 300);
    }

    function updateGameHeader() {
        document.getElementById('game-steps').textContent = session.steps;
        // [ë³€ê²½] ë³´ìœ  ë³¼ í•©ê³„ ê³„ì‚° (monster ì œì™¸)
        document.getElementById('game-balls').textContent = user.inventory.super + user.inventory.hyper + user.inventory.special + user.inventory.master;
    }

    function animateSprite(frames) {
        let idx = 0;
        const interval = setInterval(() => {
            const frame = frames[idx % 3];
            document.getElementById('playerSprite').style.backgroundPosition = `${(frame / 11) * 100}% 50%`;
            idx++;
        }, 100);
        setTimeout(() => clearInterval(interval), 300);
    }

    function updatePlayerPos() {
        document.getElementById('player').style.transform = `translate(${player.x*100}%, ${player.y*100}%)`;
    }

    function removeSilhouette() {
        document.querySelectorAll('.tile.silhouette').forEach(t => {
            t.classList.remove('silhouette', 'legendary');
            const img = t.querySelector('.silhouette-img');
            if (img) img.remove();
        });
        silhouettePos = { x: -1, y: -1 };
    }

    // 2. ê°€ì¤‘ì¹˜ ê¸°ë°˜ ëœë¤ ID ìƒì„± ë¡œì§ ìˆ˜ì • (7:3 ë³´ì • ë° í™•ë¥  ì—…ê·¸ë ˆì´ë“œ ì ìš©)
    function getWeightedRandomId() {
        // í¬ê·€ ì¡°ìš° í™•ë¥  ë³´ë„ˆìŠ¤ ê³„ì‚° (Lv.10 ê¸°ì¤€ +5%)
        const rareBonus = (user.upgrades.rareRate || 0) * 0.005;
        const roll = Math.random();

        let rarity;
        // ì „ì„¤(UR): ê¸°ë³¸ 2% + ë³´ë„ˆìŠ¤ (ìµœëŒ€ 7%)
        if (roll < (0.02 + rareBonus)) {
            rarity = 'legendary';
        }
        // í¬ê·€(Rare): 13% (ê¸°ë³¸ ìœ ì§€ í˜¹ì€ ì†Œí­ ì¡°ì • ê°€ëŠ¥)
        else if (roll < (0.15 + rareBonus)) {
            rarity = 'rare';
        }
        // ì¼ë°˜(C): ë‚˜ë¨¸ì§€
        else {
            rarity = 'common';
        }

        // ë“±ê¸‰ë³„ í¬ì¼“ëª¬ í’€ êµ¬ì„±
        let pool = [];
        if (rarity === 'legendary') {
            pool = LEGENDARY_IDS;
        } else if (rarity === 'rare') {
            pool = RARE_IDS;
        } else {
            // ì „ì²´ì—ì„œ ì „ì„¤/í¬ê·€ë¥¼ ì œì™¸í•œ ë‚˜ë¨¸ì§€
            pool = Array.from({length: MAX_POKEMON_ID}, (_, i) => i + 1)
                .filter(id => !LEGENDARY_IDS.includes(id) && !RARE_IDS.includes(id));
        }

        // --- [í•µì‹¬] 7:3 ë¯¸ë“±ë¡ í¬ì¼“ëª¬ ë“±ì¥ ë³´ì • ---
        const unowned = pool.filter(id => !user.dex.has(id));

        // ë¯¸ë“±ë¡ í¬ì¼“ëª¬ì´ ìˆê³ , 70% í™•ë¥ ì— ë‹¹ì²¨ëœ ê²½ìš°
        if (unowned.length > 0 && Math.random() < 0.7) {
            const selectedId = unowned[Math.floor(Math.random() * unowned.length)];
            return { id: selectedId, rarity };
        } else {
            // ë‚˜ë¨¸ì§€ 30% ë˜ëŠ” ë¯¸ë“±ë¡ì´ ì—†ëŠ” ê²½ìš° ì „ì²´ í’€ì—ì„œ ëœë¤
            const selectedId = pool[Math.floor(Math.random() * pool.length)];
            return { id: selectedId, rarity };
        }
    }

    async function spawnPokemon() {
        removeSilhouette();
        let x, y;
        do { x = Math.floor(Math.random() * 9); y = Math.floor(Math.random() * 9); } while (x === player.x && y === player.y);
        silhouettePos = { x, y };
        currentPokemon = null;

        const targetTile = document.querySelector(`.tile[data-x="${x}"][data-y="${y}"]`);
        const spawnData = getNextSpawnData();
        // ë‹¤ìŒ í›„ë³´ë¥¼ ì±„ì›Œë‘ê³ (í”„ë¦¬ë¡œë“œ í¬í•¨), íƒí—˜ ì§„í–‰ ì¤‘ì—ë„ ê³„ì† ìœ ì§€í•œë‹¤
        refillSpawnQueue();
        const id = spawnData.id;
        const rarity = spawnData.rarity;

        // âœ… ë¹ˆì¹¸ ë°©ì§€: ë¨¼ì € placeholderë¥¼ ê¹”ê³ , ë°ì´í„°/ì´ë¯¸ì§€ëŠ” ë’¤ì—ì„œ êµì²´í•œë‹¤
        let tileImg = null;
        if (targetTile) {
            targetTile.classList.add("silhouette");
            if (rarity === "legendary") targetTile.classList.add("legendary");

            tileImg = document.createElement("img");
            tileImg.className = "silhouette-img";
            tileImg.src = "./png/pb.png";
            targetTile.appendChild(tileImg);
        }

        try {
            await ensurePokeDb();
            const entry = pokeDbMap.get(id);

            // ë¡œì»¬ DB ìš°ì„ 
            let name = entry?.name_ko || entry?.name_en || null;
            let rate = entry?.capture_rate;

            // ë¡œì»¬ DBì— ì—†ìœ¼ë©´ PokeAPI fallback
            if (!name || typeof rate !== "number") {
                const res = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${id}`);
                const data = await res.json();
                name = data?.names?.find((n) => n?.language?.name === "ko")?.name || data?.name || `No.${id}`;
                rate = data?.capture_rate ?? 45;
            }

            let candidates = buildSpriteCandidates(id);
            candidates = normalizeCandidatesWithCache(id, candidates);
            currentPokemon = { id, name, rate, sprite: candidates[0], spriteCandidates: candidates, rarity };

            if (tileImg) {
                setImgWithFallback(tileImg, candidates, "./png/pb.png", (el) => { el.style.filter = "none"; });
            }
        } catch (e) {
            console.error("Spawn Error", e);
        }
    }

    function startEncounter() {
        if(!currentPokemon) return;
        // [ë³€ê²½] ë³¼ í•©ê³„ ì²´í¬
        if((user.inventory.super + user.inventory.hyper + user.inventory.special + user.inventory.master) <= 0) {
            endExploration('balls'); return;
        }
        document.getElementById('modal-layer').classList.remove('hidden');
        document.getElementById('modal-encounter').classList.remove('hidden');
        const encImgEl = document.getElementById('enc-img');
        if (encImgEl) {
            const urls = currentPokemon.spriteCandidates || buildSpriteCandidates(currentPokemon.id);
            setImgWithFallback(encImgEl, urls, './png/pb.png');
        }
        document.getElementById('enc-name').textContent = currentPokemon.name;

        const badgeArea = document.getElementById('enc-badge-area');
        badgeArea.innerHTML = "";
        if(currentPokemon.rarity === 'legendary') badgeArea.innerHTML = `<span class="rarity-badge" style="background:#ef4444;">ğŸŒŸ ì „ì„¤/í™˜ìƒ</span>`;
        else if (currentPokemon.rarity === 'rare') badgeArea.innerHTML = `<span class="rarity-badge" style="background:#3b82f6;">âœ¨ í¬ê·€</span>`;

        let baseRate = (currentPokemon.rate / 255);
        if (!baseRate) baseRate = 0.1;
        baseRate = baseRate * 2.5;
        baseRate += (user.upgrades.catchRate * 0.005);

        if(baseRate > 0.95) baseRate = 0.95;
        if(baseRate < 0.05) baseRate = 0.05;
        baseRate = baseRate * 0.65;

        document.getElementById('enc-rate').textContent = Math.floor(baseRate*100);
        updateBallBtns();
    }

    function updateBallBtns() {
        // [ë³€ê²½] ë²„íŠ¼ ì—…ë°ì´íŠ¸ ë¡œì§ (super, hyper, special, master)
        ['super','hyper','special','master'].forEach(type => {
            const qty = user.inventory[type];
            document.getElementById(`qty-${type}`).textContent = qty;
            document.getElementById(`btn-use-${type}`).disabled = (qty <= 0);
        });
    }

    function tryCatch(ballType) {
        if(user.inventory[ballType] <= 0) return;
        selectedBall = ballType;
        user.inventory[selectedBall]--;
        updateGameHeader();

        document.getElementById('modal-encounter').classList.add('hidden');
        document.getElementById('modal-quiz').classList.remove('hidden');

        currentCombo = 0;
        nextQuizStep();
    }

    function nextQuizStep() {
        updateComboUI();
        if(currentCombo >= MAX_COMBO) {
            finishComboAndThrow();
            return;
        }

        if(externalQuizList.length > 0) {
            currentQuiz = getExternalQuiz();
        } else {
            currentQuiz = generateGuGuDan();
        }

        document.getElementById('quiz-txt').textContent = currentQuiz.prompt;
        document.getElementById('quiz-desc').textContent = currentQuiz.promptExplain || "";

        const optsDiv = document.getElementById('quiz-opts');
        optsDiv.innerHTML = "";
        currentQuiz.choices.forEach((c, idx) => {
            const btn = document.createElement('button');
            btn.className = 'quiz-btn';
            btn.textContent = c;
            btn.onclick = () => handleAnswer(idx === currentQuiz.answerIndex);
            optsDiv.appendChild(btn);
        });

        startQuizTimer();
    }

    // [ì¤‘ìš” ë³€ê²½] startQuizTimer í•¨ìˆ˜: ìŠ¤í”¼ë“œë³¼(special) ì„ íƒ ì‹œ ì‹œê°„ 10ì´ˆ ê³ ì •
    function startQuizTimer() {
        if(quizTimerInterval) clearInterval(quizTimerInterval);

        let maxTime;
        if (selectedBall === 'special') {
            maxTime = 100; // 10ì´ˆ (ê³ ì •)
        } else {
            maxTime = QUIZ_TIME_LIMIT + (user.upgrades.timerLevel * 10);
        }

        let timeLeft = maxTime;
        const barFill = document.getElementById('quiz-timer-fill');

        barFill.style.width = '100%';
        barFill.style.background = 'linear-gradient(90deg, #4ade80, #ef4444)';

        quizTimerInterval = setInterval(() => {
            timeLeft--;
            const percentage = (timeLeft / maxTime) * 100;
            barFill.style.width = `${percentage}%`;

            if (timeLeft <= 0) {
                clearInterval(quizTimerInterval);
                handleAnswer(false);
            }
        }, 100);
    }

    function updateComboUI() {
        const comboEl = document.getElementById('quiz-combo-val');
        const probEl = document.getElementById('quiz-prob-val');

        const p = calculateCatchProb();
        comboEl.textContent = currentCombo;
        probEl.textContent = Math.floor(p * 100);

        // [ë³€ê²½] ë³¼ ë³´ë„ˆìŠ¤ í‘œì‹œ í…ìŠ¤íŠ¸
        let ballBonus, ballName;
        if(selectedBall === 'super') { ballBonus = 1.5; ballName = "ìŠˆí¼ë³¼"; }
        else if(selectedBall === 'hyper') { ballBonus = 2.0; ballName = "í•˜ì´í¼ë³¼"; }
        else if(selectedBall === 'special') { ballBonus = 10.0; ballName = "ìŠ¤í”¼ë“œë³¼"; } // 10ë°°
        else if(selectedBall === 'master') { ballBonus = 255; ballName = "ë§ˆìŠ¤í„°ë³¼"; }

        document.getElementById('quiz-ball-img').src = BALL_SPRITES[selectedBall];
        document.getElementById('quiz-ball-text').textContent = `${ballName} (ë³´ë„ˆìŠ¤ x${ballBonus === 255 ? 'MAX' : ballBonus})`;

        triggerPopAnim(comboEl);
        triggerPopAnim(probEl);
    }

    function triggerPopAnim(element) {
        element.classList.remove('pop-anim');
        void element.offsetWidth;
        element.classList.add('pop-anim');
    }

    // [ì¤‘ìš” ë³€ê²½] íšë“ í™•ë¥  ê³„ì‚° (ìŠ¤í”¼ë“œë³¼ ë¡œì§ ì¶”ê°€)
    function calculateCatchProb() {
        let rate = currentPokemon.rate / 255;
        if (!rate) rate = 0.1;

        // [ë³€ê²½] ë³¼ ë³´ë„ˆìŠ¤ ë§¤í•‘
        const ballBonus = { super: 1.5, hyper: 2.0, special: 10.0, master: 255 }[selectedBall];

        const upgradeBonus = 1 + (user.upgrades.catchRate * 0.005);
        const balancePatchMultiplier = 2.5;
        const DIFFICULTY_NERF = 0.65;

        // 1. ê¸°ì´ˆ í™•ë¥  ê³„ì‚°
        let baseP = rate * ballBonus * upgradeBonus * balancePatchMultiplier;

        // 2. 95% ìº¡ ì ìš©
        if (baseP > 0.95) baseP = 0.95;
        if (baseP < 0.05) baseP = 0.05;

        // 3. ì½¤ë³´ ë³´ë„ˆìŠ¤
        const comboBonus = 1 + (currentCombo * 0.1);
        let finalP = baseP * comboBonus;

        // 4. ë‚œì´ë„ ë„ˆí”„ (65%)
        finalP = finalP * DIFFICULTY_NERF;

        if (selectedBall === 'master') finalP = 1;
        if (finalP > 1) finalP = 1;

        return finalP;
    }

    function handleAnswer(isCorrect) {
        if(quizTimerInterval) clearInterval(quizTimerInterval);

        if (isCorrect) {
            currentCombo++;
            nextQuizStep();
        } else {
            currentCombo = 0;
            alert("í‹€ë ¸ê±°ë‚˜ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤! ì½¤ë³´ê°€ ì´ˆê¸°í™”ë˜ì–´ ë³¼ì´ ë˜ì ¸ì§‘ë‹ˆë‹¤!");
            finishComboAndThrow(false);
        }
    }

    function finishComboAndThrow(isSuccessFlow = true) {
        if(quizTimerInterval) clearInterval(quizTimerInterval);
        document.getElementById('modal-quiz').classList.add('hidden');

        const finalProb = calculateCatchProb();
        const isCaught = Math.random() < finalProb;

        let titleText, titleColor, descHtml;

        if(isCaught) {
            titleText = "ì¡ì•˜ë‹¤!";
            titleColor = "#4ade80";
            let pts = 100;
            if(currentPokemon.rarity === 'legendary') pts = 500;
            else if(currentPokemon.rarity === 'rare') pts = 200;

            const dexLimit = 30 + (user.upgrades.dexLimit * 10);
            const isNew = !user.dex.has(currentPokemon.id);
            const isFull = user.dex.size >= dexLimit;

            if(isNew) {
                if(isFull) {
                    descHtml = `${currentPokemon.name}!<br><span style='font-size:14px; color:#ef4444;'>ë„ê°ì´ ê°€ë“ ì°¨ì„œ í¬ì¸íŠ¸ë§Œ ë°›ìŠµë‹ˆë‹¤. (+${pts}P)</span>`;
                    user.points += pts;
                } else {
                    user.dex.add(currentPokemon.id);
                    descHtml = `${currentPokemon.name}!<br><span style='font-size:14px; color:#f59e0b;'>ìƒˆë¡œìš´ ì¹œêµ¬! (+${pts}P)</span>`;
                    user.points += pts;
                }
            } else {
                pts = Math.floor(pts / 2);
                descHtml = `${currentPokemon.name}!<br><span style='font-size:14px; color:#94a3b8;'>ë˜ ì¡ì•˜ë„¤ìš” (+${pts}P)</span>`;
                user.points += pts;
            }
            session.earnedPoints += pts;
            let shownSprite = currentPokemon.sprite;
            const encImgEl2 = document.getElementById('enc-img');
            if (encImgEl2 && encImgEl2.src) shownSprite = encImgEl2.src;
            session.caught.push({ name: currentPokemon.name, sprite: shownSprite });
        } else {
            titleText = "ë†“ì³¤ë‹¤...";
            titleColor = "#f87171";
            descHtml = `${currentPokemon.name}ì´(ê°€) ë„ë§ê°”ì–´ìš”.`;
        }

        saveGame();
        descHtml += `<br><br><span style="font-size:14px; color:#64748b;">(ì½¤ë³´: ${currentCombo}, í™•ë¥ : ${Math.floor(finalProb*100)}%)</span>`;

        lastCapture = { titleText, titleColor, descHtml };
        removeSilhouette();
        showThrowAnimation();
    }

    function showThrowAnimation() {
        const layer = document.getElementById("modal-layer");
        const throwModal = document.getElementById("modal-throw");
        const pokeImg = document.getElementById("throw-poke-img");
        const ballImg = document.getElementById("throw-ball-img");

        layer.classList.remove("hidden");
        throwModal.classList.remove("hidden");

        pokeImg.src = currentPokemon.sprite;
        pokeImg.classList.remove("poke-descend-shrink", "poke-hidden");
        pokeImg.style.transform = "";
        pokeImg.style.opacity = "1";

        const closedSprite = BALL_SPRITES[selectedBall];
        const openSprite = BALL_OPEN_SPRITES[selectedBall];
        const openingSprite = BALL_OPENING_SPRITES[selectedBall];

        ballImg.src = closedSprite;
        ballImg.classList.remove("ball-throw-up", "ball-drop", "ball-shake");
        void ballImg.offsetWidth;
        ballImg.classList.add("ball-throw-up");

        ballImg.onanimationend = (e) => {
            if (e.animationName === "ballThrowUp") {
                ballImg.src = openSprite;
                pokeImg.classList.remove("poke-descend-shrink", "poke-hidden");
                pokeImg.style.transform = ""; pokeImg.style.opacity = "1"; void pokeImg.offsetWidth;
                pokeImg.classList.add("poke-descend-shrink");
                pokeImg.onanimationend = () => {
                    pokeImg.classList.add("poke-hidden");
                    ballImg.src = openSprite;
                    setTimeout(() => {
                        ballImg.src = openingSprite;
                        setTimeout(() => {
                            ballImg.src = closedSprite;
                            ballImg.classList.remove("ball-throw-up"); void ballImg.offsetWidth;
                            ballImg.classList.add("ball-drop");
                        }, 80);
                    }, 80);
                };
            } else if (e.animationName === "ballDrop") {
                ballImg.classList.remove("ball-drop"); void ballImg.offsetWidth;
                ballImg.classList.add("ball-shake");
            } else if (e.animationName === "ballShake") {
                ballImg.onanimationend = null;
                throwModal.classList.add("hidden");
                showResultModal();
            }
        };
    }

    function showResultModal() {
        const layer = document.getElementById('modal-layer');
        const msgModal = document.getElementById('modal-msg');
        layer.classList.remove('hidden');
        msgModal.classList.remove('hidden');
        const msgImgEl = document.getElementById('msg-img');
        if (msgImgEl) {
            const urls = currentPokemon.spriteCandidates || buildSpriteCandidates(currentPokemon.id);
            setImgWithFallback(msgImgEl, urls, './png/pb.png');
        }
        if (lastCapture) {
            const titleEl = document.getElementById('msg-title');
            titleEl.textContent = lastCapture.titleText;
            titleEl.style.color = lastCapture.titleColor;
            document.getElementById('msg-desc').innerHTML = lastCapture.descHtml;
        }
    }

    function closeMsgModal() {
        document.getElementById('modal-layer').classList.add('hidden');
        document.getElementById('modal-msg').classList.add('hidden');
        removeSilhouette();
        // [ë³€ê²½] ë³¼ í•©ê³„ ì²´í¬
        if((user.inventory.super + user.inventory.hyper + user.inventory.special + user.inventory.master) <= 0) endExploration('balls');
        else spawnPokemon();
    }

    function runAway() {
        document.getElementById('modal-layer').classList.add('hidden');
        document.getElementById('modal-encounter').classList.add('hidden');
        removeSilhouette();
        spawnPokemon();
    }

    function updateShopUI() {
        document.getElementById('shop-points').textContent = user.points;
        document.getElementById('lv-steps').textContent = `Lv.${user.upgrades.maxSteps}`;
        document.getElementById('lv-dex').textContent = `Lv.${user.upgrades.dexLimit} (í˜„ì¬ ${30 + user.upgrades.dexLimit * 10}ë§ˆë¦¬)`;

        const timerLv = user.upgrades.timerLevel;
        const curSec = 20 + timerLv;
        document.getElementById('lv-timer').textContent = `Lv.${timerLv} (í˜„ì¬ ${curSec}ì´ˆ)`;

        const timerBtn = document.getElementById('btn-buy-timer');
        if(timerLv >= 20) {
            timerBtn.disabled = true;
            timerBtn.textContent = "Max Level";
        } else {
            timerBtn.disabled = false;
            timerBtn.textContent = "ê°•í™”í•˜ê¸°";
        }

        const rateLv = user.upgrades.catchRate;
        document.getElementById('lv-rate').textContent = `Lv.${rateLv} (í™•ë¥  +${(rateLv * 0.5).toFixed(1)}%)`;
        const rateBtn = document.getElementById('btn-buy-rate');
        if(rateLv >= 10) {
            rateBtn.disabled = true;
            rateBtn.textContent = "Max Level";
        } else {
            rateBtn.disabled = false;
            rateBtn.textContent = "ê°•í™”í•˜ê¸°";
        }

        // --- [ì¶”ê°€] ë¹›ë‚˜ëŠ” ë¶€ì (í¬ê·€ë„) UI ---
        const rareLv = user.upgrades.rareRate || 0;
        const rareProbBonus = (rareLv * 0.5).toFixed(1);
        document.getElementById('lv-rare-rate').textContent = `Lv.${rareLv} (UR í™•ë¥  +${rareProbBonus}%)`;
        const rareBtn = document.getElementById('btn-buy-rare');
        if(rareLv >= 10) {
            rareBtn.disabled = true;
            rareBtn.textContent = "Max Level";
        } else {
            rareBtn.disabled = false;
            rareBtn.textContent = "ê°•í™”í•˜ê¸°";
        }
        
    }

    function buyItem(cat, type, cost) {
        if(user.points < cost) { alert("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•´ìš”!"); return; }
        user.points -= cost;
        user.inventory[type]++;
        saveGame();
        updateShopUI();
    }

    function buyUpgrade(key, cost) {
        if(user.points < cost) { alert("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•´ìš”!"); return; }

        if(key === 'timerLevel' && user.upgrades.timerLevel >= 20) {
            alert("ì´ë¯¸ ì‹œê°„ì„ ìµœëŒ€ë¡œ ëŠ˜ë ¸ì–´ìš”! (40ì´ˆ)"); return;
        }

        if(key === 'catchRate' && user.upgrades.catchRate >= 10) {
            alert("ì´ë¯¸ ìµœê³  ë ˆë²¨ì…ë‹ˆë‹¤!"); return;
        }

        user.points -= cost;
        user.upgrades[key]++;
        saveGame();
        updateShopUI();
    }

    function renderDex() {
        const dexLimit = 30 + (user.upgrades.dexLimit * 10);
        document.getElementById('dex-count').textContent = user.dex.size;
        document.getElementById('dex-limit-display').textContent = dexLimit;

        const grid = document.getElementById('dex-grid');
        grid.innerHTML = "";
        const hint = document.createElement('p');
        hint.style.cssText = "grid-column: 1 / -1; text-align: center; color: #64748b; font-size: 14px; margin-bottom: 10px;";
        hint.textContent = `ë„ê° ìš©ëŸ‰: ${dexLimit}ë§ˆë¦¬ (ìƒì ì—ì„œ í™•ì¥ ê°€ëŠ¥)`;
        grid.appendChild(hint);

        const filterVal = currentFilter;
        let start = 1, end = MAX_POKEMON_ID;
        let showOnlyOwned = false;

        if (filterVal === 'owned') showOnlyOwned = true;
        else {
            const parts = filterVal.split('-');
            start = parseInt(parts[0]);
            end = parseInt(parts[1]);
        }

        if (showOnlyOwned) {
            const ownedIds = Array.from(user.dex).sort((a,b)=>a-b);
            if (ownedIds.length === 0) {
                const msg = document.createElement('div');
                msg.textContent = "ì•„ì§ ì¡ì€ í¬ì¼“ëª¬ì´ ì—†ì–´ìš”!";
                msg.style.cssText = "grid-column: 1/-1; text-align:center; color:#94a3b8; margin-top:20px;";
                grid.appendChild(msg);
                return;
            }
            ownedIds.forEach(id => createDexCard(id, true));
        } else {
            for(let i=start; i<=end; i++) {
                if(i > MAX_POKEMON_ID) break;
                const has = user.dex.has(i);
                createDexCard(i, has);
            }
        }

        function createDexCard(id, has) {
            const d = document.createElement('div');
            d.className = 'dex-item';
            d.style.cssText = "aspect-ratio:1; background:#fff; border-radius:15px; display:flex; justify-content:center; align-items:center; border:2px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative;";
            if(has) {
                d.innerHTML = `<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png'" style="width:80%; image-rendering:pixelated;" loading="lazy">`;
                d.style.borderColor = "#4ade80";
                d.style.background = "#f0fdf4";
                if(user.partnerId === id) d.classList.add('selected-partner');
                d.title = 'íƒ­í•˜ë©´ íŒŒíŠ¸ë„ˆë¡œ ì„¤ì •ë˜ê³  Pixelì—ì„œ ìƒ‰ì¹ ì„ ì‹œì‘í•©ë‹ˆë‹¤.';
                d.onclick = () => setPartnerAndOpenPixel(id);
            } else {
                d.textContent = id;
                d.style.color = "#cbd5e1";
                d.style.fontSize = "14px";
                d.style.fontWeight = "bold";
            }
            grid.appendChild(d);
        }
    }

    function showStepBuyModal() {
        document.getElementById('modal-layer').classList.remove('hidden');
        document.getElementById('modal-step-buy').classList.remove('hidden');
    }

    function buySteps() {
        if (user.points >= 100) {
            user.points -= 100;
            session.steps += 10;
            saveGame();
            updateGameHeader();
            document.getElementById('modal-layer').classList.add('hidden');
            document.getElementById('modal-step-buy').classList.add('hidden');
            alert("10ê±¸ìŒì´ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤! íƒí—˜ì„ ê³„ì†í•˜ì„¸ìš”.");
        } else {
            alert("í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤...");
            endExploration('steps');
        }
    }

    window.addEventListener('keydown', (e) => {
        const gameView = document.getElementById('view-game');
        if (session.active && !isMoving && !gameView.classList.contains('hidden')) {
            if (e.key === 'ArrowUp') {
                move('up');
                e.preventDefault();
            } else if (e.key === 'ArrowDown') {
                move('down');
                e.preventDefault();
            } else if (e.key === 'ArrowLeft') {
                move('left');
                e.preventDefault();
            } else if (e.key === 'ArrowRight') {
                move('right');
                e.preventDefault();
            }
        }
    });

    init();
</script>
</body>
</html>