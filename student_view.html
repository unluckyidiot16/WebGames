<!doctype html>
<meta charset="utf-8" />
<title>My Radar</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Noto Sans KR', sans-serif; margin: 24px; }
    #wrap { max-width: 420px; margin: 0 auto; }
    canvas { max-width: 420px; }
</style>
<div id="wrap">
    <h1>내 레이더</h1>
    <p id="who"></p>
    <canvas id="radar" width="360" height="360"></canvas>
    <div id="msg" style="margin-top:12px;color:#888;"></div>
</div>
<script>
    const SUPA_URL = "https://nfkjolrlegftyvxyrpfr.supabase.co";
    const ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ma2pvbHJsZWdmdHl2eHlycGZyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMTI3NzgsImV4cCI6MjA3NTg4ODc3OH0.p2IhcLKDqNdbDWu6w6R_dvsxubvWf6xtNOqlSkWTSpY";
    const supa = supabase.createClient(SUPA_URL, ANON_KEY);


    function qp(k){ return new URLSearchParams(location.search).get(k); }

    function drawRadar(axes){
        const keys = ['reaction','timing','literacy','problem','strategy','persistence'];
        const vals = keys.map(k => (axes?.[k] ?? 0));
        const ctx = document.getElementById('radar').getContext('2d');
        new Chart(ctx, { type:'radar',
            data:{ labels:['Reaction','Timing','Literacy','Problem','Strategy','Persistence'],
                datasets:[{ label:'최근 지표', data: vals }] },
            options:{ scales:{ r:{ min:0,max:1,ticks:{stepSize:0.2} } }, plugins:{ legend:{ display:false } } }
        });
    }

    (async function main(){
        const t = qp('t');
        const code = qp('code');

        let info;
        if (t) {
            const { data, error } = await supa.rpc('rpc_student_view_info_by_token', { _token: t });
            if (error) { document.getElementById('msg').textContent = error.message; return; }
            info = (data && data[0]) || null;
            // 토큰을 로컬에 저장 (게임에서 코드 없이 업로드 가능)
            localStorage.setItem('studentToken', t);
        } else if (code) {
            const { data, error } = await supa.rpc('rpc_student_view_info_by_code', { _code: code });
            if (error) { document.getElementById('msg').textContent = error.message; return; }
            info = (data && data[0]) || null;
            localStorage.setItem('studentCode', code);
        } else {
            document.getElementById('msg').textContent = 'QR 또는 code 파라미터가 필요합니다.';
            return;
        }

        if (!info) {
            document.getElementById('msg').textContent = '유효하지 않거나 만료된 토큰/코드이거나, 아직 기록이 없습니다.';
            return;
        }

        document.getElementById('who').textContent = info.display_label ? `학생: ${info.display_label}` : '';
        if (info.latest_axes) drawRadar(info.latest_axes);

        const btn = document.getElementById('launchBtn');
        if (info.allow_launch && info.launch_game_url) {
            btn.disabled = false;
            btn.onclick = () => {
                // 토큰 우선 전달 (게임은 토큰으로 업로드 가능)
                const url = new URL(info.launch_game_url);
                if (t) url.searchParams.set('t', t);
                else if (code) url.searchParams.set('code', code);
                window.open(url.toString(), '_blank');
            };
        } else {
            btn.disabled = true;
        }
    })();
</script>

<button id="launchBtn" disabled style="margin-top:12px;padding:10px 14px;border:1px solid #ccc;border-radius:10px;cursor:pointer;">
    게임 시작
</button>
<div id="msg" style="margin-top:12px;color:#888;"></div>
