<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PokÃ©mon Party Battle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif;
            background-color: #202020; color: white; height: 100dvh; overflow: hidden; touch-action: manipulation;
        }
        .pixel-art { image-rendering: pixelated; }
        .view { display: none; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .view.active { display: flex; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .anim-hit { animation: shake 0.4s; filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); }
        .anim-atk { transition: transform 0.2s; transform: scale(1.2); }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ (âœ… @applyëŠ” ë¸Œë¼ìš°ì €ì—ì„œ ë™ì‘í•˜ì§€ ì•Šì•„ì„œ ì¼ë°˜ CSSë¡œ êµì²´) */
        .poke-card {
            background: #1f2937;              /* gray-800 */
            border: 2px solid #4b5563;        /* gray-600 */
            border-radius: 0.75rem;           /* rounded-xl */
            padding: 0.5rem;                  /* p-2 */
            cursor: pointer;
            transition: all 0.2s ease;
            opacity: 0.7;
        }
        .poke-card.selected {
            border-color: #fbbf24;            /* yellow-400 */
            background: #374151;              /* gray-700 */
            opacity: 1;
            box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.45);
            transform: translateY(-5px);
        }

        /* ê²Œì´ì§€ ë°” */
        .gauge-slot { width: 0.75rem; height: 0.75rem; border-radius: 9999px; background: #4b5563; }
        .gauge-slot.filled { background: #60a5fa; box-shadow: 0 0 5px #60a5fa; }
        .hp-bar-fill { transition: width 0.3s ease-out; }
    </style>
</head>
<body>

<section id="lobbyView" class="view active bg-gray-900 overflow-y-auto">
    <div class="w-full max-w-md p-6 flex flex-col h-full">
        <h1 class="text-4xl font-black text-yellow-400 mb-1 text-center italic">POKÃ‰ PARTY</h1>
        <div class="text-xs text-gray-500 text-center mb-6">v14.2 STABLE</div>

        <div class="bg-gray-800 p-4 rounded-2xl mb-6 flex justify-between items-center shadow-lg">
            <div>
                <div class="text-xs text-gray-400">RANKING</div>
                <div class="text-xl font-bold text-white"><span id="myMMR">---</span> P</div>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-400">STATUS</div>
                <div class="text-green-400 font-bold text-sm">ONLINE</div>
            </div>
        </div>

        <div class="flex-1">
            <div class="text-sm text-gray-300 mb-2 font-bold flex justify-between">
                <span>íŒŒí‹° í¸ì„± (3ë§ˆë¦¬ ì„ íƒ)</span>
                <span id="partyCount" class="text-yellow-400">0 / 3</span>
            </div>
            <div class="grid grid-cols-4 gap-2 mb-4" id="pokeSelector"></div>
            <div class="text-[10px] text-gray-500 text-center mb-6">
                ìƒì„±: ğŸ”¥ë¶ˆ > ğŸŒ¿í’€ > ğŸ’§ë¬¼ > ğŸ”¥ë¶ˆ (âš¡ì „ê¸° > ğŸ’§ë¬¼)
            </div>
        </div>

        <div class="space-y-3 mt-auto pb-8">
            <button onclick="startRankedMatch()" id="btnStart" disabled class="w-full bg-yellow-500 hover:bg-yellow-400 disabled:bg-gray-700 disabled:text-gray-500 text-black font-black py-4 rounded-xl shadow-lg border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1 transition-all">
                ë­í‚¹ ë§¤ì¹­ ì‹œì‘
            </button>
            <button onclick="createRoom()" id="btnCreate" disabled class="w-full bg-gray-700 hover:bg-gray-600 disabled:opacity-50 text-white font-bold py-3 rounded-xl border-b-4 border-gray-900 active:border-b-0 active:translate-y-1">
                ë°© ë§Œë“¤ê¸° (ì¹œì„ )
            </button>
            <button onclick="enterCustomLobby()" class="w-full text-xs text-gray-500 underline py-2">ë°© ëª©ë¡ ë³´ê¸°</button>
        </div>
    </div>
</section>

<section id="waitingView" class="view bg-black/90 fixed inset-0 z-50 hidden">
    <div class="text-6xl mb-6 animate-spin">ğŸ˜µâ€ğŸ’«</div>
    <h2 class="text-2xl font-bold mb-2">ì ‘ì† ì¤‘...</h2>
    <p class="text-gray-400 text-sm mb-8" id="waitingMsg">ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘ì…ë‹ˆë‹¤.</p>
    <button onclick="cancelMatching()" class="border border-red-500 text-red-500 px-8 py-2 rounded-full hover:bg-red-500 hover:text-white transition">ì·¨ì†Œ</button>
</section>

<section id="roomListView" class="view bg-gray-900">
    <div class="w-full max-w-md h-full flex flex-col p-4">
        <h2 class="text-xl font-bold mb-4">ëŒ€ê¸°ì‹¤ ëª©ë¡</h2>
        <div id="roomList" class="flex-1 overflow-y-auto space-y-2"></div>
        <button onclick="leaveLobby()" class="mt-4 bg-gray-700 py-3 rounded-xl font-bold">ëŒì•„ê°€ê¸°</button>
    </div>
</section>

<section id="battleView" class="view relative bg-gray-800 justify-between pb-4">
    <div class="absolute top-4 right-4 flex flex-col items-end w-full pr-4 z-10">
        <div class="flex gap-1 mb-1" id="enemyPartyIcons"></div>
        <div class="bg-black/50 px-4 py-2 rounded-lg border border-gray-600 text-right w-48 backdrop-blur-sm">
            <div class="text-sm font-bold text-red-400" id="enemyName">Enemy</div>
            <div class="w-full h-2.5 bg-gray-700 rounded-full mt-1 overflow-hidden">
                <div id="enemyHpBar" class="hp-bar-fill h-full bg-red-500 w-full"></div>
            </div>
            <div class="text-[10px] text-gray-400 mt-1" id="enemyStatusText">Ready</div>
        </div>
        <img id="enemyImg" src="" class="w-32 h-32 pixel-art mt-[-10px] drop-shadow-xl transition-transform duration-300">
    </div>

    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 text-center w-full pointer-events-none">
        <div class="text-5xl font-black text-white drop-shadow-[0_4px_0_#000]" id="timerDisplay"></div>
        <div class="text-yellow-400 font-bold text-xl mt-2 animate-pulse hidden" id="turnMsg">YOUR TURN!</div>
        <div class="text-white font-bold text-lg mt-8 drop-shadow-md hidden" id="damageMsg"></div>
    </div>

    <div class="absolute bottom-32 left-4 flex flex-col items-start w-full pl-4 z-10">
        <img id="myImg" src="" class="w-40 h-40 pixel-art mb-[-20px] drop-shadow-xl transition-transform duration-300">
        <div class="bg-black/50 px-4 py-2 rounded-lg border border-blue-500/50 w-48 backdrop-blur-sm">
            <div class="text-sm font-bold text-blue-300" id="myName">Me</div>
            <div class="w-full h-2.5 bg-gray-700 rounded-full mt-1 overflow-hidden">
                <div id="myHpBar" class="hp-bar-fill h-full bg-blue-500 w-full"></div>
            </div>
            <div class="flex justify-between items-center mt-1">
                <div class="text-[10px] text-gray-300" id="myHpText">100/100</div>
                <div class="flex gap-1" id="myGaugeContainer">
                    <div class="gauge-slot"></div><div class="gauge-slot"></div><div class="gauge-slot"></div>
                </div>
            </div>
        </div>
        <div class="flex gap-1 mt-2" id="myPartyIcons"></div>
    </div>

    <div class="absolute bottom-0 w-full max-w-md bg-gray-900 border-t border-gray-700 p-4 pb-8 z-30">
        <div id="skillPanel" class="flex gap-3">
            <button onclick="selectSkill('normal')" id="btnNormal" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-4 rounded-xl border-b-4 border-slate-900 active:border-b-0 active:translate-y-1 transition-all">
                <div class="font-bold text-sm">ì¼ë°˜ ê³µê²©</div>
                <div class="text-[10px] text-gray-400">ê²Œì´ì§€ +1</div>
            </button>
            <button onclick="selectSkill('special')" id="btnSpecial" disabled class="flex-1 bg-yellow-600 hover:bg-yellow-500 disabled:bg-gray-800 disabled:text-gray-600 text-white py-4 rounded-xl border-b-4 border-yellow-800 disabled:border-gray-900 active:border-b-0 active:translate-y-1 transition-all">
                <div class="font-bold text-sm">íŠ¹ìˆ˜ ê¸°ìˆ </div>
                <div class="text-[10px]">ê²Œì´ì§€ 3 í•„ìš”</div>
            </button>
        </div>

        <div id="quizPanel" class="hidden absolute inset-0 bg-gray-900 p-4">
            <div class="text-center mb-4">
                <p class="text-xs text-gray-400 mb-1">ë¬¸ì œë¥¼ ë§ì¶°ì„œ ê³µê²©í•˜ì„¸ìš”!</p>
                <p class="text-xl font-bold text-white" id="quizQuestion">Loading...</p>
            </div>
            <div id="quizChoices" class="grid grid-cols-2 gap-3 h-24"></div>
        </div>
    </div>
</section>

<div id="resultModal" class="fixed inset-0 bg-black/90 z-50 hidden flex-col items-center justify-center p-4">
    <div class="text-6xl mb-4" id="resIcon">ğŸ†</div>
    <h2 class="text-4xl font-black text-white mb-2" id="resTitle">WIN</h2>
    <p class="text-gray-400 mb-8" id="resDesc">ê²°ê³¼ ì²˜ë¦¬ ì¤‘...</p>
    <button onclick="location.reload()" class="bg-white text-black font-bold py-3 px-8 rounded-full">ë¡œë¹„ë¡œ</button>
</div>

<script>
    // ==========================================
    // 0. ì„¤ì • (ë³¸ì¸ í‚¤ ì…ë ¥ í•„ìˆ˜)
    // ==========================================
    const SUPABASE_URL = 'https://otzhhhzirasqmrdknhib.supabase.co'; // âš ï¸ ë³¸ì¸ URL ì…ë ¥
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90emhoaHppcmFzcW1yZGtuaGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDQ3MjMsImV4cCI6MjA3ODY4MDcyM30.ky1jeShjnEPsUkbGI_ZRtXbdWxiPFEYqRSUiizD98_M'; // âš ï¸ ë³¸ì¸ KEY ì…ë ¥

    let sb = null;
    let myUUID = localStorage.getItem("ppb_uuid") || crypto.randomUUID();
    localStorage.setItem("ppb_uuid", myUUID);

    // ==========================================
    // 1. í¬ì¼“ëª¬ ë°ì´í„°
    // ==========================================
    const POKEMON_DB = {
        1:  { name: "ì´ìƒí•´ì”¨", type: "grass",    img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png", hp: 120, atk: 18, spec: "ë©ì¿¨ì±„ì° (2ë°°)" },
        4:  { name: "íŒŒì´ë¦¬",   type: "fire",     img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png", hp: 110, atk: 22, spec: "í™”ì—¼ë°©ì‚¬ (2ë°°)" },
        7:  { name: "ê¼¬ë¶€ê¸°",   type: "water",    img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png", hp: 115, atk: 19, spec: "í•˜ì´ë“œë¡œíŒí”„ (2ë°°)" },
        25: { name: "í”¼ì¹´ì¸„",   type: "electric", img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png", hp: 100, atk: 25, spec: "10ë§Œë³¼íŠ¸ (2ë°°)" }
    };
    const TYPE_CHART = {
        "fire": { "grass": 1.5, "water": 0.5 },
        "water": { "fire": 1.5, "electric": 0.5 },
        "grass": { "water": 1.5, "fire": 0.5 },
        "electric": { "water": 1.5, "grass": 0.5 }
    };

    let myParty = [];
    let myData = null, enemyData = null;
    let channel = null, lobbyChannel = null;
    let isHost = false, roomId = null;
    let battleMode = 'ranked';
    let battleInitialized = false; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
    let matchLocked = false;        // âœ… ë§¤ì¹­ ì¤‘ë³µ ë°©ì§€
    let handshake = { gotEnemyReady: false, gotMyReadyAck: false, ping: null, startedAt: 0 };

    let gameState = {
        round: 1, phase: 'select', timer: 10,
        myActiveIdx: 0, enemyActiveIdx: 0,
        myPartyState: [], enemyPartyState: [],
        myAnswer: null, enemyAnswer: null, currentQuiz: null
    };
    let timerInterval = null;

    // ==========================================
    // 2. ì´ˆê¸°í™” & ë¡œë¹„
    // ==========================================
    window.onload = () => {
        if(initSupabase()) {
            loadRanking();
            renderPartySelector();
            connectToLobby();
        }
    };

    function initSupabase() {
        if (!SUPABASE_URL || SUPABASE_URL.includes('YOUR')) {
            alert("html íŒŒì¼ì„ ì—´ì–´ Supabase í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”."); return false;
        }
        sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        return true;
    }

    async function loadRanking() {
        // .maybeSingle()ë¡œ ë³€ê²½í•˜ì—¬ 406 ì—ëŸ¬ ë°©ì§€
        const { data, error } = await sb.from('ppb_rankings').select('mmr').eq('user_id', myUUID).maybeSingle();
        if(data) document.getElementById('myMMR').innerText = data.mmr;
        else {
            // ì—†ìœ¼ë©´ ìƒì„± ì‹œë„
            await sb.from('ppb_rankings').insert({ user_id: myUUID, mmr: 1000 });
            document.getElementById('myMMR').innerText = 1000;
        }
    }

    function renderPartySelector() {
        const container = document.getElementById('pokeSelector');
        container.innerHTML = '';
        Object.keys(POKEMON_DB).forEach(id => {
            const p = POKEMON_DB[id];
            const div = document.createElement('div');
            div.className = "poke-card flex flex-col items-center";
            div.innerHTML = `<img src="${p.img}" class="w-12 h-12 pixel-art"><div class="text-[10px] font-bold mt-1">${p.name}</div>`;
            div.onclick = () => togglePartyMember(id, div);
            container.appendChild(div);
        });
    }

    function togglePartyMember(id, el) {
        id = parseInt(id);
        const idx = myParty.indexOf(id);
        if (idx >= 0) {
            myParty.splice(idx, 1); el.classList.remove('selected');
        } else {
            if (myParty.length >= 3) return alert("3ë§ˆë¦¬ê¹Œì§€ë§Œ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            myParty.push(id); el.classList.add('selected');
        }
        document.getElementById('partyCount').innerText = `${myParty.length} / 3`;
        const ready = myParty.length === 3;
        document.getElementById('btnStart').disabled = !ready;
        document.getElementById('btnCreate').disabled = !ready;
    }

    // ==========================================
    // 3. ë§¤ì¹­ ì‹œìŠ¤í…œ (ì•ˆì •í™”ë¨)
    // ==========================================
    function startRankedMatch() {
        battleMode = 'ranked';
        matchLocked = false;
        battleInitialized = false;
        switchView('waitingView');
        document.getElementById('waitingMsg').innerText = "ë¹„ìŠ·í•œ ì‹¤ë ¥ì˜ ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘...";

        if(channel) sb.removeChannel(channel);
        channel = sb.channel('ppb_rank_queue');

        channel.on('presence', { event: 'sync' }, () => {
            if (matchLocked) return;
            const users = Object.values(channel.presenceState()).flat();
            const opponent = users.find(u => u.id !== myUUID && u.status === 'searching');
            if (opponent && myUUID > opponent.id) {
                matchLocked = true;
                const room = `ppb_${myUUID}_${opponent.id}`;
                channel.send({ type: 'broadcast', event: 'match', payload: { room, host: myUUID } });
                joinRoom(room, true);
            }
        }).on('broadcast', { event: 'match' }, ({ payload }) => {
            if (matchLocked) return;
            if (payload.room.includes(myUUID)) {
                matchLocked = true;
                joinRoom(payload.room, payload.host === myUUID);
            }
        }).subscribe(async (s) => {
            if(s==='SUBSCRIBED') await channel.track({ id: myUUID, status: 'searching' });
        });
    }

    function createRoom() {
        battleMode = 'friendly';
        const roomName = `[ë°°í‹€] íŠ¸ë ˆì´ë„ˆ ${myUUID.substring(0,4)}ì˜ ë°©`;
        const roomId = `room_${myUUID}_${Date.now()}`;

        lobbyChannel = sb.channel('ppb_lobby');
        lobbyChannel.subscribe(async (s) => {
            if (s === 'SUBSCRIBED') {
                await lobbyChannel.track({ id: myUUID, isHost: true, roomId, name: roomName });
                waitForChallenger(roomId);
            }
        });

        switchView('waitingView');
        document.getElementById('waitingMsg').innerText = "ë„ì „ìë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
    }

    function waitForChallenger(roomId) {
        channel = sb.channel(roomId);
        channel.on('presence', {event:'join'}, ({newPresences}) => {
            newPresences.forEach(p => { if(p.id !== myUUID) joinRoom(roomId, true); });
        }).subscribe(async (s) => { if(s==='SUBSCRIBED') await channel.track({ id: myUUID }); });
    }

    function connectToLobby() {
        if(lobbyChannel) sb.removeChannel(lobbyChannel);
        lobbyChannel = sb.channel('ppb_lobby');
        lobbyChannel.on('presence', { event: 'sync' }, () => {
            const state = lobbyChannel.presenceState();
            const container = document.getElementById('roomList');
            container.innerHTML = "";
            Object.values(state).flat().filter(u => u.isHost).forEach(r => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-gray-700 p-3 rounded mb-2 text-left hover:bg-gray-600";
                btn.innerText = r.name;
                btn.onclick = () => joinRoom(r.roomId, false);
                container.appendChild(btn);
            });
        }).subscribe();
    }

    // ==========================================
    // 4. ë°°í‹€ ë¡œì§ (Handshake ê°•í™”)
    // ==========================================
    function joinRoom(room, host) {
        if(channel) sb.removeChannel(channel);
        if(lobbyChannel) sb.removeChannel(lobbyChannel);
        roomId = room; isHost = host;
        battleInitialized = false;

        myData = {
            id: myUUID,
            party: myParty.map(id => ({ ...POKEMON_DB[id], maxHp: POKEMON_DB[id].hp * 3, hp: POKEMON_DB[id].hp * 3, charge: 0 }))
        };

        channel = sb.channel(room);

// âœ… ë°© ì§„ì… ì‹œ í•¸ë“œì…°ì´í¬ ìƒíƒœ ë¦¬ì…‹
        handshake = { gotEnemyReady: false, gotMyReadyAck: false, ping: null, startedAt: Date.now() };

        function tryStartBattle() {
            // ë‚´ ìª½ì€ ìƒëŒ€ readyë¥¼ ë°›ì•˜ê³ , ìƒëŒ€ê°€ ë‚´ readyë¥¼ ë°›ì•˜ë‹¤ëŠ” ackê¹Œì§€ ì™€ì•¼ ì‹œì‘
            if (battleInitialized) return;
            if (!enemyData) return;
            if (!handshake.gotEnemyReady) return;
            if (!handshake.gotMyReadyAck) return;

            startBattle();
        }

        channel
            .on('broadcast', { event: 'ready' }, ({ payload }) => {
                if (!payload || payload.id === myUUID) return;

                // ìƒëŒ€ ë°ì´í„° ìˆ˜ì‹ 
                enemyData = payload;
                handshake.gotEnemyReady = true;

                // âœ… ë‚´ê°€ ìƒëŒ€ readyë¥¼ ë°›ì•˜ë‹¤ëŠ” ack ì „ì†¡(ìƒëŒ€ê°€ ë‚´ ready ìˆ˜ì‹  ì—¬ë¶€ íŒë‹¨ìš©)
                channel.send({
                    type: 'broadcast',
                    event: 'ready_ack',
                    payload: { to: payload.id, from: myUUID }
                });

                tryStartBattle();
            })
            .on('broadcast', { event: 'ready_ack' }, ({ payload }) => {
                // ìƒëŒ€ê°€ "ë‚´ readyë¥¼ ë°›ì•˜ë‹¤"ê³  í™•ì¸í•´ì¤Œ
                if (payload && payload.to === myUUID) {
                    handshake.gotMyReadyAck = true;
                    tryStartBattle();
                }
            })
            .on('broadcast', { event: 'quiz_start' }, ({ payload }) => { startQuizPhase(payload); })
            .on('broadcast', { event: 'submit_action' }, ({ payload }) => { if(payload.id !== myData.id) { gameState.enemyAnswer = payload; checkTurnEnd(); } });
    })
    .on('broadcast', { event: 'submit_action' }, ({ payload }) => { if(payload.id !== myData.id) { gameState.enemyAnswer = payload; checkTurnEnd(); } });

    channel.subscribe(async (s) => {
        if(s==='SUBSCRIBED') {
            // âœ… Handshake: ìƒëŒ€ê°€ ë‚´ ë°ì´í„°ë¥¼ 'ë°›ì•˜ë‹¤ê³  ack' í•  ë•Œê¹Œì§€ ë°˜ë³µ ì „ì†¡
            if (handshake.ping) clearInterval(handshake.ping);
            handshake.startedAt = Date.now();
            handshake.ping = setInterval(() => {
                // 15ì´ˆ ë„˜ê²Œ ì§€ì—°ë˜ë©´ ì•ˆë‚´(ë„¤íŠ¸ì›Œí¬/íƒ­ ë°±ê·¸ë¼ìš´ë“œ/ëª¨ë°”ì¼ ì ˆì „ ë“±)
                if (Date.now() - handshake.startedAt > 15000) {
                    clearInterval(handshake.ping);
                    handshake.ping = null;
                    document.getElementById('waitingMsg').innerText = 'ì—°ê²°ì´ ì§€ì—°ë©ë‹ˆë‹¤. ì·¨ì†Œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
                    return;
                }

                // ìƒëŒ€ ackê°€ ì˜¤ë©´ ë” ì´ìƒ ë³´ë‚¼ í•„ìš” ì—†ìŒ
                if (handshake.gotMyReadyAck) {
                    clearInterval(handshake.ping);
                    handshake.ping = null;
                    return;
                }

                channel.send({ type: 'broadcast', event: 'ready', payload: myData });
            }, 700);
        }
    });
    }

    function startBattle() {
        if (battleInitialized) return; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        battleInitialized = true;
        if (handshake && handshake.ping) { clearInterval(handshake.ping); handshake.ping = null; }

        switchView('battleView');

        // ìƒíƒœ ì´ˆê¸°í™”
        gameState.myPartyState = JSON.parse(JSON.stringify(myData.party));
        gameState.enemyPartyState = JSON.parse(JSON.stringify(enemyData.party));
        gameState.myActiveIdx = 0;
        gameState.enemyActiveIdx = 0;

        updateBattleUI();

        // í˜¸ìŠ¤íŠ¸ëŠ” ì ì‹œ ëŒ€ê¸° í›„ ì²« ë¬¸ì œ ì¶œì œ (ìƒëŒ€ê°€ ë¡œë”©í•  ì‹œê°„ í™•ë³´)
        if (isHost) {
            setTimeout(() => startNewRound(), 2000);
        }
    }

    function startNewRound() {
        const n1 = Math.floor(Math.random()*8)+2, n2 = Math.floor(Math.random()*9)+1;
        const ans = n1*n2;
        const choices = new Set([ans]);
        while(choices.size < 4) choices.add(ans + (Math.floor(Math.random()*5)-2)*10);

        const quiz = { q: `${n1} Ã— ${n2} = ?`, a: ans, choices: Array.from(choices).sort(()=>Math.random()-0.5) };
        channel.send({ type: 'broadcast', event: 'quiz_start', payload: quiz });
        startQuizPhase(quiz);
    }

    function startQuizPhase(quiz) {
        // [ìˆ˜ì •] ê²Œì„ ë°ì´í„°ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ë‹¤ë©´ ë¬´ì‹œ (charge ì—ëŸ¬ ë°©ì§€)
        if (!battleInitialized || !gameState.myPartyState.length) return;

        gameState.phase = 'select';
        gameState.currentQuiz = quiz;
        gameState.myAnswer = null;
        gameState.enemyAnswer = null;

        document.getElementById('skillPanel').classList.remove('hidden');
        document.getElementById('quizPanel').classList.add('hidden');
        document.getElementById('btnNormal').disabled = false;

        const myPoke = gameState.myPartyState[gameState.myActiveIdx];
        const btnSpecial = document.getElementById('btnSpecial');
        if (myPoke && myPoke.charge >= 3) { // [ìˆ˜ì •] myPoke ì¡´ì¬ í™•ì¸
            btnSpecial.disabled = false;
            btnSpecial.classList.add('animate-pulse', 'ring-2', 'ring-yellow-400');
        } else {
            btnSpecial.disabled = true;
            btnSpecial.classList.remove('animate-pulse', 'ring-2', 'ring-yellow-400');
        }

        document.getElementById('timerDisplay').innerText = 30;
    }

    function selectSkill(type) {
        gameState.selectedType = type;
        document.getElementById('skillPanel').classList.add('hidden');
        document.getElementById('quizPanel').classList.remove('hidden');

        document.getElementById('quizQuestion').innerText = gameState.currentQuiz.q;
        const grid = document.getElementById('quizChoices');
        grid.innerHTML = "";
        gameState.currentQuiz.choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = "btn-choice bg-gray-700 p-4 rounded text-white font-bold hover:bg-gray-600";
            btn.innerText = c;
            btn.onclick = () => submitAction(c);
            grid.appendChild(btn);
        });
    }

    function submitAction(val) {
        if (gameState.myAnswer) return;
        const correct = val === gameState.currentQuiz.a;
        gameState.myAnswer = { correct, type: gameState.selectedType };
        // âœ… quizPanel DOMì„ í†µì§¸ë¡œ ê°ˆì•„ì—ìœ¼ë©´ ë‹¤ìŒ ë¼ìš´ë“œë¶€í„° ê¹¨ì§
        document.getElementById('quizQuestion').innerText = 'ìƒëŒ€ë°© ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...';
        document.getElementById('quizChoices').innerHTML = '<div class="col-span-2 text-center text-gray-400 py-6">ìƒëŒ€ë°©ì´ ë‹µë³€ ì¤‘ì…ë‹ˆë‹¤...</div>';
        channel.send({ type: 'broadcast', event: 'submit_action', payload: { id: myUUID, correct, type: gameState.selectedType } });
        checkTurnEnd();
    }

    function checkTurnEnd() {
        if (gameState.myAnswer && gameState.enemyAnswer) {
            resolveTurn();
        }
    }

    async function resolveTurn() {
        gameState.phase = 'resolve';
        document.getElementById('quizPanel').classList.add('hidden');

        const meFirst = isHost;
        await executeAttack(meFirst ? 'me' : 'enemy');
        if (checkGameOver()) return;
        await executeAttack(meFirst ? 'enemy' : 'me');
        if (checkGameOver()) return;

        if (isHost) setTimeout(startNewRound, 1500);
    }

    function executeAttack(who) {
        return new Promise(resolve => {
            const isMe = who === 'me';
            const actor = isMe ? gameState.myPartyState[gameState.myActiveIdx] : gameState.enemyPartyState[gameState.enemyActiveIdx];
            const target = isMe ? gameState.enemyPartyState[gameState.enemyActiveIdx] : gameState.myPartyState[gameState.myActiveIdx];
            const action = isMe ? gameState.myAnswer : gameState.enemyAnswer;

            if (!action.correct) {
                showMsg(isMe ? "ê³µê²© ì‹¤íŒ¨ (ì˜¤ë‹µ)" : "ìƒëŒ€ ê³µê²© ì‹¤íŒ¨", "gray");
                setTimeout(resolve, 1000); return;
            }

            let mult = 1.0;
            const typeMatch = TYPE_CHART[actor.type];
            if (typeMatch && typeMatch[target.type]) mult = typeMatch[target.type];

            // âœ… íŠ¹ìˆ˜ê¸°: ê²Œì´ì§€ 3 ë¯¸ë§Œì´ë©´(ë™ê¸°í™”/ì¹˜íŠ¸/ë²„íŠ¼ ìƒíƒœ ê¼¬ì„) ì¼ë°˜ìœ¼ë¡œ ê°•ë“±
            let wantsSpecial = (action.type === 'special');
            if (wantsSpecial && actor.charge < 3) wantsSpecial = false;

            let power = 1.0;
            if (wantsSpecial) {
                power = 2.0; actor.charge = 0;
                showMsg(isMe ? `${actor.spec} ë°œë™!` : `ìƒëŒ€ ${actor.spec}!`, "yellow");
            } else {
                actor.charge = Math.min(3, actor.charge + 1);
            }

            const damage = Math.floor(actor.atk * power * mult);
            target.hp -= damage;

            animAttack(isMe);
            if (mult > 1.0) showMsg("íš¨ê³¼ê°€ êµ‰ì¥í–ˆë‹¤!", "red");
            updateBattleUI();

            if (target.hp <= 0) {
                setTimeout(() => { handleFaint(isMe); resolve(); }, 1000);
            } else {
                setTimeout(resolve, 1500);
            }
        });
    }

    function handleFaint(isEnemyFainted) {
        if (isEnemyFainted) {
            gameState.enemyActiveIdx++;
            showMsg(`ìƒëŒ€ ${gameState.enemyPartyState[gameState.enemyActiveIdx-1].name} ê¸°ì ˆ!`, "white");
        } else {
            gameState.myActiveIdx++;
            showMsg(`ë‚´ ${gameState.myPartyState[gameState.myActiveIdx-1].name} ê¸°ì ˆ!`, "white");
        }
        updateBattleUI();
    }

    function checkGameOver() {
        if (gameState.myActiveIdx >= 3) { endGame(false); return true; }
        if (gameState.enemyActiveIdx >= 3) { endGame(true); return true; }
        return false;
    }

    async function endGame(win) {
        if (battleMode === 'ranked') {
            const change = win ? 20 : -10;
            const cur = parseInt(document.getElementById('myMMR').innerText) || 1000;
            await sb.from('ppb_rankings').update({ mmr: cur + change }).eq('user_id', myUUID);
        }
        document.getElementById('resultModal').classList.remove('hidden');
        document.getElementById('resultModal').classList.add('flex');
        document.getElementById('resTitle').innerText = win ? "VICTORY" : "DEFEAT";
        document.getElementById('resIcon').innerText = win ? "ğŸ†" : "ğŸ’€";
        document.getElementById('resDesc').innerText = win ? "ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!" : "íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...";
        if(channel) sb.removeChannel(channel);
    }

    function updateBattleUI() {
        if (!battleInitialized) return; // ì•ˆì „ì¥ì¹˜

        const myPoke = gameState.myPartyState[gameState.myActiveIdx] || { name: "", hp: 0, maxHp: 1, charge: 0, img: "" };
        const enPoke = gameState.enemyPartyState[gameState.enemyActiveIdx] || { name: "", hp: 0, maxHp: 1, charge: 0, img: "" };

        document.getElementById('myImg').src = myPoke.img;
        document.getElementById('myImg').style.opacity = myPoke.hp > 0 ? 1 : 0.5;
        document.getElementById('myName').innerText = myPoke.name;
        document.getElementById('myHpText').innerText = `${Math.max(0, myPoke.hp)}/${myPoke.maxHp}`;
        document.getElementById('myHpBar').style.width = `${Math.max(0, (myPoke.hp/myPoke.maxHp)*100)}%`;

        const gaugeContainer = document.getElementById('myGaugeContainer');
        gaugeContainer.innerHTML = '';
        for(let i=0; i<3; i++) {
            gaugeContainer.innerHTML += `<div class="gauge-slot ${i < myPoke.charge ? 'filled' : ''}"></div>`;
        }

        document.getElementById('enemyImg').src = enPoke.img;
        document.getElementById('enemyImg').style.opacity = enPoke.hp > 0 ? 1 : 0.5;
        document.getElementById('enemyName').innerText = enPoke.name;
        document.getElementById('enemyHpBar').style.width = `${Math.max(0, (enPoke.hp/enPoke.maxHp)*100)}%`;

        updatePartyIcons('myPartyIcons', gameState.myPartyState, gameState.myActiveIdx);
        updatePartyIcons('enemyPartyIcons', gameState.enemyPartyState, gameState.enemyActiveIdx);
    }

    function updatePartyIcons(id, party, activeIdx) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        party.forEach((p, idx) => {
            const ball = document.createElement('div');
            ball.className = `w-3 h-3 rounded-full border border-gray-600 ${idx < activeIdx ? 'bg-gray-800' : idx === activeIdx ? 'bg-yellow-400' : 'bg-green-500'}`;
            el.appendChild(ball);
        });
    }

    function animAttack(isMe) {
        const img = document.getElementById(isMe ? 'myImg' : 'enemyImg');
        const target = document.getElementById(isMe ? 'enemyImg' : 'myImg');
        img.classList.add('anim-atk');
        setTimeout(() => {
            img.classList.remove('anim-atk');
            target.classList.add('anim-hit');
            setTimeout(() => target.classList.remove('anim-hit'), 400);
        }, 200);
    }

    function showMsg(text, color) {
        const el = document.getElementById('damageMsg');
        const COLOR_CLASS = {
            gray: 'text-gray-400',
            yellow: 'text-yellow-400',
            red: 'text-red-400',
            white: 'text-white'
        };
        el.innerText = text;
        el.className = `${COLOR_CLASS[color] || 'text-white'} font-bold text-lg mt-8 drop-shadow-md animate-bounce`;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 1500);
    }

    function cancelMatching() { if(channel) sb.removeChannel(channel); matchLocked = false; battleInitialized = false; switchView('lobbyView'); }

    () { if(channel) sb.removeChannel(channel); switchView('lobbyView'); }
    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => {
            v.classList.remove('active');
            // waitingViewëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€(ì˜¤ë²„ë ˆì´)
            if (v.id === 'waitingView') v.classList.add('hidden');
        });

        const target = document.getElementById(id);
        if (!target) return;

        target.classList.add('active');
        target.classList.remove('hidden'); // âœ… waitingViewë„ í‘œì‹œë˜ê²Œ
    }

    function enterCustomLobby() { switchView('roomListView'); connectToLobby(); }
    function leaveLobby() { if(lobbyChannel) sb.removeChannel(lobbyChannel); switchView('lobbyView'); }

</script>
</body>
</html>