<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>PokÃ©mon Party Battle</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif;
            background-color: #202020; color: white; height: 100dvh; overflow: hidden; touch-action: manipulation;
        }
        .pixel-art { image-rendering: pixelated; }
        .view { display: none; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .view.active { display: flex; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .anim-hit { animation: shake 0.4s; filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); }
        .anim-atk { transition: transform 0.2s; transform: scale(1.2); }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .poke-card {
            @apply bg-gray-800 border-2 border-gray-600 rounded-xl p-2 cursor-pointer transition-all duration-200 flex flex-col items-center relative;
        }
        .poke-card:hover { @apply bg-gray-700; }
        .poke-card.selected {
            @apply bg-yellow-600 border-yellow-300 ring-2 ring-yellow-400 scale-110 z-10 opacity-100 shadow-xl;
        }
        .poke-card.disabled { @apply opacity-30 cursor-not-allowed filter grayscale; }

        /* ê²Œì´ì§€ ë°” */
        .gauge-slot { @apply w-3 h-3 rounded-full bg-gray-600; }
        .gauge-slot.filled { @apply bg-blue-400 shadow-[0_0_5px_#60a5fa]; }

        .hp-bar-fill { transition: width 0.3s ease-out; }

        .room-item { @apply bg-gray-800 p-4 rounded-xl border border-gray-600 flex justify-between items-center cursor-pointer hover:bg-gray-700 transition-colors mb-2; }

        /* í€´ì¦ˆ ë²„íŠ¼ */
        .btn-choice { @apply bg-gray-700 p-4 rounded-xl text-white font-bold hover:bg-gray-600 border-2 border-gray-600 transition-all active:scale-95; }
        .btn-choice.correct { @apply bg-green-600 border-green-400 ring-2 ring-green-400; }
        .btn-choice.wrong { @apply bg-red-600 border-red-400 ring-2 ring-red-400; }
    </style>
</head>
<body>

<section id="lobbyView" class="view active bg-gray-900 overflow-y-auto">
    <div class="w-full max-w-md p-6 flex flex-col h-full justify-center">
        <h1 class="text-4xl font-black text-yellow-400 mb-1 text-center italic">POKÃ‰ PARTY</h1>
        <div class="text-xs text-gray-500 text-center mb-8">v16.2 BUG FIX</div>

        <div class="bg-gray-800 p-4 rounded-2xl mb-8 flex justify-between items-center shadow-lg border border-gray-700">
            <div>
                <div class="text-xs text-gray-400">RANKING</div>
                <div class="text-xl font-bold text-white"><span id="myMMR">---</span> P</div>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-400">UUID</div>
                <div class="text-green-400 font-bold text-xs" id="myUUIDDisplay">...</div>
            </div>
        </div>

        <div class="space-y-4 w-full">
            <button onclick="startRankedMatch()" class="w-full bg-gradient-to-r from-yellow-600 to-yellow-500 hover:from-yellow-500 hover:to-yellow-400 text-black font-black py-5 rounded-xl shadow-lg border-b-4 border-yellow-800 active:border-b-0 active:translate-y-1 transition-all group">
                <div class="text-lg">âš”ï¸ ë­í‚¹ ë§¤ì¹­</div>
                <div class="text-xs font-normal opacity-70">ë¹„ìŠ·í•œ ì‹¤ë ¥ì˜ ìƒëŒ€ì™€ ëŒ€ê²°</div>
            </button>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="createRoom()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 rounded-xl border-b-4 border-gray-900 active:border-b-0 active:translate-y-1">
                    ë°© ë§Œë“¤ê¸°
                </button>
                <button onclick="enterCustomLobby()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-4 rounded-xl border-b-4 border-gray-900 active:border-b-0 active:translate-y-1">
                    ë°© ëª©ë¡
                </button>
            </div>
        </div>
    </div>
</section>

<section id="customLobbyView" class="view bg-gray-900 justify-start pt-10">
    <div class="w-full max-w-md h-full flex flex-col p-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white">ëŒ€ê¸°ì‹¤ ëª©ë¡</h2>
            <button onclick="leaveLobby()" class="text-sm text-gray-400 hover:text-white">ë‚˜ê°€ê¸°</button>
        </div>
        <div class="flex-1 bg-gray-800/50 rounded-2xl border border-gray-700 p-2 overflow-hidden flex flex-col">
            <div id="roomListContainer" class="flex-1 overflow-y-auto space-y-2 pr-1">
                <div class="text-center text-gray-500 mt-20">ë°©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            </div>
        </div>
    </div>
</section>

<section id="waitingView" class="view bg-black/90 fixed inset-0 z-50 hidden">
    <div class="text-center">
        <div class="text-7xl mb-6 animate-pulse">â³</div>
        <h2 class="text-2xl font-bold mb-2 text-white" id="waitingTitle">ë§¤ì¹­ ì¤‘...</h2>
        <p class="text-gray-400 text-sm mb-8" id="waitingMsg">ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘ì…ë‹ˆë‹¤.</p>
        <button onclick="cancelMatching()" class="border border-red-500 text-red-500 px-8 py-2 rounded-full hover:bg-red-500 hover:text-white transition">ì·¨ì†Œ</button>
    </div>
</section>

<section id="pickView" class="view bg-gray-900">
    <div class="w-full max-w-md p-6 flex flex-col h-full justify-center">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-black text-yellow-400 italic">PICK PHASE</h2>
            <div class="text-sm text-gray-400">ì „íˆ¬ì— ë‚˜ê°ˆ 3ë§ˆë¦¬ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
            <div class="text-4xl font-bold text-white mt-4" id="pickTimer">30</div>
        </div>

        <div class="flex justify-between items-center mb-2 px-2">
            <span class="text-sm font-bold text-gray-300">MY PARTY</span>
            <span id="pickCount" class="text-yellow-400 font-bold">0 / 3</span>
        </div>

        <div class="grid grid-cols-4 gap-3 mb-8" id="pickGrid"></div>

        <div class="bg-gray-800 p-3 rounded-lg text-xs text-gray-400 text-center mb-8">
            <span class="text-red-400 font-bold">ğŸ”¥ë¶ˆ</span> &gt; <span class="text-green-400 font-bold">ğŸŒ¿í’€</span> &gt; <span class="text-blue-400 font-bold">ğŸ’§ë¬¼</span> &gt; <span class="text-red-400 font-bold">ğŸ”¥ë¶ˆ</span><br>
            (<span class="text-yellow-400 font-bold">âš¡ì „ê¸°</span> &gt; <span class="text-blue-400 font-bold">ğŸ’§ë¬¼</span>)
        </div>

        <button onclick="confirmParty()" id="btnConfirmPick" disabled class="w-full bg-green-600 hover:bg-green-500 disabled:bg-gray-700 disabled:text-gray-500 text-white font-bold py-4 rounded-xl shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all">
            ì„ íƒ ì™„ë£Œ
        </button>
        <div id="opponentPickStatus" class="text-center text-sm text-gray-500 mt-4 hidden">ìƒëŒ€ë°©ì´ ì„ íƒ ì¤‘ì…ë‹ˆë‹¤...</div>
    </div>
</section>

<section id="battleView" class="view relative bg-gray-800 justify-between pb-4">
    <button onclick="surrenderGame()" class="absolute top-4 left-4 z-50 bg-gray-900/80 text-white text-xs border border-gray-600 px-3 py-1.5 rounded-full hover:bg-red-900/80 hover:border-red-500 transition-colors">
        ğŸ³ï¸ ê¸°ê¶Œ
    </button>

    <div class="absolute top-4 right-4 flex flex-col items-end w-full pr-4 z-10">
        <div class="flex gap-1 mb-1" id="enemyPartyIcons"></div>
        <div class="bg-black/50 px-4 py-2 rounded-lg border border-gray-600 text-right w-48 backdrop-blur-sm">
            <div class="text-sm font-bold text-red-400" id="enemyName">Enemy</div>
            <div class="w-full h-2.5 bg-gray-700 rounded-full mt-1 overflow-hidden">
                <div id="enemyHpBar" class="hp-bar-fill h-full bg-red-500 w-full"></div>
            </div>
            <div class="text-[10px] text-gray-400 mt-1" id="enemyStatusText">Ready</div>
        </div>
        <img id="enemyImg" src="" class="w-32 h-32 pixel-art mt-[-10px] drop-shadow-xl transition-transform duration-300">
    </div>

    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 text-center w-full pointer-events-none">
        <div class="text-5xl font-black text-white drop-shadow-[0_4px_0_#000]" id="battleTimerDisplay"></div>
        <div class="text-yellow-400 font-bold text-xl mt-2 animate-pulse hidden" id="turnMsg">YOUR TURN!</div>
        <div class="text-white font-bold text-lg mt-8 drop-shadow-md hidden" id="damageMsg"></div>
    </div>

    <div class="absolute bottom-32 left-4 flex flex-col items-start w-full pl-4 z-10">
        <img id="myImg" src="" class="w-40 h-40 pixel-art mb-[-20px] drop-shadow-xl transition-transform duration-300">
        <div class="bg-black/50 px-4 py-2 rounded-lg border border-blue-500/50 w-48 backdrop-blur-sm">
            <div class="text-sm font-bold text-blue-300" id="myName">Me</div>
            <div class="w-full h-2.5 bg-gray-700 rounded-full mt-1 overflow-hidden">
                <div id="myHpBar" class="hp-bar-fill h-full bg-blue-500 w-full"></div>
            </div>
            <div class="flex justify-between items-center mt-1">
                <div class="text-[10px] text-gray-300" id="myHpText">100/100</div>
                <div class="flex gap-1" id="myGaugeContainer">
                    <div class="gauge-slot"></div><div class="gauge-slot"></div><div class="gauge-slot"></div>
                </div>
            </div>
        </div>
        <div class="flex gap-1 mt-2" id="myPartyIcons"></div>
    </div>

    <div class="absolute bottom-0 w-full max-w-md bg-gray-900 border-t border-gray-700 p-4 pb-8 z-30">
        <div id="skillPanel" class="flex gap-3">
            <button onclick="selectSkill('normal')" id="btnNormal" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white py-4 rounded-xl border-b-4 border-slate-900 active:border-b-0 active:translate-y-1 transition-all">
                <div class="font-bold text-sm">ì¼ë°˜ ê³µê²©</div>
                <div class="text-[10px] text-gray-400">ê²Œì´ì§€ +1</div>
            </button>
            <button onclick="selectSkill('special')" id="btnSpecial" disabled class="flex-1 bg-yellow-600 hover:bg-yellow-500 disabled:bg-gray-800 disabled:text-gray-600 text-white py-4 rounded-xl border-b-4 border-yellow-800 disabled:border-gray-900 active:border-b-0 active:translate-y-1 transition-all">
                <div class="font-bold text-sm">íŠ¹ìˆ˜ ê¸°ìˆ </div>
                <div class="text-[10px]">ê²Œì´ì§€ 3 í•„ìš”</div>
            </button>
        </div>
    </div>

    <div id="quizPanel" class="fixed inset-0 bg-black/80 z-50 hidden flex flex-col items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 border-2 border-gray-600 rounded-2xl p-6 w-full max-w-sm shadow-2xl relative animate-[bounce_0.3s]">
            <div class="text-center mb-6">
                <p class="text-xs text-gray-400 mb-1">BRAIN POWER!</p>
                <p class="text-2xl font-black text-white break-keep leading-tight" id="quizQuestion">Loading...</p>
            </div>
            <div id="quizChoices" class="grid grid-cols-2 gap-3"></div>
            <div class="mt-4 text-center text-xs text-gray-500" id="quizStatusMsg">ë¬¸ì œë¥¼ í’€ë©´ ê³µê²©ì´ ë‚˜ê°‘ë‹ˆë‹¤!</div>
        </div>
    </div>
</section>

<div id="updateModal" class="fixed inset-0 bg-black/95 z-[60] hidden flex-col items-center justify-center p-6 text-center">
    <div class="text-6xl mb-4">âš ï¸</div>
    <h2 class="text-3xl font-black text-white mb-2">ì—…ë°ì´íŠ¸ í•„ìš”</h2>
    <p class="text-gray-400 mb-6">ìƒˆë¡œìš´ íŒ¨ì¹˜ê°€ ìˆìŠµë‹ˆë‹¤.<br>ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸ í•´ì£¼ì„¸ìš”.</p>
    <button onclick="location.reload()" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-500">ìƒˆë¡œê³ ì¹¨</button>
</div>

<div id="resultModal" class="fixed inset-0 bg-black/90 z-50 hidden flex-col items-center justify-center p-4">
    <div class="text-6xl mb-4" id="resIcon">ğŸ†</div>
    <h2 class="text-4xl font-black text-white mb-2" id="resTitle">WIN</h2>
    <p class="text-gray-400 mb-8" id="resDesc">ê²°ê³¼ ì²˜ë¦¬ ì¤‘...</p>
    <button onclick="location.reload()" class="bg-white text-black font-bold py-3 px-8 rounded-full">ë¡œë¹„ë¡œ</button>
</div>

<script>
    // ==========================================
    // 0. ì„¤ì •
    // ==========================================
    const GAME_VERSION = "v16.1";
    const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // âš ï¸ í•„ìˆ˜: ë³¸ì¸ URL
    const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY'; // âš ï¸ í•„ìˆ˜: ë³¸ì¸ KEY

    let sb = null;
    let myUUID = localStorage.getItem("ppb_uuid") || crypto.randomUUID();
    localStorage.setItem("ppb_uuid", myUUID);

    // ==========================================
    // 1. ë°ì´í„°
    // ==========================================
    const FALLBACK_IMG = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
    const POKEMON_DB = {
        // ê³µê²©ë ¥ 4ë°° ìƒí–¥ ì ìš©
        1:  { name: "ì´ìƒí•´ì”¨", type: "grass",    img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png", hp: 120, atk: 72, spec: "ë©ì¿¨ì±„ì° (2ë°°)" },
        4:  { name: "íŒŒì´ë¦¬",   type: "fire",     img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png", hp: 110, atk: 88, spec: "í™”ì—¼ë°©ì‚¬ (2ë°°)" },
        7:  { name: "ê¼¬ë¶€ê¸°",   type: "water",    img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png", hp: 115, atk: 76, spec: "í•˜ì´ë“œë¡œíŒí”„ (2ë°°)" },
        25: { name: "í”¼ì¹´ì¸„",   type: "electric", img: "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png", hp: 100, atk: 100, spec: "10ë§Œë³¼íŠ¸ (2ë°°)" }
    };
    const TYPE_CHART = {
        "fire": { "grass": 1.5, "water": 0.5 },
        "water": { "fire": 1.5, "electric": 0.5 },
        "grass": { "water": 1.5, "fire": 0.5 },
        "electric": { "water": 1.5, "grass": 0.5 }
    };

    let myParty = [];
    let myData = null, enemyData = null;
    let channel = null, lobbyChannel = null;
    let isHost = false, roomId = null;
    let battleMode = 'ranked';
    let battleInitialized = false;
    let ackReceived = false;
    let gameEnded = false;

    let gameState = {
        round: 1, phase: 'select', timer: 10,
        myActiveIdx: 0, enemyActiveIdx: 0,
        myPartyState: [], enemyPartyState: [],
        myAnswer: null, enemyAnswer: null, currentQuiz: null
    };
    let timerInterval = null;

    // ==========================================
    // 2. ì´ˆê¸°í™”
    // ==========================================
    window.onload = async () => {
        if(initSupabase()) {
            await checkGameVersion();
            loadRanking();
            document.getElementById('myUUIDDisplay').innerText = myUUID.substring(0,8);
            connectToLobby();
            initPickGrid();
        }
    };

    function initSupabase() {
        if (!SUPABASE_URL || SUPABASE_URL.includes('YOUR')) {
            alert("html íŒŒì¼ì„ ì—´ì–´ Supabase í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”."); return false;
        }
        sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        return true;
    }

    async function checkGameVersion() {
        try {
            const { data, error } = await sb.from('game_info').select('latest_version').eq('id', 1).maybeSingle();
            if (data && data.latest_version && data.latest_version !== GAME_VERSION) {
                document.getElementById('updateModal').classList.remove('hidden');
                document.getElementById('updateModal').classList.add('flex');
                throw new Error("Version mismatch");
            }
        } catch (e) { if(e.message === "Version mismatch") throw e; }
    }

    async function loadRanking() {
        const { data } = await sb.from('ppb_rankings').select('mmr').eq('user_id', myUUID).maybeSingle();
        if(data) document.getElementById('myMMR').innerText = data.mmr;
        else {
            await sb.from('ppb_rankings').insert({ user_id: myUUID, mmr: 1000 });
            document.getElementById('myMMR').innerText = 1000;
        }
    }

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v=>{
            v.classList.remove('active');
            if(id!=='waitingView') document.getElementById('waitingView').classList.add('hidden');
        });
        const target = document.getElementById(id);
        if(target) {
            target.classList.add('active');
            if(id==='waitingView') target.classList.remove('hidden');
        }
    }

    // ==========================================
    // 3. ë§¤ì¹­
    // ==========================================
    function startRankedMatch() {
        battleMode = 'ranked';
        switchView('waitingView');
        document.getElementById('waitingTitle').innerText = "ë§¤ì¹­ ì¤‘...";
        document.getElementById('waitingMsg').innerText = "ë¹„ìŠ·í•œ ì‹¤ë ¥ì˜ ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘...";

        if(channel) sb.removeChannel(channel);
        channel = sb.channel('ppb_rank_queue');

        channel.on('presence', { event: 'sync' }, () => {
            const users = Object.values(channel.presenceState()).flat();
            const opponent = users.find(u => u.id !== myUUID && u.status === 'searching' && u.version === GAME_VERSION);
            if (opponent && myUUID > opponent.id) {
                const room = `ppb_${myUUID}_${opponent.id}`;
                channel.send({ type: 'broadcast', event: 'match', payload: { room, host: myUUID } });
                joinRoom(room, true);
            }
        }).on('broadcast', { event: 'match' }, ({ payload }) => {
            if (payload.room.includes(myUUID)) joinRoom(payload.room, payload.host === myUUID);
        }).subscribe(async (s) => {
            if(s==='SUBSCRIBED') await channel.track({ id: myUUID, status: 'searching', version: GAME_VERSION });
        });
    }

    function createRoom() {
        battleMode = 'friendly';
        const roomName = `[ëŒ€ê¸°ì¤‘] ${myUUID.substring(0,4)}ì˜ ë°©`;
        const rId = `room_${myUUID}_${Date.now()}`;

        lobbyChannel = sb.channel('ppb_lobby');
        lobbyChannel.subscribe(async (s) => {
            if (s === 'SUBSCRIBED') {
                await lobbyChannel.track({ id: myUUID, isHost: true, roomId: rId, name: roomName, version: GAME_VERSION });
                waitForChallenger(rId);
            }
        });

        switchView('waitingView');
        document.getElementById('waitingTitle').innerText = "ëŒ€ê¸°ì‹¤";
        document.getElementById('waitingMsg').innerText = "ë„ì „ìë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
    }

    function waitForChallenger(rId) {
        channel = sb.channel(rId);
        channel.on('presence', {event:'join'}, ({newPresences}) => {
            newPresences.forEach(p => { if(p.id !== myUUID) joinRoom(rId, true); });
        }).subscribe(async (s) => { if(s==='SUBSCRIBED') await channel.track({ id: myUUID }); });
    }

    function connectToLobby() {
        if(lobbyChannel) sb.removeChannel(lobbyChannel);
        lobbyChannel = sb.channel('ppb_lobby');
        lobbyChannel.on('presence', { event: 'sync' }, () => {
            renderRoomList(lobbyChannel.presenceState());
        }).subscribe();
    }

    function renderRoomList(state) {
        const container = document.getElementById('roomListContainer');
        if(!container) return;

        container.innerHTML = "";
        const rooms = Object.values(state).flat().filter(u => u.isHost && u.version === GAME_VERSION);

        if(rooms.length === 0) {
            container.innerHTML = '<div class="text-center text-gray-500 mt-20 flex flex-col items-center"><span class="text-4xl mb-2">ğŸ“­</span>ê°œì„¤ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }

        rooms.forEach(room => {
            const div = document.createElement('div');
            div.className = "room-item";
            div.innerHTML = `<div class="font-bold text-sm text-yellow-400">${room.name}</div><div class="text-xs bg-green-600 px-3 py-1 rounded">ì…ì¥</div>`;
            div.onclick = () => joinRoom(room.roomId, false);
            container.appendChild(div);
        });
    }

    function enterCustomLobby() { switchView('customLobbyView'); connectToLobby(); }
    function leaveLobby() { if(lobbyChannel) sb.removeChannel(lobbyChannel); switchView('lobbyView'); }
    function cancelMatching() { if(channel) sb.removeChannel(channel); switchView('lobbyView'); }

    // ==========================================
    // 4. ì ‘ì† & í”½ í˜ì´ì¦ˆ
    // ==========================================
    function joinRoom(room, host) {
        if(channel) sb.removeChannel(channel);
        if(lobbyChannel) sb.removeChannel(lobbyChannel);
        roomId = room; isHost = host;

        ackReceived = false;
        battleInitialized = false;
        gameEnded = false;
        myData = null; enemyData = null;

        channel = sb.channel(room);

        channel.on('presence', { event: 'leave' }, ({ leftPresences }) => {
            leftPresences.forEach(p => {
                if (p.id !== myUUID && !gameEnded && battleInitialized) {
                    alert("ìƒëŒ€ë°©ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤.");
                    endGame(true);
                }
            });
        });

        channel
            .on('broadcast', { event: 'ready' }, ({ payload }) => {
                if (payload.id !== myUUID) {
                    enemyData = payload;
                    channel.send({ type: 'broadcast', event: 'ready_ack', payload: { to: payload.id } });
                    checkReadyToPick();
                }
            })
            .on('broadcast', { event: 'ready_ack' }, ({ payload }) => {
                if (payload.to === myUUID) { ackReceived = true; checkReadyToPick(); }
            })
            .on('broadcast', { event: 'party_submit' }, ({ payload }) => {
                if (payload.id !== myUUID) { enemyData = { ...enemyData, party: payload.party }; checkBattleStart(); }
            })
            .on('broadcast', { event: 'quiz_start' }, ({ payload }) => { startQuizPhase(payload); })
            .on('broadcast', { event: 'submit_action' }, ({ payload }) => { if(payload.id !== myUUID) { gameState.enemyAnswer = payload; checkTurnEnd(); } })
            .on('broadcast', { event: 'surrender' }, () => { endGame(true); });

        channel.subscribe(async (s) => {
            if(s==='SUBSCRIBED') {
                await channel.track({ id: myUUID, status: 'playing' });
                const ping = setInterval(() => {
                    if(ackReceived) clearInterval(ping);
                    else channel.send({ type: 'broadcast', event: 'ready', payload: { id: myUUID } });
                }, 800);
            }
        });
    }

    function checkReadyToPick() {
        if (enemyData && ackReceived && !battleInitialized) {
            battleInitialized = true;
            startPickPhase();
        }
    }

    function startPickPhase() {
        switchView('pickView');
        myParty = [];
        document.getElementById('pickCount').innerText = "0 / 3";
        document.getElementById('btnConfirmPick').disabled = true;
        document.getElementById('opponentPickStatus').classList.add('hidden');
        renderPartySelector();

        let pickTime = 30;
        document.getElementById('pickTimer').innerText = pickTime;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            pickTime--;
            document.getElementById('pickTimer').innerText = pickTime;
            if(pickTime <= 0) {
                clearInterval(timerInterval);
                autoPick();
            }
        }, 1000);
    }

    function initPickGrid() { }

    function renderPartySelector() {
        const container = document.getElementById('pickGrid');
        container.innerHTML = '';
        Object.keys(POKEMON_DB).forEach(id => {
            const p = POKEMON_DB[id];
            const div = document.createElement('div');
            div.className = "poke-card";
            div.innerHTML = `<img src="${p.img}" class="w-12 h-12 pixel-art" onerror="this.src='${FALLBACK_IMG}'"><div class="text-[10px] font-bold mt-1 text-white">${p.name}</div>`;
            div.onclick = () => togglePick(id, div);
            container.appendChild(div);
        });
    }

    function togglePick(id, el) {
        id = parseInt(id);
        const idx = myParty.indexOf(id);

        if (idx >= 0) {
            myParty.splice(idx, 1);
            el.classList.remove('selected');
            const badge = el.querySelector('.check-badge');
            if(badge) badge.remove();
        } else {
            if (myParty.length >= 3) return;
            myParty.push(id);
            el.classList.add('selected');
            const badge = document.createElement('div');
            badge.className = "check-badge absolute top-1 right-1 bg-green-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold shadow-sm";
            badge.innerText = "âœ“";
            el.appendChild(badge);
        }

        document.getElementById('pickCount').innerText = `${myParty.length} / 3`;
        document.getElementById('btnConfirmPick').disabled = (myParty.length !== 3);
    }

    function autoPick() {
        if (myParty.length < 3) {
            const remaining = Object.keys(POKEMON_DB).map(Number).filter(id => !myParty.includes(id));
            while (myParty.length < 3 && remaining.length > 0) {
                myParty.push(remaining.pop());
            }
        }
        confirmParty();
    }

    function confirmParty() {
        clearInterval(timerInterval);
        document.getElementById('btnConfirmPick').innerText = "ëŒ€ê¸° ì¤‘...";
        document.getElementById('btnConfirmPick').disabled = true;

        myData = {
            id: myUUID,
            party: myParty.map(id => ({ ...POKEMON_DB[id], maxHp: POKEMON_DB[id].hp * 3, hp: POKEMON_DB[id].hp * 3, charge: 0 }))
        };

        channel.send({ type: 'broadcast', event: 'party_submit', payload: myData });
        checkBattleStart();
    }

    function checkBattleStart() {
        if (myData && myData.party && enemyData && enemyData.party) {
            startBattle();
        } else if (myData && myData.party) {
            document.getElementById('opponentPickStatus').classList.remove('hidden');
        }
    }

    // ==========================================
    // 5. ë°°í‹€ ë¡œì§
    // ==========================================
    function startBattle() {
        switchView('battleView');

        gameState.myPartyState = JSON.parse(JSON.stringify(myData.party));
        gameState.enemyPartyState = JSON.parse(JSON.stringify(enemyData.party));
        gameState.myActiveIdx = 0;
        gameState.enemyActiveIdx = 0;

        updateBattleUI();

        if (isHost) {
            setTimeout(() => startNewRound(), 2000);
        }
    }

    function startNewRound() {
        const n1 = Math.floor(Math.random()*8)+2, n2 = Math.floor(Math.random()*9)+1;
        const ans = n1*n2;
        const choices = new Set([ans]);
        while(choices.size < 4) choices.add(ans + (Math.floor(Math.random()*5)-2)*10);

        const quiz = { q: `${n1} Ã— ${n2} = ?`, a: ans, choices: Array.from(choices).sort(()=>Math.random()-0.5) };
        channel.send({ type: 'broadcast', event: 'quiz_start', payload: quiz });
        startQuizPhase(quiz);
    }

    function startQuizPhase(quiz) {
        if (!gameState.myPartyState.length) return;

        gameState.phase = 'select';
        gameState.currentQuiz = quiz;
        gameState.myAnswer = null;
        gameState.enemyAnswer = null;

        document.getElementById('skillPanel').classList.remove('hidden');
        document.getElementById('quizPanel').classList.add('hidden');
        document.getElementById('quizPanel').classList.remove('flex');
        document.getElementById('btnNormal').disabled = false;

        const myPoke = gameState.myPartyState[gameState.myActiveIdx];
        const btnSpecial = document.getElementById('btnSpecial');
        if (myPoke && myPoke.charge >= 3) {
            btnSpecial.disabled = false;
            btnSpecial.classList.add('animate-pulse', 'ring-2', 'ring-yellow-400');
        } else {
            btnSpecial.disabled = true;
            btnSpecial.classList.remove('animate-pulse', 'ring-2', 'ring-yellow-400');
        }

        document.getElementById('battleTimerDisplay').innerText = 30;
    }

    function selectSkill(type) {
        gameState.selectedType = type;
        document.getElementById('skillPanel').classList.add('hidden');
        document.getElementById('quizPanel').classList.remove('hidden');
        document.getElementById('quizPanel').classList.add('flex'); // ì¤‘ì•™ ëª¨ë‹¬

        document.getElementById('quizQuestion').innerText = gameState.currentQuiz.q;
        document.getElementById('quizStatusMsg').innerText = "ë¬¸ì œë¥¼ í’€ë©´ ê³µê²©ì´ ë‚˜ê°‘ë‹ˆë‹¤!";
        const grid = document.getElementById('quizChoices');
        grid.innerHTML = "";
        gameState.currentQuiz.choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = "btn-choice";
            btn.innerText = c;
            btn.onclick = () => submitAction(c);
            grid.appendChild(btn);
        });
    }

    function submitAction(val) {
        if (gameState.myAnswer) return;
        const correct = val === gameState.currentQuiz.a;
        gameState.myAnswer = { correct, type: gameState.selectedType };
        document.getElementById('quizStatusMsg').innerText = "ìƒëŒ€ë°© ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";

        channel.send({ type: 'broadcast', event: 'submit_action', payload: { id: myUUID, correct, type: gameState.selectedType } });
        checkTurnEnd();
    }

    function checkTurnEnd() {
        if (gameState.myAnswer && gameState.enemyAnswer) {
            resolveTurn();
        }
    }

    async function resolveTurn() {
        gameState.phase = 'resolve';
        document.getElementById('quizPanel').classList.add('hidden');
        document.getElementById('quizPanel').classList.remove('flex');

        const meFirst = isHost;
        await executeAttack(meFirst ? 'me' : 'enemy');
        if (checkGameOver()) return;
        await executeAttack(meFirst ? 'enemy' : 'me');
        if (checkGameOver()) return;

        if (isHost) setTimeout(startNewRound, 1500);
    }

    function executeAttack(who) {
        return new Promise(resolve => {
            const isMe = who === 'me';
            const actor = isMe ? gameState.myPartyState[gameState.myActiveIdx] : gameState.enemyPartyState[gameState.enemyActiveIdx];
            const target = isMe ? gameState.enemyPartyState[gameState.enemyActiveIdx] : gameState.myPartyState[gameState.myActiveIdx];
            const action = isMe ? gameState.myAnswer : gameState.enemyAnswer;

            if (!action.correct) {
                showMsg(isMe ? "ê³µê²© ì‹¤íŒ¨ (ì˜¤ë‹µ)" : "ìƒëŒ€ ê³µê²© ì‹¤íŒ¨", "gray");
                setTimeout(resolve, 1000); return;
            }

            let mult = 1.0;
            const typeMatch = TYPE_CHART[actor.type];
            if (typeMatch && typeMatch[target.type]) mult = typeMatch[target.type];

            let power = 1.0;
            if (action.type === 'special') {
                power = 2.0; actor.charge = 0;
                showMsg(isMe ? `${actor.spec} ë°œë™!` : `ìƒëŒ€ ${actor.spec}!`, "yellow");
            } else {
                actor.charge = Math.min(3, actor.charge + 1);
            }

            const damage = Math.floor(actor.atk * power * mult);
            target.hp -= damage;

            animAttack(isMe);
            if (mult > 1.0) showMsg("íš¨ê³¼ê°€ êµ‰ì¥í–ˆë‹¤!", "red");
            updateBattleUI();

            if (target.hp <= 0) {
                setTimeout(() => {
                    // ë²„ê·¸ ìˆ˜ì •: ë‚´ê°€ ê³µê²©í–ˆì„ ë•Œ(isMe) ì ì´ ì£½ì—ˆìœ¼ë©´ handleFaint(true=EnemyFainted)
                    // ì ì´ ê³µê²©í–ˆì„ ë•Œ(!isMe) ë‚´ê°€ ì£½ì—ˆìœ¼ë©´ handleFaint(false=EnemyFainted)
                    handleFaint(isMe);
                    resolve();
                }, 1000);
            } else {
                setTimeout(resolve, 1500);
            }
        });
    }

    function handleFaint(isEnemyFainted) {
        if (isEnemyFainted) {
            gameState.enemyActiveIdx++;
            showMsg(`ìƒëŒ€ ê¸°ì ˆ!`, "white");
        } else {
            gameState.myActiveIdx++;
            showMsg(`ë‚´ í¬ì¼“ëª¬ ê¸°ì ˆ!`, "white");
        }
        updateBattleUI();
    }

    function checkGameOver() {
        if (gameState.myActiveIdx >= 3) { endGame(false); return true; }
        if (gameState.enemyActiveIdx >= 3) { endGame(true); return true; }
        return false;
    }

    function surrenderGame() {
        if(!confirm("ì •ë§ ê¸°ê¶Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        channel.send({ type: 'broadcast', event: 'surrender' });
        endGame(false);
    }

    async function endGame(win) {
        gameEnded = true;
        if (battleMode === 'ranked') {
            const change = win ? 20 : -10;
            const cur = parseInt(document.getElementById('myMMR').innerText) || 1000;
            await sb.from('ppb_rankings').update({ mmr: cur + change }).eq('user_id', myUUID);
        }
        document.getElementById('resultModal').classList.remove('hidden');
        document.getElementById('resultModal').classList.add('flex');
        document.getElementById('resTitle').innerText = win ? "VICTORY" : "DEFEAT";
        document.getElementById('resIcon').innerText = win ? "ğŸ†" : "ğŸ’€";
        document.getElementById('resDesc').innerText = win ? "ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!" : "íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...";

        if(channel) sb.removeChannel(channel);
        if(lobbyChannel) sb.removeChannel(lobbyChannel);
    }

    function updateBattleUI() {
        if (!gameState.myPartyState || gameState.myPartyState.length === 0) return;

        const myPoke = gameState.myPartyState[gameState.myActiveIdx] || { name: "", hp: 0, maxHp: 1, charge: 0, img: "" };
        const enPoke = gameState.enemyPartyState[gameState.enemyActiveIdx] || { name: "", hp: 0, maxHp: 1, charge: 0, img: "" };

        document.getElementById('myImg').src = myPoke.img || FALLBACK_IMG;
        document.getElementById('myImg').style.opacity = myPoke.hp > 0 ? 1 : 0.5;
        document.getElementById('myName').innerText = myPoke.name;
        document.getElementById('myHpText').innerText = `${Math.max(0, myPoke.hp)}/${myPoke.maxHp}`;
        document.getElementById('myHpBar').style.width = `${Math.max(0, (myPoke.hp/myPoke.maxHp)*100)}%`;

        const gaugeContainer = document.getElementById('myGaugeContainer');
        gaugeContainer.innerHTML = '';
        for(let i=0; i<3; i++) {
            gaugeContainer.innerHTML += `<div class="gauge-slot ${i < myPoke.charge ? 'filled' : ''}"></div>`;
        }

        document.getElementById('enemyImg').src = enPoke.img || FALLBACK_IMG;
        document.getElementById('enemyImg').style.opacity = enPoke.hp > 0 ? 1 : 0.5;
        document.getElementById('enemyName').innerText = enPoke.name;
        document.getElementById('enemyHpBar').style.width = `${Math.max(0, (enPoke.hp/enPoke.maxHp)*100)}%`;

        updatePartyIcons('myPartyIcons', gameState.myPartyState, gameState.myActiveIdx);
        updatePartyIcons('enemyPartyIcons', gameState.enemyPartyState, gameState.enemyActiveIdx);
    }

    function updatePartyIcons(id, party, activeIdx) {
        const el = document.getElementById(id);
        el.innerHTML = '';
        party.forEach((p, idx) => {
            const ball = document.createElement('div');
            ball.className = `w-3 h-3 rounded-full border border-gray-600 ${idx < activeIdx ? 'bg-gray-800' : idx === activeIdx ? 'bg-yellow-400' : 'bg-green-500'}`;
            el.appendChild(ball);
        });
    }

    function animAttack(isMe) {
        const img = document.getElementById(isMe ? 'myImg' : 'enemyImg');
        const target = document.getElementById(isMe ? 'enemyImg' : 'myImg');
        img.classList.add('anim-atk');
        setTimeout(() => {
            img.classList.remove('anim-atk');
            target.classList.add('anim-hit');
            setTimeout(() => target.classList.remove('anim-hit'), 400);
        }, 200);
    }

    function showMsg(text, color) {
        const el = document.getElementById('damageMsg');
        el.innerText = text;
        el.className = `text-${color}-400 font-bold text-lg mt-8 drop-shadow-md animate-bounce`;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), 1500);
    }

    function cancelMatching() { if(channel) sb.removeChannel(channel); switchView('lobbyView'); }
    function leaveLobby() { if(lobbyChannel) sb.removeChannel(lobbyChannel); switchView('lobbyView'); }
    function goHome() { window.location.href = "DQR.html"; }

</script>
</body>
</html>