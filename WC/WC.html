<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ImmuneChain: ë°±í˜ˆêµ¬ vs ë°”ì´ëŸ¬ìŠ¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;700&display=swap');

        body { font-family: 'Noto Sans KR', sans-serif; overflow: hidden; user-select: none; }
        .font-jua { font-family: 'Jua', sans-serif; }

        canvas { display: block; touch-action: none; }

        /* Custom Scrollbar for Pokedex */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        .game-overlay { pointer-events: none; }
        .interactive { pointer-events: auto; }

        /* Animation for Evolution/Death */
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            80% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); }
        }
        .animate-pulse-red { animation: pulse-red 2s infinite; }

        /* Pokedex Styles */
        .grayscale-filter { filter: grayscale(100%) contrast(1.2); opacity: 0.7; }
    </style>
</head>
<body class="bg-slate-900 text-white w-full h-full fixed">

<!-- Canvas Layer -->
<canvas id="gameCanvas" class="absolute top-0 left-0 w-full h-full"></canvas>

<!-- UI Layer (In-Game) -->
<div id="uiLayer" class="absolute top-0 left-0 w-full h-full game-overlay flex flex-col justify-between p-4 z-10 hidden">

    <!-- Top HUD: Energy & Evolution -->
    <div class="flex justify-between items-start w-full">
        <div class="flex flex-col gap-2 w-1/3 min-w-[150px]">
            <div class="bg-black/60 p-2 rounded-lg border-2 border-slate-600 backdrop-blur-sm">
                <div class="flex justify-between text-xs text-gray-300 mb-1">
                    <span id="currentSpeciesName" class="font-jua text-lg text-yellow-400 drop-shadow">ì¢… ì´ë¦„</span>
                    <span id="tierLabel" class="text-xs bg-blue-600 px-2 py-0.5 rounded-full font-bold shadow">T0</span>
                </div>
                <!-- Energy Bar -->
                <div class="w-full h-4 bg-gray-700 rounded-full overflow-hidden relative border border-gray-600">
                    <div id="energyBar" class="h-full bg-gradient-to-r from-green-400 to-emerald-600 transition-all duration-300 shadow-[0_0_10px_rgba(74,222,128,0.5)]" style="width: 0%"></div>
                    <p class="absolute inset-0 text-center text-[10px] leading-4 font-bold drop-shadow-md text-white mix-blend-screen">ë©´ì—­ ì—ë„ˆì§€</p>
                </div>
            </div>
        </div>

        <!-- Food Chain Indicator (Right Top) -->
        <div class="bg-black/60 p-3 rounded-xl border border-slate-500 backdrop-blur-md interactive max-w-md hidden sm:block">
            <h3 class="text-xs text-center text-gray-400 mb-2 font-bold">ë°±í˜ˆêµ¬ ì„±ì¥ ë‹¨ê³„</h3>
            <div class="flex items-center justify-between gap-2 text-[10px]">
                <div id="hud-t0" class="flex flex-col items-center opacity-50 transition-all p-1 rounded">
                    <div class="w-9 h-9 rounded-full bg-slate-100 border-2 border-slate-400 mb-1 flex items-center justify-center overflow-hidden">
                        <img src="./png/cell0.png" class="w-full h-full object-contain" alt="cell0">
                    </div>
                    <span>Lv0</span>
                </div>
                <span class="text-gray-500">âœ</span>
                <div id="hud-t1" class="flex flex-col items-center opacity-50 transition-all p-1 rounded">
                    <div class="w-9 h-9 rounded-full bg-slate-100 border-2 border-slate-400 mb-1 flex items-center justify-center overflow-hidden">
                        <img src="./png/cell1.png" class="w-full h-full object-contain" alt="cell1">
                    </div>
                    <span>Lv1</span>
                </div>
                <span class="text-gray-500">âœ</span>
                <div id="hud-t2" class="flex flex-col items-center opacity-50 transition-all p-1 rounded">
                    <div class="w-9 h-9 rounded-full bg-slate-100 border-2 border-slate-400 mb-1 flex items-center justify-center overflow-hidden">
                        <img src="./png/cell2.png" class="w-full h-full object-contain" alt="cell2">
                    </div>
                    <span>Lv2</span>
                </div>
                <span class="text-gray-500">âœ</span>
                <div id="hud-t3" class="flex flex-col items-center opacity-50 transition-all p-1 rounded">
                    <div class="w-9 h-9 rounded-full bg-slate-100 border-2 border-slate-400 mb-1 flex items-center justify-center overflow-hidden">
                        <img src="./png/cell3.png" class="w-full h-full object-contain" alt="cell3">
                    </div>
                    <span>Lv3</span>
                </div>
                <span class="text-gray-500">âœ</span>
                <div id="hud-t4" class="flex flex-col items-center opacity-50 transition-all p-1 rounded">
                    <div class="w-9 h-9 rounded-full bg-slate-100 border-2 border-slate-400 mb-1 flex items-center justify-center overflow-hidden">
                        <img src="./png/cell4.png" class="w-full h-full object-contain" alt="cell4">
                    </div>
                    <span>Lv4</span>
                </div>
                <span class="text-gray-500">âœ</span>
                <div id="hud-t5" class="flex flex-col items-center opacity-50 transition-all p-1 rounded">
                    <div class="w-9 h-9 rounded-full bg-slate-100 border-2 border-slate-400 mb-1 flex items-center justify-center overflow-hidden">
                        <img src="./png/cell5.png" class="w-full h-full object-contain" alt="cell5">
                    </div>
                    <span>Lv5</span>
                </div>
            </div>
        </div>


    </div>

    <!-- Bottom Controls/Info -->
    <div class="flex justify-end items-end w-full">
        <div class="text-right opacity-70 text-xs bg-black/30 p-2 rounded text-white">
            <p>Move: ë§ˆìš°ìŠ¤ / í„°ì¹˜ ë“œë˜ê·¸</p>
            <!-- Removed Dash info -->
        </div>
    </div>
</div>

<!-- Start Screen Modal (Main Lobby) -->
<div id="startScreen" class="absolute inset-0 bg-slate-900 flex flex-col items-center justify-center z-50 interactive backdrop-blur-sm bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgb3BhY2l0eT0iMC4wNSI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9IiZmZmYiLz48L3N2Zz4')]">
    <h1 class="text-6xl font-jua text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-600 mb-2 drop-shadow-lg">ImmuneChain</h1>
    <p class="text-xl text-gray-400 mb-8 font-light tracking-widest">ëª¸ ì† ë©´ì—­ ë¡œê·¸ë¼ì´í¬</p>

    <div class="flex flex-col gap-4 w-full max-w-xs">
        <button id="startBtn" class="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-4 px-8 rounded-xl text-xl shadow-[0_0_20px_rgba(37,99,235,0.4)] transform transition hover:scale-105 active:scale-95 flex items-center justify-center gap-2">
            <span>â–¶</span> ëª¸ ì†ìœ¼ë¡œ ë“¤ì–´ê°€ê¸°
        </button>

        <button id="lobbyPokedexBtn" class="bg-slate-700 hover:bg-slate-600 border border-slate-500 text-white font-bold py-3 px-8 rounded-xl text-lg shadow-lg transform transition hover:scale-105 active:scale-95 flex items-center justify-center gap-2 relative">
            <span>ğŸ“–</span> ë©´ì—­ ë„ê°
            <span class="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center hidden animate-bounce" id="newPokedexBadge">N</span>
        </button>
    </div>

    <div class="mt-8 text-sm text-gray-500 bg-black/20 p-4 rounded-lg text-center">
        <p>ğŸ§« ë‹¹ì‹ ì€ <b class="text-sky-300">ë°±í˜ˆêµ¬</b>ì˜ˆìš”. ë°”ì´ëŸ¬ìŠ¤ë¥¼ ì¡ì•„ë¨¹ì–´ <b class="text-emerald-300">ë©´ì—­ ì—ë„ˆì§€</b>ë¥¼ ëª¨ìœ¼ì„¸ìš”.</p>
        <p>ğŸ¦  <b class="text-red-300">ë‚˜ë³´ë‹¤ í° ë°”ì´ëŸ¬ìŠ¤</b>ëŠ” í”¼í•´ì•¼ í•´ìš”. ê°€ê¹Œì´ ì˜¤ë©´ ìœ„í—˜í•´ìš”!</p>
        <p class="mt-2 text-yellow-400">â­ ê°™ì€ Lvë¼ë„ <b>í¬ê¸°ê°€ ë” í¬ë©´</b> ì´ê¸¸ ìˆ˜ ìˆì–´ìš”.</p>
        <p class="mt-2 text-[12px] text-gray-400">â€» ì´ ê²Œì„ì€ ì´í•´ë¥¼ ë•ê¸° ìœ„í•´ <b>ì•„ì£¼ ê°„ë‹¨í•˜ê²Œ</b> ë§Œë“  ëª¨ë¸ì´ì—ìš”.</p>
    </div>
</div>

<!-- Event Overlay (Death / Clear) -->
<div id="eventOverlay" class="absolute inset-0 bg-black/85 flex flex-col items-center justify-center z-40 hidden interactive p-8 text-center backdrop-blur-sm">
    <div id="eventContent" class="bg-slate-800 p-8 rounded-2xl border-4 border-slate-600 max-w-lg w-full shadow-2xl pop-in relative overflow-hidden">
        <!-- Background Decoration -->
        <div class="absolute inset-0 bg-gradient-to-b from-transparent to-black/50 pointer-events-none"></div>

        <h2 id="eventTitle" class="text-4xl font-jua mb-6 text-red-500 relative z-10 drop-shadow-md">ê°ì—¼ë˜ì—ˆìŠµë‹ˆë‹¤!</h2>

        <div id="eventIcons" class="flex justify-center items-center gap-6 mb-8 relative z-10">
            <!-- Player Icon -->
            <div class="flex flex-col items-center opacity-60 scale-90">
                <div id="eventPlayerImg" class="w-16 h-16 bg-gray-600 rounded-full mb-2 bg-cover bg-center border-2 border-gray-400 shadow-lg"></div>
                <span class="text-sm text-gray-300">ë‚˜</span>
            </div>
            <span id="eventActionIcon" class="text-3xl text-red-500 font-bold animate-pulse">ğŸ¦ </span>
            <!-- Killer Icon -->
            <div class="flex flex-col items-center scale-110">
                <div id="eventKillerImg" class="w-24 h-24 bg-red-600 rounded-full mb-2 bg-cover bg-center border-4 border-red-500 shadow-[0_0_30px_rgba(239,68,68,0.6)]"></div>
                <span id="eventKillerName" class="text-lg font-bold text-red-400">ë°”ì´ëŸ¬ìŠ¤</span>
            </div>
        </div>

        <p id="eventDesc" class="text-lg text-gray-200 mb-8 bg-black/40 p-5 rounded-xl border border-white/10 relative z-10">
            ì„¤ëª… í…ìŠ¤íŠ¸ê°€ ë“¤ì–´ê°‘ë‹ˆë‹¤.
        </p>

        <button id="toMainBtn" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-4 px-6 rounded-xl text-xl transition shadow-lg hover:shadow-gray-500/30 relative z-10 flex items-center justify-center gap-2">
            <span>ğŸ </span> ë©”ì¸ìœ¼ë¡œ
        </button>
    </div>
</div>

<!-- Pokedex Modal -->
<div id="pokedexModal" class="absolute inset-0 bg-slate-900/95 z-50 hidden interactive flex flex-col backdrop-blur-md">
    <div class="p-6 border-b border-slate-700 flex justify-between items-center bg-slate-800 shadow-xl">
        <div>
            <h2 class="text-3xl font-jua text-yellow-400 mb-1">ë©´ì—­ ë„ê°</h2>
            <p class="text-xs text-gray-400">ì„±ì¥í•œ ë°±í˜ˆêµ¬ì™€ ë°œê²¬í•œ ë°”ì´ëŸ¬ìŠ¤ê°€ ê¸°ë¡ë©ë‹ˆë‹¤.</p>
        </div>
        <button id="closePokedex" class="text-gray-400 hover:text-white text-4xl w-10 h-10 flex items-center justify-center hover:bg-white/10 rounded-full transition">&times;</button>
    </div>
    <div class="flex-1 overflow-y-auto p-4 sm:p-8 bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMCIgaGVpZ2h0PSIyMCIgb3BhY2l0eT0iMC4wNSI+PGNpcmNsZSBjeD0iMSIgY3k9IjEiIHI9IjEiIGZpbGw9IiZmZmYiLz48L3N2Zz4')]">
        <div id="pokedexGrid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-w-6xl mx-auto">
            <!-- Cards injected via JS -->
        </div>
    </div>
</div>

<script>
    // --- 1. Game Data & Configuration ---
    const RESOURCES = [
        { id: 'virus0', exp: 1, color: '#a7f3d0' }, // ì•„ì£¼ ì•½í•œ ë°”ì´ëŸ¬ìŠ¤ ì¡°ê°
        { id: 'virus1', exp: 1, color: '#6ee7b7' },
        { id: 'virus2', exp: 2, color: '#fde68a' }, // ë³´í†µ ë°”ì´ëŸ¬ìŠ¤ ì¡°ê°
        { id: 'virus3', exp: 2, color: '#fbbf24' },
        { id: 'virus4', exp: 3, color: '#fdba74' }, // ê°•í•œ ë°”ì´ëŸ¬ìŠ¤ ì¡°ê°
        { id: 'virus5', exp: 3, color: '#fb7185' }
    ];

    // Species Database
    const SPECIES_DB = {
        // --- ë‚´ í¸(í”Œë ˆì´ì–´): ë°±í˜ˆêµ¬ ì„±ì¥ ë‹¨ê³„ ---
        'cell0': { id: 'cell0', name: 'ë°±í˜ˆêµ¬ (ìƒˆì‹¹)', tier: 0, type: 'immune', diet: 'ì‘ì€ ë°”ì´ëŸ¬ìŠ¤', predators: 'ê°•í•œ ë°”ì´ëŸ¬ìŠ¤', desc: 'ëª¸ ì†ì„ ì§€í‚¤ëŠ” ë°±í˜ˆêµ¬ì˜ˆìš”. ì‘ì€ ë°”ì´ëŸ¬ìŠ¤ë¥¼ ì¡ì•„ë¨¹ê³  í˜ì„ í‚¤ì›Œìš”.', color: '#93c5fd', scale: 0.85 },
        'cell1': { id: 'cell1', name: 'ë°±í˜ˆêµ¬ (í›ˆë ¨)', tier: 1, type: 'immune', diet: 'ë°”ì´ëŸ¬ìŠ¤', predators: 'ê°•í•œ ë°”ì´ëŸ¬ìŠ¤', desc: 'ì¡°ê¸ˆ ë” ë¹ ë¥´ê³  íŠ¼íŠ¼í•´ì¡Œì–´ìš”. ë°”ì´ëŸ¬ìŠ¤ë¥¼ ë” ì˜ ì¡ì•„ë¨¹ì–´ìš”.', color: '#60a5fa', scale: 0.92 },
        'cell2': { id: 'cell2', name: 'ë°±í˜ˆêµ¬ (ì „ë¬¸)', tier: 2, type: 'immune', diet: 'ë°”ì´ëŸ¬ìŠ¤', predators: 'ê°•í•œ ë°”ì´ëŸ¬ìŠ¤', desc: 'ëª¸ ì† ìˆœì°°ì„ ë” ì˜í•´ìš”. ë°”ì´ëŸ¬ìŠ¤ê°€ ê°€ê¹Œì´ ì˜¤ë©´ ë°”ë¡œ ë‹¬ë ¤ê°€ìš”.', color: '#38bdf8', scale: 0.98 },
        'cell3': { id: 'cell3', name: 'ë°±í˜ˆêµ¬ (ê°•í™”)', tier: 3, type: 'immune', diet: 'ê°•í•œ ë°”ì´ëŸ¬ìŠ¤', predators: 'ì•„ì£¼ ê°•í•œ ë°”ì´ëŸ¬ìŠ¤', desc: 'í˜ì´ ë” ì„¸ì¡Œì–´ìš”. í° ë°”ì´ëŸ¬ìŠ¤ë„ ì´ê¸¸ ìˆ˜ ìˆì–´ìš”.', color: '#34d399', scale: 1.03 },
        'cell4': { id: 'cell4', name: 'ë°±í˜ˆêµ¬ (ì—˜ë¦¬íŠ¸)', tier: 4, type: 'immune', diet: 'ê°•í•œ ë°”ì´ëŸ¬ìŠ¤', predators: 'ìµœê°• ë°”ì´ëŸ¬ìŠ¤', desc: 'ëª¸ ì† ë°©íŒ¨ ê°™ì€ ì¡´ì¬ì˜ˆìš”. ìœ„í—˜í•œ ë°”ì´ëŸ¬ìŠ¤ë„ ê²ë‚´ì§€ ì•Šì•„ìš”!', color: '#22c55e', scale: 1.08 },
        'cell5': { id: 'cell5', name: 'ë°±í˜ˆêµ¬ (ìµœê°•)', tier: 5, type: 'immune', diet: 'ëª¨ë“  ë°”ì´ëŸ¬ìŠ¤', predators: 'ê±°ì˜ ì—†ìŒ', desc: 'ìµœê°• ë°±í˜ˆêµ¬! ì•„ì£¼ ê°•í•œ ë°”ì´ëŸ¬ìŠ¤ë„ ì¡ì•„ë¨¹ì„ ìˆ˜ ìˆì–´ìš”.', color: '#a78bfa', scale: 1.12 },

        // --- ìƒëŒ€(ì ): ë°”ì´ëŸ¬ìŠ¤ ë‹¨ê³„ ---
        'virus0': { id: 'virus0', name: 'ë°”ì´ëŸ¬ìŠ¤ (ì•½í•¨)', tier: 0, type: 'virus', diet: 'ëª¸ ì†ì— ë“¤ì–´ì˜¤ê¸°', predators: 'ë°±í˜ˆêµ¬', desc: 'ì•½í•œ ë°”ì´ëŸ¬ìŠ¤ì˜ˆìš”. ê·¸ë˜ë„ ë§ì´ ëª¨ì´ë©´ ìœ„í—˜í•´ìš”.', color: '#fda4af', scale: 0.75 },
        'virus1': { id: 'virus1', name: 'ë°”ì´ëŸ¬ìŠ¤ (ì¡°ì‹¬)', tier: 1, type: 'virus', diet: 'ëª¸ ì†ì—ì„œ ëŠ˜ì–´ë‚˜ê¸°', predators: 'ë°±í˜ˆêµ¬', desc: 'ì¡°ì‹¬í•´ì•¼ í•˜ëŠ” ë°”ì´ëŸ¬ìŠ¤ì˜ˆìš”. ê°€ê¹Œì´ ì˜¤ë©´ í”¼í•˜ì„¸ìš”.', color: '#fb7185', scale: 0.85 },
        'virus2': { id: 'virus2', name: 'ë°”ì´ëŸ¬ìŠ¤ (ë³´í†µ)', tier: 2, type: 'virus', diet: 'ë¹ ë¥´ê²Œ í¼ì§€ê¸°', predators: 'ê°•í•œ ë°±í˜ˆêµ¬', desc: 'ë³´í†µë³´ë‹¤ ì„¼ ë°”ì´ëŸ¬ìŠ¤ì˜ˆìš”. ëª¸ì„ ì•„í”„ê²Œ í•  ìˆ˜ ìˆì–´ìš”.', color: '#f59e0b', scale: 0.95 },
        'virus3': { id: 'virus3', name: 'ë°”ì´ëŸ¬ìŠ¤ (ê°•í•¨)', tier: 3, type: 'virus', diet: 'ë” ë¹ ë¥´ê²Œ í¼ì§€ê¸°', predators: 'ê°•í•œ ë°±í˜ˆêµ¬', desc: 'ê°•í•œ ë°”ì´ëŸ¬ìŠ¤ì˜ˆìš”. ë‚˜ë³´ë‹¤ í¬ë©´ ì ˆëŒ€ ê°€ê¹Œì´ ê°€ì§€ ë§ˆì„¸ìš”!', color: '#f97316', scale: 1.05 },
        'virus4': { id: 'virus4', name: 'ë°”ì´ëŸ¬ìŠ¤ (ìœ„í—˜)', tier: 4, type: 'virus', diet: 'ì•„ì£¼ ë¹ ë¥´ê²Œ í¼ì§€ê¸°', predators: 'ì—˜ë¦¬íŠ¸ ë°±í˜ˆêµ¬', desc: 'ìœ„í—˜í•œ ë°”ì´ëŸ¬ìŠ¤ì˜ˆìš”. ê°€ê¹Œì´ ì˜¤ë©´ ì‰½ê²Œ ê°ì—¼ë  ìˆ˜ ìˆì–´ìš”.', color: '#ef4444', scale: 1.12 },
        'virus5': { id: 'virus5', name: 'ë°”ì´ëŸ¬ìŠ¤ (ìµœê°•)', tier: 5, type: 'virus', diet: 'ëª¸ì„ í¬ê²Œ ì•„í”„ê²Œ í•˜ê¸°', predators: 'ìµœê°• ë°±í˜ˆêµ¬', desc: 'ìµœê°• ë°”ì´ëŸ¬ìŠ¤ì˜ˆìš”. ì•„ì£¼ ì¡°ì‹¬í•´ì•¼ í•´ìš”!', color: '#dc2626', scale: 1.20 }
    };

    const PLAYER_TIER_GROUPS = {
        0: ['cell0'],
        1: ['cell1'],
        2: ['cell2'],
        3: ['cell3'],
        4: ['cell4'],
        5: ['cell5']
    };

    const VIRUS_TIER_GROUPS = {
        0: ['virus0'],
        1: ['virus1'],
        2: ['virus2'],
        3: ['virus3'],
        4: ['virus4'],
        5: ['virus5']
    };

    // --- 1. Game Data & Configuration --- ìœ„ìª½ ì–´ë”˜ê°€ì— ì¶”ê°€
    const IMAGE_BASE_PATH = './png/';   // ë˜ëŠ” 'png/' ë„ ê°€ëŠ¥

    // Assets Loader
    const images = {};
    const loadImages = () => {
        // Resources
        RESOURCES.forEach(r => {
            const img = new Image();
            img.src = `${IMAGE_BASE_PATH}${r.id}.png`;   // âœ… ìˆ˜ì •
            images[r.id] = img;
        });
        // Species
        Object.values(SPECIES_DB).forEach(s => {
            const img = new Image();
            img.src = `${IMAGE_BASE_PATH}${s.id}.png`;   // âœ… ìˆ˜ì •
            images[s.id] = img;
        });
    };


    // --- 2. Game State & Logic ---

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let width, height;
    const WORLD_SIZE = 3000;

    let animationFrameId = null;
    let lastTime = 0; // For Delta Time

    let player = {
        x: WORLD_SIZE/2, y: WORLD_SIZE/2,
        baseRadius: 20,
        radius: 20,
        angle: 0,
        speed: 0,
        maxSpeed: 4,
        tier: 0,
        speciesId: 'cell0',
        energy: 0,
        maxEnergy: 50,
        isDead: false
    };

    const mouse = { x: 0, y: 0, active: false, lastPointer: 'mouse' };
    // Removed isBoosting

    let foods = [];
    let enemies = [];
    let particles = [];

    let unlockedSpecies = [];
    let seenSpecies = [];
    let hasPlayedBefore = false;

    try {
        unlockedSpecies = JSON.parse(localStorage.getItem('immuneChain_unlocked')) || ['cell0'];
        seenSpecies = JSON.parse(localStorage.getItem('immuneChain_seen')) || [];
        hasPlayedBefore = localStorage.getItem('immuneChain_hasPlayed') === 'true';
    } catch (e) {
        console.error("Storage Error", e);
        unlockedSpecies = ['cell0'];
    }

    let camX = 0, camY = 0;

    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();


    // --- Input: Mouse / Touch ---
    // Start centered so the player doesn't drift before the first input.
    mouse.x = width / 2;
    mouse.y = height / 2;

    function updateMouseFromClient(clientX, clientY) {
        const rect = canvas.getBoundingClientRect();
        mouse.x = clientX - rect.left;
        mouse.y = clientY - rect.top;
    }

    // Drag-to-move only (mobile friendly)
    // âœ… ì´ë™ì€ "ë“œë˜ê·¸(ëˆ„ë¥´ê³  ì›€ì§ì´ê¸°)" í•˜ëŠ” ë™ì•ˆì—ë§Œ ë©ë‹ˆë‹¤.
    function stopMovementToCenter() {
        mouse.x = width / 2;
        mouse.y = height / 2;
    }

    canvas.addEventListener('pointerdown', (e) => {
        // ë§ˆìš°ìŠ¤ëŠ” ì™¼ìª½ ë²„íŠ¼ë§Œ ë“œë˜ê·¸ë¡œ ì¸ì •
        if (e.pointerType === 'mouse' && e.button !== 0) return;

        mouse.active = true;
        mouse.lastPointer = e.pointerType || 'mouse';
        updateMouseFromClient(e.clientX, e.clientY);
        try { canvas.setPointerCapture(e.pointerId); } catch (_) {}
    }, { passive: true });

    window.addEventListener('pointermove', (e) => {
        if (!mouse.active) return;
        mouse.lastPointer = e.pointerType || mouse.lastPointer || 'mouse';
        updateMouseFromClient(e.clientX, e.clientY);
    }, { passive: true });

    function endDrag(e) {
        if (!mouse.active) return;
        mouse.active = false;
        stopMovementToCenter();
        try { canvas.releasePointerCapture(e.pointerId); } catch (_) {}
    }

    window.addEventListener('pointerup', endDrag, { passive: true });
    window.addEventListener('pointercancel', endDrag, { passive: true });

    // --- 3. Core Functions ---

    function initGame() {
        loadImages();

        // Center the input target at the start
        mouse.x = width / 2;
        mouse.y = height / 2;
        mouse.active = false;

        document.getElementById('uiLayer').classList.remove('hidden');

        setPlayerSpecies('cell0');

        if (!hasPlayedBefore) {
            localStorage.setItem('immuneChain_hasPlayed', 'true');
        }

        resetWorld();
        startGameLoop();
    }

    function resetWorld() {
        foods = [];
        enemies = [];
        player.x = Math.random() * WORLD_SIZE;
        player.y = Math.random() * WORLD_SIZE;
        player.energy = 0;
        player.isDead = false;
        player.tier = SPECIES_DB[player.speciesId].tier;
        updateMaxEnergy();

        for(let i=0; i<300; i++) spawnFood();
        for(let i=0; i<35; i++) spawnEnemy();

        updateHUD();
    }

    function setPlayerSpecies(id) {
        player.speciesId = id;
        const data = SPECIES_DB[id];
        player.tier = data.tier;

        // âœ… ì´ˆë“± 3í•™ë…„ìš© ê°„ë‹¨ ëª¨ë¸:
        // "í¬ê¸°"ëŠ” ì‹¤ì œ ì„¸í¬ í¬ê¸°ê°€ ì•„ë‹ˆë¼ "í˜(ë©´ì—­ ëŠ¥ë ¥)"ì„ ë³´ê¸° ì‰½ê²Œ í‘œì‹œí•œ ê°’ì´ì—ìš”.
        player.baseRadius = (18 + (data.tier * 7)) * (data.scale ?? 1);
        if (player.tier === 0) player.baseRadius = 18 * (data.scale ?? 1);

        player.radius = player.baseRadius;

        // ë ˆë²¨ì´ ë†’ì„ìˆ˜ë¡ ì¡°ê¸ˆ ëŠë ¤ì§€ëŠ” ëŠë‚Œ(ë¬´ê±°ì›Œì§ í‘œí˜„)
        player.maxSpeed = Math.max(2.8, 5.6 - (data.tier * 0.35));
        if (player.tier === 0) player.maxSpeed = 5.8;

        if(!unlockedSpecies.includes(id)) {
            unlockedSpecies.push(id);
            localStorage.setItem('immuneChain_unlocked', JSON.stringify(unlockedSpecies));
            if(!seenSpecies.includes(id)) {
                seenSpecies.push(id);
                localStorage.setItem('immuneChain_seen', JSON.stringify(seenSpecies));
            }
            showBadge();
        }
        updateHUD();
    }

    function updateMaxEnergy() {
        // Lvê°€ ì˜¤ë¥¼ìˆ˜ë¡ ë‹¤ìŒ ì„±ì¥ê¹Œì§€ í•„ìš”í•œ ë©´ì—­ ì—ë„ˆì§€ê°€ ëŠ˜ì–´ë‚˜ìš”.
        player.maxEnergy = 25 + (player.tier * 35);
        if (player.tier === 0) player.maxEnergy = 25;
        if (player.tier === 5) player.maxEnergy = 220;
    }

    function spawnFood() {
        const r = Math.random();
        let typeIdx = 0;
        if (r > 0.9) typeIdx = Math.floor(Math.random() * 2) + 4;
        else if (r > 0.7) typeIdx = Math.floor(Math.random() * 2) + 2;
        else typeIdx = Math.floor(Math.random() * 2);

        const res = RESOURCES[typeIdx];
        foods.push({
            x: Math.random() * WORLD_SIZE,
            y: Math.random() * WORLD_SIZE,
            id: res.id,
            exp: res.exp,
            color: res.color,
            radius: 5 + (typeIdx * 1.5),
            angle: Math.random() * Math.PI * 2
        });
    }

    function spawnEnemy() {
        let possibleTiers = [];
        if (player.tier === 0) possibleTiers = [0, 0, 1];
        else if (player.tier === 1) possibleTiers = [0, 1, 1, 2];
        else if (player.tier === 2) possibleTiers = [1, 2, 2, 3];
        else if (player.tier === 3) possibleTiers = [2, 3, 3, 4];
        else if (player.tier === 4) possibleTiers = [3, 4, 4, 5];
        else possibleTiers = [4, 5];

        const t = possibleTiers[Math.floor(Math.random() * possibleTiers.length)];
        const group = VIRUS_TIER_GROUPS[t];
        const sId = group[Math.floor(Math.random() * group.length)];
        const data = SPECIES_DB[sId];

        const sizeVariance = 0.8 + Math.random() * 0.4;
        let baseR = (18 + (t * 7)) * (data.scale ?? 1);
        if (t === 0) baseR = 18 * (data.scale ?? 1);

        enemies.push({
            x: Math.random() * WORLD_SIZE,
            y: Math.random() * WORLD_SIZE,
            speciesId: sId,
            tier: t,
            baseRadius: baseR,
            radius: baseR * sizeVariance,
            speed: (Math.random() * 2) + 1 + (t === 0 ? 1 : 0),
            vx: 0, vy: 0,
            color: data.color
        });
    }

    function evolve() {
        if (player.tier >= 5) {
            gameClear();
            return;
        }

        const nextTier = player.tier + 1;
        const candidates = PLAYER_TIER_GROUPS[nextTier];
        const nextId = candidates[Math.floor(Math.random() * candidates.length)];

        createExplosion(player.x, player.y, 30, '#ffffff');
        setPlayerSpecies(nextId);
        player.energy = 0;
        updateMaxEnergy();
    }

    function createExplosion(x, y, count, color) {
        for(let i=0; i<count; i++) {
            particles.push({
                x: x, y: y,
                vx: (Math.random() - 0.5) * 12,
                vy: (Math.random() - 0.5) * 12,
                life: 1.0,
                color: color
            });
        }
    }

    // --- 4. Game Loop (Delta Time) ---

    function startGameLoop() {
        if (animationFrameId) cancelAnimationFrame(animationFrameId);
        lastTime = 0;
        requestAnimationFrame(gameLoop);
    }

    function stopGameLoop() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
    }

    function gameLoop(timestamp) {
        if (!lastTime) lastTime = timestamp;
        const deltaTime = timestamp - lastTime;
        lastTime = timestamp;

        // Cap delta time to prevent physics explosion on lag/tab switch (max 100ms)
        const safeDelta = Math.min(deltaTime, 100);

        // Normalize to 60 FPS (approx 16.67ms per frame)
        const timeScale = safeDelta / 16.67;

        update(timeScale);
        draw();
        animationFrameId = requestAnimationFrame(gameLoop);
    }

    function update(timeScale) {
        if (player.isDead) return;

        // Growth
        const growthFactor = 1 + (player.energy / player.maxEnergy) * 0.5;
        player.radius = player.baseRadius * growthFactor;

        // Movement
        const dx = mouse.x - width/2;
        const dy = mouse.y - height/2;
        const angle = Math.atan2(dy, dx);
        player.angle = angle;

        let currentSpeed = mouse.active ? player.maxSpeed : 0;
        // Drag ì¤‘ì¼ ë•Œë§Œ ì´ë™ (í„°ì¹˜/ë§ˆìš°ìŠ¤ ê³µí†µ)
        // Removed Boosting Logic

        player.x += Math.cos(angle) * currentSpeed * timeScale;
        player.y += Math.sin(angle) * currentSpeed * timeScale;

        player.x = Math.max(player.radius, Math.min(WORLD_SIZE - player.radius, player.x));
        player.y = Math.max(player.radius, Math.min(WORLD_SIZE - player.radius, player.y));

        camX = player.x - width / 2;
        camY = player.y - height / 2;

        // Foods
        for (let i = foods.length - 1; i >= 0; i--) {
            const f = foods[i];
            // Apply timeScale to float animation drift
            f.x += (Math.cos(Date.now()/500 + i)*0.2) * timeScale;

            const dist = Math.hypot(player.x - f.x, player.y - f.y);
            if (dist < player.radius + f.radius) {
                player.energy += f.exp;
                createExplosion(f.x, f.y, 3, f.color);
                foods.splice(i, 1);
                spawnFood();

                if (player.energy >= player.maxEnergy) {
                    evolve();
                }
            }
        }

        // Enemies
        for (let i = enemies.length - 1; i >= 0; i--) {
            const e = enemies[i];
            const distToPlayer = Math.hypot(player.x - e.x, player.y - e.y);

            // AI Danger Logic (Threshold: 5% = 1.05)
            if (distToPlayer < 400) {
                const angleToP = Math.atan2(player.y - e.y, player.x - e.x);

                let isPlayerDangerous = false;
                let isPlayerEdible = false;

                if (player.tier > e.tier) isPlayerDangerous = true;
                else if (player.tier < e.tier) isPlayerEdible = true;
                else {
                    // Same Tier: 5% difference
                    if (player.radius > e.radius * 1.05) isPlayerDangerous = true;
                    else if (player.radius < e.radius / 1.05) isPlayerEdible = true;
                }

                let moveX = 0;
                let moveY = 0;

                if (isPlayerDangerous) {
                    moveX = -Math.cos(angleToP) * e.speed;
                    moveY = -Math.sin(angleToP) * e.speed;
                } else if (isPlayerEdible) {
                    moveX = Math.cos(angleToP) * e.speed;
                    moveY = Math.sin(angleToP) * e.speed;
                } else {
                    // Random drift
                    e.vx += (Math.random()-0.5) * 0.5 * timeScale;
                    e.vy += (Math.random()-0.5) * 0.5 * timeScale;
                    // Clamp velocity
                    const maxV = 2;
                    e.vx = Math.max(-maxV, Math.min(maxV, e.vx));
                    e.vy = Math.max(-maxV, Math.min(maxV, e.vy));

                    moveX = e.vx;
                    moveY = e.vy;
                }

                e.x += moveX * timeScale;
                e.y += moveY * timeScale;

            } else {
                // Wander logic
                if (Math.random() < 0.05) {
                    e.vx = (Math.random() - 0.5) * e.speed;
                    e.vy = (Math.random() - 0.5) * e.speed;
                }
                e.x += e.vx * timeScale;
                e.y += e.vy * timeScale;
            }

            e.x = Math.max(e.radius, Math.min(WORLD_SIZE - e.radius, e.x));
            e.y = Math.max(e.radius, Math.min(WORLD_SIZE - e.radius, e.y));

            // Collision Logic (Threshold 5%)
            if (distToPlayer < player.radius + e.radius) {
                let playerWins = false;
                let enemyWins = false;

                if (player.tier > e.tier) playerWins = true;
                else if (player.tier < e.tier) enemyWins = true;
                else {
                    // Same Tier: Need 5% advantage
                    if (player.radius > e.radius * 1.05) playerWins = true;
                    else if (e.radius > player.radius * 1.05) enemyWins = true;
                }

                if (playerWins) {
                    player.energy += 15 * (e.tier + 1);
                    createExplosion(e.x, e.y, 10, e.color);
                    enemies.splice(i, 1);
                    spawnEnemy();
                    if (player.energy >= player.maxEnergy) evolve();
                } else if (enemyWins) {
                    die(e);
                } else {
                    // Bump
                    const angle = Math.atan2(player.y - e.y, player.x - e.x);
                    const pushForce = 5 * timeScale;
                    player.x += Math.cos(angle) * pushForce;
                    player.y += Math.sin(angle) * pushForce;
                    e.x -= Math.cos(angle) * pushForce;
                    e.y -= Math.sin(angle) * pushForce;
                }
            }
        }

        if (enemies.length < 35) spawnEnemy();

        for(let i=particles.length-1; i>=0; i--) {
            let p = particles[i];
            p.x += p.vx * timeScale;
            p.y += p.vy * timeScale;
            p.life -= 0.05 * timeScale;
            if(p.life <= 0) particles.splice(i, 1);
        }

        // HUD
        const p = Math.min((player.energy / player.maxEnergy) * 100, 100);
        document.getElementById('energyBar').style.width = `${p}%`;
        document.getElementById('currentSpeciesName').innerText = SPECIES_DB[player.speciesId].name;
        document.getElementById('tierLabel').innerText = `Lv.${player.tier}`;
    }

    function draw() {
        ctx.fillStyle = '#1e293b';
        ctx.fillRect(0, 0, width, height);

        ctx.save();
        ctx.translate(-camX, -camY);

        ctx.strokeStyle = '#334155';
        ctx.lineWidth = 2;
        ctx.beginPath();
        for(let x=0; x<=WORLD_SIZE; x+=100) { ctx.moveTo(x,0); ctx.lineTo(x, WORLD_SIZE); }
        for(let y=0; y<=WORLD_SIZE; y+=100) { ctx.moveTo(0,y); ctx.lineTo(WORLD_SIZE, y); }
        ctx.stroke();

        foods.forEach(f => {
            ctx.save();
            ctx.translate(f.x, f.y);
            const img = images[f.id];
            if (img && img.complete && img.naturalHeight !== 0) {
                ctx.drawImage(img, -f.radius, -f.radius, f.radius*2, f.radius*2);
            } else {
                ctx.fillStyle = f.color;
                ctx.beginPath();
                ctx.arc(0, 0, f.radius, 0, Math.PI*2);
                ctx.fill();
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.beginPath();
                ctx.arc(-f.radius*0.3, -f.radius*0.3, f.radius*0.3, 0, Math.PI*2);
                ctx.fill();
            }
            ctx.restore();
        });

        enemies.forEach(e => {
            drawEntity(e, false);
        });

        if (!player.isDead) {
            drawEntity(player, true);
        }

        particles.forEach(p => {
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.beginPath();
            ctx.arc(p.x, p.y, 3, 0, Math.PI*2);
            ctx.fill();
            ctx.globalAlpha = 1;
        });

        ctx.restore();
    }

    function drawEntity(entity, isPlayer) {
        ctx.save();
        ctx.translate(entity.x, entity.y);

        const data = SPECIES_DB[entity.speciesId];
        const img = images[entity.speciesId];
        const r = entity.radius;

        ctx.fillStyle = 'white';
        ctx.font = '10px "Noto Sans KR"';
        ctx.textAlign = 'center';
        ctx.shadowColor="black";
        ctx.shadowBlur=4;
        ctx.fillText(data.name, 0, -r - 5);
        ctx.shadowBlur=0;

        if (img && img.complete && img.naturalHeight !== 0) {
            ctx.drawImage(img, -r, -r, r*2, r*2);
        } else {
            ctx.fillStyle = data.color || '#ccc';
            ctx.beginPath();
            ctx.arc(0, 0, r, 0, Math.PI*2);
            ctx.fill();
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(-r*0.3, -r*0.1, r*0.25, 0, Math.PI*2);
            ctx.arc(r*0.3, -r*0.1, r*0.25, 0, Math.PI*2);
            ctx.fill();
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(-r*0.3, -r*0.1, r*0.1, 0, Math.PI*2);
            ctx.arc(r*0.3, -r*0.1, r*0.1, 0, Math.PI*2);
            ctx.fill();
        }

        // Ring Logic
        if (isPlayer) {
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(0,0,r+2,0,Math.PI*2); ctx.stroke();
        } else {
            let isDangerous = false;
            let isEdible = false;

            if (player.tier > entity.tier) isEdible = true;
            else if (player.tier < entity.tier) isDangerous = true;
            else {
                // Same Tier
                if (player.radius > entity.radius * 1.05) isEdible = true;
                else if (entity.radius > player.radius * 1.05) isDangerous = true;
            }

            if (isDangerous) {
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 3;
                ctx.setLineDash([5, 5]);
                ctx.beginPath(); ctx.arc(0,0,r+5,0,Math.PI*2); ctx.stroke();
                ctx.setLineDash([]);
            } else if (isEdible) {
                ctx.strokeStyle = '#4ade80';
                ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(0,0,r+5,0,Math.PI*2); ctx.stroke();
            } else {
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 1;
                ctx.beginPath(); ctx.arc(0,0,r+5,0,Math.PI*2); ctx.stroke();
            }
        }

        ctx.restore();
    }

    // --- 5. UI & Interaction Logic ---

    function updateHUD() {
        ['hud-t0', 'hud-t1', 'hud-t2', 'hud-t3', 'hud-t4', 'hud-t5'].forEach(id => {
            const el = document.getElementById(id);
            if(el) {
                el.style.opacity = '0.5';
                el.classList.remove('scale-110');
            }
        });

        const cur = document.getElementById(`hud-t${player.tier}`);
        if(cur) {
            cur.style.opacity = '1';
            cur.classList.add('scale-110');
        }
    }

    function die(killer) {
        player.isDead = true;
        const kData = SPECIES_DB[killer.speciesId];

        if(!seenSpecies.includes(killer.speciesId)) {
            seenSpecies.push(killer.speciesId);
            localStorage.setItem('immuneChain_seen', JSON.stringify(seenSpecies));
            showBadge();
        }

        document.getElementById('eventTitle').innerText = "ê°ì—¼ë˜ì—ˆìŠµë‹ˆë‹¤!";
        document.getElementById('eventTitle').className = "text-4xl font-jua mb-6 text-red-400 relative z-10 drop-shadow-md";
        document.getElementById('eventActionIcon').innerText = "ğŸ¦ ";
        document.getElementById('eventKillerImg').parentElement.classList.remove('hidden');

        setEventImage('eventPlayerImg', player.speciesId);
        setEventImage('eventKillerImg', killer.speciesId);

        document.getElementById('eventKillerName').innerText = kData.name;
        document.getElementById('eventDesc').innerHTML =
            `<span class="text-yellow-300 font-bold">${kData.name}</span> ì„¤ëª…:<br>"${kData.desc}"<br><br>` +
            `<span class="text-sm text-gray-300">í•˜ëŠ” ì¼: ${kData.diet}</span>`;

        document.getElementById('eventOverlay').classList.remove('hidden');
        document.getElementById('eventOverlay').classList.add('flex');
    }


    function gameClear() {
        player.isDead = true;
        stopGameLoop();

        document.getElementById('eventTitle').innerText = "ë©´ì—­ ì˜ì›…!";
        document.getElementById('eventTitle').className = "text-5xl font-jua mb-6 text-emerald-300 relative z-10 drop-shadow-md";

        setEventImage('eventPlayerImg', player.speciesId);
        document.getElementById('eventActionIcon').innerText = "ğŸ›¡ï¸";
        document.getElementById('eventKillerImg').parentElement.classList.add('hidden');

        document.getElementById('eventDesc').innerHTML =
            `<span class="text-emerald-200 font-bold text-xl">Game Clear!</span><br><br>` +
            `ë‹¹ì‹ ì˜ ë°±í˜ˆêµ¬ëŠ” ì ì  ê°•í•´ì ¸ì„œ<br>ì•„ì£¼ ê°•í•œ ë°”ì´ëŸ¬ìŠ¤ë„ ë¬¼ë¦¬ì³¤ì–´ìš”!<br><br>` +
            `<span class="text-sm text-gray-300">â€» ì‹¤ì œ ëª¸ ì†ì—ì„œëŠ” ë” ë³µì¡í•˜ì§€ë§Œ, ì—¬ê¸°ì„œëŠ” ì‰½ê²Œ ë°°ì›Œìš”.</span>`;

        document.getElementById('eventOverlay').classList.remove('hidden');
        document.getElementById('eventOverlay').classList.add('flex');
    }


    document.getElementById('startBtn').addEventListener('click', () => {
        document.getElementById('startScreen').classList.add('hidden');
        initGame();
    });

    document.getElementById('toMainBtn').addEventListener('click', () => {
        document.getElementById('eventOverlay').classList.add('hidden');
        document.getElementById('eventOverlay').classList.remove('flex');
        stopGameLoop();
        document.getElementById('uiLayer').classList.add('hidden');
        document.getElementById('startScreen').classList.remove('hidden');
    });

    document.getElementById('lobbyPokedexBtn').addEventListener('click', () => {
        renderPokedex();
        document.getElementById('pokedexModal').classList.remove('hidden');
        document.getElementById('newPokedexBadge').classList.add('hidden');
    });

    document.getElementById('closePokedex').addEventListener('click', () => {
        document.getElementById('pokedexModal').classList.add('hidden');
    });

    loadImages();

</script>
</body>
</html>