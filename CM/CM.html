<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°œí‘œ ì œì¶œ - í•™ìƒìš©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@300;400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .transition-all-custom { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .locked-blur { filter: blur(4px); pointer-events: none; user-select: none; }
        @keyframes subtle-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); }
        }
        .animate-submit-pulse { animation: subtle-pulse 2s infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-white to-purple-50 min-h-screen flex items-center justify-center p-4">

<!-- ë©”ì¸ ì¹´ë“œ -->
<div class="w-full max-w-md bg-white/80 backdrop-blur-xl rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-white/50 overflow-hidden relative transition-all-custom">
    <div class="p-6 pb-2 flex justify-between items-center">
        <h1 class="text-2xl font-bold text-slate-800 flex items-center gap-2">
            <i data-lucide="send" class="w-6 h-6 text-indigo-600"></i>
            ë°œí‘œ ì œì¶œ
        </h1>
        <div id="statusBadge" class="px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-500 flex items-center gap-1.5 transition-colors duration-300">
            <span class="w-2 h-2 rounded-full bg-slate-400"></span>
            ëŒ€ê¸° ì¤‘
        </div>
    </div>

    <div id="lockOverlay" class="absolute inset-0 z-20 flex flex-col items-center justify-center bg-white/60 backdrop-blur-sm transition-opacity duration-500 opacity-100">
        <div class="bg-white p-5 rounded-full shadow-lg mb-4 animate-bounce">
            <i data-lucide="lock" class="w-8 h-8 text-slate-400"></i>
        </div>
        <h2 class="text-xl font-bold text-slate-700">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</h2>
        <p class="text-slate-500 text-sm mt-2">ì„ ìƒë‹˜ì˜ ì‹œì‘ ì‹ í˜¸ë¥¼ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤</p>
    </div>

    <div id="formContent" class="p-6 pt-4 space-y-5 transition-all-custom locked-blur">
        <p class="text-slate-500 text-sm">ë°œí‘œí•  ë‚´ìš©ì„ ì‘ì„±í•˜ì—¬ ì„ ìƒë‹˜ê»˜ ì „ì†¡í•˜ì„¸ìš”.</p>
        <form id="submitForm" class="space-y-4">
            <div class="group">
                <label class="block text-xs font-semibold text-slate-500 mb-1.5 ml-1">ì´ë¦„</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i data-lucide="user" class="w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                    </div>
                    <input type="text" id="name" required disabled
                           class="w-full pl-10 pr-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl focus:bg-white focus:border-indigo-500 focus:ring-0 outline-none transition-all text-slate-800 placeholder-slate-400 font-medium"
                           placeholder="ë³¸ì¸ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
            </div>
            <div class="group">
                <label class="block text-xs font-semibold text-slate-500 mb-1.5 ml-1">ë°œí‘œ ë‚´ìš©</label>
                <div class="relative">
                    <div class="absolute top-3 left-3 pointer-events-none">
                        <i data-lucide="message-square" class="w-5 h-5 text-slate-400 group-focus-within:text-indigo-500 transition-colors"></i>
                    </div>
                    <textarea id="message" required rows="4" disabled
                              class="w-full pl-10 pr-4 py-3 bg-slate-50 border-2 border-transparent rounded-xl focus:bg-white focus:border-indigo-500 focus:ring-0 outline-none transition-all text-slate-800 placeholder-slate-400 resize-none"
                              placeholder="ë°œí‘œí•  ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
            </div>
            <button type="submit" id="submitBtn" disabled
                    class="w-full py-4 rounded-xl font-bold text-white shadow-lg shadow-indigo-200 transition-all duration-300 transform active:scale-95 disabled:opacity-50 disabled:shadow-none flex justify-center items-center gap-2 bg-slate-400 cursor-not-allowed">
                <span id="btnText">ì œì¶œ ëŒ€ê¸° ì¤‘</span>
                <i id="btnIcon" data-lucide="lock" class="w-4 h-4"></i>
            </button>
        </form>
    </div>
    <div class="h-1.5 w-full bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
</div>

<div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white text-sm font-bold shadow-xl z-50 transition-all duration-300 transform translate-y-20 opacity-0 flex items-center gap-2 backdrop-blur-md"></div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // ì•„ì´ì½˜ ì´ˆê¸°í™”
        if(window.lucide) window.lucide.createIcons();

        // ==========================================
        // [ì„¤ì •] Supabase í‚¤ (ì ìš© ì™„ë£Œ)
        // ==========================================
        const SUPABASE_URL = 'https://otzhhhzirasqmrdknhib.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90emhoaHppcmFzcW1yZGtuaGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDQ3MjMsImV4cCI6MjA3ODY4MDcyM30.ky1jeShjnEPsUkbGI_ZRtXbdWxiPFEYqRSUiizD98_M';

        let supabase;
        let myClientId = localStorage.getItem('student_client_id');
        if (!myClientId) {
            myClientId = crypto.randomUUID();
            localStorage.setItem('student_client_id', myClientId);
        }

        // DOM ìš”ì†Œ ì°¸ì¡°
        const lockOverlay = document.getElementById('lockOverlay');
        const formContent = document.getElementById('formContent');
        const statusBadge = document.getElementById('statusBadge');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const nameInput = document.getElementById('name');
        const messageInput = document.getElementById('message');

        // ë²„íŠ¼ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ í—¬í¼
        function updateBtnIcon(iconName) {
            const oldIcon = submitBtn.querySelector('svg');
            if (oldIcon) oldIcon.remove();
            const i = document.createElement('i');
            i.setAttribute('data-lucide', iconName);
            i.className = "w-4 h-4";
            submitBtn.appendChild(i);
            if(window.lucide) window.lucide.createIcons();
        }

        // 1. Supabase ì´ˆê¸°í™” (ì„¤ì • ì˜¤ë¥˜ ì²´í¬)
        try {
            if (!SUPABASE_URL || SUPABASE_URL.includes('YOUR_')) {
                throw new Error("Supabase URL ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
            }
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            showToast("âš ï¸ ì„¤ì • ì˜¤ë¥˜: " + e.message, "error");
            console.error(e);
            return; // ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
        }

        // 2. ì‹œìŠ¤í…œ ì‹¤í–‰ (ë°ì´í„° í†µì‹ )
        try {
            setupSystemStatus();
            setupPresence();
        } catch(e) {
            console.error("ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:", e);
        }

        async function setupSystemStatus() {
            const { data, error } = await supabase.from('system_status').select('is_active').eq('id', 1).single();

            if (error && error.code !== 'PGRST116') { // PGRST116: ê²°ê³¼ ì—†ìŒ (ì²« ì‹¤í–‰ ì‹œ ë°œìƒ ê°€ëŠ¥, ë¬´ì‹œ)
                console.error("ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:", error);
            }

            toggleUI(data?.is_active || false);

            // ì‹¤ì‹œê°„ êµ¬ë…
            supabase.channel('public:system_status')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'system_status' },
                    payload => toggleUI(payload.new.is_active))
                .subscribe();
        }

        let presenceChannel;
        function setupPresence() {
            presenceChannel = supabase.channel('class_room');
            presenceChannel.subscribe(async (status) => {
                if (status === 'SUBSCRIBED') await trackPresence();
            });

            let timeout;
            nameInput.addEventListener('input', () => {
                clearTimeout(timeout);
                timeout = setTimeout(trackPresence, 500);
            });
        }

        async function trackPresence() {
            const name = nameInput.value.trim() || 'ìµëª… í•™ìƒ';
            await presenceChannel.track({
                client_id: myClientId,
                student_name: name,
                online_at: new Date().toISOString()
            });
        }

        function toggleUI(isActive) {
            if (isActive) {
                lockOverlay.classList.remove('opacity-100');
                lockOverlay.classList.add('opacity-0', 'pointer-events-none');
                formContent.classList.remove('locked-blur');
                statusBadge.className = "px-3 py-1 rounded-full text-xs font-bold bg-indigo-100 text-indigo-600 flex items-center gap-1.5 shadow-sm";
                statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>ì œì¶œ ê°€ëŠ¥`;
                [nameInput, messageInput, submitBtn].forEach(el => el.disabled = false);
                submitBtn.className = "w-full py-4 rounded-xl font-bold text-white shadow-lg shadow-indigo-200 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-indigo-300 bg-gradient-to-r from-indigo-500 to-purple-600 animate-submit-pulse flex justify-center items-center gap-2";
                btnText.textContent = "ë°œí‘œ ë‚´ìš© ì œì¶œí•˜ê¸°";
                updateBtnIcon('rocket');
            } else {
                lockOverlay.classList.remove('opacity-0', 'pointer-events-none');
                lockOverlay.classList.add('opacity-100');
                formContent.classList.add('locked-blur');
                statusBadge.className = "px-3 py-1 rounded-full text-xs font-bold bg-slate-100 text-slate-500 flex items-center gap-1.5";
                statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-slate-400"></span>ëŒ€ê¸° ì¤‘`;
                [nameInput, messageInput, submitBtn].forEach(el => el.disabled = true);
                submitBtn.className = "w-full py-4 rounded-xl font-bold text-white shadow-none transition-all duration-300 bg-slate-300 cursor-not-allowed flex justify-center items-center gap-2";
                btnText.textContent = "ì„ ìƒë‹˜ ëŒ€ê¸° ì¤‘";
                updateBtnIcon('lock');
            }
        }

        document.getElementById('submitForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = nameInput.value.trim();
            const msg = messageInput.value.trim();
            if (!name || !msg) return;

            // ë°´ í™•ì¸
            const { data: banData } = await supabase.from('banned_users').select('*').eq('client_id', myClientId).gt('banned_until', new Date().toISOString()).single();
            if (banData) {
                const until = new Date(banData.banned_until).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                showToast(`ğŸš« ì „ì†¡ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤ (${until}ê¹Œì§€)`, "error");
                return;
            }

            submitBtn.disabled = true;
            btnText.textContent = "ì „ì†¡ ì¤‘...";
            updateBtnIcon('loader-2');
            const loadingIcon = submitBtn.querySelector('svg');
            if(loadingIcon) loadingIcon.classList.add('animate-spin');

            const { error } = await supabase.from('submissions').insert([{ student_name: name, message: msg }]);

            if (error) {
                showToast("âŒ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.", "error");
                submitBtn.disabled = false;
                btnText.textContent = "ë°œí‘œ ë‚´ìš© ì œì¶œí•˜ê¸°";
                updateBtnIcon('rocket');
            } else {
                showToast("âœ… ì„±ê³µì ìœ¼ë¡œ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤!", "success");
                messageInput.value = '';
                btnText.textContent = "ì œì¶œ ì™„ë£Œ!";
                updateBtnIcon('check');
                submitBtn.classList.replace('from-indigo-500', 'from-green-500');
                submitBtn.classList.replace('to-purple-600', 'to-emerald-600');
                setTimeout(() => {
                    submitBtn.disabled = false;
                    btnText.textContent = "ë°œí‘œ ë‚´ìš© ì œì¶œí•˜ê¸°";
                    updateBtnIcon('rocket');
                    submitBtn.classList.replace('from-green-500', 'from-indigo-500');
                    submitBtn.classList.replace('to-emerald-600', 'to-purple-600');
                }, 2000);
            }
        });

        function showToast(msg, type) {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            const baseClass = "fixed bottom-8 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full text-white text-sm font-bold shadow-xl z-50 transition-all duration-300 transform translate-y-0 opacity-100 flex items-center gap-2 backdrop-blur-md";
            toast.className = type === 'success' ? `${baseClass} bg-green-500/90` : `${baseClass} bg-red-500/90`;
            setTimeout(() => {
                toast.classList.remove('translate-y-0', 'opacity-100');
                toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }
    });
</script>
</body>
</html>