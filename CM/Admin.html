<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>교사용 - 발표 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .card-enter { animation: slideUp 0.5s ease forwards; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        .rank-badge { position: absolute; top: -10px; left: -10px; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; border: 2px solid white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3); z-index: 10; }
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); font-size: 1.2rem; transform: scale(1.1); }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0, #808080); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #A0522D); }
        .rank-other { background: #475569; font-size: 0.8rem; }
    </style>
</head>
<body class="bg-slate-900 min-h-screen text-slate-100 flex flex-col">

<header class="bg-slate-800 border-b border-slate-700 p-4 sticky top-0 z-20 shadow-lg">
    <div class="max-w-7xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <i data-lucide="monitor-play" class="w-6 h-6 text-blue-400"></i>
            <h1 class="text-xl font-bold">발표 시스템 <span id="statusBadge" class="text-xs px-2 py-1 rounded bg-red-900 text-red-200 ml-2">잠금 상태</span></h1>
        </div>

        <div class="flex items-center gap-2">
            <!-- 버튼들 -->
            <button id="startBtn" class="flex items-center gap-2 px-5 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition shadow-lg">
                <i data-lucide="play" class="w-4 h-4"></i> 3초 후 시작
            </button>

            <button id="lockBtn" class="flex items-center gap-2 px-5 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-bold rounded-lg transition shadow-lg hidden">
                <i data-lucide="lock" class="w-4 h-4"></i> 입력 잠금
            </button>

            <div class="h-8 w-px bg-slate-600 mx-2"></div>

            <button id="resetBtn" class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-red-600 text-slate-200 hover:text-white font-medium rounded-lg transition border border-slate-600">
                <i data-lucide="trash-2" class="w-4 h-4"></i> 전체 삭제
            </button>

            <button onclick="openUserManager()" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-lg transition ml-2">
                <i data-lucide="users" class="w-4 h-4"></i> 학생 관리
            </button>
        </div>
    </div>
</header>

<main class="flex-1 p-6 overflow-y-auto">
    <div id="messageList" class="max-w-7xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    <div id="emptyState" class="flex flex-col items-center justify-center h-96 text-slate-500">
        <i data-lucide="inbox" class="w-16 h-16 opacity-30 mb-4"></i>
        <p>제출된 메시지가 없습니다.</p>
    </div>
</main>

<div id="countdownOverlay" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden backdrop-blur-sm">
    <div id="countdownNum" class="text-9xl font-black text-white">3</div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        if(window.lucide) window.lucide.createIcons();

        // ==========================================
        // [설정] Supabase 키 (반드시 입력!)
        // ==========================================
        const SUPABASE_URL = 'https://otzhhhzirasqmrdknhib.supabase.co'; // 고객님의 URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90emhoaHppcmFzcW1yZGtuaGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDQ3MjMsImV4cCI6MjA3ODY4MDcyM30.ky1jeShjnEPsUkbGI_ZRtXbdWxiPFEYqRSUiizD98_M'; // 고객님의 KEY

        let supabase;
        const messageList = document.getElementById('messageList');
        const emptyState = document.getElementById('emptyState');
        const startBtn = document.getElementById('startBtn');
        const lockBtn = document.getElementById('lockBtn');
        const resetBtn = document.getElementById('resetBtn');
        const statusBadge = document.getElementById('statusBadge');

        // 팝업 열기 함수
        window.openUserManager = function() {
            const width = 500;
            const height = 600;
            const left = (window.screen.width / 2) - (width / 2);
            const top = (window.screen.height / 2) - (height / 2);
            window.open('manager.html', 'UserManager', `width=${width},height=${height},top=${top},left=${left}`);
        };

        try {
            if (!SUPABASE_URL || SUPABASE_URL.includes('YOUR_')) {
                throw new Error("Supabase URL 및 KEY를 설정해주세요.");
            }
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            init();
        } catch (e) {
            console.error(e);
            alert("설정 오류: " + e.message + "\n코드를 열어 키가 올바른지 확인해주세요.");
        }

        function init() {
            // 이벤트 연결
            startBtn.onclick = startSession;
            lockBtn.onclick = lockSession;
            resetBtn.onclick = resetData;

            // 데이터 불러오기
            fetchMessages();

            // [수정] 이 함수가 정의되어 있어야 합니다.
            checkSystemStatus();

            // 실시간 구독
            supabase.channel('realtime-messages')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'submissions' },
                    payload => { addCard(payload.new); })
                .subscribe();

            supabase.channel('status-check')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'system_status' },
                    payload => { updateStatusUI(payload.new.is_active); })
                .subscribe();
        }

        // --- [추가됨] 시스템 상태 확인 함수 ---
        async function checkSystemStatus() {
            const { data } = await supabase.from('system_status').select('is_active').eq('id', 1).single();
            // 데이터가 없으면 false, 있으면 값 적용
            updateStatusUI(data ? data.is_active : false);
        }

        // --- 세션 제어 로직 ---
        async function startSession() {
            const overlay = document.getElementById('countdownOverlay');
            const num = document.getElementById('countdownNum');
            overlay.classList.remove('hidden');

            let count = 3;
            num.innerText = count;
            const timer = setInterval(() => {
                count--;
                if(count > 0) num.innerText = count;
                else {
                    clearInterval(timer);
                    overlay.classList.add('hidden');
                    supabase.from('system_status').upsert({ id: 1, is_active: true }).then();
                }
            }, 1000);
        }

        async function lockSession() {
            await supabase.from('system_status').upsert({ id: 1, is_active: false });
        }

        async function resetData() {
            if(!confirm("모든 발표 데이터를 영구 삭제하시겠습니까? (잠금 상태로 전환됩니다)")) return;

            await supabase.from('system_status').upsert({ id: 1, is_active: false });

            const { error } = await supabase.from('submissions').delete().neq('id', 0);

            if(!error) {
                messageList.innerHTML = '';
                emptyState.style.display = 'flex';
            } else {
                alert("삭제 실패: " + error.message);
            }
        }

        function updateStatusUI(isActive) {
            if(isActive) {
                startBtn.classList.add('hidden');
                lockBtn.classList.remove('hidden');
                statusBadge.className = "text-xs px-2 py-1 rounded bg-green-900 text-green-200 ml-2 animate-pulse";
                statusBadge.textContent = "실시간 진행 중";
            } else {
                startBtn.classList.remove('hidden');
                lockBtn.classList.add('hidden');
                statusBadge.className = "text-xs px-2 py-1 rounded bg-red-900 text-red-200 ml-2";
                statusBadge.textContent = "잠금 상태";
            }
        }

        // --- 메시지 렌더링 로직 ---
        async function fetchMessages() {
            const { data } = await supabase.from('submissions').select('*').order('created_at', { ascending: true });
            if(data && data.length > 0) data.forEach(addCard);
        }

        function addCard(data) {
            emptyState.style.display = 'none';

            const rank = messageList.children.length + 1;
            let rankClass = 'rank-other';
            let rankText = rank + '등';
            if(rank === 1) { rankClass = 'rank-1'; rankText = '1'; }
            else if(rank === 2) { rankClass = 'rank-2'; rankText = '2'; }
            else if(rank === 3) { rankClass = 'rank-3'; rankText = '3'; }

            const card = document.createElement('div');
            card.className = "bg-slate-800 rounded-xl p-5 border border-slate-700 shadow relative card-enter hover:bg-slate-750 transition";
            card.innerHTML = `
                    <div class="rank-badge ${rankClass}">${rankText}</div>
                    <div class="flex items-center gap-3 mb-2 pl-4">
                        <div class="font-bold text-lg text-white">${escapeHtml(data.student_name)}</div>
                        <div class="text-xs text-slate-400">${new Date(data.created_at).toLocaleTimeString()}</div>
                    </div>
                    <p class="text-slate-300 pl-4 break-words">${escapeHtml(data.message)}</p>
                `;
            messageList.appendChild(card);
        }

        function escapeHtml(text) {
            return text ? text.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "";
        }
    });
</script>
</body>
</html>