<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>발표 대기열 - 교사용</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/lucide.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }

        .card-enter { animation: slideInUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(30px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .countdown-text {
            animation: popIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="bg-slate-900 min-h-screen text-slate-100 flex flex-col">

<!-- 헤더 -->
<header class="bg-slate-800 border-b border-slate-700 p-6 sticky top-0 z-10 shadow-lg">
    <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 p-2 rounded-lg">
                <i data-lucide="monitor-play" class="w-6 h-6 text-white"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold tracking-wide">실시간 발표 시스템</h1>
                <div id="connectionStatus" class="flex items-center gap-2 text-xs text-slate-400 mt-1">
                    <span class="w-2 h-2 rounded-full bg-red-500" id="statusDot"></span>
                    <span id="statusText">연결 대기중...</span>
                </div>
            </div>
        </div>

        <!-- 컨트롤 패널 -->
        <div class="flex items-center gap-3 bg-slate-750 p-1.5 rounded-xl border border-slate-700">
            <!-- onclick 제거하고 id로 제어 -->
            <button id="startBtn" class="flex items-center gap-2 px-6 py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg transition-all shadow-lg hover:shadow-green-500/20 active:scale-95">
                <i data-lucide="play" class="w-5 h-5"></i>
                <span>3초 후 시작</span>
            </button>

            <button id="resetBtn" class="flex items-center gap-2 px-4 py-3 bg-slate-700 hover:bg-slate-600 text-slate-200 font-medium rounded-lg transition-all active:scale-95 border border-slate-600">
                <i data-lucide="refresh-ccw" class="w-5 h-5"></i>
                <span>초기화 & 잠금</span>
            </button>

            <button id="clearBtn" class="flex items-center gap-2 px-4 py-3 text-slate-400 hover:text-white hover:bg-slate-700 rounded-lg transition-all" title="화면만 지우기">
                <i data-lucide="trash-2" class="w-5 h-5"></i>
            </button>
        </div>
    </div>
</header>

<!-- 메인 컨텐츠 영역 -->
<main class="flex-1 p-6 overflow-y-auto bg-slate-900 relative">
    <div id="messageList" class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 pb-20">
        <!-- 카드가 여기에 추가됩니다 -->
    </div>

    <!-- 빈 상태 메시지 -->
    <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-slate-500 pointer-events-none">
        <div class="bg-slate-800 p-8 rounded-full mb-6 ring-4 ring-slate-800/50">
            <i data-lucide="inbox" class="w-16 h-16 opacity-50 text-blue-400"></i>
        </div>
        <p class="text-xl font-bold text-slate-400">제출 대기 중</p>
        <p class="text-sm opacity-60 mt-2">상단의 '시작' 버튼을 누르면 학생들이 제출할 수 있습니다.</p>
    </div>
</main>

<!-- 3초 카운트다운 오버레이 -->
<div id="countdownOverlay" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hidden backdrop-blur-sm">
    <div class="text-center">
        <div id="countdownNum" class="text-9xl font-black text-white countdown-text drop-shadow-[0_0_15px_rgba(59,130,246,0.5)]">3</div>
        <p class="text-2xl text-blue-300 mt-8 font-bold">잠시 후 학생들의 입력이 활성화됩니다!</p>
    </div>
</div>

<!-- 알림 토스트 -->
<div id="notificationToast" class="fixed bottom-6 right-6 bg-blue-600 text-white px-6 py-4 rounded-xl shadow-2xl transform translate-y-32 opacity-0 transition-all duration-500 flex items-center gap-3">
    <span class="bg-white/20 p-2 rounded-lg"><i data-lucide="bell" class="w-5 h-5"></i></span>
    <div>
        <p class="font-bold text-sm">새로운 발표 도착!</p>
        <p class="text-xs opacity-90">방금 학생이 내용을 제출했습니다.</p>
    </div>
</div>

<script>
    // DOMContentLoaded 이벤트 내에서 코드를 실행하여 전역 변수 충돌 방지 및 안전한 로딩 보장
    document.addEventListener('DOMContentLoaded', () => {

        // 아이콘 초기화
        if (window.lucide) {
            window.lucide.createIcons();
        }

        // ==========================================
        // [설정] Supabase 키 입력
        // ==========================================
        const SUPABASE_URL = 'https://otzhhhzirasqmrdknhib.supabase.co'; // ⚠️ 본인 URL 입력
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90emhoaHppcmFzcW1yZGtuaGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDQ3MjMsImV4cCI6MjA3ODY4MDcyM30.ky1jeShjnEPsUkbGI_ZRtXbdWxiPFEYqRSUiizD98_M'; // ⚠️ 본인 KEY 입력

        // DOM 요소 참조
        const messageList = document.getElementById('messageList');
        const emptyState = document.getElementById('emptyState');
        const countdownOverlay = document.getElementById('countdownOverlay');
        const countdownNum = document.getElementById('countdownNum');
        const startBtn = document.getElementById('startBtn');
        const resetBtn = document.getElementById('resetBtn');
        const clearBtn = document.getElementById('clearBtn');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');

        let supabaseClient = null;

        // 초기화 실행
        init();

        function init() {
            try {
                if (!SUPABASE_URL || SUPABASE_URL.includes('YOUR_')) {
                    throw new Error("Supabase 설정이 필요합니다.");
                }

                // 클라이언트 생성
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                // 이벤트 리스너 연결 (안전한 방식)
                startBtn.addEventListener('click', startSession);
                resetBtn.addEventListener('click', resetSession);
                clearBtn.addEventListener('click', clearUI);

                // 시스템 시작
                checkActiveStatus();
                initSubmissionSubscription();
                fetchExistingMessages();

            } catch (e) {
                console.error("Initialization Error:", e);
                emptyState.innerHTML = `
                        <div class="text-center text-red-400 p-4">
                            <p class="font-bold text-lg mb-2">⚠️ 설정 오류</p>
                            <p>HTML 파일을 열어 Supabase URL과 KEY를 입력해주세요.</p>
                            <p class="text-xs mt-2 opacity-70">${e.message}</p>
                        </div>
                    `;
                emptyState.style.display = 'flex'; // 에러 메시지 표시 강제
            }
        }

        // --- 기능 함수들 ---

        async function checkActiveStatus() {
            if (!supabaseClient) return;
            const { data, error } = await supabaseClient
                .from('system_status')
                .select('is_active')
                .eq('id', 1)
                .single();

            if (data) {
                updateStatusUI(data.is_active);
            } else if (error && error.code === 'PGRST116') {
                // 데이터가 없는 경우 (처음 실행 시)
                updateStatusUI(false);
            }
        }

        function updateStatusUI(isActive) {
            if(isActive) {
                statusDot.className = "w-2 h-2 rounded-full bg-green-500 animate-pulse";
                statusDot.style.boxShadow = "0 0 10px #22c55e";
                statusText.textContent = "입력 활성화됨 (진행 중)";
                statusText.className = "text-green-400 font-bold";

                startBtn.classList.add('opacity-50', 'cursor-not-allowed');
                startBtn.disabled = true;
                startBtn.innerHTML = `<i data-lucide="check" class="w-5 h-5"></i> <span>진행 중</span>`;
            } else {
                statusDot.className = "w-2 h-2 rounded-full bg-red-500";
                statusDot.style.boxShadow = "none";
                statusText.textContent = "입력 잠김 (대기 중)";
                statusText.className = "text-slate-400";

                startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                startBtn.disabled = false;
                startBtn.innerHTML = `<i data-lucide="play" class="w-5 h-5"></i> <span>3초 후 시작</span>`;
            }
            if (window.lucide) window.lucide.createIcons();
        }

        // 시작 세션 (카운트다운)
        async function startSession() {
            if(startBtn.disabled || !supabaseClient) return;

            countdownOverlay.classList.remove('hidden');
            let count = 3;
            countdownNum.innerText = count;

            const timer = setInterval(() => {
                count--;
                if(count > 0) {
                    countdownNum.classList.remove('countdown-text');
                    void countdownNum.offsetWidth;
                    countdownNum.classList.add('countdown-text');
                    countdownNum.innerText = count;
                } else {
                    clearInterval(timer);
                    finishCountdown();
                }
            }, 1000);
        }

        async function finishCountdown() {
            countdownOverlay.classList.add('hidden');

            const { error } = await supabaseClient
                .from('system_status')
                .upsert({ id: 1, is_active: true });

            if(error) {
                alert("오류 발생: " + error.message);
            } else {
                updateStatusUI(true);
            }
        }

        // 초기화 세션
        async function resetSession() {
            if(!supabaseClient) return;
            if(!confirm("초기화 하시겠습니까?\n\n1. 학생 입력을 잠급니다.\n2. 현재 화면을 비웁니다.")) return;

            await supabaseClient.from('system_status').upsert({ id: 1, is_active: false });
            updateStatusUI(false);
            clearUI();
        }

        function clearUI() {
            messageList.innerHTML = '';
            emptyState.style.display = 'flex';
        }

        // 데이터 수신 및 렌더링
        function initSubmissionSubscription() {
            if (!supabaseClient) return;
            supabaseClient.channel('realtime-submissions')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'submissions' }, (payload) => {
                    emptyState.style.display = 'none';
                    addCard(payload.new, true);
                    showNotification();
                })
                .subscribe();
        }

        async function fetchExistingMessages() {
            if (!supabaseClient) return;
            const { data, error } = await supabaseClient
                .from('submissions')
                .select('*')
                .order('created_at', { ascending: true });

            if (data && data.length > 0) {
                emptyState.style.display = 'none';
                data.forEach(msg => addCard(msg, false));
                setTimeout(() => {
                    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
                }, 500);
            }
        }

        function addCard(data, isNew) {
            const date = new Date(data.created_at);
            const timeStr = date.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });

            const card = document.createElement('div');
            const colors = ['border-blue-500', 'border-purple-500', 'border-pink-500', 'border-indigo-500', 'border-teal-500'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            const avatarColor = randomColor.replace('border-', 'bg-');

            card.className = `bg-slate-800 rounded-xl p-5 border-t-4 ${randomColor} shadow-lg relative hover:transform hover:-translate-y-1 transition-all duration-300 ${isNew ? 'card-enter' : ''}`;

            card.innerHTML = `
                    <div class="flex items-center gap-3 mb-3 pb-3 border-b border-slate-700">
                        <div class="w-10 h-10 rounded-full ${avatarColor} flex items-center justify-center text-white font-bold shadow-inner">
                            ${data.student_name.slice(0,1)}
                        </div>
                        <div>
                            <h3 class="font-bold text-lg text-white leading-none">${data.student_name}</h3>
                            <span class="text-xs text-slate-400 font-mono mt-1 block">${timeStr}</span>
                        </div>
                    </div>
                    <p class="text-slate-200 leading-relaxed break-words text-lg font-medium">${escapeHtml(data.message)}</p>
                `;

            messageList.appendChild(card);

            if(isNew) {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }
        }

        function showNotification() {
            const toast = document.getElementById('notificationToast');
            if(toast) {
                toast.classList.remove('translate-y-32', 'opacity-0');
                setTimeout(() => {
                    toast.classList.add('translate-y-32', 'opacity-0');
                }, 3000);
            }
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;").replace(/\n/g, "<br>");
        }
    });
</script>
</body>
</html>