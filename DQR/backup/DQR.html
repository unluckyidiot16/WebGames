<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Dungeon Quiz RPG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        /* ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € ë†’ì´ ëŒ€ì‘ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;
            touch-action: manipulation;
            height: 100dvh;
            overflow: hidden;
        }
        .view { display: none; height: 100%; }
        .view.active { display: flex; }

        /* RPG ìŠ¤íƒ€ì¼ ì¹´ë“œ */
        .hero-card { transition: all 0.2s; border: 3px solid #e2e8f0; }
        .hero-card.selected { border-color: #3b82f6; background-color: #eff6ff; transform: scale(1.02); box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); }
        .hero-card:active { transform: scale(0.98); }

        .skill-card { transition: all 0.2s; border: 2px solid #e2e8f0; }
        .skill-card.equipped { border-color: #22c55e; background-color: #f0fdf4; box-shadow: 0 0 0 1px #22c55e; }

        .pixel-art { image-rendering: pixelated; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ì  ë°˜ì „ */
        .enemy-flip { transform: scaleX(-1); }
        .enemy-flip-boss { transform: scaleX(-1) scale(1.5); }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes damageShake {
            0% { transform: translateX(0); }
            20% { transform: translateX(-6px) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); }
            40% { transform: translateX(6px) rotate(5deg); }
            60% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
        }
        .animate-damage { animation: damageShake 0.4s ease-in-out; }

        @keyframes lunge {
            0% { transform: translateX(0); }
            50% { transform: translateX(40px); }
            100% { transform: translateX(0); }
        }
        .animate-lunge { animation: lunge 0.2s ease-out; }

        @keyframes enemyLunge {
            0% { transform: translateX(0); }
            50% { transform: translateX(40px); }
            100% { transform: translateX(0); }
        }
        .animate-lunge-enemy { animation: enemyLunge 0.2s ease-out; }

        @keyframes floatUp {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-20px); opacity: 0; }
        }
        .animate-float { animation: floatUp 0.8s ease-out forwards; }

        .btn-cooldown { background-color: #f1f5f9 !important; border-color: #cbd5e1 !important; color: #94a3b8 !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .skill-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }

        .modal-backdrop { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-slate-900 text-slate-800 select-none">

<section id="titleScreen" class="view active flex-col items-center justify-center p-6 bg-slate-900 relative overflow-hidden">
    <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
    <div class="z-10 text-center">
        <h1 class="text-5xl md:text-6xl font-black text-white tracking-tighter mb-2 drop-shadow-lg">
            <span class="text-blue-500">Quiz</span> Dungeon
        </h1>
        <div class="text-slate-400 text-xs font-bold mb-8 tracking-widest">RPG EDITION v11.1</div>

        <div class="bg-slate-800 p-8 rounded-3xl shadow-2xl border-4 border-slate-700 max-w-sm mx-auto">
            <div class="flex justify-center gap-4 mb-6">
                <img src="./png/knight.png" class="w-16 h-16 pixel-art animate-bounce" style="animation-delay: 0s">
                <img src="./png/wizard.png" class="w-16 h-16 pixel-art animate-bounce" style="animation-delay: 0.1s">
                <img src="./png/rogue-male.png" class="w-16 h-16 pixel-art animate-bounce" style="animation-delay: 0.2s">
            </div>
            <p id="loadingStatus" class="text-blue-400 text-xs font-bold mb-4 animate-pulse">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</p>
            <button id="startButton" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg text-lg transition-all border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 disabled:bg-slate-600 disabled:border-slate-700 disabled:cursor-not-allowed" disabled>
                ë˜ì „ ì…ì¥
            </button>
        </div>
        <p class="text-slate-600 text-[10px] mt-8">Local Save: v110_data</p>
    </div>
</section>

<section id="lobbyScreen" class="view flex-col items-center justify-start p-4 bg-slate-100 overflow-y-auto">
    <div class="w-full max-w-md flex flex-col gap-4 mt-2 h-full">
        <div class="flex justify-between items-end px-2">
            <h2 class="text-3xl font-black text-slate-800">VILLAGE</h2>
            <div class="flex gap-2">
                <div class="bg-red-50 px-3 py-1.5 rounded-full shadow-sm border border-red-200 text-sm font-bold flex items-center gap-2">
                    <img src="./png/potion.png" class="w-4 h-4 pixel-art"> <span id="lobbyPotionCount">0</span>/3
                </div>
                <div class="bg-yellow-50 px-4 py-1.5 rounded-full shadow-sm border border-yellow-200 text-sm font-bold flex items-center gap-2">
                    <span class="text-yellow-600">ğŸ’°</span><span id="lobbyGold">0</span> G
                </div>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-lg border-2 border-slate-200 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/exp-candy-xl.png" class="w-24 h-24 pixel-art grayscale">
            </div>
            <div class="relative z-10 flex justify-between items-center">
                <div>
                    <div class="text-[10px] font-bold text-slate-400 mb-1 tracking-wider uppercase" id="lobbyClassLabel">CLASS</div>
                    <div id="lobbyHeroName" class="font-black text-2xl text-slate-800">Novice</div>
                    <div class="text-xs text-blue-600 font-bold mt-1 bg-blue-50 inline-block px-2 py-1 rounded">
                        Lv.<span id="lobbyHeroLevel">1</span>
                    </div>
                </div>
                <div class="relative">
                    <img id="lobbyHeroImg" src="" class="w-20 h-20 pixel-art drop-shadow-md">
                </div>
            </div>
            <div class="mt-4 w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                <div id="lobbyXpBar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div>
            </div>
            <div class="text-[9px] text-right text-slate-400 mt-1">NEXT LEVEL</div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-2 pb-8">
            <button id="btnPvP" class="col-span-2 bg-gradient-to-r from-indigo-800 to-indigo-600 text-white p-4 rounded-2xl shadow-lg border-b-4 border-indigo-900 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-between group">
                <div class="text-left">
                    <div class="font-bold text-lg">ì‹¤ì‹œê°„ íˆ¬ê¸°ì¥</div>
                    <div class="text-[10px] text-indigo-200">ë‹¤ë¥¸ í”Œë ˆì´ì–´ì™€ ì „ëµ ëŒ€ì „!</div>
                </div>
                <span class="text-2xl group-hover:scale-110 transition-transform">ğŸŸï¸</span>
            </button>

            <button id="btnEnterDungeon" class="col-span-2 bg-gradient-to-r from-slate-800 to-slate-700 text-white p-5 rounded-2xl shadow-lg border-b-4 border-slate-900 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-between group">
                <div class="text-left">
                    <div class="font-bold text-xl">ë˜ì „ ì…ì¥</div>
                    <div class="text-xs text-slate-400 group-hover:text-white transition-colors">ëª¬ìŠ¤í„° í† ë²Œ (v11.0)</div>
                </div>
                <span class="text-3xl group-hover:scale-110 transition-transform">âš”ï¸</span>
            </button>

            <button id="btnTraining" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 hover:bg-blue-50 transition-colors flex flex-col items-center gap-2">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-xl">ğŸ›¡ï¸</div>
                <div class="text-center">
                    <div class="font-bold text-slate-700">í›ˆë ¨ì†Œ</div>
                    <div class="text-[10px] text-slate-400">ìŠ¤í‚¬/í¬ì…˜ ìƒì </div>
                </div>
            </button>

            <button id="btnChangeClass" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 hover:bg-green-50 transition-colors flex flex-col items-center gap-2">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-xl">ğŸ”„</div>
                <div class="text-center">
                    <div class="font-bold text-slate-700">ì „ì§</div>
                    <div class="text-[10px] text-slate-400">í´ë˜ìŠ¤ ë³€ê²½</div>
                </div>
            </button>

            <button id="btnGhost" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 hover:bg-purple-50 transition-colors flex flex-col items-center gap-2">
                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-xl">ğŸ‘»</div>
                <div class="text-center">
                    <div class="font-bold text-slate-700">ê³ ìŠ¤íŠ¸</div>
                    <div class="text-[10px] text-slate-400">QR ëŒ€ì „</div>
                </div>
            </button>

            <button id="btnHoF" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 hover:bg-yellow-50 transition-colors flex flex-col items-center gap-2">
                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center text-xl">ğŸ†</div>
                <div class="text-center">
                    <div class="font-bold text-slate-700">ê¸°ë¡ì‹¤</div>
                    <div class="text-[10px] text-slate-400">ëª…ì˜ˆì˜ ì „ë‹¹</div>
                </div>
            </button>
        </div>
    </div>
</section>

<section id="classSelectScreen" class="view flex-col items-center justify-center p-6 bg-slate-50">
    <h2 class="text-2xl font-black text-slate-800 mb-6">í´ë˜ìŠ¤ ì„ íƒ</h2>
    <div class="grid grid-cols-1 gap-4 w-full max-w-sm" id="classCardGrid">
    </div>
    <button id="btnCancelClassSelect" class="mt-6 text-slate-400 text-sm font-bold underline">ëŒì•„ê°€ê¸°</button>
</section>

<section id="battleScreen" class="view flex-col items-center justify-between bg-slate-800 relative overflow-hidden">
    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-30"></div>

    <div class="w-full max-w-md p-4 flex justify-between items-start z-10 shrink-0">
        <button id="battleGiveUpBtn" class="bg-white/10 backdrop-blur text-white/80 px-3 py-1.5 rounded-full text-xs font-bold border border-white/20 hover:bg-white/20">ğŸ³ï¸ í¬ê¸°</button>
        <div class="bg-black/50 backdrop-blur text-yellow-400 px-4 py-1.5 rounded-full text-xs font-bold border border-yellow-400/30 shadow-[0_0_10px_rgba(250,204,21,0.3)]">
            STAGE <span id="battleStageText" class="text-base ml-1 text-white">1</span>
        </div>
    </div>

    <div class="w-full max-w-md flex-1 relative flex flex-col justify-center px-4 z-10 gap-8 md:gap-12">
        <div class="flex flex-col items-end relative transition-all duration-300" id="enemyContainer">
            <div id="enemyUiContainer" class="bg-slate-900/80 p-3 rounded-xl border border-slate-600 mb-2 w-40 backdrop-blur-md transform translate-x-2 relative z-30 transition-transform duration-300">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="enemyName" class="font-bold text-sm text-red-400">Slime</span>
                    <span id="enemyLevel" class="text-[10px] text-slate-400">Lv.1</span>
                </div>
                <div id="enemyBuffs" class="flex gap-1 mb-1 min-h-[16px]"></div>
                <div class="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                    <div id="enemyHpBar" class="h-full bg-red-500 transition-all duration-500" style="width: 100%"></div>
                </div>
            </div>
            <div class="relative z-10" id="enemyWrapper">
                <img id="enemyImg" src="./png/slime-green.png" class="w-28 h-28 md:w-32 md:h-32 pixel-art animate-bounce" style="animation-duration: 2s">
            </div>
        </div>

        <div class="flex flex-col items-start relative -mt-4 md:-mt-8">
            <div class="relative z-10">
                <img id="playerImg" src="./png/knight.png" class="w-32 h-32 md:w-40 md:h-40 pixel-art drop-shadow-2xl">
                <div id="playerFloatText" class="absolute top-0 left-0 w-full h-full flex justify-center items-center pointer-events-none"></div>
            </div>
            <div class="bg-slate-900/80 p-4 rounded-xl border border-blue-500/50 w-48 -mt-6 z-20 transform -translate-x-2 backdrop-blur-md shadow-lg">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="playerName" class="font-bold text-sm text-blue-300">Player</span>
                    <span id="playerLevel" class="text-[10px] text-slate-400">Lv.1</span>
                </div>
                <div id="playerBuffs" class="flex gap-1 mb-1 min-h-[16px]"></div>
                <div class="flex justify-between text-[10px] text-slate-400 mb-1">
                    <span>HP</span> <span id="playerHpText">15/15</span>
                </div>
                <div class="w-full h-2.5 bg-slate-700 rounded-full overflow-hidden mb-1">
                    <div id="playerHpBar" class="h-full bg-blue-500 transition-all duration-500" style="width: 100%"></div>
                </div>
                <div id="playerShieldContainer" class="w-full h-1 bg-slate-800 rounded-full overflow-hidden">
                    <div id="playerShieldBar" class="h-full bg-yellow-400 w-0 transition-all"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-md bg-slate-900 border-t border-slate-700 p-3 z-20 pb-6 shrink-0">
        <div id="battleLog" class="text-xs text-slate-400 mb-2 h-5 overflow-hidden text-center truncate font-mono">
            ì „íˆ¬ ì‹œì‘!
        </div>

        <div class="flex justify-end mb-2 px-1">
            <button id="battlePotionBtn" class="bg-red-500 hover:bg-red-400 text-white px-3 py-1.5 rounded-lg text-xs font-bold shadow flex items-center gap-2 active:scale-95 disabled:bg-slate-500 disabled:opacity-50 transition-all" onclick="usePotion()">
                <img src="./png/potion.png" class="w-4 h-4 pixel-art">
                íšŒë³µ (<span id="battlePotionCount">0</span>)
            </button>
        </div>

        <div id="skillGrid" class="grid grid-cols-2 gap-2">
        </div>
    </div>
</section>

<div id="trainingModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[85vh]">
        <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
            <h3 class="font-bold text-lg">ğŸ›¡ï¸ í›ˆë ¨ì†Œ & ìƒì </h3>
            <button id="closeTrainingBtn" class="text-white/80 hover:text-white">âœ•</button>
        </div>
        <div class="p-3 bg-slate-50 border-b flex justify-between items-center">
            <span class="text-xs text-slate-500" id="trainingEquipCount">ì¥ì°©: 0/4</span>
            <span class="font-bold text-yellow-600 text-lg">ğŸ’° <span id="trainingGold">0</span></span>
        </div>
        <div id="trainingList" class="p-4 overflow-y-auto space-y-2 flex-1">
        </div>
    </div>
</div>

<div id="quizModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
        <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
            <h3 class="font-bold text-lg">ğŸ“ ë¶„ìˆ˜ í€´ì¦ˆ</h3>
            <span class="text-xs bg-blue-600 px-2 py-1 rounded font-bold">ì •ë‹µ ì‹œ ìŠ¤í‚¬ ë°œë™</span>
        </div>
        <div class="p-6">
            <div class="text-center mb-4">
                <p class="text-xs text-slate-500 mb-2" id="quizExplain">ë¬¸ì œ ì„¤ëª…</p>
                <div id="quizVisual" class="flex justify-center items-center py-4 min-h-[120px]"></div>
                <p id="quizQuestion" class="hidden"></p>
            </div>
            <div id="quizChoices" class="grid grid-cols-2 gap-2"></div>
        </div>
        <div class="bg-slate-50 p-3 text-center border-t">
            <button id="quizCancel" class="text-xs text-slate-400 underline hover:text-red-500">í¬ê¸° (í„´ ë„˜ê¸°ê¸°)</button>
        </div>
    </div>
</div>

<div id="rewardModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[70] p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs p-6 text-center animate-[bounce_0.5s]">
        <h3 class="text-3xl font-black text-slate-800 mb-2">VICTORY!</h3>
        <div class="my-4">
            <div class="text-sm text-slate-500">íšë“ ê²½í—˜ì¹˜</div>
            <div class="text-2xl font-bold text-blue-600">+<span id="rewardXpVal">0</span> EXP</div>
        </div>
        <div id="rewardGoldSection" class="my-2 hidden">
            <div class="text-sm text-slate-500">ì „íˆ¬ ë³´ìƒ</div>
            <div class="text-xl font-bold text-yellow-500">+<span id="rewardGoldVal">0</span> G</div>
        </div>
        <button id="rewardOkBtn" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg mt-4">ë‹¤ìŒ ìŠ¤í…Œì´ì§€</button>
    </div>
</div>

<div id="ghostModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[55] p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col overflow-hidden">
        <div class="flex justify-between items-center px-4 py-3 border-b border-slate-200">
            <h3 class="text-lg font-bold text-slate-800">ğŸ‘» ê³ ìŠ¤íŠ¸ ë°°í‹€</h3>
            <button id="ghostClose" class="text-slate-400 text-xs font-bold">ë‹«ê¸°</button>
        </div>
        <div class="flex gap-2 px-4 pt-3">
            <button id="ghostTabMyBtn" class="flex-1 text-xs font-bold rounded-full px-3 py-2 bg-slate-800 text-white">ë‚´ QR ê³µìœ </button>
            <button id="ghostTabScanBtn" class="flex-1 text-xs font-bold rounded-full px-3 py-2 bg-slate-100 text-slate-500">ìŠ¤ìº”í•´ì„œ ë„ì „</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4 text-slate-800 text-sm">
            <div id="ghostMyPane">
                <div class="bg-slate-50 rounded-2xl border border-slate-200 flex flex-col items-center justify-center py-4">
                    <canvas id="ghostQrCanvas" class="bg-white rounded-xl p-2 mb-2"></canvas>
                    <p id="ghostMySummary" class="text-xs font-bold text-slate-700"></p>
                </div>
            </div>
            <div id="ghostScanPane" class="hidden">
                <div class="bg-black rounded-2xl overflow-hidden mb-2 relative">
                    <video id="ghostVideo" class="w-full h-48 object-cover bg-black"></video>
                    <div class="absolute inset-0 border-2 border-blue-500/50 flex items-center justify-center"><div class="w-32 h-32 border-2 border-blue-400"></div></div>
                </div>
                <p id="ghostScanStatus" class="text-xs text-center text-slate-500">ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...</p>
                <div class="flex gap-2 mt-2">
                    <button id="ghostScanStartBtn" class="flex-1 py-2 rounded-xl bg-blue-600 text-white text-xs font-bold">ìŠ¤ìº” ì‹œì‘</button>
                    <button id="ghostScanStopBtn" class="flex-1 py-2 rounded-xl bg-slate-200 text-slate-600 text-xs font-bold">ì¤‘ì§€</button>
                </div>
                <canvas id="ghostScanCanvas" class="hidden"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="hofModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[55] p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[80vh] flex flex-col overflow-hidden">
        <div class="bg-yellow-100 p-4 flex justify-between items-center border-b border-yellow-200">
            <h3 class="font-bold text-lg text-yellow-800">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3>
            <button id="hofClose" class="text-yellow-800 hover:text-black">âœ•</button>
        </div>
        <div id="hofList" class="p-4 overflow-y-auto space-y-3 flex-1 bg-yellow-50">
        </div>
    </div>
</div>

<script>
    /* =========================================
     * 0. UTILS & MODAL HELPERS
     * ========================================= */
    function showModal(id) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.remove("hidden");
            el.classList.add("flex");
        }
    }

    function hideModal(id) {
        const el = document.getElementById(id);
        if (el) {
            el.classList.add("hidden");
            el.classList.remove("flex");
        }
    }

    function toBase64UTF8(obj) {
        const json = typeof obj === "string" ? obj : JSON.stringify(obj);
        return btoa(unescape(encodeURIComponent(json)));
    }

    function fromBase64UTF8(b64) {
        try {
            return decodeURIComponent(escape(atob(b64)));
        } catch(e) { return null; }
    }

    function gcd(a, b) {
        return b ? gcd(b, a % b) : a;
    }

    /* =========================================
     * 1. DATA DEFINITIONS (DB)
     * ========================================= */

    // v11.0 ìŠ¤í‚¬ ë¦¬ë©”ì´í¬ (ê¸°ì‚¬/ë„ì /ë§ˆë²•ì‚¬ ì»¨ì…‰ ê°•í™”)
    const HERO_DEFINITIONS = {
        "knight": {
            id: "knight", name: "Knight", nameKo: "ê¸°ì‚¬",
            baseStats: { hp: 15, atk: 12, def: 8, spd: 5 },
            sprites: { default: "./png/knight.png", skin: "./png/knight-black.png" },
            skills: [
                { id: "k1", name: "ìˆ˜í˜¸ì˜ ê²€", type: "atk", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
                { id: "k2", name: "ë°©íŒ¨ ê°•íƒ€", type: "atk_stun", power: 1.2, cd: 3, desc: "í”¼í•´ + 1í„´ ê¸°ì ˆ" },
                { id: "k3", name: "ë°˜ê²© íƒœì„¸", type: "buff_counter", power: 0, cd: 4, desc: "í”¼í•´ 50% ê²½ê° ë° ë°˜ì‚¬" },
                { id: "k4", name: "ì‘ê¸‰ ì²˜ì¹˜", type: "buff_heal_missing", power: 0, cd: 4, desc: "ìƒì€ HP ë¹„ë¡€ íšŒë³µ" },
                { id: "k5", name: "ì² ë²½ ìˆ˜ë¹„", type: "buff_def", power: 0, cd: 4, desc: "ë°›ëŠ” í”¼í•´ 50% ê°ì†Œ" },
                { id: "k6", name: "ìˆ˜í˜¸ì˜ ê²°ê³„", type: "buff_shield", power: 0, cd: 4, desc: "ë³´í˜¸ë§‰ ìƒì„±" },
                { id: "k7", name: "ì§•ë²Œì˜ ì¼ê²©", type: "atk", power: 2.2, cd: 3, desc: "ê°•ë ¥í•œ ì¼ê²©" },
                { id: "k8", name: "ì„±ì±„ ì „ê°œ", type: "buff_aegis", power: 0, cd: 6, desc: "ë°©ì–´+ë°˜ê²©+ë³´í˜¸ë§‰ (ê¶ê·¹ê¸°)" }
            ]
        },
        "rogue": {
            id: "rogue", name: "Rogue", nameKo: "ë„ì ",
            baseStats: { hp: 10, atk: 18, def: 4, spd: 10 },
            sprites: { default: "./png/rogue-male.png", skin: "./png/rogue-female.png" },
            skills: [
                { id: "r1", name: "ë‹¨ê²€ íˆ¬ì²™", type: "atk", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
                { id: "r2", name: "ì•½ì  ê°„íŒŒ", type: "buff_next_crit", power: 0, cd: 3, desc: "ë‹¤ìŒ ê³µê²© í™•ì • ì¹˜ëª…íƒ€" },
                { id: "r3", name: "ê·¸ë¦¼ì ë§í† ", type: "buff_evasion", power: 0, cd: 5, desc: "íšŒí”¼ìœ¨ 80% ì¦ê°€" },
                { id: "r4", name: "í¡í˜ˆ ë² ê¸°", type: "atk_vampire", power: 1.2, cd: 3, desc: "í”¼í•´ì˜ 50% íšŒë³µ" },
                { id: "r5", name: "ê¸‰ì†Œ ì°Œë¥´ê¸°", type: "atk_crit", power: 1.5, cd: 2, desc: "ë†’ì€ ì¹˜ëª…íƒ€ í™•ë¥ " },
                { id: "r6", name: "ë…ê¸° í­ì£¼", type: "buff_atk", power: 0, cd: 4, desc: "ê³µê²©ë ¥ ì¦ê°€" },
                { id: "r7", name: "ì—°ì† ë² ê¸°", type: "atk", power: 0.8, cd: 1, desc: "ì§§ì€ ì¿¨íƒ€ì„ ê³µê²©" },
                { id: "r8", name: "ì•”ì‚´", type: "atk_execute", power: 3.0, cd: 6, desc: "ì²´ë ¥ ë‚®ì€ ì ì—ê²Œ ì¹˜ëª…ì " }
            ]
        },
        "mage": {
            id: "mage", name: "Mage", nameKo: "ë§ˆë²•ì‚¬",
            baseStats: { hp: 8, atk: 22, def: 3, spd: 6 },
            sprites: { default: "./png/wizard.png", skin: "./png/wizard.png" },
            skills: [
                { id: "m1", name: "ë§¤ì§ ë¯¸ì‚¬ì¼", type: "atk", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
                { id: "m2", name: "íŒŒì´ì–´ë³¼", type: "atk", power: 1.8, cd: 2, desc: "ë©”ì¸ ë”œë§" },
                { id: "m3", name: "ë§ˆë‚˜ ì¥ë²½", type: "buff_shield_huge", power: 0, cd: 4, desc: "ëŒ€í˜• ë³´í˜¸ë§‰" },
                { id: "m4", name: "ì–¼ìŒ ë°©íŒ¨", type: "buff_invuln", power: 0, cd: 6, desc: "1í„´ê°„ ë¬´ì " },
                { id: "m5", name: "ë§ˆë ¥ ì¦í­", type: "buff_next_double", power: 0, cd: 4, desc: "ë‹¤ìŒ ìŠ¤í‚¬ í”¼í•´ 2ë°°" },
                { id: "m6", name: "ì•„ì¼€ì¸ ë¸”ë˜ìŠ¤íŠ¸", type: "atk", power: 2.5, cd: 4, desc: "ê°•ë ¥í•œ ë‹¨ì¼ í­ë”œ" },
                { id: "m7", name: "ë§ˆë ¥ í•´ì œ", type: "dispel", power: 0, cd: 4, desc: "ì  ë²„í”„/ë³´í˜¸ë§‰ ì œê±°" },
                { id: "m8", name: "ë©”í…Œì˜¤", type: "atk_ult", power: 4.5, cd: 8, desc: "ì´ˆëŒ€í˜• í•œ ë°© (ê¶ê·¹ê¸°)" }
            ]
        }
    };

    const MONSTER_SKILLS = {
        "bite": { id: "ms_bite", name: "ë¬¼ê¸°", type: "atk", power: 1.0, cd: 0 },
        "scratch": { id: "ms_scratch", name: "í• í€´ê¸°", type: "atk", power: 1.1, cd: 1 },
        "leech": { id: "ms_leech", name: "í¡í˜ˆ", type: "atk_vampire", power: 0.8, cd: 3 },
        "web": { id: "ms_web", name: "ê±°ë¯¸ì¤„", type: "atk_stun", power: 0.5, cd: 4 },
        "bone_throw": { id: "ms_bone", name: "ë¼ˆ ë˜ì§€ê¸°", type: "atk", power: 1.2, cd: 2 },
        "spook": { id: "ms_spook", name: "ë†€ë˜í‚¤ê¸°", type: "atk_stun", power: 0.8, cd: 3 },
        "smash": { id: "ms_smash", name: "ë‚´ë ¤ì°ê¸°", type: "atk", power: 1.5, cd: 3 },
        "regen": { id: "ms_regen", name: "ì¬ìƒ", type: "buff_heal_missing", power: 0.0, cd: 4 },
        "fireball": { id: "ms_fire", name: "í™”ì—¼êµ¬", type: "atk", power: 1.4, cd: 2 },
        "curse": { id: "ms_curse", name: "ì €ì£¼", type: "atk", power: 1.2, cd: 2 },
        "doom": { id: "ms_doom", name: "íŒŒë©¸ì˜ ì¼ê²©", type: "atk_execute", power: 2.0, cd: 5 }
    };

    const ENEMY_VARIANTS = [
        { id: "rat", name: "Rat", src: "./png/rat.png", hpMult: 0.8, atkMult: 0.8, skills: ["bite"] },
        { id: "slime_g", name: "Green Slime", src: "./png/slime-green.png", hpMult: 1.0, atkMult: 0.9, skills: ["scratch"] },
        { id: "slime_b", name: "Blue Slime", src: "./png/slime-blue.png", hpMult: 1.0, atkMult: 0.9, skills: ["scratch"] },
        { id: "bat", name: "Bat", src: "./png/bat.png", hpMult: 0.7, atkMult: 1.1, skills: ["leech"] },
        { id: "spider", name: "Spider", src: "./png/spider.png", hpMult: 0.9, atkMult: 1.0, skills: ["web", "bite"] },
        { id: "skeleton", name: "Skeleton", src: "./png/skeleton.png", hpMult: 1.1, atkMult: 1.1, skills: ["bone_throw"] },
        { id: "slime_r", name: "Red Slime", src: "./png/slime-red.png", hpMult: 1.1, atkMult: 1.0, skills: ["scratch"] },
        { id: "slime_p", name: "Purple Slime", src: "./png/slime-purple.png", hpMult: 1.2, atkMult: 1.0, skills: ["scratch"] },
        { id: "slime_y", name: "Yellow Slime", src: "./png/slime-yellow.png", hpMult: 1.1, atkMult: 1.0, skills: ["scratch"] },
        { id: "ghost", name: "Ghost", src: "./png/ghost.png", hpMult: 0.8, atkMult: 1.2, skills: ["spook"] },
        { id: "troll", name: "Troll", src: "./png/troll.png", hpMult: 1.5, atkMult: 1.2, skills: ["smash", "regen"], bossOnly: true },
        { id: "flame_r", name: "Red Skull", src: "./png/flameSkull-red.png", hpMult: 1.2, atkMult: 1.4, skills: ["fireball"] },
        { id: "flame_b", name: "Blue Skull", src: "./png/flameSkull-blue.png", hpMult: 1.3, atkMult: 1.5, skills: ["fireball", "curse"], bossOnly: true },
        { id: "demon", name: "Demon", src: "./png/demon.png", hpMult: 1.8, atkMult: 1.6, skills: ["doom", "fireball"], bossOnly: true }
    ];

    /* =========================================
     * 2. STATE MANAGEMENT & LOCAL STORAGE
     * ========================================= */
    const LS_KEYS = {
        DATA: "qz_rpg_v110_data", // v11.0 ë²„ì „ ì—…
        HOF: "qz_rpg_v110_hof"
    };

    let gameState = {
        gold: 0,
        potions: 0,
        unlockedClasses: ["knight", "rogue", "mage"],
        heroes: {
            "knight": { level: 1, xp: 0, skillLevels: { k1:1, k2:1, k3:1, k4:1 }, equipped: ["k1", "k2", "k3", "k4"], skin: "default" },
            "rogue": { level: 1, xp: 0, skillLevels: { r1:1, r2:1, r3:1, r4:1 }, equipped: ["r1", "r2", "r3", "r4"], skin: "default" },
            "mage": { level: 1, xp: 0, skillLevels: { m1:1, m2:1, m3:1, m4:1 }, equipped: ["m1", "m2", "m3", "m4"], skin: "default" }
        },
        selectedClass: "knight"
    };

    let battleState = null;
    let externalQuizList = [];
    let quizCallback = null;

    function loadGameData() {
        const raw = localStorage.getItem(LS_KEYS.DATA);
        if (raw) {
            try {
                const loaded = JSON.parse(raw);
                gameState = { ...gameState, ...loaded };
                if(typeof gameState.potions === 'undefined') gameState.potions = 0;

                Object.keys(gameState.heroes).forEach(cid => {
                    const h = gameState.heroes[cid];
                    const def = HERO_DEFINITIONS[cid];
                    if (Array.isArray(h.skillLevels)) {
                        const newSlv = {};
                        def.skills.slice(0, 4).forEach((s, i) => newSlv[s.id] = h.skillLevels[i] || 1);
                        h.skillLevels = newSlv;
                    }
                    if (!h.equipped || !Array.isArray(h.equipped)) {
                        h.equipped = def.skills.slice(0, 4).map(s => s.id);
                    }
                    def.skills.forEach(s => {
                        if (!h.skillLevels[s.id]) h.skillLevels[s.id] = 1;
                    });
                });
            } catch (e) { console.error("Save load error", e); }
        }
    }

    function saveGameData() {
        localStorage.setItem(LS_KEYS.DATA, JSON.stringify(gameState));
        updateLobbyUI();
    }

    function getHeroStats(classId, levelOverride = null) {
        const heroData = gameState.heroes[classId];
        const def = HERO_DEFINITIONS[classId];
        const level = levelOverride || heroData.level;
        const base = def.baseStats;

        return {
            maxHp: Math.floor(base.hp + (level * 2)),
            atk: Math.floor(base.atk + (level * 1.5)),
            def: Math.floor(base.def + (level * 0.8)),
            spd: Math.floor(base.spd + (level * 0.5))
        };
    }

    function getHoF() {
        try { return JSON.parse(localStorage.getItem(LS_KEYS.HOF) || "[]"); }
        catch { return []; }
    }

    function addHoF(record) {
        const list = getHoF();
        list.push({ ts: Date.now(), date: new Date().toLocaleDateString(), ...record });
        list.sort((a,b) => b.ts - a.ts);
        if(list.length > 20) list.length = 20;
        localStorage.setItem(LS_KEYS.HOF, JSON.stringify(list));
    }

    // --- ìŠ¤í‚¬ ë ˆë²¨ì— ë”°ë¥¸ ìŠ¤íƒ¯ ê³„ì‚° (ì¿¨íƒ€ì„ ê°ì†Œ, ì§€ì†ì‹œê°„ ì¦ê°€ ë“±) ---
    function getEffectiveSkillStats(skill, level) {
        let cd = skill.cd;
        let power = skill.power;

        if (cd > 0) {
            let reduction = Math.floor((level - 1) / 5);
            cd = Math.max(1, cd - reduction);
        }

        let duration = 0;
        if(skill.type.includes('buff_')) duration = 3 + Math.floor((level-1)/3);
        if(skill.type === 'buff_invuln') duration = 1; // ë¬´ì ì€ 1í„´ ê³ ì •
        if(skill.type === 'buff_aegis') duration = 3; // ê¶ê·¹ê¸°ëŠ” 3í„´

        return { cd, duration };
    }

    function getSkillDesc(skill, lv) {
        const stats = getEffectiveSkillStats(skill, lv);
        const lvlMult = 1 + (lv * 0.1);
        const pct = Math.round(skill.power * lvlMult * 100);

        let txt = "";
        if(skill.type === 'buff_shield') txt = `HPì˜ ${Math.round(30 + lv * 5)}% ì‰´ë“œ`;
        else if(skill.type === 'buff_shield_huge') txt = `HPì˜ ${Math.round(50 + lv * 5)}% ì‰´ë“œ`;
        else if(skill.type === 'buff_evasion') txt = `${stats.duration}í„´ê°„ íšŒí”¼ìœ¨ 80%`;
        else if(skill.type === 'buff_atk') txt = `${stats.duration}í„´ê°„ ê³µê²©ë ¥ 50% ì¦ê°€`;
        else if(skill.type === 'buff_def') txt = `${stats.duration}í„´ê°„ ë°©ì–´ë ¥ 2ë°° (50%ê²½ê°)`;
        else if(skill.type === 'buff_counter') txt = `${stats.duration}í„´ê°„ ë°˜ê²©íƒœì„¸`;
        else if(skill.type === 'buff_aegis') txt = `ì„±ì±„ì „ê°œ (ë°©ì–´+ë°˜ê²©+ì‰´ë“œ)`;
        else if(skill.type === 'dispel') txt = `ì  ë²„í”„/ì‰´ë“œ ëª¨ë‘ ì œê±°`;
        else if(skill.type === 'atk_heal') txt = `í”¼í•´ì˜ ì¼ë¶€ íšŒë³µ`;
        else if(skill.type === 'atk_vampire') txt = `í”¼í•´ì˜ 50% í¡í˜ˆ`;
        else if(skill.type === 'buff_heal_missing') txt = `ìƒì€ HPì˜ 30% íšŒë³µ`;
        else if(skill.type.includes('atk')) txt = `ê³µê²©ë ¥ì˜ ${pct}% í”¼í•´`;
        else txt = skill.desc;

        if (skill.cd > 0) {
            txt += ` (CD:${stats.cd})`;
        }
        return txt;
    }

    /* =========================================
     * 3. UI FUNCTIONS (LOBBY & SELECT)
     * ========================================= */
    function updateLobbyUI() {
        const curClass = gameState.selectedClass;
        const heroData = gameState.heroes[curClass];
        const def = HERO_DEFINITIONS[curClass];

        document.getElementById("lobbyGold").textContent = gameState.gold.toLocaleString();
        document.getElementById("lobbyPotionCount").textContent = gameState.potions;
        document.getElementById("lobbyClassLabel").textContent = def.name;
        document.getElementById("lobbyHeroName").textContent = def.nameKo;
        document.getElementById("lobbyHeroLevel").textContent = heroData.level;

        const imgSrc = heroData.skin === "skin" ? def.sprites.skin : def.sprites.default;
        document.getElementById("lobbyHeroImg").src = imgSrc;

        const reqXp = heroData.level * 100;
        const pct = Math.min(100, (heroData.xp / reqXp) * 100);
        document.getElementById("lobbyXpBar").style.width = `${pct}%`;
    }

    function renderClassSelect() {
        const grid = document.getElementById("classCardGrid");
        grid.innerHTML = "";

        Object.keys(HERO_DEFINITIONS).forEach(key => {
            const def = HERO_DEFINITIONS[key];
            const myData = gameState.heroes[key];

            const card = document.createElement("div");
            card.className = `hero-card bg-white p-4 rounded-xl flex items-center gap-4 cursor-pointer ${gameState.selectedClass === key ? 'selected' : ''}`;
            card.onclick = () => {
                gameState.selectedClass = key;
                saveGameData();
                renderClassSelect();
            };

            const imgSrc = myData.skin === "skin" ? def.sprites.skin : def.sprites.default;

            card.innerHTML = `
                <img src="${imgSrc}" class="w-16 h-16 pixel-art bg-slate-100 rounded-lg">
                <div class="flex-1">
                    <div class="font-bold text-lg text-slate-800">${def.nameKo} <span class="text-xs text-slate-400">Lv.${myData.level}</span></div>
                    <div class="text-xs text-slate-500 mt-1">
                        HP:${def.baseStats.hp} ATK:${def.baseStats.atk}
                    </div>
                </div>
                ${gameState.selectedClass === key ? '<div class="text-blue-500 font-bold text-xl">âœ“</div>' : ''}
            `;
            grid.appendChild(card);
        });
    }

    function toggleSkin(classId) {
        const h = gameState.heroes[classId];
        h.skin = (h.skin === "default") ? "skin" : "default";
        saveGameData();
        updateLobbyUI();
    }

    /* =========================================
     * 4. TRAINING SYSTEM & SHOP
     * ========================================= */
    function openTraining() {
        renderTrainingList();
        showModal("trainingModal");
    }

    function renderTrainingList() {
        const cid = gameState.selectedClass;
        const hero = gameState.heroes[cid];
        const def = HERO_DEFINITIONS[cid];
        const list = document.getElementById("trainingList");
        list.innerHTML = "";

        document.getElementById("trainingGold").textContent = gameState.gold;
        document.getElementById("trainingEquipCount").textContent = `ì¥ì°©: ${hero.equipped.length}/4`;

        // í¬ì…˜ ìƒì  (ë§¨ ìœ„)
        const potionRow = document.createElement("div");
        potionRow.className = "bg-red-50 border border-red-200 rounded-xl p-3 flex justify-between items-center shadow-sm mb-4";
        potionRow.innerHTML = `
            <div class="flex items-center gap-3">
                <img src="./png/potion.png" class="w-8 h-8 pixel-art">
                <div>
                    <div class="font-bold text-sm text-red-900">íšŒë³µ í¬ì…˜ <span class="text-xs text-red-500">(${gameState.potions}/3)</span></div>
                    <div class="text-[10px] text-red-400">ë˜ì „ì—ì„œ ì¦‰ì‹œ HP 50% íšŒë³µ</div>
                </div>
            </div>
            <button class="px-3 py-1.5 bg-red-500 hover:bg-red-600 text-white text-xs font-bold rounded-lg shadow-sm active:scale-95 disabled:bg-slate-300 disabled:text-slate-500" 
                id="btnBuyPotion">
                100 G
            </button>
        `;
        list.appendChild(potionRow);

        const buyBtn = potionRow.querySelector("#btnBuyPotion");
        if (gameState.potions >= 3 || gameState.gold < 100) buyBtn.disabled = true;
        buyBtn.onclick = () => {
            if (gameState.potions < 3 && gameState.gold >= 100) {
                gameState.gold -= 100;
                gameState.potions++;
                saveGameData();
                renderTrainingList();
            }
        };

        const skinBtn = document.createElement("button");
        skinBtn.className = "w-full py-2 mb-2 bg-purple-100 text-purple-700 font-bold rounded-lg text-xs border border-purple-200";
        skinBtn.textContent = `ğŸ¨ ìŠ¤í‚¨ ë³€ê²½ (${hero.skin === 'default' ? 'ê¸°ë³¸' : 'ì–´ë‚˜ë”'})`;
        skinBtn.onclick = () => { toggleSkin(cid); renderTrainingList(); };
        list.appendChild(skinBtn);

        def.skills.forEach((skill) => {
            const lv = hero.skillLevels[skill.id] || 1;
            const cost = lv * 100;
            const isEquipped = hero.equipped.includes(skill.id);

            const currDesc = getSkillDesc(skill, lv);
            const nextDesc = getSkillDesc(skill, lv+1);

            const row = document.createElement("div");
            row.className = `skill-card rounded-xl p-3 flex justify-between items-center shadow-sm ${isEquipped ? 'equipped' : 'bg-white border-slate-200'}`;

            row.onclick = (e) => {
                if(e.target.tagName !== 'BUTTON') {
                    toggleEquip(cid, skill.id);
                }
            };

            row.innerHTML = `
                <div class="flex-1 cursor-pointer">
                    <div class="font-bold text-sm text-slate-800 flex items-center gap-2">
                        ${skill.name} <span class="text-blue-500 text-xs">Lv.${lv}</span>
                        ${isEquipped ? '<span class="text-[10px] bg-green-500 text-white px-1.5 rounded">ì¥ì°©ì¤‘</span>' : ''}
                    </div>
                    <div class="text-[10px] text-slate-600 mt-1 font-medium">${currDesc}</div>
                    <div class="text-[10px] text-blue-500 mt-0.5">â¬†ï¸ ë‹¤ìŒ: ${nextDesc}</div>
                </div>
                <button class="px-3 py-1.5 ml-2 bg-yellow-500 hover:bg-yellow-400 text-white text-xs font-bold rounded-lg shadow-sm active:scale-95 disabled:bg-slate-300 disabled:text-slate-500" 
                    id="btnTrain_${skill.id}">
                    âš¡ ${cost} G
                </button>
            `;

            const btn = row.querySelector(`#btnTrain_${skill.id}`);
            if (gameState.gold < cost) btn.disabled = true;

            btn.onclick = (e) => {
                e.stopPropagation();
                if (gameState.gold >= cost) {
                    gameState.gold -= cost;
                    hero.skillLevels[skill.id]++;
                    saveGameData();
                    renderTrainingList();
                }
            };

            list.appendChild(row);
        });
    }

    function toggleEquip(cid, skillId) {
        const hero = gameState.heroes[cid];
        const idx = hero.equipped.indexOf(skillId);

        if (idx >= 0) {
            if (hero.equipped.length > 1) {
                hero.equipped.splice(idx, 1);
            } else {
                alert("ìµœì†Œ 1ê°œì˜ ìŠ¤í‚¬ì€ ì¥ì°©í•´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }
        } else {
            if (hero.equipped.length < 4) {
                hero.equipped.push(skillId);
            } else {
                alert("ìµœëŒ€ 4ê°œê¹Œì§€ë§Œ ì¥ì°©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\në‹¤ë¥¸ ìŠ¤í‚¬ì„ í•´ì œí•´ì£¼ì„¸ìš”.");
                return;
            }
        }
        saveGameData();
        renderTrainingList();
    }

    /* =========================================
     * 5. BATTLE SYSTEM
     * ========================================= */
    function startDungeon() {
        const cid = gameState.selectedClass;
        const hData = gameState.heroes[cid];
        const def = HERO_DEFINITIONS[cid];
        const stats = getHeroStats(cid);
        const imgSrc = hData.skin === "skin" ? def.sprites.skin : def.sprites.default;

        const battleSkills = hData.equipped.map(sid => def.skills.find(s => s.id === sid)).filter(s => s);

        battleState = {
            mode: "dungeon",
            stage: 1,
            player: {
                ...stats,
                maxHp: stats.maxHp,
                hp: stats.maxHp,
                shield: 0,
                skills: battleSkills,
                skillLevels: hData.skillLevels,
                name: def.nameKo,
                img: imgSrc,
                classId: cid,
                level: hData.level,
                buffs: { atk: 0, def: 0, evasion: 0, counter: 0, invuln: 0, nextCrit: false, nextDouble: false }
            },
            enemy: null,
            cooldowns: [0, 0, 0, 0], // ì²˜ìŒì—” ì´ˆê¸°í™”
            enemyCooldowns: []
        };

        document.getElementById("lobbyScreen").classList.remove("active");
        document.getElementById("battleScreen").classList.add("active");
        startBattleStage();
    }

    function startBattleStage() {
        const bs = battleState;
        const isBoss = (bs.stage % 5 === 0);
        let availableEnemies = ENEMY_VARIANTS.filter(e => isBoss ? e.bossOnly : !e.bossOnly);
        if (availableEnemies.length === 0) availableEnemies = ENEMY_VARIANTS;

        const variant = availableEnemies[Math.floor(Math.random() * availableEnemies.length)];
        const stageMult = 1 + (bs.stage * 0.2);

        const monsterSkills = (variant.skills || []).map(k => MONSTER_SKILLS[k]).filter(s => s);

        const pLevel = battleState.player.level;
        const enemyLevel = Math.max(1, pLevel + Math.floor((bs.stage - 1) * 0.5));

        bs.enemy = {
            name: variant.name + (isBoss ? " (BOSS)" : ""),
            maxHp: Math.floor((10 + (enemyLevel * 3)) * (variant.hpMult || 1.0)),
            hp: Math.floor((10 + (enemyLevel * 3)) * (variant.hpMult || 1.0)),
            atk: Math.floor((3 + (enemyLevel * 1.5)) * (variant.atkMult || 1.0)),
            def: Math.floor(1 + (enemyLevel * 0.5)),
            img: variant.src,
            isBoss: isBoss,
            buffs: { stun: 0 },
            skills: monsterSkills,
            skillLevels: {}
        };

        // ì¿¨íƒ€ì„ 0ì¸ ìŠ¤í‚¬ ê°•ì œ ì´ˆê¸°í™” (ì•ˆì „ì¥ì¹˜)
        bs.player.skills.forEach((s, i) => {
            if((s.cd || 0) === 0) bs.cooldowns[i] = 0;
        });

        // ì  ì¿¨íƒ€ì„ ë¦¬ì…‹
        bs.enemyCooldowns = new Array(monsterSkills.length).fill(0);

        document.getElementById("battleStageText").textContent = bs.stage;
        document.getElementById("enemyName").textContent = bs.enemy.name;
        document.getElementById("enemyLevel").textContent = `Lv.${enemyLevel}`;

        document.getElementById("enemyImg").src = bs.enemy.img;
        document.getElementById("enemyImg").className = "w-28 h-28 md:w-32 md:h-32 pixel-art animate-bounce";

        const wrapper = document.getElementById("enemyWrapper");
        if (isBoss) {
            wrapper.className = "relative enemy-flip-boss z-10";
            document.getElementById("enemyUiContainer").classList.add("-translate-y-8");
        } else {
            wrapper.className = "relative enemy-flip z-10";
            document.getElementById("enemyUiContainer").classList.remove("-translate-y-8");
        }

        updateBattleUI();
        logBattle(`${bs.enemy.name} ì¶œí˜„! (Lv.${enemyLevel})`);
    }

    function usePotion() {
        if (!battleState) return;
        if (gameState.potions <= 0) {
            alert("í¬ì…˜ì´ ì—†ìŠµë‹ˆë‹¤!");
            return;
        }
        if (battleState.player.hp >= battleState.player.maxHp) {
            alert("ì²´ë ¥ì´ ì´ë¯¸ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.");
            return;
        }

        gameState.potions--;
        const heal = Math.floor(battleState.player.maxHp * 0.5); // 50% íšŒë³µ
        battleState.player.hp = Math.min(battleState.player.maxHp, battleState.player.hp + heal);

        logBattle(`í¬ì…˜ ì‚¬ìš©! HP ${heal} íšŒë³µ.`);
        updateBattleUI();
        saveGameData();
    }

    function createFloatingText(text, target) {
        const container = document.getElementById("playerFloatText");
        const el = document.createElement("div");
        el.className = "absolute text-white font-black text-xl stroke-black animate-float";
        el.style.textShadow = "2px 2px 0 #000";
        el.textContent = text;
        container.appendChild(el);
        setTimeout(() => el.remove(), 800);
    }

    function updateBattleUI() {
        if(!battleState) return;
        const p = battleState.player;
        const e = battleState.enemy;

        document.getElementById("playerImg").src = p.img;
        document.getElementById("playerName").textContent = p.name;
        document.getElementById("playerLevel").textContent = `Lv.${p.level}`;
        document.getElementById("playerHpText").textContent = `${p.hp}/${p.maxHp}`;
        document.getElementById("playerHpBar").style.width = `${Math.max(0, (p.hp/p.maxHp)*100)}%`;

        const shieldPct = Math.min(100, (p.shield / p.maxHp) * 100);
        document.getElementById("playerShieldBar").style.width = `${shieldPct}%`;

        const pBuffsEl = document.getElementById("playerBuffs");
        pBuffsEl.innerHTML = "";
        if (p.buffs.atk > 0) pBuffsEl.innerHTML += `<span class="text-[9px] bg-red-100 text-red-600 px-1 rounded border border-red-200">ê³µê²©UP ${p.buffs.atk}</span>`;
        if (p.buffs.def > 0) pBuffsEl.innerHTML += `<span class="text-[9px] bg-blue-100 text-blue-600 px-1 rounded border border-blue-200">ë°©ì–´UP ${p.buffs.def}</span>`;
        if (p.buffs.evasion > 0) pBuffsEl.innerHTML += `<span class="text-[9px] bg-green-100 text-green-600 px-1 rounded border border-green-200">íšŒí”¼ON ${p.buffs.evasion}</span>`;
        if (p.buffs.counter > 0) pBuffsEl.innerHTML += `<span class="text-[9px] bg-orange-100 text-orange-600 px-1 rounded border border-orange-200">ë°˜ê²©ON ${p.buffs.counter}</span>`;
        if (p.buffs.invuln > 0) pBuffsEl.innerHTML += `<span class="text-[9px] bg-sky-100 text-sky-600 px-1 rounded border border-sky-200">ë¬´ì  ${p.buffs.invuln}</span>`;
        if (p.buffs.nextCrit) pBuffsEl.innerHTML += `<span class="text-[9px] bg-purple-100 text-purple-600 px-1 rounded border border-purple-200">ì¹˜ëª…íƒ€í™•ì •</span>`;
        if (p.buffs.nextDouble) pBuffsEl.innerHTML += `<span class="text-[9px] bg-indigo-100 text-indigo-600 px-1 rounded border border-indigo-200">ë§ˆë ¥ì¦í­</span>`;

        if (p.shield > 0) pBuffsEl.innerHTML += `<span class="text-[9px] bg-yellow-100 text-yellow-600 px-1 rounded border border-yellow-200">ë³´í˜¸ë§‰ ${p.shield}</span>`;

        document.getElementById("enemyHpBar").style.width = `${Math.max(0, (e.hp/e.maxHp)*100)}%`;

        const eBuffsEl = document.getElementById("enemyBuffs");
        eBuffsEl.innerHTML = "";
        if (e.buffs.stun > 0) eBuffsEl.innerHTML += `<span class="text-[9px] bg-purple-100 text-purple-600 px-1 rounded border border-purple-200">ê¸°ì ˆ ${e.buffs.stun}</span>`;

        document.getElementById("battlePotionCount").textContent = gameState.potions;
        const potionBtn = document.getElementById("battlePotionBtn");
        if (gameState.potions <= 0) potionBtn.disabled = true;
        else potionBtn.disabled = false;

        renderSkillButtons();
    }

    function renderSkillButtons() {
        const grid = document.getElementById("skillGrid");
        grid.innerHTML = "";

        // ëª¨ë“  ìŠ¤í‚¬ì´ ì¿¨íƒ€ì„ì¸ì§€ ì²´í¬
        const allCooldown = battleState.player.skills.every((_, i) => battleState.cooldowns[i] > 0);

        if (allCooldown) {
            grid.className = "flex flex-col gap-2";
            const btn = document.createElement("button");
            btn.className = "w-full py-4 bg-slate-700 text-white rounded-xl font-bold border-2 border-slate-600 hover:bg-slate-600 active:scale-95 transition-all";
            btn.innerHTML = `
                <div class="text-lg">ğŸ’¤ íœ´ì‹</div>
                <div class="text-xs text-slate-400">ëª¨ë“  ìŠ¤í‚¬ ì¿¨íƒ€ì„ ì¤‘... (í„´ ë„˜ê¸°ê¸°)</div>
            `;
            btn.onclick = () => handleSkipTurn();
            grid.appendChild(btn);
            return;
        }

        grid.className = "grid grid-cols-2 gap-2";

        battleState.player.skills.forEach((skill, idx) => {
            const cd = battleState.cooldowns[idx];
            const lv = battleState.player.skillLevels[skill.id] || 1;
            const stats = getEffectiveSkillStats(skill, lv);

            const btn = document.createElement("button");
            btn.className = `p-3 rounded-lg border-2 text-left relative overflow-hidden transition-all ${cd > 0 ? 'bg-slate-700 border-slate-600 text-slate-500 cursor-not-allowed' : 'bg-slate-800 border-blue-500 text-white hover:bg-slate-700 active:scale-95'}`;

            btn.innerHTML = `
                <div class="font-bold text-sm">${skill.name} <span class="text-[10px] text-yellow-400">Lv.${lv}</span></div>
                <div class="text-[10px] opacity-70 truncate">${skill.desc}</div>
                ${cd > 0 ? `<div class="absolute inset-0 bg-black/50 flex items-center justify-center font-bold text-xl text-white">${cd}</div>` : ''}
            `;

            if (cd === 0) {
                btn.onclick = () => handlePlayerMove(idx);
            }
            grid.appendChild(btn);
        });
    }

    function handleSkipTurn() {
        logBattle("ì‚¬ìš© ê°€ëŠ¥í•œ ìŠ¤í‚¬ì´ ì—†ìŠµë‹ˆë‹¤. íœ´ì‹ì„ ì·¨í•©ë‹ˆë‹¤.");
        setTimeout(enemyTurn, 600);
    }

    function logBattle(msg) {
        document.getElementById("battleLog").textContent = msg;
    }

    function handlePlayerMove(skillIdx) {
        openQuiz((isCorrect) => {
            if (!isCorrect) {
                logBattle("í€´ì¦ˆ ì˜¤ë‹µ! í„´ì„ ë„˜ê¹ë‹ˆë‹¤.");
                setTimeout(enemyTurn, 800);
                return;
            }

            const p = battleState.player;
            const e = battleState.enemy;
            const skill = p.skills[skillIdx];
            const slv = p.skillLevels[skill.id] || 1;
            const stats = getEffectiveSkillStats(skill, slv);

            battleState.cooldowns[skillIdx] = (stats.cd || 0) + 1;

            if (skill.type.includes("atk")) {
                const pImg = document.getElementById("playerImg");
                pImg.classList.add("animate-lunge");
                setTimeout(() => pImg.classList.remove("animate-lunge"), 200);
            }

            applySkillEffect(p, e, skill, slv);

            updateBattleUI();

            if (e.hp <= 0) {
                setTimeout(winStage, 600);
            } else {
                setTimeout(enemyTurn, 800);
            }
        });
    }

    function applySkillEffect(attacker, defender, skill, level) {
        let mult = 1.0;
        if (attacker.buffs && attacker.buffs.atk > 0) mult += 0.5;

        let lvlMult = 1 + (level * 0.1);
        let dmg = Math.floor(attacker.atk * skill.power * lvlMult * mult);

        const stats = getEffectiveSkillStats(skill, level);

        if (battleState.mode === "ghost" && attacker === battleState.enemy) {
            dmg = Math.floor(dmg * 0.9);
        }

        // --- ë²„í”„/ìŠ¤í˜ì…œ ë¡œì§ (v11.0) ---

        // ì¹˜ëª…íƒ€/2ë°°
        if (attacker.buffs.nextCrit && skill.type.includes('atk')) {
            dmg = Math.floor(dmg * 2.0);
            attacker.buffs.nextCrit = false;
            logBattle("ì•½ì  ê°„íŒŒ! ì¹˜ëª…íƒ€ ì ì¤‘!");
        } else if (skill.type.includes("crit") && Math.random() < 0.4) {
            dmg = Math.floor(dmg * 1.5);
            logBattle("ì¹˜ëª…íƒ€ ì ì¤‘!");
        }

        if (attacker.buffs.nextDouble && skill.type.includes('atk')) {
            dmg *= 2;
            attacker.buffs.nextDouble = false;
            logBattle("ë§ˆë ¥ í­ë°œ! ë°ë¯¸ì§€ 2ë°°!");
        }

        // ìœ í‹¸/ë²„í”„
        if (skill.type === "atk_execute" && defender.hp <= defender.maxHp * 0.3) dmg *= 2;
        if (skill.type === "atk_stun") defender.buffs.stun = 1;

        if (skill.type === "buff_atk") { attacker.buffs.atk = stats.duration; logBattle("ê³µê²©ë ¥ ì¦ê°€!"); }
        if (skill.type === "buff_def") { attacker.buffs.def = stats.duration; logBattle("ë°©ì–´ íƒœì„¸!"); }
        if (skill.type === "buff_evasion") { attacker.buffs.evasion = stats.duration; logBattle("íšŒí”¼ìœ¨ ì¦ê°€!"); }
        if (skill.type === "buff_counter") { attacker.buffs.counter = stats.duration; logBattle("ë°˜ê²© íƒœì„¸!"); }
        if (skill.type === "buff_invuln") { attacker.buffs.invuln = 1; logBattle("ë¬´ì  ìƒíƒœ!"); }
        if (skill.type === "buff_next_crit") { attacker.buffs.nextCrit = true; logBattle("ë‹¤ìŒ ê³µê²© ì¹˜ëª…íƒ€!"); }
        if (skill.type === "buff_next_double") { attacker.buffs.nextDouble = true; logBattle("ë§ˆë ¥ ì¦í­!"); }

        // ì‹ ê·œ: ì„±ì±„ ì „ê°œ (ê¸°ì‚¬ ê¶ê·¹ê¸°)
        if (skill.type === "buff_aegis") {
            attacker.buffs.def = 3;
            attacker.buffs.counter = 3;
            const s = Math.floor(attacker.maxHp * 0.5);
            attacker.shield += s;
            logBattle(`ì„±ì±„ ì „ê°œ! ë°©ì–´/ë°˜ê²©/ì‰´ë“œ(${s})`);
        }

        // ì‹ ê·œ: ë§ˆë ¥ í•´ì œ (ë§ˆë²•ì‚¬ ë””ìŠ¤í )
        if (skill.type === "dispel") {
            defender.shield = 0;
            defender.buffs = { atk:0, def:0, evasion:0, counter:0, invuln:0, nextCrit:false, nextDouble:false };
            logBattle("ì ì˜ ë²„í”„ì™€ ì‰´ë“œë¥¼ ëª¨ë‘ ì œê±°í–ˆìŠµë‹ˆë‹¤!");
        }

        // ì‰´ë“œ/í
        if (skill.type.includes("shield")) {
            const ratio = skill.type==='buff_shield_huge' ? 0.5 : 0.3;
            attacker.shield += Math.floor(attacker.maxHp * ratio * lvlMult);
            logBattle("ë³´í˜¸ë§‰ ìƒì„±!");
        }

        if (skill.type.includes("heal")) {
            let heal = 0;
            if(skill.type === 'buff_heal_missing') heal = Math.floor((attacker.maxHp - attacker.hp) * 0.3 * lvlMult);
            else {
                const ratio = (skill.id === 'ms_regen') ? 0.3 : 0.2;
                heal = Math.floor(attacker.maxHp * ratio * lvlMult);
            }
            attacker.hp = Math.min(attacker.maxHp, attacker.hp + heal);
            logBattle(`HP ${heal} íšŒë³µ`);
        }

        // ê³µê²© ì²˜ë¦¬
        if (skill.power > 0) {
            // ì  ë¬´ì /íšŒí”¼ ì²´í¬
            if (defender.buffs && defender.buffs.invuln > 0) {
                logBattle("ê³µê²©ì´ ë¬´íš¨í™”ë˜ì—ˆìŠµë‹ˆë‹¤! (ë¬´ì )");
                return;
            }
            if (defender.buffs && defender.buffs.evasion > 0) {
                if (Math.random() < 0.8) {
                    logBattle("ê³µê²©ì´ ë¹—ë‚˜ê°”ìŠµë‹ˆë‹¤! (íšŒí”¼)");
                    if(defender === battleState.player) createFloatingText("MISS!", "player");
                    return;
                }
            }

            // ë°˜ê²© ì²´í¬
            let reflectDmg = 0;
            if (defender.buffs && defender.buffs.counter > 0) {
                reflectDmg = Math.floor(dmg * 0.5);
                dmg = Math.floor(dmg * 0.5); // 50% ê²½ê°
                logBattle("ë°˜ê²©ë‹¹í–ˆìŠµë‹ˆë‹¤!");
            }

            let finalDmg = Math.max(1, dmg - Math.floor(defender.def * 0.5));
            if (defender.buffs && defender.buffs.def > 0) finalDmg = Math.floor(finalDmg * 0.5);

            // í¡í˜ˆ
            if (skill.type === 'atk_vampire') {
                const drain = Math.floor(finalDmg * 0.5);
                attacker.hp = Math.min(attacker.maxHp, attacker.hp + drain);
                logBattle(`${drain} í¡í˜ˆ!`);
            }

            if (defender.shield > 0) {
                if (defender.shield >= finalDmg) {
                    defender.shield -= finalDmg;
                    finalDmg = 0;
                    logBattle("ë³´í˜¸ë§‰ìœ¼ë¡œ ë°©ì–´!");
                } else {
                    finalDmg -= defender.shield;
                    defender.shield = 0;
                    logBattle("ë³´í˜¸ë§‰ íŒŒê´´!");
                }
            }

            if (finalDmg > 0) {
                defender.hp -= finalDmg;
                logBattle(`${skill.name}! ${finalDmg} í”¼í•´.`);
                const targetImg = defender === battleState.player ? document.getElementById("playerImg") : document.getElementById("enemyImg");
                targetImg.classList.add("animate-damage");
                setTimeout(() => targetImg.classList.remove("animate-damage"), 400);
            }

            if (reflectDmg > 0) {
                attacker.hp -= reflectDmg;
                logBattle(`ë°˜ì‚¬ í”¼í•´ ${reflectDmg}ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤.`);
            }
        }
    }

    function enemyTurn() {
        if (!battleState || battleState.enemy.hp <= 0) return;

        const e = battleState.enemy;

        if (e.buffs.stun > 0) {
            e.buffs.stun--;
            logBattle(`${e.name}ì€(ëŠ”) ê¸°ì ˆí•˜ì—¬ ì›€ì§ì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`);
            endEnemyTurn();
            return;
        }

        if (e.skills && e.skills.length > 0 && Math.random() < 0.7) {
            const usable = [];
            for (let i = 0; i < e.skills.length; i++) {
                if ((battleState.enemyCooldowns?.[i] ?? 0) === 0) usable.push(i);
            }

            if (usable.length > 0) {
                const idx = usable[Math.floor(Math.random() * usable.length)];
                const skill = e.skills[idx];
                const slv = (e.skillLevels && e.skillLevels[skill.id]) ? e.skillLevels[skill.id] : 1;
                const stats = getEffectiveSkillStats(skill, slv);

                battleState.enemyCooldowns[idx] = (stats.cd || 0) + 1;

                if(skill.type.includes("atk")) {
                    const eImg = document.getElementById("enemyImg");
                    eImg.classList.add("animate-lunge-enemy");
                    setTimeout(() => eImg.classList.remove("animate-lunge-enemy"), 200);
                }

                applySkillEffect(e, battleState.player, skill, slv);
                checkPlayerDeath();
                if (battleState.player.hp > 0) endEnemyTurn();
                return;
            }
        }

        const p = battleState.player;

        if (p.buffs.evasion > 0) {
            if (Math.random() < 0.8) {
                logBattle("íšŒí”¼ ì„±ê³µ!");
                createFloatingText("MISS!", "player");
                endEnemyTurn();
                return;
            }
        }
        if (p.buffs.invuln > 0) {
            logBattle("ë¬´ì  ìƒíƒœë¼ í”¼í•´ë¥¼ ì…ì§€ ì•ŠìŠµë‹ˆë‹¤.");
            endEnemyTurn();
            return;
        }

        let dmg = Math.max(1, e.atk - Math.floor(p.def * 0.5));

        const eImg = document.getElementById("enemyImg");
        eImg.classList.add("animate-lunge-enemy");
        setTimeout(() => eImg.classList.remove("animate-lunge-enemy"), 200);

        if (p.buffs.counter > 0) {
            const reflect = Math.floor(dmg * 0.5);
            dmg = Math.floor(dmg * 0.5);
            e.hp -= reflect;
            logBattle(`ë°˜ê²©! ${reflect}ì˜ í”¼í•´ë¥¼ ëŒë ¤ì£¼ì—ˆìŠµë‹ˆë‹¤.`);
        }

        if (p.buffs.def > 0) dmg = Math.floor(dmg * 0.5);

        if (p.shield > 0) {
            if (p.shield >= dmg) {
                p.shield -= dmg;
                dmg = 0;
                logBattle("ë³´í˜¸ë§‰ì´ ê³µê²©ì„ ë§‰ì•˜ìŠµë‹ˆë‹¤!");
            } else {
                dmg -= p.shield;
                p.shield = 0;
                logBattle("ë³´í˜¸ë§‰ì´ íŒŒê´´ë˜ì—ˆìŠµë‹ˆë‹¤!");
            }
        }

        if (dmg > 0) {
            p.hp -= dmg;
            logBattle(`${e.name}ì˜ ê³µê²©! ${dmg} í”¼í•´.`);
            const pImg = document.getElementById("playerImg");
            pImg.classList.add("animate-damage");
            setTimeout(() => pImg.classList.remove("animate-damage"), 400);
        }

        checkPlayerDeath();
        if (battleState.player.hp > 0) endEnemyTurn();
    }

    function checkPlayerDeath() {
        if (battleState.player.hp <= 0) {
            updateBattleUI();
            setTimeout(() => {
                if (battleState.mode !== "ghost") {
                    addHoF({ kind: "lose", stage: battleState.stage, enemy: battleState.enemy.name });
                }
                alert(`íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...`);
                battleState = null;
                document.getElementById("battleScreen").classList.remove("active");
                document.getElementById("lobbyScreen").classList.add("active");
            }, 600);
        }
    }

    function endEnemyTurn() {
        if (!battleState) return;
        const p = battleState.player;

        battleState.cooldowns = battleState.cooldowns.map(c => Math.max(0, c - 1));
        if (battleState.enemyCooldowns) {
            battleState.enemyCooldowns = battleState.enemyCooldowns.map(c => Math.max(0, c - 1));
        }

        // ë²„í”„ í„´ ê°ì†Œ
        ['atk','def','evasion','counter','invuln'].forEach(k => {
            if(p.buffs[k] > 0) p.buffs[k]--;
        });
        // ì¼íšŒì„± ë²„í”„ëŠ” ìœ ì§€(ì‚¬ìš© ì‹œ ì†Œëª¨)

        updateBattleUI();
    }

    function winStage() {
        if (!battleState) return;
        const bs = battleState;
        const xpGain = 10 + (bs.stage * 5);
        let goldGain = 10; // ê¸°ë³¸ 10G ë³´ìƒ

        if (bs.enemy.isBoss) goldGain = 50 + (bs.stage * 10); // ë³´ìŠ¤ëŠ” ì¶”ê°€ ë³´ìƒ

        if (bs.mode === "ghost") {
            addHoF({ kind: "ghost_win", enemy: bs.enemy.name, level: bs.enemy.level });
            alert(`ìŠ¹ë¦¬! ê²½í—˜ì¹˜ ${xpGain} íšë“!`);

            const hData = gameState.heroes[gameState.selectedClass];
            hData.xp += xpGain;
            saveGameData();

            battleState = null;
            document.getElementById("battleScreen").classList.remove("active");
            document.getElementById("lobbyScreen").classList.add("active");
            updateLobbyUI();
            return;
        }

        const hData = gameState.heroes[gameState.selectedClass];
        hData.xp += xpGain;
        gameState.gold += goldGain;

        let leveledUp = false;
        while (hData.xp >= hData.level * 100) {
            hData.xp -= hData.level * 100;
            hData.level++;
            leveledUp = true;
        }
        saveGameData();

        document.getElementById("rewardXpVal").textContent = xpGain + (leveledUp ? " (LEVEL UP!)" : "");
        if (goldGain > 0) {
            document.getElementById("rewardGoldVal").textContent = goldGain;
            document.getElementById("rewardGoldSection").classList.remove("hidden");
        } else {
            document.getElementById("rewardGoldSection").classList.add("hidden");
        }

        showModal("rewardModal");

        document.getElementById("rewardOkBtn").onclick = () => {
            hideModal("rewardModal");
            const newStats = getHeroStats(hData.classId || gameState.selectedClass);
            bs.player.maxHp = newStats.maxHp;
            bs.player.atk = newStats.atk;
            bs.player.def = newStats.def;
            bs.player.level = hData.level;

            bs.cooldowns = bs.cooldowns.map(c => Math.max(0, c - 1));
            bs.player.hp = Math.min(bs.player.hp, bs.player.maxHp);
            bs.stage++;
            startBattleStage();
        };
    }

    /* =========================================
     * 6. QUIZ LOGIC (FRACTION)
     * ========================================= */
    async function loadQuizData() {
        document.getElementById("startButton").disabled = false;
        document.getElementById("loadingStatus").textContent = "ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ";
    }

    function openQuiz(cb) {
        quizCallback = cb;
        const q = generateFractionQuiz();

        document.getElementById("quizExplain").textContent = q.q;
        document.getElementById("quizVisual").innerHTML = q.html;
        document.getElementById("quizQuestion").textContent = "";

        const grid = document.getElementById("quizChoices");
        grid.innerHTML = "";
        q.choices.forEach(c => {
            const btn = document.createElement("button");
            btn.className = "bg-slate-100 hover:bg-blue-100 border-2 border-slate-200 font-bold py-4 rounded-xl text-xl transition-colors";
            btn.textContent = c;
            btn.onclick = () => {
                hideModal("quizModal");
                if (quizCallback) quizCallback(c == q.answer);
            };
            grid.appendChild(btn);
        });
        showModal("quizModal");
    }

    function generateFractionQuiz() {
        const den = Math.floor(Math.random() * 8) + 2;
        const num = Math.floor(Math.random() * (den - 1)) + 1;
        const isCircle = Math.random() < 0.5;

        let visualHtml = "";
        if (isCircle) {
            const percent = (num / den) * 100;
            const lineDeg = 360 / den;
            visualHtml = `
                <div class="w-32 h-32 rounded-full border-4 border-slate-700 relative" 
                     style="background: conic-gradient(#3b82f6 0% ${percent}%, #e2e8f0 ${percent}% 100%);">
                     <div class="absolute inset-0 rounded-full" 
                          style="background: repeating-conic-gradient(transparent 0deg ${lineDeg-1}deg, #ffffff ${lineDeg-1}deg ${lineDeg}deg);"></div>
                </div>`;
        } else {
            let gridHtml = "";
            for(let i=0; i<den; i++) {
                gridHtml += `<div class="border-r border-slate-700 last:border-r-0 ${i < num ? 'bg-blue-500' : 'bg-slate-200'}"></div>`;
            }
            visualHtml = `
                <div class="w-full h-16 border-2 border-slate-700 grid" 
                     style="grid-template-columns: repeat(${den}, 1fr)">
                    ${gridHtml}
                </div>`;
        }

        const correctVal = num / den;
        const correctStr = `${num}/${den}`;

        const choices = new Set([correctStr]);
        const usedValues = new Set([correctVal]);

        while(choices.size < 4) {
            const d = Math.floor(Math.random() * 8) + 2;
            const n = Math.floor(Math.random() * (d - 1)) + 1;
            const val = n / d;

            if (!usedValues.has(val)) {
                usedValues.add(val);
                choices.add(`${n}/${d}`);
            }
        }

        return {
            q: "ìƒ‰ì¹ í•œ ë¶€ë¶„ì„ ë¶„ìˆ˜ë¡œ ë‚˜íƒ€ë‚´ë©´?",
            html: visualHtml,
            choices: Array.from(choices).sort(() => Math.random() - 0.5),
            answer: correctStr
        };
    }

    /* =========================================
     * 7. GHOST (QR) & HoF SYSTEM
     * ========================================= */
    let ghostScanStream = null;
    let ghostScanFrameId = null;

    function openGhostModal() {
        showModal("ghostModal");
        switchGhostTab('my');

        const cid = gameState.selectedClass;
        const hero = gameState.heroes[cid];
        const def = HERO_DEFINITIONS[cid];
        const stats = getHeroStats(cid);

        const payload = {
            v: 110, // ë²„ì „ ì—…ë°ì´íŠ¸
            cid: cid,
            lv: hero.level,
            eq: hero.equipped,
            slv: hero.skillLevels,
            nm: def.nameKo,
            stats: stats,
            ts: Date.now()
        };

        const jsonStr = JSON.stringify(payload);
        const token = toBase64UTF8(jsonStr);
        const GHOST_ROOT_URL = "https://unluckyidiot16.github.io/WebGames/DQR/DQR.html";
        const url = `${GHOST_ROOT_URL}?ghost=${encodeURIComponent(token)}`;

        const canvas = document.getElementById("ghostQrCanvas");
        if(QRCode) QRCode.toCanvas(canvas, url, { width: 200 }, (err) => {});
        document.getElementById("ghostMySummary").textContent = `${def.nameKo} Lv.${hero.level}`;
    }

    function switchGhostTab(tab) {
        const myPane = document.getElementById("ghostMyPane");
        const scanPane = document.getElementById("ghostScanPane");
        const myBtn = document.getElementById("ghostTabMyBtn");
        const scanBtn = document.getElementById("ghostTabScanBtn");

        if (tab === 'my') {
            myPane.classList.remove('hidden');
            scanPane.classList.add('hidden');
            myBtn.classList.add('bg-slate-800', 'text-white');
            myBtn.classList.remove('bg-slate-100', 'text-slate-500');
            scanBtn.classList.add('bg-slate-100', 'text-slate-500');
            scanBtn.classList.remove('bg-slate-800', 'text-white');
            stopGhostScan();
        } else {
            myPane.classList.add('hidden');
            scanPane.classList.remove('hidden');
            scanBtn.classList.add('bg-slate-800', 'text-white');
            scanBtn.classList.remove('bg-slate-100', 'text-slate-500');
            myBtn.classList.add('bg-slate-100', 'text-slate-500');
            myBtn.classList.remove('bg-slate-800', 'text-white');
        }
    }

    async function startGhostScan() {
        const video = document.getElementById("ghostVideo");
        const statusEl = document.getElementById("ghostScanStatus");
        try {
            statusEl.textContent = "ì¹´ë©”ë¼ ì‹œì‘ ì¤‘...";
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            ghostScanStream = stream;
            video.srcObject = stream;
            video.play();
            statusEl.textContent = "QR ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”.";
            requestAnimationFrame(tickGhostScan);
        } catch (err) {
            statusEl.textContent = "ì¹´ë©”ë¼ ê¶Œí•œ ì˜¤ë¥˜";
        }
    }

    function tickGhostScan() {
        if (!ghostScanStream) return;
        const video = document.getElementById("ghostVideo");
        const canvas = document.getElementById("ghostScanCanvas");
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height);
            if (code) {
                const payload = parseGhostFromUrl(code.data);
                if (payload) {
                    stopGhostScan();
                    startGhostBattle(payload);
                    return;
                }
            }
        }
        ghostScanFrameId = requestAnimationFrame(tickGhostScan);
    }

    function stopGhostScan() {
        if (ghostScanStream) {
            ghostScanStream.getTracks().forEach(t => t.stop());
            ghostScanStream = null;
        }
        if (ghostScanFrameId) cancelAnimationFrame(ghostScanFrameId);
    }

    function parseGhostFromUrl(urlStr) {
        try {
            const url = new URL(urlStr);
            const data = url.searchParams.get("ghost");
            if (data) {
                const json = fromBase64UTF8(data);
                return JSON.parse(json);
            }
        } catch(e) { return null; }
        return null;
    }

    function startGhostBattle(ghostData) {
        hideModal("ghostModal");

        const myCid = gameState.selectedClass;
        const myHero = gameState.heroes[myCid];
        const myDef = HERO_DEFINITIONS[myCid];
        const myStats = getHeroStats(myCid);
        const myImg = myHero.skin === "skin" ? myDef.sprites.skin : myDef.sprites.default;
        const mySkills = myHero.equipped.map(sid => myDef.skills.find(s => s.id === sid));

        const enemyDef = HERO_DEFINITIONS[ghostData.cid] || HERO_DEFINITIONS['knight'];
        const enemyImg = enemyDef.sprites.default;

        const eStatsRaw = ghostData.stats || {};
        // ê³ ìŠ¤íŠ¸ ë°°í‹€ 5ë°° ë»¥íŠ€ê¸° ë¡œì§
        const HP_MULT = 5;
        const eMaxHp = (Number(eStatsRaw.maxHp ?? eStatsRaw.hp) || Math.floor(10 + ghostData.lv * 2)) * HP_MULT;
        const eAtk   = Number(eStatsRaw.atk) || Math.floor(2 + ghostData.lv * 1.3);
        const eDef   = Number(eStatsRaw.def) || 5;

        // í”Œë ˆì´ì–´ ì²´ë ¥ë„ 5ë°°
        const pMaxHp = myStats.maxHp * HP_MULT;

        let enemySkills = [];
        if (ghostData.eq && Array.isArray(ghostData.eq)) {
            enemySkills = ghostData.eq.map(sid => enemyDef.skills.find(s => s.id === sid)).filter(s => s);
        } else {
            enemySkills = enemyDef.skills.slice(0, 4);
        }

        battleState = {
            mode: "ghost",
            stage: 1,
            player: {
                ...myStats, maxHp: pMaxHp, hp: pMaxHp, shield: 0,
                skills: mySkills, skillLevels: myHero.skillLevels,
                name: myDef.nameKo, img: myImg, classId: myCid, level: myHero.level,
                buffs: { atk: 0, def: 0, evasion: 0, counter: 0, invuln: 0, nextCrit: false, nextDouble: false }
            },
            enemy: {
                name: `Ghost ${ghostData.nm}`,
                maxHp: eMaxHp, hp: eMaxHp,
                atk: eAtk, def: eDef,
                img: enemyImg,
                isBoss: true,
                level: ghostData.lv,
                buffs: { stun: 0 },
                skills: enemySkills,
                skillLevels: ghostData.slv || {}
            },
            cooldowns: new Array(mySkills.length).fill(0),
            enemyCooldowns: new Array(enemySkills.length).fill(0)
        };

        document.getElementById("lobbyScreen").classList.remove("active");
        document.getElementById("battleScreen").classList.add("active");

        updateBattleUI();
        document.getElementById("enemyImg").src = enemyImg;
        document.getElementById("enemyImg").className = "w-32 h-32 pixel-art animate-bounce";
        const wrapper = document.getElementById("enemyWrapper");
        wrapper.className = "relative enemy-flip-boss";

        document.getElementById("enemyName").textContent = battleState.enemy.name;
        document.getElementById("enemyLevel").textContent = `Lv.${battleState.enemy.level}`;
        logBattle("ê³ ìŠ¤íŠ¸ì™€ì˜ ëŒ€ê²°ì´ ì‹œì‘ë©ë‹ˆë‹¤!");
    }

    function renderHoF() {
        const list = getHoF();
        const container = document.getElementById("hofList");
        container.innerHTML = "";

        if (list.length === 0) {
            container.innerHTML = "<div class='text-center text-slate-500 py-4'>ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>";
            return;
        }

        list.forEach(rec => {
            const row = document.createElement("div");
            row.className = "bg-white p-3 rounded-xl border border-yellow-200 shadow-sm";
            let content = "";
            if (rec.kind === "ghost_win") {
                content = `<span class="text-purple-600 font-bold">VS ê³ ìŠ¤íŠ¸ ìŠ¹ë¦¬</span> <span class="text-xs text-slate-500">(${rec.enemy} Lv.${rec.level})</span>`;
            } else if (rec.kind === "lose") {
                content = `<span class="text-red-500 font-bold">íƒí—˜ ì‹¤íŒ¨</span> <span class="text-xs text-slate-500">${rec.stage}ì¸µ (${rec.enemy})</span>`;
            } else {
                content = `<span class="text-slate-700">ê¸°ë¡</span> <span class="text-xs">${rec.date}</span>`;
            }
            row.innerHTML = `<div class="flex justify-between items-center">${content}<div class="text-[10px] text-slate-400">${rec.date}</div></div>`;
            container.appendChild(row);
        });
    }

    /* =========================================
     * INIT
     * ========================================= */
    window.onload = () => {
        loadGameData();
        loadQuizData();

        const pendingGhost = parseGhostFromUrl(window.location.href);
        if (pendingGhost) {
            if(confirm(`Ghost ${pendingGhost.nm} (Lv.${pendingGhost.lv})ì™€ ëŒ€ê²°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                setTimeout(() => startGhostBattle(pendingGhost), 500);
            }
        }

        document.getElementById("startButton").onclick = () => {
            document.getElementById("titleScreen").classList.remove("active");
            document.getElementById("lobbyScreen").classList.add("active");
            updateLobbyUI();
        };

        document.getElementById("btnEnterDungeon").onclick = startDungeon;

        // PvP ë²„íŠ¼ í´ë¦­ ì‹œ í˜ì´ì§€ ì´ë™
        document.getElementById("btnPvP").onclick = () => {
            window.location.href = "DQR_PvP.html";
        };

        document.getElementById("btnChangeClass").onclick = () => {
            renderClassSelect();
            document.getElementById("lobbyScreen").classList.remove("active");
            document.getElementById("classSelectScreen").classList.add("active");
        };

        document.getElementById("btnCancelClassSelect").onclick = () => {
            document.getElementById("classSelectScreen").classList.remove("active");
            document.getElementById("lobbyScreen").classList.add("active");
            updateLobbyUI();
        };

        document.getElementById("btnTraining").onclick = openTraining;
        document.getElementById("closeTrainingBtn").onclick = () => hideModal("trainingModal");

        document.getElementById("btnGhost").onclick = openGhostModal;
        document.getElementById("ghostClose").onclick = () => {
            stopGhostScan();
            hideModal("ghostModal");
        };

        document.getElementById("ghostTabMyBtn").onclick = () => switchGhostTab('my');
        document.getElementById("ghostTabScanBtn").onclick = () => switchGhostTab('scan');
        document.getElementById("ghostScanStartBtn").onclick = startGhostScan;
        document.getElementById("ghostScanStopBtn").onclick = stopGhostScan;

        document.getElementById("btnHoF").onclick = () => {
            renderHoF();
            showModal("hofModal");
        };
        document.getElementById("hofClose").onclick = () => hideModal("hofModal");

        document.getElementById("battleGiveUpBtn").onclick = () => {
            if(confirm("ì •ë§ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³´ìƒ ì—†ìŒ)")) {
                battleState = null;
                document.getElementById("battleScreen").classList.remove("active");
                document.getElementById("lobbyScreen").classList.add("active");
            }
        };

        document.getElementById("quizCancel").onclick = () => {
            hideModal("quizModal");
            if(quizCallback) quizCallback(false);
        };
    };
</script>
</body>
</html>