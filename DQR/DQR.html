<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>Dungeon Quiz RPG</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; touch-action: manipulation; }
        .view { display: none; }
        .view.active { display: flex; }

        /* RPG ìŠ¤íƒ€ì¼ ì¹´ë“œ */
        .hero-card { transition: all 0.2s; border: 3px solid #e2e8f0; }
        .hero-card.selected { border-color: #3b82f6; background-color: #eff6ff; transform: scale(1.02); box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5); }
        .hero-card:active { transform: scale(0.98); }

        .pixel-art { image-rendering: pixelated; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes damageShake { 0% { transform: translateX(0); } 20% { transform: translateX(-6px) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } 40% { transform: translateX(6px) rotate(5deg); } 60% { transform: translateX(-3px); } 80% { transform: translateX(3px); } }
        .animate-damage { animation: damageShake 0.4s ease-in-out; }
        .animate-attack-player { animation: attackRight 0.2s ease-out; }
        .animate-attack-enemy { animation: attackLeft 0.2s ease-out; }
        @keyframes attackRight { 0% { transform: translateX(0) scaleX(1); } 50% { transform: translateX(30px) scaleX(1); } 100% { transform: translateX(0) scaleX(1); } }
        @keyframes attackLeft { 0% { transform: translateX(0); } 50% { transform: translateX(-30px); } 100% { transform: translateX(0); } }

        .btn-cooldown { background-color: #f1f5f9 !important; border-color: #cbd5e1 !important; color: #94a3b8 !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .skill-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }

        .modal-backdrop { background: rgba(0,0,0,0.85); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-slate-900 min-h-screen text-slate-800 select-none">

<section id="titleScreen" class="view active flex-col items-center justify-center p-6 h-screen bg-slate-900 relative overflow-hidden">
    <div class="absolute inset-0 opacity-20 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
    <div class="z-10 text-center">
        <h1 class="text-5xl md:text-6xl font-black text-white tracking-tighter mb-2 drop-shadow-lg">
            <span class="text-blue-500">Quiz</span> Dungeon
        </h1>
        <div class="text-slate-400 text-xs font-bold mb-8 tracking-widest">RPG EDITION v9.0</div>

        <div class="bg-slate-800 p-8 rounded-3xl shadow-2xl border-4 border-slate-700 max-w-sm mx-auto">
            <div class="flex justify-center gap-4 mb-6">
                <img src="./knight.png" class="w-16 h-16 pixel-art animate-bounce" style="animation-delay: 0s">
                <img src="./wizard.png" class="w-16 h-16 pixel-art animate-bounce" style="animation-delay: 0.1s">
                <img src="./rogue-male.png" class="w-16 h-16 pixel-art animate-bounce" style="animation-delay: 0.2s">
            </div>
            <p id="loadingStatus" class="text-blue-400 text-xs font-bold mb-4 animate-pulse">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘...</p>
            <button id="startButton" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl shadow-lg text-lg transition-all border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 disabled:bg-slate-600 disabled:border-slate-700 disabled:cursor-not-allowed" disabled>
                ë˜ì „ ì…ì¥
            </button>
        </div>
        <p class="text-slate-600 text-[10px] mt-8">Local Save: v90_data</p>
    </div>
</section>

<section id="lobbyScreen" class="view flex-col items-center justify-start p-4 min-h-screen bg-slate-100">
    <div class="w-full max-w-md flex flex-col gap-4 mt-2 h-full">
        <div class="flex justify-between items-end px-2">
            <h2 class="text-3xl font-black text-slate-800">VILLAGE</h2>
            <div class="bg-yellow-50 px-4 py-1.5 rounded-full shadow-sm border border-yellow-200 text-sm font-bold flex items-center gap-2">
                <span class="text-yellow-600">ğŸ’°</span><span id="lobbyGold">0</span> G
            </div>
        </div>

        <div class="bg-white rounded-2xl p-5 shadow-lg border-2 border-slate-200 relative overflow-hidden group">
            <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/exp-candy-xl.png" class="w-24 h-24 pixel-art grayscale">
            </div>
            <div class="relative z-10 flex justify-between items-center">
                <div>
                    <div class="text-[10px] font-bold text-slate-400 mb-1 tracking-wider uppercase" id="lobbyClassLabel">CLASS</div>
                    <div id="lobbyHeroName" class="font-black text-2xl text-slate-800">Novice</div>
                    <div class="text-xs text-blue-600 font-bold mt-1 bg-blue-50 inline-block px-2 py-1 rounded">
                        Lv.<span id="lobbyHeroLevel">1</span>
                    </div>
                </div>
                <div class="relative">
                    <img id="lobbyHeroImg" src="" class="w-20 h-20 pixel-art drop-shadow-md">
                </div>
            </div>
            <div class="mt-4 w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                <div id="lobbyXpBar" class="h-full bg-blue-500 w-0 transition-all duration-500"></div>
            </div>
            <div class="text-[9px] text-right text-slate-400 mt-1">NEXT LEVEL</div>
        </div>

        <div class="grid grid-cols-2 gap-3 mt-2">
            <button id="btnEnterDungeon" class="col-span-2 bg-gradient-to-r from-slate-800 to-slate-700 text-white p-5 rounded-2xl shadow-lg border-b-4 border-slate-900 active:border-b-0 active:translate-y-1 transition-all flex items-center justify-between group">
                <div class="text-left">
                    <div class="font-bold text-xl">ë˜ì „ ì…ì¥</div>
                    <div class="text-xs text-slate-400 group-hover:text-white transition-colors">ëª¬ìŠ¤í„° í† ë²Œ & ê²½í—˜ì¹˜ íšë“</div>
                </div>
                <span class="text-3xl group-hover:scale-110 transition-transform">âš”ï¸</span>
            </button>

            <button id="btnTraining" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 hover:bg-blue-50 transition-colors flex flex-col items-center gap-2">
                <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-xl">ğŸ›¡ï¸</div>
                <div class="text-center">
                    <div class="font-bold text-slate-700">í›ˆë ¨ì†Œ</div>
                    <div class="text-[10px] text-slate-400">ìŠ¤í‚¬ ê°•í™”</div>
                </div>
            </button>

            <button id="btnChangeClass" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 hover:bg-green-50 transition-colors flex flex-col items-center gap-2">
                <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-xl">ğŸ”„</div>
                <div class="text-center">
                    <div class="font-bold text-slate-700">ì „ì§</div>
                    <div class="text-[10px] text-slate-400">í´ë˜ìŠ¤ ë³€ê²½</div>
                </div>
            </button>

            <button id="btnGhost" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 hover:bg-purple-50 transition-colors flex flex-col items-center gap-2">
                <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center text-xl">ğŸ‘»</div>
                <div class="text-center">
                    <div class="font-bold text-slate-700">ê³ ìŠ¤íŠ¸</div>
                    <div class="text-[10px] text-slate-400">QR ëŒ€ì „</div>
                </div>
            </button>

            <button id="btnHoF" class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-slate-200 active:border-b-0 active:translate-y-1 hover:bg-yellow-50 transition-colors flex flex-col items-center gap-2">
                <div class="w-10 h-10 bg-yellow-100 rounded-full flex items-center justify-center text-xl">ğŸ†</div>
                <div class="text-center">
                    <div class="font-bold text-slate-700">ê¸°ë¡ì‹¤</div>
                    <div class="text-[10px] text-slate-400">ëª…ì˜ˆì˜ ì „ë‹¹</div>
                </div>
            </button>
        </div>
    </div>
</section>

<section id="classSelectScreen" class="view flex-col items-center justify-center p-6 h-screen bg-slate-50">
    <h2 class="text-2xl font-black text-slate-800 mb-6">í´ë˜ìŠ¤ ì„ íƒ</h2>
    <div class="grid grid-cols-1 gap-4 w-full max-w-sm" id="classCardGrid">
    </div>
    <button id="btnCancelClassSelect" class="mt-6 text-slate-400 text-sm font-bold underline">ëŒì•„ê°€ê¸°</button>
</section>

<section id="battleScreen" class="view flex-col items-center justify-between h-screen bg-slate-800 relative overflow-hidden">
    <div class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/dark-matter.png')] opacity-30"></div>

    <div class="w-full max-w-md p-4 flex justify-between items-start z-10">
        <button id="battleGiveUpBtn" class="bg-white/10 backdrop-blur text-white/80 px-3 py-1.5 rounded-full text-xs font-bold border border-white/20 hover:bg-white/20">ğŸ³ï¸ í¬ê¸°</button>
        <div class="bg-black/50 backdrop-blur text-yellow-400 px-4 py-1.5 rounded-full text-xs font-bold border border-yellow-400/30 shadow-[0_0_10px_rgba(250,204,21,0.3)]">
            STAGE <span id="battleStageText" class="text-base ml-1 text-white">1</span>
        </div>
    </div>

    <div class="w-full max-w-md flex-1 relative flex flex-col justify-center px-4 z-10 gap-12">
        <div class="flex flex-col items-end relative">
            <div class="bg-slate-900/80 p-3 rounded-xl border border-slate-600 mb-2 w-40 backdrop-blur-md transform translate-x-2">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="enemyName" class="font-bold text-sm text-red-400">Slime</span>
                    <span id="enemyLevel" class="text-[10px] text-slate-400">Lv.1</span>
                </div>
                <div class="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                    <div id="enemyHpBar" class="h-full bg-red-500 transition-all duration-500" style="width: 100%"></div>
                </div>
            </div>
            <div class="relative">
                <img id="enemyImg" src="./slime-green.png" class="w-32 h-32 pixel-art animate-bounce" style="animation-duration: 2s">
            </div>
        </div>

        <div class="flex flex-col items-start relative -mt-8">
            <div class="relative z-10">
                <img id="playerImg" src="./knight.png" class="w-40 h-40 pixel-art drop-shadow-2xl">
            </div>
            <div class="bg-slate-900/80 p-4 rounded-xl border border-blue-500/50 w-48 -mt-6 z-20 transform -translate-x-2 backdrop-blur-md shadow-lg">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="playerName" class="font-bold text-sm text-blue-300">Player</span>
                    <span id="playerLevel" class="text-[10px] text-slate-400">Lv.1</span>
                </div>
                <div class="flex justify-between text-[10px] text-slate-400 mb-1">
                    <span>HP</span> <span id="playerHpText">100/100</span>
                </div>
                <div class="w-full h-2.5 bg-slate-700 rounded-full overflow-hidden mb-1">
                    <div id="playerHpBar" class="h-full bg-blue-500 transition-all duration-500" style="width: 100%"></div>
                </div>
                <div id="playerShieldBar" class="w-full h-1 bg-transparent overflow-hidden">
                    <div class="h-full bg-yellow-400 w-0 transition-all"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-md bg-slate-900 border-t border-slate-700 p-4 z-20 pb-8">
        <div id="battleLog" class="text-xs text-slate-400 mb-3 h-5 overflow-hidden text-center truncate font-mono">
            ì „íˆ¬ ì‹œì‘!
        </div>
        <div id="skillGrid" class="grid grid-cols-2 gap-2">
        </div>
    </div>
</section>

<div id="trainingModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden flex flex-col max-h-[80vh]">
        <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
            <h3 class="font-bold text-lg">ğŸ›¡ï¸ ìŠ¤í‚¬ í›ˆë ¨ì†Œ</h3>
            <button id="closeTrainingBtn" class="text-white/80 hover:text-white">âœ•</button>
        </div>
        <div class="p-4 bg-slate-50 border-b flex justify-between items-center">
            <span class="text-xs text-slate-500">ë³´ìœ  ê³¨ë“œ</span>
            <span class="font-bold text-yellow-600 text-lg">ğŸ’° <span id="trainingGold">0</span></span>
        </div>
        <div id="trainingList" class="p-4 overflow-y-auto space-y-3 flex-1">
        </div>
    </div>
</div>

<div id="quizModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[60] p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
        <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
            <h3 class="font-bold text-lg">ğŸ“ í€´ì¦ˆ</h3>
            <span class="text-xs bg-blue-600 px-2 py-1 rounded font-bold">ì •ë‹µ ì‹œ ìŠ¤í‚¬ ë°œë™</span>
        </div>
        <div class="p-6">
            <div class="text-center mb-4">
                <p class="text-xs text-slate-500 mb-2" id="quizExplain">ë¬¸ì œ ì„¤ëª…</p>
                <p class="text-2xl font-black text-slate-800 tracking-tight" id="quizQuestion">3 x 3 = ?</p>
            </div>
            <div id="quizChoices" class="grid grid-cols-1 gap-2"></div>
        </div>
        <div class="bg-slate-50 p-3 text-center border-t">
            <button id="quizCancel" class="text-xs text-slate-400 underline hover:text-red-500">í¬ê¸° (í„´ ë„˜ê¸°ê¸°)</button>
        </div>
    </div>
</div>

<div id="rewardModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[70] p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-xs p-6 text-center animate-[bounce_0.5s]">
        <h3 class="text-3xl font-black text-slate-800 mb-2">VICTORY!</h3>
        <div class="my-4">
            <div class="text-sm text-slate-500">íšë“ ê²½í—˜ì¹˜</div>
            <div class="text-2xl font-bold text-blue-600">+<span id="rewardXpVal">0</span> EXP</div>
        </div>
        <div id="rewardGoldSection" class="my-2 hidden">
            <div class="text-sm text-slate-500">ë³´ìŠ¤ ë³´ìƒ</div>
            <div class="text-xl font-bold text-yellow-500">+<span id="rewardGoldVal">0</span> G</div>
        </div>
        <button id="rewardOkBtn" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold shadow-lg mt-4">ë‹¤ìŒ ìŠ¤í…Œì´ì§€</button>
    </div>
</div>

<div id="ghostModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[55] p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col overflow-hidden">
        <div class="flex justify-between items-center px-4 py-3 border-b border-slate-200">
            <h3 class="text-lg font-bold text-slate-800">ğŸ‘» ê³ ìŠ¤íŠ¸ ë°°í‹€</h3>
            <button id="ghostClose" class="text-slate-400 text-xs font-bold">ë‹«ê¸°</button>
        </div>
        <div class="flex gap-2 px-4 pt-3">
            <button id="ghostTabMyBtn" class="flex-1 text-xs font-bold rounded-full px-3 py-2 bg-slate-800 text-white">ë‚´ QR ê³µìœ </button>
            <button id="ghostTabScanBtn" class="flex-1 text-xs font-bold rounded-full px-3 py-2 bg-slate-100 text-slate-500">ìŠ¤ìº”í•´ì„œ ë„ì „</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 space-y-4 text-slate-800 text-sm">
            <div id="ghostMyPane">
                <div class="bg-slate-50 rounded-2xl border border-slate-200 flex flex-col items-center justify-center py-4">
                    <canvas id="ghostQrCanvas" class="bg-white rounded-xl p-2 mb-2"></canvas>
                    <p id="ghostMySummary" class="text-xs font-bold text-slate-700"></p>
                </div>
            </div>
            <div id="ghostScanPane" class="hidden">
                <div class="bg-black rounded-2xl overflow-hidden mb-2 relative">
                    <video id="ghostVideo" class="w-full h-48 object-cover bg-black"></video>
                    <div class="absolute inset-0 border-2 border-blue-500/50 flex items-center justify-center"><div class="w-32 h-32 border-2 border-blue-400"></div></div>
                </div>
                <p id="ghostScanStatus" class="text-xs text-center text-slate-500">ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...</p>
                <div class="flex gap-2 mt-2">
                    <button id="ghostScanStartBtn" class="flex-1 py-2 rounded-xl bg-blue-600 text-white text-xs font-bold">ìŠ¤ìº” ì‹œì‘</button>
                    <button id="ghostScanStopBtn" class="flex-1 py-2 rounded-xl bg-slate-200 text-slate-600 text-xs font-bold">ì¤‘ì§€</button>
                </div>
                <canvas id="ghostScanCanvas" class="hidden"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    /* =========================================
     * 1. DATA DEFINITIONS (DB)
     * ========================================= */

    // í´ë˜ìŠ¤ ì •ì˜ (3ì¢…)
    const HERO_DEFINITIONS = {
        "knight": {
            id: "knight", name: "Knight", nameKo: "ê¸°ì‚¬",
            baseStats: { hp: 120, atk: 12, def: 8, spd: 5 },
            sprites: { default: "./knight.png", skin: "./knight-black.png" },
            skills: [
                { id: "k1", name: "ë² ê¸°", type: "atk", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
                { id: "k2", name: "ë°©íŒ¨ ê°€ê²©", type: "atk_stun", power: 1.2, cd: 2, desc: "ê°•í•œ íƒ€ê²© + ì  í–‰ë™ ì§€ì—°" },
                { id: "k3", name: "ì² ë²½", type: "buff_def", power: 0, cd: 3, desc: "ë‹¤ìŒ í„´ ë°©ì–´ë ¥ 2ë°°" },
                { id: "k4", name: "í™€ë¦¬ í¬ë¡œìŠ¤", type: "atk_heal", power: 2.5, cd: 5, desc: "í° í”¼í•´ + ì²´ë ¥ íšŒë³µ" }
            ]
        },
        "rogue": {
            id: "rogue", name: "Rogue", nameKo: "ë„ì ",
            baseStats: { hp: 80, atk: 18, def: 4, spd: 10 },
            sprites: { default: "./rogue-male.png", skin: "./rogue-female.png" },
            skills: [
                { id: "r1", name: "ë‹¨ê²€ íˆ¬ì²™", type: "atk", power: 1.0, cd: 0, desc: "ë¹ ë¥¸ ê³µê²©" },
                { id: "r2", name: "ê¸‰ì†Œ ì°Œë¥´ê¸°", type: "atk_crit", power: 1.5, cd: 2, desc: "ë°©ì–´ ê´€í†µ í”¼í•´" },
                { id: "r3", name: "ë… ë°”ë¥´ê¸°", type: "buff_atk", power: 0, cd: 3, desc: "3í„´ê°„ ê³µê²©ë ¥ ì¦ê°€" },
                { id: "r4", name: "ì•”ì‚´", type: "atk_execute", power: 3.0, cd: 5, desc: "ì²´ë ¥ì´ ë‚®ì€ ì ì—ê²Œ ì¹˜ëª…ì " }
            ]
        },
        "mage": {
            id: "mage", name: "Mage", nameKo: "ë§ˆë²•ì‚¬",
            baseStats: { hp: 70, atk: 22, def: 3, spd: 6 },
            sprites: { default: "./wizard.png", skin: "./wizard.png" }, // ë§ˆë²•ì‚¬ëŠ” ë‹¨ì¼ ìŠ¤í‚¨
            skills: [
                { id: "m1", name: "ë§¤ì§ ë¯¸ì‚¬ì¼", type: "atk", power: 1.0, cd: 0, desc: "ì›ê±°ë¦¬ ê³µê²©" },
                { id: "m2", name: "íŒŒì´ì–´ë³¼", type: "atk_aoe", power: 1.8, cd: 3, desc: "ê°•ë ¥í•œ í™”ì—¼ í”¼í•´" },
                { id: "m3", name: "ë§ˆë‚˜ ì‰´ë“œ", type: "buff_shield", power: 0, cd: 4, desc: "ì„ì‹œ ë³´í˜¸ë§‰ ìƒì„±" },
                { id: "m4", name: "ë©”í…Œì˜¤", type: "atk_ult", power: 4.0, cd: 6, desc: "ì´ˆëŒ€í˜• ìš´ì„ ì†Œí™˜" }
            ]
        }
    };

    // ì  ì •ì˜ (ìŠ¬ë¼ì„ 4ì¢…)
    const ENEMY_VARIANTS = [
        { id: "slime_g", name: "Green Slime", src: "./slime-green.png", type: "nature" },
        { id: "slime_b", name: "Blue Slime", src: "./slime-blue.png", type: "water" },
        { id: "slime_r", name: "Red Slime", src: "./slime-red.png", type: "fire" },
        { id: "slime_p", name: "Purple Slime", src: "./slime-purple.png", type: "poison" }
    ];

    /* =========================================
     * 2. STATE MANAGEMENT & LOCAL STORAGE
     * ========================================= */
    const LS_KEYS = {
        DATA: "qz_rpg_v90_data", // í†µí•© ë°ì´í„°
        HOF: "qz_rpg_v90_hof"
    };

    // ê¸°ë³¸ ê²Œì„ ìƒíƒœ
    let gameState = {
        gold: 0,
        unlockedClasses: ["knight", "rogue", "mage"],
        heroes: {
            "knight": { level: 1, xp: 0, skillLevels: [1, 1, 1, 1], skin: "default" },
            "rogue": { level: 1, xp: 0, skillLevels: [1, 1, 1, 1], skin: "default" },
            "mage": { level: 1, xp: 0, skillLevels: [1, 1, 1, 1], skin: "default" }
        },
        selectedClass: "knight"
    };

    let battleState = null;
    let externalQuizList = [];
    let quizCallback = null;

    // ë°ì´í„° ë¡œë“œ/ì €ì¥
    function loadGameData() {
        const raw = localStorage.getItem(LS_KEYS.DATA);
        if (raw) {
            try {
                const loaded = JSON.parse(raw);
                // ë³‘í•© (ìƒˆë¡œìš´ í•„ë“œ ì¶”ê°€ ëŒ€ë¹„)
                gameState = { ...gameState, ...loaded, heroes: { ...gameState.heroes, ...loaded.heroes } };
            } catch (e) { console.error("Save load error", e); }
        }
    }

    function saveGameData() {
        localStorage.setItem(LS_KEYS.DATA, JSON.stringify(gameState));
        updateLobbyUI();
    }

    function getHeroStats(classId, levelOverride = null) {
        const heroData = gameState.heroes[classId];
        const def = HERO_DEFINITIONS[classId];
        const level = levelOverride || heroData.level;
        const base = def.baseStats;

        // RPG ìŠ¤íƒ¯ ê³µì‹: Base + (Lv * Multiplier)
        return {
            maxHp: Math.floor(base.hp + (level * 10)),
            atk: Math.floor(base.atk + (level * 1.5)),
            def: Math.floor(base.def + (level * 0.8)),
            spd: Math.floor(base.spd + (level * 0.5))
        };
    }

    /* =========================================
     * 3. UI FUNCTIONS (LOBBY & SELECT)
     * ========================================= */
    function updateLobbyUI() {
        const curClass = gameState.selectedClass;
        const heroData = gameState.heroes[curClass];
        const def = HERO_DEFINITIONS[curClass];

        document.getElementById("lobbyGold").textContent = gameState.gold.toLocaleString();

        // ì¹´ë“œ ì •ë³´ ì—…ë°ì´íŠ¸
        document.getElementById("lobbyClassLabel").textContent = def.name;
        document.getElementById("lobbyHeroName").textContent = def.nameKo;
        document.getElementById("lobbyHeroLevel").textContent = heroData.level;

        const imgSrc = heroData.skin === "skin" ? def.sprites.skin : def.sprites.default;
        document.getElementById("lobbyHeroImg").src = imgSrc;

        // ê²½í—˜ì¹˜ ë°”
        const reqXp = heroData.level * 100;
        const pct = Math.min(100, (heroData.xp / reqXp) * 100);
        document.getElementById("lobbyXpBar").style.width = `${pct}%`;
    }

    function renderClassSelect() {
        const grid = document.getElementById("classCardGrid");
        grid.innerHTML = "";

        Object.keys(HERO_DEFINITIONS).forEach(key => {
            const def = HERO_DEFINITIONS[key];
            const myData = gameState.heroes[key];

            const card = document.createElement("div");
            card.className = `hero-card bg-white p-4 rounded-xl flex items-center gap-4 cursor-pointer ${gameState.selectedClass === key ? 'selected' : ''}`;
            card.onclick = () => {
                gameState.selectedClass = key;
                saveGameData();
                renderClassSelect(); // ì¬ë Œë”ë§ìœ¼ë¡œ ì„ íƒ í‘œì‹œ ì—…ë°ì´íŠ¸
            };

            const imgSrc = myData.skin === "skin" ? def.sprites.skin : def.sprites.default;

            card.innerHTML = `
                <img src="${imgSrc}" class="w-16 h-16 pixel-art bg-slate-100 rounded-lg">
                <div class="flex-1">
                    <div class="font-bold text-lg text-slate-800">${def.nameKo} <span class="text-xs text-slate-400">Lv.${myData.level}</span></div>
                    <div class="text-xs text-slate-500 mt-1">
                        HP:${def.baseStats.hp} ATK:${def.baseStats.atk}
                    </div>
                </div>
                ${gameState.selectedClass === key ? '<div class="text-blue-500 font-bold text-xl">âœ“</div>' : ''}
            `;
            grid.appendChild(card);
        });
    }

    function toggleSkin(classId) {
        const h = gameState.heroes[classId];
        h.skin = (h.skin === "default") ? "skin" : "default";
        saveGameData();
        updateLobbyUI();
    }

    /* =========================================
     * 4. TRAINING SYSTEM (SKILL UPGRADE)
     * ========================================= */
    function openTraining() {
        const cid = gameState.selectedClass;
        const hero = gameState.heroes[cid];
        const def = HERO_DEFINITIONS[cid];

        document.getElementById("trainingGold").textContent = gameState.gold;
        const list = document.getElementById("trainingList");
        list.innerHTML = "";

        // ìƒë‹¨ ìŠ¤í‚¨ ë³€ê²½ ë²„íŠ¼ (ë³´ë„ˆìŠ¤ ê¸°ëŠ¥)
        const skinBtn = document.createElement("button");
        skinBtn.className = "w-full py-2 mb-4 bg-purple-100 text-purple-700 font-bold rounded-lg text-xs border border-purple-200";
        skinBtn.textContent = `ğŸ¨ ìŠ¤í‚¨ ë³€ê²½ (${hero.skin === 'default' ? 'ê¸°ë³¸' : 'ì–´ë‚˜ë”'})`;
        skinBtn.onclick = () => { toggleSkin(cid); openTraining(); };
        list.appendChild(skinBtn);

        def.skills.forEach((skill, idx) => {
            const lv = hero.skillLevels[idx];
            const cost = lv * 100; // ê°•í™” ë¹„ìš©: ë ˆë²¨ * 100G

            const row = document.createElement("div");
            row.className = "bg-white border border-slate-200 rounded-xl p-3 flex justify-between items-center shadow-sm";
            row.innerHTML = `
                <div>
                    <div class="font-bold text-sm text-slate-800">${skill.name} <span class="text-blue-500 text-xs">Lv.${lv}</span></div>
                    <div class="text-[10px] text-slate-500">${skill.desc}</div>
                </div>
                <button class="px-3 py-1.5 bg-yellow-500 hover:bg-yellow-400 text-white text-xs font-bold rounded-lg shadow-sm active:scale-95 disabled:bg-slate-300 disabled:text-slate-500" 
                    id="btnTrain_${idx}">
                    âš¡ ${cost} G
                </button>
            `;

            const btn = row.querySelector(`#btnTrain_${idx}`);
            if (gameState.gold < cost) btn.disabled = true;

            btn.onclick = () => {
                if (gameState.gold >= cost) {
                    gameState.gold -= cost;
                    hero.skillLevels[idx]++;
                    saveGameData();
                    openTraining(); // Refresh
                }
            };

            list.appendChild(row);
        });

        document.getElementById("trainingModal").classList.remove("hidden");
        document.getElementById("trainingModal").classList.add("flex");
    }

    /* =========================================
     * 5. BATTLE SYSTEM
     * ========================================= */
    function startDungeon() {
        const cid = gameState.selectedClass;
        const hData = gameState.heroes[cid];
        const def = HERO_DEFINITIONS[cid];
        const stats = getHeroStats(cid);

        const imgSrc = hData.skin === "skin" ? def.sprites.skin : def.sprites.default;

        battleState = {
            mode: "dungeon",
            stage: 1,
            player: {
                ...stats,
                maxHp: stats.maxHp,
                hp: stats.maxHp,
                skills: def.skills,
                skillLevels: hData.skillLevels,
                name: def.nameKo,
                img: imgSrc,
                classId: cid
            },
            enemy: null,
            cooldowns: [0, 0, 0, 0]
        };

        // UI ì „í™˜
        document.getElementById("lobbyScreen").classList.remove("active");
        document.getElementById("battleScreen").classList.add("active");

        startBattleStage();
    }

    function startBattleStage() {
        const bs = battleState;

        // ì  ìƒì„± (ëœë¤ ìŠ¬ë¼ì„)
        const variant = ENEMY_VARIANTS[Math.floor(Math.random() * ENEMY_VARIANTS.length)];
        const isBoss = (bs.stage % 5 === 0);

        // ì  ìŠ¤íƒ¯ ìŠ¤ì¼€ì¼ë§
        const stageMult = 1 + (bs.stage * 0.2);
        const bossMult = isBoss ? 2.5 : 1.0;

        bs.enemy = {
            name: variant.name + (isBoss ? " (BOSS)" : ""),
            maxHp: Math.floor(60 * stageMult * bossMult),
            hp: Math.floor(60 * stageMult * bossMult),
            atk: Math.floor(8 * stageMult * bossMult * 0.7), // í”Œë ˆì´ì–´ë³´ë‹¤ ì¡°ê¸ˆ ì•½í•˜ê²Œ
            img: variant.src,
            isBoss: isBoss
        };

        // UI ì—…ë°ì´íŠ¸
        document.getElementById("battleStageText").textContent = bs.stage;
        document.getElementById("enemyName").textContent = bs.enemy.name;
        document.getElementById("enemyLevel").textContent = `Lv.${bs.stage}`;
        document.getElementById("enemyImg").src = bs.enemy.img;
        if (isBoss) document.getElementById("enemyImg").style.transform = "scale(1.5)";
        else document.getElementById("enemyImg").style.transform = "scale(1)";

        updateBattleUI();
        logBattle(`${bs.enemy.name} ì¶œí˜„!`);
    }

    function updateBattleUI() {
        const p = battleState.player;
        const e = battleState.enemy;

        // Player UI
        document.getElementById("playerImg").src = p.img;
        document.getElementById("playerName").textContent = p.name;
        document.getElementById("playerHpText").textContent = `${p.hp}/${p.maxHp}`;
        document.getElementById("playerHpBar").style.width = `${Math.max(0, (p.hp/p.maxHp)*100)}%`;

        // Enemy UI
        document.getElementById("enemyHpBar").style.width = `${Math.max(0, (e.hp/e.maxHp)*100)}%`;

        renderSkillButtons();
    }

    function renderSkillButtons() {
        const grid = document.getElementById("skillGrid");
        grid.innerHTML = "";

        battleState.player.skills.forEach((skill, idx) => {
            const cd = battleState.cooldowns[idx];
            const lv = battleState.player.skillLevels[idx];

            const btn = document.createElement("button");
            btn.className = `p-3 rounded-lg border-2 text-left relative overflow-hidden transition-all ${cd > 0 ? 'bg-slate-700 border-slate-600 text-slate-500 cursor-not-allowed' : 'bg-slate-800 border-blue-500 text-white hover:bg-slate-700 active:scale-95'}`;

            btn.innerHTML = `
                <div class="font-bold text-sm">${skill.name} <span class="text-[10px] text-yellow-400">Lv.${lv}</span></div>
                <div class="text-[10px] opacity-70 truncate">${skill.desc}</div>
                ${cd > 0 ? `<div class="absolute inset-0 bg-black/50 flex items-center justify-center font-bold text-xl text-white">${cd}</div>` : ''}
            `;

            if (cd === 0) {
                btn.onclick = () => handlePlayerMove(idx);
            }
            grid.appendChild(btn);
        });
    }

    function logBattle(msg) {
        document.getElementById("battleLog").textContent = msg;
    }

    // ì „íˆ¬ ë¡œì§
    function handlePlayerMove(skillIdx) {
        openQuiz((isCorrect) => {
            if (!isCorrect) {
                logBattle("í€´ì¦ˆ ì˜¤ë‹µ! í„´ì„ ë„˜ê¹ë‹ˆë‹¤.");
                setTimeout(enemyTurn, 800);
                return;
            }

            const p = battleState.player;
            const skill = p.skills[skillIdx];
            const slv = p.skillLevels[skillIdx];

            // ì¿¨ë‹¤ìš´ ì„¤ì •
            battleState.cooldowns[skillIdx] = skill.cd + 1; // +1ì€ ì´ë²ˆ í„´ ê°ì†Œ ê³ ë ¤

            // ë°ë¯¸ì§€ ê³„ì‚° (ê¸°ë³¸ê³µê²©ë ¥ + ìŠ¤í‚¬ê³„ìˆ˜ + ë ˆë²¨ë³´ì •)
            // ìŠ¤í‚¬ ë ˆë²¨ 1ë‹¹ ë°ë¯¸ì§€ 10% ì¦ê°€
            let dmg = Math.floor(p.atk * skill.power * (1 + (slv * 0.1)));

            // ìŠ¤í‚¬ íƒ€ì…ë³„ íš¨ê³¼
            if (skill.type.includes("crit") && Math.random() < 0.3) dmg = Math.floor(dmg * 1.5);
            if (skill.type.includes("heal")) {
                const heal = Math.floor(p.maxHp * 0.2);
                p.hp = Math.min(p.maxHp, p.hp + heal);
                logBattle(`${skill.name}! ${dmg}í”¼í•´ ë° ${heal}íšŒë³µ`);
            } else {
                logBattle(`${skill.name}! ${dmg}ì˜ í”¼í•´!`);
            }

            battleState.enemy.hp -= dmg;

            // ì• ë‹ˆë©”ì´ì…˜
            const eImg = document.getElementById("enemyImg");
            eImg.classList.add("animate-damage");
            setTimeout(() => eImg.classList.remove("animate-damage"), 400);

            updateBattleUI();

            if (battleState.enemy.hp <= 0) {
                setTimeout(winStage, 600);
            } else {
                setTimeout(enemyTurn, 800);
            }
        });
    }

    function enemyTurn() {
        if (!battleState || battleState.enemy.hp <= 0) return;

        const p = battleState.player;
        const e = battleState.enemy;

        let dmg = Math.max(1, e.atk - Math.floor(p.def * 0.5));
        p.hp -= dmg;

        logBattle(`${e.name}ì˜ ê³µê²©! ${dmg} í”¼í•´.`);

        const pImg = document.getElementById("playerImg");
        pImg.classList.add("animate-damage");
        setTimeout(() => pImg.classList.remove("animate-damage"), 400);

        // ì¿¨ë‹¤ìš´ ê°ì†Œ
        battleState.cooldowns = battleState.cooldowns.map(c => Math.max(0, c - 1));

        updateBattleUI();

        if (p.hp <= 0) {
            setTimeout(() => {
                alert(`íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤... ìµœì¢… ìŠ¤í…Œì´ì§€: ${battleState.stage}`);
                document.getElementById("battleScreen").classList.remove("active");
                document.getElementById("lobbyScreen").classList.add("active");
            }, 600);
        }
    }

    function winStage() {
        const bs = battleState;
        const xpGain = 10 + (bs.stage * 5);
        let goldGain = 0;

        // ë³´ìŠ¤ ë³´ìƒ
        if (bs.enemy.isBoss) {
            goldGain = 50 + (bs.stage * 10);
        }

        // ë°ì´í„° ë°˜ì˜
        const hData = gameState.heroes[gameState.selectedClass];
        hData.xp += xpGain;
        gameState.gold += goldGain;

        // ë ˆë²¨ì—… ì²´í¬
        let leveledUp = false;
        while (hData.xp >= hData.level * 100) {
            hData.xp -= hData.level * 100;
            hData.level++;
            leveledUp = true;
        }
        saveGameData();

        // UI í‘œì‹œ
        document.getElementById("rewardXpVal").textContent = xpGain + (leveledUp ? " (LEVEL UP!)" : "");

        if (goldGain > 0) {
            document.getElementById("rewardGoldVal").textContent = goldGain;
            document.getElementById("rewardGoldSection").classList.remove("hidden");
        } else {
            document.getElementById("rewardGoldSection").classList.add("hidden");
        }

        document.getElementById("rewardModal").classList.remove("hidden");

        // ë‹¤ìŒ ìŠ¤í…Œì´ì§€ ì¤€ë¹„ (ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰ë  í•¨ìˆ˜ëŠ” ì´ë¯¸ ì—°ê²°ë¨)
        document.getElementById("rewardOkBtn").onclick = () => {
            document.getElementById("rewardModal").classList.add("hidden");

            // í”Œë ˆì´ì–´ ìŠ¤íƒ¯ ê°±ì‹  (ë ˆë²¨ì—… ë°˜ì˜ ë° ì†Œí­ íšŒë³µ)
            const newStats = getHeroStats(hData.classId || gameState.selectedClass);
            bs.player.maxHp = newStats.maxHp;
            bs.player.atk = newStats.atk;
            bs.player.def = newStats.def; // ë“±ë“±...

            // ìŠ¤í…Œì´ì§€ í´ë¦¬ì–´ ì‹œ 30% íšŒë³µ
            bs.player.hp = Math.min(bs.player.maxHp, bs.player.hp + Math.floor(bs.player.maxHp * 0.3));

            bs.stage++;
            startBattleStage();
        };
    }

    /* =========================================
     * 6. QUIZ LOGIC (Internal & External)
     * ========================================= */
    async function loadQuizData() {
        try {
            const res = await fetch("./quiz/quiz.json");
            if (res.ok) {
                const data = await res.json();
                if (data.questions) externalQuizList = data.questions;
            }
        } catch (e) { console.log("Quiz load failed, using Math fallback."); }

        document.getElementById("startButton").disabled = false;
        document.getElementById("loadingStatus").textContent = "ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ";
    }

    function openQuiz(cb) {
        quizCallback = cb;
        let q = generateMathQuiz(); // ê¸°ë³¸ êµ¬êµ¬ë‹¨

        if (externalQuizList.length > 0 && Math.random() < 0.7) {
            const raw = externalQuizList[Math.floor(Math.random() * externalQuizList.length)];
            // ë‹¨ìˆœí™” ë§¤í•‘
            q = {
                q: raw.prompt,
                explain: raw.promptExplain || "í€´ì¦ˆ",
                choices: raw.choices,
                answer: raw.choices[raw.answerIndex]
            };
            // ì…”í”Œ ë¡œì§ ìƒëµ (ê°„ê²°í•¨ ìœ„í•´)
        }

        document.getElementById("quizExplain").textContent = q.explain;
        document.getElementById("quizQuestion").textContent = q.q;

        const grid = document.getElementById("quizChoices");
        grid.innerHTML = "";

        q.choices.forEach(c => {
            const btn = document.createElement("button");
            btn.className = "bg-slate-100 hover:bg-blue-100 border-2 border-slate-200 font-bold py-3 rounded-xl text-lg transition-colors";
            btn.textContent = c;
            btn.onclick = () => {
                document.getElementById("quizModal").classList.add("hidden");
                if (quizCallback) quizCallback(c == q.answer);
            };
            grid.appendChild(btn);
        });

        document.getElementById("quizModal").classList.remove("hidden");
    }

    function generateMathQuiz() {
        const a = Math.floor(Math.random() * 8) + 2;
        const b = Math.floor(Math.random() * 9) + 1;
        const ans = a * b;
        const choices = [ans, ans + a, ans - 1, ans + 10].sort(() => Math.random() - 0.5);
        return {
            q: `${a} Ã— ${b} = ?`,
            explain: "êµ¬êµ¬ë‹¨ í€´ì¦ˆ",
            choices: choices,
            answer: ans
        };
    }

    /* =========================================
     * 7. GHOST (QR) SYSTEM
     * ========================================= */
    function openGhostModal() {
        document.getElementById("ghostModal").classList.remove("hidden");
        document.getElementById("ghostModal").classList.add("flex");

        // ë‚´ QR ìƒì„±
        const cid = gameState.selectedClass;
        const hero = gameState.heroes[cid];
        const def = HERO_DEFINITIONS[cid];
        const payload = {
            v: 90,
            cid: cid,
            lv: hero.level,
            slv: hero.skillLevels,
            nm: def.nameKo,
            ts: Date.now()
        };

        const jsonStr = JSON.stringify(payload);
        const encoded = btoa(unescape(encodeURIComponent(jsonStr)));
        const url = `${location.origin}${location.pathname}?ghost=${encoded}`;

        const canvas = document.getElementById("ghostQrCanvas");
        QRCode.toCanvas(canvas, url, { width: 200 }, (err) => {});
        document.getElementById("ghostMySummary").textContent = `${def.nameKo} Lv.${hero.level} (ì „íˆ¬ë ¥ ${hero.level * 100})`;
    }

    // Ghost Scan ë¡œì§ì€ PRL_v2ì™€ ë™ì¼í•˜ê²Œ jsQR ì‚¬ìš© (ìƒëµ ê°€ëŠ¥í•˜ë‚˜ ê¸°ëŠ¥ ìœ ì§€ë¥¼ ìœ„í•´ í¬í•¨)
    // ê°„ë‹¨íˆ: ì¹´ë©”ë¼ ì¼œê³  -> ìŠ¤ìº”ë˜ë©´ -> startGhostBattle(parsedData)

    /* =========================================
     * INIT
     * ========================================= */
    window.onload = () => {
        loadGameData();
        loadQuizData();

        // ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
        document.getElementById("startButton").onclick = () => {
            document.getElementById("titleScreen").classList.remove("active");
            document.getElementById("lobbyScreen").classList.add("active");
            updateLobbyUI();
        };

        document.getElementById("btnEnterDungeon").onclick = startDungeon;

        document.getElementById("btnChangeClass").onclick = () => {
            renderClassSelect();
            document.getElementById("lobbyScreen").classList.remove("active");
            document.getElementById("classSelectScreen").classList.add("active");
        };

        document.getElementById("btnCancelClassSelect").onclick = () => {
            document.getElementById("classSelectScreen").classList.remove("active");
            document.getElementById("lobbyScreen").classList.add("active");
            updateLobbyUI();
        };

        document.getElementById("btnTraining").onclick = openTraining;
        document.getElementById("closeTrainingBtn").onclick = () => document.getElementById("trainingModal").classList.add("hidden");

        document.getElementById("btnGhost").onclick = openGhostModal;
        document.getElementById("ghostClose").onclick = () => document.getElementById("ghostModal").classList.add("hidden");

        document.getElementById("battleGiveUpBtn").onclick = () => {
            if(confirm("ì •ë§ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë³´ìƒ ì—†ìŒ)")) {
                document.getElementById("battleScreen").classList.remove("active");
                document.getElementById("lobbyScreen").classList.add("active");
            }
        };

        document.getElementById("quizCancel").onclick = () => {
            document.getElementById("quizModal").classList.add("hidden");
            if(quizCallback) quizCallback(false);
        };
    };
</script>
</body>
</html>