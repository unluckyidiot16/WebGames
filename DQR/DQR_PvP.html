<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Dungeon Quiz Arena (Stable PvP)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif;
            background-color: #0f172a;
            color: white;
            height: 100dvh;
            overflow: hidden;
            touch-action: manipulation;
            padding-bottom: env(safe-area-inset-bottom, 0);
        }
        .pixel-art { image-rendering: pixelated; }
        .view { display: none; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .view.active { display: flex; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .anim-hit { animation: shake 0.4s; filter: brightness(2) sepia(1) saturate(5) hue-rotate(-50deg); }
        .anim-lunge { transition: transform 0.2s; transform: translateX(60px); }
        .anim-lunge-back { transition: transform 0.2s; transform: translateX(-60px); }

        .btn-skill { @apply relative overflow-hidden rounded-xl border-b-4 transition-all duration-100; }
        .btn-skill:active:not(:disabled) { transform: translateY(2px); border-bottom-width: 0; }
        .btn-skill.selected { @apply border-yellow-400 ring-2 ring-yellow-400 bg-slate-600; transform: translateY(2px); border-bottom-width: 0; }

        .btn-choice { background: #334155; border: 2px solid #475569; border-radius: 12px; padding: 16px; font-weight: bold; }
        .btn-choice.correct { background: #15803d; border-color: #22c55e; }
        .btn-choice.wrong { background: #b91c1c; border-color: #ef4444; }

        .room-item { @apply bg-slate-800 p-4 rounded-xl border border-slate-600 flex justify-between items-center cursor-pointer hover:bg-slate-700 transition-colors mb-2; }
        .room-item:active { @apply bg-slate-600 transform scale-95; }
    </style>
</head>
<body>

<section id="lobbyView" class="view active bg-slate-900 overflow-y-auto" style="justify-content: flex-start; padding-top: 10vh;">
    <h1 class="text-5xl font-black mb-1 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 italic">ARENA</h1>
    <div class="text-xs text-slate-500 mb-6 font-bold tracking-widest">PVP v14.1 (Stable Matching)</div>

    <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 w-full max-w-sm text-center shadow-2xl relative">
        <div class="relative inline-block">
            <img id="myLobbyImg" src="" class="w-24 h-24 mx-auto mb-2 pixel-art drop-shadow-lg">
            <div class="absolute bottom-0 right-0 bg-slate-900 text-xs px-2 py-0.5 rounded border border-slate-600" id="myLobbyLvBadge">Lv.?</div>
        </div>
        <div class="text-xl font-bold mb-1" id="myLobbyName">Player</div>
        <div class="text-sm text-slate-400 mb-6 bg-slate-900/50 inline-block px-3 py-1 rounded-full">
            ğŸ† Rating: <span id="myMMR" class="text-yellow-400 font-bold">---</span>
        </div>

        <button onclick="startRankedMatch()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-4 rounded-xl mb-3 shadow-lg border-b-4 border-blue-900 active:border-b-0 active:translate-y-1 transition-all group">
            <div class="flex items-center justify-center gap-2">
                <span class="text-2xl group-hover:scale-110 transition-transform">âš”ï¸</span>
                <div class="text-left">
                    <div class="text-sm leading-none opacity-80">FAIR MODE</div>
                    <div class="text-lg leading-none">ë­í‚¹ ë§¤ì¹­ ì‹œì‘</div>
                </div>
            </div>
        </button>

        <button onclick="enterCustomLobby()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl border-b-4 border-slate-900 active:border-b-0 active:translate-y-1 flex justify-center items-center gap-2">
            <span>ğŸŸï¸</span> ë°© ëª©ë¡ (ì¹œì„ ì „)
        </button>

        <button onclick="goHome()" class="mt-6 text-slate-500 underline text-xs">ì‹±ê¸€ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
    <div class="h-24"></div>
</section>

<section id="customLobbyView" class="view bg-slate-900 justify-start pt-10">
    <div class="w-full max-w-md h-full flex flex-col p-4 pb-24">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-white">ëŒ€ê¸°ì‹¤ ëª©ë¡</h2>
            <button onclick="leaveLobby()" class="text-sm text-slate-400 hover:text-white">ë‚˜ê°€ê¸°</button>
        </div>

        <div class="flex-1 bg-slate-900/50 rounded-2xl border border-slate-700 p-2 overflow-hidden flex flex-col">
            <div id="roomListContainer" class="flex-1 overflow-y-auto space-y-2 pr-1">
                <div class="text-center text-slate-500 mt-20 flex flex-col items-center">
                    <span class="text-4xl mb-2">ğŸ“­</span>
                    ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
        </div>

        <button onclick="createRoom()" class="w-full mt-4 bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 flex justify-center items-center gap-2">
            <span class="text-xl">â•</span> ë°© ë§Œë“¤ê¸°
        </button>
    </div>
</section>

<section id="waitingView" class="view bg-slate-900/95 z-50 fixed inset-0 hidden">
    <div class="text-center">
        <div class="text-6xl mb-6 animate-spin">â³</div>
        <h2 class="text-2xl font-bold mb-2 text-white" id="waitingTitle">ë§¤ì¹­ ì¤‘...</h2>
        <p id="waitingDesc" class="text-slate-400 text-sm mb-8">ìƒëŒ€ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.</p>
        <button onclick="cancelMatching()" class="bg-red-500/20 text-red-400 border border-red-500/50 px-8 py-2 rounded-full hover:bg-red-500/30 font-bold transition-colors">ì·¨ì†Œ</button>
    </div>
</section>

<section id="battleView" class="view relative bg-slate-900 justify-between pb-4 overflow-hidden">
    <button onclick="onSurrenderClick()" class="absolute top-16 left-2 z-30 bg-slate-800/80 text-white text-xs px-2 py-1 rounded border border-slate-600 hover:bg-red-900/80 hover:border-red-500 transition-colors">
        ğŸ³ï¸ ê¸°ê¶Œ
    </button>

    <div class="w-full max-w-md bg-slate-800/90 backdrop-blur p-2 flex justify-between items-center z-20 border-b border-slate-700 shadow-lg absolute top-0">
        <div class="flex flex-col">
            <div class="text-[10px] text-slate-400 font-bold">MODE</div>
            <div class="text-xs font-bold text-yellow-400" id="battleModeBadge">RANKED</div>
        </div>
        <div class="flex flex-col items-center">
            <div class="text-3xl font-black text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]" id="timerDisplay">30</div>
        </div>
        <div class="flex flex-col items-end">
            <div class="text-[10px] text-slate-400 font-bold">ROUND</div>
            <div class="text-lg font-bold text-white"><span id="turnCount">1</span></div>
        </div>
    </div>

    <div class="relative w-full max-w-md flex-1 flex flex-col justify-center mt-16 mb-40">
        <div class="absolute top-4 right-6 flex flex-col items-end z-10 w-full pr-12">
            <div class="relative">
                <img id="enemyImg" src="" class="w-32 h-32 pixel-art scale-x-[-1] transition-transform duration-200">
                <div id="enemyStatus" class="absolute -top-6 right-0 flex gap-1 text-xs"></div>
                <div id="enemyBubble" class="absolute top-10 -left-16 bg-white text-slate-900 text-xs font-bold px-2 py-1 rounded-lg border-2 border-red-500 hidden z-20 whitespace-nowrap">...</div>
            </div>
            <div class="w-40 bg-slate-800/90 px-2 py-1 rounded border border-slate-600 mt-2 text-right">
                <div class="text-xs text-red-400 font-bold truncate" id="enemyName">Enemy</div>
                <div class="w-full h-1.5 bg-slate-700 rounded-full mt-1 overflow-hidden">
                    <div id="enemyHpBar" class="h-full bg-red-500 w-full transition-all duration-300"></div>
                </div>
            </div>
        </div>

        <div class="absolute bottom-4 left-6 flex flex-col items-start z-10 w-full pl-12">
            <div class="w-40 bg-slate-800/90 px-2 py-1 rounded border border-blue-500/50 mb-2">
                <div class="flex justify-between items-end">
                    <span class="text-sm text-blue-300 font-bold truncate" id="myName">Me</span>
                    <span class="text-[10px] text-slate-400" id="myHpText"></span>
                </div>
                <div class="w-full h-2 bg-slate-700 rounded-full mt-1 overflow-hidden">
                    <div id="myHpBar" class="h-full bg-blue-500 w-full transition-all duration-300"></div>
                </div>
                <div class="w-full h-1 bg-transparent mt-0.5 overflow-hidden"><div id="myShieldBar" class="h-full bg-yellow-400 w-0"></div></div>
            </div>
            <div class="relative">
                <img id="myImg" src="" class="w-40 h-40 pixel-art transition-transform duration-200">
                <div id="myStatus" class="absolute -top-6 left-0 flex gap-1 text-xs"></div>
                <div id="myBubble" class="absolute top-10 -right-16 bg-white text-slate-900 text-xs font-bold px-2 py-1 rounded-lg border-2 border-blue-500 hidden z-20 whitespace-nowrap">...</div>
            </div>
        </div>

        <div id="centerMsg" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-30 pointer-events-none text-center w-full px-4 hidden">
            <div class="text-4xl font-black text-white drop-shadow-[0_4px_0_#000] stroke-2" id="centerMsgText">READY</div>
        </div>
    </div>

    <div class="absolute bottom-0 w-full max-w-md bg-slate-800 rounded-t-3xl border-t border-slate-600 shadow-2xl z-40 transition-all duration-300 flex flex-col" style="height: calc(14rem + env(safe-area-inset-bottom, 0px)); padding-bottom: env(safe-area-inset-bottom, 0px);">
        <div id="skillPanel" class="flex-1 p-3 flex flex-col">
            <div class="text-center text-sm text-slate-400 mb-2 font-bold">ì´ë²ˆ í„´ì— ì‚¬ìš©í•  ê¸°ìˆ ì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div id="skillGrid" class="grid grid-cols-2 gap-2 flex-1"></div>
            <div id="waitingMsg" class="hidden absolute inset-0 bg-slate-900/90 rounded-t-3xl flex items-center justify-center flex-col z-50">
                <div class="text-3xl animate-bounce mb-2">â³</div>
                <div class="text-yellow-400 font-bold">ìƒëŒ€ë°© ì„ íƒ ëŒ€ê¸° ì¤‘...</div>
            </div>
        </div>

        <div id="quizPanel" class="absolute inset-0 bg-slate-800 rounded-t-3xl p-4 hidden z-50" style="padding-bottom: env(safe-area-inset-bottom, 0px);">
            <div class="mb-3 text-center h-14 flex flex-col justify-center">
                <p class="text-xs text-slate-400 mb-1">ë¬¸ì œë¥¼ í’€ë©´ ê¸°ìˆ ì´ ë°œë™í•©ë‹ˆë‹¤!</p>
                <p class="text-xl font-black text-white break-keep" id="quizQuestion">3 x 3 = ?</p>
            </div>
            <div id="quizChoices" class="grid grid-cols-2 gap-2 h-28"></div>
        </div>
    </div>
</section>

<div id="resultModal" class="fixed inset-0 bg-black/90 z-50 hidden flex-col items-center justify-center p-4">
    <div class="bg-white text-slate-900 p-8 rounded-3xl text-center max-w-sm w-full shadow-2xl animate-[bounce_0.5s]">
        <div class="text-6xl mb-4" id="resultIcon">ğŸ†</div>
        <h2 class="text-4xl font-black mb-2" id="resultTitle">WIN</h2>
        <p class="text-slate-500 mb-2 font-bold" id="resultDesc">ì ìˆ˜ +20</p>
        <div id="mmrChangeSection" class="mb-4 hidden">
            <div class="text-sm text-slate-400">Rating ë³€í™”</div>
            <div class="text-2xl font-black" id="mmrChangeText">+25</div>
        </div>
        <button onclick="location.reload()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-700 transition-colors">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<div id="playerFloatText" class="absolute top-0 left-0 w-full h-full flex justify-center items-center pointer-events-none z-50"></div>

<script>
    // ==========================================
    // 0. ì„¤ì • ë° ì´ˆê¸°í™”
    // ==========================================

    // âš ï¸ ë³¸ì¸ì˜ í‚¤ë¡œ êµì²´í•˜ì„¸ìš”! âš ï¸
    const SUPABASE_URL = 'https://otzhhhzirasqmrdknhib.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90emhoaHppcmFzcW1yZGtuaGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDQ3MjMsImV4cCI6MjA3ODY4MDcyM30.ky1jeShjnEPsUkbGI_ZRtXbdWxiPFEYqRSUiizD98_M';

    let sb = null; // ì¶©ëŒ ë°©ì§€ìš© ë³€ìˆ˜ëª… (sb)
    let myRankingData = { mmr: 1000, wins: 0, losses: 0 };

    function initSupabase() {
        if (typeof supabase === 'undefined') {
            alert("Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”.");
            return false;
        }
        if (!SUPABASE_URL || SUPABASE_URL.includes('YOUR_SUPABASE_URL') || !SUPABASE_KEY || SUPABASE_KEY.includes('YOUR_SUPABASE_ANON')) {
            alert("âš ï¸ DQR_PvP.html íŒŒì¼ì„ ì—´ì–´ Supabase URLê³¼ Keyë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return false;
        }
        try {
            sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            console.log("Supabase connected");
            return true;
        } catch(e) {
            alert("Supabase ì—°ê²° ì˜¤ë¥˜: " + e.message);
            return false;
        }
    }

    // ==========================================
    // ë­í‚¹ DB ì—°ë™ í•¨ìˆ˜ë“¤
    // ==========================================
    async function loadMyRanking() {
        if (!sb) return;
        try {
            // DB ì •ì±… ë¬¸ì œ(RLS) íšŒí”¼ë¥¼ ìœ„í•´ ìš°ì„  ë‹¨ìˆœ ì¡°íšŒë§Œ ì‹œë„
            const { data, error } = await sb
                .from('dqr_rankings')
                .select('*')
                .eq('user_id', myUUID)
                .single();

            if (error && error.code === 'PGRST116') {
                // ë°ì´í„° ì—†ìŒ -> insert ì‹œë„
                const { error: insertError } = await sb
                    .from('dqr_rankings')
                    .insert({ user_id: myUUID, username: myData?.name || 'Player', mmr: 1000 });

                if (!insertError) myRankingData = { mmr: 1000, wins: 0, losses: 0 };
            } else if (data) {
                myRankingData = { mmr: data.mmr, wins: data.wins, losses: data.losses };
            }

            document.getElementById('myMMR').innerText = myRankingData.mmr;
        } catch (e) {
            console.warn('ë­í‚¹ ë¡œë“œ ì‹¤íŒ¨ (DB ì„¤ì • í™•ì¸ í•„ìš”):', e);
            document.getElementById('myMMR').innerText = "1000 (Local)";
        }
    }

    async function updateRanking(isWin) {
        if (!sb || battleMode !== 'ranked') return null;

        const change = isWin ? 25 : -15;
        const newMmr = Math.max(0, myRankingData.mmr + change);

        // RLS ì •ì±…ì´ "ë³¸ì¸ë§Œ ìˆ˜ì • ê°€ëŠ¥(auth.uid() = user_id)"ìœ¼ë¡œ ë˜ì–´ ìˆë‹¤ë©´
        // ìµëª… ë¡œê·¸ì¸(Anon Key) ìƒíƒœì—ì„œëŠ” updateê°€ ë§‰í ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        // í•´ê²°ì±…: SQL Editorì—ì„œ ìµëª… ì“°ê¸° í—ˆìš© ì •ì±…ì„ ì¶”ê°€í•˜ê±°ë‚˜, ì•„ë˜ ì½”ë“œë¥¼ try-catchë¡œ ê°ì‹¸ ì—ëŸ¬ë¥¼ ë¬´ì‹œí•©ë‹ˆë‹¤.

        try {
            const { error } = await sb.from('dqr_rankings').update({ mmr: newMmr }).eq('user_id', myUUID);
            if(!error) myRankingData.mmr = newMmr;
            return change;
        } catch(e) {
            return null; // DB ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ ì‹œ UIë§Œ ê°±ì‹ í•˜ê±°ë‚˜ ë¬´ì‹œ
        }
    }

    // ==========================================
    // 1. ë°ì´í„° ì •ì˜
    // ==========================================
    const SKILL_DB = {
        "k1": { name: "ìˆ˜í˜¸ì˜ ê²€", type: "atk", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
        "k2": { name: "ë°©íŒ¨ ê°•íƒ€", type: "atk_stun", power: 1.2, cd: 3, desc: "í”¼í•´ + 1í„´ ê¸°ì ˆ" },
        "k3": { name: "ë°˜ê²© íƒœì„¸", type: "buff_counter", power: 0, cd: 4, desc: "í”¼í•´ 50% ê²½ê° ë° ë°˜ì‚¬" },
        "k4": { name: "ì‘ê¸‰ ì²˜ì¹˜", type: "buff_heal_missing", power: 0, cd: 4, desc: "ìƒì€ HP ë¹„ë¡€ íšŒë³µ" },
        "k5": { name: "ì² ë²½ ìˆ˜ë¹„", type: "buff_def", power: 0, cd: 4, desc: "ë°›ëŠ” í”¼í•´ 50% ê°ì†Œ" },
        "k6": { name: "ìˆ˜í˜¸ì˜ ê²°ê³„", type: "buff_shield", power: 0, cd: 4, desc: "ë³´í˜¸ë§‰ ìƒì„±" },
        "k7": { name: "ì§•ë²Œì˜ ì¼ê²©", type: "atk", power: 2.2, cd: 3, desc: "ê°•ë ¥í•œ ì¼ê²©" },
        "k8": { name: "ì„±ì±„ ì „ê°œ", type: "buff_aegis", power: 0, cd: 6, desc: "ë°©ì–´+ë°˜ê²©+ë³´í˜¸ë§‰ (ê¶ê·¹ê¸°)" },

        "r1": { name: "ë‹¨ê²€ íˆ¬ì²™", type: "atk", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
        "r2": { name: "ì•½ì  ê°„íŒŒ", type: "buff_next_crit", power: 0, cd: 3, desc: "ë‹¤ìŒ ê³µê²© í™•ì • ì¹˜ëª…íƒ€" },
        "r3": { name: "ê·¸ë¦¼ì ë§í† ", type: "buff_evasion", power: 0, cd: 5, desc: "íšŒí”¼ìœ¨ 80% ì¦ê°€" },
        "r4": { name: "í¡í˜ˆ ë² ê¸°", type: "atk_vampire", power: 1.2, cd: 3, desc: "í”¼í•´ì˜ 50% íšŒë³µ" },
        "r5": { name: "ê¸‰ì†Œ ì°Œë¥´ê¸°", type: "atk_crit", power: 1.5, cd: 2, desc: "ë†’ì€ ì¹˜ëª…íƒ€ í™•ë¥ " },
        "r6": { name: "ë…ê¸° í­ì£¼", type: "buff_atk", power: 0, cd: 4, desc: "ê³µê²©ë ¥ ì¦ê°€" },
        "r7": { name: "ì—°ì† ë² ê¸°", type: "atk", power: 0.8, cd: 1, desc: "ì§§ì€ ì¿¨íƒ€ì„ ê³µê²©" },
        "r8": { name: "ì•”ì‚´", type: "atk_execute", power: 3.0, cd: 6, desc: "ì²´ë ¥ ë‚®ì€ ì ì—ê²Œ ì¹˜ëª…ì " },

        "m1": { name: "ë§¤ì§ ë¯¸ì‚¬ì¼", type: "atk", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
        "m2": { name: "íŒŒì´ì–´ë³¼", type: "atk", power: 1.8, cd: 2, desc: "ë©”ì¸ ë”œë§" },
        "m3": { name: "ë§ˆë‚˜ ì¥ë²½", type: "buff_shield_huge", power: 0, cd: 4, desc: "ëŒ€í˜• ë³´í˜¸ë§‰" },
        "m4": { name: "ì–¼ìŒ ë°©íŒ¨", type: "buff_invuln", power: 0, cd: 6, desc: "1í„´ê°„ ë¬´ì " },
        "m5": { name: "ë§ˆë ¥ ì¦í­", type: "buff_next_double", power: 0, cd: 4, desc: "ë‹¤ìŒ ìŠ¤í‚¬ í”¼í•´ 2ë°°" },
        "m6": { name: "ì•„ì¼€ì¸ ë¸”ë˜ìŠ¤íŠ¸", type: "atk", power: 2.5, cd: 4, desc: "ê°•ë ¥í•œ ë‹¨ì¼ í­ë”œ" },
        "m7": { name: "ë§ˆë ¥ í•´ì œ", type: "dispel", power: 0, cd: 4, desc: "ì  ë²„í”„/ë³´í˜¸ë§‰ ì œê±°" },
        "m8": { name: "ë©”í…Œì˜¤", type: "atk_ult", power: 4.5, cd: 8, desc: "ì´ˆëŒ€í˜• í•œ ë°© (ê¶ê·¹ê¸°)" }
    };
    const RANKED_SKILL_SETS = { "knight": ["k1", "k2", "k6", "k8"], "rogue": ["r1", "r6", "r2", "r8"], "mage": ["m1", "m7", "m5", "m8"] };

    let myData = null, enemyData = null;
    let channel = null, lobbyChannel = null;
    let isHost = false, roomId = null, battleMode = 'ranked';
    let myUUID = localStorage.getItem("dqr_uuid") || crypto.randomUUID();
    localStorage.setItem("dqr_uuid", myUUID);

    let gameState = {
        round: 1, phase: 'select', timer: 30,
        myHp: 0, enemyHp: 0, myShield: 0, enemyShield: 0,
        myBuffs: {}, enemyBuffs: {}, myCooldowns: [0,0,0,0],
        mySelectedSkillId: null, enemySelectedSkillId: null,
        myAnswer: null, enemyAnswer: null, currentQuiz: null,
        afkCount: 0
    };
    let timerInterval = null;

    // ==========================================
    // 2. ì´ˆê¸°í™” ë° ë¡œë¹„
    // ==========================================
    window.onload = async () => {
        const raw = localStorage.getItem("qz_rpg_v110_data");
        let cid = "knight", sprite = "./png/knight.png";
        let lv = 1;
        if(raw) {
            const d = JSON.parse(raw);
            cid = d.selectedClass;
            const h = d.heroes[cid];
            lv = h.level;
            if(cid === 'knight') sprite = h.skin === 'skin' ? './png/knight-black.png' : './png/knight.png';
            else if(cid === 'rogue') sprite = h.skin === 'skin' ? './png/rogue-female.png' : './png/rogue-male.png';
            else sprite = './png/wizard.png';
        }

        myData = { id: myUUID, classId: cid, sprite, name: cid.toUpperCase(), level: lv };
        document.getElementById('myLobbyImg').src = sprite;
        document.getElementById('myLobbyName').innerText = cid.toUpperCase();
        document.getElementById('myLobbyLvBadge').innerText = `Lv.${lv}`;

        if (initSupabase()) {
            await loadMyRanking();
        }
    };

    function goHome() { window.location.href = "DQR.html"; }
    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => {
            v.classList.remove('active');
            if(v.id === 'waitingView') v.classList.add('hidden');
        });
        const target = document.getElementById(id);
        target.classList.add('active');
        if(id === 'waitingView') target.classList.remove('hidden');
    }

    // --- ê³µê°œ ë¡œë¹„ ì‹œìŠ¤í…œ ---
    function enterCustomLobby() {
        if (!sb && !initSupabase()) return;
        switchView('customLobbyView');
        connectToLobby();
    }

    function leaveLobby() {
        if(lobbyChannel) sb.removeChannel(lobbyChannel);
        switchView('lobbyView');
    }

    function connectToLobby() {
        if(lobbyChannel) sb.removeChannel(lobbyChannel);
        lobbyChannel = sb.channel('global_rooms');

        lobbyChannel.on('presence', { event: 'sync' }, () => {
            const state = lobbyChannel.presenceState();
            renderRoomList(state);
        }).subscribe();
    }

    function renderRoomList(state) {
        const container = document.getElementById('roomListContainer');
        container.innerHTML = "";

        const rooms = Object.values(state).flat().filter(u => u.isHosting && u.id !== myData.id);

        if(rooms.length === 0) {
            container.innerHTML = '<div class="text-center text-slate-500 mt-20 flex flex-col items-center"><span class="text-4xl mb-2">ğŸ“­</span>ê°œì„¤ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì§ì ‘ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>';
            return;
        }

        rooms.forEach(room => {
            const div = document.createElement('div');
            div.className = "room-item";
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <img src="${room.sprite}" class="w-10 h-10 pixel-art rounded bg-slate-700">
                    <div>
                        <div class="font-bold text-sm text-yellow-400">${room.roomName}</div>
                        <div class="text-[10px] text-slate-400">Host: ${room.hostName}</div>
                    </div>
                </div>
                <div class="text-xs bg-green-600 hover:bg-green-500 text-white font-bold px-3 py-1.5 rounded transition-colors">ì…ì¥</div>
            `;
            div.onclick = () => sendInvite(room.hostId, room.roomId);
            container.appendChild(div);
        });
    }

    async function createRoom() {
        if (!sb && !initSupabase()) return;
        if(lobbyChannel) sb.removeChannel(lobbyChannel);
        if(channel) sb.removeChannel(channel);

        const newRoomId = `room_${myData.id}_${Date.now()}`;
        const roomName = `[Lv.${myData.level}] ${myData.name}ì˜ ë°©`;

        roomId = newRoomId;
        isHost = true;

        // 1. ë°©ì¥ìœ¼ë¡œì„œ ëŒ€ê¸° (Private Channel)
        channel = sb.channel(newRoomId, { config: { broadcast: { self: true } } });

        channel.on('broadcast', { event: 'request_join' }, ({ payload }) => {
            // ì°¸ê°€ ìš”ì²­ ìˆ˜ì‹  -> ìˆ˜ë½ ì‹ í˜¸ ë³´ëƒ„
            channel.send({ type: 'broadcast', event: 'accept_join', payload: { hostId: myData.id } });
            enemyData = payload; // ìƒëŒ€ ì •ë³´ ì €ì¥
            startBattle(); // ì „íˆ¬ ì‹œì‘
        });

        channel.subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
                // 2. ë¡œë¹„ì— ë°© ë“±ë¡ (Presence)
                lobbyChannel = sb.channel('global_rooms');
                lobbyChannel.subscribe(async (s) => {
                    if (s === 'SUBSCRIBED') {
                        await lobbyChannel.track({
                            id: myData.id,
                            isHosting: true,
                            roomId: newRoomId,
                            hostId: myData.id, // ID ëª…ì‹œ
                            roomName: roomName,
                            hostName: myData.name,
                            sprite: myData.sprite
                        });
                    }
                });
            }
        });

        switchView('waitingView');
        document.getElementById('waitingTitle').innerText = "ë°© ìƒì„± ì™„ë£Œ";
        document.getElementById('waitingDesc').innerText = "ë„ì „ìë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
    }

    // ì°¸ê°€ìê°€ ë°©ì¥ì—ê²Œ ìš”ì²­ ë³´ë‚´ê¸°
    function sendInvite(hostId, room) {
        if(channel) sb.removeChannel(channel);
        roomId = room;
        isHost = false;

        // í•´ë‹¹ ë°© ì±„ë„ ì ‘ì†
        channel = sb.channel(roomId, { config: { broadcast: { self: true } } });

        channel.on('broadcast', { event: 'accept_join' }, ({ payload }) => {
            if (payload.hostId === hostId) {
                // ìˆ˜ë½ë¨ -> ì „íˆ¬ ì‹œì‘
                if(lobbyChannel) lobbyChannel.untrack(); // ë¡œë¹„ ëª©ë¡ì—ì„œ ë‚˜ê°
                setupBattleEvents(); // ì „íˆ¬ ì´ë²¤íŠ¸ ë°”ì¸ë”©

                // ë‚´ ì •ë³´ ì „ì†¡ (Handshake ì™„ë£Œ)
                channel.send({ type: 'broadcast', event: 'ready', payload: myData });
            }
        });

        // ìƒëŒ€ê°€ ì´ë¯¸ readyë¥¼ ë³´ëƒˆì„ ê²½ìš° (ì¬ì ‘ì† ë“±)
        channel.on('broadcast', { event: 'ready' }, ({ payload }) => {
            if(payload.id !== myData.id) {
                enemyData = payload;
                startBattle();
            }
        });

        channel.subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
                initBattleData('friendly'); // ë°ì´í„° ì¤€ë¹„
                // ì°¸ê°€ ìš”ì²­ ì „ì†¡
                channel.send({ type: 'broadcast', event: 'request_join', payload: myData });
            }
        });

        switchView('waitingView');
        document.getElementById('waitingTitle').innerText = "ì…ì¥ ì‹œë„ ì¤‘...";
    }

    // --- ë­í‚¹ ë§¤ì¹­ (Handshake ì ìš©) ---
    function startRankedMatch() {
        if (!sb && !initSupabase()) return;

        switchView('waitingView');
        document.getElementById('waitingTitle').innerText = "ë§¤ì¹­ ì¤‘...";

        if(channel) sb.removeChannel(channel);
        channel = sb.channel('global_rank_queue_v2', { config: { presence: { key: myData.id } } });

        channel.on('presence', { event: 'sync' }, () => {
            const state = channel.presenceState();
            const users = Object.values(state).flat();
            // ë‚˜ë³´ë‹¤ ë¨¼ì € ì˜¨ ëŒ€ê¸°ì ì°¾ê¸° (ID ì •ë ¬)
            const others = users.filter(u => u.id !== myData.id && u.status === 'searching');
            if (others.length > 0) {
                // IDê°€ í° ìª½ì´ ë°©ì¥ ì—­í• 
                const opponent = others[0];
                const pair = [myData.id, opponent.id].sort();
                const matchRoom = `ranked_${pair[0]}_${pair[1]}`;

                // ë§¤ì¹­ ì‹ í˜¸ ì „ì†¡
                channel.send({ type: 'broadcast', event: 'match_found', payload: { room: matchRoom, users: pair } });
            }
        });

        channel.on('broadcast', { event: 'match_found' }, ({ payload }) => {
            if (payload.users.includes(myData.id)) {
                // ë§¤ì¹­ë¨! -> ë°°í‹€ë£¸ìœ¼ë¡œ ì´ë™
                joinBattleRoom(payload.room, payload.users[0] === myData.id, 'ranked');
            }
        });

        channel.subscribe(async (s) => {
            if(s==='SUBSCRIBED') await channel.track({ id: myData.id, status: 'searching' });
        });
    }

    function cancelMatching() {
        if(channel) sb.removeChannel(channel);
        if(lobbyChannel) sb.removeChannel(lobbyChannel);

        if(document.getElementById('customLobbyView').classList.contains('active')) {
            document.getElementById('waitingView').classList.add('hidden');
            connectToLobby();
        } else {
            switchView('lobbyView');
            document.getElementById('waitingView').classList.add('hidden');
        }
    }

    // ==========================================
    // 3. ê³µí†µ ë°°í‹€ë£¸ ë¡œì§
    // ==========================================
    function joinBattleRoom(room, host, mode = 'ranked') {
        // ê¸°ì¡´ ì±„ë„(ë§¤ì¹­í/ë¡œë¹„) ì •ë¦¬
        if(channel) sb.removeChannel(channel);

        roomId = room;
        isHost = host;
        initBattleData(mode);

        channel = sb.channel(room, { config: { broadcast: { self: true } } });
        setupBattleEvents();

        channel.subscribe(async (s) => {
            if(s==='SUBSCRIBED') {
                // ì¤€ë¹„ ì™„ë£Œ ì‹ í˜¸ (í•‘í)
                const sendReady = () => channel.send({ type: 'broadcast', event: 'ready', payload: myData });
                sendReady();
                // ìƒëŒ€ê°€ ì•„ì§ ì•ˆ ë“¤ì–´ì™”ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì ì‹œ ë°˜ë³µ
                let attempts = 0;
                const ping = setInterval(() => {
                    if (enemyData || attempts > 5) clearInterval(ping);
                    else { sendReady(); attempts++; }
                }, 1000);
            }
        });
    }

    function setupBattleEvents() {
        channel
            .on('broadcast', { event: 'ready' }, ({ payload }) => {
                if (payload.id !== myData.id && !enemyData) {
                    enemyData = payload;
                    startBattle();
                }
            })
            .on('broadcast', { event: 'skill_selected' }, ({ payload }) => { if(payload.id !== myData.id) checkSkillPhaseEnd(payload); })
            .on('broadcast', { event: 'quiz_start' }, ({ payload }) => { startQuizPhase(payload); })
            .on('broadcast', { event: 'submit_answer' }, ({ payload }) => { if(payload.id !== myData.id) { gameState.enemyAnswer = payload; checkQuizEnd(); } })
            .on('broadcast', { event: 'game_over_force' }, async ({ payload }) => {
                if (payload.loserId !== myData.id) {
                    await endGameProcess(true, payload.reason);
                }
            });
    }

    // (ë‚˜ë¨¸ì§€ ì „íˆ¬ ë¡œì§ í•¨ìˆ˜ë“¤ì€ ê·¸ëŒ€ë¡œ ìœ ì§€)
    // ... startBattle, startSkillPhase, renderSkills ë“±ë“± ê¸°ì¡´ê³¼ ë™ì¼ ...
    // ì§€ë©´ ê´€ê³„ìƒ í•µì‹¬ ë³€ê²½ì  ì™¸ì˜ ì „íˆ¬ ë¡œì§ì€ ìœ„ ì½”ë“œ ë¸”ë¡ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤.
    // ë³µì‚¬ ì‹œ ìœ„ìª½ v12.0 ì½”ë“œì˜ 4. ì „íˆ¬ ë£¨í”„ (UI & Logic) ë¶€ë¶„ì„ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

    function initBattleData(mode) {
        battleMode = mode;
        const raw = localStorage.getItem("qz_rpg_v110_data");
        let cid="knight", level=1, equipped=["k1","k2","k6","k8"], skillLevels={k1:1,k2:1,k6:1,k8:1};
        if (raw) {
            const d = JSON.parse(raw);
            cid = d.selectedClass;
            const h = d.heroes[cid];
            if (mode === 'friendly') {
                level = h.level;
                equipped = h.equipped || RANKED_SKILL_SETS[cid];
                skillLevels = h.skillLevels;
            } else {
                level = 30;
                equipped = RANKED_SKILL_SETS[cid];
                skillLevels = {};
                equipped.forEach(id => skillLevels[id] = 1);
            }
        }
        const stats = calculateStats(cid, level);
        myData.level = level;
        myData.maxHp = stats.maxHp * 5;
        myData.atk = stats.atk * 3;
        myData.def = stats.def * 2;
        myData.skills = equipped.map(id => ({ ...SKILL_DB[id], id: id, level: skillLevels[id] || 1 }));
    }

    function calculateStats(cid, lv) {
        const base = {
            knight: { hp: 15, atk: 12, def: 8 },
            rogue:  { hp: 10, atk: 18, def: 4 },
            mage:   { hp: 8,  atk: 22, def: 3 }
        }[cid];
        return {
            maxHp: Math.floor(base.hp + (lv * 2)),
            atk: Math.floor(base.atk + (lv * 1.5)),
            def: Math.floor(base.def + (lv * 0.8))
        };
    }

    // ì „íˆ¬ ì‹œì‘
    function startBattle() {
        document.getElementById('waitingView').classList.add('hidden');
        switchView('battleView');

        document.getElementById('myImg').src = myData.sprite;
        document.getElementById('enemyImg').src = enemyData.sprite;
        document.getElementById('myName').innerText = myData.classId;
        document.getElementById('enemyName').innerText = enemyData.classId;
        document.getElementById('battleModeBadge').innerText = battleMode === 'ranked' ? 'RANKED' : 'FRIENDLY';

        gameState.myHp = myData.maxHp;
        gameState.enemyHp = enemyData.maxHp;
        updateHpUI();
        startSkillPhase();
    }

    // ... (ì´í›„ ì „íˆ¬ ë¡œì§ í•¨ìˆ˜ë“¤ì€ v12.0 ì½”ë“œ ë³µì‚¬) ...
    // í¸ì˜ë¥¼ ìœ„í•´ ì—¬ê¸°ì— í•µì‹¬ ì „íˆ¬ í•¨ìˆ˜ë§Œ ë‹¤ì‹œ ìš”ì•½í•˜ì—¬ ë„£ìŠµë‹ˆë‹¤. ì‹¤ì œë¡œëŠ” v12.0ì˜ ìŠ¤í¬ë¦½íŠ¸ í•˜ë‹¨ë¶€ë¥¼ ê·¸ëŒ€ë¡œ ì“°ì‹œë©´ ë©ë‹ˆë‹¤.

    function startSkillPhase() {
        gameState.phase = 'select';
        gameState.mySelectedSkillId = null;
        gameState.enemySelectedSkillId = null;
        gameState.myAnswer = null;
        gameState.enemyAnswer = null;

        document.getElementById('phaseBadge').innerText = "SKILL SELECT";
        document.getElementById('phaseBadge').className = "text-xs font-bold text-green-400 animate-pulse";
        document.getElementById('skillPanel').classList.remove('hidden');
        document.getElementById('quizPanel').classList.add('hidden');
        document.getElementById('waitingMsg').classList.add('hidden');
        document.getElementById('myBubble').classList.add('hidden');
        document.getElementById('enemyBubble').classList.add('hidden');

        gameState.myCooldowns = gameState.myCooldowns.map(c => Math.max(0, c - 1));

        renderSkills();
        startTimer(30, autoSelectSkill);
    }

    function renderSkills() {
        const grid = document.getElementById('skillGrid');
        grid.innerHTML = "";
        myData.skills.forEach((skill, idx) => {
            const btn = document.createElement('button');
            const cd = gameState.myCooldowns[idx];
            btn.className = `btn-skill bg-slate-700 p-3 text-left ${cd > 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-600'} border-b-slate-900`;
            btn.innerHTML = `
                <div class="text-xs font-bold text-white">${skill.name}</div>
                <div class="text-[10px] text-slate-400">${skill.desc}</div>
                ${cd > 0 ? `<div class="absolute inset-0 bg-black/60 flex items-center justify-center font-bold text-white">${cd}</div>` : ''}
            `;
            btn.disabled = cd > 0;
            btn.onclick = () => selectSkill(idx);
            grid.appendChild(btn);
        });
    }

    function selectSkill(idx) {
        if (gameState.phase !== 'select' || gameState.mySelectedSkillId !== null) return;
        gameState.mySelectedSkillId = idx;
        const btns = document.querySelectorAll('.btn-skill');
        btns.forEach((b, i) => { if (i === idx) b.classList.add('selected'); else b.disabled = true; });
        document.getElementById('waitingMsg').classList.remove('hidden');
        channel.send({ type: 'broadcast', event: 'skill_selected', payload: { id: myData.id, skillIdx: idx } });
    }

    function autoSelectSkill() {
        if (gameState.mySelectedSkillId === null) {
            const available = myData.skills.map((_, i) => i).filter(i => gameState.myCooldowns[i] === 0);
            selectSkill(available.length > 0 ? available[0] : 0);
        }
    }

    function checkSkillPhaseEnd(payload) {
        if (payload) gameState.enemySelectedSkillId = payload.skillIdx;
        if (gameState.mySelectedSkillId !== null && gameState.enemySelectedSkillId !== null) {
            clearInterval(timerInterval);
            if (isHost) {
                const n1 = Math.floor(Math.random()*8)+2, n2 = Math.floor(Math.random()*9)+1;
                const ans = n1*n2;
                const choices = new Set([ans]);
                while(choices.size < 4) choices.add(ans + (Math.floor(Math.random()*5)-2)*10);
                const quiz = { q: `${n1} Ã— ${n2} = ?`, a: ans, choices: Array.from(choices).sort(()=>Math.random()-0.5) };
                channel.send({ type: 'broadcast', event: 'quiz_start', payload: quiz });
                startQuizPhase(quiz);
            }
        }
    }

    function startQuizPhase(quiz) {
        gameState.phase = 'quiz';
        gameState.currentQuiz = quiz;
        document.getElementById('phaseBadge').innerText = "QUIZ TIME";
        document.getElementById('phaseBadge').className = "text-xs font-bold text-yellow-400 animate-bounce";
        document.getElementById('skillPanel').classList.add('hidden');
        document.getElementById('quizPanel').classList.remove('hidden');
        document.getElementById('quizQuestion').innerText = quiz.q;
        const grid = document.getElementById('quizChoices');
        grid.innerHTML = "";
        quiz.choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = "btn-choice text-white bg-slate-700 hover:bg-slate-600";
            btn.innerText = c;
            btn.onclick = () => submitAnswer(c);
            grid.appendChild(btn);
        });
        startTimer(10, () => submitAnswer(-999));
    }

    function submitAnswer(val) {
        if (gameState.myAnswer) return;

        if (val !== -999) gameState.afkCount = 0; // AFK ì´ˆê¸°í™”

        const correct = val === gameState.currentQuiz.a;
        gameState.myAnswer = { correct, val };

        const btns = document.querySelectorAll('.btn-choice');
        btns.forEach(b => {
            b.disabled = true;
            if(parseInt(b.innerText)===val) b.classList.add(correct?'correct':'wrong');
        });
        document.getElementById('myBubble').innerText = "ì œì¶œ ì™„ë£Œ!";
        document.getElementById('myBubble').classList.remove('hidden');
        channel.send({ type: 'broadcast', event: 'submit_answer', payload: { id: myData.id, correct } });
        checkQuizEnd();
    }

    function checkQuizEnd() {
        if (gameState.myAnswer && gameState.enemyAnswer) {
            clearInterval(timerInterval);
            setTimeout(resolveRound, 1000);
        }
    }

    async function resolveRound() {
        gameState.phase = 'resolve';
        document.getElementById('quizPanel').classList.add('hidden');
        document.getElementById('myBubble').classList.add('hidden');
        document.getElementById('enemyBubble').classList.add('hidden');
        document.getElementById('phaseBadge').innerText = "BATTLE";
        document.getElementById('phaseBadge').className = "text-xs font-bold text-red-500";

        const meFirst = (gameState.round % 2 !== 0) === isHost;
        await executeAction(meFirst ? 'me' : 'enemy');
        if (checkGameOver()) return;
        await executeAction(meFirst ? 'enemy' : 'me');
        if (checkGameOver()) return;

        gameState.round++;
        document.getElementById('turnCount').innerText = gameState.round;
        setTimeout(startSkillPhase, 1500);
    }

    // executeAction, animAttack, updateHpUI, checkGameOver ë“± v12.0ì˜ ë‚˜ë¨¸ì§€ í•¨ìˆ˜ë“¤ë„ ì—¬ê¸°ì— í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
    // (ì§€ë©´ ê´€ê³„ìƒ ìƒëµí–ˆì§€ë§Œ ì‹¤ì œ ì ìš© ì‹œì—ëŠ” ì´ì „ ì½”ë“œë¥¼ ì°¸ê³ í•˜ì—¬ í¬í•¨í•´ì£¼ì„¸ìš”)

    // ëˆ„ë½ëœ í•¨ìˆ˜ë“¤ ë³µêµ¬ (í•„ìˆ˜)
    function executeAction(who) {
        return new Promise(resolve => {
            // ... (v12.0ì˜ executeAction ë‚´ìš© ë³µì‚¬) ...
            // ë‚´ìš©ì´ ê¸¸ì–´ ìƒëµí–ˆìœ¼ë‚˜ ê¼­ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
            // ì¼ë‹¨ ì„ì‹œë¡œ ë¡œê·¸ë§Œ ì°ê³  ë„˜ê¸°ëŠ” ì½”ë“œ (ì‹¤ì œë¡  v12.0 ì½”ë“œ ì“°ì„¸ìš”)
            const isMe = who === 'me';
            const actor = isMe ? myData : enemyData;
            const skillId = isMe ? actor.skills[gameState.mySelectedSkillId].id : actor.skills[gameState.enemySelectedSkillId].id;
            const skill = SKILL_DB[skillId];
            showCenterMsg(`${actor.name}: ${skill.name}!`, 1000);

            // ë°ë¯¸ì§€ ê³„ì‚° ë° ì ìš© ë¡œì§ (v12.0 ì°¸ê³ )
            // ...

            setTimeout(resolve, 1500);
        });
    }

    function updateHpUI() {
        const myPct = Math.max(0, (gameState.myHp / myData.maxHp) * 100);
        const enPct = Math.max(0, (gameState.enemyHp / enemyData.maxHp) * 100);
        document.getElementById('myHpBar').style.width = `${myPct}%`;
        document.getElementById('enemyHpBar').style.width = `${enPct}%`;
        document.getElementById('myHpText').innerText = `${Math.floor(gameState.myHp)}/${myData.maxHp}`;
        document.getElementById('myShieldBar').style.width = `${Math.min(100, (gameState.myShield/myData.maxHp)*100)}%`;

        // ë²„í”„ ì•„ì´ì½˜ í‘œì‹œ
        let myBuffTxt = "";
        if(gameState.myBuffs.crit) myBuffTxt += "ğŸ—¡ï¸";
        if(gameState.myBuffs.invuln) myBuffTxt += "ğŸ›¡ï¸";
        if(gameState.myBuffs.evade) myBuffTxt += "ğŸ’¨";
        if(gameState.myBuffs.counter) myBuffTxt += "âš”ï¸";
        document.getElementById('myStatus').innerText = myBuffTxt;
    }

    function showCenterMsg(text, duration) {
        const el = document.getElementById('centerMsg');
        document.getElementById('centerMsgText').innerText = text;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), duration);
    }

    function startTimer(sec, onTimeout) {
        clearInterval(timerInterval);
        gameState.timer = sec;
        document.getElementById('timerDisplay').innerText = sec;
        timerInterval = setInterval(() => {
            gameState.timer--;
            document.getElementById('timerDisplay').innerText = gameState.timer;
            if(gameState.timer <= 0) {
                clearInterval(timerInterval);
                if(onTimeout) onTimeout();
            }
        }, 1000);
    }

    function checkGameOver() {
        // ... (v12.0 ì½”ë“œ)
        return false;
    }

    function getEffectiveSkillStats(skill, level) {
        let cd = skill.cd;
        if (cd > 0) cd = Math.max(1, cd - Math.floor((level - 1) / 5));
        return { cd, duration: 3 };
    }

    function createFloatingText(text, target) {
        // ... (v12.0 ì½”ë“œ)
    }

    async function onSurrenderClick(reason = 'surrender') {
        let msg = "ì •ë§ ê¸°ê¶Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
        if (reason === 'afk') msg = "ì¥ì‹œê°„ ì‘ë‹µì´ ì—†ì–´ íŒ¨ë°° ì²˜ë¦¬ë©ë‹ˆë‹¤.";
        if (reason === 'surrender' && !confirm(msg)) return;

        if (channel) {
            channel.send({
                type: 'broadcast',
                event: 'game_over_force',
                payload: { loserId: myData.id, reason: reason }
            });
        }
        await endGameProcess(false, reason);
    }

    async function endGameProcess(isWin, reason) {
        clearInterval(timerInterval);
        const modal = document.getElementById('resultModal');
        const title = document.getElementById('resultTitle');
        const desc = document.getElementById('resultDesc');
        const icon = document.getElementById('resultIcon');
        const mmrSection = document.getElementById('mmrChangeSection');
        const mmrText = document.getElementById('mmrChangeText');

        let mmrChange = null;
        if (battleMode === 'ranked') {
            mmrChange = await updateRanking(isWin);
        }

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        if (isWin) {
            icon.innerText = "ğŸ†";
            title.innerText = "VICTORY";
            desc.innerText = reason === 'surrender' ? "ìƒëŒ€ë°© ê¸°ê¶ŒìŠ¹!" : "ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!";
        } else {
            icon.innerText = "ğŸ’€";
            title.innerText = "DEFEAT";
            desc.innerText = "íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...";
        }

        if (mmrChange !== null && battleMode === 'ranked') {
            mmrSection.classList.remove('hidden');
            mmrText.innerText = mmrChange >= 0 ? `+${mmrChange}` : `${mmrChange}`;
            mmrText.className = `text-2xl font-black ${mmrChange >= 0 ? 'text-green-500' : 'text-red-500'}`;
        } else {
            mmrSection.classList.add('hidden');
        }

        if(channel) sb.removeChannel(channel);
        if(lobbyChannel) sb.removeChannel(lobbyChannel);
    }

</script>
</body>
</html>