<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Dungeon Quiz Arena (PvP)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif; background-color: #1e293b; color: white; height: 100vh; overflow: hidden; touch-action: manipulation; }
        .pixel-art { image-rendering: pixelated; }
        .view { display: none; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .view.active { display: flex; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes damageShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .anim-damage { animation: damageShake 0.4s; }
        .btn-skill { transition: all 0.1s; border-bottom: 4px solid #00000030; }
        .btn-skill:active { transform: translateY(2px); border-bottom: 0; }
        .btn-skill:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; transform: none; border-bottom: 4px solid #00000030; }
    </style>
</head>
<body>

<section id="lobbyView" class="view active">
    <h1 class="text-4xl font-black mb-2 text-yellow-400 italic">ARENA</h1>
    <div class="bg-slate-800 p-6 rounded-2xl border border-slate-600 w-full max-w-sm text-center shadow-xl">
        <img id="myLobbyImg" src="" class="w-24 h-24 mx-auto mb-2 pixel-art">
        <div class="text-xl font-bold mb-1" id="myLobbyName">Player</div>
        <div class="text-sm text-slate-400 mb-6">Rating: <span id="myMMR" class="text-yellow-400 font-bold">---</span></div>

        <button onclick="startRankedMatch()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl mb-3 shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1">
            âš”ï¸ ë­í‚¹ ë§¤ì¹­ (ëœë¤)
        </button>

        <div class="grid grid-cols-2 gap-2">
            <button onclick="showCustomRoomUI('create')" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 rounded-xl border-b-4 border-slate-800 active:border-b-0 active:translate-y-1">
                ë°© ë§Œë“¤ê¸°
            </button>
            <button onclick="showCustomRoomUI('join')" class="bg-slate-600 hover:bg-slate-500 text-white font-bold py-3 rounded-xl border-b-4 border-slate-800 active:border-b-0 active:translate-y-1">
                ë°© ì°¸ê°€
            </button>
        </div>

        <button onclick="goHome()" class="mt-6 text-slate-500 underline text-sm">ëŒì•„ê°€ê¸°</button>
    </div>
</section>

<section id="matchingView" class="view">
    <div class="text-6xl mb-6 animate-bounce">ğŸ”</div>
    <h2 class="text-2xl font-bold mb-2">ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘...</h2>
    <p id="matchingStatus" class="text-slate-400 text-sm mb-8">ëŒ€ê¸°ì—´ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

    <div id="roomCodeDisplay" class="hidden bg-black/30 px-6 py-3 rounded-xl mb-8 border border-white/10">
        <div class="text-xs text-slate-400 mb-1">ROOM CODE</div>
        <div class="text-3xl font-mono font-bold tracking-widest text-yellow-400" id="roomCodeText">----</div>
    </div>

    <div id="roomJoinInput" class="hidden w-full max-w-xs mb-4">
        <input type="text" id="inputRoomCode" placeholder="ì½”ë“œ 4ìë¦¬ ì…ë ¥" maxlength="4" class="w-full text-center text-2xl p-3 rounded-xl bg-slate-700 text-white border-2 border-slate-500 focus:border-blue-500 outline-none font-mono uppercase">
        <button onclick="joinCustomRoom()" class="w-full mt-2 bg-green-600 py-3 rounded-xl font-bold">ì…ì¥í•˜ê¸°</button>
    </div>

    <button onclick="cancelMatching()" class="bg-red-500/20 text-red-400 border border-red-500/50 px-6 py-2 rounded-full hover:bg-red-500/30">ì·¨ì†Œ</button>
</section>

<section id="battleView" class="view relative bg-slate-900">
    <div class="absolute top-10 flex flex-col items-center w-full">
        <div class="relative">
            <img id="enemyImg" src="" class="w-32 h-32 pixel-art brightness-75 scale-x-[-1]"> <div class="absolute -top-8 left-1/2 -translate-x-1/2 bg-slate-800/80 px-3 py-1 rounded-lg border border-slate-600 text-center w-40">
            <div class="text-xs text-red-400 font-bold" id="enemyName">Opponent</div>
            <div class="w-full h-2 bg-slate-700 rounded-full mt-1 overflow-hidden">
                <div id="enemyHpBar" class="h-full bg-red-500 w-full transition-all duration-300"></div>
            </div>
        </div>
        </div>
    </div>

    <div id="battleMsg" class="z-20 text-yellow-400 font-black text-2xl drop-shadow-md animate-pulse">VS</div>

    <div class="absolute bottom-40 flex flex-col items-center w-full">
        <div class="relative">
            <img id="myImg" src="" class="w-40 h-40 pixel-art drop-shadow-2xl">
            <div class="absolute -top-10 left-1/2 -translate-x-1/2 bg-slate-800/80 px-4 py-2 rounded-xl border border-blue-500/50 text-center w-48">
                <div class="flex justify-between items-end mb-1">
                    <span class="text-sm text-blue-300 font-bold" id="myName">Me</span>
                    <span class="text-xs text-slate-400" id="myHpText">100/100</span>
                </div>
                <div class="w-full h-3 bg-slate-700 rounded-full overflow-hidden">
                    <div id="myHpBar" class="h-full bg-blue-500 w-full transition-all duration-300"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="absolute bottom-0 w-full bg-slate-800 border-t-4 border-slate-700 p-4 pb-8">
        <div class="text-center text-sm text-slate-400 mb-2" id="turnIndicator">ëŒ€ê¸° ì¤‘...</div>
        <div id="skillGrid" class="grid grid-cols-2 gap-2 max-w-md mx-auto">
        </div>
    </div>
</section>

<div id="resultModal" class="fixed inset-0 bg-black/80 z-50 hidden flex-col items-center justify-center">
    <div class="bg-white text-slate-900 p-8 rounded-2xl text-center max-w-sm w-full mx-4 shadow-2xl transform scale-100 transition-transform">
        <div class="text-6xl mb-4" id="resultIcon">ğŸ†</div>
        <h2 class="text-4xl font-black mb-2" id="resultTitle">VICTORY</h2>
        <p class="text-slate-500 mb-6" id="resultDesc">ë­í‚¹ ì ìˆ˜ +10</p>
        <button onclick="location.reload()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold text-lg">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<script>
    // ==========================================
    // 0. ì„¤ì • ë° ë°ì´í„°
    // ==========================================
    const SUPABASE_URL = 'https://otzhhhzirasqmrdknhib.supabase.co'; // âš ï¸ êµì²´ í•„ìš”
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90emhoaHppcmFzcW1yZGtuaGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDQ3MjMsImV4cCI6MjA3ODY4MDcyM30.ky1jeShjnEPsUkbGI_ZRtXbdWxiPFEYqRSUiizD98_M'; // âš ï¸ êµì²´ í•„ìš”
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // DQR.htmlê³¼ ë™ì¼í•œ ì˜ì›… ë°ì´í„° (ì¶•ì•½ë¨)
    const HERO_DEFINITIONS = {
        "knight": { sprites: { default: "./png/knight.png" }, skills: [
                { id: "k1", name: "ë² ê¸°", power: 1.0, cd: 0 }, { id: "k2", name: "ë°©íŒ¨ ê°€ê²©", power: 1.2, cd: 2 },
                { id: "k3", name: "ì² ë²½", power: 0, cd: 3, type: 'buff' }, { id: "k4", name: "í™€ë¦¬ í¬ë¡œìŠ¤", power: 2.5, cd: 5 }
            ]},
        "rogue": { sprites: { default: "./png/rogue-male.png" }, skills: [
                { id: "r1", name: "ë‹¨ê²€ íˆ¬ì²™", power: 1.0, cd: 0 }, { id: "r2", name: "ê¸‰ì†Œ ì°Œë¥´ê¸°", power: 1.5, cd: 2 },
                { id: "r3", name: "ë… ë°”ë¥´ê¸°", power: 0, cd: 3, type: 'buff' }, { id: "r4", name: "ì•”ì‚´", power: 3.0, cd: 5 }
            ]},
        "mage": { sprites: { default: "./png/wizard.png" }, skills: [
                { id: "m1", name: "ë§¤ì§ ë¯¸ì‚¬ì¼", power: 1.0, cd: 0 }, { id: "m2", name: "íŒŒì´ì–´ë³¼", power: 1.8, cd: 3 },
                { id: "m3", name: "ë§ˆë‚˜ ì‰´ë“œ", power: 0, cd: 4, type: 'buff' }, { id: "m4", name: "ë©”í…Œì˜¤", power: 4.0, cd: 6 }
            ]}
    };

    let myData = null;
    let enemyData = null;
    let channel = null;
    let battleState = { myTurn: false, myHp: 0, enemyHp: 0, cooldowns: [0,0,0,0] };
    let myUUID = crypto.randomUUID(); // ì„¸ì…˜ìš© ì„ì‹œ ID

    // ==========================================
    // 1. ì´ˆê¸°í™” ë° ë¡œì»¬ ë°ì´í„° ë¡œë“œ
    // ==========================================
    window.onload = async () => {
        loadMyData();
        await fetchMyRanking(); // ë­í‚¹ ì ìˆ˜ ë¡œë“œ
        renderLobby();
    };

    function loadMyData() {
        const raw = localStorage.getItem("qz_rpg_v105_data"); // ìµœì‹  ë²„ì „ í‚¤ ì‚¬ìš©
        if (raw) {
            const d = JSON.parse(raw);
            const cid = d.selectedClass;
            const hero = d.heroes[cid];
            myData = {
                id: myUUID,
                name: "í”Œë ˆì´ì–´", // ì´ë¦„ ì €ì¥ ê¸°ëŠ¥ì´ ì—†ì–´ì„œ ê³ ì •
                classId: cid,
                level: hero.level,
                // ìŠ¤íƒ¯ ê°„ì†Œí™” ê³„ì‚°
                maxHp: Math.floor(15 + hero.level * 2), // v10.5 ë°¸ëŸ°ìŠ¤ ê¸°ì¤€
                atk: Math.floor(12 + hero.level * 1.5),
                def: Math.floor(8 + hero.level * 0.8),
                sprite: HERO_DEFINITIONS[cid].sprites.default,
                skills: HERO_DEFINITIONS[cid].skills // ì‹¤ì œë¡œëŠ” equipped ë°°ì—´ì„ ì°¸ì¡°í•´ì•¼ í•¨ (ê°„ì†Œí™”)
            };
        } else {
            // ë°ì´í„° ì—†ìœ¼ë©´ í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸
            myData = { id: myUUID, name: "Guest", classId: "knight", level: 1, maxHp: 20, atk: 15, def: 5, sprite: "./png/knight.png", skills: HERO_DEFINITIONS.knight.skills };
        }

        // PvP ë°¸ëŸ°ìŠ¤ ë³´ì • (ì²´ë ¥ 5ë°°)
        myData.maxHp *= 5;
    }

    async function fetchMyRanking() {
        // user_idëŠ” ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì— ì˜êµ¬ ì €ì¥ëœ IDë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ìƒì„±
        let permId = localStorage.getItem("dqr_user_id");
        if (!permId) { permId = crypto.randomUUID(); localStorage.setItem("dqr_user_id", permId); }
        myData.permId = permId;

        const { data, error } = await supabase.from('dqr_rankings').select('mmr').eq('user_id', permId).single();
        if (data) {
            myData.mmr = data.mmr;
        } else {
            // ì‹ ê·œ ìœ ì € ë“±ë¡
            await supabase.from('dqr_rankings').insert({ user_id: permId, username: myData.classId, mmr: 1000 });
            myData.mmr = 1000;
        }
        document.getElementById('myMMR').innerText = myData.mmr;
    }

    function renderLobby() {
        document.getElementById('myLobbyImg').src = myData.sprite;
        document.getElementById('myLobbyName').innerText = `${myData.classId.toUpperCase()} (Lv.${myData.level})`;
    }

    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function goHome() { window.location.href = "DQR.html"; }

    // ==========================================
    // 2. ë§¤ì¹­ ì‹œìŠ¤í…œ (ë­í‚¹ / ì»¤ìŠ¤í…€)
    // ==========================================

    // [ëª¨ë“œ A] ë­í‚¹ ë§¤ì¹­ (Presence ì‚¬ìš©)
    async function startRankedMatch() {
        switchView('matchingView');
        document.getElementById('matchingStatus').innerText = "ëŒ€ì „ ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘...";

        // 'global_lobby' ì±„ë„ì—ì„œ ëŒ€ê¸°ì¤‘ì¸ ìœ ì € íƒìƒ‰
        channel = supabase.channel('global_lobby');

        channel.on('presence', { event: 'sync' }, () => {
            const state = channel.presenceState();
            const users = Object.values(state).flat();

            // ë‚˜ ì´ì™¸ì˜ 'searching' ìƒíƒœì¸ ìœ ì € ì°¾ê¸°
            const opponent = users.find(u => u.id !== myData.id && u.status === 'searching');

            if (opponent) {
                // ë§¤ì¹­ ì„±ì‚¬! (IDê°€ ë” í° ìª½ì´ ë°©ì„ ë§Œë“¦ - ì¶©ëŒ ë°©ì§€)
                if (myData.id > opponent.id) {
                    const roomId = `battle_${myData.id}_${opponent.id}`;
                    channel.send({ type: 'broadcast', event: 'found_match', payload: { targetId: opponent.id, roomId: roomId } });
                    enterBattleRoom(roomId, true); // ë‚´ê°€ ì„ ê³µ(Host)
                }
            }
        }).on('broadcast', { event: 'found_match' }, ({ payload }) => {
            if (payload.targetId === myData.id) {
                enterBattleRoom(payload.roomId, false); // ë‚´ê°€ í›„ê³µ(Guest)
            }
        }).subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
                await channel.track({ id: myData.id, status: 'searching', mmr: myData.mmr });
            }
        });
    }

    // [ëª¨ë“œ B] ì»¤ìŠ¤í…€ ë°©
    function showCustomRoomUI(mode) {
        switchView('matchingView');
        if (mode === 'create') {
            const code = Math.floor(1000 + Math.random() * 9000); // 4ìë¦¬ ì½”ë“œ
            document.getElementById('roomCodeDisplay').classList.remove('hidden');
            document.getElementById('roomCodeText').innerText = code;
            document.getElementById('matchingStatus').innerText = "ìƒëŒ€ê°€ ì½”ë“œë¥¼ ì…ë ¥í•˜ê¸¸ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";

            channel = supabase.channel(`room_${code}`);
            channel.on('presence', { event: 'join' }, ({ newPresences }) => {
                // ëˆ„êµ°ê°€ ë“¤ì–´ì™”ë‹¤!
                newPresences.forEach(p => {
                    if (p.id !== myData.id) enterBattleRoom(`room_${code}`, true);
                });
            }).subscribe(async (status) => {
                if (status === 'SUBSCRIBED') await channel.track({ id: myData.id });
            });

        } else {
            document.getElementById('roomJoinInput').classList.remove('hidden');
            document.getElementById('matchingStatus').innerText = "ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.";
        }
    }

    function joinCustomRoom() {
        const code = document.getElementById('inputRoomCode').value;
        if (code.length !== 4) return alert("4ìë¦¬ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

        channel = supabase.channel(`room_${code}`);
        channel.subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
                await channel.track({ id: myData.id }); // ë‚´ ì¡´ì¬ ì•Œë¦¼
                enterBattleRoom(`room_${code}`, false);
            }
        });
    }

    function cancelMatching() {
        if (channel) supabase.removeChannel(channel);
        switchView('lobbyView');
        document.getElementById('roomCodeDisplay').classList.add('hidden');
        document.getElementById('roomJoinInput').classList.add('hidden');
    }

    // ==========================================
    // 3. ë°°í‹€ ë¡œì§
    // ==========================================
    async function enterBattleRoom(roomId, isHost) {
        if (channel) supabase.removeChannel(channel); // ì´ì „ ì±„ë„(ë¡œë¹„ ë“±) í‡´ì¥

        // ë°°í‹€ ì±„ë„ ì ‘ì†
        channel = supabase.channel(roomId);

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        channel
            .on('broadcast', { event: 'player_info' }, ({ payload }) => {
                if (payload.id !== myData.id && !enemyData) {
                    initBattle(payload, isHost);
                }
            })
            .on('broadcast', { event: 'attack' }, ({ payload }) => {
                receiveAttack(payload);
            })
            .on('broadcast', { event: 'game_over' }, ({ payload }) => {
                endGame(payload.winnerId === myData.id);
            });

        channel.subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
                // ë‚´ ì •ë³´ ì „ì†¡ (ìƒëŒ€ê°€ ë°›ì„ ë•Œê¹Œì§€ ë°˜ë³µ or handshake)
                channel.send({ type: 'broadcast', event: 'player_info', payload: myData });
            }
        });

        // í•‘í: ìƒëŒ€ê°€ ëŠ¦ê²Œ ë“¤ì–´ì˜¬ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì ì‹œ ì£¼ê¸°ì ìœ¼ë¡œ ë‚´ ì •ë³´ ì†¡ì¶œ
        const handshake = setInterval(() => {
            if (enemyData) clearInterval(handshake);
            else channel.send({ type: 'broadcast', event: 'player_info', payload: myData });
        }, 1000);
    }

    function initBattle(enemyInfo, isHost) {
        enemyData = enemyInfo;
        switchView('battleView');

        // UI ì„¸íŒ…
        document.getElementById('myImg').src = myData.sprite;
        document.getElementById('myName').innerText = myData.classId.toUpperCase();
        document.getElementById('enemyImg').src = enemyData.sprite;
        document.getElementById('enemyName').innerText = enemyData.classId.toUpperCase();

        // ìƒíƒœ ì´ˆê¸°í™”
        battleState = {
            myHp: myData.maxHp,
            enemyHp: enemyData.maxHp,
            cooldowns: [0, 0, 0, 0],
            myTurn: isHost // ë°©ì¥ì´ ì„ ê³µ
        };

        updateBattleUI();
        renderSkills();
        updateTurnUI();
    }

    function updateBattleUI() {
        const myPct = (battleState.myHp / myData.maxHp) * 100;
        const enPct = (battleState.enemyHp / enemyData.maxHp) * 100;
        document.getElementById('myHpBar').style.width = `${Math.max(0, myPct)}%`;
        document.getElementById('myHpText').innerText = `${Math.max(0, battleState.myHp)}/${myData.maxHp}`;
        document.getElementById('enemyHpBar').style.width = `${Math.max(0, enPct)}%`;
    }

    function updateTurnUI() {
        const ind = document.getElementById('turnIndicator');
        const grid = document.getElementById('skillGrid');

        if (battleState.myTurn) {
            ind.innerText = "ë‚˜ì˜ í„´! í–‰ë™ì„ ì„ íƒí•˜ì„¸ìš”.";
            ind.className = "text-center text-sm text-yellow-400 font-bold mb-2 animate-pulse";
            grid.classList.remove('opacity-50', 'pointer-events-none');

            // ì¿¨íƒ€ì„ ê°ì†Œ (ë‚´ í„´ ì‹œì‘ ì‹œ)
            battleState.cooldowns = battleState.cooldowns.map(c => Math.max(0, c - 1));
            renderSkills();
        } else {
            ind.innerText = "ìƒëŒ€ì˜ í–‰ë™ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
            ind.className = "text-center text-sm text-slate-500 mb-2";
            grid.classList.add('opacity-50', 'pointer-events-none');
        }
    }

    function renderSkills() {
        const grid = document.getElementById('skillGrid');
        grid.innerHTML = "";

        myData.skills.forEach((skill, idx) => {
            const btn = document.createElement('button');
            const cd = battleState.cooldowns[idx];

            btn.className = `btn-skill bg-slate-700 text-white p-3 rounded-lg text-left relative overflow-hidden ${cd > 0 ? '' : 'hover:bg-slate-600'}`;
            btn.disabled = cd > 0 || !battleState.myTurn;

            btn.innerHTML = `
                <div class="font-bold text-xs">${skill.name}</div>
                <div class="text-[10px] text-slate-400">ìœ„ë ¥ ${skill.power}</div>
                ${cd > 0 ? `<div class="absolute inset-0 bg-black/60 flex items-center justify-center font-bold text-lg">${cd}</div>` : ''}
            `;

            btn.onclick = () => performAction(idx);
            grid.appendChild(btn);
        });
    }

    function performAction(skillIdx) {
        if (!battleState.myTurn) return;

        const skill = myData.skills[skillIdx];

        // 1. ë°ë¯¸ì§€ ê³„ì‚° (ê°„ì†Œí™” ê³µì‹)
        // (ê³µê²©ë ¥ * ìŠ¤í‚¬ìœ„ë ¥) - (ì ë°©ì–´ë ¥ * 0.5)
        let dmg = Math.floor((myData.atk * skill.power) - (enemyData.def * 0.5));
        dmg = Math.max(1, dmg); // ìµœì†Œ ë°ë¯¸ì§€ 1

        // 2. ë‚´ í™”ë©´ ë°˜ì˜ (ì¦‰ì‹œì„±)
        battleState.enemyHp -= dmg;
        battleState.cooldowns[skillIdx] = skill.cd + 1; // ì‚¬ìš© ì‹œ ì¿¨íƒ€ì„ ì ìš©
        updateBattleUI();

        // ì• ë‹ˆë©”ì´ì…˜
        const myImg = document.getElementById('myImg');
        const enemyImg = document.getElementById('enemyImg');
        myImg.classList.add('translate-x-10', 'transition-transform'); // ëŒì§„
        setTimeout(() => {
            myImg.classList.remove('translate-x-10');
            enemyImg.classList.add('anim-damage', 'brightness-200'); // í”¼ê²©
            setTimeout(() => enemyImg.classList.remove('anim-damage', 'brightness-200'), 400);
        }, 200);

        // 3. ì„œë²„ ì „ì†¡
        channel.send({
            type: 'broadcast',
            event: 'attack',
            payload: { damage: dmg, skillName: skill.name }
        });

        // 4. í„´ ë„˜ê¹€
        battleState.myTurn = false;
        updateTurnUI();

        // 5. ìŠ¹ë¦¬ ì²´í¬
        if (battleState.enemyHp <= 0) {
            channel.send({ type: 'broadcast', event: 'game_over', payload: { winnerId: myData.id } });
            endGame(true);
        }
    }

    function receiveAttack({ damage, skillName }) {
        // ìƒëŒ€ê°€ ê³µê²©í•¨
        document.getElementById('turnIndicator').innerText = `ì ì´ ${skillName}(ì„)ë¥¼ ì‚¬ìš©! ${damage} í”¼í•´!`;

        battleState.myHp -= damage;
        updateBattleUI();

        // ì• ë‹ˆë©”ì´ì…˜
        const enemyImg = document.getElementById('enemyImg');
        const myImg = document.getElementById('myImg');

        // ì  ëŒì§„ (ë°˜ì „ ìƒíƒœë¼ -Xê°€ ì „ì§„)
        enemyImg.style.transform = "scaleX(-1) translateX(-40px)";
        setTimeout(() => {
            enemyImg.style.transform = "scaleX(-1) translateX(0)";
            myImg.classList.add('anim-damage', 'bg-red-500/50');
            setTimeout(() => myImg.classList.remove('anim-damage', 'bg-red-500/50'), 400);
        }, 200);

        if (battleState.myHp > 0) {
            battleState.myTurn = true;
            setTimeout(updateTurnUI, 1000); // ì—°ì¶œ ì‹œê°„ í›„ í„´ ë„˜ê¹€
        }
    }

    async function endGame(isWin) {
        if (channel) supabase.removeChannel(channel);

        const modal = document.getElementById('resultModal');
        const title = document.getElementById('resultTitle');
        const icon = document.getElementById('resultIcon');
        const desc = document.getElementById('resultDesc');

        modal.classList.remove('hidden');
        modal.classList.add('flex');

        if (isWin) {
            title.innerText = "VICTORY";
            title.className = "text-4xl font-black mb-2 text-yellow-500";
            icon.innerText = "ğŸ†";
            desc.innerText = "ìƒëŒ€ë¥¼ ì••ë„í–ˆìŠµë‹ˆë‹¤! (+20ì )";

            // ìŠ¹ë¦¬ ì‹œ DB ì—…ë°ì´íŠ¸ (ë³´ì•ˆ ì·¨ì•½í•˜ì§€ë§Œ MVPìš©)
            const newMMR = myData.mmr + 20;
            await supabase.from('dqr_rankings').update({ mmr: newMMR, wins: 1 }).eq('user_id', myData.permId); // winsëŠ” increment í•„ìš”í•˜ë‚˜ MVPëŠ” ë‹¨ìˆœ update
        } else {
            title.innerText = "DEFEAT";
            title.className = "text-4xl font-black mb-2 text-slate-500";
            icon.innerText = "ğŸ’€";
            desc.innerText = "ì•„ì‰½ê²Œ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤... (-10ì )";

            const newMMR = Math.max(0, myData.mmr - 10);
            await supabase.from('dqr_rankings').update({ mmr: newMMR, losses: 1 }).eq('user_id', myData.permId);
        }
    }

</script>
</body>
</html>