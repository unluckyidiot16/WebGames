<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Dungeon Quiz Arena (PvP)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif; background-color: #0f172a; color: white; height: 100vh; overflow: hidden; touch-action: manipulation; }
        .pixel-art { image-rendering: pixelated; }
        .view { display: none; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .view.active { display: flex; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .anim-hit { animation: shake 0.4s; filter: brightness(2) sepia(1) saturate(5) hue-rotate(-50deg); }
        .anim-lunge { transition: transform 0.2s; transform: translateX(60px); }
        .anim-lunge-back { transition: transform 0.2s; transform: translateX(-60px); }

        .btn-skill { @apply relative overflow-hidden rounded-xl border-b-4 transition-all duration-100; }
        .btn-skill:active:not(:disabled) { transform: translateY(2px); border-bottom-width: 0; }
        .btn-skill.selected { @apply border-yellow-400 ring-2 ring-yellow-400 bg-slate-600; transform: translateY(2px); border-bottom-width: 0; }

        .btn-choice { background: #334155; border: 2px solid #475569; border-radius: 12px; padding: 16px; font-weight: bold; }
        .btn-choice.correct { background: #15803d; border-color: #22c55e; }
        .btn-choice.wrong { background: #b91c1c; border-color: #ef4444; }

        .room-item { @apply bg-slate-800 p-4 rounded-xl border border-slate-600 flex justify-between items-center cursor-pointer hover:bg-slate-700 transition-colors mb-2; }
        .room-item:active { @apply bg-slate-600 transform scale-95; }
    </style>
</head>
<body>

<section id="lobbyView" class="view active bg-slate-900">
    <h1 class="text-5xl font-black mb-1 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 italic">ARENA</h1>
    <div class="text-xs text-slate-500 mb-6 font-bold tracking-widest">PVP v13.2</div>

    <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 w-full max-w-sm text-center shadow-2xl relative">
        <img id="myLobbyImg" src="" class="w-24 h-24 mx-auto mb-2 pixel-art drop-shadow-lg">
        <div class="text-xl font-bold mb-1" id="myLobbyName">Player</div>
        <div class="text-sm text-slate-400 mb-6">Rating: <span id="myMMR" class="text-yellow-400 font-bold">---</span></div>

        <button onclick="startRankedMatch()" class="w-full bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-4 rounded-xl mb-3 shadow-lg border-b-4 border-blue-900 active:border-b-0 active:translate-y-1 transition-all group">
            <div class="flex items-center justify-center gap-2">
                <span class="text-2xl group-hover:scale-110 transition-transform">âš”ï¸</span>
                <div class="text-left">
                    <div class="text-sm leading-none opacity-80">FAIR MODE</div>
                    <div class="text-lg leading-none">ë­í‚¹ ë§¤ì¹­ ì‹œì‘</div>
                </div>
            </div>
        </button>

        <button onclick="enterCustomLobby()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl border-b-4 border-slate-900 active:border-b-0 active:translate-y-1 flex justify-center items-center gap-2">
            <span>ğŸŸï¸</span> ë°© ëª©ë¡ (ì¹œì„ ì „)
        </button>

        <button onclick="goHome()" class="mt-6 text-slate-500 underline text-xs">ì‹±ê¸€ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</section>

<section id="customLobbyView" class="view bg-slate-900 justify-start pt-10">
    <div class="w-full max-w-md h-full flex flex-col p-4">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-bold text-white">ëŒ€ê¸°ì‹¤ ëª©ë¡</h2>
            <button onclick="leaveLobby()" class="text-sm text-slate-400 hover:text-white">ë‚˜ê°€ê¸°</button>
        </div>

        <div class="flex-1 bg-slate-900/50 rounded-2xl border border-slate-700 p-2 overflow-hidden flex flex-col">
            <div id="roomListContainer" class="flex-1 overflow-y-auto space-y-2 pr-1">
                <div class="text-center text-slate-500 mt-20 flex flex-col items-center">
                    <span class="text-4xl mb-2">ğŸ“­</span>
                    ë°©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
                </div>
            </div>
        </div>

        <button onclick="createRoom()" class="w-full mt-4 bg-green-600 hover:bg-green-500 text-white font-bold py-4 rounded-xl shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 flex justify-center items-center gap-2">
            <span class="text-xl">â•</span> ë°© ë§Œë“¤ê¸°
        </button>
    </div>
</section>

<section id="waitingView" class="view bg-slate-900/95 z-50 fixed inset-0 hidden">
    <div class="text-center">
        <div class="text-6xl mb-6 animate-spin">â³</div>
        <h2 class="text-2xl font-bold mb-2 text-white" id="waitingTitle">ë§¤ì¹­ ì¤‘...</h2>
        <p id="waitingDesc" class="text-slate-400 text-sm mb-8">ìƒëŒ€ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.</p>
        <button onclick="cancelMatching()" class="bg-red-500/20 text-red-400 border border-red-500/50 px-8 py-2 rounded-full hover:bg-red-500/30 font-bold transition-colors">ì·¨ì†Œ</button>
    </div>
</section>

<section id="battleView" class="view relative bg-slate-900 justify-between pb-4 overflow-hidden">
    <div class="w-full max-w-md bg-slate-800/90 backdrop-blur p-2 flex justify-between items-center z-20 border-b border-slate-700 shadow-lg absolute top-0">
        <div class="flex flex-col">
            <div class="text-[10px] text-slate-400 font-bold">MODE</div>
            <div class="text-xs font-bold text-yellow-400" id="battleModeBadge">RANKED</div>
        </div>
        <div class="flex flex-col items-center">
            <div class="text-3xl font-black text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]" id="timerDisplay">30</div>
        </div>
        <div class="flex flex-col items-end">
            <div class="text-[10px] text-slate-400 font-bold">ROUND</div>
            <div class="text-lg font-bold text-white"><span id="turnCount">1</span></div>
        </div>
    </div>

    <div class="relative w-full max-w-md flex-1 flex flex-col justify-center mt-16 mb-40">
        <div class="absolute top-4 right-6 flex flex-col items-end z-10 w-full pr-12">
            <div class="relative">
                <img id="enemyImg" src="" class="w-32 h-32 pixel-art scale-x-[-1] transition-transform duration-200">
                <div id="enemyStatus" class="absolute -top-6 right-0 flex gap-1 text-xs"></div>
                <div id="enemyBubble" class="absolute top-10 -left-16 bg-white text-slate-900 text-xs font-bold px-2 py-1 rounded-lg border-2 border-red-500 hidden z-20 whitespace-nowrap">...</div>
            </div>
            <div class="w-40 bg-slate-800/90 px-2 py-1 rounded border border-slate-600 mt-2 text-right">
                <div class="text-xs text-red-400 font-bold truncate" id="enemyName">Enemy</div>
                <div class="w-full h-1.5 bg-slate-700 rounded-full mt-1 overflow-hidden">
                    <div id="enemyHpBar" class="h-full bg-red-500 w-full transition-all duration-300"></div>
                </div>
            </div>
        </div>

        <div class="absolute bottom-4 left-6 flex flex-col items-start z-10 w-full pl-12">
            <div class="w-40 bg-slate-800/90 px-2 py-1 rounded border border-blue-500/50 mb-2">
                <div class="flex justify-between items-end">
                    <span class="text-sm text-blue-300 font-bold truncate" id="myName">Me</span>
                    <span class="text-[10px] text-slate-400" id="myHpText"></span>
                </div>
                <div class="w-full h-2 bg-slate-700 rounded-full mt-1 overflow-hidden">
                    <div id="myHpBar" class="h-full bg-blue-500 w-full transition-all duration-300"></div>
                </div>
                <div class="w-full h-1 bg-transparent mt-0.5 overflow-hidden"><div id="myShieldBar" class="h-full bg-yellow-400 w-0"></div></div>
            </div>
            <div class="relative">
                <img id="myImg" src="" class="w-40 h-40 pixel-art transition-transform duration-200">
                <div id="myStatus" class="absolute -top-6 left-0 flex gap-1 text-xs"></div>
                <div id="myBubble" class="absolute top-10 -right-16 bg-white text-slate-900 text-xs font-bold px-2 py-1 rounded-lg border-2 border-blue-500 hidden z-20 whitespace-nowrap">...</div>
            </div>
        </div>

        <div id="centerMsg" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-30 pointer-events-none text-center w-full px-4 hidden">
            <div class="text-4xl font-black text-white drop-shadow-[0_4px_0_#000] stroke-2" id="centerMsgText">READY</div>
        </div>
    </div>

    <div class="absolute bottom-0 w-full max-w-md bg-slate-800 rounded-t-3xl border-t border-slate-600 shadow-2xl z-40 transition-all duration-300 h-64 flex flex-col">
        <div id="skillPanel" class="flex-1 p-4 flex flex-col">
            <div class="text-center text-sm text-slate-400 mb-2 font-bold">ì´ë²ˆ í„´ì— ì‚¬ìš©í•  ê¸°ìˆ ì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div id="skillGrid" class="grid grid-cols-2 gap-2 flex-1"></div>
            <div id="waitingMsg" class="hidden absolute inset-0 bg-slate-900/90 rounded-t-3xl flex items-center justify-center flex-col z-50">
                <div class="text-3xl animate-bounce mb-2">â³</div>
                <div class="text-yellow-400 font-bold">ìƒëŒ€ë°© ì„ íƒ ëŒ€ê¸° ì¤‘...</div>
            </div>
        </div>

        <div id="quizPanel" class="absolute inset-0 bg-slate-800 rounded-t-3xl p-5 hidden z-50">
            <div class="mb-4 text-center h-16 flex flex-col justify-center">
                <p class="text-xs text-slate-400 mb-1">ë¬¸ì œë¥¼ í’€ë©´ ê¸°ìˆ ì´ ë°œë™í•©ë‹ˆë‹¤!</p>
                <p class="text-2xl font-black text-white break-keep" id="quizQuestion">3 x 3 = ?</p>
            </div>
            <div id="quizChoices" class="grid grid-cols-2 gap-3 h-32"></div>
        </div>
    </div>
</section>

<div id="resultModal" class="fixed inset-0 bg-black/90 z-50 hidden flex-col items-center justify-center p-4">
    <div class="bg-white text-slate-900 p-8 rounded-3xl text-center max-w-sm w-full shadow-2xl animate-[bounce_0.5s]">
        <div class="text-6xl mb-4" id="resultIcon">ğŸ†</div>
        <h2 class="text-4xl font-black mb-2" id="resultTitle">WIN</h2>
        <p class="text-slate-500 mb-6 font-bold" id="resultDesc">ì ìˆ˜ +20</p>
        <button onclick="location.reload()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold hover:bg-slate-700 transition-colors">ë¡œë¹„ë¡œ ëŒì•„ê°€ê¸°</button>
    </div>
</div>

<div id="playerFloatText" class="absolute top-0 left-0 w-full h-full flex justify-center items-center pointer-events-none z-50"></div>

<script>
    // ==========================================
    // 0. ì„¤ì • ë° ì´ˆê¸°í™”
    // ==========================================
    // âš ï¸ ì•„ë˜ ë‘ ë³€ìˆ˜ì— ë³¸ì¸ì˜ í‚¤ë¥¼ ë°˜ë“œì‹œ ì…ë ¥í•˜ì„¸ìš”!
    const SUPABASE_URL = 'https://otzhhhzirasqmrdknhib.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90emhoaHppcmFzcW1yZGtuaGliIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMxMDQ3MjMsImV4cCI6MjA3ODY4MDcyM30.ky1jeShjnEPsUkbGI_ZRtXbdWxiPFEYqRSUiizD98_M';

    let sb = null; // ì¶©ëŒ ë°©ì§€ìš© ë³€ìˆ˜ëª… (sb)

    function initSupabase() {
        if (typeof supabase === 'undefined') {
            alert("Supabase ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨. ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.");
            return false;
        }
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_KEY.length < 10) {
            alert("âš ï¸ DQR_PvP.html íŒŒì¼ì„ ì—´ì–´ Supabase í‚¤ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤!");
            return false;
        }
        try {
            sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            return true;
        } catch(e) {
            alert("Supabase ì´ˆê¸°í™” ì˜¤ë¥˜: " + e.message);
            return false;
        }
    }

    // ==========================================
    // 1. ë°ì´í„° ì •ì˜
    // ==========================================
    const SKILL_DB = {
        "k1": { name: "ìˆ˜í˜¸ì˜ ê²€", type: "atk", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
        "k2": { name: "ë°©íŒ¨ ê°•íƒ€", type: "atk_stun", power: 1.2, cd: 3, desc: "í”¼í•´ + 1í„´ ê¸°ì ˆ" },
        "k3": { name: "ë°˜ê²© íƒœì„¸", type: "buff_counter", power: 0, cd: 4, desc: "í”¼í•´ 50% ê²½ê° ë° ë°˜ì‚¬" },
        "k4": { name: "ì‘ê¸‰ ì²˜ì¹˜", type: "buff_heal_missing", power: 0, cd: 4, desc: "ìƒì€ HP ë¹„ë¡€ íšŒë³µ" },
        "k5": { name: "ì² ë²½ ìˆ˜ë¹„", type: "buff_def", power: 0, cd: 4, desc: "ë°›ëŠ” í”¼í•´ 50% ê°ì†Œ" },
        "k6": { name: "ìˆ˜í˜¸ì˜ ê²°ê³„", type: "buff_shield", power: 0, cd: 4, desc: "ë³´í˜¸ë§‰ ìƒì„±" },
        "k7": { name: "ì§•ë²Œì˜ ì¼ê²©", type: "atk", power: 2.2, cd: 3, desc: "ê°•ë ¥í•œ ì¼ê²©" },
        "k8": { name: "ì„±ì±„ ì „ê°œ", type: "buff_aegis", power: 0, cd: 6, desc: "ë°©ì–´+ë°˜ê²©+ë³´í˜¸ë§‰ (ê¶ê·¹ê¸°)" },

        "r1": { name: "ë‹¨ê²€ íˆ¬ì²™", type: "atk", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
        "r2": { name: "ì•½ì  ê°„íŒŒ", type: "buff_next_crit", power: 0, cd: 3, desc: "ë‹¤ìŒ ê³µê²© í™•ì • ì¹˜ëª…íƒ€" },
        "r3": { name: "ê·¸ë¦¼ì ë§í† ", type: "buff_evasion", power: 0, cd: 5, desc: "íšŒí”¼ìœ¨ 80% ì¦ê°€" },
        "r4": { name: "í¡í˜ˆ ë² ê¸°", type: "atk_vampire", power: 1.2, cd: 3, desc: "í”¼í•´ì˜ 50% íšŒë³µ" },
        "r5": { name: "ê¸‰ì†Œ ì°Œë¥´ê¸°", type: "atk_crit", power: 1.5, cd: 2, desc: "ë†’ì€ ì¹˜ëª…íƒ€ í™•ë¥ " },
        "r6": { name: "ë…ê¸° í­ì£¼", type: "buff_atk", power: 0, cd: 4, desc: "ê³µê²©ë ¥ ì¦ê°€" },
        "r7": { name: "ì—°ì† ë² ê¸°", type: "atk", power: 0.8, cd: 1, desc: "ì§§ì€ ì¿¨íƒ€ì„ ê³µê²©" },
        "r8": { name: "ì•”ì‚´", type: "atk_execute", power: 3.0, cd: 6, desc: "ì²´ë ¥ ë‚®ì€ ì ì—ê²Œ ì¹˜ëª…ì " },

        "m1": { name: "ë§¤ì§ ë¯¸ì‚¬ì¼", type: "atk", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
        "m2": { name: "íŒŒì´ì–´ë³¼", type: "atk", power: 1.8, cd: 2, desc: "ë©”ì¸ ë”œë§" },
        "m3": { name: "ë§ˆë‚˜ ì¥ë²½", type: "buff_shield_huge", power: 0, cd: 4, desc: "ëŒ€í˜• ë³´í˜¸ë§‰" },
        "m4": { name: "ì–¼ìŒ ë°©íŒ¨", type: "buff_invuln", power: 0, cd: 6, desc: "1í„´ê°„ ë¬´ì " },
        "m5": { name: "ë§ˆë ¥ ì¦í­", type: "buff_next_double", power: 0, cd: 4, desc: "ë‹¤ìŒ ìŠ¤í‚¬ í”¼í•´ 2ë°°" },
        "m6": { name: "ì•„ì¼€ì¸ ë¸”ë˜ìŠ¤íŠ¸", type: "atk", power: 2.5, cd: 4, desc: "ê°•ë ¥í•œ ë‹¨ì¼ í­ë”œ" },
        "m7": { name: "ë§ˆë ¥ í•´ì œ", type: "dispel", power: 0, cd: 4, desc: "ì  ë²„í”„/ë³´í˜¸ë§‰ ì œê±°" },
        "m8": { name: "ë©”í…Œì˜¤", type: "atk_ult", power: 4.5, cd: 8, desc: "ì´ˆëŒ€í˜• í•œ ë°© (ê¶ê·¹ê¸°)" }
    };
    const RANKED_SKILL_SETS = { "knight": ["k1", "k2", "k6", "k8"], "rogue": ["r1", "r6", "r2", "r8"], "mage": ["m1", "m7", "m5", "m8"] };

    let myData = null, enemyData = null;
    let channel = null, lobbyChannel = null;
    let isHost = false, roomId = null, battleMode = 'ranked';
    let myUUID = localStorage.getItem("dqr_uuid") || crypto.randomUUID();
    localStorage.setItem("dqr_uuid", myUUID);

    let gameState = { round: 1, phase: 'select', timer: 30, myHp: 0, enemyHp: 0, myShield: 0, enemyShield: 0, myBuffs: {}, enemyBuffs: {}, myCooldowns: [0,0,0,0], mySelectedSkillId: null, enemySelectedSkillId: null, myAnswer: null, enemyAnswer: null, currentQuiz: null };
    let timerInterval = null;

    // ==========================================
    // 2. ì´ˆê¸°í™” ë° ë¡œë¹„
    // ==========================================
    window.onload = async () => {
        if (!initSupabase()) return;

        const raw = localStorage.getItem("qz_rpg_v110_data");
        let cid = "knight", sprite = "./png/knight.png";
        let lv = 1;
        if(raw) {
            const d = JSON.parse(raw);
            cid = d.selectedClass;
            const h = d.heroes[cid];
            lv = h.level;
            if(cid === 'knight') sprite = h.skin === 'skin' ? './png/knight-black.png' : './png/knight.png';
            else if(cid === 'rogue') sprite = h.skin === 'skin' ? './png/rogue-female.png' : './png/rogue-male.png';
            else sprite = './png/wizard.png';
        }

        myData = { id: myUUID, classId: cid, sprite, name: cid.toUpperCase(), level: lv };
        document.getElementById('myLobbyImg').src = sprite;
        document.getElementById('myLobbyName').innerText = cid.toUpperCase();
        document.getElementById('myLobbyLvBadge').innerText = `Lv.${lv}`;
        document.getElementById('myMMR').innerText = "1000";
    };

    function goHome() { window.location.href = "DQR.html"; }
    function switchView(id) {
        document.querySelectorAll('.view').forEach(v => {
            v.classList.remove('active');
            if(v.id === 'waitingView') v.classList.add('hidden');
        });
        const target = document.getElementById(id);
        target.classList.add('active');
        if(id === 'waitingView') target.classList.remove('hidden');
    }

    // --- ê³µê°œ ë¡œë¹„ ì‹œìŠ¤í…œ ---
    function enterCustomLobby() {
        switchView('customLobbyView');
        connectToLobby();
    }

    function leaveLobby() {
        if(lobbyChannel) sb.removeChannel(lobbyChannel);
        switchView('lobbyView');
    }

    function connectToLobby() {
        if(lobbyChannel) sb.removeChannel(lobbyChannel);
        lobbyChannel = sb.channel('global_rooms');

        lobbyChannel.on('presence', { event: 'sync' }, () => {
            const state = lobbyChannel.presenceState();
            renderRoomList(state);
        }).subscribe();
    }

    function renderRoomList(state) {
        const container = document.getElementById('roomListContainer');
        container.innerHTML = "";

        const rooms = Object.values(state).flat().filter(u => u.isHosting && u.id !== myData.id);

        if(rooms.length === 0) {
            container.innerHTML = '<div class="text-center text-slate-500 mt-20 flex flex-col items-center"><span class="text-4xl mb-2">ğŸ“­</span>ê°œì„¤ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì§ì ‘ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>';
            return;
        }

        rooms.forEach(room => {
            const div = document.createElement('div');
            div.className = "room-item";
            div.innerHTML = `
                <div class="flex items-center gap-3">
                    <img src="${room.sprite}" class="w-10 h-10 pixel-art rounded bg-slate-700">
                    <div>
                        <div class="font-bold text-sm text-yellow-400">${room.roomName}</div>
                        <div class="text-[10px] text-slate-400">Host: ${room.hostName}</div>
                    </div>
                </div>
                <div class="text-xs bg-green-600 hover:bg-green-500 text-white font-bold px-3 py-1.5 rounded transition-colors">ì…ì¥</div>
            `;
            div.onclick = () => joinRoom(room.roomId, false, 'friendly');
            container.appendChild(div);
        });
    }

    async function createRoom() {
        if(lobbyChannel) sb.removeChannel(lobbyChannel);

        const newRoomId = `room_${myData.id}_${Date.now()}`;
        const roomName = `[Lv.${myData.level}] ${myData.name}ì˜ ë°©`;

        lobbyChannel = sb.channel('global_rooms');
        lobbyChannel.subscribe(async (status) => {
            if (status === 'SUBSCRIBED') {
                await lobbyChannel.track({
                    id: myData.id,
                    isHosting: true,
                    roomId: newRoomId,
                    roomName: roomName,
                    hostName: myData.name,
                    sprite: myData.sprite
                });
                waitForChallenger(newRoomId);
            }
        });

        switchView('waitingView');
        document.getElementById('waitingTitle').innerText = "ë°© ìƒì„± ì™„ë£Œ";
        document.getElementById('waitingDesc').innerText = "ë„ì „ìë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘ì…ë‹ˆë‹¤...";
    }

    function waitForChallenger(roomId) {
        channel = sb.channel(roomId);
        channel.on('presence', {event:'join'}, ({newPresences}) => {
            newPresences.forEach(p => {
                if(p.id !== myData.id) {
                    if(lobbyChannel) lobbyChannel.untrack();
                    joinRoom(roomId, true, 'friendly');
                }
            });
        }).subscribe(async (s) => {
            if(s==='SUBSCRIBED') await channel.track({ id: myData.id });
        });
    }

    // --- ë­í‚¹ ë§¤ì¹­ ---
    function startRankedMatch() {
        if (!sb) return alert("Supabase ì—°ê²° ì‹¤íŒ¨");
        switchView('waitingView');
        document.getElementById('waitingTitle').innerText = "ë§¤ì¹­ ì¤‘...";
        document.getElementById('waitingDesc').innerText = "ë¹„ìŠ·í•œ ì‹¤ë ¥ì˜ ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘...";

        channel = sb.channel('global_rank_queue');
        channel.on('presence', { event: 'sync' }, () => {
            const users = Object.values(channel.presenceState()).flat();
            const opponent = users.find(u => u.id !== myData.id && u.status === 'searching' && u.mode === 'ranked');
            if (opponent && myData.id > opponent.id) {
                const room = `btl_${myData.id}_${opponent.id}`;
                channel.send({ type: 'broadcast', event: 'match', payload: { room, host: myData.id } });
                joinRoom(room, true, 'ranked');
            }
        }).on('broadcast', { event: 'match' }, ({ payload }) => {
            if (payload.room.includes(myData.id)) joinRoom(payload.room, payload.host === myData.id, 'ranked');
        }).subscribe(async (s) => {
            if(s==='SUBSCRIBED') await channel.track({ id: myData.id, status: 'searching', mode: 'ranked' });
        });
    }

    function cancelMatching() {
        if(channel) sb.removeChannel(channel);
        if(lobbyChannel) sb.removeChannel(lobbyChannel);

        if(document.getElementById('customLobbyView').classList.contains('active')) {
            document.getElementById('waitingView').classList.add('hidden');
            connectToLobby();
        } else {
            switchView('lobbyView');
            document.getElementById('waitingView').classList.add('hidden');
        }
    }

    // ==========================================
    // 3. ë°°í‹€ ë°ì´í„° & ì ‘ì†
    // ==========================================
    function initBattleData(mode) {
        battleMode = mode;
        const raw = localStorage.getItem("qz_rpg_v110_data");

        let cid = "knight";
        let level = 1;
        let equipped = ["k1", "k2", "k6", "k8"];
        let skillLevels = { k1:1, k2:1, k6:1, k8:1 };

        if (raw) {
            const d = JSON.parse(raw);
            cid = d.selectedClass;
            const h = d.heroes[cid];

            if (mode === 'friendly') {
                level = h.level;
                equipped = h.equipped || RANKED_SKILL_SETS[cid];
                skillLevels = h.skillLevels;
            } else {
                level = 30;
                equipped = RANKED_SKILL_SETS[cid];
                skillLevels = {};
                equipped.forEach(id => skillLevels[id] = 1);
            }
        }

        const stats = calculateStats(cid, level);

        myData.level = level;
        myData.maxHp = stats.maxHp * 5;
        myData.atk = stats.atk * 3;
        myData.def = stats.def * 2;
        myData.skills = equipped.map(id => ({ ...SKILL_DB[id], id: id, level: skillLevels[id] || 1 }));
    }

    function calculateStats(cid, lv) {
        const base = {
            knight: { hp: 15, atk: 12, def: 8 },
            rogue:  { hp: 10, atk: 18, def: 4 },
            mage:   { hp: 8,  atk: 22, def: 3 }
        }[cid];
        return {
            maxHp: Math.floor(base.hp + (lv * 2)),
            atk: Math.floor(base.atk + (lv * 1.5)),
            def: Math.floor(base.def + (lv * 0.8))
        };
    }

    function joinRoom(room, host, mode) {
        if(channel) sb.removeChannel(channel);
        roomId = room; isHost = host;

        initBattleData(mode);

        channel = sb.channel(room);

        channel
            .on('broadcast', { event: 'ready' }, ({ payload }) => { if (payload.id !== myData.id) { enemyData = payload; startBattle(); } })
            .on('broadcast', { event: 'skill_selected' }, ({ payload }) => { if(payload.id !== myData.id) checkSkillPhaseEnd(payload); })
            .on('broadcast', { event: 'quiz_start' }, ({ payload }) => { startQuizPhase(payload); })
            .on('broadcast', { event: 'submit_answer' }, ({ payload }) => { if(payload.id !== myData.id) { gameState.enemyAnswer = payload; checkQuizEnd(); } });

        channel.subscribe(async (s) => {
            if(s==='SUBSCRIBED') {
                channel.send({ type: 'broadcast', event: 'ready', payload: myData });
                const interval = setInterval(() => {
                    if (enemyData) clearInterval(interval);
                    else channel.send({ type: 'broadcast', event: 'ready', payload: myData });
                }, 1000);
            }
        });
    }

    // ==========================================
    // 4. ì „íˆ¬ ë£¨í”„
    // ==========================================
    function startBattle() {
        document.getElementById('waitingView').classList.add('hidden');
        switchView('battleView');

        document.getElementById('myImg').src = myData.sprite;
        document.getElementById('enemyImg').src = enemyData.sprite;
        document.getElementById('myName').innerText = myData.classId;
        document.getElementById('enemyName').innerText = enemyData.classId;
        document.getElementById('battleModeBadge').innerText = battleMode === 'ranked' ? 'RANKED' : 'FRIENDLY';

        gameState.myHp = myData.maxHp;
        gameState.enemyHp = enemyData.maxHp;
        updateHpUI();
        startSkillPhase();
    }

    function startSkillPhase() {
        gameState.phase = 'select';
        gameState.mySelectedSkillId = null;
        gameState.enemySelectedSkillId = null;
        gameState.myAnswer = null;
        gameState.enemyAnswer = null;

        document.getElementById('phaseBadge').innerText = "SKILL SELECT";
        document.getElementById('phaseBadge').className = "text-xs font-bold text-green-400 animate-pulse";
        document.getElementById('skillPanel').classList.remove('hidden');
        document.getElementById('quizPanel').classList.add('hidden');
        document.getElementById('waitingMsg').classList.add('hidden');
        document.getElementById('myBubble').classList.add('hidden');
        document.getElementById('enemyBubble').classList.add('hidden');

        gameState.myCooldowns = gameState.myCooldowns.map(c => Math.max(0, c - 1));

        renderSkills();
        startTimer(30, autoSelectSkill);
    }

    function renderSkills() {
        const grid = document.getElementById('skillGrid');
        grid.innerHTML = "";
        myData.skills.forEach((skill, idx) => {
            const btn = document.createElement('button');
            const cd = gameState.myCooldowns[idx];
            btn.className = `btn-skill bg-slate-700 p-3 text-left ${cd > 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-600'} border-b-slate-900`;
            btn.innerHTML = `
                <div class="text-xs font-bold text-white">${skill.name}</div>
                <div class="text-[10px] text-slate-400">${skill.desc}</div>
                ${cd > 0 ? `<div class="absolute inset-0 bg-black/60 flex items-center justify-center font-bold text-white">${cd}</div>` : ''}
            `;
            btn.disabled = cd > 0;
            btn.onclick = () => selectSkill(idx);
            grid.appendChild(btn);
        });
    }

    function selectSkill(idx) {
        if (gameState.phase !== 'select' || gameState.mySelectedSkillId !== null) return;
        gameState.mySelectedSkillId = idx;
        const btns = document.querySelectorAll('.btn-skill');
        btns.forEach((b, i) => { if (i === idx) b.classList.add('selected'); else b.disabled = true; });
        document.getElementById('waitingMsg').classList.remove('hidden');
        channel.send({ type: 'broadcast', event: 'skill_selected', payload: { id: myData.id, skillIdx: idx } });
    }

    function autoSelectSkill() {
        if (gameState.mySelectedSkillId === null) {
            const available = myData.skills.map((_, i) => i).filter(i => gameState.myCooldowns[i] === 0);
            selectSkill(available.length > 0 ? available[0] : 0);
        }
    }

    function checkSkillPhaseEnd(payload) {
        if (payload) gameState.enemySelectedSkillId = payload.skillIdx;
        if (gameState.mySelectedSkillId !== null && gameState.enemySelectedSkillId !== null) {
            clearInterval(timerInterval);
            if (isHost) {
                const n1 = Math.floor(Math.random()*8)+2, n2 = Math.floor(Math.random()*9)+1;
                const ans = n1*n2;
                const choices = new Set([ans]);
                while(choices.size < 4) choices.add(ans + (Math.floor(Math.random()*5)-2)*10);
                const quiz = { q: `${n1} Ã— ${n2} = ?`, a: ans, choices: Array.from(choices).sort(()=>Math.random()-0.5) };
                channel.send({ type: 'broadcast', event: 'quiz_start', payload: quiz });
                startQuizPhase(quiz);
            }
        }
    }

    function startQuizPhase(quiz) {
        gameState.phase = 'quiz';
        gameState.currentQuiz = quiz;
        document.getElementById('phaseBadge').innerText = "QUIZ TIME";
        document.getElementById('phaseBadge').className = "text-xs font-bold text-yellow-400 animate-bounce";
        document.getElementById('skillPanel').classList.add('hidden');
        document.getElementById('quizPanel').classList.remove('hidden');
        document.getElementById('quizQuestion').innerText = quiz.q;
        const grid = document.getElementById('quizChoices');
        grid.innerHTML = "";
        quiz.choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = "btn-choice text-white bg-slate-700 hover:bg-slate-600";
            btn.innerText = c;
            btn.onclick = () => submitAnswer(c);
            grid.appendChild(btn);
        });
        startTimer(10, () => submitAnswer(-999));
    }

    function submitAnswer(val) {
        if (gameState.myAnswer) return;
        const correct = val === gameState.currentQuiz.a;
        gameState.myAnswer = { correct, val };

        const btns = document.querySelectorAll('.btn-choice');
        btns.forEach(b => {
            b.disabled = true;
            if(parseInt(b.innerText)===val) b.classList.add(correct?'correct':'wrong');
        });
        document.getElementById('myBubble').innerText = "ì œì¶œ ì™„ë£Œ!";
        document.getElementById('myBubble').classList.remove('hidden');
        channel.send({ type: 'broadcast', event: 'submit_answer', payload: { id: myData.id, correct } });
        checkQuizEnd();
    }

    function checkQuizEnd() {
        if (gameState.myAnswer && gameState.enemyAnswer) {
            clearInterval(timerInterval);
            setTimeout(resolveRound, 1000);
        }
    }

    async function resolveRound() {
        gameState.phase = 'resolve';
        document.getElementById('quizPanel').classList.add('hidden');
        document.getElementById('myBubble').classList.add('hidden');
        document.getElementById('enemyBubble').classList.add('hidden');
        document.getElementById('phaseBadge').innerText = "BATTLE";
        document.getElementById('phaseBadge').className = "text-xs font-bold text-red-500";

        const meFirst = (gameState.round % 2 !== 0) === isHost;
        await executeAction(meFirst ? 'me' : 'enemy');
        if (checkGameOver()) return;
        await executeAction(meFirst ? 'enemy' : 'me');
        if (checkGameOver()) return;

        gameState.round++;
        document.getElementById('turnCount').innerText = gameState.round;
        setTimeout(startSkillPhase, 1500);
    }

    function executeAction(who) {
        return new Promise(resolve => {
            const isMe = who === 'me';
            const actor = isMe ? myData : enemyData;
            const skillId = isMe ? actor.skills[gameState.mySelectedSkillId].id : actor.skills[gameState.enemySelectedSkillId].id;
            const skill = SKILL_DB[skillId];
            const answer = isMe ? gameState.myAnswer : gameState.enemyAnswer;
            const buffs = isMe ? gameState.myBuffs : gameState.enemyBuffs;
            const targetBuffs = isMe ? gameState.enemyBuffs : gameState.myBuffs;
            const level = isMe ? actor.skills[gameState.mySelectedSkillId].level : actor.skills[gameState.enemySelectedSkillId].level;

            showCenterMsg(`${actor.name}: ${skill.name}!`, 1000);

            if (!answer.correct) {
                setTimeout(() => {
                    document.getElementById(isMe?'myBubble':'enemyBubble').innerText = "ì‹¤ìˆ˜í–ˆë‹¤!";
                    document.getElementById(isMe?'myBubble':'enemyBubble').classList.remove('hidden');
                    resolve();
                }, 1000);
                return;
            }

            if (isMe) gameState.myCooldowns[gameState.mySelectedSkillId] = getEffectiveSkillStats(skill, level).cd + 1;

            let dmg = 0;
            let msg = "";
            let stats = { duration: 3 };

            if (skill.type === 'buff_next_crit') { buffs.nextCrit = true; msg = "ì¹˜ëª…íƒ€ ì¥ì „!"; }
            if (skill.type === 'buff_next_double') { buffs.nextDouble = true; msg = "ë§ˆë ¥ ì¦í­!"; }
            if (skill.type === 'buff_atk') { buffs.atk = stats.duration; msg = "ê³µê²©ë ¥ ì¦ê°€!"; }
            if (skill.type === 'buff_def') { buffs.def = stats.duration; msg = "ë°©ì–´ íƒœì„¸!"; }
            if (skill.type === 'buff_evasion') { buffs.evasion = stats.duration; msg = "íšŒí”¼ìœ¨ ì¦ê°€!"; }
            if (skill.type === 'buff_counter') { buffs.counter = stats.duration; msg = "ë°˜ê²© íƒœì„¸!"; }
            if (skill.type === 'buff_invuln') { buffs.invuln = 1; msg = "ë¬´ì !"; }
            if (skill.type === 'buff_aegis') { buffs.def=3; buffs.counter=3; const s=Math.floor(actor.maxHp*0.5); if(isMe) gameState.myShield+=s; else gameState.enemyShield+=s; msg="ì„±ì±„ ì „ê°œ!"; }
            if (skill.type === 'dispel') { if(isMe) { gameState.enemyShield=0; gameState.enemyBuffs={}; } else { gameState.myShield=0; gameState.myBuffs={}; } msg="ë§ˆë ¥ í•´ì œ!"; }

            if (skill.type.includes('shield')) { const s=Math.floor(actor.maxHp*(skill.type==='buff_shield_huge'?0.5:0.3)); if(isMe) gameState.myShield+=s; else gameState.enemyShield+=s; msg=`ì‰´ë“œ +${s}`; }
            if (skill.type.includes('heal')) {
                let h=0;
                if(skill.type==='buff_heal_missing') h=Math.floor((actor.maxHp-(isMe?gameState.myHp:gameState.enemyHp))*0.3);
                else h=Math.floor(actor.maxHp*0.2);
                if(isMe) gameState.myHp=Math.min(actor.maxHp, gameState.myHp+h); else gameState.enemyHp=Math.min(actor.maxHp, gameState.enemyHp+h);
                msg=`íšŒë³µ +${h}`;
            }

            if (skill.type.includes('atk')) {
                if (targetBuffs.invuln) { msg = "ë¬´ì !"; }
                else if (targetBuffs.evasion && Math.random() < 0.8) { msg = "íšŒí”¼!"; }
                else {
                    let atk = actor.atk;
                    if (buffs.atk) atk *= 1.5;
                    if (buffs.nextDouble) { atk *= 2; buffs.nextDouble = false; }
                    let def = isMe ? enemyData.def : myData.def;
                    if (targetBuffs.def) def *= 2;
                    dmg = Math.floor((atk * skill.power) - (def * 0.5));
                    if (buffs.nextCrit || (skill.type.includes('crit') && Math.random()<0.4)) { dmg *= 2; buffs.nextCrit = false; msg = "Critical!"; }
                    if (skill.type === 'atk_execute') { const hp=isMe?gameState.enemyHp:gameState.myHp; const max=isMe?enemyData.maxHp:myData.maxHp; if(hp<=max*0.3) dmg*=2; }
                    dmg = Math.max(1, dmg);

                    if (targetBuffs.counter) {
                        const reflect = Math.floor(dmg * 0.5);
                        dmg = Math.floor(dmg * 0.5);
                        if(isMe) gameState.myHp -= reflect; else gameState.enemyHp -= reflect;
                        msg = `ë°˜ê²©ë‹¹í•¨!`;
                    }
                    if (skill.type === 'atk_vampire') { const drain=Math.floor(dmg*0.5); if(isMe) gameState.myHp+=drain; else gameState.enemyHp+=drain; }

                    if(isMe) {
                        if(gameState.enemyShield >= dmg) { gameState.enemyShield -= dmg; dmg = 0; msg = "Blocked"; }
                        else { dmg -= gameState.enemyShield; gameState.enemyShield = 0; gameState.enemyHp -= dmg; }
                    } else {
                        if(gameState.myShield >= dmg) { gameState.myShield -= dmg; dmg = 0; msg = "Blocked"; }
                        else { dmg -= gameState.myShield; gameState.myShield = 0; gameState.myHp -= dmg; }
                    }
                    if(dmg > 0) animAttack(who);
                }
            }

            document.getElementById(isMe?'myBubble':'enemyBubble').innerText = msg || skill.name;
            document.getElementById(isMe?'myBubble':'enemyBubble').classList.remove('hidden');
            updateHpUI();

            ['atk','def','evasion','counter','invuln'].forEach(k => { if(buffs[k]>0) buffs[k]--; });
            setTimeout(resolve, 1500);
        });
    }

    function animAttack(who) {
        const attacker = document.getElementById(who === 'me' ? 'myImg' : 'enemyImg');
        const victim = document.getElementById(who === 'me' ? 'enemyImg' : 'myImg');
        attacker.classList.add(who==='me' ? 'anim-lunge' : 'anim-lunge-back');
        setTimeout(() => {
            victim.classList.add('anim-hit');
            attacker.classList.remove('anim-lunge', 'anim-lunge-back');
            setTimeout(() => victim.classList.remove('anim-hit'), 400);
        }, 200);
    }

    function startTimer(sec, onTimeout) {
        clearInterval(timerInterval);
        gameState.timer = sec;
        document.getElementById('timerDisplay').innerText = sec;
        timerInterval = setInterval(() => {
            gameState.timer--;
            document.getElementById('timerDisplay').innerText = gameState.timer;
            if(gameState.timer <= 0) {
                clearInterval(timerInterval);
                if(onTimeout) onTimeout();
            }
        }, 1000);
    }

    function updateHpUI() {
        const myPct = Math.max(0, (gameState.myHp / myData.maxHp) * 100);
        const enPct = Math.max(0, (gameState.enemyHp / enemyData.maxHp) * 100);
        document.getElementById('myHpBar').style.width = `${myPct}%`;
        document.getElementById('enemyHpBar').style.width = `${enPct}%`;
        document.getElementById('myHpText').innerText = `${Math.floor(gameState.myHp)}/${myData.maxHp}`;
        document.getElementById('myShieldBar').style.width = `${Math.min(100, (gameState.myShield/myData.maxHp)*100)}%`;

        let myBuffTxt = "";
        if(gameState.myBuffs.crit) myBuffTxt += "ğŸ—¡ï¸";
        if(gameState.myBuffs.invuln) myBuffTxt += "ğŸ›¡ï¸";
        if(gameState.myBuffs.evade) myBuffTxt += "ğŸ’¨";
        if(gameState.myBuffs.counter) myBuffTxt += "âš”ï¸";
        document.getElementById('myStatus').innerText = myBuffTxt;
    }

    function getEffectiveSkillStats(skill, level) {
        let cd = skill.cd;
        if (cd > 0) cd = Math.max(1, cd - Math.floor((level - 1) / 5));
        return { cd, duration: 3 };
    }

    function checkGameOver() {
        if (gameState.myHp <= 0 || gameState.enemyHp <= 0) {
            const win = gameState.myHp > 0;
            const modal = document.getElementById('resultModal');
            document.getElementById('resultTitle').innerText = win ? "VICTORY" : "DEFEAT";
            document.getElementById('resultDesc').innerText = win ? "ìƒëŒ€ë¥¼ ì œì••í–ˆìŠµë‹ˆë‹¤!" : "íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...";
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            if(channel) sb.removeChannel(channel);
            if(lobbyChannel) sb.removeChannel(lobbyChannel);
            return true;
        }
        return false;
    }

    function showCenterMsg(text, duration) {
        const el = document.getElementById('centerMsg');
        document.getElementById('centerMsgText').innerText = text;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), duration);
    }

    function createFloatingText(text, target) {
        const container = document.getElementById("playerFloatText");
        const el = document.createElement("div");
        el.className = "absolute text-white font-black text-xl stroke-black animate-float";
        el.style.textShadow = "2px 2px 0 #000";
        el.textContent = text;
        container.appendChild(el);
        setTimeout(() => el.remove(), 800);
    }
</script>
</body>
</html>