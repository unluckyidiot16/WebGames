<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Dungeon Quiz Arena (Tactics)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", sans-serif; background-color: #0f172a; color: white; height: 100vh; overflow: hidden; touch-action: manipulation; }
        .pixel-art { image-rendering: pixelated; }
        .view { display: none; height: 100%; flex-direction: column; align-items: center; justify-content: center; }
        .view.active { display: flex; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .anim-hit { animation: shake 0.4s; filter: brightness(2) sepia(1) saturate(5) hue-rotate(-50deg); }
        .anim-lunge { transition: transform 0.2s; transform: translateX(60px); }
        .anim-lunge-back { transition: transform 0.2s; transform: translateX(-60px); }

        /* ìŠ¤í‚¬ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-skill { @apply relative overflow-hidden rounded-xl border-b-4 transition-all duration-100; }
        .btn-skill:active:not(:disabled) { transform: translateY(2px); border-bottom-width: 0; }
        .btn-skill.selected { @apply border-yellow-400 ring-2 ring-yellow-400 bg-slate-600; transform: translateY(2px); border-bottom-width: 0; }

        /* í€´ì¦ˆ ë²„íŠ¼ */
        .btn-choice { background: #334155; border: 2px solid #475569; border-radius: 12px; padding: 16px; font-weight: bold; }
        .btn-choice.correct { background: #15803d; border-color: #22c55e; }
        .btn-choice.wrong { background: #b91c1c; border-color: #ef4444; }
    </style>
</head>
<body>

<section id="lobbyView" class="view active bg-slate-900">
    <h1 class="text-5xl font-black mb-1 text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-blue-600 italic">TACTICS</h1>
    <div class="text-xs text-slate-500 mb-8 font-bold tracking-widest">STRATEGIC PVP v12.0</div>

    <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700 w-full max-w-sm text-center shadow-2xl">
        <img id="myLobbyImg" src="" class="w-24 h-24 mx-auto mb-4 pixel-art drop-shadow-lg">
        <div class="text-xl font-bold mb-1" id="myLobbyName">Player</div>
        <div class="text-sm text-slate-400 mb-6">Rating: <span id="myMMR" class="text-yellow-400 font-bold">---</span></div>

        <button onclick="startMatching('ranked')" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl mb-3 shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1">
            âš”ï¸ ë­í‚¹ ë§¤ì¹­ (ëœë¤)
        </button>
        <div class="grid grid-cols-2 gap-2">
            <button onclick="showCustomRoomUI('create')" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl border-b-4 border-slate-900">ë°© ë§Œë“¤ê¸°</button>
            <button onclick="showCustomRoomUI('join')" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 rounded-xl border-b-4 border-slate-900">ë°© ì°¸ê°€</button>
        </div>
        <button onclick="goHome()" class="mt-6 text-slate-500 underline text-xs">ë‚˜ê°€ê¸°</button>
    </div>
</section>

<section id="matchingView" class="view bg-slate-900">
    <div class="text-6xl mb-6 animate-spin">â³</div>
    <h2 class="text-2xl font-bold mb-2">ë§¤ì¹­ ì¤‘...</h2>
    <p id="matchingStatus" class="text-slate-400 text-sm mb-8">ìƒëŒ€ë¥¼ ì°¾ê³  ìˆìŠµë‹ˆë‹¤.</p>

    <div id="roomUI" class="hidden w-full max-w-xs text-center">
        <div id="roomCodeDisplay" class="hidden bg-black/50 px-8 py-4 rounded-2xl mb-6 border border-white/10">
            <div class="text-xs text-slate-400 mb-1">CODE</div>
            <div class="text-4xl font-mono font-black text-yellow-400" id="roomCodeText">----</div>
        </div>
        <div id="roomJoinInput" class="hidden w-full mb-4">
            <input type="text" id="inputRoomCode" placeholder="ì½”ë“œ 4ìë¦¬" maxlength="4" class="w-full text-center text-2xl p-3 rounded-xl bg-slate-800 text-white border-2 border-slate-600 mb-2 uppercase">
            <button onclick="joinCustomRoom()" class="w-full bg-green-600 font-bold py-3 rounded-xl">ì…ì¥</button>
        </div>
    </div>
    <button onclick="cancelMatching()" class="mt-4 bg-red-500/20 text-red-400 px-8 py-2 rounded-full">ì·¨ì†Œ</button>
</section>

<section id="battleView" class="view relative bg-slate-900 justify-between pb-4 overflow-hidden">
    <div class="w-full max-w-md bg-slate-800/90 backdrop-blur p-2 flex justify-between items-center z-20 border-b border-slate-700 shadow-lg absolute top-0">
        <div class="flex flex-col">
            <div class="text-[10px] text-slate-400 font-bold">PHASE</div>
            <div class="text-xs font-bold text-yellow-400 animate-pulse" id="phaseBadge">SKILL SELECT</div>
        </div>
        <div class="flex flex-col items-center">
            <div class="text-3xl font-black text-white" id="timerDisplay">30</div>
        </div>
        <div class="flex flex-col items-end">
            <div class="text-[10px] text-slate-400 font-bold">ROUND</div>
            <div class="text-lg font-bold text-white"><span id="turnCount">1</span></div>
        </div>
    </div>

    <div class="relative w-full max-w-md flex-1 flex flex-col justify-center mt-16 mb-40">
        <div class="absolute top-4 right-6 flex flex-col items-end z-10 w-full pr-12">
            <div class="relative">
                <img id="enemyImg" src="" class="w-32 h-32 pixel-art scale-x-[-1] transition-transform duration-200">
                <div id="enemyStatus" class="absolute -top-6 right-0 flex gap-1"></div>
                <div id="enemyBubble" class="absolute top-10 -left-16 bg-white text-slate-900 text-xs font-bold px-2 py-1 rounded-lg border-2 border-red-500 hidden z-20 whitespace-nowrap">...</div>
            </div>
            <div class="w-40 bg-slate-800/90 px-2 py-1 rounded border border-slate-600 mt-2 text-right">
                <div class="text-xs text-red-400 font-bold truncate" id="enemyName">Enemy</div>
                <div class="w-full h-1.5 bg-slate-700 rounded-full mt-1 overflow-hidden">
                    <div id="enemyHpBar" class="h-full bg-red-500 w-full transition-all duration-300"></div>
                </div>
            </div>
        </div>

        <div class="absolute bottom-4 left-6 flex flex-col items-start z-10 w-full pl-12">
            <div class="w-40 bg-slate-800/90 px-2 py-1 rounded border border-blue-500/50 mb-2">
                <div class="flex justify-between items-end">
                    <span class="text-sm text-blue-300 font-bold truncate" id="myName">Me</span>
                    <span class="text-[10px] text-slate-400" id="myHpText"></span>
                </div>
                <div class="w-full h-2 bg-slate-700 rounded-full mt-1 overflow-hidden">
                    <div id="myHpBar" class="h-full bg-blue-500 w-full transition-all duration-300"></div>
                </div>
                <div class="w-full h-1 bg-transparent mt-0.5 overflow-hidden"><div id="myShieldBar" class="h-full bg-yellow-400 w-0"></div></div>
            </div>
            <div class="relative">
                <img id="myImg" src="" class="w-40 h-40 pixel-art transition-transform duration-200">
                <div id="myStatus" class="absolute -top-6 left-0 flex gap-1"></div>
                <div id="myBubble" class="absolute top-10 -right-16 bg-white text-slate-900 text-xs font-bold px-2 py-1 rounded-lg border-2 border-blue-500 hidden z-20 whitespace-nowrap">...</div>
            </div>
        </div>

        <div id="centerMsg" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-30 pointer-events-none text-center w-full px-4 hidden">
            <div class="text-4xl font-black text-white drop-shadow-[0_4px_0_#000] stroke-2" id="centerMsgText">READY</div>
        </div>
    </div>

    <div class="absolute bottom-0 w-full max-w-md bg-slate-800 rounded-t-3xl border-t border-slate-600 shadow-2xl z-40 transition-all duration-300 h-64 flex flex-col">

        <div id="skillPanel" class="flex-1 p-4 flex flex-col">
            <div class="text-center text-sm text-slate-400 mb-2 font-bold">ì´ë²ˆ í„´ì— ì‚¬ìš©í•  ê¸°ìˆ ì„ ì„ íƒí•˜ì„¸ìš”</div>
            <div id="skillGrid" class="grid grid-cols-2 gap-2 flex-1">
            </div>
            <div id="waitingMsg" class="hidden absolute inset-0 bg-slate-900/90 rounded-t-3xl flex items-center justify-center flex-col z-50">
                <div class="text-3xl animate-bounce mb-2">â³</div>
                <div class="text-yellow-400 font-bold">ìƒëŒ€ë°© ì„ íƒ ëŒ€ê¸° ì¤‘...</div>
            </div>
        </div>

        <div id="quizPanel" class="absolute inset-0 bg-slate-800 rounded-t-3xl p-5 hidden z-50">
            <div class="mb-4 text-center h-16 flex flex-col justify-center">
                <p class="text-xs text-slate-400 mb-1">ë¬¸ì œë¥¼ í’€ë©´ ê¸°ìˆ ì´ ë°œë™í•©ë‹ˆë‹¤!</p>
                <p class="text-2xl font-black text-white break-keep" id="quizQuestion">3 x 3 = ?</p>
            </div>
            <div id="quizChoices" class="grid grid-cols-2 gap-3 h-32"></div>
        </div>
    </div>
</section>

<div id="resultModal" class="fixed inset-0 bg-black/90 z-50 hidden flex-col items-center justify-center p-4">
    <div class="bg-white text-slate-900 p-8 rounded-3xl text-center max-w-sm w-full shadow-2xl animate-[bounce_0.5s]">
        <div class="text-6xl mb-4" id="resultIcon">ğŸ†</div>
        <h2 class="text-4xl font-black mb-2" id="resultTitle">WIN</h2>
        <p class="text-slate-500 mb-6 font-bold" id="resultDesc">ì ìˆ˜ +20</p>
        <button onclick="location.reload()" class="w-full bg-slate-900 text-white py-4 rounded-xl font-bold">ë¡œë¹„ë¡œ</button>
    </div>
</div>

<script>
    // ==========================================
    // 0. ì„¤ì •
    // ==========================================
    const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // âš ï¸ í•„ìˆ˜: ë³¸ì¸ URL
    const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY'; // âš ï¸ í•„ìˆ˜: ë³¸ì¸ KEY
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ==========================================
    // 1. ë°ì´í„° ì •ì˜ (ì¬í¸ì„±ëœ ìŠ¤í‚¬)
    // ==========================================

    // ìŠ¤í‚¬ DB (íƒ€ì…: normal, def, buff, ult)
    // normal: ê¸°ë³¸ê³µê²©, def: ë°©ì–´/ë°˜ê²©/íšŒí”¼, buff: ìœ í‹¸/í/ë²„í”„, ult: í•„ì‚´ê¸°
    const SKILL_DB = {
        // ê¸°ì‚¬ (íƒ±ì»¤/ë°˜ì‚¬)
        "k_atk": { name: "ë² ê¸°", type: "normal", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
        "k_def": { name: "ë°˜ê²© íƒœì„¸", type: "def_counter", power: 0, cd: 2, desc: "í”¼ê²© ì‹œ 50% ê²½ê° ë° ë°˜ì‚¬" },
        "k_util": { name: "ì‘ê¸‰ ì²˜ì¹˜", type: "buff_heal", power: 0, cd: 3, desc: "ìƒì€ ì²´ë ¥ì˜ 30% íšŒë³µ" },
        "k_ult": { name: "ì‹¬íŒì˜ ê²€", type: "ult_smite", power: 3.5, cd: 5, desc: "ê°•ë ¥í•œ ë§ˆë¬´ë¦¬ ì¼ê²©" },

        // ë„ì  (íšŒí”¼/ì¹˜ëª…)
        "r_atk": { name: "ë‹¨ê²€ íˆ¬ì²™", type: "normal", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
        "r_def": { name: "ê·¸ë¦¼ì ìˆ¨ê¸°", type: "def_evade", power: 0, cd: 3, desc: "80% í™•ë¥ ë¡œ ì™„ì „ íšŒí”¼" },
        "r_util": { name: "ë… ë°”ë¥´ê¸°", type: "buff_crit", power: 0, cd: 3, desc: "ë‹¤ìŒ ê³µê²© ì¹˜ëª…íƒ€ í™•ì •" },
        "r_ult": { name: "ì•”ì‚´", type: "ult_execute", power: 3.0, cd: 5, desc: "ì  ì²´ë ¥ 30% ì´í•˜ì‹œ 2ë°° í”¼í•´" },

        // ë§ˆë²•ì‚¬ (í­ë”œ/ë¬´ì )
        "m_atk": { name: "ë§¤ì§ ë¯¸ì‚¬ì¼", type: "normal", power: 1.0, cd: 0, desc: "ê¸°ë³¸ ê³µê²©" },
        "m_def": { name: "ì–¼ìŒ ë°©íŒ¨", type: "def_invuln", power: 0, cd: 4, desc: "ì´ë²ˆ í„´ ë¬´ì  (ë‹¤ìŒ í„´ íœ´ì‹)" },
        "m_util": { name: "ë§ˆë‚˜ ì‰´ë“œ", type: "buff_shield", power: 0, cd: 3, desc: "ì²´ë ¥ 30%ë§Œí¼ ë³´í˜¸ë§‰ ìƒì„±" },
        "m_ult": { name: "ë©”í…Œì˜¤", type: "ult_nuke", power: 4.5, cd: 6, desc: "ì´ˆëŒ€í˜• ìš´ì„ ì†Œí™˜" }
    };

    const CLASS_SKILLS = {
        "knight": ["k_atk", "k_def", "k_util", "k_ult"],
        "rogue":  ["r_atk", "r_def", "r_util", "r_ult"],
        "mage":   ["m_atk", "m_def", "m_util", "m_ult"]
    };

    // ìƒíƒœ ë³€ìˆ˜
    let myData = null, enemyData = null;
    let channel = null, isHost = false, roomId = null;
    let myUUID = localStorage.getItem("dqr_uuid") || crypto.randomUUID();
    localStorage.setItem("dqr_uuid", myUUID);

    let gameState = {
        round: 1,
        phase: 'select', // select -> quiz -> resolve
        timer: 30,
        myHp: 0, enemyHp: 0,
        myShield: 0, enemyShield: 0,
        myBuffs: {}, enemyBuffs: {}, // { counter: bool, evade: bool, invuln: bool, crit: bool }
        myCooldowns: [0,0,0,0],
        mySelectedSkillId: null,
        enemySelectedSkillId: null, // IDë§Œ ë¨¼ì € ë°›ê³  ë‚´ìš©ì€ ë‚˜ì¤‘ì—
        myAnswer: null, enemyAnswer: null,
        currentQuiz: null
    };

    let timerInterval = null;

    // ==========================================
    // 2. ì´ˆê¸°í™” ë° ë§¤ì¹­
    // ==========================================
    window.onload = async () => {
        // ê°„ë‹¨ ë¡œë¹„ ì„¸íŒ…
        const raw = localStorage.getItem("qz_rpg_v105_data");
        let cid = "knight";
        if(raw) cid = JSON.parse(raw).selectedClass;

        myData = {
            id: myUUID,
            classId: cid,
            sprite: `./png/${cid}.png`, // ì´ë¯¸ì§€ ê²½ë¡œ ê°€ì •
            skills: CLASS_SKILLS[cid].map(id => ({ ...SKILL_DB[id], id }))
        };
        // í‘ê¸°ì‚¬ ìŠ¤í‚¨ ë“± ì˜ˆì™¸ ì²˜ë¦¬ ìƒëµ (ê¸°ë³¸ë§Œ)

        document.getElementById('myLobbyImg').src = myData.sprite;
        document.getElementById('myLobbyName').innerText = cid.toUpperCase();
    };

    function startMatching(mode) {
        document.getElementById('lobbyView').classList.remove('active');
        document.getElementById('matchingView').classList.add('active');
        document.getElementById('roomUI').classList.add('hidden'); // ì»¤ìŠ¤í…€ UI ìˆ¨ê¹€

        channel = supabase.channel('global_lobby_v4');
        channel.on('presence', { event: 'sync' }, () => {
            const users = Object.values(channel.presenceState()).flat();
            const opponent = users.find(u => u.id !== myData.id && u.status === 'searching');
            if (opponent && myData.id > opponent.id) {
                const room = `btl_${myData.id}_${opponent.id}`;
                channel.send({ type: 'broadcast', event: 'match', payload: { room, host: myData.id } });
                joinRoom(room, true);
            }
        }).on('broadcast', { event: 'match' }, ({ payload }) => {
            if (payload.room.includes(myData.id)) joinRoom(payload.room, payload.host === myData.id);
        }).subscribe(async (s) => {
            if(s==='SUBSCRIBED') await channel.track({ id: myData.id, status: 'searching' });
        });
    }

    // ì»¤ìŠ¤í…€ ë°© ë¡œì§ì€ ê¸°ì¡´ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµ (startMatchingê³¼ ìœ ì‚¬)
    function showCustomRoomUI(mode) {
        document.getElementById('lobbyView').classList.remove('active');
        document.getElementById('matchingView').classList.add('active');
        document.getElementById('roomUI').classList.remove('hidden');
        if(mode==='create') {
            const code = Math.floor(1000+Math.random()*9000);
            document.getElementById('roomCodeText').innerText = code;
            document.getElementById('roomCodeDisplay').classList.remove('hidden');
            channel = supabase.channel(`room_${code}`);
            channel.on('presence', {event:'join'}, ({newPresences}) => {
                newPresences.forEach(p => { if(p.id !== myData.id) joinRoom(`room_${code}`, true); });
            }).subscribe(async (s) => { if(s==='SUBSCRIBED') await channel.track({id:myData.id}); });
        } else {
            document.getElementById('roomCodeDisplay').classList.add('hidden');
            document.getElementById('roomJoinInput').classList.remove('hidden');
        }
    }
    function joinCustomRoom() {
        const code = document.getElementById('inputRoomCode').value;
        channel = supabase.channel(`room_${code}`);
        channel.subscribe(async(s)=>{ if(s==='SUBSCRIBED'){ await channel.track({id:myData.id}); joinRoom(`room_${code}`, false); }});
    }
    function cancelMatching() { if(channel) supabase.removeChannel(channel); location.reload(); }

    function joinRoom(room, host) {
        if(channel) supabase.removeChannel(channel);
        roomId = room; isHost = host;
        channel = supabase.channel(room);

        channel
            .on('broadcast', { event: 'ready' }, ({ payload }) => { if (payload.id !== myData.id) { enemyData = payload; startBattle(); } })
            .on('broadcast', { event: 'skill_selected' }, ({ payload }) => { if(payload.id !== myData.id) checkSkillPhaseEnd(payload); })
            .on('broadcast', { event: 'quiz_start' }, ({ payload }) => { startQuizPhase(payload); })
            .on('broadcast', { event: 'submit_answer' }, ({ payload }) => { if(payload.id !== myData.id) { gameState.enemyAnswer = payload; checkQuizEnd(); } });

        channel.subscribe(async (s) => {
            if(s==='SUBSCRIBED') {
                // ë°¸ëŸ°ìŠ¤: ë ˆë²¨ 30 ê³ ì • ìŠ¤íƒ¯
                const base = { hp: 100, atk: 15, def: 5 }; // ê¸°ë³¸
                if(myData.classId==='knight') { base.hp=120; base.atk=12; base.def=10; }
                if(myData.classId==='rogue') { base.hp=90; base.atk=18; base.def=5; }
                if(myData.classId==='mage') { base.hp=80; base.atk=22; base.def=3; }

                // PvP ì²´ë ¥ ë»¥íŠ€ê¸° (x5)
                myData.maxHp = base.hp * 5;
                myData.atk = base.atk * 3; // ê³µê²©ë ¥ë„ ì•½ê°„ ë³´ì •
                myData.def = base.def * 2;

                channel.send({ type: 'broadcast', event: 'ready', payload: myData });
            }
        });
    }

    // ==========================================
    // 3. ì „íˆ¬ ë£¨í”„ (Select -> Quiz -> Resolve)
    // ==========================================
    function startBattle() {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById('battleView').classList.add('active');

        // UI ì´ˆê¸°í™”
        document.getElementById('myImg').src = myData.sprite;
        document.getElementById('enemyImg').src = enemyData.sprite;
        document.getElementById('myName').innerText = myData.classId;
        document.getElementById('enemyName').innerText = enemyData.classId;

        gameState.myHp = myData.maxHp;
        gameState.enemyHp = enemyData.maxHp;
        updateHpUI();

        startSkillPhase();
    }

    // --- PHASE 1: SKILL SELECT (30s) ---
    function startSkillPhase() {
        gameState.phase = 'select';
        gameState.mySelectedSkillId = null;
        gameState.enemySelectedSkillId = null;
        gameState.myAnswer = null;
        gameState.enemyAnswer = null;

        document.getElementById('phaseBadge').innerText = "SKILL SELECT";
        document.getElementById('phaseBadge').className = "text-xs font-bold text-green-400 animate-pulse";
        document.getElementById('skillPanel').classList.remove('hidden');
        document.getElementById('quizPanel').classList.add('hidden');
        document.getElementById('waitingMsg').classList.add('hidden');
        document.getElementById('myBubble').classList.add('hidden');
        document.getElementById('enemyBubble').classList.add('hidden');

        // ì¿¨íƒ€ì„ ê°ì†Œ (ë¼ìš´ë“œ ì‹œì‘ ì‹œ)
        gameState.myCooldowns = gameState.myCooldowns.map(c => Math.max(0, c - 1));

        renderSkills();
        startTimer(30, autoSelectSkill);
    }

    function renderSkills() {
        const grid = document.getElementById('skillGrid');
        grid.innerHTML = "";

        myData.skills.forEach((skill, idx) => {
            const btn = document.createElement('button');
            const cd = gameState.myCooldowns[idx];
            btn.className = `btn-skill bg-slate-700 p-3 text-left ${cd > 0 ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-600'} border-b-slate-900`;
            btn.innerHTML = `
                <div class="text-xs font-bold text-white">${skill.name}</div>
                <div class="text-[10px] text-slate-400">${skill.desc}</div>
                ${cd > 0 ? `<div class="absolute inset-0 bg-black/60 flex items-center justify-center font-bold text-white">${cd}</div>` : ''}
            `;
            btn.disabled = cd > 0;
            btn.onclick = () => selectSkill(idx);
            grid.appendChild(btn);
        });
    }

    function selectSkill(idx) {
        if (gameState.phase !== 'select' || gameState.mySelectedSkillId !== null) return;

        gameState.mySelectedSkillId = idx;
        const skill = myData.skills[idx];

        // UI í”¼ë“œë°±
        const btns = document.querySelectorAll('.btn-skill');
        btns.forEach((b, i) => {
            if (i === idx) b.classList.add('selected');
            else b.disabled = true;
        });

        document.getElementById('waitingMsg').classList.remove('hidden');

        // ì„œë²„ ì „ì†¡ (IDë§Œ ë³´ëƒ„)
        channel.send({ type: 'broadcast', event: 'skill_selected', payload: { id: myData.id, skillIdx: idx } });

        // ì‹±ê¸€ í…ŒìŠ¤íŠ¸ìš© (ìƒëŒ€ ì—†ìœ¼ë©´ ë°”ë¡œ ì§„í–‰) - ì‹¤ì œì—ì„  ì œê±° ê°€ëŠ¥
        // checkSkillPhaseEnd(); 
    }

    function autoSelectSkill() {
        if (gameState.mySelectedSkillId === null) {
            // ì‚¬ìš© ê°€ëŠ¥í•œ ìŠ¤í‚¬ ì¤‘ ëœë¤
            const available = myData.skills.map((_, i) => i).filter(i => gameState.myCooldowns[i] === 0);
            const pick = available.length > 0 ? available[Math.floor(Math.random() * available.length)] : 0; // 0ë²ˆ(í‰íƒ€)ì€ ì¿¨ 0 ë³´ì¥
            selectSkill(pick);
        }
    }

    function checkSkillPhaseEnd(payload) {
        if (payload) gameState.enemySelectedSkillId = payload.skillIdx;

        if (gameState.mySelectedSkillId !== null && gameState.enemySelectedSkillId !== null) {
            clearInterval(timerInterval);
            if (isHost) {
                // í€´ì¦ˆ ìƒì„± í›„ ì „ì†¡
                const n1 = Math.floor(Math.random()*8)+2, n2 = Math.floor(Math.random()*9)+1;
                const ans = n1*n2;
                const choices = new Set([ans]);
                while(choices.size < 4) choices.add(ans + (Math.floor(Math.random()*5)-2)*10);

                const quiz = { q: `${n1} Ã— ${n2} = ?`, a: ans, choices: Array.from(choices).sort(()=>Math.random()-0.5) };
                channel.send({ type: 'broadcast', event: 'quiz_start', payload: quiz });
                startQuizPhase(quiz);
            }
        }
    }

    // --- PHASE 2: QUIZ (10s) ---
    function startQuizPhase(quiz) {
        gameState.phase = 'quiz';
        gameState.currentQuiz = quiz;

        document.getElementById('phaseBadge').innerText = "QUIZ TIME";
        document.getElementById('phaseBadge').className = "text-xs font-bold text-yellow-400 animate-bounce";
        document.getElementById('skillPanel').classList.add('hidden');
        document.getElementById('quizPanel').classList.remove('hidden');

        // í€´ì¦ˆ ë Œë”ë§
        document.getElementById('quizQuestion').innerText = quiz.q;
        const grid = document.getElementById('quizChoices');
        grid.innerHTML = "";
        quiz.choices.forEach(c => {
            const btn = document.createElement('button');
            btn.className = "btn-choice text-white";
            btn.innerText = c;
            btn.onclick = () => submitAnswer(c);
            grid.appendChild(btn);
        });

        startTimer(10, () => submitAnswer(-999)); // íƒ€ì„ì•„ì›ƒ ì˜¤ë‹µ
    }

    function submitAnswer(val) {
        if (gameState.myAnswer) return;
        const correct = val === gameState.currentQuiz.a;
        gameState.myAnswer = { correct, val };

        // UI ì ê¸ˆ
        const btns = document.querySelectorAll('.btn-choice');
        btns.forEach(b => {
            b.disabled = true;
            if(parseInt(b.innerText)===val) b.classList.add(correct?'correct':'wrong');
        });

        document.getElementById('myBubble').innerText = "ì œì¶œ ì™„ë£Œ!";
        document.getElementById('myBubble').classList.remove('hidden');

        channel.send({ type: 'broadcast', event: 'submit_answer', payload: { id: myData.id, correct } });
        checkQuizEnd();
    }

    function checkQuizEnd() {
        if (gameState.myAnswer && gameState.enemyAnswer) {
            clearInterval(timerInterval);
            setTimeout(resolveRound, 1000);
        }
    }

    // --- PHASE 3: RESOLVE (Animation) ---
    async function resolveRound() {
        gameState.phase = 'resolve';
        document.getElementById('quizPanel').classList.add('hidden');
        document.getElementById('myBubble').classList.add('hidden');
        document.getElementById('enemyBubble').classList.add('hidden');
        document.getElementById('phaseBadge').innerText = "BATTLE";
        document.getElementById('phaseBadge').className = "text-xs font-bold text-red-500";

        // ì„ ê³µ ê²°ì • (ëœë¤ì´ ì•„ë‹Œ, ì •ë‹µì ìš°ì„ ? í˜¹ì€ ë¼ìš´ë“œ í™€ì§? ì—¬ê¸°ì„  í™€ì§)
        const meFirst = (gameState.round % 2 !== 0) === isHost; // í™€ìˆ˜: í˜¸ìŠ¤íŠ¸ ì„ ê³µ

        // 1. ì„ ê³µ ì•¡ì…˜
        await executeAction(meFirst ? 'me' : 'enemy');
        if (checkGameOver()) return;

        // 2. í›„ê³µ ì•¡ì…˜
        await executeAction(meFirst ? 'enemy' : 'me');
        if (checkGameOver()) return;

        // 3. ì¢…ë£Œ ë° ë‹¤ìŒ ë¼ìš´ë“œ
        gameState.round++;
        document.getElementById('turnCount').innerText = gameState.round;

        // ë²„í”„ í„´ ê°ì†Œ ë“± ì²˜ë¦¬ í•„ìš”í•˜ì§€ë§Œ ì—¬ê¸°ì„  ìƒëµ(ë‹¨ìˆœí™”)
        setTimeout(startSkillPhase, 1500);
    }

    function executeAction(who) {
        return new Promise(resolve => {
            const isMe = who === 'me';
            const actor = isMe ? myData : enemyData;
            const skillId = isMe ? actor.skills[gameState.mySelectedSkillId].id : actor.skills[gameState.enemySelectedSkillId].id;
            const skill = SKILL_DB[skillId];
            const answer = isMe ? gameState.myAnswer : gameState.enemyAnswer;
            const buffs = isMe ? gameState.myBuffs : gameState.enemyBuffs;
            const targetBuffs = isMe ? gameState.enemyBuffs : gameState.myBuffs;

            // ìŠ¤í‚¬ëª… í‘œì‹œ
            showCenterMsg(`${actor.name}: ${skill.name}!`, 1000);

            // ìƒíƒœì´ìƒ: ë‹¤ìŒ í„´ íœ´ì‹(ì–¼ìŒ ë°©íŒ¨ í˜ë„í‹°) ë“± êµ¬í˜„ ê°€ëŠ¥
            // ì—¬ê¸°ì„  ì‹¬í”Œí•˜ê²Œ: ì˜¤ë‹µì´ë©´ ì‹¤íŒ¨
            if (!answer.correct) {
                setTimeout(() => {
                    document.getElementById(isMe?'myBubble':'enemyBubble').innerText = "ì‹¤ìˆ˜í–ˆë‹¤!";
                    document.getElementById(isMe?'myBubble':'enemyBubble').classList.remove('hidden');
                    resolve();
                }, 1000);
                return;
            }

            // ì¿¨íƒ€ì„ ì ìš© (ë‚´ ê²ƒë§Œ)
            if (isMe) gameState.myCooldowns[gameState.mySelectedSkillId] = skill.cd + 1; // +1ì€ ì´ë²ˆ í„´ ì†Œëª¨ í¬í•¨

            // ë¡œì§ ì‹¤í–‰ (ê°€ìœ„ë°”ìœ„ë³´ ìƒì„±)
            // ë°©ì–´ ê³„ì—´: ë°ë¯¸ì§€ ê²½ê°/íšŒí”¼ ì¤€ë¹„ (ì´ë¯¸ í™œì„±í™”ëœ ë²„í”„ê°€ ì•„ë‹˜, ì¦‰ë°œì„±)
            // ê³µê²© ê³„ì—´: ë°ë¯¸ì§€ ê³„ì‚°

            let dmg = 0;
            let msg = "";

            if (skill.type.includes('def_')) {
                if (skill.type === 'def_counter') { buffs.counter = true; msg = "ë°˜ê²© ì¤€ë¹„!"; }
                if (skill.type === 'def_evade') { buffs.evade = true; msg = "íšŒí”¼ ì¤€ë¹„!"; }
                if (skill.type === 'def_invuln') { buffs.invuln = true; msg = "ë¬´ì !"; }
            } else if (skill.type.includes('buff_')) {
                if (skill.type === 'buff_shield') {
                    const amt = Math.floor(actor.maxHp * 0.3);
                    if(isMe) gameState.myShield += amt; else gameState.enemyShield += amt;
                    msg = `ì‰´ë“œ +${amt}`;
                }
                if (skill.type === 'buff_heal') {
                    const amt = Math.floor((actor.maxHp - (isMe?gameState.myHp:gameState.enemyHp)) * 0.3); // ìƒì€ì²´ë ¥ ë¹„ë¡€
                    if(isMe) gameState.myHp += amt; else gameState.enemyHp += amt;
                    msg = `íšŒë³µ +${amt}`;
                }
                if (skill.type === 'buff_crit') { buffs.crit = true; msg = "ì¹˜ëª…íƒ€ ì¥ì „!"; }
            } else {
                // ê³µê²© ìŠ¤í‚¬
                let finalAtk = actor.atk * skill.power;
                if (buffs.crit) { finalAtk *= 2; buffs.crit = false; msg = "Critical!"; }

                // ìƒëŒ€ ë°©ì–´ ìŠ¤í‚¬ ì²´í¬
                if (targetBuffs.invuln) {
                    dmg = 0; msg = "ë°ë¯¸ì§€ ë¬´íš¨!"; targetBuffs.invuln = false; // 1íšŒìš©
                } else if (targetBuffs.evade) {
                    if (Math.random() < 0.8) { dmg = 0; msg = "íšŒí”¼í•¨!"; }
                    else { dmg = Math.floor(finalAtk); msg = "íšŒí”¼ ì‹¤íŒ¨!"; }
                    targetBuffs.evade = false;
                } else if (targetBuffs.counter) {
                    dmg = Math.floor(finalAtk * 0.5); // 50% ê²½ê°
                    // ë°˜ì‚¬ ë°ë¯¸ì§€
                    const reflect = Math.floor(finalAtk * 0.5);
                    if(isMe) gameState.myHp -= reflect; else gameState.enemyHp -= reflect;
                    msg = `ë°˜ê²©ë‹¹í•¨ -${reflect}`;
                    targetBuffs.counter = false;
                } else {
                    // ì¼ë°˜ í”¼ê²©
                    let defense = (isMe ? enemyData.def : myData.def);
                    dmg = Math.max(1, Math.floor(finalAtk - defense * 0.5));
                }
            }

            // ë°ë¯¸ì§€ ì ìš©
            if (dmg > 0) {
                // ì‰´ë“œ ì°¨ê°
                if (isMe) {
                    if (gameState.enemyShield > 0) {
                        if (gameState.enemyShield >= dmg) { gameState.enemyShield -= dmg; dmg = 0; msg = "Blocked"; }
                        else { dmg -= gameState.enemyShield; gameState.enemyShield = 0; }
                    }
                    gameState.enemyHp -= dmg;
                } else {
                    if (gameState.myShield > 0) {
                        if (gameState.myShield >= dmg) { gameState.myShield -= dmg; dmg = 0; msg = "Blocked"; }
                        else { dmg -= gameState.myShield; gameState.myShield = 0; }
                    }
                    gameState.myHp -= dmg;
                }

                // ì• ë‹ˆë©”ì´ì…˜
                animAttack(who);
            }

            document.getElementById(isMe?'myBubble':'enemyBubble').innerText = msg || skill.name;
            document.getElementById(isMe?'myBubble':'enemyBubble').classList.remove('hidden');
            updateHpUI();

            setTimeout(resolve, 1500);
        });
    }

    function animAttack(who) {
        const attacker = document.getElementById(who === 'me' ? 'myImg' : 'enemyImg');
        const victim = document.getElementById(who === 'me' ? 'enemyImg' : 'myImg');
        attacker.classList.add(who==='me' ? 'anim-lunge' : 'anim-lunge-back');
        setTimeout(() => {
            victim.classList.add('anim-hit');
            attacker.classList.remove('anim-lunge', 'anim-lunge-back');
            setTimeout(() => victim.classList.remove('anim-hit'), 400);
        }, 200);
    }

    // ==========================================
    // ìœ í‹¸
    // ==========================================
    function startTimer(sec, onTimeout) {
        clearInterval(timerInterval);
        gameState.timer = sec;
        document.getElementById('timerDisplay').innerText = sec;
        timerInterval = setInterval(() => {
            gameState.timer--;
            document.getElementById('timerDisplay').innerText = gameState.timer;
            if(gameState.timer <= 0) {
                clearInterval(timerInterval);
                if(onTimeout) onTimeout();
            }
        }, 1000);
    }

    function updateHpUI() {
        const myPct = Math.max(0, (gameState.myHp / myData.maxHp) * 100);
        const enPct = Math.max(0, (gameState.enemyHp / enemyData.maxHp) * 100);
        document.getElementById('myHpBar').style.width = `${myPct}%`;
        document.getElementById('enemyHpBar').style.width = `${enPct}%`;
        document.getElementById('myHpText').innerText = `${Math.floor(gameState.myHp)}/${myData.maxHp}`;

        document.getElementById('myShieldBar').style.width = `${Math.min(100, (gameState.myShield/myData.maxHp)*100)}%`;

        // ë²„í”„ í‘œì‹œ
        let myBuffTxt = "";
        if(gameState.myBuffs.crit) myBuffTxt += "ğŸ—¡ï¸";
        if(gameState.myBuffs.invuln) myBuffTxt += "ğŸ›¡ï¸";
        if(gameState.myBuffs.evade) myBuffTxt += "ğŸ’¨";
        if(gameState.myBuffs.counter) myBuffTxt += "âš”ï¸";
        document.getElementById('myStatus').innerText = myBuffTxt;
    }

    function checkGameOver() {
        if (gameState.myHp <= 0 || gameState.enemyHp <= 0) {
            const win = gameState.myHp > 0;
            const modal = document.getElementById('resultModal');
            document.getElementById('resultTitle').innerText = win ? "VICTORY" : "DEFEAT";
            document.getElementById('resultDesc').innerText = win ? "ìƒëŒ€ë¥¼ ì œì••í–ˆìŠµë‹ˆë‹¤!" : "íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...";
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            if(channel) supabase.removeChannel(channel);
            return true;
        }
        return false;
    }

    function showCenterMsg(text, duration) {
        const el = document.getElementById('centerMsg');
        document.getElementById('centerMsgText').innerText = text;
        el.classList.remove('hidden');
        setTimeout(() => el.classList.add('hidden'), duration);
    }

    function goHome() { location.href = "DQR.html"; }
</script>
</body>
</html>