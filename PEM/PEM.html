<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ì¼“ ì—ë“€ ë©”ì´ì»¤ (PokeEdu Maker)</title>
    <!-- Tailwind CSS for Styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Pixel Style -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f4f8;
            touch-action: manipulation; /* ëª¨ë°”ì¼ í„°ì¹˜ ìµœì í™” */
        }
        .pixel-font {
            font-family: 'Press Start 2P', cursive;
        }
        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .screen.active {
            display: flex;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Poke Animation */
        .poke-sprite {
            image-rendering: pixelated;
            transition: transform 0.2s;
        }
        .bounce { animation: bounce 1s infinite; }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            50% { transform: translateX(10px); }
            75% { transform: translateX(-10px); }
            100% { transform: translateX(0); }
        }
        .attack-anim { animation: lunge 0.3s; }
        @keyframes lunge {
            0% { transform: translateX(0); }
            50% { transform: translateX(50px); }
            100% { transform: translateX(0); }
        }

        /* Gauge Bars */
        .stat-bar-bg {
            background-color: #e2e8f0;
            border-radius: 9999px;
            overflow: hidden;
            height: 12px;
        }
        .stat-bar-fill {
            height: 100%;
            transition: width 0.5s ease-out;
        }

        /* Card Styles */
        .game-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-width: 480px;
            width: 100%;
            margin: 0 auto;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

<!-- === GAME CONTAINER === -->
<div id="game-container" class="game-card relative min-h-[700px] flex flex-col">

    <!-- 1. TITLE SCREEN -->
    <div id="screen-title" class="screen active flex-col items-center justify-center h-full absolute inset-0 bg-blue-50 z-50">
        <h1 class="text-3xl font-bold text-blue-600 mb-2 pixel-font text-center leading-tight">Poke<br>Edu Maker</h1>
        <p class="text-gray-600 mb-8 text-sm">í€´ì¦ˆë¡œ í‚¤ìš°ëŠ” ë‚˜ë§Œì˜ íŒŒíŠ¸ë„ˆ</p>

        <div class="flex gap-4 mb-8">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png" class="w-16 h-16 animate-bounce">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png" class="w-16 h-16 animate-bounce" style="animation-delay: 0.1s">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png" class="w-16 h-16 animate-bounce" style="animation-delay: 0.2s">
        </div>

        <button onclick="Game.startNewGame()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 mb-4 w-64">
            ìƒˆ ê²Œì„ ì‹œì‘
        </button>
        <button onclick="Game.loadGame()" id="btn-load" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 px-8 rounded-full shadow transform transition hover:scale-105 w-64 hidden">
            ì´ì–´í•˜ê¸°
        </button>
        <p class="text-xs text-gray-400 mt-8">Ver 0.1.0 MVP Test</p>
    </div>

    <!-- 2. SELECT STARTER -->
    <div id="screen-select" class="screen flex-col h-full bg-white p-6 absolute inset-0 z-40">
        <h2 class="text-xl font-bold text-center mb-6">íŒŒíŠ¸ë„ˆë¥¼ ì„ íƒí•˜ì„¸ìš”</h2>
        <div class="grid grid-cols-1 gap-4 flex-1 overflow-y-auto">
            <!-- Bulbasaur -->
            <div onclick="Game.chooseStarter('grass')" class="border-2 border-green-100 hover:border-green-500 rounded-xl p-4 flex items-center cursor-pointer transition bg-green-50">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png" class="w-20 h-20 bg-white rounded-full p-1 mr-4 shadow-sm">
                <div>
                    <h3 class="font-bold text-green-800">ì´ìƒí•´ì”¨ (í’€)</h3>
                    <p class="text-xs text-green-600 mt-1">ê· í˜•ì¡íŒ ì„±ì¥í˜•</p>
                    <p class="text-xs text-gray-500 mt-1">íŠ¹ê¸°: ê³¼í•™/ì‚¬íšŒ (ë°©ì–´)</p>
                </div>
            </div>
            <!-- Charmander -->
            <div onclick="Game.chooseStarter('fire')" class="border-2 border-red-100 hover:border-red-500 rounded-xl p-4 flex items-center cursor-pointer transition bg-red-50">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png" class="w-20 h-20 bg-white rounded-full p-1 mr-4 shadow-sm">
                <div>
                    <h3 class="font-bold text-red-800">íŒŒì´ë¦¬ (ë¶ˆ)</h3>
                    <p class="text-xs text-red-600 mt-1">ê³µê²© íŠ¹í™”í˜•</p>
                    <p class="text-xs text-gray-500 mt-1">íŠ¹ê¸°: ìˆ˜í•™ (ê³µê²©)</p>
                </div>
            </div>
            <!-- Squirtle -->
            <div onclick="Game.chooseStarter('water')" class="border-2 border-blue-100 hover:border-blue-500 rounded-xl p-4 flex items-center cursor-pointer transition bg-blue-50">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png" class="w-20 h-20 bg-white rounded-full p-1 mr-4 shadow-sm">
                <div>
                    <h3 class="font-bold text-blue-800">ê¼¬ë¶€ê¸° (ë¬¼)</h3>
                    <p class="text-xs text-blue-600 mt-1">ê¸°ìˆ /ì§‘ì¤‘í˜•</p>
                    <p class="text-xs text-gray-500 mt-1">íŠ¹ê¸°: êµ­ì–´/ì˜ì–´ (ìŠ¤í‚¬)</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. MAIN HUB (WEEKLY VIEW) -->
    <div id="screen-main" class="screen flex-col h-full bg-slate-50 relative z-30">
        <!-- Header -->
        <div class="bg-white p-4 shadow-sm flex justify-between items-center">
            <div>
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider">Season 1</span>
                <h2 class="text-lg font-bold" id="main-week-display">1ì£¼ì°¨</h2>
            </div>
            <div class="text-right">
                <div class="text-xs text-gray-500">í”¼ë¡œë„</div>
                <div class="w-24 stat-bar-bg bg-gray-200 mt-1">
                    <div id="main-fatigue-bar" class="stat-bar-fill bg-orange-400" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Pokemon Status Area -->
        <div class="flex-1 flex flex-col items-center justify-center p-6 bg-gradient-to-b from-white to-slate-50">
            <div class="relative">
                <img id="main-poke-img" src="" class="w-40 h-40 object-contain bounce drop-shadow-xl">
                <div id="main-emotion-bubble" class="absolute -top-2 -right-6 bg-white px-3 py-1 rounded-full text-xs shadow border border-gray-200 animate-pulse">
                    íŒŒì´íŒ…!
                </div>
            </div>
            <h3 id="main-poke-name" class="text-xl font-bold mt-4 text-gray-800">ì´ë¦„</h3>
            <div class="grid grid-cols-2 gap-x-8 gap-y-2 mt-6 w-full max-w-xs">
                <div>
                    <div class="text-xs text-gray-400">ATK (ìˆ˜í•™)</div>
                    <div class="text-sm font-bold text-red-600" id="stat-atk">0</div>
                </div>
                <div>
                    <div class="text-xs text-gray-400">DEF (ê³¼í•™)</div>
                    <div class="text-sm font-bold text-green-600" id="stat-def">0</div>
                </div>
                <div>
                    <div class="text-xs text-gray-400">SPD (ë°˜ì‘)</div>
                    <div class="text-sm font-bold text-blue-600" id="stat-spd">0</div>
                </div>
                <div>
                    <div class="text-xs text-gray-400">SKL (ì–¸ì–´)</div>
                    <div class="text-sm font-bold text-purple-600" id="stat-skl">0</div>
                </div>
            </div>
        </div>

        <!-- Schedule Planner -->
        <div class="bg-white p-6 rounded-t-3xl shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
            <h4 class="text-sm font-bold text-gray-600 mb-4 flex justify-between items-center">
                <span>ì´ë²ˆ ì£¼ ìŠ¤ì¼€ì¤„</span>
                <span class="text-xs text-blue-500 font-normal">í„°ì¹˜í•˜ì—¬ ë³€ê²½</span>
            </h4>
            <div class="flex justify-between gap-2 mb-6">
                <button onclick="Game.toggleSchedule(0)" id="sched-0" class="flex-1 aspect-square rounded-xl bg-gray-100 flex flex-col items-center justify-center border-2 border-transparent hover:border-blue-300 transition relative">
                    <span class="text-2xl mb-1">â•</span>
                    <span class="text-xs font-bold text-gray-500">ì„ íƒ</span>
                </button>
                <button onclick="Game.toggleSchedule(1)" id="sched-1" class="flex-1 aspect-square rounded-xl bg-gray-100 flex flex-col items-center justify-center border-2 border-transparent hover:border-blue-300 transition relative">
                    <span class="text-2xl mb-1">â•</span>
                    <span class="text-xs font-bold text-gray-500">ì„ íƒ</span>
                </button>
                <button onclick="Game.toggleSchedule(2)" id="sched-2" class="flex-1 aspect-square rounded-xl bg-gray-100 flex flex-col items-center justify-center border-2 border-transparent hover:border-blue-300 transition relative">
                    <span class="text-2xl mb-1">â•</span>
                    <span class="text-xs font-bold text-gray-500">ì„ íƒ</span>
                </button>
            </div>
            <button onclick="Game.startWeek()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transition flex justify-center items-center gap-2">
                <span>í›ˆë ¨ ì‹œì‘í•˜ê¸°</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            </button>
        </div>
    </div>

    <!-- 4. QUIZ SCREEN -->
    <div id="screen-quiz" class="screen flex-col h-full bg-indigo-900 text-white relative z-50 p-6">
        <div class="flex justify-between items-center mb-8">
            <span id="quiz-subject-badge" class="bg-indigo-700 px-3 py-1 rounded text-xs font-bold text-indigo-200">ìˆ˜í•™ í›ˆë ¨ ì¤‘</span>
            <span id="quiz-timer" class="text-xl font-mono text-yellow-400">10.0s</span>
        </div>

        <div class="flex-1 flex flex-col justify-center">
            <div class="bg-white/10 backdrop-blur-sm p-6 rounded-2xl mb-8 border border-white/20">
                <h2 id="quiz-question" class="text-2xl font-bold text-center leading-snug">ë¬¸ì œ í…ìŠ¤íŠ¸</h2>
            </div>

            <div id="quiz-choices" class="grid grid-cols-1 gap-3">
                <!-- Buttons generated by JS -->
            </div>
        </div>

        <div class="mt-8 text-center text-indigo-400 text-sm">
            ë‚¨ì€ ë¬¸ì œ: <span id="quiz-progress">1/3</span>
        </div>
    </div>

    <!-- 5. WEEKLY RESULT -->
    <div id="screen-result" class="screen flex-col h-full bg-white p-6 justify-center z-50">
        <h2 class="text-2xl font-bold text-center mb-2">í›ˆë ¨ ê²°ê³¼</h2>
        <p class="text-center text-gray-500 mb-8" id="result-week-text">1ì£¼ì°¨ ì¢…ë£Œ</p>

        <div class="bg-gray-50 rounded-2xl p-6 mb-6">
            <div class="flex items-center gap-4 mb-4">
                <img id="result-poke-img" src="" class="w-16 h-16">
                <div>
                    <div class="font-bold text-lg" id="result-message">ì˜ í–ˆì–´ìš”!</div>
                    <div class="text-xs text-gray-400">ì„±ì¥ ê¸°ë¡</div>
                </div>
            </div>
            <hr class="border-gray-200 mb-4">
            <div class="space-y-3" id="result-stats-list">
                <!-- Stats added by JS -->
            </div>
        </div>

        <button onclick="Game.finishResult()" class="w-full bg-blue-500 text-white font-bold py-3 rounded-xl">
            í™•ì¸
        </button>
    </div>

    <!-- 6. BATTLE SCREEN -->
    <div id="screen-battle" class="screen flex-col h-full bg-gray-800 text-white z-50">
        <!-- Battle Scene -->
        <div class="h-1/2 bg-gradient-to-b from-gray-700 to-gray-800 relative overflow-hidden flex items-end justify-center pb-8 px-4">
            <!-- Enemy -->
            <div class="absolute top-8 right-8 text-right">
                <div class="text-sm font-bold text-red-300" id="enemy-name">ë¼ì´ë²Œ</div>
                <div class="w-32 bg-gray-600 h-2 mt-1 rounded-full overflow-hidden">
                    <div id="enemy-hp-bar" class="h-full bg-red-500 w-full transition-all duration-300"></div>
                </div>
            </div>
            <img id="enemy-sprite" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png" class="absolute top-16 right-12 w-24 h-24 poke-sprite">

            <!-- Player -->
            <div class="absolute bottom-24 left-8">
                <div class="text-sm font-bold text-blue-300" id="battle-player-name">ë‚˜ì˜ í¬ì¼“ëª¬</div>
                <div class="w-32 bg-gray-600 h-2 mt-1 rounded-full overflow-hidden">
                    <div id="player-hp-bar" class="h-full bg-green-500 w-full transition-all duration-300"></div>
                </div>
            </div>
            <img id="battle-player-sprite" src="" class="absolute bottom-8 left-12 w-32 h-32 poke-sprite scale-x-[-1]">

            <!-- VFX Container -->
            <div id="battle-vfx" class="absolute inset-0 pointer-events-none flex items-center justify-center text-4xl font-bold opacity-0">ğŸ’¥</div>
        </div>

        <!-- Battle Text / Controls -->
        <div class="h-1/2 bg-white text-gray-800 p-4 flex flex-col">
            <div id="battle-log" class="flex-1 bg-gray-100 p-4 rounded-lg mb-4 overflow-y-auto text-sm font-mono leading-relaxed border border-gray-200 shadow-inner">
                ë°°í‹€ì´ ì‹œì‘ë©ë‹ˆë‹¤!
            </div>
            <button id="battle-next-btn" onclick="Game.battleStep()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-xl shadow-lg">
                ì „íˆ¬ ì§„í–‰ (Turn)
            </button>
        </div>
    </div>

    <!-- 7. ENDING SCREEN -->
    <div id="screen-ending" class="screen flex-col h-full bg-yellow-50 p-6 items-center justify-center z-50 text-center">
        <div class="mb-6">
            <span class="text-4xl">ğŸ†</span>
        </div>
        <h1 class="text-3xl font-bold text-yellow-800 mb-2">ì¡¸ì—…ì„ ì¶•í•˜í•©ë‹ˆë‹¤!</h1>
        <p class="text-gray-600 mb-8">ëª¨ë“  ê³¼ì •ì„ í›Œë¥­í•˜ê²Œ ë§ˆì³¤ìŠµë‹ˆë‹¤.</p>

        <img id="ending-img" src="" class="w-40 h-40 mb-6 mx-auto animate-bounce">

        <div class="bg-white p-6 rounded-xl shadow-md w-full mb-6 text-left">
            <h3 class="font-bold text-gray-800 border-b pb-2 mb-2">ì„±ì í‘œ</h3>
            <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-500">ìµœì¢… ë­í¬</span>
                <span class="font-bold text-blue-600" id="ending-rank">A</span>
            </div>
            <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-500">ì´ ì •ë‹µ ìˆ˜</span>
                <span class="font-bold" id="ending-score">0</span>
            </div>
            <div class="flex justify-between text-sm">
                <span class="text-gray-500">ì£¼ë ¥ ìŠ¤íƒ¯</span>
                <span class="font-bold" id="ending-top-stat">-</span>
            </div>
        </div>

        <button onclick="location.reload()" class="bg-blue-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-blue-600 transition">
            ë©”ì¸ í™”ë©´ìœ¼ë¡œ
        </button>
    </div>

</div>

<!-- === GAME LOGIC === -->
<script>
    // --- 1. DATA & CONFIG ---
    const POKEMON_DB = {
        grass: {
            name: "ì´ìƒí•´ì”¨",
            type: "grass",
            stages: [1, 2, 3], // PokeAPI IDs
            baseStats: { atk: 3, def: 5, spd: 3, skl: 4 }
        },
        fire: {
            name: "íŒŒì´ë¦¬",
            type: "fire",
            stages: [4, 5, 6],
            baseStats: { atk: 6, def: 2, spd: 4, skl: 3 }
        },
        water: {
            name: "ê¼¬ë¶€ê¸°",
            type: "water",
            stages: [7, 8, 9],
            baseStats: { atk: 3, def: 4, spd: 3, skl: 6 }
        }
    };

    const SUBJECTS = {
        math: { name: "ìˆ˜í•™", stat: "atk", icon: "ğŸ§®", color: "text-red-600" },
        lang: { name: "êµ­ì–´/ì˜ì–´", stat: "skl", icon: "ğŸ“š", color: "text-purple-600" },
        sci: { name: "ê³¼í•™/ì‚¬íšŒ", stat: "def", icon: "ğŸ”¬", color: "text-green-600" },
        rest: { name: "íœ´ì‹", stat: "rest", icon: "ğŸ›Œ", color: "text-blue-500" }
    };

    const SUBJECT_KEYS = ["math", "lang", "sci", "rest"];

    // --- 2. STATE MANAGEMENT ---
    const Game = {
        state: {
            starterType: null,
            pokemon: {
                name: "",
                stageIdx: 0, // 0: basic, 1: mid, 2: final
                stats: { atk: 0, def: 0, spd: 0, skl: 0, hp: 100 },
                fatigue: 0,
                exp: 0
            },
            week: 1,
            maxWeeks: 8, // Total duration
            schedule: [null, null, null], // 3 slots
            player: {
                totalCorrect: 0,
                totalQuestions: 0
            },
            currentBattle: null
        },

        // --- Initialization ---
        init: function() {
            this.showScreen('screen-title');
            if(localStorage.getItem('pokeEduSave')) {
                document.getElementById('btn-load').classList.remove('hidden');
            }
        },

        startNewGame: function() {
            localStorage.removeItem('pokeEduSave');
            this.state.week = 1;
            this.state.pokemon.stageIdx = 0;
            this.state.pokemon.fatigue = 0;
            this.state.player.totalCorrect = 0;
            this.showScreen('screen-select');
        },

        loadGame: function() {
            const saved = localStorage.getItem('pokeEduSave');
            if(saved) {
                this.state = JSON.parse(saved);
                this.renderMainHub();
                this.showScreen('screen-main');
            }
        },

        saveGame: function() {
            localStorage.setItem('pokeEduSave', JSON.stringify(this.state));
        },

        // --- Selection & Setup ---
        chooseStarter: function(type) {
            this.state.starterType = type;
            const base = POKEMON_DB[type];
            this.state.pokemon.name = base.name;
            // Init stats based on base + slight random
            this.state.pokemon.stats = {
                atk: base.baseStats.atk * 2,
                def: base.baseStats.def * 2,
                spd: base.baseStats.spd * 2,
                skl: base.baseStats.skl * 2,
                hp: 50
            };
            this.renderMainHub();
            this.showScreen('screen-main');
        },

        // --- Main Hub Logic ---
        renderMainHub: function() {
            const pk = this.state.pokemon;
            const db = POKEMON_DB[this.state.starterType];
            const imgId = db.stages[pk.stageIdx];

            document.getElementById('main-week-display').innerText = `${this.state.week}ì£¼ì°¨`;
            document.getElementById('main-poke-name').innerText = pk.name;
            document.getElementById('main-poke-img').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${imgId}.png`;

            // Stats
            document.getElementById('stat-atk').innerText = Math.floor(pk.stats.atk);
            document.getElementById('stat-def').innerText = Math.floor(pk.stats.def);
            document.getElementById('stat-spd').innerText = Math.floor(pk.stats.spd);
            document.getElementById('stat-skl').innerText = Math.floor(pk.stats.skl);

            // Fatigue Bar
            const ftgPct = Math.min(100, (pk.fatigue / 50) * 100);
            document.getElementById('main-fatigue-bar').style.width = `${ftgPct}%`;
            document.getElementById('main-fatigue-bar').className = `stat-bar-fill ${ftgPct > 70 ? 'bg-red-500' : 'bg-green-400'}`;

            // Reset Schedule UI
            this.state.schedule = [null, null, null];
            for(let i=0; i<3; i++) {
                this.renderScheduleSlot(i);
            }
        },

        toggleSchedule: function(slotIdx) {
            const current = this.state.schedule[slotIdx];
            let nextIdx = 0;
            if(current) {
                const currKeyIdx = SUBJECT_KEYS.indexOf(current);
                nextIdx = (currKeyIdx + 1) % SUBJECT_KEYS.length;
            }
            this.state.schedule[slotIdx] = SUBJECT_KEYS[nextIdx];
            this.renderScheduleSlot(slotIdx);
        },

        renderScheduleSlot: function(slotIdx) {
            const key = this.state.schedule[slotIdx];
            const btn = document.getElementById(`sched-${slotIdx}`);

            if(!key) {
                btn.innerHTML = `<span class="text-2xl mb-1">â•</span><span class="text-xs text-gray-400">ì„ íƒ</span>`;
                btn.className = "flex-1 aspect-square rounded-xl bg-gray-50 flex flex-col items-center justify-center border-2 border-dashed border-gray-300";
            } else {
                const subj = SUBJECTS[key];
                btn.innerHTML = `<span class="text-3xl mb-1">${subj.icon}</span><span class="text-xs font-bold ${subj.color}">${subj.name}</span>`;
                btn.className = "flex-1 aspect-square rounded-xl bg-white flex flex-col items-center justify-center border-2 border-blue-200 shadow-sm";
            }
        },

        // --- Quiz Loop ---
        startWeek: function() {
            // Validate schedule
            if(this.state.schedule.includes(null)) {
                alert("ìŠ¤ì¼€ì¤„ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”!");
                return;
            }

            this.currentQueue = [...this.state.schedule]; // Copy schedule
            this.currentSessionResults = { atk:0, def:0, spd:0, skl:0, fatigue:0 };
            this.processNextScheduleItem();
        },

        processNextScheduleItem: function() {
            if(this.currentQueue.length === 0) {
                this.finishWeek();
                return;
            }

            const type = this.currentQueue.shift();

            if(type === 'rest') {
                // Rest Logic
                this.currentSessionResults.fatigue -= 10;
                this.currentSessionResults.hp = 10; // Heal
                // Skip quiz screen for rest, maybe show a quick alert or toast (omitted for MVP speed)
                setTimeout(() => this.processNextScheduleItem(), 500);
            } else {
                // Start Quiz Session
                this.startQuizSession(type);
            }
        },

        startQuizSession: function(subjectKey) {
            const subj = SUBJECTS[subjectKey];
            this.currentQuizSubject = subjectKey;
            this.currentQuizCount = 0;
            this.currentQuizMax = 3; // 3 questions per slot

            this.showScreen('screen-quiz');
            document.getElementById('quiz-subject-badge').innerText = `${subj.name} í›ˆë ¨ ì¤‘`;
            this.nextQuestion();
        },

        nextQuestion: function() {
            if(this.currentQuizCount >= this.currentQuizMax) {
                // End Session
                this.processNextScheduleItem();
                return;
            }

            this.currentQuizCount++;
            document.getElementById('quiz-progress').innerText = `${this.currentQuizCount}/${this.currentQuizMax}`;

            // Generate Question
            const q = this.generateQuestion(this.currentQuizSubject);
            document.getElementById('quiz-question').innerText = q.question;

            const choicesDiv = document.getElementById('quiz-choices');
            choicesDiv.innerHTML = '';

            q.choices.forEach((choice, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-white/10 hover:bg-white/20 text-white font-bold py-4 px-6 rounded-xl border border-white/20 text-left transition active:scale-95";
                btn.innerText = choice;
                btn.onclick = () => this.handleAnswer(idx === q.answerIdx);
                choicesDiv.appendChild(btn);
            });
        },

        handleAnswer: function(isCorrect) {
            // Stats Logic
            this.state.player.totalQuestions++;
            if(isCorrect) {
                this.state.player.totalCorrect++;
                const statMap = { 'math': 'atk', 'sci': 'def', 'lang': 'skl' };
                const stat = statMap[this.currentQuizSubject];
                this.currentSessionResults[stat] = (this.currentSessionResults[stat] || 0) + 2; // +2 stat per correct
                // Bonus SPD for simply playing
                this.currentSessionResults.spd = (this.currentSessionResults.spd || 0) + 0.5;
            }
            this.currentSessionResults.fatigue += 2; // Tired from studying

            // Next
            this.nextQuestion();
        },

        // Simple Question Generator
        generateQuestion: function(subject) {
            if(subject === 'math') {
                const a = Math.floor(Math.random() * 10) + 1;
                const b = Math.floor(Math.random() * 10) + 1;
                const op = Math.random() > 0.5 ? '+' : '-';
                const ans = op === '+' ? a+b : a-b;
                // Create choices
                let choices = [ans, ans+1, ans-1, ans+2].sort(() => 0.5 - Math.random());
                return {
                    question: `${a} ${op} ${b} = ?`,
                    choices: choices,
                    answerIdx: choices.indexOf(ans)
                };
            } else if(subject === 'sci') {
                const qDb = [
                    { q: "ë¬¼ì˜ í™”í•™ì‹ì€?", a: "H2O", w: ["CO2", "O2", "NaCl"] },
                    { q: "ê´‘í•©ì„±ì— í•„ìš”í•œ ê²ƒì€?", a: "ë¹›", w: ["ì†Œê¸ˆ", "ë°”ëŒ", "ì–´ë‘ "] },
                    { q: "ì§€êµ¬ì˜ ìœ„ì„±ì€?", a: "ë‹¬", w: ["íƒœì–‘", "í™”ì„±", "ëª©ì„±"] }
                ];
                const pick = qDb[Math.floor(Math.random() * qDb.length)];
                let choices = [pick.a, ...pick.w].sort(() => 0.5 - Math.random());
                return { question: pick.q, choices: choices, answerIdx: choices.indexOf(pick.a) };
            } else {
                // Lang
                const qDb = [
                    { q: "'Apple'ì˜ ëœ»ì€?", a: "ì‚¬ê³¼", w: ["ë°”ë‚˜ë‚˜", "í¬ë„", "ì˜¤ë Œì§€"] },
                    { q: "ë‹¤ìŒì— ì˜¬ ë‹¨ì–´: I am ___ student.", a: "a", w: ["an", "the", "is"] },
                    { q: "'í–‰ë³µ'ì˜ ë°˜ëŒ€ë§ì€?", a: "ë¶ˆí–‰", w: ["ê¸°ì¨", "ì¦ê±°ì›€", "ì‚¬ë‘"] }
                ];
                const pick = qDb[Math.floor(Math.random() * qDb.length)];
                let choices = [pick.a, ...pick.w].sort(() => 0.5 - Math.random());
                return { question: pick.q, choices: choices, answerIdx: choices.indexOf(pick.a) };
            }
        },

        finishWeek: function() {
            // Apply Stats
            const pk = this.state.pokemon;
            const res = this.currentSessionResults;

            pk.stats.atk += res.atk || 0;
            pk.stats.def += res.def || 0;
            pk.stats.spd += res.spd || 0;
            pk.stats.skl += res.skl || 0;
            pk.fatigue = Math.max(0, pk.fatigue + (res.fatigue || 0));

            // Evolution Check? (Simplification: Evolve at week 4 and 7)
            let evolveMsg = "";
            if((this.state.week === 3 && pk.stageIdx === 0) || (this.state.week === 6 && pk.stageIdx === 1)) {
                pk.stageIdx++;
                evolveMsg = " ì¶•í•˜í•©ë‹ˆë‹¤! ì§„í™”í–ˆìŠµë‹ˆë‹¤!";
                pk.stats.atk += 10; pk.stats.def += 10; pk.stats.hp += 50;
            }

            // Show Result Screen
            this.showScreen('screen-result');
            document.getElementById('result-week-text').innerText = `${this.state.week}ì£¼ì°¨ í›ˆë ¨ ì™„ë£Œ`;

            const db = POKEMON_DB[this.state.starterType];
            document.getElementById('result-poke-img').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${db.stages[pk.stageIdx]}.png`;
            document.getElementById('result-message').innerText = evolveMsg ? evolveMsg : "ì˜¤ëŠ˜ë„ ì—´ì‹¬íˆ í–ˆì–´ìš”!";

            const list = document.getElementById('result-stats-list');
            list.innerHTML = `
                    <div class="flex justify-between text-sm"><span class="text-red-600">ê³µê²©ë ¥ (ìˆ˜í•™)</span> <span>+${Math.floor(res.atk||0)}</span></div>
                    <div class="flex justify-between text-sm"><span class="text-green-600">ë°©ì–´ë ¥ (ê³¼í•™)</span> <span>+${Math.floor(res.def||0)}</span></div>
                    <div class="flex justify-between text-sm"><span class="text-purple-600">ê¸°ìˆ  (ì–¸ì–´)</span> <span>+${Math.floor(res.skl||0)}</span></div>
                    <div class="flex justify-between text-sm"><span class="text-gray-500">í”¼ë¡œë„</span> <span>${res.fatigue > 0 ? '+'+res.fatigue : res.fatigue}</span></div>
                `;
        },

        finishResult: function() {
            // Battle Trigger? (Every 4 weeks or End)
            if(this.state.week === 4 || this.state.week === this.state.maxWeeks) {
                this.initBattle();
            } else {
                this.state.week++;
                this.saveGame();
                this.renderMainHub();
                this.showScreen('screen-main');
            }
        },

        // --- Battle System ---
        initBattle: function() {
            this.showScreen('screen-battle');
            const isBoss = this.state.week === this.state.maxWeeks;

            // Set Player
            const db = POKEMON_DB[this.state.starterType];
            const playerImg = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/back/${db.stages[this.state.pokemon.stageIdx]}.png`;
            document.getElementById('battle-player-sprite').src = playerImg;
            document.getElementById('battle-player-name').innerText = this.state.pokemon.name;

            // Set Enemy (Adaptive Difficulty)
            // Calculate Player Power
            const pStats = this.state.pokemon.stats;
            const powerLevel = pStats.atk + pStats.def + pStats.skl;

            // Adaptive Factor based on Quiz Performance
            const accuracy = this.state.player.totalQuestions > 0 ? (this.state.player.totalCorrect / this.state.player.totalQuestions) : 0.5;
            const difficultyMult = isBoss ? (0.8 + (accuracy * 0.4)) : 0.8; // 0.8 ~ 1.2

            this.state.currentBattle = {
                player: { ...pStats, currentHp: pStats.hp, maxHp: pStats.hp },
                enemy: {
                    name: isBoss ? "ì±”í”¼ì–¸ ë¡œë“œ" : "ë¼ì´ë²Œ",
                    currentHp: pStats.hp * difficultyMult,
                    maxHp: pStats.hp * difficultyMult,
                    atk: pStats.atk * difficultyMult,
                    def: pStats.def * difficultyMult,
                    spd: pStats.spd * difficultyMult
                },
                turn: 0,
                log: ["ë°°í‹€ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!"],
                isOver: false
            };

            // Boss Image (Mewtwo or Pikachu)
            const enemyId = isBoss ? 150 : 25;
            document.getElementById('enemy-sprite').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${enemyId}.png`;
            document.getElementById('enemy-name').innerText = this.state.currentBattle.enemy.name;

            this.updateBattleUI();
        },

        battleStep: function() {
            const b = this.state.currentBattle;
            if(b.isOver) {
                if(this.state.week === this.state.maxWeeks) {
                    this.showEnding(b.player.currentHp > 0);
                } else {
                    // Return to game
                    this.state.week++;
                    this.saveGame();
                    this.renderMainHub();
                    this.showScreen('screen-main');
                }
                return;
            }

            // Turn Logic
            b.turn++;
            // Who goes first?
            const pSpeed = b.player.spd * (Math.random() + 0.5);
            const eSpeed = b.enemy.spd * (Math.random() + 0.5);

            let first = pSpeed >= eSpeed ? 'player' : 'enemy';
            let second = first === 'player' ? 'enemy' : 'player';

            // Attack 1
            this.executeAttack(first, second);
            if(b.enemy.currentHp <= 0 || b.player.currentHp <= 0) {
                this.endBattle();
                return;
            }

            // Attack 2
            setTimeout(() => {
                this.executeAttack(second, first);
                if(b.enemy.currentHp <= 0 || b.player.currentHp <= 0) {
                    this.endBattle();
                }
            }, 500);
        },

        executeAttack: function(attackerKey, defenderKey) {
            const b = this.state.currentBattle;
            const att = attackerKey === 'player' ? b.player : b.enemy;
            const def = defenderKey === 'player' ? b.player : b.enemy;
            const name = attackerKey === 'player' ? this.state.pokemon.name : b.enemy.name;

            // Damage Calc
            let dmg = Math.max(1, (att.atk * 0.5) - (def.def * 0.2));
            dmg = Math.floor(dmg * (0.8 + Math.random() * 0.4)); // Variance

            // Crit? (Skill based)
            const critChance = (att.skl || 0) / 100;
            let isCrit = Math.random() < critChance;
            if(isCrit) {
                dmg = Math.floor(dmg * 1.5);
                this.battleLog(`${name}ì˜ ê¸‰ì†Œ ê³µê²©!`);
            }

            def.currentHp = Math.max(0, def.currentHp - dmg);
            this.battleLog(`${name}ì˜ ê³µê²©! ${dmg} ë°ë¯¸ì§€!`);

            // Animation Trigger
            const spriteId = attackerKey === 'player' ? 'battle-player-sprite' : 'enemy-sprite';
            const el = document.getElementById(spriteId);
            el.classList.add('attack-anim');
            setTimeout(() => el.classList.remove('attack-anim'), 300);

            this.updateBattleUI();
        },

        endBattle: function() {
            const b = this.state.currentBattle;
            b.isOver = true;
            const won = b.player.currentHp > 0;
            this.battleLog(won ? "ìŠ¹ë¦¬í–ˆìŠµë‹ˆë‹¤!" : "íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤...");

            const btn = document.getElementById('battle-next-btn');
            btn.innerText = won ? "ìŠ¹ë¦¬! (ëŒì•„ê°€ê¸°)" : "íŒ¨ë°°... (ëŒì•„ê°€ê¸°)";
            btn.className = won ? "w-full bg-blue-600 text-white font-bold py-4 rounded-xl" : "w-full bg-gray-600 text-white font-bold py-4 rounded-xl";
        },

        battleLog: function(msg) {
            const logEl = document.getElementById('battle-log');
            const p = document.createElement('div');
            p.innerText = msg;
            p.className = "mb-1";
            logEl.appendChild(p);
            logEl.scrollTop = logEl.scrollHeight;
        },

        updateBattleUI: function() {
            const b = this.state.currentBattle;
            // HP Bars
            const pHp = (b.player.currentHp / b.player.maxHp) * 100;
            const eHp = (b.enemy.currentHp / b.enemy.maxHp) * 100;

            document.getElementById('player-hp-bar').style.width = `${pHp}%`;
            document.getElementById('enemy-hp-bar').style.width = `${eHp}%`;

            // Color change
            document.getElementById('player-hp-bar').className = `h-full transition-all duration-300 ${pHp < 30 ? 'bg-red-500' : 'bg-green-500'}`;
        },

        // --- Ending ---
        showEnding: function(isWin) {
            this.showScreen('screen-ending');
            const pk = this.state.pokemon;
            const db = POKEMON_DB[this.state.starterType];

            document.getElementById('ending-img').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${db.stages[pk.stageIdx]}.png`;
            document.getElementById('ending-rank').innerText = isWin ? "S (ì±”í”¼ì–¸)" : "A (ìš°ìˆ˜ ì¡¸ì—…ìƒ)";
            document.getElementById('ending-score').innerText = `${this.state.player.totalCorrect} ë¬¸ì œ ì •ë‹µ`;

            // Find top stat
            const stats = pk.stats;
            const maxStatVal = Math.max(stats.atk, stats.def, stats.skl);
            let topStat = "ë°¸ëŸ°ìŠ¤í˜•";
            if(stats.atk === maxStatVal) topStat = "ê³µê²©í˜• (ìˆ˜í•™ ë§ˆìŠ¤í„°)";
            else if(stats.def === maxStatVal) topStat = "ë°©ì–´í˜• (ê³¼í•™ ë§ˆìŠ¤í„°)";
            else if(stats.skl === maxStatVal) topStat = "ê¸°ìˆ í˜• (ì–¸ì–´ ë§ˆìŠ¤í„°)";

            document.getElementById('ending-top-stat').innerText = topStat;

            // Clear save
            localStorage.removeItem('pokeEduSave');
        },

        // --- Utils ---
        showScreen: function(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    };

    // Start
    Game.init();
</script>
</body>
</html>