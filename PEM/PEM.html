<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ì¼“ ìˆ˜í•™ í† ë„ˆë¨¼íŠ¸</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
            touch-action: manipulation;
            user-select: none;
        }
        .game-font { font-family: 'Jua', sans-serif; }
        .screen { display: none; opacity: 0; transition: opacity 0.4s ease; }
        .screen.active { display: flex; opacity: 1; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        .bounce { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        .combo-pop { animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0.8; }
            50% { transform: scale(1.3); }
            100% { transform: scale(1.0); opacity: 1; }
        }

        /* ì „ì²´í™”ë©´ ëª¨ë“œì¼ ë•Œ ì‚´ì§ ì—¬ë°± ì¤„ì´ê¸° (ì„ íƒì‚¬í•­) */
        .fullscreen-active {
            border-radius: 0;
            max-width: none;
            width: 100%;
            height: 100vh;
        }

        /* ì „ì²´í™”ë©´ API ë¯¸ì§€ì› ê¸°ê¸°(iOS ë“±)ìš© fallback */
        body.fullscreen-fallback {
            padding: 0;
            margin: 0;
            background-color: #000;
        }

        .fullscreen-fallback-card {
            position: fixed;
            inset: 0;
            margin: 0;
            border-radius: 0;
            max-width: none;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
        }

        /* ëª¨ë°”ì¼ì—ì„œ í•˜ë‹¨ ë¸Œë¼ìš°ì € ë°”ì— ë²„íŠ¼ì´ ê°€ë ¤ì§€ì§€ ì•Šë„ë¡ ì—¬ìœ  ê³µê°„ ì¶”ê°€ */
        @media (max-width: 768px) {
            .mobile-bottom-guard {
                /* ê¸°ë³¸ 32px + ì•ˆì „ ì˜ì—­(ì•„ì´í° í™ˆ ì¸ë””ì¼€ì´í„° ë“±) */
                padding-bottom: max(32px, env(safe-area-inset-bottom, 0px) + 24px);
            }
        }


        /* ì „íˆ¬ ì• ë‹ˆë©”ì´ì…˜ */
        .anim-attack-right { animation: lungeRight 0.2s forwards; }
        @keyframes lungeRight { 0% { transform: translateX(0); } 50% { transform: translateX(80px) scale(1.1); } 100% { transform: translateX(0); } }

        .anim-attack-left { animation: lungeLeft 0.2s forwards; }
        @keyframes lungeLeft { 0% { transform: translateX(0) scaleX(-1); } 50% { transform: translateX(-80px) scaleX(-1) scale(1.1); } 100% { transform: translateX(0) scaleX(-1); } }

        .anim-hit { animation: shakeRed 0.4s; }
        @keyframes shakeRed {
            0% { transform: translateX(0); filter: none; }
            20% { transform: translateX(-10px) filter: sepia(1) hue-rotate(-50deg) saturate(5); opacity: 0.8; }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); filter: none; opacity: 1; }
            100% { transform: translateX(0); }
        }

        .anim-skill-trigger { animation: flashSkill 0.5s; }
        @keyframes flashSkill {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.2); filter: brightness(1.5); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        .defeated-gray { filter: grayscale(100%) opacity(0.5); transition: filter 1s ease; }

        /* ë ˆì–´ë„ í…ìŠ¤íŠ¸ íš¨ê³¼ */
        .rarity-common { color: #4b5563; }
        .rarity-rare { color: #2563eb; text-shadow: 0 0 2px #bfdbfe; }
        .rarity-epic { color: #9333ea; text-shadow: 0 0 5px #e9d5ff; font-weight: bold; }

        .game-card {
            background: white; border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 480px; width: 100%; margin: 0 auto; overflow: hidden; border: 4px solid #fff;
        }
        .bg-pastel-blue { background: linear-gradient(135deg, #E0F2FE 0%, #F0F9FF 100%); }
        .bg-pastel-green { background: linear-gradient(135deg, #DCFCE7 0%, #F0FDF4 100%); }
        .bg-pastel-arena { background: linear-gradient(to bottom, #bfdbfe 0%, #dbeafe 40%, #86efac 40%, #bbf7d0 100%); }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex items-center justify-center p-4">

<div id="game-container" class="game-card relative min-h-[800px] flex flex-col">

    <!-- ğŸ”¹ ì „ì²´ í™”ë©´ í† ê¸€ ë²„íŠ¼ (êµì‚¬/í•™ìƒ ê³µí†µ) -->
    <button
            id="fullscreen-btn"
            type="button"
            class="absolute top-3 right-3 z-[80] px-3 py-1 rounded-full bg-black/40 text-white text-xs font-semibold flex items-center gap-1 hover:bg-black/60 transition"
            onclick="Game.toggleFullscreen()"
    >
        â›¶ ì „ì²´ í™”ë©´
    </button>
    
    <div id="screen-title" class="screen active flex-col items-center justify-center h-full absolute inset-0 bg-pastel-blue z-50">
        <h1 class="text-4xl font-bold text-indigo-600 mb-2 game-font text-center drop-shadow-sm">í¬ì¼“ ìˆ˜í•™<br>í† ë„ˆë¨¼íŠ¸ V8</h1>
        <p class="text-gray-500 mb-10 game-font text-lg">ì „ëµì  ìœ¡ì„± & ì˜¤í†  ë°°í‹€</p>
        <div class="flex gap-6 mb-12">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png" class="w-20 h-20 bounce">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png" class="w-20 h-20 bounce" style="animation-delay: 0.2s">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png" class="w-20 h-20 bounce" style="animation-delay: 0.4s">
        </div>
        <button onclick="Game.startNewGame()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-12 rounded-full shadow-lg transform transition hover:scale-105 text-xl game-font">ëª¨í—˜ ì‹œì‘í•˜ê¸°</button>
    </div>

    <div id="screen-select" class="screen flex-col h-full bg-white p-6 absolute inset-0 z-40">
        <h2 class="text-2xl game-font font-bold text-center mb-8 text-gray-700">í•¨ê»˜í•  íŒŒíŠ¸ë„ˆë¥¼ ê³¨ë¼ì¤˜!</h2>
        <div class="space-y-4">
            <div onclick="Game.chooseStarter('grass')" class="border-4 border-green-200 bg-green-50 hover:bg-green-100 rounded-3xl p-4 flex items-center cursor-pointer transition transform hover:-translate-y-1">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png" class="w-24 h-24 bg-white rounded-full p-2 mr-4 shadow-sm">
                <div><h3 class="font-bold text-xl text-green-700 game-font">ì´ìƒí•´ì”¨ (í’€)</h3><p class="text-sm text-green-600">ë°©ì–´/íšŒë³µ íŠ¹í™”</p></div>
            </div>
            <div onclick="Game.chooseStarter('fire')" class="border-4 border-red-200 bg-red-50 hover:bg-red-100 rounded-3xl p-4 flex items-center cursor-pointer transition transform hover:-translate-y-1">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png" class="w-24 h-24 bg-white rounded-full p-2 mr-4 shadow-sm">
                <div><h3 class="font-bold text-xl text-red-700 game-font">íŒŒì´ë¦¬ (ë¶ˆ)</h3><p class="text-sm text-red-600">ê³µê²©/í™”ë ¥ íŠ¹í™”</p></div>
            </div>
            <div onclick="Game.chooseStarter('water')" class="border-4 border-blue-200 bg-blue-50 hover:bg-blue-100 rounded-3xl p-4 flex items-center cursor-pointer transition transform hover:-translate-y-1">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png" class="w-24 h-24 bg-white rounded-full p-2 mr-4 shadow-sm">
                <div><h3 class="font-bold text-xl text-blue-700 game-font">ê¼¬ë¶€ê¸° (ë¬¼)</h3><p class="text-sm text-blue-600">ë°¸ëŸ°ìŠ¤/ëª…ì¤‘ íŠ¹í™”</p></div>
            </div>
        </div>
    </div>

    <div id="screen-main" class="screen flex-col h-full bg-white relative z-30">
        <div class="p-5 flex justify-between items-end bg-pastel-blue rounded-b-3xl shadow-sm z-10">
            <div>
                <div class="text-xs font-bold text-indigo-400 mb-1" id="league-info">16ê°• ì˜ˆì„ ì „</div>
                <h2 class="text-3xl font-bold game-font text-gray-800" id="main-week-display">1ì£¼ì°¨</h2>
            </div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-start pt-6 relative">
            <div class="relative group flex flex-col items-center mb-6">
                <img id="main-poke-img" src="" class="object-contain drop-shadow-lg transition-transform duration-500">
                <h3 id="main-poke-name" class="text-2xl font-bold text-center text-gray-800 game-font mt-2">ì´ë¦„</h3>
            </div>

            <div class="w-full px-6 mb-4">
                <div class="bg-gray-50 rounded-2xl p-5 shadow-inner border border-gray-100">
                    <div class="grid grid-cols-2 gap-6 h-full">

                        <div class="flex flex-col justify-center space-y-4 border-r border-gray-200 pr-2">
                            <div class="text-xs font-bold text-gray-400 mb-1 text-center">ê¸°ë³¸ ëŠ¥ë ¥ì¹˜</div>
                            <div class="flex flex-col items-center">
                                <span class="text-sm font-bold text-red-500 mb-1">ê³µê²© (ATK)</span>
                                <span class="text-2xl font-bold text-gray-700 game-font" id="stat-atk">0</span>
                            </div>
                            <div class="flex flex-col items-center">
                                <span class="text-sm font-bold text-green-500 mb-1">ë°©ì–´ (DEF)</span>
                                <span class="text-2xl font-bold text-gray-700 game-font" id="stat-def">0</span>
                            </div>
                            <div class="flex flex-col items-center">
                                <span class="text-sm font-bold text-purple-500 mb-1">ê¸°ìˆ  (SKL)</span>
                                <span class="text-2xl font-bold text-gray-700 game-font" id="stat-skl">0</span>
                            </div>
                        </div>

                        <div class="flex flex-col">
                            <div class="text-xs font-bold text-gray-400 mb-2 text-center">ì¥ì°© ìŠ¤í‚¬ (4ì¹¸)</div>
                            <div class="grid grid-cols-2 gap-2 h-full content-center" id="main-skill-grid">
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="p-6 bg-white border-t border-gray-100 rounded-t-3xl shadow-[0_-5px_15px_rgba(0,0,0,0.05)] mobile-bottom-guard">
            <h4 class="text-lg game-font font-bold text-gray-700 mb-4">í›ˆë ¨ ê³¼ëª© ì„ íƒ</h4>
            <div class="flex gap-3 mb-4">
                <button onclick="Game.toggleSchedule(0)" id="sched-0" class="flex-1 aspect-square rounded-2xl bg-gray-50 border-2 border-dashed border-gray-300 flex flex-col items-center justify-center hover:bg-gray-100 transition">?</button>
                <button onclick="Game.toggleSchedule(1)" id="sched-1" class="flex-1 aspect-square rounded-2xl bg-gray-50 border-2 border-dashed border-gray-300 flex flex-col items-center justify-center hover:bg-gray-100 transition">?</button>
                <button onclick="Game.toggleSchedule(2)" id="sched-2" class="flex-1 aspect-square rounded-2xl bg-gray-50 border-2 border-dashed border-gray-300 flex flex-col items-center justify-center hover:bg-gray-100 transition">?</button>
            </div>
            <button onclick="Game.startWeek()" class="w-full bg-indigo-500 text-white text-lg game-font font-bold py-4 rounded-2xl shadow-md active:scale-95 transition">í›ˆë ¨ ì‹œì‘!</button>
        </div>
    </div>

    <div id="screen-quiz" class="screen flex-col h-full bg-indigo-600 text-white relative z-50 p-6">
        <div class="flex justify-between items-center mb-2">
            <span id="quiz-subject-badge" class="bg-white/20 px-4 py-1 rounded-full text-sm font-bold text-yellow-300">ìˆ˜í•™ í›ˆë ¨</span>
            <span class="text-xl font-bold game-font" id="quiz-progress">1/3</span>
        </div>
        <div class="w-full h-4 bg-indigo-900 rounded-full mb-6 overflow-hidden border border-indigo-400">
            <div id="quiz-timer-bar" class="h-full bg-yellow-400 transition-all duration-100 ease-linear" style="width: 100%"></div>
        </div>
        <div id="quiz-combo-container" class="absolute top-20 right-6 text-right hidden z-10 pointer-events-none">
            <div class="text-5xl font-bold text-yellow-300 game-font drop-shadow-md combo-pop" id="quiz-combo-text">COMBO!</div>
        </div>
        <div class="flex-1 flex flex-col items-center justify-center">
            <div class="w-full bg-white text-gray-800 p-8 rounded-3xl mb-8 shadow-xl text-center relative">
                <h2 id="quiz-question" class="text-4xl font-bold game-font mt-2 leading-relaxed">?</h2>
            </div>
            <div id="quiz-choices" class="grid grid-cols-2 gap-4 w-full"></div>
        </div>
    </div>

    <div id="screen-result" class="screen flex-col h-full bg-pastel-green p-6 justify-center z-50 items-center">
        <h2 class="text-3xl font-bold game-font text-green-800 mb-2">í›ˆë ¨ ì™„ë£Œ!</h2>
        <div class="bg-white rounded-2xl p-6 w-full shadow-lg mb-6">
            <div class="font-bold text-xl text-center text-gray-700 game-font mb-4" id="result-message">ê²°ê³¼</div>
            <div class="space-y-3" id="result-stats-list"></div>
        </div>
        <button onclick="Game.checkSkillAcquisition()" class="w-full bg-green-600 text-white font-bold py-4 rounded-2xl shadow-lg game-font text-lg">ë‹¤ìŒìœ¼ë¡œ</button>
    </div>

    <div id="screen-skill-learn" class="screen flex-col h-full bg-gray-800/95 absolute inset-0 z-[60] p-6 justify-center items-center backdrop-blur-sm">
        <div class="bg-white w-full rounded-3xl p-6 shadow-2xl border-4 border-yellow-400 relative">
            <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 bg-yellow-400 text-yellow-900 px-6 py-2 rounded-full font-bold shadow-lg game-font">
                ìƒˆë¡œìš´ ìŠ¤í‚¬ ë°œê²¬!
            </div>

            <div id="new-skill-card" class="bg-gray-100 rounded-xl p-4 mb-6 border-2 border-gray-300 text-center">
                <div class="text-sm text-gray-500 mb-1" id="new-skill-rarity">RARITY</div>
                <h3 class="text-2xl font-bold mb-2 game-font" id="new-skill-name">ìŠ¤í‚¬ ì´ë¦„</h3>
                <p class="text-gray-600 text-sm" id="new-skill-desc">ì„¤ëª…</p>
                <div class="mt-2 text-xs font-bold text-indigo-500" id="new-skill-stat">ìœ„ë ¥: 50</div>
            </div>

            <p class="text-center text-gray-600 mb-4 font-bold text-sm">ê¸°ìˆ  ìŠ¬ë¡¯(4ê°œ)ì´ ê°€ë“ ì°¼ìŠµë‹ˆë‹¤.<br>ìŠì„ ê¸°ìˆ ì„ ì„ íƒí•˜ê±°ë‚˜ í¬ê¸°í•˜ì„¸ìš”.</p>

            <div id="skill-swap-list" class="space-y-2 mb-4">
            </div>

            <button onclick="Game.giveUpSkill()" class="w-full bg-gray-400 hover:bg-gray-500 text-white font-bold py-3 rounded-xl">ì´ë²ˆì—” ë°°ìš°ì§€ ì•ŠëŠ”ë‹¤</button>
        </div>
    </div>

    <div id="screen-battle" class="screen flex-col h-full bg-white z-50">
        <div class="flex-1 w-full bg-pastel-arena relative overflow-hidden flex flex-col rounded-b-3xl shadow-md z-10 min-h-[350px]">
            <div class="absolute top-8 right-6 flex flex-col items-end w-32 z-20">
                <div class="bg-white/80 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-gray-600 mb-1 shadow-sm border border-white">
                    Lv.<span id="enemy-level"></span> <span id="enemy-name"></span>
                </div>
                <div class="w-full h-2 bg-gray-300 rounded-full overflow-hidden border border-gray-200">
                    <div id="enemy-hp-bar" class="h-full bg-red-400 w-full transition-all duration-500"></div>
                </div>
                <img id="enemy-sprite" src="" class="w-28 h-28 mt-2 drop-shadow-xl transition-all">
                <div id="enemy-damage-text" class="absolute top-10 right-10 text-4xl font-bold text-red-600 opacity-0 game-font" style="text-shadow: 2px 2px 0 #fff;">-0</div>
            </div>

            <div class="absolute bottom-6 left-6 flex flex-col w-32 z-20">
                <img id="battle-player-sprite" src="" class="w-32 h-32 mb-2 drop-shadow-xl transition-all">
                <div class="bg-white/80 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-gray-600 mb-1 shadow-sm border border-white">
                    Lv.<span id="player-level"></span> <span id="battle-player-name"></span>
                </div>
                <div class="w-full h-2 bg-gray-300 rounded-full overflow-hidden border border-gray-200">
                    <div id="player-hp-bar" class="h-full bg-green-400 w-full transition-all duration-500"></div>
                </div>
                <div id="player-damage-text" class="absolute bottom-20 left-10 text-4xl font-bold text-red-600 opacity-0 game-font" style="text-shadow: 2px 2px 0 #fff;">-0</div>
            </div>

            <div id="skill-trigger-overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none z-30 opacity-0 transition-opacity">
                <div class="bg-black/50 text-white px-6 py-2 rounded-full font-bold text-xl game-font border-2 border-white" id="skill-trigger-text">
                    ëª¸í†µë°•ì¹˜ê¸°!
                </div>
            </div>

            <div id="battle-fx" class="absolute inset-0 pointer-events-none flex items-center justify-center z-30"></div>
        </div>

        <div class="h-48 p-4 flex flex-col bg-white flex-none">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                    <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                    <span class="text-sm font-bold text-gray-500">AUTO BATTLE</span>
                </div>
            </div>
            <div class="flex-1 bg-gray-50 rounded-2xl p-4 border border-gray-100 shadow-inner overflow-hidden relative">
                <div id="battle-log" class="text-center font-bold text-gray-700 leading-relaxed mt-4">
                    ì „íˆ¬ ì¤€ë¹„ ì¤‘...
                </div>
            </div>
        </div>

        <div id="battle-result-overlay" class="absolute inset-0 bg-black/60 hidden flex-col items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white p-8 rounded-3xl text-center shadow-2xl max-w-xs w-full animate-[bounce_0.5s]">
                <div class="text-6xl mb-4" id="battle-result-icon">ğŸ†</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-6 game-font" id="battle-result-text">ìŠ¹ë¦¬!</h2>
                <button onclick="Game.endBattle()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-3 rounded-xl shadow-md transition">í™•ì¸</button>
            </div>
        </div>
    </div>

    <div id="screen-bracket" class="screen flex-col h-full bg-gray-800 text-white p-6 z-50">
        <div class="text-center mb-6"><h2 class="text-3xl text-yellow-400 game-font" id="bracket-title">8ê°•ì „</h2></div>
        <div class="flex-1 flex flex-col items-center justify-center relative gap-8">
            <div class="bg-gray-700 p-4 rounded-2xl border-2 border-red-500 w-40 text-center"><img id="bracket-enemy-img" src="" class="w-20 h-20 mx-auto"><div class="font-bold mt-2" id="bracket-enemy-name">???</div></div>
            <div class="font-bold text-2xl text-yellow-500">VS</div>
            <div class="bg-gray-700 p-4 rounded-2xl border-2 border-blue-500 w-40 text-center"><img id="bracket-player-img" src="" class="w-20 h-20 mx-auto"><div class="font-bold mt-2" id="bracket-player-name">ë‚˜</div></div>
        </div>
        <button onclick="Game.initBattleReal()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-2xl shadow-lg text-xl game-font mt-6 animate-pulse">ê²½ê¸°ì¥ ì…ì¥!</button>
    </div>

    <div id="screen-ending" class="screen flex-col h-full bg-yellow-50 p-6 items-center justify-center z-50 text-center">
        <h1 class="text-4xl font-bold text-yellow-700 mb-4 game-font">ì „ì„¤ì˜ íŠ¸ë ˆì´ë„ˆ!</h1>
        <div class="bg-white p-8 rounded-[40px] shadow-xl w-full mb-8 border-4 border-yellow-200">
            <img id="ending-img" src="" class="w-40 h-40 mx-auto mb-6">
            <div class="flex justify-between text-lg mb-2 border-b border-gray-100 pb-2">
                <span class="text-gray-400 font-bold">ìµœì¢… ë­í¬</span>
                <span class="font-bold text-indigo-600" id="ending-rank">ì±”í”¼ì–¸</span>
            </div>
            <div class="flex justify-between text-lg">
                <span class="text-gray-400 font-bold">ì •ë‹µ ê°œìˆ˜</span>
                <span class="font-bold text-gray-800" id="ending-score">0 ë¬¸ì œ</span>
            </div>
        </div>

        <!-- ğŸ”¹ NEW: êµì‚¬ì—ê²Œ ë³´ë‚¼ í´ë¦¬ì–´ ë°ì´í„° ì½”ë“œ -->
        <!-- ğŸ”¹ ì„ ìƒë‹˜ê»˜ ë°”ë¡œ ë³´ë‚´ê¸° (1í•™ë…„ìš©) -->
        <div class="bg-white p-4 rounded-2xl shadow-inner w-full max-w-xl mx-auto mb-6 border border-dashed border-indigo-200">
            <p class="text-sm text-gray-600 mb-2 font-semibold">
                ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì„ ìƒë‹˜ê»˜ ì˜¤ëŠ˜ ê²°ê³¼ê°€ ë°”ë¡œ ë³´ë‚´ì ¸ìš”. ğŸ‘‡
            </p>
            <textarea
                    id="ending-export-json"
                    class="w-full h-24 text-xs md:text-sm font-mono bg-gray-50 rounded-lg p-2 border border-gray-200"
                    readonly
            ></textarea>
            <button
                    type="button"
                    onclick="Game.sendToTeacher()"
                    class="mt-2 px-3 py-2 rounded-lg bg-indigo-500 text-white text-sm font-bold shadow hover:bg-indigo-600 transition game-font w-full"
            >
                ì„ ìƒë‹˜ê»˜ ë³´ë‚´ê¸°
            </button>
        </div>

        <button onclick="location.reload()" class="bg-indigo-500 text-white px-6 py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-600 transition text-lg game-font">
            ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°
        </button>

    </div>
</div>

<script>
    // --- ë°ì´í„° ---

    // PEM.html?roomId=...&studentId=... í˜•íƒœë¡œ ë“¤ì–´ì˜¨ ê°’ ì‚¬ìš©
    const urlParams = new URLSearchParams(window.location.search);
    const PEM_ROOM_ID =
        urlParams.get("roomId") || null;
    const PEM_STUDENT_ID =
        urlParams.get("studentId") ||
        urlParams.get("student_id") ||
        urlParams.get("studentKey") ||
        null;


    const SKILLS_DB = [
        // type: atk(ê³µê²©), def(ë°©ì–´/íšŒë³µ), eff(íŠ¹ìˆ˜)
        { id: 'tackle', name: 'ëª¸í†µë°•ì¹˜ê¸°', type: 'atk', power: 20, acc: 95, rarity: 1, desc: 'ê¸°ë³¸ì ì¸ ê³µê²© ê¸°ìˆ ' },
        { id: 'scratch', name: 'í• í€´ê¸°', type: 'atk', power: 25, acc: 90, rarity: 1, desc: 'ë‚ ì¹´ë¡œìš´ ì†í†±ìœ¼ë¡œ ê³µê²©' },
        { id: 'ember', name: 'ë¶ˆê½ƒì„¸ë¡€', type: 'atk', power: 40, acc: 90, rarity: 2, desc: 'ì‘ì€ ë¶ˆê½ƒì„ ë°œì‚¬' },
        { id: 'watergun', name: 'ë¬¼ëŒ€í¬', type: 'atk', power: 40, acc: 90, rarity: 2, desc: 'ë¬¼ì„ ë¿œì–´ ê³µê²©' },
        { id: 'vinewhip', name: 'ë©êµ´ì±„ì°', type: 'atk', power: 40, acc: 90, rarity: 2, desc: 'ë©êµ´ë¡œ ìƒëŒ€ë¥¼ íƒ€ê²©' },
        { id: 'bite', name: 'ë¬¼ê¸°', type: 'atk', power: 50, acc: 85, rarity: 2, desc: 'ê°•í•œ ì´ë¹¨ë¡œ ë¬¼ì–´ëœ¯ê¸°' },
        { id: 'flamethrower', name: 'í™”ì—¼ë°©ì‚¬', type: 'atk', power: 70, acc: 85, rarity: 3, desc: 'ê°•ë ¬í•œ ë¶ˆê½ƒ ë°œì‚¬' },
        { id: 'hydropump', name: 'í•˜ì´ë“œë¡œíŒí”„', type: 'atk', power: 80, acc: 75, rarity: 3, desc: 'ì—„ì²­ë‚œ ë¬¼ëŒ€í¬' },
        { id: 'solarbeam', name: 'ì†”ë¼ë¹”', type: 'atk', power: 80, acc: 75, rarity: 3, desc: 'íƒœì–‘ì˜ í˜ì„ ëª¨ì•„ ë°œì‚¬' },

        { id: 'heal', name: 'ì‘ê¸‰ì²˜ì¹˜', type: 'def', power: 40, acc: 100, rarity: 1, desc: 'ì²´ë ¥ì„ 40 íšŒë³µ' },
        { id: 'rest', name: 'ì ìê¸°', type: 'def', power: 70, acc: 100, rarity: 3, desc: 'ì²´ë ¥ì„ í¬ê²Œ íšŒë³µ' },

        { id: 'headbutt', name: 'ë°•ì¹˜ê¸°', type: 'atk', power: 60, acc: 90, rarity: 2, desc: 'ê°•ë ¥í•œ ë°•ì¹˜ê¸°' },
        // ğŸ”¹ ìƒíƒœì´ìƒ / í¡ìˆ˜ ê³„ì—´ (ìƒˆë¡œ ì¶”ê°€)
        {
            id: 'burn_strike',
            name: 'í™”ì—¼í€ì¹˜',
            type: 'eff',
            power: 30,
            acc: 95,
            rarity: 2,
            effect: 'burn',          // í™”ìƒ
            effectChance: 1.0,
            desc: 'ëœ¨ê±°ìš´ ë¶ˆê½ƒìœ¼ë¡œ ìƒëŒ€ë¥¼ í™”ìƒ ìƒíƒœë¡œ ë§Œë“ ë‹¤'
        },
        {
            id: 'poison_sting',
            name: 'ë…ì¹¨',
            type: 'eff',
            power: 25,
            acc: 95,
            rarity: 2,
            effect: 'poison',        // ë…
            effectChance: 1.0,
            desc: 'ìƒëŒ€ë¥¼ ë… ìƒíƒœë¡œ ë§Œë“ ë‹¤'
        },
        {
            id: 'drain_leaf',
            name: 'ê¸°ê°€ë“œë ˆì¸',
            type: 'eff',
            power: 35,
            acc: 100,
            rarity: 3,
            effect: 'drain',         // í¡ìˆ˜
            drainRatio: 0.5,         // ì…íŒ í”¼í•´ì˜ 50% íšŒë³µ
            desc: 'ì…íŒ í”¼í•´ì˜ ì ˆë°˜ë§Œí¼ ì²´ë ¥ì„ íšŒë³µí•œë‹¤'
        },
    ];

    const POKEMON_DB = {
        grass: { name: "ì´ìƒí•´ì”¨", stages: [1, 2, 3], stats: { atk: 15, def: 25, spd: 10, skl: 20 }, initSkill: 'vinewhip' },
        fire: { name: "íŒŒì´ë¦¬", stages: [4, 5, 6], stats: { atk: 30, def: 10, spd: 20, skl: 10 }, initSkill: 'ember' },
        water: { name: "ê¼¬ë¶€ê¸°", stages: [7, 8, 9], stats: { atk: 15, def: 20, spd: 15, skl: 25 }, initSkill: 'watergun' }
    };

    const SUBJECTS = {
        math: { name: "ë§ì…ˆ (ê³µê²©)", stat: "atk", icon: "âš”ï¸", color: "text-red-500" },
        sci: { name: "ëº„ì…ˆ (ë°©ì–´)", stat: "def", icon: "ğŸ›¡ï¸", color: "text-green-500" },
        lang: { name: "ê·œì¹™ (ê¸°ìˆ )", stat: "skl", icon: "âœ¨", color: "text-purple-500" }
    };
    const SUBJECT_KEYS = ["math", "sci", "lang"];
    const TOURNAMENT_ROUNDS = [
        { week: 2, name: "16ê°•ì „", enemyId: 19, enemyName: "ê¼¬ë ›", difficultyRatio: 0.5 },
        { week: 4, name: "8ê°•ì „", enemyId: 52, enemyName: "ë‚˜ì˜¹", difficultyRatio: 0.7 },
        { week: 6, name: "ì¤€ê²°ìŠ¹", enemyId: 25, enemyName: "í”¼ì¹´ì¸„", difficultyRatio: 0.9 },
        { week: 8, name: "ê²°ìŠ¹ì „", enemyId: 150, enemyName: "ë®¤ì¸ ", difficultyRatio: 1.2 }
    ];

    // --- ê²Œì„ ì—”ì§„ ---
    const Game = {
        state: {
            starter: null,
            pokemon: { name: "", stage: 0, stats: { atk:0, def:0, skl:0, hp:100 }, skills: [] },
            week: 1,
            schedule: [null, null, null],
            player: { totalCorrect: 0, totalQuestions: 0 },
            combo: 0,
            pendingSkill: null,
            lastSummary: null,

            // ğŸ”¹ ì£¼ì°¨ ì‹œì‘ ì§ì „ ë°±ì—…(í¬ì¼“ëª¬/ì •ë‹µ ìˆ˜ ë“±)
            backupBeforeWeek: null,
            // ğŸ”¹ ê°™ì€ ì£¼ì°¨ ê²½ê¸°ì—ì„œ ëª‡ ë²ˆ ì¡ŒëŠ”ì§€
            currentRoundLosses: 0,
        },

        // ğŸ”¹ ê´€ì „ ëª¨ë“œ ì—¬ë¶€ (êµì‚¬ìš© í† ë„ˆë¨¼íŠ¸ì¼ ë•Œ true)
        spectatorMode: false,

        toggleFullscreen: function() {
            const root = document.documentElement;
            const card = document.getElementById('game-container');

            if (!card) return;

            // ë¸Œë¼ìš°ì € ì „ì²´í™”ë©´ ì§€ì› ì—¬ë¶€ ì²´í¬
            const enterFs =
                root.requestFullscreen ||
                root.webkitRequestFullscreen ||
                root.msRequestFullscreen;

            const exitFs =
                document.exitFullscreen ||
                document.webkitExitFullscreen ||
                document.msExitFullscreen;

            const supportsFullscreen = !!enterFs && !!exitFs;

            if (supportsFullscreen) {
                // âœ… PC ë“± Fullscreen API ì§€ì› ë¸Œë¼ìš°ì €
                if (!document.fullscreenElement) {
                    enterFs.call(root);
                    card.classList.add('fullscreen-active');
                } else {
                    exitFs.call(document);
                    card.classList.remove('fullscreen-active');
                }
            } else {
                // âœ… iOS Safari ë“±: CSS ê¸°ë°˜ "ê°€ì§œ ì „ì²´í™”ë©´" í† ê¸€
                const isFallbackOn = card.classList.contains('fullscreen-fallback-card');

                if (!isFallbackOn) {
                    document.body.classList.add('fullscreen-fallback');
                    card.classList.add('fullscreen-fallback-card');
                } else {
                    document.body.classList.remove('fullscreen-fallback');
                    card.classList.remove('fullscreen-fallback-card');
                }
            }
        },


        init: function() { this.showScreen('screen-title'); },
        
        startNewGame: function() {
            this.state.week = 1;
            this.state.pokemon.stage = 0;
            this.state.pokemon.skills = [];
            this.state.player.totalCorrect = 0;
            this.state.player.totalQuestions = 0;
            this.state.lastSummary = null;

            // ğŸ”¹ í•™ìƒ ëª¨í—˜ ì‹œì‘ ì‹œì—ëŠ” ê´€ì „ ëª¨ë“œ ë„ê¸°
            this.spectatorMode = false;

            this.showScreen('screen-select');
        },



        chooseStarter: function(type) {
            this.state.starter = type;
            const base = POKEMON_DB[type];
            this.state.pokemon.name = base.name;
            this.state.pokemon.stats = { ...base.stats, hp: 100 };
            this.learnSkill('tackle'); // ê¸°ë³¸ ìŠ¤í‚¬
            this.learnSkill(base.initSkill);
            this.renderMain();
            this.showScreen('screen-main');
        },

        getSkillObj: function(id) { return SKILLS_DB.find(s => s.id === id); },

        learnSkill: function(id) {
            if(this.state.pokemon.skills.length < 4) {
                this.state.pokemon.skills.push(id);
                return true;
            }
            return false;
        },

        // ìˆ˜ì •ëœ ë Œë” í•¨ìˆ˜ (ìŠ¤í‚¬ ìŠ¬ë¡¯ ì‹œê°í™”)
        renderMain: function() {
            const pk = this.state.pokemon;
            const db = POKEMON_DB[this.state.starter];
            document.getElementById('main-week-display').innerText = `${this.state.week}ì£¼ì°¨`;
            document.getElementById('main-poke-name').innerText = pk.name;
            document.getElementById('main-poke-img').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${db.stages[pk.stage]}.png`;

            const imgEl = document.getElementById('main-poke-img');
            imgEl.className = pk.stage === 0 ? "w-40 h-40 object-contain drop-shadow-lg bounce" : "w-56 h-56 object-contain drop-shadow-lg bounce";

            // ìŠ¤íƒ¯ í‘œì‹œ
            document.getElementById('stat-atk').innerText = Math.floor(pk.stats.atk);
            document.getElementById('stat-def').innerText = Math.floor(pk.stats.def);
            document.getElementById('stat-skl').innerText = Math.floor(pk.stats.skl);

            // ìŠ¤í‚¬ ê·¸ë¦¬ë“œ í‘œì‹œ (ì‹ ê·œ)
            const skillGrid = document.getElementById('main-skill-grid');
            skillGrid.innerHTML = '';

            for(let i=0; i<4; i++) {
                const sid = pk.skills[i];
                const box = document.createElement('div');

                if(sid) {
                    const s = this.getSkillObj(sid);
                    // ë ˆì–´ë„ë³„ í…Œë‘ë¦¬ ìƒ‰ìƒ
                    let borderClass = "border-gray-300 bg-gray-50";
                    let textClass = "text-gray-700";

                    if(s.rarity === 2) { borderClass = "border-blue-400 bg-blue-50"; textClass = "text-blue-700"; }
                    if(s.rarity === 3) { borderClass = "border-purple-400 bg-purple-50"; textClass = "text-purple-700"; }

                    box.className = `aspect-square rounded-xl border-2 ${borderClass} flex flex-col items-center justify-center cursor-pointer hover:scale-105 transition shadow-sm p-1`;
                    box.onclick = () => alert(`[${s.name}]\në“±ê¸‰: ${s.rarity===1?'ì¼ë°˜':s.rarity===2?'í¬ê·€':'ì „ì„¤'}\nìœ„ë ¥: ${s.power}\nì„¤ëª…: ${s.desc}`);
                    box.innerHTML = `<div class="text-[10px] font-bold ${textClass} text-center break-keep leading-tight">${s.name}</div>`;
                } else {
                    // ë¹ˆ ìŠ¬ë¡¯
                    box.className = `aspect-square rounded-xl border-2 border-dashed border-gray-300 flex items-center justify-center bg-gray-50/50`;
                    box.innerHTML = `<span class="text-gray-300 text-xl">+</span>`;
                }
                skillGrid.appendChild(box);
            }

            this.state.schedule = [null, null, null];
            [0,1,2].forEach(i => this.renderSlot(i));
        },

        toggleSchedule: function(idx) {
            const curr = this.state.schedule[idx];
            const nextKey = curr ? SUBJECT_KEYS[(SUBJECT_KEYS.indexOf(curr)+1)%3] : SUBJECT_KEYS[0];
            this.state.schedule[idx] = nextKey;
            this.renderSlot(idx);
        },
        renderSlot: function(idx) {
            const key = this.state.schedule[idx];
            const btn = document.getElementById(`sched-${idx}`);
            if(!key) {
                btn.innerHTML = `<span class="text-3xl text-gray-300">?</span>`;
                btn.className = "flex-1 aspect-square rounded-2xl bg-gray-50 border-2 border-dashed border-gray-300 flex flex-col items-center justify-center hover:bg-gray-100 transition";
            } else {
                const s = SUBJECTS[key];
                btn.innerHTML = `<span class="text-3xl mb-1">${s.icon}</span><span class="text-xs font-bold ${s.color}">${s.name}</span>`;
                btn.className = "flex-1 aspect-square rounded-2xl bg-white border-2 border-indigo-200 flex flex-col items-center justify-center shadow-md ring-2 ring-indigo-50 transition transform active:scale-95";
            }
        },

        startWeek: function() {
            if (this.state.schedule.includes(null)) {
                alert("ê³„íší‘œë¥¼ ì±„ì›Œì£¼ì„¸ìš”!");
                return;
            }

            // ğŸ”¹ í•™ìƒ ëª¨ë“œì—ì„œë§Œ: ì£¼ì°¨ ì‹œì‘ ì§ì „ì— ë°±ì—… ì €ì¥
            if (!this.spectatorMode) {
                this.state.backupBeforeWeek = {
                    week: this.state.week,
                    // í¬ì¼“ëª¬ ìƒíƒœ ì „ì²´ ê¹Šì€ ë³µì‚¬ (ìŠ¤í‚¬/ìŠ¤íƒ¯/ì§„í™” ë‹¨ê³„ í¬í•¨)
                    pokemon: JSON.parse(JSON.stringify(this.state.pokemon)),
                    // ì •ë‹µ ëˆ„ì ë„ í•¨ê»˜ ì €ì¥ (ì›í•˜ë©´ ì œì™¸ ê°€ëŠ¥)
                    playerTotals: {
                        totalCorrect: this.state.player.totalCorrect,
                        totalQuestions: this.state.player.totalQuestions,
                    },
                };
                // ìƒˆë¡œìš´ ì£¼ì°¨ ì‹œì‘ì´ë¯€ë¡œ íŒ¨ë°° ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
                this.state.currentRoundLosses = 0;
            }

            this.queue = [...this.state.schedule];
            this.sessionRes = { atk:0, def:0, skl:0 };
            this.state.combo = 0;
            this.nextSession();
        },


        nextSession: function() {
            if(this.queue.length === 0) { this.finishWeek(); return; }
            this.startQuiz(this.queue.shift());
        },

        startQuiz: function(type) {
            this.currSubject = type;
            this.qCount = 0;
            this.showScreen('screen-quiz');
            document.getElementById('quiz-subject-badge').innerText = SUBJECTS[type].name;
            if(this.state.combo < 2) document.getElementById('quiz-combo-container').classList.add('hidden');
            this.nextQ();
        },

        nextQ: function() {
            if(this.qCount >= 3) { this.nextSession(); return; }
            this.qCount++;
            document.getElementById('quiz-progress').innerText = `${this.qCount}/3`;
            const qData = this.genQ(this.currSubject);
            document.getElementById('quiz-question').innerText = qData.q;
            const div = document.getElementById('quiz-choices');
            div.innerHTML = '';
            qData.a.forEach((ans, i) => {
                const btn = document.createElement('button');
                btn.className = "bg-white/10 hover:bg-white/20 border-2 border-white/30 text-white font-bold py-4 rounded-xl text-3xl transition active:scale-95";
                btn.innerText = ans;
                btn.onclick = () => this.checkAns(i === qData.idx);
                div.appendChild(btn);
            });
            this.startTimer(5);
        },

        startTimer: function(sec) {
            if(this.timerInterval) clearInterval(this.timerInterval);
            this.timeLeft = sec;
            const bar = document.getElementById('quiz-timer-bar');
            bar.style.width = '100%';
            this.timerInterval = setInterval(() => {
                this.timeLeft -= 0.1;
                bar.style.width = `${(this.timeLeft/sec)*100}%`;
                if(this.timeLeft <= 0) { clearInterval(this.timerInterval); this.checkAns(false); }
            }, 100);
        },

        checkAns: function(ok) {
            clearInterval(this.timerInterval);

            // ğŸ”¹ ë¬¸ì œë¥¼ í’€ ë•Œë§ˆë‹¤ ì´ ë¬¸ì œ ìˆ˜ +1
            this.state.player.totalQuestions =
                (this.state.player.totalQuestions || 0) + 1;

            if(ok) {
                this.state.player.totalCorrect++;
                this.state.combo++;
                let bonus = this.state.combo > 1 ? 1 : 0;
                this.sessionRes[SUBJECTS[this.currSubject].stat] += (3 + bonus);
                if(this.state.combo > 1) {
                    const ct = document.getElementById('quiz-combo-text');
                    document.getElementById('quiz-combo-container').classList.remove('hidden');
                    ct.innerText = `${this.state.combo} COMBO!`;
                    ct.classList.remove('combo-pop'); void ct.offsetWidth; ct.classList.add('combo-pop');
                }
            } else {
                this.state.combo = 0;
                document.getElementById('quiz-combo-container').classList.add('hidden');
            }
            this.nextQ();
        },


        genQ: function(type) {
            if(type === 'math') {
                const s = Math.floor(Math.random()*19)+2;
                const a = Math.floor(Math.random()*(s-1))+1;
                let arr = [s, s+1, s-1, s+2].sort(()=>0.5-Math.random());
                return { q: `${a} + ${s-a} = ?`, a: arr, idx: arr.indexOf(s) };
            } else if(type === 'sci') {
                const a = Math.floor(Math.random()*19)+1;
                const b = Math.floor(Math.random()*a);
                const r = a-b;
                let arr = [r, r+1, r+2, Math.abs(r-1)].sort(()=>0.5-Math.random());
                arr = [...new Set(arr)]; while(arr.length<4) arr.push(Math.floor(Math.random()*20));
                return { q: `${a} - ${b} = ?`, a: arr, idx: arr.indexOf(r) };
            } else {
                const icons = ['ğŸ','ğŸŒ','ğŸ‡','â­','â¤ï¸','ğŸ„'];
                let seq = [], A = icons[Math.floor(Math.random()*6)], B = icons[Math.floor(Math.random()*6)];
                while(A===B) B = icons[Math.floor(Math.random()*6)];
                if(Math.random()>0.5) seq=[A,B,A,B]; else seq=[A,A,B,A,A,B];
                const h = Math.floor(Math.random()*seq.length);
                const ans = seq[h];
                let choices = [ans]; while(choices.length<4) { const w=icons[Math.floor(Math.random()*6)]; if(!choices.includes(w)) choices.push(w); }
                return { q: seq.map((x,i)=>i===h?"[?]":x).join(" "), a: choices.sort(()=>0.5-Math.random()), idx: choices.indexOf(ans) };
            }
        },

        finishWeek: function() {
            const pk = this.state.pokemon;
            const r = this.sessionRes;
            pk.stats.atk += r.atk; pk.stats.def += r.def; pk.stats.skl += r.skl;

            let msg = "í›ˆë ¨ ì™„ë£Œ! ìŠ¤íƒ¯ ìƒìŠ¹!";
            if((this.state.week===3 && pk.stage===0) || (this.state.week===6 && pk.stage===1)) {
                pk.stage++; pk.stats.atk+=15; pk.stats.def+=15; pk.stats.hp+=50;
                msg = "ì¶•í•˜í•©ë‹ˆë‹¤! í¬ì¼“ëª¬ì´ ì§„í™”í–ˆìŠµë‹ˆë‹¤!";
            }

            this.showScreen('screen-result');
            const db = POKEMON_DB[this.state.starter];
            document.getElementById('result-poke-img').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${db.stages[pk.stage]}.png`;
            document.getElementById('result-message').innerText = msg;
            document.getElementById('result-stats-list').innerHTML = `<div class="flex justify-between border-b pb-2"><span class="text-red-500 font-bold">ê³µê²© +${r.atk}</span> <span class="text-green-500 font-bold">ë°©ì–´ +${r.def}</span> <span class="text-purple-500 font-bold">ê¸°ìˆ  +${r.skl}</span></div>`;
        },

        checkSkillAcquisition: function() {
            // ìŠ¤í‚¬ íšë“ í™•ë¥ 
            const chance = 0.4 + (this.state.pokemon.stats.skl * 0.002);
            if(Math.random() < chance) {
                const candidates = SKILLS_DB.filter(s => !this.state.pokemon.skills.includes(s.id));
                if(candidates.length > 0) {
                    const pick = candidates[Math.floor(Math.random() * candidates.length)];
                    this.state.pendingSkill = pick;

                    if(this.state.pokemon.skills.length < 4) {
                        this.state.pokemon.skills.push(pick.id);
                        alert(`ìƒˆë¡œìš´ ê¸°ìˆ  [${pick.name}]ì„(ë¥¼) ë°°ì› ìŠµë‹ˆë‹¤!`);
                        this.finishResult();
                    } else {
                        this.showSkillSwapUI(pick);
                    }
                    return;
                }
            }
            this.finishResult();
        },

        showSkillSwapUI: function(newSkill) {
            this.showScreen('screen-skill-learn');
            document.getElementById('new-skill-name').innerText = newSkill.name;
            document.getElementById('new-skill-desc').innerText = newSkill.desc;
            document.getElementById('new-skill-stat').innerText = `ìœ„ë ¥: ${newSkill.power} / ëª…ì¤‘: ${newSkill.acc}`;

            const rMap = {1: 'COMMON', 2: 'RARE', 3: 'EPIC'};
            const rClass = {1: 'rarity-common', 2: 'rarity-rare', 3: 'rarity-epic'};
            document.getElementById('new-skill-rarity').innerText = rMap[newSkill.rarity];
            document.getElementById('new-skill-rarity').className = `text-sm font-bold mb-1 ${rClass[newSkill.rarity]}`;

            const list = document.getElementById('skill-swap-list');
            list.innerHTML = '';
            this.state.pokemon.skills.forEach((sid, idx) => {
                const s = this.getSkillObj(sid);
                const div = document.createElement('div');
                div.className = "bg-white border p-3 rounded-xl flex justify-between items-center cursor-pointer hover:bg-red-50 hover:border-red-300 transition";
                div.innerHTML = `<div><div class="font-bold text-gray-800">${s.name}</div><div class="text-xs text-gray-500">${s.desc}</div></div><button class="bg-red-100 text-red-600 text-xs px-2 py-1 rounded font-bold">ìŠê¸°</button>`;
                div.onclick = () => {
                    if(confirm(`${s.name}ì„(ë¥¼) ìŠê³  ${newSkill.name}ì„(ë¥¼) ë°°ìš°ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        this.state.pokemon.skills[idx] = newSkill.id;
                        this.finishResult();
                    }
                };
                list.appendChild(div);
            });
        },

        giveUpSkill: function() { this.finishResult(); },

        finishResult: function() {
            const round = TOURNAMENT_ROUNDS.find(r => r.week === this.state.week);
            if(round) this.showBracket(round);
            else {
                this.state.week++;
                this.renderMain();
                this.showScreen('screen-main');
            }
        },

        showBracket: function(round) {
            this.currentRound = round;
            this.showScreen('screen-bracket');
            document.getElementById('bracket-title').innerText = round.name;
            document.getElementById('bracket-enemy-img').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${round.enemyId}.png`;
            document.getElementById('bracket-enemy-name').innerText = round.enemyName;
            const db = POKEMON_DB[this.state.starter];
            document.getElementById('bracket-player-img').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${db.stages[this.state.pokemon.stage]}.png`;
        },


        /**
         * ğŸ”¹ êµì‚¬ìš© ê´€ì „ ëª¨ë“œ ì§„ì…
         *
         * config = {
         *   player: { starter, pokemonName, stage, stats: { atk,def,skl,hp } },
         *   enemy:  { starter, pokemonName, stage, stats: { atk,def,skl,hp } },
         *   meta?:  { title?: string, week?: number }
         * }
         *
         * TeacherRoomLivePageì—ì„œ iframe.postMessageë¡œ ë„˜ê¸´ payload ê·¸ëŒ€ë¡œ ë°›ëŠ”ë‹¤.
         */
        startSpectatorBattle: function(config) {
            const player = config?.player || {};
            const enemy  = config?.enemy  || {};
            const meta   = config?.meta   || {};

            // ğŸ‘€ ê´€ì „ ëª¨ë“œ ON
            this.spectatorMode = true;

            // 1) í”Œë ˆì´ì–´(ì™¼ìª½) ì„¤ì •
            this.state.starter = player.starter || "grass";
            const playerDb = POKEMON_DB[this.state.starter];

            this.state.pokemon.name =
                player.pokemonName || (playerDb ? playerDb.name : "í”Œë ˆì´ì–´");
            this.state.pokemon.stage =
                typeof player.stage === "number" ? player.stage : 0;

            this.state.pokemon.stats = {
                atk: player.stats?.atk ?? (playerDb?.stats.atk ?? 10),
                def: player.stats?.def ?? (playerDb?.stats.def ?? 10),
                skl: player.stats?.skl ?? (playerDb?.stats.skl ?? 10),
                hp:  player.stats?.hp  ?? 100,
            };
            // ìŠ¤í‚¬ì€ ê¸°ì¡´ í•™ìƒìš© ê·¸ëŒ€ë¡œ ë‘ê±°ë‚˜, í•„ìš”í•˜ë‹¤ë©´ ë‚˜ì¤‘ì— payloadì— ì¶”ê°€í•´ì„œ ì„¸íŒ…

            // ê´€ì „ìš© week (ë ˆë²¨ í‘œì‹œì—ë§Œ ì‚¬ìš©)
            this.state.week = typeof meta.week === "number" ? meta.week : 8;

            // 2) ìƒëŒ€(ì˜¤ë¥¸ìª½) ìŠ¤í”„ë¼ì´íŠ¸ ID ê³„ì‚°
            const enemyStarter = enemy.starter || "fire";
            const enemyStage   = typeof enemy.stage === "number" ? enemy.stage : 0;
            const enemyDb      = POKEMON_DB[enemyStarter];
            const enemySpriteId =
                enemyDb?.stages?.[enemyStage] ?? TOURNAMENT_ROUNDS[0].enemyId;

            // 3) currentRoundì— ê´€ì „ìš© ì •ë³´ ì„¸íŒ…
            this.currentRound = {
                week: this.state.week,
                name: meta.title || "í´ë˜ìŠ¤ í† ë„ˆë¨¼íŠ¸",
                enemyId: enemySpriteId,
                enemyName: enemy.pokemonName || enemy.name || "ìƒëŒ€",
                difficultyRatio: 1.0,

                // ğŸ‘‡ ê´€ì „ ëª¨ë“œì—ì„œ ì‚¬ìš©í•  ì  ìŠ¤íƒ¯
                enemyHp: enemy.stats?.hp  ?? 100,
                enemyAtk: enemy.stats?.atk ?? 20,
            };

            // 4) ë©”ì¸ í™”ë©´ë„ ìµœì‹  ìŠ¤íƒ¯ìœ¼ë¡œ ì—…ë°ì´íŠ¸(ì„ íƒì‚¬í•­ì´ì§€ë§Œ ë³´ê¸° ì¢‹ìŒ)
            this.renderMain();

            // 5) ë¸Œë˜í‚· í™”ë©´ìœ¼ë¡œ ì „í™˜ (ê¸°ì¡´ ë²„íŠ¼ "ê²½ê¸°ì¥ ì…ì¥!"ì´ initBattleReal í˜¸ì¶œ)
            this.showBracket(this.currentRound);
        },


        // --- ìë™ ì „íˆ¬ ì‹œìŠ¤í…œ ---
        initBattleReal: function() {
            this.showScreen('screen-battle');
            document.getElementById('battle-result-overlay').classList.add('hidden');
            document.getElementById('battle-result-overlay').classList.remove('flex');

            const r = this.currentRound;
            const pStats = this.state.pokemon.stats;

            // ğŸ”¹ ê´€ì „ ëª¨ë“œë©´ currentRound.enemyHp / enemyAtk ì‚¬ìš©
            let eHp, eAtk;
            if (
                this.spectatorMode &&
                r &&
                typeof r.enemyHp === "number" &&
                typeof r.enemyAtk === "number"
            ) {
                eHp = r.enemyHp;
                eAtk = r.enemyAtk;
            } else {
                // ê¸°ì¡´ ë¡œì§: í”Œë ˆì´ì–´ ìŠ¤íƒ¯ + difficultyRatio ê¸°ë°˜ìœ¼ë¡œ ì  ëŠ¥ë ¥ì¹˜ ê³„ì‚°
                const baseRatio = r?.difficultyRatio ?? 1.0;
                eHp = Math.floor(pStats.hp * 1.2 * baseRatio);
                eAtk = Math.floor(pStats.atk * baseRatio);
            }

            const playerSpd = pStats.spd ?? 10;
            const enemySpdBase = r?.difficultyRatio ?? 1.0;
            const enemySpd = Math.max(5, Math.floor(playerSpd * enemySpdBase));

            this.battle = {
                player: {
                    hp: pStats.hp,
                    maxHp: pStats.hp,
                    atk: pStats.atk,
                    def: pStats.def,
                    spd: playerSpd,
                },
                enemy: {
                    hp: eHp,
                    maxHp: eHp,
                    atk: eAtk,
                    name: r?.enemyName ?? "ìƒëŒ€",
                    spd: enemySpd,
                },
                status: {
                    player: { burn: 0, poison: 0 },
                    enemy: { burn: 0, poison: 0 },
                },
                turn: true, // true: player, false: enemy
            };


            const db = POKEMON_DB[this.state.starter];
            document.getElementById('battle-player-sprite').src =
                `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/back/${db.stages[this.state.pokemon.stage]}.png`;
            document.getElementById('battle-player-name').innerText = this.state.pokemon.name;
            document.getElementById('player-level').innerText = this.state.week * 2;
            document.getElementById('enemy-sprite').src =
                `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${r.enemyId}.png`;
            document.getElementById('enemy-name').innerText = r.enemyName;
            document.getElementById('enemy-level').innerText = this.state.week * 2 + 1;

            this.updateBattleUI();
            this.logBattle(`ì•¼ìƒì˜ ${r.enemyName}(ì´)ê°€ ë‚˜íƒ€ë‚¬ë‹¤!`);

            // 2ì´ˆ ë’¤ ìë™ ì „íˆ¬ ì‹œì‘
            setTimeout(() => this.runAutoBattle(), 2000);
        },


        runAutoBattle: async function() {
            const b = this.battle;
            if (!b) return;

            // ğŸ”¹ í„´ ì‹œì‘ ì‹œ ìƒíƒœì´ìƒ ë°ë¯¸ì§€ (í™”ìƒ/ë…)
            const applyDot = (whoKey, label) => {
                if (!b.status || !b.status[whoKey]) return;
                const st = b.status[whoKey];
                const target = whoKey === 'player' ? b.player : b.enemy;

                if (st.burn && st.burn > 0) {
                    const dot = Math.max(1, Math.floor(target.maxHp * 0.05));
                    target.hp -= dot;
                    this.logBattle(`${label}ëŠ” í™”ìƒìœ¼ë¡œ ${dot}ì˜ í”¼í•´ë¥¼ ì…ì—ˆë‹¤!`);
                    st.burn--;
                }
                if (st.poison && st.poison > 0) {
                    const dot = Math.max(1, Math.floor(target.maxHp * 0.06));
                    target.hp -= dot;
                    this.logBattle(`${label}ëŠ” ë…ìœ¼ë¡œ ${dot}ì˜ í”¼í•´ë¥¼ ì…ì—ˆë‹¤!`);
                    st.poison--;
                }
            };

            applyDot('player', this.state.pokemon.name);
            applyDot('enemy', b.enemy.name);
            this.updateBattleUI();

            if (b.player.hp <= 0) { this.battleWin(false); return; }
            if (b.enemy.hp <= 0) { this.battleWin(true); return; }

            // ğŸ”¹ SPD ê¸°ë°˜ ì„ ê³µ ê²°ì •
            const playerSpd = this.state.pokemon.stats.spd ?? 10;
            const enemySpd = b.enemy.spd ?? playerSpd;
            const playerFirst = playerSpd >= enemySpd;

            // ğŸ”¹ ë°ë¯¸ì§€ ê³µì‹ (ê³µê²©ë ¥ + ìœ„ë ¥ + ì•½ê°„ì˜ ëœë¤)
            const calcDamage = (atk, power) => {
                const base = power + atk * 0.4;
                const rand = 0.9 + Math.random() * 0.2;
                return Math.max(1, Math.floor(base * rand));
            };

            // ğŸ”¹ í”Œë ˆì´ì–´ í„´
            const doPlayerTurn = async () => {
                const useSkill =
                    Math.random() < 0.6 && this.state.pokemon.skills.length > 0;
                let skill = null;
                if (useSkill && this.state.pokemon.skills.length > 0) {
                    const sId =
                        this.state.pokemon.skills[
                            Math.floor(Math.random() * this.state.pokemon.skills.length)
                            ];
                    skill = this.getSkillObj(sId);
                }

                if (skill) {
                    const acc = skill.acc ?? 100;
                    const hitRoll = Math.random() * 100;

                    this.logBattle(`[ë°œë™] ${this.state.pokemon.name}ì˜ ${skill.name}!`);
                    this.showSkillTrigger(skill.name);
                    await this.animAttack('player');

                    if (hitRoll > acc) {
                        this.logBattle(`í•˜ì§€ë§Œ ê³µê²©ì´ ë¹—ë‚˜ê°”ë‹¤!`);
                        await this.animHit('enemy');
                        return;
                    }

                    if (skill.type === 'def') {
                        const heal = skill.power;
                        b.player.hp = Math.min(b.player.maxHp, b.player.hp + heal);
                        this.logBattle(`>> ì²´ë ¥ì„ ${heal} íšŒë³µí–ˆë‹¤!`);
                    } else {
                        const dmg = calcDamage(b.player.atk, skill.power);
                        b.enemy.hp -= dmg;
                        this.showDmgText('enemy', dmg);
                        await this.animHit('enemy');

                        // ğŸ”¸ íŠ¹ìˆ˜(eff) ìŠ¤í‚¬ ì¶”ê°€ íš¨ê³¼ ì²˜ë¦¬
                        if (skill.type === 'eff' && b.status && b.status.enemy) {
                            if (skill.effect === 'drain') {
                                const ratio = skill.drainRatio ?? 0.5;
                                const healAmt = Math.max(
                                    1,
                                    Math.floor(dmg * ratio),
                                );
                                b.player.hp = Math.min(
                                    b.player.maxHp,
                                    b.player.hp + healAmt,
                                );
                                this.logBattle(
                                    `>> ì…íŒ í”¼í•´ì˜ ì¼ë¶€ë¥¼ í¡ìˆ˜í•˜ì—¬ ${healAmt} íšŒë³µí–ˆë‹¤!`,
                                );
                            } else if (skill.effect === 'burn') {
                                const chance = skill.effectChance ?? 1.0;
                                if (Math.random() < chance) {
                                    b.status.enemy.burn = Math.max(
                                        b.status.enemy.burn || 0,
                                        3,
                                    );
                                    this.logBattle(`>> ìƒëŒ€ê°€ í™”ìƒ ìƒíƒœê°€ ë˜ì—ˆë‹¤!`);
                                }
                            } else if (skill.effect === 'poison') {
                                const chance = skill.effectChance ?? 1.0;
                                if (Math.random() < chance) {
                                    b.status.enemy.poison = Math.max(
                                        b.status.enemy.poison || 0,
                                        3,
                                    );
                                    this.logBattle(`>> ìƒëŒ€ê°€ ë… ìƒíƒœê°€ ë˜ì—ˆë‹¤!`);
                                }
                            }
                        }
                    }
                } else {
                    this.logBattle(`${this.state.pokemon.name}ì˜ ê¸°ë³¸ ê³µê²©!`);
                    await this.animAttack('player');
                    const dmg = calcDamage(b.player.atk, 10);
                    b.enemy.hp -= dmg;
                    this.showDmgText('enemy', dmg);
                    await this.animHit('enemy');
                }

                this.updateBattleUI();
            };

            // ğŸ”¹ ì  í„´ (ë‹¨ìˆœ ë¬¼ë¦¬ ê³µê²© + ë°©ì–´ ë³´ì •)
            const doEnemyTurn = async () => {
                this.logBattle(`${b.enemy.name}ì˜ ê³µê²©!`);
                await this.animAttack('enemy');

                let eDmg = Math.floor(
                    (b.enemy.atk * 0.5 + 20) * (0.85 + Math.random() * 0.3),
                );
                eDmg = Math.max(
                    1,
                    eDmg - Math.floor(this.state.pokemon.stats.def * 0.3),
                );

                b.player.hp -= eDmg;
                this.showDmgText('player', eDmg);
                await this.animHit('player');
                this.updateBattleUI();
            };

            // ğŸ”¹ ì„ ê³µ/í›„ê³µ ìˆœì„œëŒ€ë¡œ í„´ ì§„í–‰
            if (playerFirst) {
                await doPlayerTurn();
                if (b.enemy.hp <= 0) {
                    this.battleWin(true);
                    return;
                }

                await this.wait(700);
                await doEnemyTurn();
                if (b.player.hp <= 0) {
                    this.battleWin(false);
                    return;
                }
            } else {
                await doEnemyTurn();
                if (b.player.hp <= 0) {
                    this.battleWin(false);
                    return;
                }

                await this.wait(700);
                await doPlayerTurn();
                if (b.enemy.hp <= 0) {
                    this.battleWin(true);
                    return;
                }
            }

            // ë‹¤ìŒ ë¼ìš´ë“œ
            setTimeout(() => this.runAutoBattle(), 1000);
        },

        showSkillTrigger: function(name) {
            const el = document.getElementById('skill-trigger-overlay');
            const txt = document.getElementById('skill-trigger-text');
            txt.innerText = `${name}!`;
            el.style.opacity = '1';
            txt.classList.add('anim-skill-trigger');
            setTimeout(() => {
                el.style.opacity = '0';
                txt.classList.remove('anim-skill-trigger');
            }, 800);
        },

        updateBattleUI: function() {
            const b = this.battle;
            const pPct = Math.max(0, (b.player.hp / b.player.maxHp)*100);
            const ePct = Math.max(0, (b.enemy.hp / b.enemy.maxHp)*100);
            document.getElementById('player-hp-bar').style.width = `${pPct}%`;
            document.getElementById('player-hp-bar').className = `h-full ${pPct<30?'bg-red-500':'bg-green-400'} transition-all duration-500`;
            document.getElementById('enemy-hp-bar').style.width = `${ePct}%`;
        },

        logBattle: function(msg) {
            const el = document.getElementById('battle-log');
            el.innerText = msg;
            el.classList.add('animate-pulse');
            setTimeout(() => el.classList.remove('animate-pulse'), 200);
        },

        showDmgText: function(who, dmg) {
            const el = document.getElementById(`${who}-damage-text`);
            el.innerText = `-${dmg}`;
            el.classList.remove('opacity-0');
            el.animate([{ transform: 'translateY(0)', opacity: 1 }, { transform: 'translateY(-20px)', opacity: 0 }], { duration: 800, fill: 'forwards' });
        },

        battleWin: function(win) {
            const ol = document.getElementById('battle-result-overlay');
            ol.classList.remove('hidden'); ol.classList.add('flex');
            document.getElementById('battle-result-icon').innerText = win ? "ğŸ†" : "ğŸ˜­";
            document.getElementById('battle-result-text').innerText = win ? "ìŠ¹ë¦¬!" : "íŒ¨ë°°...";
            this.lastWin = win;
        },

        // PEM_RUN_COMPLETE ê·¼ì²˜ì˜ script ì•ˆ, Game ê°ì²´ ì•ˆì— ë³´ì¡° í•¨ìˆ˜ í•˜ë‚˜ ì¶”ê°€
        notifySpectatorResult: function (result) {
            // ê´€ì „ ëª¨ë“œì—ì„œë§Œ ë¶€ëª¨(êµì‹¤ í™”ë©´)ë¡œ ê²°ê³¼ ë³´ë‚´ê¸°
            if (this.spectatorMode && window.parent && window.parent !== window) {
                window.parent.postMessage(
                    {
                        type: "PEM_SPECTATOR_RESULT",
                        payload: {
                            result,            // "player" | "enemy"
                            week: this.state.week,
                        },
                    },
                    "*",
                );
            }
        },

        endBattle: function() {
            const overlay = document.getElementById('battle-result-overlay');

            if (this.lastWin) {
                // ğŸ”¹ ê´€ì „ ëª¨ë“œ(êµì‚¬ í† ë„ˆë¨¼íŠ¸)ì¸ ê²½ìš°: ê·¸ëƒ¥ ì˜¤ë²„ë ˆì´ë§Œ ë‹«ê³  ì¢…ë£Œ
                if (this.spectatorMode) {
                    if (overlay) {
                        overlay.classList.add('hidden');
                        overlay.classList.remove('flex');
                    }
                    this.logBattle("ê²½ê¸°ê°€ ëë‚¬ìŠµë‹ˆë‹¤! (ìŠ¹ë¦¬)");
                    return;
                }

                // ğŸ”¹ í•™ìƒ ëª¨ë“œ â€“ ìŠ¹ë¦¬
                if (this.state.week === 8) {
                    // ê²°ìŠ¹ ìŠ¹ë¦¬ â†’ ì—”ë”©ìœ¼ë¡œ
                    this.showEnding();
                } else {
                    // ë‹¤ìŒ ì£¼ì°¨ë¡œ
                    this.state.week++;
                    this.renderMain();
                    this.showScreen('screen-main');
                }
            } else {
                // ğŸ”¹ íŒ¨ë°°í•œ ê²½ìš°
                if (this.spectatorMode) {
                    // ê´€ì „ ëª¨ë“œ: ë‹¤ìŒ ê²½ê¸° í¸ì„±ì€ êµì‚¬ ìª½ì—ì„œ ë‹¤ì‹œ ë³´ëƒ„
                    if (overlay) {
                        overlay.classList.add('hidden');
                        overlay.classList.remove('flex');
                    }
                    this.logBattle("ê²½ê¸°ê°€ ëë‚¬ìŠµë‹ˆë‹¤! (íŒ¨ë°°)");
                    return;
                }

                // --- í•™ìƒ ëª¨ë“œ íŒ¨ë°° ì²˜ë¦¬ ---

                // 1) ê²°ìŠ¹ì—ì„œ ì§„ ê²½ìš°: ì£¼ì°¨ ë¡¤ë°± ëŒ€ì‹  ê·¸ëƒ¥ ì—”ë”©/ë¦¬ì…‹ íë¦„
                if (this.state.week === 8) {
                    alert("ì•„ì‰½ì§€ë§Œ ê²°ìŠ¹ì—ì„œ ì¡Œì–´ìš”! í›ˆë ¨ì„ ë” í•´ì„œ ë‹¤ì‹œ ë„ì „í•´ ë³´ì!");
                    this.renderMain();
                    this.showScreen('screen-main');
                    return;
                }

                // 2) ì¤‘ê°„ ë¼ìš´ë“œ íŒ¨ë°°: ë°±ì—…ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì£¼ì°¨ ì‹œì‘ ì „ìœ¼ë¡œ ë¡¤ë°±
                if (
                    this.state.backupBeforeWeek &&
                    this.state.backupBeforeWeek.week === this.state.week
                ) {
                    this.state.pokemon = JSON.parse(
                        JSON.stringify(this.state.backupBeforeWeek.pokemon),
                    );
                    this.state.player.totalCorrect =
                        this.state.backupBeforeWeek.playerTotals.totalCorrect;
                    this.state.player.totalQuestions =
                        this.state.backupBeforeWeek.playerTotals.totalQuestions;
                }

                // 3) íŒ¨ë°° ì¹´ìš´íŠ¸ ì¦ê°€
                this.state.currentRoundLosses =
                    (this.state.currentRoundLosses || 0) + 1;

                // 4) 2ë²ˆ íŒ¨ë°° ì‹œ: ì´ë²ˆ ìœ¡ì„± ì¢…ë£Œ(ì—”ë”©)
                if (this.state.currentRoundLosses >= 2) {
                    alert("ë‘ ë²ˆì´ë‚˜ ì¡Œì–´ìš”! ì´ë²ˆ ëª¨í—˜ì€ ì—¬ê¸°ê¹Œì§€ í•˜ê³ , ë‹¤ìŒì— ë” ê°•í•´ì ¸ì„œ ë‹¤ì‹œ ë„ì „í•´ ë³´ì!");
                    this.showEnding(); // ğŸ‘‰ í˜„ì¬ ìŠ¤íƒ¯/ì •ë‹µ ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ 'ë„ì „ì' ì—”ë”© ë“±
                    return;
                }

                // 5) ì²« íŒ¨ë°°: ì£¼ì°¨ ë¡¤ë°± + ë‹¤ì‹œ í›ˆë ¨ í™”ë©´ìœ¼ë¡œ
                alert("ì´ë²ˆ ì£¼ ê²½ê¸°ëŠ” íŒ¨ë°°í–ˆì–´ìš”. í›ˆë ¨ì„ ë‹¤ì‹œ ê³„íší•´ ë³¼ê¹Œìš”?");
                this.renderMain();
                this.showScreen('screen-main');
            }
        },




        // ğŸ”¹ ì—”ë”© í™”ë©´ ì§„ì… + ìš”ì•½ ë°ì´í„° ìƒì„±
        showEnding: function() {
            this.showScreen('screen-ending');

            const db = POKEMON_DB[this.state.starter];
            const pk = this.state.pokemon;
            const totalCorrect = this.state.player.totalCorrect || 0;
            const totalQuestions = this.state.player.totalQuestions || 0;

            // ì—”ë”© ì´ë¯¸ì§€ ì„¤ì •
            const endingImgEl = document.getElementById('ending-img');
            if (endingImgEl && db) {
                endingImgEl.src =
                    `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${db.stages[pk.stage]}.png`;
            }

            // ì ìˆ˜ í‘œì‹œ
            const scoreEl = document.getElementById('ending-score');
            if (scoreEl) {
                scoreEl.innerText = `${totalCorrect} ë¬¸ì œ`;
            }

            // ê°„ë‹¨ ë­í¬ ê³„ì‚° (ì •ë‹µë¥  ê¸°ì¤€)
            const rate = totalQuestions > 0 ? totalCorrect / totalQuestions : 0;
            let rank = "ë„ì „ì";
            if (rate >= 0.9) rank = "ì „ì„¤ì˜ íŠ¸ë ˆì´ë„ˆ";
            else if (rate >= 0.7) rank = "ì±”í”¼ì–¸ í›„ë³´";
            else if (rate >= 0.5) rank = "ì„±ì¥ ì¤‘ì¸ íŠ¸ë ˆì´ë„ˆ";

            const rankEl = document.getElementById('ending-rank');
            if (rankEl) {
                rankEl.innerText = rank;
            }

            // ğŸ”¹ êµì‚¬ ìª½ìœ¼ë¡œ ë³´ë‚¼ ìš”ì•½ ë°ì´í„° ìƒì„±
            const summary = {
                runId: `pem-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
                version: "pem-v1",

                // ğŸ”¹ ì–´ë”” ë°©/ì–´ëŠ í•™ìƒì¸ì§€ ì‹ë³„ìš©
                roomId: PEM_ROOM_ID,
                studentId: PEM_STUDENT_ID,

                starter: this.state.starter,      // "grass" | "fire" | "water"
                pokemonName: pk.name,
                stage: pk.stage,
                stats: {
                    atk: pk.stats.atk,
                    def: pk.stats.def,
                    skl: pk.stats.skl,
                    hp:  pk.stats.hp,
                },
                totalCorrect,
                totalQuestions,
                weekReached: this.state.week,
                endedAt: new Date().toISOString(),
            };


            // ğŸ”¹ ë‚˜ì¤‘ì— ë²„íŠ¼ì—ì„œ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ë³´ê´€
            this.state.lastSummary = summary;

            // ğŸ”¹ textareaì—ë„ ë„£ì–´ ë‘ê¸° (êµì‚¬ ë””ë²„ê·¸ìš©)
            const exportEl = document.getElementById('ending-export-json');
            if (exportEl) {
                exportEl.value = JSON.stringify(summary);
            }
        },

        // ğŸ”¹ 1í•™ë…„ìš©: ë²„íŠ¼ í•œ ë²ˆìœ¼ë¡œ ì„ ìƒë‹˜ê»˜ ë³´ë‚´ê¸°
        sendToTeacher: function() {
            // ìš”ì•½ ë°ì´í„°ê°€ ì—†ë‹¤ë©´ í•œ ë²ˆ ë” ìƒì„±
            if (!this.state.lastSummary) {
                this.showEnding();
            }
            const summary = this.state.lastSummary;

            try {
                if (window.parent && window.parent !== window) {
                    window.parent.postMessage(
                        { type: "PEM_RUN_COMPLETE", payload: summary },
                        "*"
                    );
                }
                // ì•„ì´ë“¤ìš© í”¼ë“œë°±
                alert("ì„ ìƒë‹˜ê»˜ ë³´ëƒˆì–´ìš”! ğŸ‘");
            } catch (err) {
                console.warn("[PEM] sendToTeacher postMessage ì‹¤íŒ¨", err);
                alert("ì•—, ì„ ìƒë‹˜ê»˜ ë³´ë‚´ëŠ” ë° ë¬¸ì œê°€ ìƒê²¼ì–´ìš”.");
            }
        },


        animAttack: function(who) {
            return new Promise(r => {
                const el = document.getElementById(who==='player'?'battle-player-sprite':'enemy-sprite');
                el.classList.add(who==='player'?'anim-attack-right':'anim-attack-left');
                setTimeout(()=>{ el.classList.remove(who==='player'?'anim-attack-right':'anim-attack-left'); r(); }, 300);
            });
        },
        animHit: function(who) {
            return new Promise(r => {
                const el = document.getElementById(who==='player'?'battle-player-sprite':'enemy-sprite');
                el.classList.add('anim-hit');
                setTimeout(()=>{ el.classList.remove('anim-hit'); r(); }, 400);
            });
        },
        wait: function(ms) { return new Promise(r => setTimeout(r, ms)); },
        showScreen: function(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    };

    Game.init();

    // ğŸ”¹ êµì‚¬ìš© í† ë„ˆë¨¼íŠ¸ ê´€ì „: ë¶€ëª¨(TeacherRoomLivePage)ì—ì„œ ì˜¤ëŠ” ë©”ì‹œì§€ ì²˜ë¦¬
    window.addEventListener("message", (event) => {
        const data = event.data;
        if (!data || typeof data !== "object") return;

        if (data.type === "PEM_START_SPECTATOR_BATTLE") {
            try {
                Game.startSpectatorBattle(data.payload || {});
            } catch (err) {
                console.error("[PEM] startSpectatorBattle error", err);
            }
        }
    });
</script>
</body>
</html>
