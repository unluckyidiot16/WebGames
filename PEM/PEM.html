<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í¬ì¼“ ìˆ˜í•™ í† ë„ˆë¨¼íŠ¸ V3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f3f4f6;
            touch-action: manipulation;
            user-select: none;
        }
        .game-font { font-family: 'Jua', sans-serif; }

        /* í™”ë©´ ì „í™˜ íš¨ê³¼ */
        .screen { display: none; opacity: 0; transition: opacity 0.4s ease; }
        .screen.active { display: flex; opacity: 1; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        .bounce { animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* ì „íˆ¬ ì• ë‹ˆë©”ì´ì…˜ */
        .anim-attack-right { animation: lungeRight 0.2s forwards; }
        @keyframes lungeRight { 0% { transform: translateX(0); } 50% { transform: translateX(80px) scale(1.1); } 100% { transform: translateX(0); } }

        .anim-attack-left { animation: lungeLeft 0.2s forwards; }
        @keyframes lungeLeft { 0% { transform: translateX(0) scaleX(-1); } 50% { transform: translateX(-80px) scaleX(-1) scale(1.1); } 100% { transform: translateX(0) scaleX(-1); } }

        .anim-hit { animation: shakeRed 0.4s; }
        @keyframes shakeRed {
            0% { transform: translateX(0); filter: none; }
            20% { transform: translateX(-10px) filter: sepia(1) hue-rotate(-50deg) saturate(5); opacity: 0.8; }
            40% { transform: translateX(10px); }
            60% { transform: translateX(-10px); }
            80% { transform: translateX(10px); filter: none; opacity: 1; }
            100% { transform: translateX(0); }
        }

        .defeated-gray { filter: grayscale(100%) opacity(0.5); transition: filter 1s ease; }

        /* ê²Œì´ì§€ ë°” */
        .stat-bar-bg { background-color: #e5e7eb; border-radius: 9999px; height: 12px; overflow: hidden; border: 1px solid #d1d5db; }
        .stat-bar-fill { height: 100%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }

        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .game-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            max-width: 480px; width: 100%; margin: 0 auto; overflow: hidden;
            border: 4px solid #fff;
        }

        /* íŒŒìŠ¤í…” ë°°ê²½ ìœ í‹¸ë¦¬í‹° */
        .bg-pastel-blue { background: linear-gradient(135deg, #E0F2FE 0%, #F0F9FF 100%); }
        .bg-pastel-green { background: linear-gradient(135deg, #DCFCE7 0%, #F0FDF4 100%); }
        .bg-pastel-arena { background: linear-gradient(to bottom, #bfdbfe 0%, #dbeafe 40%, #86efac 40%, #bbf7d0 100%); }
    </style>
</head>
<body class="bg-indigo-50 min-h-screen flex items-center justify-center p-4">

<div id="game-container" class="game-card relative min-h-[750px] flex flex-col">

    <!-- 1. íƒ€ì´í‹€ í™”ë©´ -->
    <div id="screen-title" class="screen active flex-col items-center justify-center h-full absolute inset-0 bg-pastel-blue z-50">
        <h1 class="text-4xl font-bold text-indigo-600 mb-2 game-font text-center drop-shadow-sm">í¬ì¼“ ìˆ˜í•™<br>í† ë„ˆë¨¼íŠ¸</h1>
        <p class="text-gray-500 mb-10 game-font text-lg">ìµœê°•ì˜ ìˆ˜í•™ì™•ì— ë„ì „í•˜ë¼!</p>

        <div class="flex gap-6 mb-12">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png" class="w-20 h-20 bounce">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png" class="w-20 h-20 bounce" style="animation-delay: 0.2s">
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png" class="w-20 h-20 bounce" style="animation-delay: 0.4s">
        </div>

        <button onclick="Game.startNewGame()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-4 px-12 rounded-full shadow-lg transform transition hover:scale-105 text-xl game-font">
            ëª¨í—˜ ì‹œì‘í•˜ê¸°
        </button>
    </div>

    <!-- 2. íŒŒíŠ¸ë„ˆ ì„ íƒ -->
    <div id="screen-select" class="screen flex-col h-full bg-white p-6 absolute inset-0 z-40">
        <h2 class="text-2xl game-font font-bold text-center mb-8 text-gray-700">í•¨ê»˜í•  íŒŒíŠ¸ë„ˆë¥¼ ê³¨ë¼ì¤˜!</h2>
        <div class="space-y-4">
            <div onclick="Game.chooseStarter('grass')" class="border-4 border-green-200 bg-green-50 hover:bg-green-100 rounded-3xl p-4 flex items-center cursor-pointer transition transform hover:-translate-y-1">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/1.png" class="w-24 h-24 bg-white rounded-full p-2 mr-4 shadow-sm">
                <div>
                    <h3 class="font-bold text-xl text-green-700 game-font">ì´ìƒí•´ì”¨ (í’€)</h3>
                    <p class="text-sm text-green-600">ëº„ì…ˆ ë°©ì–´ íŠ¹í™”</p>
                </div>
            </div>
            <div onclick="Game.chooseStarter('fire')" class="border-4 border-red-200 bg-red-50 hover:bg-red-100 rounded-3xl p-4 flex items-center cursor-pointer transition transform hover:-translate-y-1">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/4.png" class="w-24 h-24 bg-white rounded-full p-2 mr-4 shadow-sm">
                <div>
                    <h3 class="font-bold text-xl text-red-700 game-font">íŒŒì´ë¦¬ (ë¶ˆ)</h3>
                    <p class="text-sm text-red-600">ë§ì…ˆ ê³µê²© íŠ¹í™”</p>
                </div>
            </div>
            <div onclick="Game.chooseStarter('water')" class="border-4 border-blue-200 bg-blue-50 hover:bg-blue-100 rounded-3xl p-4 flex items-center cursor-pointer transition transform hover:-translate-y-1">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/7.png" class="w-24 h-24 bg-white rounded-full p-2 mr-4 shadow-sm">
                <div>
                    <h3 class="font-bold text-xl text-blue-700 game-font">ê¼¬ë¶€ê¸° (ë¬¼)</h3>
                    <p class="text-sm text-blue-600">ê·œì¹™ ê¸°ìˆ  íŠ¹í™”</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 3. ë©”ì¸ (í›ˆë ¨/ìœ¡ì„±) -->
    <div id="screen-main" class="screen flex-col h-full bg-white relative z-30">
        <!-- ìƒë‹¨ ì •ë³´ -->
        <div class="p-5 flex justify-between items-end bg-pastel-blue rounded-b-3xl shadow-sm z-10">
            <div>
                <div class="text-xs font-bold text-indigo-400 mb-1" id="league-info">16ê°• ì˜ˆì„ ì „</div>
                <h2 class="text-3xl font-bold game-font text-gray-800" id="main-week-display">1ì£¼ì°¨</h2>
            </div>
            <!-- í”¼ë¡œë„ ì‚­ì œë¨ -->
        </div>

        <!-- í¬ì¼“ëª¬ & ìŠ¤íƒ¯ -->
        <div class="flex-1 flex flex-col items-center justify-center relative -mt-4">
            <div class="relative group flex flex-col items-center" onclick="Game.pokeTouch()">
                <!-- í¬ì¼“ëª¬ ì´ë¯¸ì§€ (í¬ê¸° ì¡°ì •ë¨) -->
                <img id="main-poke-img" src="" class="object-contain drop-shadow-lg transition-transform duration-500">

                <div id="main-emotion-bubble" class="absolute -top-6 right-0 bg-white px-4 py-2 rounded-2xl text-sm font-bold shadow border border-gray-100 game-font animate-pulse hidden">
                    í˜ë‚´ì!
                </div>

                <!-- ì´ë¦„ê³¼ ìŠ¤íƒ¯ì´ ë°”ë¡œ ì•„ë˜ ë¶™ë„ë¡ ìœ„ì¹˜ ì¡°ì • -->
                <h3 id="main-poke-name" class="text-2xl font-bold text-center text-gray-800 game-font mt-2 mb-2">ì´ë¦„</h3>
            </div>

            <div class="w-full max-w-xs px-6">
                <div class="bg-gray-50 rounded-2xl p-4 space-y-3 shadow-inner">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-bold text-red-500">âš”ï¸ ê³µê²© (ë§ì…ˆ)</span>
                        <span class="text-lg font-bold text-gray-600 game-font" id="stat-atk">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-bold text-green-500">ğŸ›¡ï¸ ë°©ì–´ (ëº„ì…ˆ)</span>
                        <span class="text-lg font-bold text-gray-600 game-font" id="stat-def">0</span>
                    </div>
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-bold text-purple-500">âœ¨ ê¸°ìˆ  (ê·œì¹™)</span>
                        <span class="text-lg font-bold text-gray-600 game-font" id="stat-skl">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- í•˜ë‹¨ ìŠ¤ì¼€ì¤„ -->
        <div class="p-6 bg-white border-t border-gray-100 rounded-t-3xl shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
            <h4 class="text-lg game-font font-bold text-gray-700 mb-4">ì´ë²ˆ ì£¼ í›ˆë ¨ ê³„íš</h4>
            <div class="flex gap-3 mb-4">
                <button onclick="Game.toggleSchedule(0)" id="sched-0" class="flex-1 aspect-square rounded-2xl bg-gray-50 border-2 border-dashed border-gray-300 flex flex-col items-center justify-center hover:bg-gray-100 transition">
                    <span class="text-3xl text-gray-300">?</span>
                </button>
                <button onclick="Game.toggleSchedule(1)" id="sched-1" class="flex-1 aspect-square rounded-2xl bg-gray-50 border-2 border-dashed border-gray-300 flex flex-col items-center justify-center hover:bg-gray-100 transition">
                    <span class="text-3xl text-gray-300">?</span>
                </button>
                <button onclick="Game.toggleSchedule(2)" id="sched-2" class="flex-1 aspect-square rounded-2xl bg-gray-50 border-2 border-dashed border-gray-300 flex flex-col items-center justify-center hover:bg-gray-100 transition">
                    <span class="text-3xl text-gray-300">?</span>
                </button>
            </div>
            <button onclick="Game.startWeek()" class="w-full bg-indigo-500 text-white text-lg game-font font-bold py-4 rounded-2xl shadow-md active:scale-95 transition">
                í›ˆë ¨ ì‹œì‘!
            </button>
        </div>
    </div>

    <!-- 4. í€´ì¦ˆ í™”ë©´ -->
    <div id="screen-quiz" class="screen flex-col h-full bg-indigo-600 text-white relative z-50 p-6">
        <div class="flex justify-between items-center mb-8">
            <span id="quiz-subject-badge" class="bg-white/20 px-4 py-1 rounded-full text-sm font-bold text-yellow-300">ìˆ˜í•™ í›ˆë ¨</span>
            <span class="text-xl font-bold game-font" id="quiz-progress">1/3</span>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center">
            <div class="w-full bg-white text-gray-800 p-8 rounded-3xl mb-8 shadow-xl text-center relative">
                <div class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-yellow-400 text-yellow-900 px-4 py-1 rounded-full text-sm font-bold shadow-sm">ë¬¸ì œ</div>
                <h2 id="quiz-question" class="text-4xl font-bold game-font mt-2 leading-relaxed">5 + 3 = ?</h2>
            </div>

            <div id="quiz-choices" class="grid grid-cols-2 gap-4 w-full">
                <!-- JS generated -->
            </div>
        </div>
    </div>

    <!-- 5. ì£¼ê°„ ê²°ê³¼ í™”ë©´ -->
    <div id="screen-result" class="screen flex-col h-full bg-pastel-green p-6 justify-center z-50 items-center">
        <h2 class="text-3xl font-bold game-font text-green-800 mb-2">í›ˆë ¨ ì™„ë£Œ!</h2>
        <p class="text-green-600 mb-8" id="result-week-text">1ì£¼ì°¨ ì¢…ë£Œ</p>

        <img id="result-poke-img" src="" class="w-32 h-32 mb-6 drop-shadow-md bounce">

        <div class="bg-white rounded-2xl p-6 w-full shadow-lg mb-6">
            <div class="font-bold text-xl text-center text-gray-700 game-font mb-4" id="result-message">ëŠ¥ë ¥ì¹˜ê°€ ì˜¬ëë‹¤!</div>
            <div class="space-y-3" id="result-stats-list">
                <!-- Stats -->
            </div>
        </div>

        <button onclick="Game.finishResult()" class="w-full bg-green-600 text-white font-bold py-4 rounded-2xl shadow-lg game-font text-lg">
            ë‹¤ìŒìœ¼ë¡œ
        </button>
    </div>

    <!-- 6. ëŒ€ì§„í‘œ í™”ë©´ -->
    <div id="screen-bracket" class="screen flex-col h-full bg-gray-800 text-white p-6 z-50">
        <div class="text-center mb-6">
            <h2 class="text-3xl text-yellow-400 game-font mb-1" id="bracket-title">8ê°•ì „ ëŒ€ì§„í‘œ</h2>
            <div class="text-gray-400 text-sm">ì´ê¸°ë©´ ì˜¬ë¼ê°€ê³ , ì§€ë©´ íƒˆë½í•œë‹¤!</div>
        </div>

        <div class="flex-1 flex flex-col items-center justify-center relative">
            <!-- ëŒ€ì§„í‘œ ë¼ì¸ -->
            <div class="absolute w-1 bg-gray-600 h-32 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>
            <div class="absolute h-1 bg-gray-600 w-32 top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></div>

            <!-- ìƒëŒ€ë°© (ìœ„) -->
            <div class="bg-gray-700 p-4 rounded-2xl border-2 border-red-500 w-40 text-center relative mb-12 z-10">
                <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-red-500 text-xs px-2 py-0.5 rounded text-white font-bold">ìƒëŒ€</div>
                <img id="bracket-enemy-img" src="" class="w-20 h-20 mx-auto mb-2">
                <div class="text-lg font-bold" id="bracket-enemy-name">???</div>
            </div>

            <div class="font-bold text-2xl text-yellow-500 my-2 z-10 game-font">VS</div>

            <!-- í”Œë ˆì´ì–´ (ì•„ë˜) -->
            <div class="bg-gray-700 p-4 rounded-2xl border-2 border-blue-500 w-40 text-center relative mt-12 z-10">
                <div class="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-blue-500 text-xs px-2 py-0.5 rounded text-white font-bold">ë‚˜</div>
                <img id="bracket-player-img" src="" class="w-20 h-20 mx-auto mb-2">
                <div class="text-lg font-bold" id="bracket-player-name">ë‚˜</div>
            </div>
        </div>

        <button onclick="Game.initBattleReal()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-2xl shadow-lg text-xl game-font mt-6 animate-pulse">
            ê²½ê¸°ì¥ ì…ì¥!
        </button>
    </div>

    <!-- 7. ì „íˆ¬ í™”ë©´ (ìˆ˜ì •ë¨: FLEX ë ˆì´ì•„ì›ƒìœ¼ë¡œ ë³€ê²½) -->
    <div id="screen-battle" class="screen flex-col h-full bg-white z-50">
        <!-- ê²½ê¸°ì¥: ë‚¨ì€ ê³µê°„ ëª¨ë‘ ì°¨ì§€ (flex-1) -->
        <div class="flex-1 w-full bg-pastel-arena relative overflow-hidden flex flex-col rounded-b-3xl shadow-md z-10 min-h-[300px]">

            <!-- ìƒëŒ€ë°© (ìš°ì¸¡ ìƒë‹¨) -->
            <div class="absolute top-8 right-6 flex flex-col items-end w-32 z-20">
                <div class="bg-white/80 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-gray-600 mb-1 shadow-sm border border-white">
                    Lv.<span id="enemy-level">5</span> <span id="enemy-name">ìƒëŒ€</span>
                </div>
                <div class="w-full h-2 bg-gray-300 rounded-full overflow-hidden border border-gray-200">
                    <div id="enemy-hp-bar" class="h-full bg-red-400 w-full"></div>
                </div>
                <img id="enemy-sprite" src="" class="w-28 h-28 mt-2 drop-shadow-xl transition-all">
            </div>

            <!-- í”Œë ˆì´ì–´ (ì¢Œì¸¡ í•˜ë‹¨) -->
            <div class="absolute bottom-6 left-6 flex flex-col w-32 z-20">
                <img id="battle-player-sprite" src="" class="w-32 h-32 mb-2 drop-shadow-xl scale-x-[-1] transition-all">
                <div class="bg-white/80 backdrop-blur px-3 py-1 rounded-full text-xs font-bold text-gray-600 mb-1 shadow-sm border border-white">
                    Lv.<span id="player-level">5</span> <span id="battle-player-name">ë‚˜</span>
                </div>
                <div class="w-full h-2 bg-gray-300 rounded-full overflow-hidden border border-gray-200">
                    <div id="player-hp-bar" class="h-full bg-green-400 w-full"></div>
                </div>
            </div>

            <!-- íš¨ê³¼ ì´í™íŠ¸ ë ˆì´ì–´ -->
            <div id="battle-fx" class="absolute inset-0 pointer-events-none flex items-center justify-center z-30"></div>
        </div>

        <!-- ì „íˆ¬ ë¡œê·¸: ê³ ì • ë†’ì´ -->
        <div class="h-48 p-4 flex flex-col bg-white flex-none">
            <div class="flex items-center gap-2 mb-2">
                <div class="w-3 h-3 bg-red-500 rounded-full animate-pulse"></div>
                <span class="text-sm font-bold text-gray-400 uppercase">Live Battle Log</span>
            </div>
            <div class="flex-1 bg-gray-50 rounded-2xl p-4 border border-gray-100 flex items-center justify-center text-center shadow-inner overflow-hidden">
                <p id="battle-log" class="text-xl font-bold text-gray-700 game-font leading-relaxed">
                    ì „íˆ¬ ì‹œì‘!
                </p>
            </div>
        </div>

        <!-- ê²°ê³¼ ì˜¤ë²„ë ˆì´ -->
        <div id="battle-result-overlay" class="absolute inset-0 bg-black/60 hidden flex-col items-center justify-center z-50 backdrop-blur-sm">
            <div class="bg-white p-8 rounded-3xl text-center shadow-2xl max-w-xs w-full animate-[bounce_0.5s]">
                <div class="text-6xl mb-4" id="battle-result-icon">ğŸ†</div>
                <h2 class="text-3xl font-bold text-gray-800 mb-6 game-font" id="battle-result-text">ìŠ¹ë¦¬!</h2>
                <button onclick="Game.endBattle()" class="w-full bg-yellow-400 hover:bg-yellow-500 text-yellow-900 font-bold py-3 rounded-xl shadow-md transition">
                    ê²°ê³¼ í™•ì¸
                </button>
            </div>
        </div>
    </div>

    <!-- 8. ì—”ë”© í™”ë©´ -->
    <div id="screen-ending" class="screen flex-col h-full bg-yellow-50 p-6 items-center justify-center z-50 text-center">
        <div class="mb-4 text-6xl bounce">ğŸ“</div>
        <h1 class="text-4xl font-bold text-yellow-700 mb-4 game-font">ì „ì„¤ì˜ ìˆ˜í•™ì™•!</h1>
        <p class="text-gray-600 mb-8 font-bold">ëª¨ë“  í† ë„ˆë¨¼íŠ¸ë¥¼ ì œíŒ¨í–ˆìŠµë‹ˆë‹¤.</p>

        <div class="bg-white p-8 rounded-[40px] shadow-xl w-full mb-8 border-4 border-yellow-200">
            <img id="ending-img" src="" class="w-40 h-40 mx-auto mb-6">
            <div class="flex justify-between text-lg mb-2 border-b border-gray-100 pb-2">
                <span class="text-gray-400 font-bold">ìµœì¢… ë­í¬</span>
                <span class="font-bold text-indigo-600" id="ending-rank">ì±”í”¼ì–¸</span>
            </div>
            <div class="flex justify-between text-lg">
                <span class="text-gray-400 font-bold">ì •ë‹µ ê°œìˆ˜</span>
                <span class="font-bold text-gray-800" id="ending-score">0 ë¬¸ì œ</span>
            </div>
        </div>

        <button onclick="location.reload()" class="bg-indigo-500 text-white px-10 py-4 rounded-full font-bold shadow-lg hover:bg-indigo-600 transition text-lg game-font">
            ì²˜ìŒë¶€í„° ë‹¤ì‹œí•˜ê¸°
        </button>
    </div>

</div>

<!-- === ê²Œì„ ë¡œì§ === -->
<script>
    // --- ë°ì´í„° ---
    const POKEMON_DB = {
        grass: { name: "ì´ìƒí•´ì”¨", stages: [1, 2, 3], stats: { atk: 15, def: 25, spd: 10, skl: 20 } },
        fire: { name: "íŒŒì´ë¦¬", stages: [4, 5, 6], stats: { atk: 30, def: 10, spd: 20, skl: 10 } },
        water: { name: "ê¼¬ë¶€ê¸°", stages: [7, 8, 9], stats: { atk: 15, def: 20, spd: 15, skl: 25 } }
    };

    const SUBJECTS = {
        math: { name: "ë§ì…ˆ (ê³µê²©)", stat: "atk", icon: "âš”ï¸", color: "text-red-500" },
        sci: { name: "ëº„ì…ˆ (ë°©ì–´)", stat: "def", icon: "ğŸ›¡ï¸", color: "text-green-500" },
        lang: { name: "ê·œì¹™ (ê¸°ìˆ )", stat: "skl", icon: "âœ¨", color: "text-purple-500" }
    };
    const SUBJECT_KEYS = ["math", "sci", "lang"];

    const TOURNAMENT_ROUNDS = [
        { week: 2, name: "16ê°•ì „", enemyId: 19, enemyName: "ê¼¬ë ›", hp: 60, atk: 15 },
        { week: 4, name: "8ê°•ì „", enemyId: 52, enemyName: "ë‚˜ì˜¹", hp: 100, atk: 25 },
        { week: 6, name: "ì¤€ê²°ìŠ¹", enemyId: 25, enemyName: "í”¼ì¹´ì¸„", hp: 160, atk: 40 },
        { week: 8, name: "ê²°ìŠ¹ì „", enemyId: 150, enemyName: "ë®¤ì¸ ", hp: 250, atk: 55 }
    ];

    // --- ê²Œì„ ì—”ì§„ ---
    const Game = {
        state: {
            starter: null,
            pokemon: { name: "", stage: 0, stats: { atk:0, def:0, skl:0, hp:100 } }, // í”¼ë¡œë„ ì œê±°
            week: 1,
            schedule: [null, null, null],
            player: { totalCorrect: 0, totalQs: 0 },
            battle: null
        },

        init: function() { this.showScreen('screen-title'); },

        startNewGame: function() {
            this.state.week = 1;
            this.state.pokemon.stage = 0;
            this.state.player.totalCorrect = 0;
            this.showScreen('screen-select');
        },

        chooseStarter: function(type) {
            this.state.starter = type;
            const base = POKEMON_DB[type];
            this.state.pokemon.name = base.name;
            this.state.pokemon.stats = { ...base.stats, hp: 100 };
            this.renderMain();
            this.showScreen('screen-main');
        },

        renderMain: function() {
            const pk = this.state.pokemon;
            const db = POKEMON_DB[this.state.starter];

            let roundInfo = "ì¼ë°˜ í›ˆë ¨ ê¸°ê°„";
            const nextRound = TOURNAMENT_ROUNDS.find(r => r.week === this.state.week + 1 || r.week === this.state.week);
            if (nextRound) roundInfo = `ë‹¤ìŒ ëŒ€íšŒ: ${nextRound.name}`;

            document.getElementById('main-week-display').innerText = `${this.state.week}ì£¼ì°¨`;
            document.getElementById('league-info').innerText = roundInfo;

            document.getElementById('main-poke-name').innerText = pk.name;
            const imgEl = document.getElementById('main-poke-img');
            imgEl.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${db.stages[pk.stage]}.png`;

            // ì§„í™” ë‹¨ê³„ì— ë”°ë¥¸ í¬ê¸° ë³€í™” (Tailwind width class ì¡°ì •)
            if(pk.stage === 0) imgEl.className = "w-40 h-40 object-contain drop-shadow-lg transition-transform duration-500 bounce";
            else if(pk.stage === 1) imgEl.className = "w-48 h-48 object-contain drop-shadow-lg transition-transform duration-500 bounce";
            else imgEl.className = "w-56 h-56 object-contain drop-shadow-lg transition-transform duration-500 bounce";

            document.getElementById('stat-atk').innerText = Math.floor(pk.stats.atk);
            document.getElementById('stat-def').innerText = Math.floor(pk.stats.def);
            document.getElementById('stat-skl').innerText = Math.floor(pk.stats.skl);

            // í”¼ë¡œë„ UI ì œê±°ë¨
            this.state.schedule = [null, null, null];
            [0,1,2].forEach(i => this.renderSlot(i));
        },

        pokeTouch: function() {
            const el = document.getElementById('main-emotion-bubble');
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 2000);
        },

        toggleSchedule: function(idx) {
            const curr = this.state.schedule[idx];
            const nextKey = curr ? SUBJECT_KEYS[(SUBJECT_KEYS.indexOf(curr)+1)%3] : SUBJECT_KEYS[0];
            this.state.schedule[idx] = nextKey;
            this.renderSlot(idx);
        },

        renderSlot: function(idx) {
            const key = this.state.schedule[idx];
            const btn = document.getElementById(`sched-${idx}`);
            if(!key) {
                btn.innerHTML = `<span class="text-3xl text-gray-300">?</span>`;
                btn.className = "flex-1 aspect-square rounded-2xl bg-gray-50 border-2 border-dashed border-gray-300 flex flex-col items-center justify-center hover:bg-gray-100 transition";
            } else {
                const s = SUBJECTS[key];
                btn.innerHTML = `<span class="text-3xl mb-1">${s.icon}</span><span class="text-xs font-bold ${s.color}">${s.name}</span>`;
                btn.className = "flex-1 aspect-square rounded-2xl bg-white border-2 border-indigo-200 flex flex-col items-center justify-center shadow-md ring-2 ring-indigo-50 transition transform active:scale-95";
            }
        },

        startWeek: function() {
            if(this.state.schedule.includes(null)) { alert("ê³„íší‘œë¥¼ ì±„ì›Œì£¼ì„¸ìš”!"); return; }
            this.queue = [...this.state.schedule];
            this.sessionRes = { atk:0, def:0, skl:0 }; // í”¼ë¡œë„ ì œê±°
            this.nextSession();
        },

        nextSession: function() {
            if(this.queue.length === 0) { this.finishWeek(); return; }
            this.startQuiz(this.queue.shift());
        },

        startQuiz: function(type) {
            this.currSubject = type;
            this.qCount = 0;
            this.showScreen('screen-quiz');
            const s = SUBJECTS[type];
            document.getElementById('quiz-subject-badge').innerText = `${s.name} í›ˆë ¨`;
            this.nextQ();
        },

        nextQ: function() {
            if(this.qCount >= 3) { this.nextSession(); return; }
            this.qCount++;
            document.getElementById('quiz-progress').innerText = `${this.qCount}/3`;

            const qData = this.genQ(this.currSubject);
            document.getElementById('quiz-question').innerText = qData.q;

            const div = document.getElementById('quiz-choices');
            div.innerHTML = '';
            qData.a.forEach((ans, i) => {
                const btn = document.createElement('button');
                btn.className = "bg-white/10 hover:bg-white/20 border-2 border-white/30 text-white font-bold py-4 rounded-xl text-3xl transition active:scale-95";
                btn.innerText = ans;
                btn.onclick = () => this.checkAns(i === qData.idx);
                div.appendChild(btn);
            });
        },

        // --- ë¬¸ì œ ìƒì„± ë¡œì§ ---
        genQ: function(type) {
            if(type === 'math') { // ë§ì…ˆ
                const s = Math.floor(Math.random()*19)+2;
                const a = Math.floor(Math.random()*(s-1))+1;
                let arr = [s, s+1, s-1, s+2].sort(()=>0.5-Math.random());
                return { q: `${a} + ${s-a} = ?`, a: arr, idx: arr.indexOf(s) };
            }
            else if(type === 'sci') { // ëº„ì…ˆ
                const a = Math.floor(Math.random()*19)+1;
                const b = Math.floor(Math.random()*a);
                const r = a-b;
                let arr = [r, r+1, r+2, Math.abs(r-1)].sort(()=>0.5-Math.random());
                arr = [...new Set(arr)];
                while(arr.length<4) arr.push(Math.floor(Math.random()*20));
                return { q: `${a} - ${b} = ?`, a: arr, idx: arr.indexOf(r) };
            }
            else { // ê·œì¹™
                const icons = ['ğŸ','ğŸŒ','ğŸ‡','â­','â¤ï¸','ğŸ„'];
                const pType = Math.floor(Math.random() * 3);
                let seq = [];

                const A = icons[Math.floor(Math.random()*icons.length)];
                let B = icons[Math.floor(Math.random()*icons.length)];
                while(A===B) B = icons[Math.floor(Math.random()*icons.length)];
                let C = icons[Math.floor(Math.random()*icons.length)];
                while(C===A || C===B) C = icons[Math.floor(Math.random()*icons.length)];

                if(pType === 0) seq = [A, B, A, B];
                else if(pType === 1) seq = [A, A, B, A, A, B];
                else seq = [A, B, C, A, B, C];

                const hideIdx = Math.floor(Math.random() * seq.length);
                const answer = seq[hideIdx];
                const qStr = seq.map((item, idx) => idx === hideIdx ? "[ ? ]" : item).join(" ");

                let choices = [answer];
                while(choices.length < 4) {
                    const wrong = icons[Math.floor(Math.random()*icons.length)];
                    if(!choices.includes(wrong)) choices.push(wrong);
                }
                choices.sort(() => 0.5 - Math.random());

                return { q: qStr, a: choices, idx: choices.indexOf(answer) };
            }
        },

        checkAns: function(ok) {
            if(ok) {
                this.state.player.totalCorrect++;
                this.sessionRes[SUBJECTS[this.currSubject].stat] += 3;
            }
            // í”¼ë¡œë„ ì¦ê°€ ë¡œì§ ì œê±°
            this.nextQ();
        },

        finishWeek: function() {
            const pk = this.state.pokemon;
            const r = this.sessionRes;
            pk.stats.atk += r.atk; pk.stats.def += r.def; pk.stats.skl += r.skl;
            // í”¼ë¡œë„ ë°˜ì˜ ì œê±°

            let msg = "í›ˆë ¨ì„ ë¬´ì‚¬íˆ ë§ˆì³¤ë‹¤!";
            if((this.state.week===3 && pk.stage===0) || (this.state.week===6 && pk.stage===1)) {
                pk.stage++;
                pk.stats.atk+=15; pk.stats.def+=15; pk.stats.hp+=50;
                msg = "ì˜¤ì‰?! í¬ì¼“ëª¬ì´ ì§„í™”í–ˆë‹¤!";
            }

            this.showScreen('screen-result');
            const db = POKEMON_DB[this.state.starter];
            document.getElementById('result-poke-img').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${db.stages[pk.stage]}.png`;
            document.getElementById('result-message').innerText = msg;
            document.getElementById('result-stats-list').innerHTML = `
                    <div class="flex justify-between border-b pb-2"><span class="text-red-500 font-bold">ê³µê²© +${r.atk}</span> <span class="text-green-500 font-bold">ë°©ì–´ +${r.def}</span> <span class="text-purple-500 font-bold">ê¸°ìˆ  +${r.skl}</span></div>
                `;
        },

        finishResult: function() {
            const round = TOURNAMENT_ROUNDS.find(r => r.week === this.state.week);
            if(round) {
                this.showBracket(round);
            } else {
                this.state.week++;
                this.renderMain();
                this.showScreen('screen-main');
            }
        },

        showBracket: function(roundData) {
            this.currentRound = roundData;
            this.showScreen('screen-bracket');
            document.getElementById('bracket-title').innerText = roundData.name;

            const eImg = document.getElementById('bracket-enemy-img');
            eImg.src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${roundData.enemyId}.png`;
            eImg.classList.remove('defeated-gray');
            document.getElementById('bracket-enemy-name').innerText = roundData.enemyName;

            const db = POKEMON_DB[this.state.starter];
            document.getElementById('bracket-player-img').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${db.stages[this.state.pokemon.stage]}.png`;
            document.getElementById('bracket-player-name').innerText = this.state.pokemon.name;
        },

        initBattleReal: function() {
            this.showScreen('screen-battle');
            document.getElementById('battle-result-overlay').classList.add('hidden');
            document.getElementById('battle-result-overlay').classList.remove('flex');

            const r = this.currentRound;
            const pStats = this.state.pokemon.stats;

            this.state.battle = {
                player: { hp: pStats.hp, maxHp: pStats.hp, atk: pStats.atk },
                enemy: { hp: r.hp, maxHp: r.hp, atk: r.atk },
                active: true
            };

            const db = POKEMON_DB[this.state.starter];
            document.getElementById('battle-player-sprite').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/back/${db.stages[this.state.pokemon.stage]}.png`;
            document.getElementById('battle-player-name').innerText = this.state.pokemon.name;
            document.getElementById('player-level').innerText = this.state.week * 2;

            document.getElementById('enemy-sprite').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${r.enemyId}.png`;
            document.getElementById('enemy-name').innerText = r.enemyName;
            document.getElementById('enemy-level').innerText = this.state.week * 2 + 1;

            this.updateBattleUI();
            this.battleLog("ì „íˆ¬ ì‹œì‘! ê¸´ì¥ê°ì´ íë¦…ë‹ˆë‹¤...");

            setTimeout(() => this.runAutoBattle(), 1500);
        },

        runAutoBattle: async function() {
            const b = this.state.battle;
            if(!b.active) return;

            // 1. í”Œë ˆì´ì–´ ê³µê²©
            this.battleLog(`${this.state.pokemon.name}ì˜ ëª¸í†µë°•ì¹˜ê¸°!`);
            await this.animAttack('player');

            let dmg = Math.floor(b.player.atk * (0.9 + Math.random()*0.2));
            b.enemy.hp -= dmg;
            this.updateBattleUI();
            await this.animHit('enemy');

            if(b.enemy.hp <= 0) { this.battleWin(true); return; }

            await this.wait(1000);

            // 2. ì  ë°˜ê²©
            this.battleLog(`${this.currentRound.enemyName}ì˜ ë°˜ê²©!`);
            await this.animAttack('enemy');

            let eDmg = Math.floor(b.enemy.atk * (0.9 + Math.random()*0.2));
            eDmg = Math.max(1, eDmg - Math.floor(this.state.pokemon.stats.def * 0.4));
            b.player.hp -= eDmg;
            this.updateBattleUI();
            await this.animHit('player');

            if(b.player.hp <= 0) { this.battleWin(false); return; }

            setTimeout(() => this.runAutoBattle(), 1000);
        },

        animAttack: function(who) {
            return new Promise(resolve => {
                const id = who === 'player' ? 'battle-player-sprite' : 'enemy-sprite';
                const cls = who === 'player' ? 'anim-attack-right' : 'anim-attack-left';
                const el = document.getElementById(id);
                el.classList.add(cls);
                setTimeout(() => { el.classList.remove(cls); resolve(); }, 300);
            });
        },
        animHit: function(who) {
            return new Promise(resolve => {
                const id = who === 'player' ? 'battle-player-sprite' : 'enemy-sprite';
                const el = document.getElementById(id);
                el.classList.add('anim-hit');

                const fx = document.getElementById('battle-fx');
                fx.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';

                setTimeout(() => {
                    el.classList.remove('anim-hit');
                    fx.style.backgroundColor = 'transparent';
                    resolve();
                }, 400);
            });
        },

        updateBattleUI: function() {
            const b = this.state.battle;
            const pPct = Math.max(0, (b.player.hp / b.player.maxHp)*100);
            const ePct = Math.max(0, (b.enemy.hp / b.enemy.maxHp)*100);
            document.getElementById('player-hp-bar').style.width = `${pPct}%`;
            document.getElementById('player-hp-bar').className = `h-full ${pPct < 30 ? 'bg-red-500' : 'bg-green-400'}`;
            document.getElementById('enemy-hp-bar').style.width = `${ePct}%`;
        },

        battleLog: function(msg) {
            document.getElementById('battle-log').innerText = msg;
        },

        battleWin: function(win) {
            this.state.battle.active = false;
            this.lastWin = win;
            const ol = document.getElementById('battle-result-overlay');
            ol.classList.remove('hidden');
            ol.classList.add('flex');

            document.getElementById('battle-result-icon').innerText = win ? "ğŸ†" : "ğŸ˜­";
            document.getElementById('battle-result-text').innerText = win ? "ìŠ¹ë¦¬í–ˆë‹¤!" : "íŒ¨ë°°í–ˆë‹¤...";
        },

        endBattle: function() {
            if(this.lastWin) {
                this.showScreen('screen-bracket');
                document.getElementById('bracket-enemy-img').classList.add('defeated-gray');

                setTimeout(() => {
                    if(this.state.week === 8) {
                        this.showEnding();
                    } else {
                        this.state.week++;
                        this.renderMain();
                        this.showScreen('screen-main');
                    }
                }, 2000);
            } else {
                alert("íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤... ë‹¤ì‹œ ë„ì „í•´ë³´ì„¸ìš”!");
                this.initBattleReal();
            }
        },

        showEnding: function() {
            this.showScreen('screen-ending');
            const db = POKEMON_DB[this.state.starter];
            document.getElementById('ending-img').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${db.stages[this.state.pokemon.stage]}.png`;
            document.getElementById('ending-score').innerText = `${this.state.player.totalCorrect} ë¬¸ì œ`;
        },

        wait: function(ms) { return new Promise(r => setTimeout(r, ms)); },
        showScreen: function(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
    };

    Game.init();
</script>
</body>
</html>