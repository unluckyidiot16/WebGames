<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>QuizMon: Ver 7.0 Grand Update</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; touch-action: manipulation; }
        .view { display: none; }
        .view.active { display: flex; }
        .poke-card { transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .poke-card:active { transform: scale(0.95); }

        /* ë“±ê¸‰ë³„ ìŠ¤íƒ€ì¼ ì¬ì •ì˜ */
        .rarity-UR  { border: 2px solid #ef4444; background: linear-gradient(135deg, #fff0f0 0%, #ffe4e4 100%); box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
        .rarity-SSR { border: 2px solid #f97316; background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); }
        .rarity-SR  { border: 2px solid #eab308; background: #fefce8; }
        .rarity-R   { border: 2px solid #3b82f6; background: #eff6ff; }
        .rarity-C   { border: 1px solid #cbd5e1; background: #ffffff; }

        .modal-backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        img.pixel-art { image-rendering: pixelated; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes damageShake { 0% { transform: translateX(0); } 20% { transform: translateX(-6px) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } 40% { transform: translateX(6px) rotate(5deg); } 60% { transform: translateX(-3px); } 80% { transform: translateX(3px); } }
        .animate-damage { animation: damageShake 0.4s ease-in-out; }
        .animate-attack-player { animation: attackRight 0.2s ease-out; }
        .animate-attack-enemy { animation: attackLeft 0.2s ease-out; }
        @keyframes attackRight { 0% { transform: translateX(0) scaleX(-1); } 50% { transform: translateX(30px) scaleX(-1); } 100% { transform: translateX(0) scaleX(-1); } }
        @keyframes attackLeft { 0% { transform: translateX(0); } 50% { transform: translateX(-30px); } 100% { transform: translateX(0); } }

        .btn-cooldown { background-color: #f1f5f9 !important; border-color: #cbd5e1 !important; color: #94a3b8 !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .skill-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 select-none">

<section id="titleScreen" class="view active flex-col items-center justify-center p-6 h-screen">
    <div class="mb-8 relative">
        <div class="absolute -top-10 -left-10 w-20 h-20 bg-purple-500 rounded-full blur-xl opacity-30 animate-pulse"></div>
        <h1 class="text-5xl md:text-6xl font-black text-slate-800 tracking-tighter relative z-10">
            <span class="text-red-500">Quiz</span>Mon
        </h1>
        <div class="text-right text-xs font-bold text-slate-400 mt-1">Ver 7.0 Grand Update</div>
    </div>
    <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-sm text-center border-4 border-slate-800">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/250.png" class="w-24 h-24 mx-auto pixel-art animate-bounce" alt="Ho-oh">
        <p class="text-slate-500 text-sm mb-6 font-medium">
            10ì—°ì°¨ ê¸°ëŠ¥ ì¶”ê°€!<br>ìŠ¤í…Œì´ì§€ì— ë”°ë¼ ê°•í•´ì§€ëŠ” ì ë“¤!
        </p>
        <button id="startButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg text-lg transition-colors border-b-4 border-red-700 active:border-b-0 active:translate-y-1">
            ëª¨í—˜ ì‹œì‘í•˜ê¸°
        </button>
    </div>
</section>

<section id="lobbyScreen" class="view flex-col items-center justify-start p-4 min-h-screen overflow-y-auto">
    <div class="w-full max-w-md flex flex-col gap-4 mt-2">
        <div class="flex justify-between items-end px-2">
            <h2 class="text-3xl font-black text-slate-800">LOBBY</h2>
            <div class="flex gap-2">
                <div class="bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200 text-xs font-bold flex items-center gap-1">
                    <span class="text-yellow-500">ğŸ«</span><span id="ticketTextLobby">0</span>
                </div>
                <div class="bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200 text-xs font-bold flex items-center gap-1">
                    <span class="text-blue-500">P</span><span id="pointsTextLobby">0</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button id="lobbyCodexBtn" class="bg-white p-4 rounded-2xl shadow-sm border-2 border-slate-100 flex flex-col items-center gap-2 hover:border-emerald-400 transition-colors group">
                <div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center group-hover:bg-emerald-100"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="w-8 h-8 pixel-art opacity-80"></div>
                <div class="text-center"><div class="font-bold text-slate-700">ìŠ¤íƒ€í„° ì„ íƒ</div><div class="text-[10px] text-slate-400">ëª¨í—˜ ì¤€ë¹„</div></div>
            </button>
            <button id="lobbyGachaBtn" class="bg-white p-4 rounded-2xl shadow-sm border-2 border-slate-100 flex flex-col items-center gap-2 hover:border-indigo-400 transition-colors group">
                <div class="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center group-hover:bg-indigo-100"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" class="w-8 h-8 pixel-art opacity-80"></div>
                <div class="text-center"><div class="font-bold text-slate-700">ëª¬ìŠ¤í„° ì†Œí™˜</div><div class="text-[10px] text-slate-400">ë™ë£Œ ì˜ì…</div></div>
            </button>
            <button id="lobbyHofBtn" class="col-span-2 bg-white p-3 rounded-2xl shadow-sm border-2 border-slate-100 flex items-center justify-center gap-3 hover:border-yellow-400 transition-colors group">
                <div class="w-10 h-10 bg-yellow-50 rounded-full flex items-center justify-center group-hover:bg-yellow-100"><span class="text-xl">ğŸ†</span></div>
                <div class="text-left"><div class="font-bold text-slate-700">ëª…ì˜ˆì˜ ì „ë‹¹</div><div class="text-[10px] text-slate-400">ì—­ëŒ€ ìµœê³  ê¸°ë¡ ë³´ê¸°</div></div>
            </button>
        </div>

        <div class="bg-slate-800 rounded-2xl p-5 text-white shadow-lg relative overflow-hidden mt-2">
            <div class="relative z-10 flex justify-between items-center">
                <div>
                    <div class="text-xs text-slate-400 mb-1">ì„ íƒëœ ìŠ¤íƒ€í„°</div>
                    <div id="lobbyPartnerName" class="font-bold text-xl">ì—†ìŒ</div>
                    <div class="text-[10px] text-slate-400 mt-1 bg-slate-700 inline-block px-2 py-1 rounded" id="lobbyStartBonus">
                        ì„ íƒ í•„ìš”
                    </div>
                </div>
                <img id="lobbyPartnerImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="w-16 h-16 pixel-art bg-slate-700 rounded-full">
            </div>
        </div>
    </div>
</section>

<section id="codexScreen" class="view flex-col items-center h-screen bg-slate-50">
    <div class="w-full max-w-3xl flex flex-col h-full">
        <div class="flex-none p-4 bg-white border-b border-slate-200 flex items-center justify-between shadow-sm z-10">
            <h2 class="text-xl font-bold text-slate-800">ìŠ¤íƒ€í„° <span class="text-xs font-normal text-slate-400" id="collectionRate">0/251</span></h2>
            <button id="codexToLobbyBtn" class="text-xs font-bold px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">ë‚˜ê°€ê¸°</button>
        </div>
        <div class="flex-none p-4 bg-white border-t border-slate-200 order-last flex gap-3 items-center">
            <div class="flex-1"><div class="text-xs text-slate-400">ì„ íƒë¨</div><div id="partnerInfo" class="font-bold text-slate-800 text-sm truncate">ì—†ìŒ</div></div>
            <button id="startAdventureBtn" disabled class="bg-emerald-500 hover:bg-emerald-600 disabled:bg-slate-300 text-white font-bold py-3 px-6 rounded-xl shadow-md w-32">ëª¨í—˜ ì‹œì‘</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
            <div id="codexGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 pb-4"></div>
        </div>
    </div>
</section>

<section id="battleScreen" class="view flex-col items-center justify-between h-screen bg-gradient-to-b from-sky-200 to-sky-100 relative overflow-hidden">
    <div class="absolute bottom-0 w-full h-1/3 bg-emerald-600 rounded-t-[50%] scale-150 translate-y-12 border-t-8 border-emerald-700 opacity-90"></div>
    <div class="w-full max-w-md p-4 flex justify-between items-start z-10">
        <button id="battleBackBtn" class="bg-white/80 backdrop-blur text-slate-700 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm">&larr; í¬ê¸°</button>
        <div class="bg-black/40 backdrop-blur text-white px-4 py-1.5 rounded-full text-xs font-bold">STAGE <span id="battleStageText" class="text-yellow-300 text-base ml-1">1</span></div>
    </div>
    <div class="w-full max-w-md flex-1 relative flex flex-col justify-center px-4 z-10 gap-8">
        <div class="flex flex-col items-end relative">
            <div class="bg-white/90 p-2 rounded-xl shadow-md mb-2 w-40 transform translate-x-2">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="enemyName" class="font-bold text-sm text-slate-800">?</span>
                    <span id="enemyLevel" class="text-[10px] text-slate-500">Lv.1</span>
                </div>
                <div id="enemyTypeBadge" class="text-[9px] text-white px-1.5 py-0.5 rounded mb-1 inline-block bg-gray-400">TYPE</div>
                <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden"><div id="enemyHpBar" class="h-full bg-red-500 transition-all duration-500" style="width: 100%"></div></div>
            </div>
            <img id="enemyImg" src="" class="w-32 h-32 pixel-art animate-bounce-slow drop-shadow-xl filter grayscale-0">
        </div>
        <div class="flex flex-col items-start relative mt-4">
            <img id="playerImg" src="" class="w-40 h-40 pixel-art drop-shadow-2xl scale-x-[-1]">
            <div class="bg-white/90 p-3 rounded-xl shadow-md w-44 -mt-4 z-20 transform -translate-x-2 border-l-4 border-emerald-500">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="playerName" class="font-bold text-sm text-slate-800">?</span>
                    <span id="playerLevel" class="text-[10px] text-slate-500">Lv.1</span>
                </div>
                <div class="flex justify-between text-[10px] text-slate-500 mb-0.5"><span>HP</span><span id="playerHpText">0/0</span></div>
                <div class="w-full h-2.5 bg-slate-200 rounded-full overflow-hidden"><div id="playerHpBar" class="h-full bg-emerald-500 transition-all duration-500" style="width: 100%"></div></div>
                <div class="w-full h-1 bg-slate-100 rounded-full mt-1 overflow-hidden"><div id="playerExpBar" class="h-full bg-sky-400 transition-all" style="width: 0%"></div></div>
            </div>
        </div>
    </div>
    <div class="w-full max-w-md bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-5 z-20">
        <div id="battleLog" class="text-xs text-slate-500 mb-3 h-6 overflow-y-hidden text-center italic">ì „íˆ¬ ì‹œì‘!</div>
        <div id="moveButtons" class="skill-grid"></div>
    </div>
</section>

<div id="hofModal" class="fixed inset-0 bg-slate-900 z-50 hidden flex-col items-center justify-center"><div class="w-full max-w-md bg-white p-6 rounded-2xl shadow-2xl m-4 max-h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-black text-slate-800">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3><button id="hofClose" class="text-slate-400 font-bold">ë‹«ê¸°</button></div><div id="hofList" class="flex-1 overflow-y-auto space-y-3"></div></div></div>

<div id="gachaModal" class="fixed inset-0 bg-slate-900 z-50 hidden flex-col items-center justify-center">
    <div class="w-full max-w-lg p-6 flex flex-col h-full md:h-auto">
        <div class="flex justify-between items-center mb-6 text-white">
            <div><h3 class="text-2xl font-bold">ëª¬ìŠ¤í„° ì†Œí™˜</h3><p class="text-xs opacity-70" id="gachaResDisplay"></p></div>
            <button id="gachaClose" class="bg-white/20 rounded-full p-2">âœ•</button>
        </div>
        <div id="gachaScene" class="flex-1 bg-slate-800 rounded-2xl border border-slate-700 p-4 overflow-y-auto mb-4 min-h-[300px] flex items-center justify-center relative">
            <div id="gachaPlaceholder" class="text-center text-slate-500">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" class="w-24 h-24 mx-auto mb-4 opacity-20 grayscale">
                <p>ì†Œí™˜ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”</p>
            </div>
            <div id="gachaResultsGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-3 w-full hidden"></div>
        </div>
        <div class="grid grid-cols-3 gap-2 mb-2">
            <button id="gacha1Btn" class="bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 text-xs">
                <span class="block opacity-80">100 P</span>1íšŒ ì†Œí™˜
            </button>
            <button id="gacha10Btn" class="bg-purple-600 hover:bg-purple-500 text-white py-3 rounded-xl shadow-lg border-b-4 border-purple-800 active:border-b-0 active:translate-y-1 text-xs">
                <span class="block opacity-80">900 P</span>10íšŒ ì†Œí™˜
            </button>
            <button id="gachaSpecialBtn" class="bg-yellow-500 hover:bg-yellow-400 text-white py-3 rounded-xl shadow-lg border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1 text-xs relative overflow-hidden">
                <div class="absolute inset-0 bg-white opacity-10 animate-pulse"></div>
                <span class="block opacity-80 font-bold text-yellow-900">ğŸ« í‹°ì¼“ 1</span>ì „ì„¤ ì†Œí™˜
            </button>
        </div>
        <p class="text-center text-[10px] text-slate-400">* ì¤‘ë³µ íšë“ ì‹œ ì‹œì‘ ê²½í—˜ì¹˜(ì ì¬ë ¥)ê°€ ìƒìŠ¹í•©ë‹ˆë‹¤.</p>
    </div>
</div>

<div id="quizModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden"><div class="bg-slate-800 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg">ğŸ“ ìˆ˜í•™ í€´ì¦ˆ</h3><span class="text-xs bg-slate-700 px-2 py-1 rounded text-yellow-300">ì •ë‹µ ì‹œ ê³µê²©</span></div><div class="p-6"><div class="text-center mb-6"><p class="text-3xl font-black text-slate-800 tracking-wider" id="quizQuestion">?</p></div><div id="quizChoices" class="grid grid-cols-2 gap-3"></div></div><div class="bg-slate-50 p-3 text-center border-t"><button id="quizCancel" class="text-xs text-slate-400 underline">í¬ê¸°í•˜ê¸°</button></div></div></div>
<div id="rewardModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center"><h3 class="text-2xl font-black text-slate-800 mb-2">VICTORY!</h3><div class="text-xs text-sky-600 font-bold mb-4 bg-sky-50 inline-block px-3 py-1 rounded-full">EXP <span id="rewardXpVal">0</span> íšë“!</div><p class="text-sm text-slate-500 mb-2" id="rewardTitle">ë³´ìƒì„ ì„ íƒí•˜ì„¸ìš”</p><div class="grid grid-cols-1 gap-3" id="rewardButtons"></div></div></div>
<div id="messageModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[60] p-6"><div class="bg-white rounded-xl shadow-xl w-full max-w-xs p-5 text-center"><h3 id="messageTitle" class="text-lg font-bold text-slate-800 mb-2">ì•Œë¦¼</h3><p id="messageBody" class="text-sm text-slate-600 mb-4 break-keep"></p><button id="messageOk" class="w-full py-2.5 rounded-lg bg-slate-800 text-white text-sm font-bold">í™•ì¸</button></div></div>

<script>
    /* =========================================
     * DATA (251 Pokemon) & STATS MAP
     * ========================================= */
    const POKE_NAMES_STR = "ì´ìƒí•´ì”¨,ì´ìƒí•´í’€,ì´ìƒí•´ê½ƒ,íŒŒì´ë¦¬,ë¦¬ìë“œ,ë¦¬ìëª½,ê¼¬ë¶€ê¸°,ì–´ë‹ˆë¶€ê¸°,ê±°ë¶ì™•,ìºí„°í”¼,ë‹¨ë°ê¸°,ë²„í„°í”Œ,ë¿”ì¶©ì´,ë”±ì¶©ì´,ë…ì¹¨ë¶•,êµ¬êµ¬,í”¼ì£¤,í”¼ì£¤íˆ¬,ê¼¬ë ›,ë ˆíŠ¸ë¼,ê¹¨ë¹„ì°¸,ê¹¨ë¹„ë“œë¦´ì¡°,ì•„ë³´,ì•„ë³´í¬,í”¼ì¹´ì¸„,ë¼ì´ì¸„,ëª¨ë˜ë‘ì§€,ê³ ì§€,ë‹ˆë“œëŸ°â™€,ë‹ˆë“œë¦¬ë‚˜,ë‹ˆë“œí€¸,ë‹ˆë“œëŸ°â™‚,ë‹ˆë“œë¦¬ë…¸,ë‹ˆë“œí‚¹,ì‚ì‚,í”½ì‹œ,ì‹ìŠ¤í…Œì¼,ë‚˜ì¸í…Œì¼,í‘¸ë¦°,í‘¸í¬ë¦°,ì£¼ë±ƒ,ê³¨ë±ƒ,ëšœë²…ìµ¸,ëƒ„ìƒˆê¼¬,ë¼í”Œë ˆì‹œì•„,íŒŒë¼ìŠ¤,íŒŒë¼ì„¹íŠ¸,ì½˜íŒ¡,ë„ë‚˜ë¦¬,ë””ê·¸ë‹¤,ë‹¥íŠ¸ë¦¬ì˜¤,ë‚˜ì˜¹,í˜ë¥´ì‹œì˜¨,ê³ ë¼íŒŒë•,ê³¨ë•,ë§í‚¤,ì„±ì›ìˆ­,ê°€ë””,ìœˆë””,ë°œì±™ì´,ìŠˆë¥™ì±™ì´,ê°•ì±™ì´,ìºì´ì‹œ,ìœ¤ê²”ë¼,í›„ë”˜,ì•Œí†µëª¬,ê·¼ìœ¡ëª¬,ê´´ë ¥ëª¬,ëª¨ë‹¤í”¼,ìš°ì¸ ë™,ìš°ì¸ ë³´íŠ¸,ì™•ëˆˆí•´,ë…íŒŒë¦¬,ê¼¬ë§ˆëŒ,ë°êµ¬ë¦¬,ë”±êµ¬ë¦¬,í¬ë‹ˆíƒ€,ë‚ ìŒ©ë§ˆ,ì•¼ëˆ,ì•¼ë„ë€,ì½”ì¼,ë ˆì–´ì½”ì¼,íŒŒì˜¤ë¦¬,ë‘ë‘,ë‘íŠ¸ë¦¬ì˜¤,ì¥¬ì¥¬,ì¥¬ë ˆê³¤,ì§ˆí½ì´,ì§ˆë»ê¸°,ì…€ëŸ¬,íŒŒë¥´ì…€,ê³ ì˜¤ìŠ¤,ê³ ìš°ìŠ¤íŠ¸,íŒ¬í…€,ë¡±ìŠ¤í†¤,ìŠ¬ë¦¬í”„,ìŠ¬ë¦¬í¼,í¬ë©,í‚¹í¬ë©,ì°Œë¦¬ë¦¬ê³µ,ë¶ë³¼,ì•„ë¼ë¦¬,ë‚˜ì‹œ,íƒ•êµ¬ë¦¬,í……êµ¬ë¦¬,ì‹œë¼ì†Œëª¬,í™ìˆ˜ëª¬,ë‚´ë£¨ë¯¸,ë˜ê°€ìŠ¤,ë˜ë„ê°€ìŠ¤,ë¿”ì¹´ë…¸,ì½”ë¿Œë¦¬,ëŸ­í‚¤,ë©ì¿ ë¦¬,ìº¥ì¹´,ì˜ë“œë¼,ì‹œë“œë¼,ì½˜ì¹˜,ì™•ì½˜ì¹˜,ë³„ê°€ì‚¬ë¦¬,ì•„ì¿ ìŠ¤íƒ€,ë§ˆì„ë§¨,ìŠ¤í„±,ë£¨ì£¼ë¼,ì—ë ˆë¸Œ,ë§ˆê·¸ë§ˆ,ì˜ì‚¬ì´ì €,ì¼„íƒ€ë¡œìŠ¤,ì‰ì–´í‚¹,ê°¸ë¼ë„ìŠ¤,ë¼í”„ë¼ìŠ¤,ë©”íƒ€ëª½,ì´ë¸Œì´,ìƒ¤ë¯¸ë“œ,ì¥¬í”¼ì¬ë”,ë¶€ìŠ¤í„°,í´ë¦¬ê³¤,ì•”ë‚˜ì´íŠ¸,ì•”ìŠ¤íƒ€,íˆ¬êµ¬,íˆ¬êµ¬í‘¸ìŠ¤,í”„í…Œë¼,ì ë§Œë³´,í”„ë¦¬ì ¸,ì¬ë”,íŒŒì´ì–´,ë¯¸ë‡½,ì‹ ë‡½,ë§ë‚˜ë‡½,ë®¤ì¸ ,ë®¤,ì¹˜ì½”ë¦¬íƒ€,ë² ì´ë¦¬í”„,ë©”ê°€ë‹ˆì›€,ë¸Œì¼€ì¸,ë§ˆê·¸ì¼€ì¸,ë¸”ë ˆì´ë²”,ë¦¬ì•„ì½”,ì—˜ë¦¬ê²Œì´,ì¥í¬ë¡œë‹¤ì¼,ê¼¬ë¦¬ì„ ,ë‹¤ê¼¬ë¦¬,ë¶€ìš°ë¶€,ì•¼ë¶€ì—‰,ë ˆë””ë°”,ë ˆë””ì•ˆ,í˜ì´ê²€,ì•„ë¦¬ì•„ë„ìŠ¤,í¬ë¡œë±ƒ,ì´ˆë¼ê¸°,ëœí„´,í”¼ì¸„,ì‚,í‘¸í‘¸ë¦°,í† ê²Œí”¼,í† ê²Œí‹±,ë„¤ì´í‹°,ë„¤ì´í‹°ì˜¤,ë©”ë¦¬í”„,ë³´ì†¡ì†¡,ì „ë£¡,ì•„ë¥´ì½”,ë§ˆë¦´,ë§ˆë¦´ë¦¬,ê¼¬ì§€ëª¨,ì™•êµ¬ë¦¬,í†µí†µì½”,ë‘ì½”,ì†œì†œì½”,ì—ì´íŒœ,í•´ë„ˆì¸ ,í•´ë£¨ë¯¸,ì™•ìë¦¬,ìš°íŒŒ,ëˆ„ì˜¤,ì—ë¸Œì´,ë¸”ë˜í‚¤,ë‹ˆë¡œìš°,ì•¼ë„í‚¹,ë¬´ìš°ë§ˆ,ì•ˆë†,ë§ˆììš©,í‚¤ë§í‚¤,í”¼ì½˜,ì˜ì½˜,ë…¸ê³ ì¹˜,ê¸€ë¼ì´ê±°,ê°•ì² í†¤,ë¸”ë£¨,ê·¸ë‘ë¸”ë£¨,ì¹¨ë°”ë£¨,í•«ì‚¼,ë‹¨ë‹¨ì§€,í—¤ë¼í¬ë¡œìŠ¤,í¬ë‰´ë¼,ê¹œì§€ê³°,ë§ê³°,ë§ˆê·¸ë§ˆê·¸,ë§ˆê·¸ì¹´ë¥´ê³ ,ê¾¸ê¾¸ë¦¬,ë©”ê¾¸ë¦¬,ì½”ì‚°í˜¸,ì´ì–´,ëŒ€í¬ë¬´ë…¸,ë”œë¦¬ë²„ë“œ,ë§Œíƒ€ì¸,ë¬´ì¥ì¡°,ë¸ë¹Œ,í—¬ê°€,í‚¹ë“œë¼,ì½”íŒ,ì½”ë¦¬ê°‘,í´ë¦¬ê³¤2,ë…¸ë¼í‚¤,ë£¨ë¸Œë„,ë°°ë£¨í‚¤,ì¹´í¬ì—ë¼,ë½€ë½€ë¼,ì—ë ˆí‚¤ë“œ,ë§ˆê·¸ë¹„,ë°€íƒ±í¬,í•´í”¼ë„ˆìŠ¤,ë¼ì´ì½”,ì•¤í…Œì´,ìŠ¤ì´ì¿¤,ì• ë²„ë¼ìŠ¤,ë°ê¸°ë¼ìŠ¤,ë§ˆê¸°ë¼ìŠ¤,ë£¨ê¸°ì•„,ì¹ ìƒ‰ì¡°,ì„¸ë ˆë¹„";
    const POKE_NAMES = POKE_NAMES_STR.split(",");
    const LEGENDARY_IDS = [144,145,146,150,243,244,245,249,250];
    const MYTHICAL_IDS = [151, 251];

    const TYPE_DATA = {
        "í’€": { color: "bg-green-500", weak: ["ë¶ˆê½ƒ", "ë…", "ì–¼ìŒ", "ë¹„í–‰", "ë²Œë ˆ"], resist: ["ë¬¼", "ì „ê¸°", "í’€", "ë•…"] },
        "ë¶ˆê½ƒ": { color: "bg-red-500", weak: ["ë¬¼", "ë•…", "ë°”ìœ„"], resist: ["ë¶ˆê½ƒ", "í’€", "ì–¼ìŒ", "ë²Œë ˆ", "ê°•ì² ", "í˜ì–´ë¦¬"] },
        "ë¬¼": { color: "bg-blue-500", weak: ["ì „ê¸°", "í’€"], resist: ["ë¶ˆê½ƒ", "ë¬¼", "ì–¼ìŒ", "ê°•ì² "] },
        "ì „ê¸°": { color: "bg-yellow-400", weak: ["ë•…"], resist: ["ì „ê¸°", "ë¹„í–‰", "ê°•ì² "] },
        "ë…¸ë§": { color: "bg-stone-400", weak: ["ê²©íˆ¬"], resist: [] },
        "ì—ìŠ¤í¼": { color: "bg-pink-400", weak: ["ë²Œë ˆ", "ê³ ìŠ¤íŠ¸", "ì•…"], resist: ["ê²©íˆ¬", "ì—ìŠ¤í¼"] },
        "ê²©íˆ¬": { color: "bg-orange-600", weak: ["ë¹„í–‰", "ì—ìŠ¤í¼", "í˜ì–´ë¦¬"], resist: ["ë²Œë ˆ", "ë°”ìœ„", "ì•…"] },
        "ë…": { color: "bg-purple-500", weak: ["ë•…", "ì—ìŠ¤í¼"], resist: ["í’€", "ê²©íˆ¬", "ë…", "ë²Œë ˆ", "í˜ì–´ë¦¬"] },
    };
    const TYPE_KEYS = Object.keys(TYPE_DATA);

    const RAW_MOVES = {
        "í’€": [ {n:"ë©êµ´ì±„ì°",p:45,a:100}, {n:"ìë‚ ê°€ë¥´ê¸°",p:55,a:95}, {n:"ë©”ê°€ë“œë ˆì¸",p:40,a:100}, {n:"ì”¨í­íƒ„",p:80,a:100}, {n:"ì—ë„ˆì§€ë³¼",p:90,a:100}, {n:"ê¸°ê°€ë“œë ˆì¸",p:75,a:100}, {n:"ë§¤ì§€ì»¬ë¦¬í”„",p:60,a:100}, {n:"ê½ƒë³´ë¼",p:90,a:100}, {n:"ì†”ë¼ë¹”",p:120,a:100}, {n:"ë¦¬í”„ìŠ¤í†°",p:130,a:90}, {n:"í•˜ë“œí”ŒëœíŠ¸",p:150,a:90}, {n:"ìš°ë“œí•´ë¨¸",p:120,a:100}, {n:"íŒŒì›Œíœ©",p:120,a:85}, {n:"ë¦¬í”„ë¸”ë ˆì´ë“œ",p:90,a:100}, {n:"ì†”ë¼ë¸”ë ˆì´ë“œ",p:125,a:100}, {n:"í’€ë¬¶ê¸°",p:60,a:100} ],
        "ë¶ˆê½ƒ": [ {n:"ë¶ˆê½ƒì„¸ë¡€",p:40,a:100}, {n:"ë¶ˆê½ƒí€ì¹˜",p:75,a:100}, {n:"ë‹ˆíŠ¸ë¡œì°¨ì§€",p:50,a:100}, {n:"í™”ì—¼ë°”í€´",p:60,a:100}, {n:"í™”ì—¼ë°©ì‚¬",p:90,a:100}, {n:"ì—´í’",p:95,a:90}, {n:"ë¶ˆê½ƒì˜¤ë¦„",p:80,a:100}, {n:"ë¶ˆê½ƒì±„ì°",p:80,a:100}, {n:"ë¶ˆëŒ€ë¬¸ì",p:110,a:85}, {n:"ì˜¤ë²„íˆíŠ¸",p:130,a:90}, {n:"ë¸”ë¼ìŠ¤íŠ¸ë²ˆ",p:150,a:90}, {n:"í”Œë ˆì–´ë“œë¼ì´ë¸Œ",p:120,a:100}, {n:"ë¶„í™”",p:150,a:100}, {n:"ë§ˆê·¸ë§ˆìŠ¤í†°",p:100,a:75}, {n:"ì„±ìŠ¤ëŸ¬ìš´ë¶ˆê½ƒ",p:100,a:95}, {n:"Vì œë„ˆë ˆì´íŠ¸",p:180,a:95} ],
        "ë¬¼": [ {n:"ë¬¼ëŒ€í¬",p:40,a:100}, {n:"ê±°í’ˆê´‘ì„ ",p:65,a:100}, {n:"ë¬¼ì˜íŒŒë™",p:60,a:100}, {n:"ì•„ì¿ ì•„ì œíŠ¸",p:40,a:100}, {n:"íŒŒë„íƒ€ê¸°",p:90,a:100}, {n:"ì•„ì¿ ì•„í…Œì¼",p:90,a:90}, {n:"ì—´íƒ•",p:80,a:100}, {n:"íƒë¥˜",p:90,a:85}, {n:"í•˜ì´ë“œë¡œíŒí”„",p:110,a:80}, {n:"í•˜ì´ë“œë¡œìºë…¼",p:150,a:90}, {n:"í•´ì¼",p:110,a:90}, {n:"ê·¼ì›ì˜íŒŒë™",p:110,a:85}, {n:"ì…¸ë¸”ë ˆì´ë“œ",p:75,a:95}, {n:"í­í¬ì˜¤ë¥´ê¸°",p:80,a:100}, {n:"ë‹¤ì´ë¹™",p:80,a:100}, {n:"ì•„ì¿ ì•„ë¸Œë ˆì´í¬",p:85,a:100} ],
        "ì „ê¸°": [ {n:"ì „ê¸°ì‡¼í¬",p:40,a:100}, {n:"ì „ê´‘ì„í™”",p:40,a:100}, {n:"ìŠ¤íŒŒí¬",p:65,a:100}, {n:"ì „ê²©íŒŒ",p:60,a:100}, {n:"10ë§Œë³¼íŠ¸",p:90,a:100}, {n:"ë²ˆê°œí€ì¹˜",p:75,a:100}, {n:"ë°©ì „",p:80,a:100}, {n:"ì¼ë ‰íŠ¸ë¦­ë³¼",p:80,a:100}, {n:"ë²ˆê°œ",p:110,a:70}, {n:"ì „ìí¬",p:120,a:50}, {n:"ë³¼íŠ¸íƒœí´",p:120,a:100}, {n:"ë¼ì´ì§•ë³¼íŠ¸",p:70,a:100}, {n:"ë‡Œê²©",p:130,a:85}, {n:"í¬ë¡œìŠ¤ì¬ë”",p:100,a:100}, {n:"ì˜¤ë¼ìœ™",p:80,a:100}, {n:"ì™€ì¼ë“œë³¼íŠ¸",p:90,a:100} ],
        "ë…¸ë§": [ {n:"ëª¸í†µë°•ì¹˜ê¸°",p:40,a:100}, {n:"í• í€´ê¸°",p:40,a:100}, {n:"ë§‰ì¹˜ê¸°",p:40,a:100}, {n:"ëŒì§„",p:90,a:85}, {n:"ì€í˜œê°šê¸°",p:102,a:100}, {n:"ëˆ„ë¥´ê¸°",p:85,a:100}, {n:"ë² ì–´ê°€ë¥´ê¸°",p:70,a:100}, {n:"í•˜ì´í¼ë³´ì´ìŠ¤",p:90,a:100}, {n:"íŒŒê´´ê´‘ì„ ",p:150,a:90}, {n:"ê¸°ê°€ì„íŒ©íŠ¸",p:150,a:90}, {n:"ì´íŒì‚¬íŒíƒœí´",p:120,a:100}, {n:"ë¸Œë ˆì´í¬í¬ë£¨",p:75,a:95}, {n:"ì§“ë°Ÿê¸°",p:65,a:100}, {n:"ê°ê¸°",p:70,a:100}, {n:"ìŠ¤í”¼ë“œìŠ¤íƒ€",p:60,a:100}, {n:"íŠ¸ë¼ì´ì–´íƒ",p:80,a:100} ],
        "ì—ìŠ¤í¼": [ {n:"ì—¼ë™ë ¥",p:50,a:100}, {n:"í™˜ìƒë¹”",p:65,a:100}, {n:"í•˜íŠ¸ìŠ¤íƒ¬í”„",p:60,a:100}, {n:"ì‚¬ë…ì˜ë°•ì¹˜ê¸°",p:80,a:90}, {n:"ì‚¬ì´ì½”í‚¤ë„¤ì‹œìŠ¤",p:90,a:100}, {n:"ì‚¬ì´ì½”ì‡¼í¬",p:80,a:100}, {n:"ì‹ í†µë ¥",p:80,a:100}, {n:"ëŸ¬ìŠ¤í„°í¼ì§€",p:70,a:100}, {n:"ë¯¸ë˜ì˜ˆì§€",p:120,a:100}, {n:"ê¿ˆë¨¹ê¸°",p:100,a:100}, {n:"ì‚¬ì´ì½”ë¶€ìŠ¤íŠ¸",p:140,a:90}, {n:"í”„ë¦¬ì¦˜ë ˆì´ì €",p:160,a:100}, {n:"ì™€ì´ë“œí¬ìŠ¤",p:80,a:100}, {n:"ì‚¬ì´ì½”ì»¤í„°",p:70,a:100}, {n:"ë¯¸ëŸ¬ì½”íŠ¸",p:60,a:100}, {n:"ì‚¬ì´ì½”ë¸Œë ˆì´í¬",p:100,a:100} ],
        "ê²©íˆ¬": [ {n:"ë°”ìœ„ê¹¨ê¸°",p:40,a:100}, {n:"ë§ˆí•˜í€ì¹˜",p:40,a:100}, {n:"ì•ˆë‹¤ë¦¬ê±¸ê¸°",p:60,a:100}, {n:"ë°œê²½",p:60,a:100}, {n:"ì§€ì˜¥ì˜ë°”í€´",p:80,a:80}, {n:"ê¹¨íŠ¸ë¦¬ê¸°",p:75,a:100}, {n:"íŒŒë™íƒ„",p:80,a:100}, {n:"ë“œë ˆì¸í€ì¹˜",p:75,a:100}, {n:"ì¸íŒŒì´íŠ¸",p:120,a:100}, {n:"ì—„ì²­ë‚œí˜",p:120,a:100}, {n:"ê¸°í•©êµ¬ìŠ¬",p:120,a:70}, {n:"í­ë°œí€ì¹˜",p:100,a:50}, {n:"ì„±ìŠ¤ëŸ¬ìš´ì¹¼",p:90,a:100}, {n:"ë¬´ë¦ì°¨ê¸°",p:130,a:90}, {n:"í¬ë¡œìŠ¤ì´ˆí”„",p:100,a:80}, {n:"ì•”í•´ë¨¸",p:100,a:90} ],
        "ë…": [ {n:"ë…ì¹¨",p:15,a:100}, {n:"ìš©í•´ì•¡",p:40,a:100}, {n:"ìŠ¤ëª¨ê·¸",p:30,a:70}, {n:"í´ë¦¬ì–´ìŠ¤ëª¨ê·¸",p:50,a:100}, {n:"ì˜¤ë¬¼í­íƒ„",p:90,a:100}, {n:"ë…ì°Œë¥´ê¸°",p:80,a:100}, {n:"í¬ë¡œìŠ¤í¬ì´ì¦Œ",p:70,a:100}, {n:"ì˜¤ë¬¼ì›¨ì´ë¸Œ",p:95,a:100}, {n:"ë”ìŠ¤íŠ¸ìŠˆíŠ¸",p:120,a:80}, {n:"ë² ë†ˆì‡¼í¬",p:65,a:100}, {n:"ì˜¤ë¬¼ê³µê²©",p:65,a:100}, {n:"íŠ¸ë¦¼",p:120,a:90}, {n:"í¬ì´ì¦Œí…Œì¼",p:50,a:100}, {n:"ì• ì‹œë“œë´„",p:40,a:100}, {n:"ì…¸ì•”ì¦ˆ",p:90,a:100}, {n:"ë§¹ë…",p:50,a:90} ]
    };

    // [ë³€ê²½] ìœ„ë ¥ ê¸°ë°˜ ì¿¨íƒ€ì„ & í‹°ì–´ (C: <=60)
    function calcMoveStats(m) {
        let t, c;
        if (m.p <= 60) { t="C"; c=0; }
        else if (m.p < 80) { t="R"; c=1; }
        else if (m.p < 110) { t="SR"; c=2; }
        else if (m.p < 140) { t="SSR"; c=3; }
        else { t="UR"; c=4; }
        return { ...m, t, c };
    }

    const MOVE_POOL = {};
    Object.keys(RAW_MOVES).forEach(k => { MOVE_POOL[k] = RAW_MOVES[k].map(m => calcMoveStats(m)); });

    // [ì‹ ê·œ] í¬ì¼“ëª¬ ìŠ¤íƒ¯/ë ˆì–´ë„ ê³„ì‚°ì„ ìœ„í•œ ì‹œë“œê°’ (ID ê¸°ë°˜)
    function getStatSeed(id) {
        // ë‹¨ìˆœ í•´ì‹œ í•¨ìˆ˜ë¡œ IDë³„ ê³ ìœ  ìŠ¤íƒ¯ ë°°ìœ¨ ìƒì„± (0.8 ~ 1.5)
        const x = Math.sin(id * 999) * 10000;
        const rnd = x - Math.floor(x);

        // ì „ì„¤/í™˜ìƒ ë³´ì •
        if(LEGENDARY_IDS.includes(id) || MYTHICAL_IDS.includes(id)) return 1.8;

        // ì§„í™”ì²´ ë³´ì • (ëŒ€ëµì ) - 3ë‹¨ ì§„í™” ë“± ê³ ë ¤í•˜ì—¬ ë’·ë²ˆí˜¸ì¼ìˆ˜ë¡ ê°•í•˜ê²Œ
        let evoBonus = 1.0;
        if(id % 3 === 0) evoBonus = 1.4; // 3ì§„í™”ì²´ ê°€ì •
        else if(id % 3 === 2) evoBonus = 1.2; // 2ì§„í™”ì²´

        return (0.8 + (rnd * 0.4)) * evoBonus;
    }

    function getPokeInfo(id) {
        if (id > 251) id = (id % 251) + 1;
        const name = POKE_NAMES[id - 1] || `No.${id}`;

        // [ë³€ê²½] ìŠ¤íƒ¯ ê¸°ë°˜ ë ˆì–´ë„ ì‚°ì •
        // ê¸°ë³¸ê°’: HP 50, Atk 50 ì— seed ê³±í•˜ê¸°
        const seed = getStatSeed(id);
        const baseHp = Math.floor(50 * seed);
        const baseAtk = Math.floor(50 * seed);
        const total = baseHp + baseAtk;

        let rarity = "C";
        if (total >= 190) rarity = "UR";
        else if (total >= 160) rarity = "SSR";
        else if (total >= 130) rarity = "SR";
        else if (total >= 100) rarity = "R";

        let typeIdx = 4;
        const grass = [1,2,3,43,44,45,69,70,71,102,103,114, 152,153,154,182,187,188,189,191,192, 165, 166];
        const fire = [4,5,6,37,38,58,59,77,126,136,146, 155,156,157,218,219,228,229,240,244,250];
        const water = [7,8,9,54,55,60,61,62,86,87,90,91,98,99,116,117,118,119,120,121,129,130,131,134, 158,159,160,170,171,183,184,186,194,195,211,223,224,226,245,249];
        const electric = [25,26,81,82,100,101,125,135,145, 172,179,180,181,239,243];
        const psychic = [63,64,65,96,97,122,124,150,151, 177,178,196,199,201,202,203,249,251];
        const fighting = [56,57,66,67,68,106,107, 214,236,237];
        const poison = [13,14,15,23,24,29,30,31,32,33,34,41,42,88,89,109,110, 167,168,169,211];

        if (grass.includes(id)) typeIdx = 0; else if (fire.includes(id)) typeIdx = 1; else if (water.includes(id)) typeIdx = 2; else if (electric.includes(id)) typeIdx = 3; else if (psychic.includes(id)) typeIdx = 5; else if (fighting.includes(id)) typeIdx = 6; else if (poison.includes(id)) typeIdx = 7;

        const typeName = TYPE_KEYS[typeIdx];
        return { id, name, rarity, type: { name: typeName, ...TYPE_DATA[typeName] }, sprite: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`, baseHp, baseAtk };
    }

    // [ë³€ê²½] í™•ë¥  ê¸°ë°˜ ìŠ¤í‚¬ ë½‘ê¸° (ê°€ì¤‘ì¹˜ ì ìš©)
    function getRandomMoves(typeName, count, maxTier = null) { // maxTierê°€ ìˆìœ¼ë©´ ê·¸ ì´í•˜ë§Œ (ì´ˆë°˜ìš©)
        const pool = MOVE_POOL[typeName] || MOVE_POOL["ë…¸ë§"];
        let filtered = pool;

        if(maxTier === 'C') filtered = pool.filter(m => m.t === 'C');
        else if(maxTier === 'R') filtered = pool.filter(m => ['C','R'].includes(m.t));

        const res = [];
        for(let i=0; i<count; i++) {
            // í™•ë¥  ì ìš©: C 50%, R 30%, SR 15%, SSR 4%, UR 1%
            const rnd = Math.random() * 100;
            let targetTier = 'C';
            if(rnd > 99) targetTier = 'UR';
            else if(rnd > 95) targetTier = 'SSR';
            else if(rnd > 80) targetTier = 'SR';
            else if(rnd > 50) targetTier = 'R';

            // maxTier ì œí•œì´ ìˆìœ¼ë©´ ë‹¤ìš´ê·¸ë ˆì´ë“œ
            if (maxTier === 'C') targetTier = 'C';
            if (maxTier === 'R' && ['SR','SSR','UR'].includes(targetTier)) targetTier = 'R';

            // í•´ë‹¹ í‹°ì–´ì˜ ìŠ¤í‚¬ ëª©ë¡ì—ì„œ ëœë¤
            let tierMoves = filtered.filter(m => m.t === targetTier);
            if(tierMoves.length === 0) tierMoves = filtered; // fallback

            res.push(tierMoves[Math.floor(Math.random() * tierMoves.length)]);
        }
        return res;
    }

    function calcStats(baseHp, baseAtk, level) {
        return {
            maxHp: Math.floor((baseHp * 0.8) + (level * 10) + 20),
            atk: Math.floor((baseAtk * 0.5) + (level * 3) + 5)
        };
    }

    /* =========================================
     * STATE & LOGIC
     * ========================================= */
    const LS_KEY = { POINTS: "qz_p_v7", OWNED: "qz_o_v7", PARTNER: "qz_st_v7", HOF: "qz_hof_v7", TICKETS: "qz_t_v7", DUPES: "qz_d_v7" };
    let battleState = null;
    let quizCallback = null;

    function getPoints() { return parseInt(localStorage.getItem(LS_KEY.POINTS) || "1000", 10); }
    function setPoints(n) { localStorage.setItem(LS_KEY.POINTS, Math.max(0, n)); updateResUI(); }
    function addPoints(n) { setPoints(getPoints() + n); }
    function getTickets() { return parseInt(localStorage.getItem(LS_KEY.TICKETS) || "0", 10); }
    function setTickets(n) { localStorage.setItem(LS_KEY.TICKETS, Math.max(0, n)); updateResUI(); }
    function addTickets(n) { setTickets(getTickets() + n); }
    function getOwned() { try { return new Set(JSON.parse(localStorage.getItem(LS_KEY.OWNED) || "[]")); } catch { return new Set(); } }
    function saveOwned(set) { localStorage.setItem(LS_KEY.OWNED, JSON.stringify([...set])); }
    function getDupes() { try { return JSON.parse(localStorage.getItem(LS_KEY.DUPES) || "{}"); } catch { return {}; } }
    function saveDupes(d) { localStorage.setItem(LS_KEY.DUPES, JSON.stringify(d)); }
    function getStarterId() { return parseInt(localStorage.getItem(LS_KEY.PARTNER) || "0"); }
    function setStarterId(id) { localStorage.setItem(LS_KEY.PARTNER, id); updateLobbyPartner(); }
    function getHoF() { try { return JSON.parse(localStorage.getItem(LS_KEY.HOF) || "[]"); } catch { return []; } }
    function addHoF(record) {
        const list = getHoF(); list.push(record); list.sort((a,b) => b.stage - a.stage);
        localStorage.setItem(LS_KEY.HOF, JSON.stringify(list.slice(0, 5)));
    }

    function updateResUI() {
        const p = getPoints().toLocaleString(), t = getTickets().toLocaleString();
        document.getElementById("pointsTextLobby").textContent = p;
        document.getElementById("ticketTextLobby").textContent = t;
        document.getElementById("gachaResDisplay").textContent = `P: ${p} / ğŸ«: ${t}`;
    }

    function updateLobbyPartner() {
        const pid = getStarterId();
        if (pid > 0) {
            const info = getPokeInfo(pid);
            const dupes = getDupes()[pid] || 0;
            let xpBonus = 0;
            if (info.rarity === 'UR') xpBonus = 90 * dupes;
            else if (info.rarity === 'SSR') xpBonus = 70 * dupes;
            else if (info.rarity === 'SR') xpBonus = 50 * dupes;
            else if (info.rarity === 'R') xpBonus = 30 * dupes;
            else xpBonus = 10 * dupes;

            document.getElementById("lobbyPartnerName").textContent = info.name;
            document.getElementById("lobbyPartnerImg").src = info.sprite;
            document.getElementById("partnerInfo").textContent = info.name;
            document.getElementById("lobbyStartBonus").textContent = `ì¤‘ë³µ ${dupes}íšŒ / ì‹œì‘ XP +${xpBonus}`;
            document.getElementById("startAdventureBtn").disabled = false;
        } else {
            document.getElementById("lobbyPartnerName").textContent = "ì—†ìŒ";
            document.getElementById("partnerInfo").textContent = "ì„ íƒ í•„ìš”";
            document.getElementById("lobbyStartBonus").textContent = "ì„ íƒ í•„ìš”";
            document.getElementById("startAdventureBtn").disabled = true;
        }
    }

    function renderCodex() {
        const grid = document.getElementById("codexGrid"); grid.innerHTML = "";
        const owned = getOwned(), pid = getStarterId(), dupes = getDupes();
        let count = 0;
        for (let i = 1; i <= 251; i++) {
            const info = getPokeInfo(i);
            if(owned.has(i)) count++;
            const el = document.createElement("div");
            el.className = `poke-card relative rounded-xl p-2 flex flex-col items-center cursor-pointer rarity-${info.rarity}`;
            if (!owned.has(i)) el.classList.add("opacity-50", "grayscale");
            if (pid === i) el.classList.add("ring-4", "ring-emerald-400");
            const dupeCount = dupes[i] || 0;
            el.innerHTML = `<div class="absolute top-1 left-1 text-[9px] font-bold text-slate-400">#${String(i).padStart(3,'0')}</div>${dupeCount > 0 ? `<div class="absolute top-1 right-1 bg-red-500 text-white text-[8px] px-1 rounded-full">+${dupeCount}</div>` : ''}<div class="w-12 h-12 mt-2"><img src="${owned.has(i) ? info.sprite : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png'}" class="w-full h-full pixel-art object-contain ${!owned.has(i)?'opacity-20':''}"></div><div class="text-[10px] font-bold truncate mt-1">${owned.has(i) ? info.name : '???'}</div><div class="text-[8px] font-bold mt-0.5 ${info.rarity==='UR'?'text-red-500':info.rarity==='SSR'?'text-orange-500':'text-slate-400'}">${info.rarity}</div>`;
            el.onclick = () => { if(!owned.has(i)) { showAlert("ë¯¸ë³´ìœ ", "ê°€ì± ë¡œ ë¨¼ì € íšë“í•˜ì„¸ìš”."); return; } setStarterId(i); renderCodex(); };
            grid.appendChild(el);
        }
        document.getElementById("collectionRate").textContent = `${count}/251`;
    }

    function renderHoF() {
        const list = getHoF(), container = document.getElementById("hofList"); container.innerHTML = "";
        if(list.length === 0) { container.innerHTML = '<p class="text-center text-slate-400 py-10">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
        list.forEach((rec, idx) => {
            const div = document.createElement("div");
            div.className = "hof-item border-2 rounded-xl p-3 flex items-center gap-3 relative";
            div.innerHTML = `<div class="font-black text-2xl w-8 text-center text-slate-400 italic">#${idx+1}</div><img src="${rec.sprite}" class="w-12 h-12 pixel-art bg-white rounded-full border border-slate-200"><div class="flex-1"><div class="font-bold text-slate-800">${rec.name} <span class="text-xs font-normal text-slate-500">(${rec.date})</span></div><div class="text-xs text-slate-600">ìµœì¢… ìŠ¤í…Œì´ì§€: <span class="text-red-500 font-bold text-base">${rec.stage}</span></div></div>`;
            container.appendChild(div);
        });
    }

    /* =========================================
     * BATTLE
     * ========================================= */
    function initAdventure() {
        const pid = getStarterId(); if (!pid) return;
        const info = getPokeInfo(pid);
        const dupes = getDupes()[pid] || 0;
        let startXp = 0;
        if (info.rarity === 'UR') startXp = 90 * dupes;
        else if (info.rarity === 'SSR') startXp = 70 * dupes;
        else if (info.rarity === 'SR') startXp = 50 * dupes;
        else if (info.rarity === 'R') startXp = 30 * dupes;
        else startXp = 10 * dupes;

        let level = 1;
        let xp = startXp;
        while (xp >= level * 100) { xp -= level * 100; level++; }

        const stats = calcStats(info.baseHp, info.baseAtk, level);
        const startMoves = getRandomMoves(info.type.name, 1, 'C');

        battleState = {
            stage: 1,
            player: {
                id: pid, name: info.name, sprite: info.sprite, type: info.type.name,
                level: level, xp: xp,
                maxHp: stats.maxHp, hp: stats.maxHp, atk: stats.atk,
                baseHp: info.baseHp, baseAtk: info.baseAtk,
                moves: startMoves
            },
            cooldowns: [0]
        };
        startBattleStage();
        document.getElementById("titleScreen").classList.remove("active");
        document.getElementById("codexScreen").classList.remove("active");
        document.getElementById("battleScreen").classList.add("active");
    }

    function startBattleStage() {
        const { stage, player } = battleState;

        // [ë³€ê²½] ìŠ¤í…Œì´ì§€ ê¸°ë°˜ ì  ìŠ¤í° (ë‚œì´ë„ ê³¡ì„ )
        let enemyRarityPool = ['C'];
        if (stage >= 4) enemyRarityPool.push('R');
        if (stage >= 8) enemyRarityPool.push('SR');
        if (stage >= 12) enemyRarityPool.push('SSR');
        if (stage >= 15) enemyRarityPool.push('UR');

        let enemyId;
        // í•´ë‹¹ Rarityì— ë§ëŠ” ì ì„ ì°¾ì„ ë•Œê¹Œì§€ ëœë¤ (ë¹„íš¨ìœ¨ì ì´ì§€ë§Œ 251ë§ˆë¦¬ë¼ OK)
        let safe = 0;
        do {
            enemyId = Math.floor(Math.random() * 251) + 1;
            const checkInfo = getPokeInfo(enemyId);
            if(enemyRarityPool.includes(checkInfo.rarity)) break;
            safe++;
        } while(safe < 100);

        const eInfo = getPokeInfo(enemyId);
        const levelDiff = Math.floor(Math.random() * 3) - 1;
        const eLevel = Math.max(1, player.level + levelDiff);
        const eStats = calcStats(eInfo.baseHp, eInfo.baseAtk, eLevel);
        const eMoves = getRandomMoves(eInfo.type.name, 1, 'SR'); // ì ì€ ìµœëŒ€ SRê¹Œì§€ ì‚¬ìš©

        battleState.enemy = {
            id: enemyId, name: eInfo.name, sprite: eInfo.sprite, type: eInfo.type.name,
            maxHp: eStats.maxHp, hp: eStats.maxHp, atk: eStats.atk, level: eLevel,
            move: eMoves[0], isBoss: eInfo.rarity === 'UR'
        };
        battleState.cooldowns = battleState.cooldowns.map(c => Math.max(0, c - 1));

        updateBattleUI();
        logBattle(eInfo.rarity === 'UR' ? `âš ï¸ ì „ì„¤ ${eInfo.name} ë“±ì¥!!` : `ì•¼ìƒì˜ ${eInfo.name} (Lv.${eLevel}) ë“±ì¥!`, eInfo.rarity === 'UR' ? 'critical' : 'normal');
    }

    function updateBattleUI() {
        const { player, enemy } = battleState;
        document.getElementById("battleStageText").textContent = battleState.stage;
        document.getElementById("playerName").textContent = player.name;
        document.getElementById("playerLevel").textContent = `Lv.${player.level}`;
        document.getElementById("playerImg").src = player.sprite;
        document.getElementById("playerHpText").textContent = `${Math.ceil(player.hp)}/${Math.ceil(player.maxHp)}`;
        document.getElementById("playerHpBar").style.width = `${Math.max(0, (player.hp/player.maxHp)*100)}%`;
        document.getElementById("playerExpBar").style.width = `${Math.min(100, (player.xp/(player.level*100))*100)}%`;

        document.getElementById("enemyName").textContent = enemy.name;
        document.getElementById("enemyLevel").textContent = `Lv.${enemy.level}`;
        document.getElementById("enemyImg").src = enemy.sprite;
        document.getElementById("enemyHpBar").style.width = `${Math.max(0, (enemy.hp/enemy.maxHp)*100)}%`;
        document.getElementById("enemyTypeBadge").textContent = enemy.type;
        document.getElementById("enemyTypeBadge").className = `text-[9px] text-white px-1.5 py-0.5 rounded mb-1 inline-block ${TYPE_DATA[enemy.type].color}`;

        const btnGrid = document.getElementById("moveButtons"); btnGrid.innerHTML = "";
        player.moves.forEach((m, idx) => {
            const btn = document.createElement("button");
            const cd = battleState.cooldowns[idx];
            let cls = "bg-white border-slate-200";
            let tColor = "text-slate-500";
            if(m.t === "UR") { cls = "bg-red-50 border-red-300"; tColor = "text-red-600"; }
            else if(m.t === "SSR") { cls = "bg-orange-50 border-orange-300"; tColor = "text-orange-600"; }
            else if(m.t === "SR") { cls = "bg-yellow-50 border-yellow-300"; tColor = "text-yellow-600"; }
            else if(m.t === "R") { cls = "bg-blue-50 border-blue-200"; tColor = "text-blue-600"; }

            if(cd > 0) cls = "btn-cooldown";
            btn.className = `${cls} border-b-4 rounded-xl py-2 flex flex-col items-center justify-center transition-all h-16 ${cd===0 ? 'hover:brightness-95 active:border-b-0 active:translate-y-1' : ''}`;
            btn.innerHTML = `<span class="font-bold text-xs truncate w-full text-center">${m.n}</span><span class="text-[9px] ${cd > 0 ? 'text-slate-400' : tColor}">${cd > 0 ? `ì¿¨íƒ€ì„ ${cd}` : `${m.t} / ìœ„${m.p}`}</span>`;
            btn.disabled = cd > 0;
            btn.onclick = () => handlePlayerMove(m, idx);
            btnGrid.appendChild(btn);
        });
    }

    function logBattle(msg, type="normal") {
        const log = document.getElementById("battleLog"); log.textContent = msg;
        log.className = `text-xs font-bold mb-3 h-6 text-center overflow-hidden ${type==='critical'?'text-red-500 animate-pulse': type==='weak'?'text-blue-500':'text-slate-500 italic'}`;
    }

    function handlePlayerMove(move, idx) {
        openQuiz((isCorrect) => {
            if(!isCorrect) { logBattle("í€´ì¦ˆ ì˜¤ë‹µ! ê³µê²© ì‹¤íŒ¨!"); setTimeout(enemyTurn, 800); return; }
            battleState.cooldowns[idx] = move.c + 1;
            const el = document.getElementById("playerImg"); el.classList.remove("animate-attack-player"); void el.offsetWidth; el.classList.add("animate-attack-player");

            const hit = Math.random() * 100 <= move.a;
            const mult = hit ? 1.0 : 0.5; // [ë³€ê²½] 1ë°° ìœ ì§€

            const typeInfo = TYPE_DATA[battleState.enemy.type];
            let eff = 1.0; if (typeInfo.weak.includes(battleState.player.type)) eff = 1.5; if (typeInfo.resist.includes(battleState.player.type)) eff = 0.8;
            let dmg = Math.floor((battleState.player.atk * move.p / 40) * eff * mult * (0.9 + Math.random()*0.2));

            setTimeout(() => {
                battleState.enemy.hp -= dmg;
                const eImg = document.getElementById("enemyImg"); eImg.classList.remove("animate-damage"); void eImg.offsetWidth; eImg.classList.add("animate-damage");
                let msg = hit ? (eff > 1 ? `ê¸‰ì†Œ! íš¨ê³¼ê°€ êµ‰ì¥í–ˆë‹¤! (${dmg})` : `ëª…ì¤‘! (${dmg})`) : `ë¹—ë§ìŒ... (${dmg})`;
                logBattle(msg, hit && eff > 1 ? 'critical' : (!hit ? 'weak' : 'normal'));
                battleState.cooldowns = battleState.cooldowns.map(c => Math.max(0, c - 1));
                updateBattleUI();
                if(battleState.enemy.hp <= 0) setTimeout(handleWin, 800);
                else setTimeout(enemyTurn, 1000);
            }, 200);
        });
    }

    function enemyTurn() {
        if(battleState.enemy.hp <= 0) return;
        const eImg = document.getElementById("enemyImg"); eImg.classList.remove("animate-attack-enemy"); void eImg.offsetWidth; eImg.classList.add("animate-attack-enemy");
        const move = battleState.enemy.move;
        const typeInfo = TYPE_DATA[battleState.player.type];
        let eff = 1.0; if (typeInfo.weak.includes(battleState.enemy.type)) eff = 1.5; if (typeInfo.resist.includes(battleState.enemy.type)) eff = 0.8;
        let dmg = Math.floor((battleState.enemy.atk * move.p / 50) * eff);

        if(Math.random()*100 > 85) { setTimeout(() => { logBattle("ì ì˜ ê³µê²©ì´ ë¹—ë‚˜ê°”ë‹¤!"); }, 300); return; }

        setTimeout(() => {
            battleState.player.hp -= dmg;
            const pImg = document.getElementById("playerImg"); pImg.classList.remove("animate-damage"); void pImg.offsetWidth; pImg.classList.add("animate-damage");
            logBattle(`ì ì˜ ${move.n}! (${dmg})`);
            updateBattleUI();
            if(battleState.player.hp <= 0) setTimeout(handleDefeat, 800);
        }, 200);
    }

    function handleWin() {
        if(battleState.enemy.isBoss) { addTickets(1); alert("âœ¨ ì „ì„¤ ìŠ¹ë¦¬! [í™©ê¸ˆ í‹°ì¼“] íšë“!"); }
        const s = battleState.stage;
        const pt = Math.floor(20 + (s * 10) + (s * s * 0.5));
        const xp = 30 + (s * 10);
        addPoints(pt); battleState.player.xp += xp;

        let lvUp = false;
        if(battleState.player.xp >= battleState.player.level * 100) {
            battleState.player.xp -= battleState.player.level * 100;
            battleState.player.level++;
            const newStats = calcStats(battleState.player.baseHp, battleState.player.baseAtk, battleState.player.level);
            battleState.player.maxHp = newStats.maxHp;
            battleState.player.atk = newStats.atk;
            battleState.player.hp += 20;
            lvUp = true;
        }

        document.getElementById("rewardXpVal").textContent = `${xp}${lvUp?' & Level Up!':''}`;
        const grid = document.getElementById("rewardButtons"); grid.innerHTML = "";
        const isFullSlots = battleState.player.moves.length >= 4;

        [{ t: `í¬ì¸íŠ¸ +${pt} P`, d: "ê°€ì±  ì¬í™”", f: () => { nextStage(); }},
            { t: "ì™„ì „ íšŒë³µ", d: "HP 100%", f: () => { battleState.player.hp = battleState.player.maxHp; nextStage(); }},
            { t: "ê¸°ìˆ  ë¨¸ì‹ ", d: isFullSlots ? "ìŠ¤í‚¬ 1ê°œ êµì²´" : "ìŠ¤í‚¬ ì¶”ê°€ ìŠµë“", f: () => { if(isFullSlots) showSkillReplaceUI(); else addNewSkill(); }}]
            .forEach(r => {
                const btn = document.createElement("button");
                btn.className = "w-full py-3 bg-slate-100 hover:bg-indigo-50 border rounded-xl flex justify-between px-4 items-center";
                btn.innerHTML = `<span class="font-bold text-sm">${r.t}</span><span class="text-xs text-slate-500">${r.d}</span>`;
                btn.onclick = () => { if(r.t !== "ê¸°ìˆ  ë¨¸ì‹ ") document.getElementById("rewardModal").classList.add("hidden"); r.f(); };
                grid.appendChild(btn);
            });
        document.getElementById("rewardModal").classList.remove("hidden");
    }

    function addNewSkill() {
        const newMove = getRandomMoves(battleState.player.type, 1)[0];
        battleState.player.moves.push(newMove);
        battleState.cooldowns.push(0);
        document.getElementById("rewardModal").classList.add("hidden");
        alert(`[${newMove.n}] ê¸°ìˆ ì„ ìƒˆë¡œ ë°°ì› ìŠµë‹ˆë‹¤!`);
        nextStage();
    }

    function showSkillReplaceUI() {
        document.getElementById("rewardTitle").textContent = "êµì²´í•  ìŠ¤í‚¬ì„ ì„ íƒí•˜ì„¸ìš”";
        const grid = document.getElementById("rewardButtons"); grid.innerHTML = "";
        battleState.player.moves.forEach((m, idx) => {
            const btn = document.createElement("button");
            let cls = "bg-white border-slate-200";
            if(m.t === "UR") cls = "bg-red-50 border-red-300"; else if(m.t === "SSR") cls = "bg-orange-50 border-orange-300"; else if(m.t === "SR") cls = "bg-yellow-50 border-yellow-300"; else if(m.t === "R") cls = "bg-blue-50 border-blue-200";
            btn.className = `w-full py-2 ${cls} border rounded-xl hover:brightness-95 flex flex-col items-center`;
            btn.innerHTML = `<span class="font-bold text-sm">${m.n}</span><span class="text-[9px]">${m.t} / ì¿¨íƒ€ì„ ${m.c}</span>`;
            btn.onclick = () => {
                const newMove = getRandomMoves(battleState.player.type, 1)[0];
                battleState.player.moves[idx] = newMove;
                battleState.cooldowns[idx] = 0;
                document.getElementById("rewardModal").classList.add("hidden");
                alert(`[${newMove.n}] ìŠµë“ ì™„ë£Œ!`);
                nextStage();
            };
            grid.appendChild(btn);
        });
    }

    function nextStage() { battleState.stage++; startBattleStage(); }
    function handleDefeat() {
        addHoF({ name: battleState.player.name, sprite: battleState.player.sprite, stage: battleState.stage, date: new Date().toLocaleDateString() });
        alert(`ê²Œì„ ì˜¤ë²„! ìµœì¢… ìŠ¤í…Œì´ì§€: ${battleState.stage}`);
        document.getElementById("battleScreen").classList.remove("active");
        document.getElementById("lobbyScreen").classList.add("active");
        updateResUI();
    }

    function openQuiz(cb) {
        quizCallback = cb;
        const qData = generateMath();
        document.getElementById("quizQuestion").textContent = qData.q;
        const grid = document.getElementById("quizChoices"); grid.innerHTML = "";
        qData.choices.forEach(c => {
            const btn = document.createElement("button");
            btn.className = "bg-slate-100 hover:bg-sky-100 border-2 border-slate-200 font-bold py-4 rounded-xl text-lg";
            btn.textContent = c;
            btn.onclick = () => { document.getElementById("quizModal").classList.add("hidden"); if(quizCallback) quizCallback(c===qData.a); };
            grid.appendChild(btn);
        });
        document.getElementById("quizModal").classList.remove("hidden");
    }

    function generateMath() {
        const r=(n)=>Math.floor(Math.random()*(n+1));
        const t = Math.floor(Math.random()*5); let q="",a=0;
        if(t===0){const n1=r(20),n2=r(20-n1);a=n1+n2;q=`${n1}+${n2}=?`;}
        else if(t===1){const n1=r(20),n2=r(n1);a=n1-n2;q=`${n1}-${n2}=?`;}
        else if(t===2){const n1=r(10),n2=r(10),max=20-n1-n2;const n3=r(Math.max(0,max));a=n1+n2+n3;q=`${n1}+${n2}+${n3}=?`;}
        else if(t===3){const n1=r(20),n2=r(n1),n3=r(n1-n2);a=n1-n2-n3;q=`${n1}-${n2}-${n3}=?`;}
        else{const n1=r(20),n2=r(n1),cur=n1-n2,n3=r(20-cur);a=cur+n3;q=`${n1}-${n2}+${n3}=?`;}
        const s=new Set([a]); while(s.size<4){const f=a+(r(9)-4);if(f>=0&&f<=25&&f!==a)s.add(f);}
        return {q,a,choices:Array.from(s).sort(()=>Math.random()-0.5)};
    }

    // [ë³€ê²½] 10ì—°ì°¨ ì§€ì› Gacha
    function playGacha(type) {
        let count = 1;
        if (type === '10x') { type = 'normal'; count = 10; }

        const costPer = type==='normal' ? 100 : 1;
        // 10ì—°ì°¨ í• ì¸ (900P)
        const totalCost = count === 10 ? 900 : costPer * count;
        const cur = type==='normal' ? getPoints() : getTickets();

        if(cur < totalCost){ alert("ì¬í™” ë¶€ì¡±!"); return; }
        if(type==='normal') setPoints(getPoints()-totalCost); else setTickets(getTickets()-totalCost);

        document.getElementById("gachaPlaceholder").classList.add("hidden");
        const grid = document.getElementById("gachaResultsGrid"); grid.classList.remove("hidden"); grid.innerHTML="";

        const owned = getOwned();
        const dupes = getDupes();

        for(let i=0; i<count; i++) {
            let pid;
            // ì „ì„¤ ì†Œí™˜: 50% í™•ë¥ ë¡œ ì „ì„¤
            if(type==='special') pid = Math.random()<0.5 ? LEGENDARY_IDS[Math.floor(Math.random()*LEGENDARY_IDS.length)] : Math.floor(Math.random()*251)+1;
            else { do { pid = Math.floor(Math.random()*251)+1; } while(LEGENDARY_IDS.includes(pid)); }
            if(pid>251) pid=251;

            const info = getPokeInfo(pid);
            if (owned.has(pid)) { dupes[pid] = (dupes[pid] || 0) + 1; saveDupes(dupes); }
            else { owned.add(pid); saveOwned(owned); }

            const div = document.createElement("div");
            div.className = `flex flex-col items-center p-2 rounded-xl animate-[bounce_0.5s] ${info.rarity==='UR'?'bg-red-100 border border-red-400': info.rarity==='SSR'?'bg-orange-100 border-orange-400' : 'bg-slate-700'}`;
            div.innerHTML = `<img src="${info.sprite}" class="w-8 h-8 pixel-art"><div class="text-[8px] font-bold ${['UR','SSR','SR'].includes(info.rarity)?'text-black':'text-white'} truncate w-full text-center">${info.name}</div>`;
            grid.appendChild(div);
        }
        updateResUI(); renderCodex();
    }

    function showAlert(t,b){ alert(`${t}\n${b}`); }

    window.onload = () => {
        updateResUI(); updateLobbyPartner();
        document.getElementById("startButton").onclick = () => { document.getElementById("titleScreen").classList.remove("active"); document.getElementById("lobbyScreen").classList.add("active"); };
        document.getElementById("lobbyCodexBtn").onclick = () => { renderCodex(); document.getElementById("lobbyScreen").classList.remove("active"); document.getElementById("codexScreen").classList.add("active"); };
        document.getElementById("codexToLobbyBtn").onclick = () => { document.getElementById("codexScreen").classList.remove("active"); document.getElementById("lobbyScreen").classList.add("active"); };
        document.getElementById("lobbyGachaBtn").onclick = () => document.getElementById("gachaModal").classList.remove("hidden");
        document.getElementById("gachaClose").onclick = () => document.getElementById("gachaModal").classList.add("hidden");
        document.getElementById("gachaNormalBtn").onclick = () => playGacha('normal');
        document.getElementById("gacha10Btn").onclick = () => playGacha('10x');
        document.getElementById("gachaSpecialBtn").onclick = () => playGacha('special');
        document.getElementById("startAdventureBtn").onclick = initAdventure;
        document.getElementById("battleBackBtn").onclick = () => { if(confirm("í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) handleDefeat(); };
        document.getElementById("quizCancel").onclick = () => { document.getElementById("quizModal").classList.add("hidden"); if(quizCallback) quizCallback(false); };
        document.getElementById("lobbyHofBtn").onclick = () => { renderHoF(); document.getElementById("hofModal").classList.remove("hidden"); };
        document.getElementById("hofClose").onclick = () => document.getElementById("hofModal").classList.add("hidden");
    };
</script>
</body>
</html>