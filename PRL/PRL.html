<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>PokÃ©mon Roguelike (Gen 9 Expanded)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --bg-color: #202028;
            --text-color: #f0f0f8;
            --accent-color: #ffcc00;
            --panel-bg: #383848;
            --danger-color: #ff5555;
            --success-color: #55ff55;
        }

        * { box-sizing: border-box; touch-action: manipulation; }
        body {
            margin: 0; padding: 0;
            background: var(--bg-color); color: var(--text-color);
            font-family: 'Press Start 2P', cursive;
            overflow: hidden; height: 100vh; width: 100vw;
            display: flex; flex-direction: column; align-items: center;
        }

        /* ìœ í‹¸ë¦¬í‹° */
        .hidden { display: none !important; }
        .full-screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; display: flex; flex-direction: column; }

        /* ë¡œë¹„ */
        #lobby-screen { z-index: 10; background: var(--bg-color); justify-content: center; align-items: center; gap: 20px; }
        .logo { font-size: 24px; color: var(--accent-color); text-shadow: 4px 4px #000; text-align: center; line-height: 1.5; }
        .btn {
            background: var(--panel-bg); border: 4px solid #000; color: #fff;
            padding: 15px 20px; font-family: inherit; font-size: 14px; cursor: pointer;
            box-shadow: inset 2px 2px 0 #ffffff44, inset -2px -2px 0 #00000044;
            text-align: center; min-width: 200px;
        }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-primary { background: #3b82f6; }

        /* íŒŒíŠ¸ë„ˆ ì„ íƒ */
        #partner-select-screen { background: #111; padding: 10px; }
        .grid-container {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px; overflow-y: auto; padding: 10px; width: 100%; flex: 1;
        }
        .dex-entry {
            background: #333; border: 2px solid #555; border-radius: 8px;
            display: flex; flex-direction: column; align-items: center; padding: 5px; cursor: pointer;
        }
        .dex-entry.locked { opacity: 0.3; pointer-events: none; filter: grayscale(100%); }
        .dex-entry.selected { border-color: var(--accent-color); background: #444; }
        .dex-entry img { width: 48px; height: 48px; image-rendering: pixelated; }
        .dex-id { font-size: 8px; margin-bottom: 2px; color: #aaa; }

        /* ë©”ì¸ ê²Œì„ í™”ë©´ */
        #game-screen { background: #1a1a24; }

        /* ìƒë‹¨ ìƒíƒœë°” */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px; background: #000; border-bottom: 2px solid #444; height: 60px;
        }
        .floor-info { font-size: 12px; color: #aaa; }
        .player-hp-bar { width: 120px; height: 16px; background: #333; border: 2px solid #fff; position: relative; }
        .hp-fill { height: 100%; background: var(--success-color); width: 100%; transition: width 0.2s; }
        .hp-text { position: absolute; top:0; left:0; width:100%; text-align:center; font-size:8px; line-height:12px; text-shadow:1px 1px 0 #000; }

        /* ì „íˆ¬ ì˜ì—­ */
        .battle-area {
            flex: 1; position: relative; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background-image: radial-gradient(#333 10%, transparent 10%);
            background-size: 20px 20px;
        }

        .enemy-container { position: absolute; top: 20px; right: 20px; text-align: center; }
        .player-container { position: absolute; bottom: 20px; left: 20px; text-align: center; }

        .sprite { width: 96px; height: 96px; image-rendering: pixelated; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.5)); transition: transform 0.2s; }
        .anim-hit { animation: shake 0.4s; filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); }
        .anim-atk { animation: lunge 0.2s; }

        @keyframes shake { 0% { transform: translate(0,0); } 20% { transform: translate(-5px, 0); } 40% { transform: translate(5px, 0); } 60% { transform: translate(-5px, 0); } 80% { transform: translate(5px, 0); } 100% { transform: translate(0,0); } }
        @keyframes lunge { 0% { transform: translate(0,0); } 50% { transform: scale(1.2); } 100% { transform: translate(0,0); } }

        .dmg-text {
            position: absolute; color: #fff; font-size: 20px;
            text-shadow: 2px 2px 0 #f00; font-weight: bold;
            animation: floatUp 0.8s forwards; pointer-events: none;
        }
        @keyframes floatUp { 0% { transform: translateY(0); opacity:1; } 100% { transform: translateY(-30px); opacity:0; } }

        /* í•˜ë‹¨ ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
        .control-panel {
            height: 140px; background: var(--panel-bg); border-top: 4px solid #000;
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 10px;
        }
        .move-btn {
            background: #ddd; color: #000; border: 2px solid #555; border-radius: 8px;
            font-size: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;
            cursor: pointer; position: relative;
        }
        .move-btn:active { background: #bbb; }
        .move-type { font-size: 8px; opacity: 0.7; margin-bottom: 2px; }
        .move-pp { font-size: 8px; color: #333; }

        /* ë¡œê·¸ë¼ì´í¬ ì„ íƒì§€ (ë³´ìƒ ë“±) */
        #selection-screen { background: rgba(0,0,0,0.9); z-index: 20; justify-content: center; padding: 20px; }
        .selection-title { font-size: 16px; margin-bottom: 20px; color: var(--accent-color); text-align: center; }
        .card-container { display: flex; flex-direction: column; gap: 15px; width: 100%; max-width: 400px; }
        .card {
            background: #fff; color: #000; padding: 15px; border-radius: 10px;
            border: 4px solid #888; cursor: pointer; display: flex; align-items: center; gap: 10px;
        }
        .card:hover { transform: scale(1.02); border-color: var(--accent-color); }
        .card img { width: 40px; height: 40px; image-rendering: pixelated; }

        /* QR ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100;
            display: flex; justify-content: center; align-items: center;
        }
        .modal-box {
            background: #fff; color: #000; padding: 20px; border-radius: 15px;
            text-align: center; max-width: 300px; width: 90%;
        }

        /* í† ìŠ¤íŠ¸ ë©”ì‹œì§€ */
        #toast {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px;
            border-radius: 20px; font-size: 10px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 50;
        }

        /* íƒ€ì…ë³„ ìƒ‰ìƒ */
        .type-fire { background: #ff4422 !important; color: #fff !important; }
        .type-water { background: #3399ff !important; color: #fff !important; }
        .type-grass { background: #77cc55 !important; color: #000 !important; }
        .type-electric { background: #ffcc33 !important; color: #000 !important; }
        .type-ice { background: #66ccff !important; color: #000 !important; }
        .type-fighting { background: #bb5544 !important; color: #fff !important; }
        .type-poison { background: #aa5599 !important; color: #fff !important; }
        .type-ground { background: #ddbb55 !important; color: #000 !important; }
        .type-flying { background: #8899ff !important; color: #000 !important; }
        .type-psychic { background: #ff5599 !important; color: #fff !important; }
        .type-bug { background: #aabb22 !important; color: #000 !important; }
        .type-rock { background: #bbaa66 !important; color: #000 !important; }
        .type-ghost { background: #6666bb !important; color: #fff !important; }
        .type-dragon { background: #7766ee !important; color: #fff !important; }
        .type-steel { background: #aaaabb !important; color: #000 !important; }
        .type-dark { background: #775544 !important; color: #fff !important; }
        .type-normal { background: #aaaa99 !important; color: #000 !important; }

    </style>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
</head>
<body>

<div id="lobby-screen" class="full-screen">
    <div class="logo">POKÃ‰MON<br>ROGUELIKE<br><span style="font-size:12px; color:#aaa;">Ver. DB-1025</span></div>
    <button class="btn btn-primary" onclick="showPartnerSelect()">ëª¨í—˜ ì‹œì‘ (Start)</button>
    <button class="btn" onclick="tryImportFromIndex()">ğŸ“¥ íƒí—˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°</button>
    <button class="btn" onclick="startGhostBattle()">ğŸ‘» ê³ ìŠ¤íŠ¸ ë°°í‹€ (QR)</button>
    <div style="font-size:8px; color:#666; max-width:80%; text-align:center;">
        * íƒí—˜ ê²Œì„(index.html)ì—ì„œ í¬ì¼“ëª¬ì„ ì¡ì•„<br>ì´ê³³ìœ¼ë¡œ ë‚´ë³´ë‚¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
</div>

<div id="partner-select-screen" class="full-screen hidden">
    <div style="text-align:center; padding:10px;">íŒŒíŠ¸ë„ˆ ì„ íƒ</div>
    <div class="grid-container" id="partner-grid"></div>
    <button class="btn" style="width:100%; border-radius:0;" onclick="switchScreen('lobby-screen')">ë’¤ë¡œê°€ê¸°</button>
</div>

<div id="game-screen" class="full-screen hidden">
    <div class="top-bar">
        <div style="display:flex; flex-direction:column;">
            <span style="color:#ffcc00; font-size:10px;">Lv.<span id="p-lv">5</span> <span id="p-name">í”¼ì¹´ì¸„</span></span>
            <div class="player-hp-bar"><div class="hp-fill" id="p-hp-bar"></div><span class="hp-text" id="p-hp-text">20/20</span></div>
        </div>
        <div class="floor-info">B<span id="floor-num">1</span>F</div>
    </div>

    <div class="battle-area">
        <div class="enemy-container">
            <div style="font-size:8px; margin-bottom:4px; color:#ff5555;">Lv.<span id="e-lv">3</span> <span id="e-name">êµ¬êµ¬</span></div>
            <div style="width:80px; height:8px; background:#333; border:1px solid #fff; margin:0 auto;"><div class="hp-fill" id="e-hp-bar" style="background:#ff5555;"></div></div>
            <img id="e-img" class="sprite" src="" alt="Enemy">
        </div>

        <div class="player-container">
            <img id="p-img" class="sprite" src="" alt="Player" style="transform:scaleX(-1);"> </div>
        <div id="dmg-layer" style="position:absolute; inset:0; pointer-events:none;"></div>
    </div>

    <div class="control-panel" id="move-container">
    </div>
</div>

<div id="selection-screen" class="full-screen hidden">
    <div class="selection-title" id="sel-title">ì „ë¦¬í’ˆ ì„ íƒ</div>
    <div class="card-container" id="sel-container"></div>
</div>

<div id="qr-modal" class="modal-overlay hidden" onclick="closeQrModal(event)">
    <div class="modal-box">
        <div id="qr-canvas-area"></div>
        <p style="font-size:10px; margin-top:10px;">ì¹œêµ¬ì—ê²Œ ë³´ì—¬ì£¼ì„¸ìš”!</p>
        <button class="btn" style="margin-top:10px; padding:5px;" onclick="closeQrModal(null, true)">ë‹«ê¸°</button>
    </div>
</div>

<div id="scanner-screen" class="full-screen hidden" style="background:#000;">
    <video id="qr-video" style="width:100%; height:60%; object-fit:cover;"></video>
    <div style="flex:1; display:flex; justify-content:center; align-items:center; color:#fff;">
        QR ì½”ë“œë¥¼ ë¹„ì¶°ì£¼ì„¸ìš”
    </div>
    <button class="btn" onclick="stopScanner()">ì·¨ì†Œ</button>
</div>

<div id="toast">ë©”ì‹œì§€</div>

<script>
    /**
     * ==========================================================
     * POKEMON ROGUELIKE (PRL) - DB EXTENDED (1025)
     * ==========================================================
     */

// ì „ì—­ ì„¤ì •
    const BASE_DEX_MAX = 1025; // 9ì„¸ëŒ€ê¹Œì§€ ì§€ì›
    const TYPE_COLORS = {
        "ë…¸ë§":"#aaaa99", "ë¶ˆê½ƒ":"#ff4422", "ë¬¼":"#3399ff", "ì „ê¸°":"#ffcc33",
        "í’€":"#77cc55", "ì–¼ìŒ":"#66ccff", "ê²©íˆ¬":"#bb5544", "ë…":"#aa5599",
        "ë•…":"#ddbb55", "ë¹„í–‰":"#8899ff", "ì—ìŠ¤í¼":"#ff5599", "ë²Œë ˆ":"#aabb22",
        "ë°”ìœ„":"#bbaa66", "ê³ ìŠ¤íŠ¸":"#6666bb", "ê°•ì² ":"#aaaabb", "ë“œë˜ê³¤":"#7766ee", "ì•…":"#775544"
    };
    const TYPE_EN_MAP = {
        "normal":"ë…¸ë§", "fire":"ë¶ˆê½ƒ", "water":"ë¬¼", "electric":"ì „ê¸°", "grass":"í’€",
        "ice":"ì–¼ìŒ", "fighting":"ê²©íˆ¬", "poison":"ë…", "ground":"ë•…", "flying":"ë¹„í–‰",
        "psychic":"ì—ìŠ¤í¼", "bug":"ë²Œë ˆ", "rock":"ë°”ìœ„", "ghost":"ê³ ìŠ¤íŠ¸", "dragon":"ë“œë˜ê³¤",
        "steel":"ê°•ì² ", "dark":"ì•…", "fairy":"ë…¸ë§" // í˜ì–´ë¦¬ëŠ” ë…¸ë§ ì·¨ê¸‰ (ë°¸ëŸ°ìŠ¤ ìœ ì§€)
    };

    // [ì¤‘ìš”] DBê°€ ë¡œë“œë  ë³€ìˆ˜ë“¤
    let POKE_NAMES = []; // ì¸ë±ìŠ¤ = id-1
    let ALL_STATS_DB = []; // ì¸ë±ìŠ¤ = id-1 (hp, atk, def, spa, spd, spe)
    let POKE_TYPES = []; // ì¸ë±ìŠ¤ = id-1, [type1, type2]

    // ìœ ì € ë°ì´í„°
    let userDex = new Set([25, 1, 4, 7]); // ê¸°ë³¸ ì œê³µ: í”¼ì¹´ì¸„ + 1ì„¸ëŒ€ ìŠ¤íƒ€íŒ…
    let myPartner = null; // í˜„ì¬ ì„ íƒëœ í¬ì¼“ëª¬ {id, lv, hp, maxHp, stats, moves...}
    let floor = 1;
    let enemy = null;
    let isBattleBusy = false;

    // DB ë¡œë“œ í•¨ìˆ˜
    async function loadPokeDB() {
        try {
            showToast("ë°ì´í„°ë² ì´ìŠ¤ ë¡œë”© ì¤‘...");
            // ê°™ì€ í´ë”ì˜ poke_db.jsonì„ fetch (buildPokeDb.cjsë¡œ ìƒì„±ëœ íŒŒì¼)
            const res = await fetch('./poke_db.json');
            if(!res.ok) throw new Error("JSON Fetch Failed");
            const data = await res.json();

            // ë°°ì—´ ì´ˆê¸°í™” (0ë²ˆ ì¸ë±ìŠ¤ë¶€í„° ì±„ì›€, id 1 => index 0)
            POKE_NAMES = new Array(BASE_DEX_MAX).fill("???");
            ALL_STATS_DB = new Array(BASE_DEX_MAX).fill(null);
            POKE_TYPES = new Array(BASE_DEX_MAX).fill(["ë…¸ë§"]);

            data.pokemon.forEach(p => {
                if(p.id <= BASE_DEX_MAX) {
                    const idx = p.id - 1;
                    POKE_NAMES[idx] = p.name_ko;
                    ALL_STATS_DB[idx] = p.stats_habdcs; // [hp, atk, def, spa, spd, spe]
                    POKE_TYPES[idx] = p.types_ko;
                }
            });

            console.log(`DB Loaded: ${data.pokemon.length} entries.`);
            showToast("ë¡œë”© ì™„ë£Œ!");

            // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ë„ê° ë¶ˆëŸ¬ì˜¤ê¸°
            loadSaveData();

        } catch (e) {
            console.error(e);
            alert("ë°ì´í„°ë² ì´ìŠ¤(poke_db.json) ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\nê²Œì„ì´ ì •ìƒ ì‘ë™í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }
    }

    // ì´ˆê¸°í™”
    window.onload = async () => {
        await loadPokeDB();

        // URL íŒŒë¼ë¯¸í„°ë¡œ ë°ì´í„° ì „ë‹¬ë°›ì•˜ëŠ”ì§€ í™•ì¸
        const urlParams = new URLSearchParams(window.location.search);
        const importData = urlParams.get('import');
        if(importData) {
            processImportToken(importData);
            // ì²˜ë¦¬ í›„ URL ì •ë¦¬
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    };

    /* =========================================
       ë°ì´í„° ê´€ë¦¬ (Import / Save)
       ========================================= */
    function loadSaveData() {
        const saved = localStorage.getItem("prl_dex_v2");
        if(saved) {
            try {
                const arr = JSON.parse(saved);
                arr.forEach(id => {
                    if(id <= BASE_DEX_MAX) userDex.add(id);
                });
            } catch(e) {}
        }
    }

    function saveDex() {
        localStorage.setItem("prl_dex_v2", JSON.stringify(Array.from(userDex)));
    }

    async function tryImportFromIndex() {
        try {
            const text = await navigator.clipboard.readText();
            if(!text) { showToast("í´ë¦½ë³´ë“œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."); return; }

            processImportToken(text);
        } catch(e) {
            // í´ë¦½ë³´ë“œ ê¶Œí•œ ì—†ìŒ ë“±
            const manual = prompt("íƒí—˜ ê²Œì„ì—ì„œ ë³µì‚¬í•œ ì½”ë“œë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”:");
            if(manual) processImportToken(manual);
        }
    }

    function processImportToken(token) {
        try {
            // base64url -> string
            const jsonStr = atob(token.replace(/-/g, '+').replace(/_/g, '/'));
            const data = JSON.parse(jsonStr);

            if(data.source !== "index") throw new Error("Invalid Source");

            let addedCount = 0;
            let newPartner = null;

            if(data.dexIds && Array.isArray(data.dexIds)) {
                data.dexIds.forEach(id => {
                    if(id <= BASE_DEX_MAX && !userDex.has(id)) {
                        userDex.add(id);
                        addedCount++;
                    }
                });
            }

            if(data.partnerId && data.partnerId <= BASE_DEX_MAX) {
                newPartner = data.partnerId;
            }

            saveDex();

            let msg = "ë°ì´í„° ì—°ë™ ì„±ê³µ!";
            if(addedCount > 0) msg += `\nìƒˆ í¬ì¼“ëª¬ ${addedCount}ë§ˆë¦¬ ë“±ë¡!`;
            else msg += `\n(ì´ë¯¸ ë“±ë¡ëœ í¬ì¼“ëª¬ë“¤ì…ë‹ˆë‹¤)`;

            if(newPartner) {
                msg += "\níŒŒíŠ¸ë„ˆë¡œ ì„ íƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                if(confirm(msg)) {
                    startGame(newPartner);
                    return;
                }
            } else {
                alert(msg);
            }
        } catch(e) {
            console.error(e);
            alert("ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„° ì½”ë“œì…ë‹ˆë‹¤.");
        }
    }

    /* =========================================
       ê²Œì„ ë¡œì§
       ========================================= */

    // íŒŒíŠ¸ë„ˆ ì„ íƒ í™”ë©´ í‘œì‹œ
    function showPartnerSelect() {
        const grid = document.getElementById('partner-grid');
        grid.innerHTML = "";

        // ë„ê° ë²ˆí˜¸ìˆœ ì •ë ¬
        const sorted = Array.from(userDex).sort((a,b) => a-b);

        sorted.forEach(id => {
            const div = document.createElement('div');
            div.className = 'dex-entry';

            // DBì—ì„œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸°
            const name = POKE_NAMES[id-1] || `No.${id}`;

            div.innerHTML = `
            <span class="dex-id">No.${id}</span>
            <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png" loading="lazy">
            <span style="font-size:8px;">${name}</span>
        `;
            div.onclick = () => startGame(id);
            grid.appendChild(div);
        });

        switchScreen('partner-select-screen');
    }

    function startGame(id) {
        // í”Œë ˆì´ì–´ ì´ˆê¸°í™”
        const stats = ALL_STATS_DB[id-1] || [10,10,10,10,10,10];
        const name = POKE_NAMES[id-1];
        const types = POKE_TYPES[id-1];

        myPartner = {
            id: id,
            name: name,
            types: types,
            lv: 5,
            baseStats: stats, // [hp, atk, def, spa, spd, spe]
            // ì‹¤ì œ ìŠ¤íƒ¯ (ê°„ë‹¨ ê³µì‹: base * lv / 50 + 5)
            hp: 0, maxHp: 0, atk:0, def:0, spa:0, spd:0, spe:0,
            moves: [],
            exp: 0,
            nextExp: 50
        };
        calcStats(myPartner);
        myPartner.hp = myPartner.maxHp;

        // ê¸°ë³¸ ê¸°ìˆ  2ê°œ ë°°ì • (ëª¸í†µë°•ì¹˜ê¸° + íƒ€ì…ë³„ ê¸°ìˆ )
        myPartner.moves.push({ name: "ëª¸í†µë°•ì¹˜ê¸°", type: "ë…¸ë§", power: 40, acc: 100, pp: 35, maxPp: 35, cat: "physical" });
        // íƒ€ì… ìì† ê¸°ìˆ  í•˜ë‚˜ ì¶”ê°€ (ê°„ì´ ë¡œì§)
        const stabType = types[0];
        myPartner.moves.push(generateBasicMove(stabType));

        floor = 1;
        switchScreen('game-screen');
        encounterEnemy();
        updateUi();
    }

    function calcStats(p) {
        const base = p.baseStats;
        // HP: (Base * 2 * Lv / 100) + Lv + 10 (ì•½ì‹)
        p.maxHp = Math.floor((base[0] * 2 * p.lv / 100) + p.lv + 10);
        // Others: (Base * 2 * Lv / 100) + 5
        p.atk = Math.floor((base[1] * 2 * p.lv / 100) + 5);
        p.def = Math.floor((base[2] * 2 * p.lv / 100) + 5);
        p.spa = Math.floor((base[3] * 2 * p.lv / 100) + 5);
        p.spd = Math.floor((base[4] * 2 * p.lv / 100) + 5);
        p.spe = Math.floor((base[5] * 2 * p.lv / 100) + 5);
    }

    function generateBasicMove(type) {
        // íƒ€ì…ë³„ ëŒ€í‘œ ì €ìœ„ë ¥ ê¸°ìˆ  ë§¤í•‘
        const movePool = {
            "ë…¸ë§": "í• í€´ê¸°", "ë¶ˆê½ƒ": "ë¶ˆê½ƒì„¸ë¡€", "ë¬¼": "ë¬¼ëŒ€í¬", "í’€": "ë©êµ´ì±„ì°",
            "ì „ê¸°": "ì „ê¸°ì‡¼í¬", "ì–¼ìŒ": "ëˆˆì‹¸ë¼ê¸°", "ê²©íˆ¬": "ë°”ìœ„ê¹¨ê¸°", "ë…": "ë…ì¹¨",
            "ë•…": "ì§„í™ë¿Œë¦¬ê¸°", "ë¹„í–‰": "ìª¼ê¸°", "ì—ìŠ¤í¼": "ì—¼ë™ë ¥", "ë²Œë ˆ": "ë²Œë ˆë¨¹ê¸°",
            "ë°”ìœ„": "ëŒë–¨êµ¬ê¸°", "ê³ ìŠ¤íŠ¸": "í•¥ê¸°", "ê°•ì² ": "ë©”íƒˆí¬ë¡œìš°", "ë“œë˜ê³¤": "ìš©ì˜ìˆ¨ê²°", "ì•…": "ë¬¼ê¸°"
        };
        return {
            name: movePool[type] || "ëª¸í†µë°•ì¹˜ê¸°",
            type: type,
            power: 40, acc: 100, pp: 25, maxPp: 25,
            cat: (type==="ì—ìŠ¤í¼"||type==="ì „ê¸°"||type==="ë¶ˆê½ƒ"||type==="ë¬¼"||type==="í’€"||type==="ì–¼ìŒ"||type==="ë“œë˜ê³¤") ? "special" : "physical"
        };
    }

    function encounterEnemy() {
        isBattleBusy = false;
        // ì  ìƒì„± (ëœë¤)
        // 1025ë§ˆë¦¬ ì¤‘ ëœë¤ or í˜„ì¬ ì¸µìˆ˜ì— ë§ì¶°ì„œ
        let eid = Math.floor(Math.random() * BASE_DEX_MAX) + 1;
        // DB ìœ íš¨ì„± ì²´í¬ (í˜¹ì‹œ ë¹„ì–´ìˆìœ¼ë©´ 1ë²ˆìœ¼ë¡œ)
        if(!POKE_NAMES[eid-1]) eid = 1;

        const stats = ALL_STATS_DB[eid-1] || [10,10,10,10,10,10];
        const name = POKE_NAMES[eid-1];
        const types = POKE_TYPES[eid-1];

        enemy = {
            id: eid,
            name: name,
            types: types,
            lv: Math.max(1, myPartner.lv + Math.floor(Math.random()*3) - 1),
            baseStats: stats,
            hp:0, maxHp:0, atk:0, def:0, spa:0, spd:0, spe:0
        };
        calcStats(enemy);
        enemy.hp = enemy.maxHp; // í’€í”¼

        updateUi();
    }

    function updateUi() {
        // Player
        document.getElementById('p-name').textContent = myPartner.name;
        document.getElementById('p-lv').textContent = myPartner.lv;
        const pHpPct = (myPartner.hp / myPartner.maxHp) * 100;
        document.getElementById('p-hp-bar').style.width = `${Math.max(0, pHpPct)}%`;
        document.getElementById('p-hp-bar').style.background = pHpPct > 50 ? '#55ff55' : (pHpPct > 20 ? '#ffcc00' : '#ff5555');
        document.getElementById('p-hp-text').textContent = `${myPartner.hp}/${myPartner.maxHp}`;
        document.getElementById('p-img').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/back/${myPartner.id}.png`;

        // Enemy
        document.getElementById('e-name').textContent = enemy.name;
        document.getElementById('e-lv').textContent = enemy.lv;
        const eHpPct = (enemy.hp / enemy.maxHp) * 100;
        document.getElementById('e-hp-bar').style.width = `${Math.max(0, eHpPct)}%`;
        document.getElementById('e-img').src = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${enemy.id}.png`;

        document.getElementById('floor-num').textContent = floor;

        // Moves
        const moveContainer = document.getElementById('move-container');
        moveContainer.innerHTML = "";
        myPartner.moves.forEach((m, idx) => {
            const btn = document.createElement('div');
            btn.className = `move-btn type-${TYPE_EN_MAP_REV(m.type)}`;
            btn.innerHTML = `
            <span class="move-type">${m.type}</span>
            <span>${m.name}</span>
            <span class="move-pp">${m.pp}/${m.maxPp}</span>
        `;
            btn.onclick = () => useMove(idx);
            // ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ (íƒ€ì…ìƒ‰ìƒ)
            const enType = TYPE_EN_MAP_REV(m.type);
            if(enType) btn.classList.add(`type-${enType}`);

            moveContainer.appendChild(btn);
        });
    }

    function TYPE_EN_MAP_REV(ko) {
        return Object.keys(TYPE_EN_MAP).find(key => TYPE_EN_MAP[key] === ko);
    }

    async function useMove(moveIdx) {
        if(isBattleBusy || myPartner.hp <= 0) return;
        const move = myPartner.moves[moveIdx];
        if(move.pp <= 0) { showToast("PPê°€ ë¶€ì¡±í•©ë‹ˆë‹¤!"); return; }

        isBattleBusy = true;
        move.pp--;
        updateUi();

        // Player Attack
        await animateAttack('p-img', 'anim-atk');
        const dmg = calcDamage(myPartner, enemy, move);
        showDamage(dmg, 'e-img');
        await animateHit('e-img');
        enemy.hp -= dmg;
        updateUi();

        if(enemy.hp <= 0) {
            await winBattle();
        } else {
            // Enemy Turn
            setTimeout(async () => {
                // ì  ê³µê²© (ë‹¨ìˆœ: ëª¸í†µë°•ì¹˜ê¸° or ìì†ê¸°)
                await animateAttack('e-img', 'anim-atk');
                // ì ì˜ ê³µê²©ë ¥ ê¸°ì¤€ (ë¬¼ë¦¬/íŠ¹ìˆ˜ êµ¬ë¶„ ì—†ì´ ë‹¨ìˆœí™”)
                // ì  ê¸°ìˆ ì€ ëœë¤ ìœ„ë ¥ 40~60 ê°€ì •
                const enemyMove = { type: enemy.types[0], power: 40, cat: "physical" };
                const eDmg = calcDamage(enemy, myPartner, enemyMove);
                showDamage(eDmg, 'p-img');
                await animateHit('p-img');
                myPartner.hp -= eDmg;
                updateUi();

                if(myPartner.hp <= 0) {
                    alert(`íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤... ${floor}ì¸µê¹Œì§€ ë„ë‹¬.`);
                    switchScreen('lobby-screen');
                }
                isBattleBusy = false;
            }, 500);
        }
    }

    function calcDamage(atkObj, defObj, move) {
        // (2 * Lv / 5 + 2) * Power * (A / D) / 50 + 2
        // ë¬¼ë¦¬/íŠ¹ìˆ˜ êµ¬ë¶„
        let a = (move.cat === "physical") ? atkObj.atk : atkObj.spa;
        let d = (move.cat === "physical") ? defObj.def : defObj.spd;

        let baseDmg = Math.floor(((2 * atkObj.lv / 5 + 2) * move.power * (a / d)) / 50 + 2);

        // ìì† ë³´ì • (1.5)
        if(atkObj.types.includes(move.type)) baseDmg = Math.floor(baseDmg * 1.5);

        // íƒ€ì… ìƒì„± (ì•½ì‹: 2ë°°, 0.5ë°°, 1ë°°ë§Œ ì ìš© - ì‹¤ì œë¡œëŠ” ë³µì¡í•¨)
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ëœë¤ í¬ë¦¬í‹°ì»¬(1.5ë°°)ë§Œ ì ìš©
        if(Math.random() < 0.0625) {
            baseDmg *= 2; // ê¸‰ì†Œ
            showToast("ê¸‰ì†Œì— ë§ì•˜ë‹¤!");
        }

        return Math.max(1, baseDmg);
    }

    // ì• ë‹ˆë©”ì´ì…˜ ìœ í‹¸
    function animateAttack(id, animClass) {
        return new Promise(resolve => {
            const el = document.getElementById(id);
            el.classList.add(animClass);
            setTimeout(() => {
                el.classList.remove(animClass);
                resolve();
            }, 200);
        });
    }
    function animateHit(id) {
        return new Promise(resolve => {
            const el = document.getElementById(id);
            el.classList.add('anim-hit');
            setTimeout(() => {
                el.classList.remove('anim-hit');
                resolve();
            }, 400);
        });
    }
    function showDamage(amount, targetId) {
        const target = document.getElementById(targetId);
        const rect = target.getBoundingClientRect();
        const layer = document.getElementById('dmg-layer');

        const div = document.createElement('div');
        div.className = 'dmg-text';
        div.textContent = `-${amount}`;
        // ìœ„ì¹˜ ì¡°ì •
        // ëª¨ë°”ì¼/PC ì¢Œí‘œê³„ ë‹¨ìˆœí™”
        div.style.left = (targetId === 'e-img' ? '70%' : '30%');
        div.style.top = (targetId === 'e-img' ? '20%' : '60%');

        layer.appendChild(div);
        setTimeout(() => div.remove(), 800);
    }

    async function winBattle() {
        showToast(`${enemy.name}ì„(ë¥¼) ì“°ëŸ¬íŠ¸ë ¸ë‹¤!`);
        await new Promise(r => setTimeout(r, 1000));

        // ê²½í—˜ì¹˜ íšë“
        const gainExp = Math.floor(enemy.lv * 10 * 1.5);
        myPartner.exp += gainExp;
        showToast(`ê²½í—˜ì¹˜ ${gainExp} íšë“!`);

        if(myPartner.exp >= myPartner.nextExp) {
            myPartner.lv++;
            myPartner.exp -= myPartner.nextExp;
            myPartner.nextExp = Math.floor(myPartner.nextExp * 1.2);
            calcStats(myPartner); // ìŠ¤íƒ¯ ì¬ê³„ì‚°
            myPartner.hp = myPartner.maxHp; // ë ˆë²¨ì—… ì‹œ íšŒë³µ
            showToast(`ë ˆë²¨ ì—…! Lv.${myPartner.lv}`);
        }

        floor++;

        // ë³´ìƒ ì„ íƒ (íšŒë³µ or ì•„ì´í…œ ë“± - ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœí™”í•˜ì—¬ ì¸µ ì§„í–‰)
        if(floor % 5 === 0) {
            // 5ì¸µë§ˆë‹¤ ì „ë¦¬í’ˆ ì„ íƒ
            showSelection();
        } else {
            encounterEnemy();
        }
    }

    function showSelection() {
        const sc = document.getElementById('selection-screen');
        const con = document.getElementById('sel-container');
        con.innerHTML = "";

        // ì„ íƒì§€ 1: íšŒë³µ
        const card1 = document.createElement('div');
        card1.className = 'card';
        card1.innerHTML = `<div>ğŸ’Š</div><div>ì²´ë ¥ ëª¨ë‘ íšŒë³µ</div>`;
        card1.onclick = () => {
            myPartner.hp = myPartner.maxHp;
            myPartner.moves.forEach(m => m.pp = m.maxPp);
            showToast("ì™„ì „ íšŒë³µ!");
            switchScreen('game-screen');
            encounterEnemy();
        };
        con.appendChild(card1);

        // ì„ íƒì§€ 2: ìµœëŒ€ ì²´ë ¥ ì¦ê°€
        const card2 = document.createElement('div');
        card2.className = 'card';
        card2.innerHTML = `<div>â¤ï¸</div><div>ìµœëŒ€ ì²´ë ¥ +10 ì¦ê°€</div>`;
        card2.onclick = () => {
            myPartner.maxHp += 10;
            myPartner.hp += 10;
            showToast("ì²´ë ¥ì´ ëŠ˜ì–´ë‚¬ë‹¤!");
            switchScreen('game-screen');
            encounterEnemy();
        };
        con.appendChild(card2);

        switchScreen('selection-screen');
    }


    /* =========================================
       ê³ ìŠ¤íŠ¸ ë°°í‹€ (QR)
       ========================================= */
    const GHOST_ROOT_URL = window.location.href.split('?')[0]; // í˜„ì¬ ì£¼ì†Œ ê¸°ì¤€

    function startGhostBattle() {
        // ë‚´ íŒŒíŠ¸ë„ˆ ë°ì´í„°ë¥¼ QRë¡œ ìƒì„±
        if(!myPartner && userDex.size > 0) {
            // íŒŒíŠ¸ë„ˆê°€ ì—†ìœ¼ë©´ ë„ê° ì²«ë²ˆì§¸ë¡œ ì„ì‹œ ìƒì„±
            startGame(Array.from(userDex)[0]);
            switchScreen('lobby-screen'); // ê²Œì„ ì‹œì‘ì€ ì•ˆí•¨
        }

        if(!myPartner) { alert("íŒŒíŠ¸ë„ˆê°€ ì—†ìŠµë‹ˆë‹¤."); return; }

        // ë°ì´í„° ì••ì¶• (id, lv, stats ë“±)
        const ghostData = {
            id: myPartner.id,
            lv: myPartner.lv,
            nm: myPartner.name,
            st: [myPartner.hp, myPartner.atk, myPartner.def, myPartner.spa, myPartner.spd, myPartner.spe]
        };

        const json = JSON.stringify(ghostData);
        // URLì— ë¶™ì—¬ì„œ QR ìƒì„± (ê°„í¸ ê³µìœ )
        // ì‹¤ì œë¡œëŠ” ë°ì´í„°ê°€ ê¸¸ë©´ URLì´ ë„ˆë¬´ ê¸¸ì–´ì§ˆ ìˆ˜ ìˆìœ¼ë¯€ë¡œ base64 ë“±ìœ¼ë¡œ ì••ì¶• ì¶”ì²œ
        const payload = btoa(unescape(encodeURIComponent(json)));
        const targetUrl = `${GHOST_ROOT_URL}?ghost=${payload}`;

        const canvas = document.createElement('canvas');
        QRCode.toCanvas(canvas, targetUrl, { width: 200 }, function (error) {
            if (error) console.error(error);
            const area = document.getElementById('qr-canvas-area');
            area.innerHTML = "";
            area.appendChild(canvas);

            // ìŠ¤ìºë„ˆ ë²„íŠ¼ë„ ì¶”ê°€
            const btn = document.createElement('button');
            btn.className = "btn";
            btn.textContent = "ğŸ“· ìƒëŒ€ QR ìŠ¤ìº”í•˜ê¸°";
            btn.style.marginTop = "10px";
            btn.onclick = () => {
                closeQrModal(null, true);
                openScanner();
            };
            area.appendChild(btn);

            document.getElementById('qr-modal').classList.remove('hidden');
        });
    }

    function closeQrModal(e, force) {
        if(force || e.target.id === 'qr-modal') {
            document.getElementById('qr-modal').classList.add('hidden');
        }
    }

    // ìŠ¤ìºë„ˆ
    let videoStream = null;
    function openScanner() {
        switchScreen('scanner-screen');
        const video = document.getElementById('qr-video');
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
            .then(function(stream) {
                videoStream = stream;
                video.srcObject = stream;
                video.setAttribute("playsinline", true);
                video.play();
                requestAnimationFrame(tickScanner);
            });
    }

    function tickScanner() {
        if(!videoStream) return;
        const video = document.getElementById('qr-video');
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            const canvas = document.createElement("canvas");
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });

            if (code) {
                // QR ë°œê²¬
                stopScanner();
                handleGhostQr(code.data);
            } else {
                requestAnimationFrame(tickScanner);
            }
        } else {
            requestAnimationFrame(tickScanner);
        }
    }

    function stopScanner() {
        if(videoStream) {
            videoStream.getTracks().forEach(track => track.stop());
            videoStream = null;
        }
        switchScreen('lobby-screen');
    }

    function handleGhostQr(urlOrData) {
        try {
            let payload = "";
            if(urlOrData.includes("ghost=")) {
                payload = urlOrData.split("ghost=")[1];
            } else {
                payload = urlOrData; // í˜¹ì‹œ raw dataì¼ ê²½ìš°
            }

            const json = decodeURIComponent(escape(atob(payload)));
            const ghost = JSON.parse(json);

            if(confirm(`[${ghost.nm} Lv.${ghost.lv}] ì™€ ë°°í‹€í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                startGhostBattleGame(ghost);
            }
        } catch(e) {
            alert("ì˜ëª»ëœ QR ì½”ë“œì…ë‹ˆë‹¤.");
        }
    }

    function startGhostBattleGame(ghost) {
        // ì ìœ¼ë¡œ ì„¤ì •
        enemy = {
            id: ghost.id,
            name: `Ghost ${ghost.nm}`,
            types: POKE_TYPES[ghost.id-1],
            lv: ghost.lv,
            maxHp: ghost.st[0],
            hp: ghost.st[0],
            atk: ghost.st[1],
            def: ghost.st[2],
            spa: ghost.st[3],
            spd: ghost.st[4],
            spe: ghost.st[5]
        };

        // ë‚´ íŒŒíŠ¸ë„ˆ í™•ì¸
        if(!myPartner) startGame(Array.from(userDex)[0]);

        switchScreen('game-screen');
        updateUi();
        showToast("ê³ ìŠ¤íŠ¸ ë°°í‹€ ì‹œì‘!");
    }


    /* =========================================
       ìœ í‹¸ë¦¬í‹°
       ========================================= */
    function switchScreen(id) {
        document.querySelectorAll('.full-screen').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.opacity = 1;
        setTimeout(() => t.style.opacity = 0, 2000);
    }

</script>
</body>
</html>