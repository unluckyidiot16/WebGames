<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>QuizMon: Legend 300 (Ver 2.2 Skill Select)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; touch-action: manipulation; }
        .view { display: none; }
        .view.active { display: flex; }
        .poke-card { transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .poke-card:active { transform: scale(0.95); }
        .rarity-SR { background: linear-gradient(135deg, #fff 0%, #fff7ed 100%); border: 2px solid #f59e0b; box-shadow: 0 0 10px rgba(245, 158, 11, 0.3); }
        .rarity-R  { border: 2px solid #60a5fa; }
        .rarity-C  { border: 1px solid #e2e8f0; }
        .modal-backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(2px); }
        img.pixel-art { image-rendering: pixelated; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* === ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ === */
        @keyframes damageShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-6px) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); }
            40% { transform: translateX(6px) rotate(5deg); }
            60% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
        }
        .animate-damage { animation: damageShake 0.4s ease-in-out; }

        @keyframes attackRight {
            0% { transform: translateX(0) scaleX(-1); }
            50% { transform: translateX(30px) scaleX(-1); }
            100% { transform: translateX(0) scaleX(-1); }
        }
        .animate-attack-player { animation: attackRight 0.2s ease-out; }

        @keyframes attackLeft {
            0% { transform: translateX(0); }
            50% { transform: translateX(-30px); }
            100% { transform: translateX(0); }
        }
        .animate-attack-enemy { animation: attackLeft 0.2s ease-out; }

        .animate-bounce-slow { animation: bounce 2s infinite; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 select-none">

<section id="titleScreen" class="view active flex-col items-center justify-center p-6 h-screen">
    <div class="mb-8 relative">
        <div class="absolute -top-10 -left-10 w-20 h-20 bg-yellow-300 rounded-full blur-xl opacity-50 animate-pulse"></div>
        <h1 class="text-5xl md:text-6xl font-black text-slate-800 tracking-tighter relative z-10">
            <span class="text-red-500">Quiz</span>Mon
        </h1>
        <div class="text-right text-xs font-bold text-slate-400 mt-1">Ver 2.2 Skill Select</div>
    </div>
    <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-sm text-center border-4 border-slate-800">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png" class="w-24 h-24 mx-auto pixel-art animate-bounce" alt="Pikachu">
        <p class="text-slate-500 text-sm mb-6 font-medium">
            ìˆ˜í•™ í€´ì¦ˆ ë°°í‹€ RPG<br>
            <span class="text-xs text-slate-400">(ì •ë‹µ ë²”ìœ„ 0~20)</span>
        </p>
        <button id="startButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg text-lg transition-colors border-b-4 border-red-700 active:border-b-0 active:translate-y-1">
            ëª¨í—˜ ì‹œì‘í•˜ê¸°
        </button>
    </div>
</section>

<section id="lobbyScreen" class="view flex-col items-center justify-start p-4 min-h-screen overflow-y-auto">
    <div class="w-full max-w-md flex flex-col gap-5 mt-4">
        <div class="flex justify-between items-end px-2">
            <h2 class="text-3xl font-black text-slate-800">LOBBY</h2>
            <div class="bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200 text-sm font-bold flex items-center gap-1">
                <span class="text-yellow-500">P</span>
                <span id="pointsTextLobby">0</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button id="lobbyCodexBtn" class="bg-white p-5 rounded-2xl shadow-sm border-2 border-slate-100 flex flex-col items-center gap-3 hover:border-emerald-400 transition-colors group">
                <div class="w-16 h-16 bg-emerald-50 rounded-full flex items-center justify-center group-hover:bg-emerald-100 transition-colors">
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="w-10 h-10 pixel-art opacity-80">
                </div>
                <div class="text-center">
                    <div class="font-bold text-lg text-slate-700">í¬ì¼“ëª¬ ë„ê°</div>
                    <div class="text-xs text-slate-400">íŒŒíŠ¸ë„ˆ ì„ íƒ & ëª¨í—˜</div>
                </div>
            </button>

            <button id="lobbyGachaBtn" class="bg-white p-5 rounded-2xl shadow-sm border-2 border-slate-100 flex flex-col items-center gap-3 hover:border-indigo-400 transition-colors group">
                <div class="w-16 h-16 bg-indigo-50 rounded-full flex items-center justify-center group-hover:bg-indigo-100 transition-colors">
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" class="w-10 h-10 pixel-art opacity-80">
                </div>
                <div class="text-center">
                    <div class="font-bold text-lg text-slate-700">ëª¬ìŠ¤í„° ë½‘ê¸°</div>
                    <div class="text-xs text-slate-400">ìƒˆë¡œìš´ ë™ë£Œ ì˜ì…</div>
                </div>
            </button>
        </div>

        <div class="bg-slate-800 rounded-2xl p-5 text-white shadow-lg relative overflow-hidden">
            <div class="relative z-10 flex justify-between items-center">
                <div>
                    <div class="text-xs text-slate-400 mb-1">í˜„ì¬ íŒŒíŠ¸ë„ˆ</div>
                    <div id="lobbyPartnerName" class="font-bold text-xl">íŒŒíŠ¸ë„ˆ ì—†ìŒ</div>
                    <div id="lobbyPartnerStat" class="text-xs text-slate-400 mt-1">ë„ê°ì—ì„œ ì„ íƒí•˜ì„¸ìš”</div>
                    <div class="w-32 h-1.5 bg-slate-600 rounded-full mt-2 overflow-hidden">
                        <div id="lobbyExpBar" class="h-full bg-sky-400 w-0 transition-all"></div>
                    </div>
                </div>
                <img id="lobbyPartnerImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="w-16 h-16 pixel-art bg-slate-700 rounded-full">
            </div>
            <div class="absolute -right-4 -bottom-4 w-24 h-24 bg-white opacity-5 rounded-full"></div>
        </div>
    </div>
</section>

<section id="codexScreen" class="view flex-col items-center h-screen bg-slate-50">
    <div class="w-full max-w-3xl flex flex-col h-full">
        <div class="flex-none p-4 bg-white border-b border-slate-200 flex items-center justify-between shadow-sm z-10">
            <div>
                <h2 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    ë„ê°
                    <span class="text-xs font-normal text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full" id="collectionRate">0/300</span>
                </h2>
            </div>
            <div class="flex items-center gap-2">
                <span class="text-xs font-bold text-sky-600 bg-sky-50 px-2 py-1 rounded">
                  <span id="pointsTextCodex">0</span> P
                </span>
                <button id="codexToLobbyBtn" class="text-xs font-bold px-3 py-2 rounded-lg bg-slate-100 text-slate-600 hover:bg-slate-200">
                    ë‚˜ê°€ê¸°
                </button>
            </div>
        </div>

        <div class="flex-none p-4 bg-white border-t border-slate-200 order-last">
            <div class="flex items-center gap-3">
                <div class="flex-1">
                    <div class="text-xs text-slate-400">ì„ íƒëœ íŒŒíŠ¸ë„ˆ</div>
                    <div id="partnerInfo" class="font-bold text-slate-800 text-sm truncate">ì—†ìŒ</div>
                </div>
                <button id="startAdventureBtn" disabled class="bg-emerald-500 hover:bg-emerald-600 disabled:bg-slate-300 disabled:text-slate-500 text-white font-bold py-3 px-6 rounded-xl shadow-md transition-all text-sm w-32">
                    ëª¨í—˜ ì‹œì‘
                </button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
            <div id="codexGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 pb-4">
            </div>
        </div>
    </div>
</section>

<section id="battleScreen" class="view flex-col items-center justify-between h-screen bg-gradient-to-b from-sky-200 to-sky-100 relative overflow-hidden">
    <div class="absolute bottom-0 w-full h-1/3 bg-emerald-600 rounded-t-[50%] scale-150 translate-y-12 border-t-8 border-emerald-700 opacity-90"></div>

    <div class="w-full max-w-md p-4 flex justify-between items-start z-10">
        <button id="battleBackBtn" class="bg-white/80 backdrop-blur text-slate-700 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm">
            &larr; ë„ì£¼
        </button>
        <div class="bg-black/40 backdrop-blur text-white px-4 py-1.5 rounded-full text-xs font-bold">
            STAGE <span id="battleStageText" class="text-yellow-300 text-base ml-1">1</span>
        </div>
    </div>

    <div class="w-full max-w-md flex-1 relative flex flex-col justify-center px-4 z-10 gap-8">
        <div class="flex flex-col items-end relative">
            <div class="bg-white/90 p-2 rounded-xl shadow-md mb-2 w-40 transform translate-x-2">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="enemyName" class="font-bold text-sm text-slate-800">ì•¼ìƒëª¬</span>
                    <span id="enemyLevel" class="text-[10px] text-slate-500">Lv.1</span>
                </div>
                <div id="enemyTypeBadge" class="text-[9px] text-white px-1.5 py-0.5 rounded mb-1 inline-block bg-gray-400">TYPE</div>
                <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div id="enemyHpBar" class="h-full bg-red-500 transition-all duration-500" style="width: 100%"></div>
                </div>
            </div>
            <img id="enemyImg" src="" class="w-32 h-32 pixel-art animate-bounce-slow drop-shadow-xl filter grayscale-0">
        </div>

        <div class="flex flex-col items-start relative mt-4">
            <img id="playerImg" src="" class="w-40 h-40 pixel-art drop-shadow-2xl scale-x-[-1]">
            <div class="bg-white/90 p-3 rounded-xl shadow-md w-44 -mt-4 z-20 transform -translate-x-2 border-l-4 border-emerald-500">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="playerName" class="font-bold text-sm text-slate-800">ë‚˜ì˜ëª¬</span>
                    <span id="playerLevel" class="text-[10px] text-slate-500">Lv.1</span>
                </div>
                <div class="flex justify-between text-[10px] text-slate-500 mb-0.5">
                    <span>HP</span>
                    <span id="playerHpText">0/0</span>
                </div>
                <div class="w-full h-2.5 bg-slate-200 rounded-full overflow-hidden">
                    <div id="playerHpBar" class="h-full bg-emerald-500 transition-all duration-500" style="width: 100%"></div>
                </div>
                <div class="w-full h-1 bg-slate-100 rounded-full mt-1 overflow-hidden">
                    <div id="playerExpBar" class="h-full bg-sky-400 transition-all" style="width: 0%"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="w-full max-w-md bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-5 z-20">
        <div id="battleLog" class="text-xs text-slate-500 mb-3 h-6 overflow-y-hidden text-center italic">
            ì „íˆ¬ê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.
        </div>
        <div id="moveButtons" class="grid grid-cols-2 gap-3"></div>
    </div>
</section>

<div id="quizModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
        <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
            <h3 class="font-bold text-lg">ğŸ“ ìˆ˜í•™ í€´ì¦ˆ</h3>
            <span class="text-xs bg-slate-700 px-2 py-1 rounded text-yellow-300">ì •ë‹µ ì‹œ ê³µê²©</span>
        </div>
        <div class="p-6">
            <div class="text-center mb-6">
                <p class="text-3xl font-black text-slate-800 tracking-wider" id="quizQuestion">?</p>
            </div>
            <div id="quizChoices" class="grid grid-cols-2 gap-3"></div>
        </div>
        <div class="bg-slate-50 p-3 text-center border-t">
            <button id="quizCancel" class="text-xs text-slate-400 hover:text-slate-600 underline">í¬ê¸°í•˜ê¸°</button>
        </div>
    </div>
</div>

<div id="rewardModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
        <h3 class="text-2xl font-black text-slate-800 mb-2">VICTORY!</h3>
        <div class="text-xs text-sky-600 font-bold mb-4 bg-sky-50 inline-block px-3 py-1 rounded-full">
            EXP <span id="rewardXpVal">0</span> íšë“!
        </div>
        <p class="text-sm text-slate-500 mb-2" id="rewardTitle">ì „íˆ¬ ìŠ¹ë¦¬ ë³´ìƒì„ ì„ íƒí•˜ì„¸ìš”.</p>
        <div class="grid grid-cols-1 gap-3" id="rewardButtons"></div>
    </div>
</div>

<div id="gachaModal" class="fixed inset-0 bg-slate-900 z-50 hidden flex-col items-center justify-center">
    <div class="w-full max-w-lg p-6 flex flex-col h-full md:h-auto">
        <div class="flex justify-between items-center mb-6 text-white">
            <div><h3 class="text-2xl font-bold">ëª¬ìŠ¤í„° ì†Œí™˜</h3><p class="text-sm opacity-70" id="gachaPointDisplay">í¬ì¸íŠ¸: 0P</p></div>
            <button id="gachaClose" class="bg-white/20 hover:bg-white/30 rounded-full p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>
        <div id="gachaScene" class="flex-1 bg-slate-800 rounded-2xl border border-slate-700 p-4 overflow-y-auto mb-4 min-h-[300px] flex items-center justify-center relative">
            <div id="gachaPlaceholder" class="text-center text-slate-500">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" class="w-24 h-24 mx-auto mb-4 opacity-20 grayscale"><p>ë²„íŠ¼ì„ ëˆŒëŸ¬ ì†Œí™˜í•˜ì„¸ìš”</p>
            </div>
            <div id="gachaResultsGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-3 w-full hidden"></div>
        </div>
        <div class="flex gap-3">
            <button id="gacha1Btn" class="flex-1 bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl shadow-lg border-b-4 border-indigo-800 active:border-b-0 active:translate-y-1">100P ì†Œí™˜</button>
            <button id="gacha10Btn" class="flex-1 bg-purple-600 hover:bg-purple-500 text-white font-bold py-4 rounded-xl shadow-lg border-b-4 border-purple-800 active:border-b-0 active:translate-y-1">1000P 10íšŒ</button>
        </div>
    </div>
</div>

<div id="messageModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[60] p-6">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-xs p-5 text-center">
        <h3 id="messageTitle" class="text-lg font-bold text-slate-800 mb-2">ì•Œë¦¼</h3>
        <p id="messageBody" class="text-sm text-slate-600 mb-4 break-keep"></p>
        <button id="messageOk" class="w-full py-2.5 rounded-lg bg-slate-800 text-white text-sm font-bold">í™•ì¸</button>
    </div>
</div>

<script>
    /* =========================================
     * DATA: Pokemon & Moves
     * ========================================= */
    const POKE_NAMES_STR = "ì´ìƒí•´ì”¨,ì´ìƒí•´í’€,ì´ìƒí•´ê½ƒ,íŒŒì´ë¦¬,ë¦¬ìë“œ,ë¦¬ìëª½,ê¼¬ë¶€ê¸°,ì–´ë‹ˆë¶€ê¸°,ê±°ë¶ì™•,ìºí„°í”¼,ë‹¨ë°ê¸°,ë²„í„°í”Œ,ë¿”ì¶©ì´,ë”±ì¶©ì´,ë…ì¹¨ë¶•,êµ¬êµ¬,í”¼ì£¤,í”¼ì£¤íˆ¬,ê¼¬ë ›,ë ˆíŠ¸ë¼,ê¹¨ë¹„ì°¸,ê¹¨ë¹„ë“œë¦´ì¡°,ì•„ë³´,ì•„ë³´í¬,í”¼ì¹´ì¸„,ë¼ì´ì¸„,ëª¨ë˜ë‘ì§€,ê³ ì§€,ë‹ˆë“œëŸ°â™€,ë‹ˆë“œë¦¬ë‚˜,ë‹ˆë“œí€¸,ë‹ˆë“œëŸ°â™‚,ë‹ˆë“œë¦¬ë…¸,ë‹ˆë“œí‚¹,ì‚ì‚,í”½ì‹œ,ì‹ìŠ¤í…Œì¼,ë‚˜ì¸í…Œì¼,í‘¸ë¦°,í‘¸í¬ë¦°,ì£¼ë±ƒ,ê³¨ë±ƒ,ëšœë²…ìµ¸,ëƒ„ìƒˆê¼¬,ë¼í”Œë ˆì‹œì•„,íŒŒë¼ìŠ¤,íŒŒë¼ì„¹íŠ¸,ì½˜íŒ¡,ë„ë‚˜ë¦¬,ë””ê·¸ë‹¤,ë‹¥íŠ¸ë¦¬ì˜¤,ë‚˜ì˜¹,í˜ë¥´ì‹œì˜¨,ê³ ë¼íŒŒë•,ê³¨ë•,ë§í‚¤,ì„±ì›ìˆ­,ê°€ë””,ìœˆë””,ë°œì±™ì´,ìŠˆë¥™ì±™ì´,ê°•ì±™ì´,ìºì´ì‹œ,ìœ¤ê²”ë¼,í›„ë”˜,ì•Œí†µëª¬,ê·¼ìœ¡ëª¬,ê´´ë ¥ëª¬,ëª¨ë‹¤í”¼,ìš°ì¸ ë™,ìš°ì¸ ë³´íŠ¸,ì™•ëˆˆí•´,ë…íŒŒë¦¬,ê¼¬ë§ˆëŒ,ë°êµ¬ë¦¬,ë”±êµ¬ë¦¬,í¬ë‹ˆíƒ€,ë‚ ìŒ©ë§ˆ,ì•¼ëˆ,ì•¼ë„ë€,ì½”ì¼,ë ˆì–´ì½”ì¼,íŒŒì˜¤ë¦¬,ë‘ë‘,ë‘íŠ¸ë¦¬ì˜¤,ì¥¬ì¥¬,ì¥¬ë ˆê³¤,ì§ˆí½ì´,ì§ˆë»ê¸°,ì…€ëŸ¬,íŒŒë¥´ì…€,ê³ ì˜¤ìŠ¤,ê³ ìš°ìŠ¤íŠ¸,íŒ¬í…€,ë¡±ìŠ¤í†¤,ìŠ¬ë¦¬í”„,ìŠ¬ë¦¬í¼,í¬ë©,í‚¹í¬ë©,ì°Œë¦¬ë¦¬ê³µ,ë¶ë³¼,ì•„ë¼ë¦¬,ë‚˜ì‹œ,íƒ•êµ¬ë¦¬,í……êµ¬ë¦¬,ì‹œë¼ì†Œëª¬,í™ìˆ˜ëª¬,ë‚´ë£¨ë¯¸,ë˜ê°€ìŠ¤,ë˜ë„ê°€ìŠ¤,ë¿”ì¹´ë…¸,ì½”ë¿Œë¦¬,ëŸ­í‚¤,ë©ì¿ ë¦¬,ìº¥ì¹´,ì˜ë“œë¼,ì‹œë“œë¼,ì½˜ì¹˜,ì™•ì½˜ì¹˜,ë³„ê°€ì‚¬ë¦¬,ì•„ì¿ ìŠ¤íƒ€,ë§ˆì„ë§¨,ìŠ¤í„±,ë£¨ì£¼ë¼,ì—ë ˆë¸Œ,ë§ˆê·¸ë§ˆ,ì˜ì‚¬ì´ì €,ì¼„íƒ€ë¡œìŠ¤,ì‰ì–´í‚¹,ê°¸ë¼ë„ìŠ¤,ë¼í”„ë¼ìŠ¤,ë©”íƒ€ëª½,ì´ë¸Œì´,ìƒ¤ë¯¸ë“œ,ì¥¬í”¼ì¬ë”,ë¶€ìŠ¤í„°,í´ë¦¬ê³¤,ì•”ë‚˜ì´íŠ¸,ì•”ìŠ¤íƒ€,íˆ¬êµ¬,íˆ¬êµ¬í‘¸ìŠ¤,í”„í…Œë¼,ì ë§Œë³´,í”„ë¦¬ì ¸,ì¬ë”,íŒŒì´ì–´,ë¯¸ë‡½,ì‹ ë‡½,ë§ë‚˜ë‡½,ë®¤ì¸ ,ë®¤";
    const POKE_NAMES = POKE_NAMES_STR.split(",");

    const TYPE_DATA = {
        "í’€": { color: "bg-green-500", weak: ["ë¶ˆê½ƒ", "ë…", "ì–¼ìŒ", "ë¹„í–‰", "ë²Œë ˆ"], resist: ["ë¬¼", "ì „ê¸°", "í’€", "ë•…"] },
        "ë¶ˆê½ƒ": { color: "bg-red-500", weak: ["ë¬¼", "ë•…", "ë°”ìœ„"], resist: ["ë¶ˆê½ƒ", "í’€", "ì–¼ìŒ", "ë²Œë ˆ", "ê°•ì² ", "í˜ì–´ë¦¬"] },
        "ë¬¼": { color: "bg-blue-500", weak: ["ì „ê¸°", "í’€"], resist: ["ë¶ˆê½ƒ", "ë¬¼", "ì–¼ìŒ", "ê°•ì² "] },
        "ì „ê¸°": { color: "bg-yellow-400", weak: ["ë•…"], resist: ["ì „ê¸°", "ë¹„í–‰", "ê°•ì² "] },
        "ë…¸ë§": { color: "bg-stone-400", weak: ["ê²©íˆ¬"], resist: [] },
        "ì—ìŠ¤í¼": { color: "bg-pink-400", weak: ["ë²Œë ˆ", "ê³ ìŠ¤íŠ¸", "ì•…"], resist: ["ê²©íˆ¬", "ì—ìŠ¤í¼"] },
        "ê²©íˆ¬": { color: "bg-orange-600", weak: ["ë¹„í–‰", "ì—ìŠ¤í¼", "í˜ì–´ë¦¬"], resist: ["ë²Œë ˆ", "ë°”ìœ„", "ì•…"] },
        "ë…": { color: "bg-purple-500", weak: ["ë•…", "ì—ìŠ¤í¼"], resist: ["í’€", "ê²©íˆ¬", "ë…", "ë²Œë ˆ", "í˜ì–´ë¦¬"] },
    };
    const TYPE_KEYS = Object.keys(TYPE_DATA);

    const MOVE_POOL = {
        "í’€": [
            {n:"ë©êµ´ì±„ì°", p:45, a:100, t:1}, {n:"ìë‚ ê°€ë¥´ê¸°", p:55, a:95, t:1}, {n:"í¡ìˆ˜", p:20, a:100, t:1},
            {n:"ì”¨í­íƒ„", p:80, a:100, t:2}, {n:"ì—ë„ˆì§€ë³¼", p:90, a:100, t:2}, {n:"ê¸°ê°€ë“œë ˆì¸", p:75, a:100, t:2},
            {n:"ì†”ë¼ë¹”", p:120, a:100, t:3}, {n:"ë¦¬í”„ìŠ¤í†°", p:130, a:90, t:3}
        ],
        "ë¶ˆê½ƒ": [
            {n:"ë¶ˆê½ƒì„¸ë¡€", p:40, a:100, t:1}, {n:"íšŒì˜¤ë¦¬ë¶ˆê½ƒ", p:35, a:85, t:1}, {n:"ë‹ˆíŠ¸ë¡œì°¨ì§€", p:50, a:100, t:1},
            {n:"ë¶ˆê½ƒí€ì¹˜", p:75, a:100, t:2}, {n:"í™”ì—¼ë°©ì‚¬", p:90, a:100, t:2}, {n:"ì—´í’", p:95, a:90, t:2},
            {n:"ë¶ˆëŒ€ë¬¸ì", p:110, a:85, t:3}, {n:"ì˜¤ë²„íˆíŠ¸", p:130, a:90, t:3}
        ],
        "ë¬¼": [
            {n:"ë¬¼ëŒ€í¬", p:40, a:100, t:1}, {n:"ê±°í’ˆê´‘ì„ ", p:65, a:100, t:1}, {n:"ë¬¼ì˜íŒŒë™", p:60, a:100, t:1},
            {n:"ì•„ì¿ ì•„í…Œì¼", p:90, a:90, t:2}, {n:"íŒŒë„íƒ€ê¸°", p:90, a:100, t:2}, {n:"ì—´íƒ•", p:80, a:100, t:2},
            {n:"í•˜ì´ë“œë¡œíŒí”„", p:110, a:80, t:3}, {n:"í•˜ì´ë“œë¡œìºë…¼", p:150, a:90, t:3}
        ],
        "ì „ê¸°": [
            {n:"ì „ê¸°ì‡¼í¬", p:40, a:100, t:1}, {n:"ì „ê´‘ì„í™”", p:40, a:100, t:1}, {n:"ìŠ¤íŒŒí¬", p:65, a:100, t:1},
            {n:"10ë§Œë³¼íŠ¸", p:90, a:100, t:2}, {n:"ë²ˆê°œí€ì¹˜", p:75, a:100, t:2}, {n:"ë°©ì „", p:80, a:100, t:2},
            {n:"ë²ˆê°œ", p:110, a:70, t:3}, {n:"ì „ìí¬", p:120, a:50, t:3}
        ],
        "ë…¸ë§": [
            {n:"ëª¸í†µë°•ì¹˜ê¸°", p:40, a:100, t:1}, {n:"í• í€´ê¸°", p:40, a:100, t:1}, {n:"ë§‰ì¹˜ê¸°", p:40, a:100, t:1},
            {n:"ë² ì–´ê°€ë¥´ê¸°", p:70, a:100, t:2}, {n:"ëˆ„ë¥´ê¸°", p:85, a:100, t:2}, {n:"ì€í˜œê°šê¸°", p:102, a:100, t:2},
            {n:"íŒŒê´´ê´‘ì„ ", p:150, a:90, t:3}, {n:"ê¸°ê°€ì„íŒ©íŠ¸", p:150, a:90, t:3}
        ],
        "ì—ìŠ¤í¼": [
            {n:"ì—¼ë™ë ¥", p:50, a:100, t:1}, {n:"í™˜ìƒë¹”", p:65, a:100, t:1}, {n:"í•˜íŠ¸ìŠ¤íƒ¬í”„", p:60, a:100, t:1},
            {n:"ì‚¬ì´ì½”í‚¤ë„¤ì‹œìŠ¤", p:90, a:100, t:2}, {n:"ì‚¬ë…ì˜ë°•ì¹˜ê¸°", p:80, a:90, t:2}, {n:"ì‚¬ì´ì½”ì‡¼í¬", p:80, a:100, t:2},
            {n:"ë¯¸ë˜ì˜ˆì§€", p:120, a:100, t:3}, {n:"ê¿ˆë¨¹ê¸°", p:100, a:100, t:3}
        ],
        "ê²©íˆ¬": [
            {n:"ì•ˆë‹¤ë¦¬ê±¸ê¸°", p:60, a:100, t:1}, {n:"ë°”ìœ„ê¹¨ê¸°", p:40, a:100, t:1}, {n:"ë°œê²½", p:60, a:100, t:1},
            {n:"ì§€ì˜¥ì˜ë°”í€´", p:80, a:80, t:2}, {n:"ê¹¨íŠ¸ë¦¬ê¸°", p:75, a:100, t:2}, {n:"í­ë°œí€ì¹˜", p:100, a:50, t:2},
            {n:"ì¸íŒŒì´íŠ¸", p:120, a:100, t:3}, {n:"ê¸°í•©êµ¬ìŠ¬", p:120, a:70, t:3}
        ],
        "ë…": [
            {n:"ë…ì¹¨", p:15, a:100, t:1}, {n:"ìš©í•´ì•¡", p:40, a:100, t:1}, {n:"ìŠ¤ëª¨ê·¸", p:30, a:70, t:1},
            {n:"ë…ì°Œë¥´ê¸°", p:80, a:100, t:2}, {n:"ì˜¤ë¬¼í­íƒ„", p:90, a:100, t:2}, {n:"í¬ë¡œìŠ¤í¬ì´ì¦Œ", p:70, a:100, t:2},
            {n:"ë”ìŠ¤íŠ¸ìŠˆíŠ¸", p:120, a:80, t:3}, {n:"ì˜¤ë¬¼ì›¨ì´ë¸Œ", p:95, a:100, t:3}
        ]
    };

    const LEGENDARY_IDS = [144,145,146,150,151];

    function getPokeInfo(id) {
        if (id > 151 && id <= 300) id = (id % 151) + 1;
        const name = POKE_NAMES[id - 1] || `No.${id}`;
        let rarity = "C";
        if (LEGENDARY_IDS.includes(id)) rarity = "SR";
        else if (id % 10 === 0 || [3,6,9,130,131,143,149].includes(id)) rarity = "R";

        let typeIdx = 4; // ê¸°ë³¸ ë…¸ë§
        if ([1,2,3,43,44,45,69,70,71,102,103,114].includes(id)) typeIdx = 0; // í’€
        else if ([4,5,6,37,38,58,59,77,78,126,136,146].includes(id)) typeIdx = 1; // ë¶ˆê½ƒ
        else if ([7,8,9,54,55,60,61,62,86,87,90,91,98,99,116,117,118,119,120,121,129,130,131,134].includes(id)) typeIdx = 2; // ë¬¼
        else if ([25,26,81,82,100,101,125,135,145].includes(id)) typeIdx = 3; // ì „ê¸°
        else if ([63,64,65,96,97,122,124,150,151].includes(id)) typeIdx = 5; // ì—ìŠ¤í¼
        else if ([56,57,66,67,68,106,107].includes(id)) typeIdx = 6; // ê²©íˆ¬
        else if ([13,14,15,23,24,29,30,31,32,33,34,41,42,88,89,109,110].includes(id)) typeIdx = 7; // ë…

        const typeName = TYPE_KEYS[typeIdx];
        return {
            id, name, rarity,
            type: { name: typeName, ...TYPE_DATA[typeName] },
            sprite: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`
        };
    }

    function getRandomMoves(typeName, maxTier = 3) {
        const pool = MOVE_POOL[typeName] || MOVE_POOL["ë…¸ë§"];
        const filtered = pool.filter(m => m.t <= maxTier);
        if (filtered.length < 2) return filtered.concat(filtered);
        const moves = [];
        const idx1 = Math.floor(Math.random() * filtered.length);
        let idx2 = Math.floor(Math.random() * filtered.length);
        while(idx1 === idx2 && filtered.length > 1) idx2 = Math.floor(Math.random() * filtered.length);
        return [filtered[idx1], filtered[idx2]];
    }

    /* =========================================
     * SYSTEM CONSTANTS & STATE
     * ========================================= */
    const GACHA_COST = 100;
    const LS_KEY = { POINTS: "qz_points_v2", OWNED: "qz_owned_v2", PARTNER: "qz_partner_v2", MON_DB: "qz_mon_db_v2" };

    const views = {
        title: document.getElementById("titleScreen"),
        lobby: document.getElementById("lobbyScreen"),
        codex: document.getElementById("codexScreen"),
        battle: document.getElementById("battleScreen"),
    };

    function getPoints() { return parseInt(localStorage.getItem(LS_KEY.POINTS) || "500", 10); }
    function setPoints(n) { localStorage.setItem(LS_KEY.POINTS, Math.max(0, n)); updatePointsUI(); }
    function addPoints(n) { setPoints(getPoints() + n); }

    function getOwned() { try { return new Set(JSON.parse(localStorage.getItem(LS_KEY.OWNED) || "[]")); } catch { return new Set(); } }
    function saveOwned(set) { localStorage.setItem(LS_KEY.OWNED, JSON.stringify([...set])); }

    function getPartnerId() { return parseInt(localStorage.getItem(LS_KEY.PARTNER) || "0"); }
    function setPartnerId(id) { localStorage.setItem(LS_KEY.PARTNER, id); updateLobbyPartner(); }

    function getMonDb() { try { return JSON.parse(localStorage.getItem(LS_KEY.MON_DB) || "{}"); } catch { return {}; } }
    function saveMonDb(db) { localStorage.setItem(LS_KEY.MON_DB, JSON.stringify(db)); }

    function getMonStatus(id) {
        const db = getMonDb();
        if (!db[id]) {
            const info = getPokeInfo(id);
            let baseStat = 20;
            if (info.rarity === 'R') baseStat = 30;
            if (info.rarity === 'SR') baseStat = 50;

            db[id] = {
                id,
                level: 1,
                xp: 0,
                maxHp: baseStat * 4,
                hp: baseStat * 4,
                atk: baseStat,
                moves: getRandomMoves(info.type.name, 1)
            };
            saveMonDb(db);
        }
        return db[id];
    }

    function getMaxXp(level) { return level * 100; }

    function updatePointsUI() {
        const p = getPoints();
        document.getElementById("pointsTextLobby").textContent = p.toLocaleString();
        document.getElementById("pointsTextCodex").textContent = p.toLocaleString();
        document.getElementById("gachaPointDisplay").textContent = `ë³´ìœ  í¬ì¸íŠ¸: ${p.toLocaleString()}P`;
    }

    function updateLobbyPartner() {
        const pid = getPartnerId();
        const nameEl = document.getElementById("lobbyPartnerName");
        const statEl = document.getElementById("lobbyPartnerStat");
        const imgEl = document.getElementById("lobbyPartnerImg");
        const barEl = document.getElementById("lobbyExpBar");

        if (pid > 0) {
            const info = getPokeInfo(pid);
            const stat = getMonStatus(pid);
            nameEl.textContent = info.name;
            statEl.textContent = `Lv.${stat.level} / HP ${Math.ceil(stat.hp)}/${stat.maxHp}`;
            imgEl.src = info.sprite;
            const xpP = Math.min(100, (stat.xp / getMaxXp(stat.level)) * 100);
            barEl.style.width = `${xpP}%`;
        } else {
            nameEl.textContent = "íŒŒíŠ¸ë„ˆ ì—†ìŒ";
            statEl.textContent = "ë„ê°ì—ì„œ ì„ íƒí•˜ì„¸ìš”";
            imgEl.src = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";
            barEl.style.width = "0%";
        }
    }

    function showView(name) {
        Object.values(views).forEach(v => v.classList.remove("active"));
        views[name].classList.add("active");
        if(name === 'lobby') updateLobbyPartner();
    }

    function renderCodex() {
        const grid = document.getElementById("codexGrid");
        grid.innerHTML = "";
        const owned = getOwned();
        const pid = getPartnerId();
        let ownedCount = 0;

        for (let i = 1; i <= 151; i++) {
            const info = getPokeInfo(i);
            const isOwned = owned.has(i);
            if(isOwned) ownedCount++;
            const isPartner = pid === i;
            const card = document.createElement("div");
            card.className = `poke-card relative rounded-xl p-2 flex flex-col items-center bg-white cursor-pointer select-none overflow-hidden`;
            card.classList.add(`rarity-${info.rarity}`);
            if (isPartner) card.classList.add("ring-2", "ring-emerald-500", "ring-offset-2");
            if (!isOwned) card.classList.add("opacity-60", "grayscale");
            card.innerHTML = `
        <div class="absolute top-1 left-1 text-[9px] font-bold text-slate-400">#${String(i).padStart(3,'0')}</div>
        <div class="absolute top-1 right-1 w-2 h-2 rounded-full ${info.type.color}"></div>
        <div class="mt-2 w-16 h-16 flex items-center justify-center">
          ${isOwned ? `<img src="${info.sprite}" loading="lazy" class="w-full h-full pixel-art object-contain">` : `<span class="text-2xl opacity-20">?</span>`}
        </div>
        <div class="text-[11px] font-bold text-slate-700 truncate w-full text-center mt-1">${isOwned ? info.name : "???"}</div>
        ${info.rarity !== 'C' && isOwned ? `<span class="absolute bottom-1 right-1 text-[8px] font-black ${info.rarity === 'SR' ? 'text-amber-500' : 'text-blue-500'}">${info.rarity}</span>` : ''}
      `;
            card.onclick = () => {
                if (!isOwned) { showAlert("ë¯¸ë³´ìœ ", "ê°€ì± ë¥¼ í†µí•´ ë¨¼ì € íšë“í•´ì•¼ í•©ë‹ˆë‹¤."); return; }
                setPartnerId(i); renderCodex();
            };
            grid.appendChild(card);
        }
        document.getElementById("collectionRate").textContent = `${ownedCount}/151`;
        if (pid > 0) {
            const pInfo = getPokeInfo(pid);
            document.getElementById("partnerInfo").textContent = `#${pid} ${pInfo.name}`;
            document.getElementById("startAdventureBtn").disabled = false;
        }
    }

    /* =========================================
     * MATH QUIZ LOGIC (0~20)
     * ========================================= */
    function generateMathQuestion() {
        const type = Math.floor(Math.random() * 4);
        let qStr = "", ans = 0;
        let safe = 0;
        while(safe < 100) {
            safe++;
            if (type === 0) { // +
                const a = Math.floor(Math.random() * 21);
                const b = Math.floor(Math.random() * (21 - a));
                ans = a + b; qStr = `${a} + ${b} = ?`;
            } else if (type === 1) { // -
                const a = Math.floor(Math.random() * 21);
                const b = Math.floor(Math.random() * (a + 1));
                ans = a - b; qStr = `${a} - ${b} = ?`;
            } else if (type === 2) { // â–¡
                const target = Math.floor(Math.random() * 21);
                const a = Math.floor(Math.random() * (target + 1));
                ans = target - a; qStr = `${a} + â–¡ = ${target}`;
            } else { // 3 nums
                const a = Math.floor(Math.random() * 10);
                const b = Math.floor(Math.random() * 10);
                if (a+b > 20) continue;
                const c = Math.floor(Math.random() * (21 - a - b));
                ans = a + b + c; qStr = `${a} + ${b} + ${c} = ?`;
            }
            break;
        }
        const choices = new Set([ans]);
        while (choices.size < 4) {
            const diff = Math.floor(Math.random() * 9) - 4;
            const fake = ans + diff;
            if (fake >= 0 && fake <= 25 && fake !== ans) choices.add(fake);
        }
        return { q: qStr, choices: Array.from(choices).sort(() => Math.random() - 0.5), ans: ans };
    }

    /* =========================================
     * BATTLE SYSTEM
     * ========================================= */
    let battleState = null;
    let quizCallback = null;

    function getEffectiveness(atkType, defType) {
        if (!TYPE_DATA[atkType]) return 1.0;
        const data = TYPE_DATA[defType];
        if (!data) return 1.0;
        if (data.weak.includes(atkType)) return 1.5;
        if (data.resist.includes(atkType)) return 0.8;
        return 1.0;
    }

    function initAdventure() {
        const pid = getPartnerId();
        if (!pid) return;
        const pStat = getMonStatus(pid);
        const pInfo = getPokeInfo(pid);

        if(pStat.hp <= 0) {
            showAlert("ì¶œì „ ë¶ˆê°€", "íŒŒíŠ¸ë„ˆì˜ ì²´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤. íšŒë³µì´ í•„ìš”í•©ë‹ˆë‹¤.");
            if (pStat.hp <= 0 && getPoints() < 100) {
                pStat.hp = pStat.maxHp;
                const db = getMonDb(); db[pid] = pStat; saveMonDb(db);
                showAlert("êµ¬ì¡°ëŒ€ ì§€ì›", "í¬ì¸íŠ¸ ë¶€ì¡±ìœ¼ë¡œ ë¬´ë£Œ ì¹˜ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            } else { return; }
        }

        battleState = { stage: 1, player: { ...pStat, name: pInfo.name, sprite: pInfo.sprite, type: pInfo.type.name }, turn: 0 };
        startBattleStage();
        showView("battle");
    }

    function startBattleStage() {
        const { stage, player } = battleState;
        let enemyId = Math.floor(Math.random() * 151) + 1;
        const eInfo = getPokeInfo(enemyId);

        const eLevel = stage + Math.floor(player.level * 0.5);
        const eMaxHp = (30 + eLevel * 5) * (eInfo.rarity === 'SR' ? 1.5 : 1);
        const eAtk = (5 + eLevel * 1.5);
        const eMoves = getRandomMoves(eInfo.type.name, 1);

        battleState.enemy = {
            id: enemyId, name: eInfo.name, sprite: eInfo.sprite, type: eInfo.type.name,
            maxHp: eMaxHp, hp: eMaxHp, atk: eAtk, level: eLevel,
            move: eMoves[0]
        };

        updateBattleUI();
        logBattle(`ì•¼ìƒì˜ ${eInfo.name} (Lv.${eLevel}) ë“±ì¥!`);
    }

    function updateBattleUI() {
        const { player, enemy } = battleState;
        document.getElementById("battleStageText").textContent = battleState.stage;

        document.getElementById("playerName").textContent = player.name;
        document.getElementById("playerLevel").textContent = `Lv.${player.level}`;
        document.getElementById("playerImg").src = player.sprite;
        document.getElementById("playerHpText").textContent = `${Math.ceil(player.hp)}/${player.maxHp}`;
        document.getElementById("playerHpBar").style.width = `${Math.max(0, (player.hp/player.maxHp)*100)}%`;
        const pXpMax = getMaxXp(player.level);
        document.getElementById("playerExpBar").style.width = `${Math.min(100, (player.xp/pXpMax)*100)}%`;

        document.getElementById("enemyName").textContent = enemy.name;
        document.getElementById("enemyLevel").textContent = `Lv.${enemy.level}`;
        document.getElementById("enemyImg").src = enemy.sprite;
        document.getElementById("enemyHpBar").style.width = `${Math.max(0, (enemy.hp/enemy.maxHp)*100)}%`;
        const eTypeInfo = TYPE_DATA[enemy.type];
        const typeBadge = document.getElementById("enemyTypeBadge");
        typeBadge.textContent = enemy.type;
        typeBadge.className = `text-[9px] text-white px-1.5 py-0.5 rounded mb-1 inline-block ${eTypeInfo.color}`;

        const btnArea = document.getElementById("moveButtons");
        btnArea.innerHTML = "";

        player.moves.forEach(m => {
            const btn = document.createElement("button");
            let tierColor = "border-slate-200 bg-white";
            if(m.t === 2) tierColor = "border-blue-200 bg-blue-50";
            if(m.t === 3) tierColor = "border-yellow-300 bg-yellow-50";

            btn.className = `${tierColor} hover:brightness-95 border-b-4 active:border-b-0 active:translate-y-1 text-slate-800 py-3 rounded-xl font-bold text-sm shadow-sm transition-all flex flex-col items-center justify-center gap-1`;
            btn.innerHTML = `<span>${m.n}</span><div class="flex gap-1 text-[10px] text-slate-500"><span class="bg-slate-100 px-1 rounded">ìœ„ë ¥ ${m.p}</span><span class="bg-slate-100 px-1 rounded ${m.a < 100 ? 'text-red-500':''}">ëª…ì¤‘ ${m.a}</span></div>`;
            btn.onclick = () => handlePlayerMove(m);
            btnArea.appendChild(btn);
        });
    }

    function logBattle(msg, type = "normal") {
        const log = document.getElementById("battleLog");
        log.textContent = msg;
        if (type === "critical") log.className = "text-xs text-red-500 font-bold mb-3 h-6 text-center animate-pulse";
        else if (type === "weak") log.className = "text-xs text-blue-500 font-bold mb-3 h-6 text-center";
        else log.className = "text-xs text-slate-500 mb-3 h-6 text-center italic";
    }

    function playAnim(elementId, animClass) {
        const el = document.getElementById(elementId);
        el.classList.remove(animClass);
        void el.offsetWidth;
        el.classList.add(animClass);
        setTimeout(() => el.classList.remove(animClass), 500);
    }

    function handlePlayerMove(move) {
        openQuiz((isCorrect) => {
            if (!isCorrect) {
                logBattle("ë¬¸ì œë¥¼ í‹€ë ¤ì„œ ê³µê²©ì´ ë¹—ë‚˜ê°”ë‹¤!");
                setTimeout(enemyTurn, 800);
                return;
            }
            playAnim("playerImg", "animate-attack-player");
            const roll = Math.random() * 100;
            const isHit = roll <= move.a;
            const accMult = isHit ? 2.0 : 0.5;
            const eff = getEffectiveness(battleState.player.type, battleState.enemy.type);
            let dmg = Math.floor((battleState.player.atk * move.p / 40) * eff * accMult);
            dmg = Math.floor(dmg * (0.9 + Math.random() * 0.2));

            setTimeout(() => {
                battleState.enemy.hp -= dmg;
                playAnim("enemyImg", "animate-damage");
                let logMsg = "", logType = "normal";
                if (isHit) {
                    if (eff > 1.0) { logMsg = `[ëª…ì¤‘! ê¸‰ì†Œ!] íš¨ê³¼ê°€ êµ‰ì¥í–ˆë‹¤! (${dmg})`; logType = "critical"; }
                    else logMsg = `[ëª…ì¤‘!] ê°•ë ¥í•œ ê³µê²©! (${dmg})`;
                } else {
                    logMsg = `ë¹—ë§ìŒ... ë°ë¯¸ì§€ê°€ ë°˜ê°ë¨ (${dmg})`; logType = "weak";
                }
                logBattle(logMsg, logType);
                updateBattleUI();
                if (battleState.enemy.hp <= 0) setTimeout(handleWin, 800);
                else setTimeout(enemyTurn, 1000);
            }, 250);
        });
    }

    function enemyTurn() {
        if (battleState.enemy.hp <= 0) return;
        const move = battleState.enemy.move;
        playAnim("enemyImg", "animate-attack-enemy");
        const eff = getEffectiveness(battleState.enemy.type, battleState.player.type);
        let dmg = Math.floor((battleState.enemy.atk * move.p / 50) * eff);

        if (Math.random() * 100 > move.a) { setTimeout(() => logBattle(`ì ì˜ ê³µê²©ì´ ë¹—ë‚˜ê°”ë‹¤!`), 300); return; }

        setTimeout(() => {
            playAnim("playerImg", "animate-damage");
            battleState.player.hp -= dmg;
            logBattle(`ì ì˜ ${move.n}! (${dmg} í”¼í•´)`);
            updateBattleUI();
            if (battleState.player.hp <= 0) setTimeout(handleDefeat, 800);
        }, 250);
    }

    function handleWin() {
        const gainedXp = 30 + (battleState.stage * 10);
        const gainedPoints = 30 + (battleState.stage * 5);

        battleState.player.xp += gainedXp;
        addPoints(gainedPoints);

        let levelUpMsg = "";
        const maxXp = getMaxXp(battleState.player.level);
        if (battleState.player.xp >= maxXp) {
            battleState.player.level++; battleState.player.xp -= maxXp;
            battleState.player.maxHp += 10; battleState.player.hp += 10; battleState.player.atk += 3;
            levelUpMsg = " & ë ˆë²¨ ì—…!";
        }
        const lostHp = battleState.player.maxHp - battleState.player.hp;
        if (lostHp > 0) battleState.player.hp += Math.floor(lostHp * 0.5);

        const db = getMonDb(); db[battleState.player.id] = { ...battleState.player }; saveMonDb(db);

        document.getElementById("rewardXpVal").textContent = `${gainedXp}${levelUpMsg}`;
        document.getElementById("rewardTitle").textContent = "ì „íˆ¬ ìŠ¹ë¦¬ ë³´ìƒì„ ì„ íƒí•˜ì„¸ìš”.";

        const modal = document.getElementById("rewardModal");
        const grid = document.getElementById("rewardButtons");
        grid.innerHTML = "";

        const choices = [
            { t: "ì¬í™” íšë“", d: "í¬ì¸íŠ¸ +100 P", f: () => { addPoints(100); nextStage(); } },
            {
                t: "ê¸°ìˆ  ë¨¸ì‹ ", d: "ìŠ¤í‚¬ 1ê°œë¥¼ ì„ íƒí•˜ì—¬ ê°•í™”/êµì²´",
                f: () => {
                    // ê¸°ìˆ  ì„ íƒ UIë¡œ ë³€ê²½
                    document.getElementById("rewardTitle").textContent = "êµì²´í•  ìŠ¤í‚¬ ìŠ¬ë¡¯ì„ ì„ íƒí•˜ì„¸ìš”.";
                    grid.innerHTML = "";
                    battleState.player.moves.forEach((m, idx) => {
                        const btn = document.createElement("button");
                        let tColor = "bg-white border-slate-200";
                        if(m.t === 2) tColor = "bg-blue-50 border-blue-200";
                        if(m.t === 3) tColor = "bg-yellow-50 border-yellow-300";

                        btn.className = `w-full py-4 ${tColor} border rounded-xl flex flex-col items-center justify-center gap-1 hover:brightness-95`;
                        btn.innerHTML = `<span class="font-bold text-slate-800">${m.n}</span><span class="text-xs text-slate-500">ìœ„ë ¥ ${m.p} / ëª…ì¤‘ ${m.a} (Tier ${m.t})</span><span class="text-[10px] text-red-500 font-bold mt-1">í´ë¦­ ì‹œ êµì²´</span>`;

                        btn.onclick = () => {
                            // ìƒˆ ìŠ¤í‚¬ ë½‘ê¸° (ì¤‘ë³µ ë°©ì§€)
                            const otherMove = battleState.player.moves[idx === 0 ? 1 : 0];
                            let candidates, newMove;
                            do {
                                candidates = getRandomMoves(battleState.player.type, 3);
                                newMove = candidates[0];
                            } while(newMove.n === otherMove.n || newMove.n === m.n); // ê¸°ì¡´ê³¼ ë™ì¼í•˜ê±°ë‚˜ ì˜† ìŠ¬ë¡¯ê³¼ ë™ì¼í•˜ë©´ ë‹¤ì‹œ

                            battleState.player.moves[idx] = newMove;
                            const db = getMonDb(); db[battleState.player.id] = battleState.player; saveMonDb(db);
                            showAlert("ê¸°ìˆ  ìŠµë“!", `[${newMove.n}] ê¸°ìˆ ì„ ë°°ì› ìŠµë‹ˆë‹¤!`, nextStage);
                        };
                        grid.appendChild(btn);
                    });
                }
            },
            { t: "ì™„ì „ íšŒë³µ", d: "HP 100% íšŒë³µ", f: () => {
                    battleState.player.hp = battleState.player.maxHp;
                    const db = getMonDb(); db[battleState.player.id] = battleState.player; saveMonDb(db);
                    nextStage();
                }
            }
        ];

        choices.forEach(c => {
            const btn = document.createElement("button");
            btn.className = "w-full py-4 bg-slate-100 hover:bg-indigo-50 border border-slate-200 hover:border-indigo-200 rounded-xl flex flex-col items-center justify-center gap-1 transition-colors";
            btn.innerHTML = `<span class="font-bold text-slate-800 text-lg">${c.t}</span><span class="text-xs text-slate-500">${c.d}</span>`;
            btn.onclick = () => { if(c.t !== "ê¸°ìˆ  ë¨¸ì‹ ") modal.classList.add("hidden"); c.f(); };
            grid.appendChild(btn);
        });

        modal.classList.remove("hidden");
    }

    function nextStage() { battleState.stage++; startBattleStage(); }
    function handleDefeat() {
        battleState.player.hp = 1;
        const db = getMonDb(); db[battleState.player.id] = battleState.player; saveMonDb(db);
        showAlert("ì „íˆ¬ íŒ¨ë°°", "ëˆˆì•ì´ ê¹œê¹œí•´ì¡Œë‹¤... (ì²´ë ¥ 1ë¡œ ê·€í™˜)", () => showView("lobby"));
    }

    function openQuiz(cb) {
        quizCallback = cb;
        const qModal = document.getElementById("quizModal");
        const qText = document.getElementById("quizQuestion");
        const qGrid = document.getElementById("quizChoices");
        const qData = generateMathQuestion();
        qText.textContent = qData.q; qGrid.innerHTML = "";
        qData.choices.forEach(val => {
            const btn = document.createElement("button");
            btn.className = "bg-slate-100 hover:bg-sky-100 border-2 border-slate-200 hover:border-sky-300 text-slate-800 font-bold py-4 rounded-xl text-lg transition-colors";
            btn.textContent = val;
            btn.onclick = () => { qModal.classList.add("hidden"); if (quizCallback) quizCallback(val === qData.ans); };
            qGrid.appendChild(btn);
        });
        qModal.classList.remove("hidden");
    }

    document.getElementById("quizCancel").onclick = () => { document.getElementById("quizModal").classList.add("hidden"); if(quizCallback) quizCallback(false); };

    function playGacha(count) {
        const cost = count * GACHA_COST;
        if (getPoints() < cost) { showAlert("í¬ì¸íŠ¸ ë¶€ì¡±", "í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
        setPoints(getPoints() - cost);
        document.getElementById("gachaPlaceholder").classList.add("hidden");
        const resGrid = document.getElementById("gachaResultsGrid");
        resGrid.classList.remove("hidden"); resGrid.innerHTML = "";
        const owned = getOwned();
        for(let k=0; k<count; k++) {
            let pickId = Math.floor(Math.random() * 151) + 1;
            const pInfo = getPokeInfo(pickId);
            const isNew = !owned.has(pickId); owned.add(pickId);
            const div = document.createElement("div");
            div.className = "flex flex-col items-center p-2 bg-slate-700 rounded-xl animate-[bounce_0.5s]";
            div.innerHTML = `<div class="w-14 h-14 bg-slate-600 rounded-full flex items-center justify-center mb-2 relative"><img src="${pInfo.sprite}" class="w-10 h-10 pixel-art">${isNew ? '<span class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] px-1 rounded-sm font-bold">NEW</span>' : ''}</div><div class="text-[9px] text-white font-bold truncate w-full text-center">${pInfo.name}</div>`;
            resGrid.appendChild(div);
        }
        saveOwned(owned); updatePointsUI();
    }

    function showAlert(title, body, onOk) {
        document.getElementById("messageTitle").textContent = title;
        document.getElementById("messageBody").textContent = body;
        const modal = document.getElementById("messageModal");
        modal.classList.remove("hidden");
        document.getElementById("messageOk").onclick = () => { modal.classList.add("hidden"); if(onOk) onOk(); };
    }

    window.onload = () => {
        if (!localStorage.getItem(LS_KEY.POINTS)) setPoints(500);
        updatePointsUI(); updateLobbyPartner();
        document.getElementById("startButton").onclick = () => showView("lobby");
        document.getElementById("lobbyCodexBtn").onclick = () => { renderCodex(); showView("codex"); };
        document.getElementById("lobbyGachaBtn").onclick = () => { document.getElementById("gachaModal").classList.remove("hidden"); };
        document.getElementById("codexToLobbyBtn").onclick = () => showView("lobby");
        document.getElementById("startAdventureBtn").onclick = initAdventure;
        document.getElementById("battleBackBtn").onclick = () => { if(confirm("ì „íˆ¬ë¥¼ í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) showView("lobby"); };
        document.getElementById("gachaClose").onclick = () => document.getElementById("gachaModal").classList.add("hidden");
        document.getElementById("gacha1Btn").onclick = () => playGacha(1);
        document.getElementById("gacha10Btn").onclick = () => playGacha(10);
    };
</script>
</body>
</html>