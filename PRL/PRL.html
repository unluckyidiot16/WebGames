<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>QuizMon: Ver 8.2 (ì§„í™” ìˆ˜ì •)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; touch-action: manipulation; }
        .view { display: none; }
        .view.active { display: flex; }
        .poke-card { transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .poke-card:active { transform: scale(0.95); }

        /* ë“±ê¸‰ë³„ ìŠ¤íƒ€ì¼ */
        .rarity-UR  { border: 2px solid #ef4444; background: linear-gradient(135deg, #fff0f0 0%, #ffe4e4 100%); box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
        .rarity-SSR { border: 2px solid #f97316; background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); }
        .rarity-SR  { border: 2px solid #eab308; background: #fefce8; }
        .rarity-R   { border: 2px solid #3b82f6; background: #eff6ff; }
        .rarity-C   { border: 1px solid #cbd5e1; background: #ffffff; }

        .modal-backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        img.pixel-art { image-rendering: pixelated; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes damageShake { 0% { transform: translateX(0); } 20% { transform: translateX(-6px) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } 40% { transform: translateX(6px) rotate(5deg); } 60% { transform: translateX(-3px); } 80% { transform: translateX(3px); } }
        .animate-damage { animation: damageShake 0.4s ease-in-out; }
        .animate-attack-player { animation: attackRight 0.2s ease-out; }
        .animate-attack-enemy { animation: attackLeft 0.2s ease-out; }
        @keyframes attackRight { 0% { transform: translateX(0) scaleX(-1); } 50% { transform: translateX(30px) scaleX(-1); } 100% { transform: translateX(0) scaleX(-1); } }
        @keyframes attackLeft { 0% { transform: translateX(0); } 50% { transform: translateX(-30px); } 100% { transform: translateX(0); } }

        .btn-cooldown { background-color: #f1f5f9 !important; border-color: #cbd5e1 !important; color: #94a3b8 !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .skill-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }

        /* ì§„í™” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes evolveGlow {
            0% { filter: brightness(1); transform: scale(1); }
            50% { filter: brightness(3) saturate(0); transform: scale(1.3); }
            100% { filter: brightness(1); transform: scale(1); }
        }
        .animate-evolve { animation: evolveGlow 1.5s ease-in-out; }


        /* âœ… GachaModal ë¹„í™œì„±í™”: íƒí—˜ì€ index_patchedë¡œ ì´ë™ */
        #gachaModal { display: none !important; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 select-none">

<section id="titleScreen" class="view active flex-col items-center justify-center p-6 h-screen">
    <div class="mb-8 relative">
        <div class="absolute -top-10 -left-10 w-20 h-20 bg-purple-500 rounded-full blur-xl opacity-30 animate-pulse"></div>
        <h1 class="text-5xl md:text-6xl font-black text-slate-800 tracking-tighter relative z-10">
            <span class="text-red-500">Quiz</span>Mon
        </h1>
        <div class="text-right text-xs font-bold text-slate-400 mt-1">Ver 8.2 (ì—°ì† ì§„í™” + UI ì—…ë°ì´íŠ¸)</div>
    </div>
    <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-sm text-center border-4 border-slate-800">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/250.png" class="w-24 h-24 mx-auto pixel-art animate-bounce" alt="Ho-oh">
        <p class="text-slate-500 text-sm mb-6 font-medium">
            poke_db.json ì—°ë™ + ì§„í™” ì‹œìŠ¤í…œ!<br>ê¸°ë³¸ í¬ì¼“ëª¬ë§Œ ë½‘ê¸° ê°€ëŠ¥
        </p>
        <div id="loadingStatus" class="text-xs text-blue-500 mb-2">ë°ì´í„° ë¡œë”© ì¤‘...</div>
        <button id="startButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg text-lg transition-colors border-b-4 border-red-700 active:border-b-0 active:translate-y-1 disabled:bg-slate-400 disabled:border-slate-500" disabled>
            ëª¨í—˜ ì‹œì‘í•˜ê¸°
        </button>
    </div>
</section>

<section id="lobbyScreen" class="view flex-col items-center justify-start p-4 min-h-screen overflow-y-auto">
    <div class="w-full max-w-md flex flex-col gap-4 mt-2">
        <div class="flex justify-between items-end px-2">
            <h2 class="text-3xl font-black text-slate-800">LOBBY</h2>
            <div class="flex gap-2">
                <div class="bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200 text-xs font-bold flex items-center gap-1">
                    <span class="text-yellow-500">ğŸ«</span><span id="ticketTextLobby">0</span>
                </div>
                <div class="bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200 text-xs font-bold flex items-center gap-1">
                    <span class="text-blue-500">P</span><span id="pointsTextLobby">0</span>
                </div>
            </div>
        </div>

        <button onclick="importFromClipboard()" class="w-full bg-slate-800 text-white py-2 rounded-xl text-xs font-bold shadow-md hover:bg-slate-700 active:scale-95 transition-transform mb-2">
            ğŸ“¥ index ë°ì´í„°(í´ë¦½ë³´ë“œ) ê°€ì ¸ì˜¤ê¸°
        </button>

        <div class="grid grid-cols-2 gap-3">
            <button id="lobbyCodexBtn" class="bg-white p-4 rounded-2xl shadow-sm border-2 border-slate-100 flex flex-col items-center gap-2 hover:border-emerald-400 transition-colors group">
                <div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center group-hover:bg-emerald-100">
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="w-8 h-8 pixel-art opacity-80">
                </div>
                <div class="text-center">
                    <div class="font-bold text-slate-700">ìŠ¤íƒ€í„° ì„ íƒ</div>
                    <div class="text-[10px] text-slate-400">ëª¨í—˜ ì¤€ë¹„</div>
                </div>
            </button>

            <button id="lobbyGachaBtn" class="bg-white p-4 rounded-2xl shadow-sm border-2 border-slate-100 flex flex-col items-center gap-2 hover:border-indigo-400 transition-colors group">
                <div class="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center group-hover:bg-indigo-100">
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/town-map.png" class="w-8 h-8 pixel-art opacity-80">
                </div>
                <div class="text-center">
                    <div class="font-bold text-slate-700">íƒí—˜ìœ¼ë¡œ ì´ë™</div>
                    <div class="text-[10px] text-slate-400">í¬íš/íƒí—˜ í™”ë©´</div>
                </div>
            </button>

            <button id="lobbyHofBtn" class="bg-white p-3 rounded-2xl shadow-sm border-2 border-slate-100 flex items-center justify-center gap-3 hover:border-yellow-400 transition-colors group">
                <div class="w-10 h-10 bg-yellow-50 rounded-full flex items-center justify-center group-hover:bg-yellow-100">
                    <span class="text-xl">ğŸ†</span>
                </div>
                <div class="text-left">
                    <div class="font-bold text-slate-700">ëª…ì˜ˆì˜ ì „ë‹¹</div>
                    <div class="text-[10px] text-slate-400">ì—­ëŒ€ ìµœê³  ê¸°ë¡ ë³´ê¸°</div>
                </div>
            </button>

            <!-- ğŸ‘» ê³ ìŠ¤íŠ¸ ë°°í‹€ ë²„íŠ¼ ì¶”ê°€ -->
            <button id="lobbyGhostBtn" class="bg-white p-3 rounded-2xl shadow-sm border-2 border-slate-100 flex items-center justify-center gap-3 hover:border-purple-400 transition-colors group">
                <div class="w-10 h-10 bg-purple-50 rounded-full flex items-center justify-center group-hover:bg-purple-100">
                    <span class="text-xl">ğŸ‘»</span>
                </div>
                <div class="text-left">
                    <div class="font-bold text-slate-700">ì¹œêµ¬ì™€ ë°°í‹€</div>
                    <div class="text-[10px] text-slate-400">QR ê³µìœ  / ìŠ¤ìº” ëŒ€ê²°</div>
                </div>
            </button>
        </div>


        <div class="bg-slate-800 rounded-2xl p-5 text-white shadow-lg relative overflow-hidden mt-2">
            <div class="relative z-10 flex justify-between items-center">
                <div>
                    <div class="text-xs text-slate-400 mb-1">ì„ íƒëœ ìŠ¤íƒ€í„°</div>
                    <div id="lobbyPartnerName" class="font-bold text-xl">ì—†ìŒ</div>
                    <div class="text-[10px] text-slate-400 mt-1 bg-slate-700 inline-block px-2 py-1 rounded" id="lobbyStartBonus">
                        ì„ íƒ í•„ìš”
                    </div>
                </div>
                <img id="lobbyPartnerImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="w-16 h-16 pixel-art bg-slate-700 rounded-full">
            </div>
        </div>
    </div>
</section>

<section id="codexScreen" class="view flex-col items-center h-[100dvh] bg-slate-50 relative overflow-hidden">
    <div class="w-full max-w-3xl flex flex-col h-full">
        <div class="flex-none p-4 bg-white border-b border-slate-200 flex items-center justify-between shadow-sm z-10">
            <h2 class="text-xl font-bold text-slate-800">ë„ê° <span class="text-xs font-normal text-slate-400" id="collectionRate">0/--</span></h2>
            <div class="flex items-center gap-2">
                <button id="codexPrevBtn" class="text-xs font-bold px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 disabled:opacity-50">â—€</button>
                <span id="codexPageInfo" class="text-xs text-slate-500">1/11</span>
                <button id="codexNextBtn" class="text-xs font-bold px-2 py-1 rounded bg-slate-200 hover:bg-slate-300 disabled:opacity-50">â–¶</button>
                <button id="codexToLobbyBtn" class="text-xs font-bold px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200 ml-2">ë‚˜ê°€ê¸°</button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 bg-slate-50 pb-32"> <div id="codexGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3"></div>
        </div>

        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur-md border-t border-slate-200 flex gap-3 items-center z-30 pb-[env(safe-area-inset-bottom,1rem)]">
            <div class="max-w-3xl mx-auto w-full flex gap-3 items-center">
                <div class="flex-1">
                    <div class="text-[10px] text-slate-400 uppercase tracking-wider">Selected Partner</div>
                    <div id="partnerInfo" class="font-bold text-slate-800 text-base truncate">ì—†ìŒ</div>
                </div>
                <button id="startAdventureBtn" disabled class="bg-emerald-500 hover:bg-emerald-600 disabled:bg-slate-300 text-white font-black py-4 px-8 rounded-2xl shadow-lg transition-all active:scale-95">
                    ëª¨í—˜ ì‹œì‘
                </button>
            </div>
        </div>
    </div>
</section>

<section id="battleScreen" class="view flex-col items-center justify-between h-screen bg-gradient-to-b from-sky-200 to-sky-100 relative overflow-hidden">
    <div class="absolute bottom-0 w-full h-1/3 bg-emerald-600 rounded-t-[50%] scale-150 translate-y-12 border-t-8 border-emerald-700 opacity-90"></div>
    <div class="w-full max-w-md p-4 flex justify-between items-start z-10">
        <button id="battleBackBtn" class="bg-white/80 backdrop-blur text-slate-700 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm">&larr; í¬ê¸°</button>
        <div class="bg-black/40 backdrop-blur text-white px-4 py-1.5 rounded-full text-xs font-bold">STAGE <span id="battleStageText" class="text-yellow-300 text-base ml-1">1</span></div>
    </div>
    <div class="w-full max-w-md flex-1 relative flex flex-col justify-center px-4 z-10 gap-8">
        <div class="flex flex-col items-end relative">
            <div class="bg-white/90 p-2 rounded-xl shadow-md mb-2 w-40 transform translate-x-2">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="enemyName" class="font-bold text-sm text-slate-800">?</span>
                    <span id="enemyLevel" class="text-[10px] text-slate-500">Lv.1</span>
                </div>
                <div id="enemyTypeBadge" class="text-[9px] text-white px-1.5 py-0.5 rounded mb-1 inline-block bg-gray-400">TYPE</div>
                <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden"><div id="enemyHpBar" class="h-full bg-red-500 transition-all duration-500" style="width: 100%"></div></div>
            </div>
            <img id="enemyImg" src="" class="w-32 h-32 pixel-art animate-bounce-slow drop-shadow-xl filter grayscale-0">
        </div>
        <div class="flex flex-col items-start relative mt-4">
            <img id="playerImg" src="" class="w-40 h-40 pixel-art drop-shadow-2xl scale-x-[-1]">
            <div class="bg-white/90 p-3 rounded-xl shadow-md w-44 -mt-4 z-20 transform -translate-x-2 border-l-4 border-emerald-500">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="playerName" class="font-bold text-sm text-slate-800">?</span>
                    <span id="playerLevel" class="text-[10px] text-slate-500">Lv.1</span>
                </div>
                <div class="flex justify-between text-[10px] text-slate-500 mb-0.5"><span>HP</span><span id="playerHpText">0/0</span></div>
                <div class="w-full h-2.5 bg-slate-200 rounded-full overflow-hidden"><div id="playerHpBar" class="h-full bg-emerald-500 transition-all duration-500" style="width: 100%"></div></div>
                <div class="w-full h-1 bg-slate-100 rounded-full mt-1 overflow-hidden"><div id="playerExpBar" class="h-full bg-sky-400 transition-all" style="width: 0%"></div></div>
            </div>
        </div>
    </div>
    <div class="w-full max-w-md bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-5 z-20">
        <div id="battleLog" class="text-xs text-slate-500 mb-3 h-6 overflow-y-hidden text-center italic">ì „íˆ¬ ì‹œì‘!</div>
        <div id="moveButtons" class="skill-grid"></div>
    </div>
</section>

<div id="hofModal" class="fixed inset-0 bg-slate-900 z-50 hidden flex-col items-center justify-center"><div class="w-full max-w-md bg-white p-6 rounded-2xl shadow-2xl m-4 max-h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-black text-slate-800">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3><button id="hofClose" class="text-slate-400 font-bold">ë‹«ê¸°</button></div><div id="hofList" class="flex-1 overflow-y-auto space-y-3"></div></div></div>

<div id="gachaModal" class="fixed inset-0 bg-slate-900 z-50 hidden flex-col items-center justify-center">
    <div class="w-full max-w-lg p-6 flex flex-col h-full md:h-auto">
        <div class="flex justify-between items-center mb-6 text-white">
            <div><h3 class="text-2xl font-bold">ëª¬ìŠ¤í„° ì†Œí™˜</h3><p class="text-xs opacity-70" id="gachaResDisplay"></p></div>
            <button id="gachaClose" class="bg-white/20 rounded-full p-2">âœ•</button>
        </div>
        <div class="bg-yellow-500/20 text-yellow-200 text-xs p-2 rounded-lg mb-2 text-center">
            âœ¨ ê¸°ë³¸í˜• í¬ì¼“ëª¬ë§Œ ë“±ì¥! ë ˆë²¨ì—…ìœ¼ë¡œ ì§„í™”í•´ìš”!
        </div>
        <div id="gachaScene" class="flex-1 bg-slate-800 rounded-2xl border border-slate-700 p-4 overflow-y-auto mb-4 min-h-[300px] flex items-center justify-center relative">
            <div id="gachaPlaceholder" class="text-center text-slate-500">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" class="w-24 h-24 mx-auto mb-4 opacity-20 grayscale">
                <p>ì†Œí™˜ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”</p>
            </div>
            <div id="gachaResultsGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-3 w-full hidden"></div>
        </div>
        <div class="grid grid-cols-3 gap-2 mb-2">
            <button id="gacha1Btn" class="bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 text-xs">
                <span class="block opacity-80">100 P</span>1íšŒ ì†Œí™˜
            </button>
            <button id="gacha10Btn" class="bg-purple-600 hover:bg-purple-500 text-white py-3 rounded-xl shadow-lg border-b-4 border-purple-800 active:border-b-0 active:translate-y-1 text-xs">
                <span class="block opacity-80">900 P</span>10íšŒ ì†Œí™˜
            </button>
            <button id="gachaSpecialBtn" class="bg-yellow-500 hover:bg-yellow-400 text-white py-3 rounded-xl shadow-lg border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1 text-xs relative overflow-hidden">
                <div class="absolute inset-0 bg-white opacity-10 animate-pulse"></div>
                <span class="block opacity-80 font-bold text-yellow-900">ğŸ« í‹°ì¼“ 1</span>ì „ì„¤ ì†Œí™˜
            </button>
        </div>
        <p class="text-center text-[10px] text-slate-400">* ì¤‘ë³µ íšë“ ì‹œ ì‹œì‘ ê²½í—˜ì¹˜(ì ì¬ë ¥)ê°€ ìƒìŠ¹í•©ë‹ˆë‹¤.</p>
    </div>
</div>

<!-- ì§„í™” ëª¨ë‹¬ -->
<div id="evolveModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[60] p-6">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-xs p-5 text-center">
        <h3 class="text-lg font-bold text-slate-800 mb-2">ğŸ‰ ì§„í™”!</h3>
        <div class="flex items-center justify-center gap-4 my-4">
            <div class="text-center">
                <img id="evolveFromImg" class="w-16 h-16 pixel-art mx-auto" src="">
                <div id="evolveFromName" class="text-xs mt-1"></div>
            </div>
            <div class="text-2xl">â†’</div>
            <div class="text-center">
                <img id="evolveToImg" class="w-20 h-20 pixel-art mx-auto animate-evolve" src="">
                <div id="evolveToName" class="text-sm font-bold mt-1"></div>
            </div>
        </div>
        <p id="evolveMessage" class="text-sm text-slate-600 mb-4"></p>
        <button id="evolveOkBtn" class="w-full py-2.5 rounded-lg bg-slate-800 text-white text-sm font-bold">í™•ì¸</button>
    </div>
</div>

<!-- ğŸ‘» ê³ ìŠ¤íŠ¸ ë°°í‹€ ëª¨ë‹¬ -->
<div id="ghostModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[55] p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90vh] flex flex-col overflow-hidden">
        <div class="flex justify-between items-center px-4 py-3 border-b border-slate-200">
            <h3 class="text-lg font-bold text-slate-800">ğŸ‘» ê³ ìŠ¤íŠ¸ ë°°í‹€</h3>
            <button id="ghostClose" class="text-slate-400 text-xs font-bold">ë‹«ê¸°</button>
        </div>

        <!-- íƒ­ ë²„íŠ¼ -->
        <div class="flex gap-2 px-4 pt-3">
            <button
                    id="ghostTabMyBtn"
                    class="flex-1 text-xs font-bold rounded-full px-3 py-2 bg-slate-800 text-white"
            >
                ë‚´ QR ê³µìœ 
            </button>
            <button
                    id="ghostTabScanBtn"
                    class="flex-1 text-xs font-bold rounded-full px-3 py-2 bg-slate-100 text-slate-500"
            >
                ìŠ¤ìº”í•´ì„œ ë„ì „
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 text-slate-800 text-sm">
            <!-- ë‚´ QR íƒ­ -->
            <div id="ghostMyPane">
                <p id="ghostMySummary" class="text-[11px] text-slate-500 mb-3 break-keep">
                    í˜„ì¬ ìŠ¤íƒ€í„° ì •ë³´ë¥¼ QR ì½”ë“œë¡œ ë§Œë“¤ì–´ì„œ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ìŠ¤ìº”í•˜ë©´,
                    ë‚´ í¬ì¼“ëª¬ê³¼ ê³ ìŠ¤íŠ¸ ë°°í‹€ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
                <div class="bg-slate-50 rounded-2xl border border-slate-200 flex flex-col items-center justify-center py-4">
                    <canvas id="ghostQrCanvas" class="bg-white rounded-xl p-2"></canvas>
                    <p class="mt-2 text-[10px] text-slate-400 text-center leading-relaxed">
                        ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì´ QRì„ ì¹´ë©”ë¼ë¡œ ë¹„ì¶”ë©´<br />
                        ë‚´ í¬ì¼“ëª¬ê³¼ì˜ ê³ ìŠ¤íŠ¸ ë°°í‹€ì´ ì‹œì‘ë©ë‹ˆë‹¤.
                    </p>
                </div>
            </div>

            <!-- ìŠ¤ìº” íƒ­ -->
            <div id="ghostScanPane" class="hidden">
                <p class="text-[11px] text-slate-500 mb-2 break-keep">
                    ì¹´ë©”ë¼ ì‚¬ìš©ì„ í—ˆìš©í•œ ë’¤, ì¹œêµ¬ì˜ í°ì— ë„ì›Œì§„ ê³ ìŠ¤íŠ¸ QRì„ ë¹„ì¶° ë³´ì„¸ìš”.
                </p>
                <div class="bg-black rounded-2xl overflow-hidden mb-2">
                    <video id="ghostVideo" class="w-full h-48 object-cover bg-black"></video>
                </div>
                <p id="ghostScanStatus" class="text-[11px] text-slate-500 mb-3">
                    ëŒ€ê¸° ì¤‘...
                </p>
                <button
                        id="ghostScanStartBtn"
                        class="w-full py-2.5 rounded-xl bg-slate-800 text-white text-xs font-bold"
                >
                    ìŠ¤ìº” ì‹œì‘
                </button>
                <button
                        id="ghostScanStopBtn"
                        class="w-full py-2 mt-2 rounded-xl bg-slate-100 text-slate-600 text-xs font-bold"
                >
                    ìŠ¤ìº” ì¢…ë£Œ
                </button>
                <!-- ë¹„í‘œì‹œìš© ìº”ë²„ìŠ¤ (í”„ë ˆì„ ìº¡ì³ìš©) -->
                <canvas id="ghostScanCanvas" class="hidden"></canvas>
            </div>
        </div>
    </div>
</div>

<div id="quizModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden"><div class="bg-slate-800 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg">ğŸ“ í€´ì¦ˆ</h3><span class="text-xs bg-slate-700 px-2 py-1 rounded text-yellow-300">ì •ë‹µ ì‹œ ê³µê²©</span></div><div class="p-6"><div class="text-center mb-2"><p class="text-sm text-slate-500 mb-2" id="quizExplain"></p><p class="text-2xl font-black text-slate-800 tracking-wider" id="quizQuestion">?</p></div><div id="quizChoices" class="grid grid-cols-2 gap-3"></div></div><div class="bg-slate-50 p-3 text-center border-t"><button id="quizCancel" class="text-xs text-slate-400 underline">í¬ê¸°í•˜ê¸°</button></div></div></div>
<div id="rewardModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center"><h3 class="text-2xl font-black text-slate-800 mb-2">VICTORY!</h3><div class="text-xs text-sky-600 font-bold mb-4 bg-sky-50 inline-block px-3 py-1 rounded-full">EXP <span id="rewardXpVal">0</span> íšë“!</div><div id="bonusLootLine" class="text-[11px] font-black text-emerald-600 mb-3 hidden"></div><p class="text-sm text-slate-500 mb-2" id="rewardTitle">ë³´ìƒì„ ì„ íƒí•˜ì„¸ìš”</p><div class="grid grid-cols-1 gap-3" id="rewardButtons"></div></div></div>
<div id="messageModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[60] p-6"><div class="bg-white rounded-xl shadow-xl w-full max-w-xs p-5 text-center"><h3 id="messageTitle" class="text-lg font-bold text-slate-800 mb-2">ì•Œë¦¼</h3><p id="messageBody" class="text-sm text-slate-600 mb-4 break-keep"></p><button id="messageOk" class="w-full py-2.5 rounded-lg bg-slate-800 text-white text-sm font-bold">í™•ì¸</button></div></div>

<script>
    const INDEX_PATCHED_URL = "../PS/index_patched.html"; // í•„ìš” ì‹œ ê²½ë¡œë§Œ ìˆ˜ì •
    const GACHA_ENABLED = false; // PRLì—ì„œëŠ” ì†Œí™˜(ê°€ì± ) UI/ë¡œì§ ìˆ¨ê¹€

    /* =========================================
     * DATA & CONSTANTS - poke_db.jsonì—ì„œ ë¡œë“œ
     * ========================================= */
    let POKE_DB = null;         // poke_db.json ì „ì²´ ë°ì´í„°
    let POKE_NAMES = [];        // ì´ë¦„ ë°°ì—´
    let ALL_STATS_DB = [];      // ìŠ¤íƒ¯ ë°°ì—´ [hp, atk, def, spa, spd, spe]
    let EVOLUTION_MAP = {};     // id -> { next_id, min_level }
    let BASIC_POKEMON_IDS = []; // is_basic: trueì¸ í¬ì¼“ëª¬ ID ëª©ë¡

    // í€´ì¦ˆ ë°ì´í„°
    let externalQuizList = [];

    const BASE_DEX_MAX = 1025;  // ì „ì²´ í¬ì¼“ëª¬ ì§€ì›

    // ì „ì„¤ í¬ì¼“ëª¬ (Gen1~9)
    const LEGENDARY_IDS = [
        // Gen1
        144, 145, 146, 150,
        // Gen2
        243, 244, 245, 249, 250,
        // Gen3
        377, 378, 379, 380, 381, 382, 383, 384, 386,
        // Gen4
        480, 481, 482, 483, 484, 485, 486, 487, 488,
        // Gen5
        638, 639, 640, 641, 642, 643, 644, 645, 646,
        // Gen6
        716, 717, 718,
        // Gen7
        785, 786, 787, 788, 791, 792, 800,
        // Gen8
        888, 889, 890, 891, 892, 894, 895, 896, 897, 898,
        // Gen9
        1001, 1002, 1003, 1004, 1007, 1008, 1014, 1015, 1016, 1017, 1020, 1021, 1022, 1023, 1024
    ];

    // í™˜ìƒ í¬ì¼“ëª¬ (Mythical)
    const MYTHICAL_IDS = [
        151,  // ë®¤
        251,  // ì„¸ë ˆë¹„
        385,  // ì§€ë¼ì¹˜
        489, 490,  // í•„ë¡œë„¤/ë§ˆë‚˜í”¼
        491, 492, 493,  // ë‹¤í¬ë¼ì´/ì…°ì´ë¯¸/ì•„ë¥´ì„¸ìš°ìŠ¤
        494,  // ë¹„í¬í‹°ë‹ˆ
        647, 648, 649,  // ì¼€ë¥´ë””ì˜¤/ë©”ë¡œì—£íƒ€/ê²Œë…¸ì„¸í¬íŠ¸
        719, 720, 721,  // ë””ì•ˆì‹œ/í›„íŒŒ/ë³¼ì¼€ë‹ˆì˜¨
        801, 802, 807, 808, 809,  // ë§ˆê¸°ì•„ë‚˜/ë§ˆìƒ¤ë„/ì œë¼ì˜¤ë¼/ë©œíƒ„/ë©œë©”íƒˆ
        893,  // ìë£¨ë„
        1025  // ë³µìˆ­ì•…ë™
    ];

    const TIER_CONFIG = {
        "C":   { targetBst: 300, bonus: 0 },
        "R":   { targetBst: 380, bonus: 5 },
        "SR":  { targetBst: 480, bonus: 10 },
        "SSR": { targetBst: 550, bonus: 15 },
        "UR":  { targetBst: 650, bonus: 25 }
    };

    // ì¸ê¸°/ê·€ì—¬ìš´ í¬ì¼“ëª¬ (ìƒ¤ì´ë‹ˆ UR ë²„ì „)
    const CUTE_IDS = [
        25, 133, 175, 39, 35, 37, 151, 172, 194, 216, 147, 183, 152, 155, 158, 251,
        // ì¶”ê°€ ì¸ê¸° í¬ì¼“ëª¬
        393, 403, 417, 427, 447, 471, 495, 501, 531, 572, 587, 613, 677, 702, 722, 728,
        778, 813, 819, 835, 868, 872, 906, 912, 924
    ];

    // UR ìƒ¤ì´ë‹ˆ ë³€í˜•ì€ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (1025ê°œ ì „ì²´ ì§€ì›)
    const UR_VARIANT_BASE_IDS = [];

    let DEX_TOTAL = BASE_DEX_MAX;

    // íƒ€ì…ë³„ ë°ì´í„° ë° ìƒì„±
    const TYPE_DATA = {
        "ë…¸ë§":   { color: "bg-slate-400", weak: ["ê²©íˆ¬"], resist: [] },
        "ë¶ˆê½ƒ":   { color: "bg-red-500", weak: ["ë¬¼", "ë•…", "ë°”ìœ„"], resist: ["ë¶ˆê½ƒ", "í’€", "ì–¼ìŒ", "ë²Œë ˆ", "ê°•ì² "] },
        "ë¬¼":     { color: "bg-blue-500", weak: ["ì „ê¸°", "í’€"], resist: ["ë¶ˆê½ƒ", "ë¬¼", "ì–¼ìŒ", "ê°•ì² "] },
        "ì „ê¸°":   { color: "bg-yellow-400", weak: ["ë•…"], resist: ["ì „ê¸°", "ë¹„í–‰", "ê°•ì² "] },
        "í’€":     { color: "bg-green-500", weak: ["ë¶ˆê½ƒ", "ì–¼ìŒ", "ë…", "ë¹„í–‰", "ë²Œë ˆ"], resist: ["ë¬¼", "ì „ê¸°", "í’€", "ë•…"] },
        "ì–¼ìŒ":   { color: "bg-cyan-300", weak: ["ë¶ˆê½ƒ", "ê²©íˆ¬", "ë°”ìœ„", "ê°•ì² "], resist: ["ì–¼ìŒ"] },
        "ê²©íˆ¬":   { color: "bg-orange-600", weak: ["ë¹„í–‰", "ì—ìŠ¤í¼"], resist: ["ë²Œë ˆ", "ë°”ìœ„", "ì•…"] },
        "ë…":     { color: "bg-fuchsia-600", weak: ["ë•…", "ì—ìŠ¤í¼"], resist: ["í’€", "ê²©íˆ¬", "ë…", "ë²Œë ˆ"] },
        "ë•…":     { color: "bg-amber-700", weak: ["ë¬¼", "í’€", "ì–¼ìŒ"], resist: ["ë…", "ë°”ìœ„"] },
        "ë¹„í–‰":   { color: "bg-sky-400", weak: ["ì „ê¸°", "ì–¼ìŒ", "ë°”ìœ„"], resist: ["í’€", "ê²©íˆ¬", "ë²Œë ˆ"] },
        "ì—ìŠ¤í¼": { color: "bg-pink-500", weak: ["ë²Œë ˆ", "ê³ ìŠ¤íŠ¸", "ì•…"], resist: ["ê²©íˆ¬", "ì—ìŠ¤í¼"] },
        "ë²Œë ˆ":   { color: "bg-lime-600", weak: ["ë¶ˆê½ƒ", "ë¹„í–‰", "ë°”ìœ„"], resist: ["í’€", "ê²©íˆ¬", "ë•…"] },
        "ë°”ìœ„":   { color: "bg-stone-500", weak: ["ë¬¼", "í’€", "ê²©íˆ¬", "ë•…", "ê°•ì² "], resist: ["ë…¸ë§", "ë¶ˆê½ƒ", "ë…", "ë¹„í–‰"] },
        "ê³ ìŠ¤íŠ¸": { color: "bg-indigo-700", weak: ["ê³ ìŠ¤íŠ¸", "ì•…"], resist: ["ë…", "ë²Œë ˆ"] },
        "ê°•ì² ":   { color: "bg-slate-500", weak: ["ë¶ˆê½ƒ", "ê²©íˆ¬", "ë•…"], resist: ["ë…¸ë§", "í’€", "ì–¼ìŒ", "ë¹„í–‰", "ì—ìŠ¤í¼", "ë²Œë ˆ", "ë°”ìœ„", "ê³ ìŠ¤íŠ¸", "ë“œë˜ê³¤", "ê°•ì² "] },
        "ì•…":     { color: "bg-zinc-800", weak: ["ê²©íˆ¬", "ë²Œë ˆ"], resist: ["ê³ ìŠ¤íŠ¸", "ì•…", "ì—ìŠ¤í¼"] },
        "ë“œë˜ê³¤": { color: "bg-violet-600", weak: ["ì–¼ìŒ", "ë“œë˜ê³¤"], resist: ["ë¶ˆê½ƒ", "ë¬¼", "ì „ê¸°", "í’€"] },
        "í˜ì–´ë¦¬": { color: "bg-pink-300", weak: ["ë…", "ê°•ì² "], resist: ["ê²©íˆ¬", "ë²Œë ˆ", "ë“œë˜ê³¤", "ì•…"] },
    };

    const PHYSICAL_TYPES = ["ë…¸ë§", "ê²©íˆ¬", "ë…", "ë•…", "ë¹„í–‰", "ë²Œë ˆ", "ë°”ìœ„", "ê³ ìŠ¤íŠ¸", "ê°•ì² "];
    const SPECIAL_TYPES = ["ë¶ˆê½ƒ", "ë¬¼", "í’€", "ì „ê¸°", "ì—ìŠ¤í¼", "ì–¼ìŒ", "ë“œë˜ê³¤", "ì•…", "í˜ì–´ë¦¬"];

    const RAW_MOVES = {
        "ë…¸ë§": [ {n:"ëª¸í†µë°•ì¹˜ê¸°",p:40,a:100}, {n:"í• í€´ê¸°",p:40,a:100}, {n:"ë©”ê°€í†¤í€ì¹˜",p:80,a:85}, {n:"íŒŒê´´ê´‘ì„ ",p:150,a:90} ],
        "í’€":   [ {n:"ë©êµ´ì±„ì°",p:45,a:100}, {n:"ìë‚ ê°€ë¥´ê¸°",p:55,a:95}, {n:"ì”¨í­íƒ„",p:80,a:100}, {n:"ì—ë„ˆì§€ë³¼",p:90,a:100}, {n:"ì†”ë¼ë¹”",p:120,a:100}, {n:"ë¦¬í”„ìŠ¤í†°",p:130,a:90} ],
        "ë¶ˆê½ƒ": [ {n:"ë¶ˆê½ƒì„¸ë¡€",p:40,a:100}, {n:"ë¶ˆê½ƒí€ì¹˜",p:75,a:100}, {n:"í™”ì—¼ë°©ì‚¬",p:90,a:100}, {n:"ë¶ˆëŒ€ë¬¸ì",p:110,a:85}, {n:"ë¸”ë ˆì´ì¦ˆí‚¥",p:85,a:90}, {n:"í­ë ¬í™”ì—¼",p:150,a:90} ],
        "ë¬¼":   [ {n:"ë¬¼ì´",p:40,a:100}, {n:"ê±°í’ˆê´‘ì„ ",p:65,a:100}, {n:"íŒŒë„íƒ€ê¸°",p:90,a:100}, {n:"í•˜ì´ë“œë¡œíŒí”„",p:110,a:80}, {n:"ì•„ì¿ ì•„í…Œì¼",p:90,a:90}, {n:"í•˜ì´ë“œë¡œìºë…¼",p:150,a:90} ],
        "ì „ê¸°": [ {n:"ì „ê¸°ì‡¼í¬",p:40,a:100}, {n:"ìŠ¤íŒŒí¬",p:65,a:100}, {n:"ë²ˆê°œ",p:110,a:70}, {n:"10ë§Œë³¼íŠ¸",p:90,a:100}, {n:"ë³¼íŠ¸íƒœí´",p:120,a:100}, {n:"ë¼ì´íŠ¸ë‹",p:150,a:90} ],
        "ì–¼ìŒ": [ {n:"ëƒ‰ë™ë¹”",p:90,a:100}, {n:"ëˆˆë³´ë¼",p:110,a:70}, {n:"ì–¼ìŒë­‰ì¹˜",p:40,a:100}, {n:"ì–¼ìŒì—„ë‹ˆ",p:65,a:95}, {n:"ëƒ‰ë™í€ì¹˜",p:75,a:100} ],
        "ë•…":   [ {n:"ì§„í™ë¿Œë¦¬ê¸°",p:20,a:100}, {n:"ë•…ê³ ë¥´ê¸°",p:60,a:100}, {n:"ì§€ì§„",p:100,a:100}, {n:"ëŒ€ì§€ì˜í˜",p:90,a:100}, {n:"ë¼ˆë‹¤ê·€ë¶€ë©”ë‘",p:50,a:90} ],
        "ë¹„í–‰": [ {n:"ë‚ ê°œì¹˜ê¸°",p:60,a:100}, {n:"ê³µì¤‘ë‚ ê¸°",p:90,a:95}, {n:"ì—ì–´ìŠ¬ë˜ì‹œ",p:75,a:95}, {n:"ë“œë¦´ë¶€ë¦¬",p:80,a:100}, {n:"í­í’",p:110,a:70} ],
        "ë²Œë ˆ": [ {n:"ë²Œë ˆë¨¹ê¸°",p:60,a:100}, {n:"ì—°ì†ìë¥´ê¸°",p:40,a:95}, {n:"ë©”ê°€í˜¼",p:120,a:85}, {n:"ì‹œê·¸ë„ë¹”",p:75,a:100}, {n:"ë²Œë ˆì˜ì•¼ë‹¨ë²•ì„",p:90,a:100} ],
        "ë°”ìœ„": [ {n:"ë°”ìœ„ë˜ì§€ê¸°",p:50,a:90}, {n:"ì•”ì„ë´‰ì¸",p:60,a:95}, {n:"ìŠ¤í†¤ì—ì§€",p:100,a:80}, {n:"ë¡ë¸”ë˜ìŠ¤íŠ¸",p:25,a:90}, {n:"íŒŒì›Œì ¬",p:80,a:100} ],
        "ê³ ìŠ¤íŠ¸":[ {n:"ì„€ë„ë³¼",p:80,a:100}, {n:"ì„€ë„í€ì¹˜",p:60,a:100}, {n:"ë‚˜ì´íŠ¸í—¤ë“œ",p:70,a:100}, {n:"ì„€ë„í´ë¡œ",p:70,a:100}, {n:"ì„€ë„ë‹¤ì´ë¸Œ",p:120,a:90} ],
        "ê°•ì² ": [ {n:"ë©”íƒˆí´ë¡œ",p:50,a:95}, {n:"ì•„ì´ì–¸í—¤ë“œ",p:80,a:100}, {n:"ë¯¸ëŸ¬ìƒ·",p:65,a:85}, {n:"ì½”ë©§í€ì¹˜",p:90,a:90}, {n:"ì² ë²½íƒ€ê²©",p:90,a:95} ],
        "ì•…":   [ {n:"ê¹¨ë¬¼ì–´ë¶€ìˆ˜ê¸°",p:60,a:100}, {n:"í¬ëŸ°ì¹˜",p:80,a:100}, {n:"ì•…ì˜íŒŒë™",p:80,a:100}, {n:"ê¸°ìŠµ",p:40,a:100}, {n:"ì†ì„ìˆ˜",p:95,a:100} ],
        "ë“œë˜ê³¤":[ {n:"ìš©ì˜ìˆ¨ê²°",p:60,a:100}, {n:"ìš©ì˜íŒŒë™",p:85,a:100}, {n:"ë“œë˜ê³¤í´ë¡œ",p:80,a:100}, {n:"ì—­ë¦°",p:120,a:100}, {n:"ìš©ì„±êµ°",p:130,a:90} ],
        "ì—ìŠ¤í¼":[ {n:"ì—¼ë™ë ¥",p:50,a:100}, {n:"ì‚¬ì´ì½”í‚¤ë„¤ì‹œìŠ¤",p:90,a:100}, {n:"ì‚¬ì´ì½”ì‡¼í¬",p:80,a:100}, {n:"ë“œë¦¼ì´í„°",p:100,a:100}, {n:"ë¯¸ë˜ì˜ˆì§€",p:120,a:100} ],
        "ê²©íˆ¬": [ {n:"ë¡œí‚¥",p:50,a:100}, {n:"ì¹´ìš´í„°",p:60,a:100}, {n:"ìŠ¤ì¹´ì´ì—…í¼",p:85,a:90}, {n:"ì¸íŒŒì´íŠ¸",p:120,a:100}, {n:"í­ë°œí€ì¹˜",p:100,a:50} ],
        "ë…":   [ {n:"ë…ì¹¨",p:15,a:100}, {n:"ë…ê°€ìŠ¤",p:40,a:100}, {n:"ì˜¤ë¬¼í­íƒ„",p:90,a:100}, {n:"ë”ìŠ¤íŠ¸ìŠˆíŠ¸",p:120,a:80}, {n:"í¬ë¡œìŠ¤í¬ì´ì¦Œ",p:70,a:100} ],
        "í˜ì–´ë¦¬": [ {n:"ìš”ì •ì˜ë°”ëŒ",p:40,a:100}, {n:"ë“œë ˆì¸í‚¤ìŠ¤",p:50,a:100}, {n:"ë¬¸í¬ìŠ¤",p:95,a:100}, {n:"í”Œë ˆì´ëŸ¬í”„",p:90,a:90} ],
    };

    function calcMoveTier(m) {
        let t, c;
        if (m.p <= 60) { t="C"; c=0; }
        else if (m.p < 80) { t="R"; c=1; }
        else if (m.p < 110) { t="SR"; c=2; }
        else if (m.p < 140) { t="SSR"; c=3; }
        else { t="UR"; c=4; }
        return { ...m, t, c };
    }

    const MOVE_POOL = {};
    Object.keys(RAW_MOVES).forEach(k => { MOVE_POOL[k] = RAW_MOVES[k].map(m => calcMoveTier(m)); });

    /* =========================================
     * ë°ì´í„° ë¡œë”© í•¨ìˆ˜ë“¤
     * ========================================= */
    let DB_LOADED = false;  // DB ë¡œë“œ ì™„ë£Œ í”Œë˜ê·¸

    async function loadPokeDb() {
        try {
            const timestamp = new Date().getTime();
            // ìƒëŒ€ ê²½ë¡œë¡œ poke_db.json ë¡œë“œ ì‹œë„
            let res = await fetch(`./poke_db.json?v=${timestamp}`, {
                cache: "no-store",
                headers: { 'Pragma': 'no-cache', 'Cache-Control': 'no-cache' }
            });

            if (!res.ok) {
                // ì ˆëŒ€ ê²½ë¡œ ì‹œë„
                res = await fetch(`/quiz/poke_db.json?v=${timestamp}`, {
                    cache: "no-store"
                });
            }

            if (!res.ok) throw new Error("poke_db.json ë¡œë“œ ì‹¤íŒ¨");

            POKE_DB = await res.json();

            // ë°ì´í„° íŒŒì‹±
            POKE_NAMES = [];
            ALL_STATS_DB = [];
            EVOLUTION_MAP = {};
            BASIC_POKEMON_IDS = [];

            for (const poke of POKE_DB.pokemon) {
                const idx = poke.id - 1;
                POKE_NAMES[idx] = poke.name_ko;
                ALL_STATS_DB[idx] = [
                    poke.base_stats.hp,
                    poke.base_stats.atk,
                    poke.base_stats.def,
                    poke.base_stats.spa,
                    poke.base_stats.spd,
                    poke.base_stats.spe
                ];

                if (poke.evolution) {
                    EVOLUTION_MAP[poke.id] = {
                        next_id: poke.evolution.next_id,
                        min_level: poke.evolution.min_level
                    };
                }

                if (poke.is_basic && poke.id <= BASE_DEX_MAX) {
                    BASIC_POKEMON_IDS.push(poke.id);
                }
            }

            console.log(`[DB] ${POKE_DB.pokemon.length}ê°œ í¬ì¼“ëª¬ ë¡œë“œ ì™„ë£Œ`);
            console.log(`[DB] ê¸°ë³¸í˜• í¬ì¼“ëª¬: ${BASIC_POKEMON_IDS.length}ê°œ`);
            console.log(`[DB] ê¸°ë³¸í˜• ìƒ˜í”Œ:`, BASIC_POKEMON_IDS.slice(0, 10));
            DB_LOADED = true;
            return true;
        } catch (e) {
            console.error("[DB] poke_db.json ë¡œë“œ ì‹¤íŒ¨:", e);
            DB_LOADED = false;
            // Fallback: ê¸°ì¡´ í•˜ë“œì½”ë”© ë°ì´í„° ì‚¬ìš©
            return false;
        }
    }

    async function loadQuizData() {
        try {
            const timestamp = new Date().getTime();
            const res = await fetch(`./quiz/quiz.json?v=${timestamp}`, {
                cache: "no-store",
                headers: { 'Pragma': 'no-cache', 'Cache-Control': 'no-cache' }
            });
            if (!res.ok) throw new Error("Quiz JSON Fetch Failed");
            const data = await res.json();
            if (data && data.questions && data.questions.length > 0) {
                externalQuizList = data.questions;
                console.log(`[Quiz] ${externalQuizList.length}ê°œ ë¬¸ì œ ë¡œë“œ ì™„ë£Œ`);
            }
        } catch (e) {
            console.warn("[Quiz] quiz.json ë¡œë“œ ì‹¤íŒ¨, êµ¬êµ¬ë‹¨ ì‚¬ìš©:", e);
            externalQuizList = [];
        }
    }

    /* =========================================
     * ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
     * ========================================= */
    const TIER_ORDER = ['C', 'R', 'SR', 'SSR', 'UR'];

    function getRandomMoves(typeName, count, maxTierStr = 'UR') {
        const pool = MOVE_POOL[typeName] || MOVE_POOL["ë…¸ë§"];
        const maxIdx = TIER_ORDER.indexOf(maxTierStr);
        const filtered = pool.filter(m => TIER_ORDER.indexOf(m.t) <= maxIdx);
        const res = [];
        if (filtered.length === 0) return res;
        for (let i = 0; i < count; i++) {
            res.push(filtered[Math.floor(Math.random() * filtered.length)]);
        }
        return res;
    }

    // [ìˆ˜ì •] ë ˆë²¨ì— ë”°ë¥¸ ìŠ¤íƒ¯ ê³„ì‚° (ë³¸ê°€ ê³µì‹)
    function calcStats(base, level) {
        // base: { hp, atk, def, spa, spd, spe }
        const calc = (b, isHp) => Math.floor(((2 * b + 31) * level) / 100) + (isHp ? level + 10 : 5);
        return {
            maxHp: calc(base.hp, true),
            atk: calc(base.atk, false),
            def: calc(base.def, false),
            spa: calc(base.spa, false),
            spd: calc(base.spd, false),
            spe: calc(base.spe, false),
        };
    }

    function getPokeInfo(id) {
        id = Math.floor(Number(id) || 1);
        if (id < 1) id = 1;
        if (id > BASE_DEX_MAX) id = BASE_DEX_MAX;

        const dexId = id;
        const baseId = id;

        const nameBase = POKE_NAMES[baseId - 1] || `No.${baseId}`;
        const name = nameBase;

        // íƒ€ì… ê²°ì • (poke_db.jsonì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        let typeName = "ë…¸ë§";
        if (POKE_DB && POKE_DB.pokemon && POKE_DB.pokemon[baseId - 1]) {
            const types_ko = POKE_DB.pokemon[baseId - 1].types_ko;
            if (types_ko && types_ko.length > 0) {
                typeName = types_ko[0];
            }
        }

        // ìŠ¤íƒ¯ ê°€ì ¸ì˜¤ê¸°
        const sData = ALL_STATS_DB[baseId - 1] || [45,45,45,45,45,45];
        const rawBase = { hp: sData[0], atk: sData[1], def: sData[2], spa: sData[3], spd: sData[4], spe: sData[5] };
        const bst = rawBase.hp + rawBase.atk + rawBase.def + rawBase.spa + rawBase.spd + rawBase.spe;

        // ë ˆì–´ë„ íŒë‹¨
        let rarity = "C";
        if (bst >= 580) rarity = "UR";
        else if (bst >= 500) rarity = "SSR";
        else if (bst >= 400) rarity = "SR";
        else if (bst >= 300) rarity = "R";

        const isLegendary = LEGENDARY_IDS.includes(baseId);
        const isMythical = MYTHICAL_IDS.includes(baseId);

        let isShiny = CUTE_IDS.includes(baseId);

        if (isLegendary || isMythical) rarity = "UR";

        // BST ì°¨ì´ë¥¼ ì‚´ë¦¬ë˜ í‹°ì–´ë³„ ëª©í‘œ BST ê¸°ì¤€ìœ¼ë¡œ ë¹„ìœ¨ ì¡°ì •
        const config = TIER_CONFIG[rarity] || { targetBst: bst, bonus: 0 };
        const ratio = config.targetBst / Math.max(1, bst);

        const finalBase = {
            hp: Math.max(1, Math.floor(rawBase.hp * ratio) + config.bonus),
            atk: Math.max(1, Math.floor(rawBase.atk * ratio) + config.bonus),
            def: Math.max(1, Math.floor(rawBase.def * ratio) + config.bonus),
            spa: Math.max(1, Math.floor(rawBase.spa * ratio) + config.bonus),
            spd: Math.max(1, Math.floor(rawBase.spd * ratio) + config.bonus),
            spe: Math.max(1, Math.floor(rawBase.spe * ratio) + config.bonus)
        };

        const baseUrl = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon";
        const spriteUrl = isShiny
            ? `${baseUrl}/shiny/${baseId}.png`
            : `${baseUrl}/${baseId}.png`;

        return {
            id: dexId,
            baseId,
            name,
            rarity,
            type: { name: typeName, ...(TYPE_DATA[typeName] || TYPE_DATA["ë…¸ë§"]) },
            sprite: spriteUrl,
            base: finalBase,
            isShiny,
            isLegendary,
            isMythical
        };
    }

    // ì§„í™” ê°€ëŠ¥ ì—¬ë¶€ ì²´í¬
    function canEvolve(pokemonId, level) {
        const evoInfo = EVOLUTION_MAP[pokemonId];
        if (!evoInfo) return null;
        if (level >= evoInfo.min_level) {
            return evoInfo.next_id;
        }
        return null;
    }

    // ì§„í™” ì‹¤í–‰
    function doEvolve(pokemonId) {
        const evoInfo = EVOLUTION_MAP[pokemonId];
        if (!evoInfo) return null;

        const nextId = evoInfo.next_id;
        const owned = getOwned();

        // ì§„í™” í›„ í¬ì¼“ëª¬ ë„ê° ë“±ë¡
        if (!owned.has(nextId)) {
            owned.add(nextId);
            saveOwned(owned);
        }

        return nextId;
    }

    // ğŸ” UTF-8 ì•ˆì „ Base64 ì¸ì½”ë”/ë””ì½”ë”
    function toBase64UTF8(obj) {
        const json = typeof obj === "string" ? obj : JSON.stringify(obj);
        return btoa(unescape(encodeURIComponent(json)));
    }

    function fromBase64UTF8(b64) {
        const str = decodeURIComponent(escape(atob(b64)));
        return str;
    }

    /* =========================================
     * STATE & LOGIC
     * ========================================= */
    const LS_KEY = {
        POINTS: "qz_p_v80",
        OWNED: "qz_o_v80",
        PARTNER: "qz_st_v80",
        HOF: "qz_hof_v80",
        TICKETS: "qz_t_v80",
        DUPES: "qz_d_v80",
        CHAR_DATA: "qz_c_prog_v80"
    };

    const GHOST_ROOT_URL = (location.origin && location.origin !== "null")
        ? `${location.origin}${location.pathname}`
        : "https://unluckyidiot16.github.io/WebGames/PRL/PRL.html";

    function getCharData() {
        try { return JSON.parse(localStorage.getItem(LS_KEY.CHAR_DATA) || "{}"); }
        catch { return {}; }
    }

    function saveCharData(data) {
        localStorage.setItem(LS_KEY.CHAR_DATA, JSON.stringify(data));
    }

    function saveCurrentPlayerProgress() {
        if (!battleState || !battleState.player) return;
        const allData = getCharData();
        allData[battleState.player.id] = {
            level: battleState.player.level,
            xp: battleState.player.xp
        };
        saveCharData(allData);
    }

    let battleState = null;
    let quizCallback = null;
    let ghostScanStream = null;
    let ghostScanFrameId = null;

    function getPoints() { return parseInt(localStorage.getItem(LS_KEY.POINTS) || "1000", 10); }
    function setPoints(n) { localStorage.setItem(LS_KEY.POINTS, Math.max(0, n)); updateResUI(); }
    function addPoints(n) { setPoints(getPoints() + n); }
    function getTickets() { return parseInt(localStorage.getItem(LS_KEY.TICKETS) || "0", 10); }
    function setTickets(n) { localStorage.setItem(LS_KEY.TICKETS, Math.max(0, n)); updateResUI(); }
    function addTickets(n) { setTickets(getTickets() + n); }
    function getOwned() { try { return new Set(JSON.parse(localStorage.getItem(LS_KEY.OWNED) || "[]")); } catch { return new Set(); } }
    function saveOwned(set) { localStorage.setItem(LS_KEY.OWNED, JSON.stringify([...set])); }
    function getDupes() { try { return JSON.parse(localStorage.getItem(LS_KEY.DUPES) || "{}"); } catch { return {}; } }
    function saveDupes(d) { localStorage.setItem(LS_KEY.DUPES, JSON.stringify(d)); }

    /* =========================================
     * INDEX -> PRL ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
     * ========================================= */
    const INDEX_EXPORT_KEY = "classhub_index_export_to_prl_v1";
    const INDEX_IMPORT_MAX_AGE_MS = 1000 * 60 * 60 * 24 * 14;

    function _b64UrlDecodeUtf8(token) {
        try {
            token = (token || "").replace(/-/g, "+").replace(/_/g, "/");
            token += "=".repeat((4 - (token.length % 4)) % 4);
            const bin = atob(token);
            const bytes = new Uint8Array(bin.length);
            for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
            return new TextDecoder().decode(bytes);
        } catch (e) {
            return null;
        }
    }

    function _readImportFromUrl() {
        try {
            const sp = new URLSearchParams(location.search);
            const token = sp.get("import");
            if (token) return token;
        } catch {}
        try {
            const h = (location.hash || "").replace(/^#/, "");
            if (!h) return null;
            const m = h.match(/(?:^|&)import=([^&]+)/);
            if (m && m[1]) return decodeURIComponent(m[1]);
        } catch {}
        return null;
    }

    function _stripImportFromUrl() {
        try {
            const sp = new URLSearchParams(location.search);
            if (sp.has("import")) {
                sp.delete("import");
                const qs = sp.toString();
                history.replaceState(null, "", location.pathname + (qs ? "?" + qs : "") + (location.hash || ""));
            }
        } catch {}
        try {
            if ((location.hash || "").includes("import=")) {
                history.replaceState(null, "", location.pathname + location.search);
            }
        } catch {}
    }

    function tryImportFromIndex() {
        let payload = null;
        const token = _readImportFromUrl();
        if (token) {
            const raw = _b64UrlDecodeUtf8(token);
            if (raw) {
                try { payload = JSON.parse(raw); } catch {}
            }
        }
        if (!payload) {
            try {
                const raw = localStorage.getItem(INDEX_EXPORT_KEY);
                if (raw) payload = JSON.parse(raw);
            } catch {}
        }
        if (!payload) return;

        const ts = Number(payload.ts || payload.timestamp || payload.time || 0);
        if (ts && (Date.now() - ts) > INDEX_IMPORT_MAX_AGE_MS) {
            try { localStorage.removeItem(INDEX_EXPORT_KEY); } catch {}
            _stripImportFromUrl();
            return;
        }

        const dexIds = payload.dexIds || payload.dex || payload.ownedIds || payload.ids || [];
        if (!Array.isArray(dexIds)) return;

        const owned = getOwned();
        let added = 0;

        for (const v of dexIds) {
            const pid = parseInt(v, 10);
            if (!Number.isFinite(pid) || pid < 1 || pid > BASE_DEX_MAX) continue;
            if (!owned.has(pid)) {
                owned.add(pid);
                added++;
            }
        }

        if (added > 0) saveOwned(owned);

        const partnerId = parseInt(payload.partnerId, 10);
        if (Number.isFinite(partnerId) && owned.has(partnerId)) {
            localStorage.setItem(LS_KEY.PARTNER, String(partnerId));
        }

        try { localStorage.removeItem(INDEX_EXPORT_KEY); } catch {}
        _stripImportFromUrl();

        updateResUI();
        updateLobbyPartner();
        renderCodex();

        if (added > 0) {
            showAlert("âœ… ë‚´ë³´ë‚´ê¸° ì™„ë£Œ", `indexì—ì„œ ê°€ì ¸ì˜¨ í¬ì¼“ëª¬ ${added}ë§ˆë¦¬ë¥¼ PRLì— ë“±ë¡í–ˆì–´ìš”!`);
        }
    }

    async function importFromClipboard() {
        try {
            const text = await navigator.clipboard.readText();
            if (!text) {
                alert("í´ë¦½ë³´ë“œê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. index ê²Œì„ì—ì„œ 'ë‚´ë³´ë‚´ê¸°'ë¥¼ ë¨¼ì € í•´ì£¼ì„¸ìš”.");
                return;
            }

            const raw = _b64UrlDecodeUtf8(text);
            if (!raw) {
                alert("ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.\n(Base64 ë””ì½”ë”© ì‹¤íŒ¨)");
                return;
            }

            let payload;
            try {
                payload = JSON.parse(raw);
            } catch (e) {
                alert("ë°ì´í„°ê°€ ì†ìƒë˜ì—ˆìŠµë‹ˆë‹¤.\n(JSON íŒŒì‹± ì‹¤íŒ¨)");
                return;
            }

            if (payload.source !== "index" || !Array.isArray(payload.dexIds)) {
                alert("ìœ íš¨í•œ í¬ì¼“ëª¬ ë°ì´í„°ê°€ ì•„ë‹™ë‹ˆë‹¤.");
                return;
            }

            const owned = getOwned();
            let added = 0;

            for (const v of payload.dexIds) {
                const pid = parseInt(v, 10);
                if (!Number.isFinite(pid) || pid < 1 || pid > BASE_DEX_MAX) continue;
                if (!owned.has(pid)) {
                    owned.add(pid);
                    added++;
                }
            }

            if (added > 0) {
                saveOwned(owned);
                updateResUI();
                renderCodex();
            }

            const partnerId = parseInt(payload.partnerId, 10);
            if (Number.isFinite(partnerId) && partnerId <= BASE_DEX_MAX) {
                if(confirm(`${added}ë§ˆë¦¬ í¬ì¼“ëª¬ì„ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!\n\níŒŒíŠ¸ë„ˆ í¬ì¼“ëª¬(${getPokeInfo(partnerId).name})ë„ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    setStarterId(partnerId);
                }
            } else {
                alert(`${added}ë§ˆë¦¬ì˜ í¬ì¼“ëª¬ì„ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤!`);
            }

        } catch (err) {
            console.error(err);
            alert("í´ë¦½ë³´ë“œ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
        }
    }

    function getStarterId() { return parseInt(localStorage.getItem(LS_KEY.PARTNER) || "0"); }
    function setStarterId(id) {
        localStorage.setItem(LS_KEY.PARTNER, id);
        updateLobbyPartner();

        if (window.__pendingGhost) {
            const g = window.__pendingGhost;
            window.__pendingGhost = null;
            if (confirm(`ê³ ìŠ¤íŠ¸ ${g.name} (Lv.${g.level}) ì´ˆëŒ€ê°€ ìˆìŠµë‹ˆë‹¤.\nì§€ê¸ˆ ë°”ë¡œ ë„ì „í• ê¹Œìš”?`)) {
                startGhostBattle(g);
            }
        }
    }

    function getHoF() {
        try { return JSON.parse(localStorage.getItem(LS_KEY.HOF) || "[]"); }
        catch { return []; }
    }

    function getBestAdventureRecord() {
        const list = getHoF();
        const adv = list.filter(r => !r.kind || r.kind === "adventure");
        if (!adv.length) return null;
        adv.sort((a, b) => (b.stage || 0) - (a.stage || 0));
        return adv[0];
    }

    function addHoF(record) {
        const list = getHoF();
        const enriched = {
            kind: record.kind || "adventure",
            ts: record.ts || Date.now(),
            ...record,
        };
        list.push(enriched);
        list.sort((a, b) => (b.stage || 0) - (a.stage || 0));
        localStorage.setItem(LS_KEY.HOF, JSON.stringify(list.slice(0, 10)));
    }

    /* =========================================
     * UI ì—…ë°ì´íŠ¸ í•¨ìˆ˜ë“¤
     * ========================================= */
    function updateResUI() {
        const p = getPoints().toLocaleString(), t = getTickets().toLocaleString();
        document.getElementById("pointsTextLobby").textContent = p;
        document.getElementById("ticketTextLobby").textContent = t;
        const gachaRes = document.getElementById("gachaResDisplay");
        if (gachaRes) gachaRes.textContent = `P: ${p} / ğŸ«: ${t}`;
    }

    function updateLobbyPartner() {
        const pid = getStarterId();
        if (pid > 0) {
            const info = getPokeInfo(pid);
            const dupes = getDupes()[pid] || 0;
            const savedData = getCharData()[pid];
            const currentLv = savedData ? savedData.level : (1 + dupes);

            document.getElementById("lobbyPartnerName").textContent = info.name;
            document.getElementById("lobbyPartnerImg").src = info.sprite;
            document.getElementById("partnerInfo").textContent = info.name;
            document.getElementById("lobbyStartBonus").textContent = `í˜„ì¬ Lv.${currentLv} (ì¤‘ë³µ +${dupes})`;
            document.getElementById("startAdventureBtn").disabled = false;
        } else {
            document.getElementById("lobbyPartnerName").textContent = "ì—†ìŒ";
            document.getElementById("partnerInfo").textContent = "ì„ íƒ í•„ìš”";
            document.getElementById("lobbyStartBonus").textContent = "ì„ íƒ í•„ìš”";
            document.getElementById("startAdventureBtn").disabled = true;
        }
    }

    let codexPage = 0;
    const CODEX_PER_PAGE = 100;

    function renderCodex() {
        const grid = document.getElementById("codexGrid");
        grid.innerHTML = "";
        const owned = getOwned(), pid = getStarterId(), dupes = getDupes();

        // ì „ì²´ ì†Œìœ  ìˆ˜ ê³„ì‚°
        let totalOwned = 0;
        for (let i = 1; i <= DEX_TOTAL; i++) {
            if (owned.has(i)) totalOwned++;
        }

        // í˜ì´ì§€ ë²”ìœ„ ê³„ì‚°
        const totalPages = Math.ceil(DEX_TOTAL / CODEX_PER_PAGE);
        const startIdx = codexPage * CODEX_PER_PAGE + 1;
        const endIdx = Math.min((codexPage + 1) * CODEX_PER_PAGE, DEX_TOTAL);

        for (let i = startIdx; i <= endIdx; i++) {
            const info = getPokeInfo(i);
            const ownedBase = owned.has(info.baseId);

            const el = document.createElement("div");
            el.className = `poke-card relative rounded-xl p-2 flex flex-col items-center cursor-pointer rarity-${info.rarity}`;
            if (!ownedBase) el.classList.add("opacity-50", "grayscale");
            if (pid === i) el.classList.add("ring-4", "ring-emerald-400");

            const dupeCount = dupes[i] || 0;
            const evoInfo = EVOLUTION_MAP[info.baseId];
            const evoTag = evoInfo ? `<div class="absolute bottom-1 left-1 text-[8px] bg-yellow-400 text-yellow-900 px-1 rounded">â†’Lv.${evoInfo.min_level}</div>` : '';

            el.innerHTML = `
                <div class="absolute top-1 left-1 text-[9px] font-bold text-slate-400">#${String(i).padStart(4,'0')}</div>
                ${dupeCount > 0 ? `<div class="absolute top-1 right-1 bg-red-500 text-white text-[8px] px-1 rounded-full">+${dupeCount}</div>` : ''}
                <div class="w-12 h-12 mt-2">
                    <img src="${ownedBase ? info.sprite : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png'}" class="w-full h-full pixel-art object-contain ${!ownedBase ? 'opacity-20' : ''}" loading="lazy">
                </div>
                <div class="text-[10px] font-bold truncate mt-1">${ownedBase ? info.name : '???'}</div>
                <div class="text-[8px] font-bold mt-0.5 ${info.rarity==='UR'?'text-red-500':info.rarity==='SSR'?'text-orange-500':'text-slate-400'}">${info.rarity}</div>
                ${evoTag}
            `;
            el.onclick = () => {
                if (!ownedBase) {
                    showAlert("ë¯¸ë³´ìœ ", "ê°€ì± ë¡œ ë¨¼ì € íšë“í•˜ì„¸ìš”.");
                    return;
                }
                setStarterId(info.baseId);
                renderCodex();
            };
            grid.appendChild(el);
        }

        // í˜ì´ì§€ ì •ë³´ ë° ë„¤ë¹„ê²Œì´ì…˜
        document.getElementById("collectionRate").textContent = `${totalOwned}/${DEX_TOTAL}`;

        // í˜ì´ì§€ë„¤ì´ì…˜ UI ì—…ë°ì´íŠ¸
        const pageInfo = document.getElementById("codexPageInfo");
        if (pageInfo) {
            pageInfo.textContent = `${codexPage + 1}/${totalPages} (${startIdx}-${endIdx})`;
        }

        const prevBtn = document.getElementById("codexPrevBtn");
        const nextBtn = document.getElementById("codexNextBtn");
        if (prevBtn) prevBtn.disabled = codexPage === 0;
        if (nextBtn) nextBtn.disabled = codexPage >= totalPages - 1;
    }

    function codexPrevPage() {
        if (codexPage > 0) {
            codexPage--;
            renderCodex();
        }
    }

    function codexNextPage() {
        const totalPages = Math.ceil(DEX_TOTAL / CODEX_PER_PAGE);
        if (codexPage < totalPages - 1) {
            codexPage++;
            renderCodex();
        }
    }

    function renderHoF() {
        const list = getHoF();
        const container = document.getElementById("hofList");
        container.innerHTML = "";

        if (!list || list.length === 0) {
            container.innerHTML = '<p class="text-center text-slate-400 py-10">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const normal = list.filter((r) => !r.kind || r.kind === "adventure").sort((a, b) => (b.stage || 0) - (a.stage || 0));
        const ghost = list.filter((r) => r.kind === "ghost").sort((a, b) => (b.ts || 0) - (a.ts || 0));

        if (normal.length > 0) {
            const header = document.createElement("div");
            header.className = "text-xs font-bold text-slate-500 mb-2 flex items-center gap-1";
            header.innerHTML = '<span>ğŸŒŸ ì¼ë°˜ ëª¨í—˜ ê¸°ë¡</span>';
            container.appendChild(header);

            normal.forEach((rec, idx) => {
                const div = document.createElement("div");
                div.className = "hof-item border-2 rounded-xl p-3 flex items-center gap-3 relative";
                div.innerHTML = `
                    <div class="font-black text-2xl w-8 text-center text-slate-400 italic">#${idx + 1}</div>
                    <img src="${rec.sprite}" class="w-12 h-12 pixel-art bg-white rounded-full border border-slate-200">
                    <div class="flex-1">
                        <div class="font-bold text-slate-800">${rec.name} <span class="text-xs font-normal text-slate-500">(${rec.date || ""})</span></div>
                        <div class="text-xs text-slate-600">ìµœì¢… ìŠ¤í…Œì´ì§€: <span class="text-red-500 font-bold text-base">${rec.stage}</span></div>
                    </div>
                    <button type="button" class="hof-export-btn absolute right-3 top-3 text-[10px] px-2 py-1 rounded-full bg-slate-100 text-slate-600 border border-slate-300 hover:bg-slate-200">QR</button>
                `;

                const btn = div.querySelector(".hof-export-btn");
                if (btn) {
                    btn.addEventListener("click", (ev) => {
                        ev.stopPropagation();
                        openGhostModalFromHof(rec);
                    });
                }
                container.appendChild(div);
            });
        }

        if (ghost.length > 0) {
            const header = document.createElement("div");
            header.className = "text-xs font-bold text-slate-500 mt-4 mb-2 flex items-center gap-1";
            header.innerHTML = '<span>ğŸ‘» ê³ ìŠ¤íŠ¸ ìŠ¹ë¦¬ ê¸°ë¡</span>';
            container.appendChild(header);

            ghost.forEach((rec, idx) => {
                const div = document.createElement("div");
                div.className = "hof-item border-2 border-purple-300 rounded-xl p-3 flex items-center gap-3 relative bg-purple-50/40";
                div.innerHTML = `
                    <div class="font-black text-2xl w-8 text-center text-purple-400 italic">#${idx + 1}</div>
                    <img src="${rec.sprite}" class="w-12 h-12 pixel-art bg-white rounded-full border border-purple-200">
                    <div class="flex-1">
                        <div class="font-bold text-slate-800">${rec.name} <span class="text-xs font-normal text-slate-500">(${rec.date || ""})</span></div>
                        <div class="text-xs text-slate-600">ìƒëŒ€: <span class="font-bold text-purple-600">${rec.ghostName || "ì•Œ ìˆ˜ ì—†ìŒ"}</span> <span class="text-[11px] text-slate-500 ml-1">Lv.${rec.ghostLevel || "?"}</span></div>
                        <div class="text-[11px] text-slate-500 mt-0.5">ê¸°ë¡ ìŠ¤í…Œì´ì§€: <span class="font-semibold">${rec.stage ?? "-"}</span></div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
    }

    /* =========================================
     * GACHA SYSTEM - ê¸°ë³¸í˜•ë§Œ ë½‘ê¸°
     * ========================================= */
    function playGacha(type) {
        if (!GACHA_ENABLED) return;
        // DB ë¡œë“œ í™•ì¸
        if (!DB_LOADED || BASIC_POKEMON_IDS.length === 0) {
            alert("í¬ì¼“ëª¬ ë°ì´í„° ë¡œë”© ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            console.error("[Gacha] DB_LOADED:", DB_LOADED, "BASIC_POKEMON_IDS:", BASIC_POKEMON_IDS.length);
            return;
        }

        let count = 1;
        if (type === '10x') { type = 'normal'; count = 10; }

        const costPer = type === 'normal' ? 100 : 1;
        const totalCost = count === 10 ? 900 : costPer * count;
        const cur = type === 'normal' ? getPoints() : getTickets();

        if (cur < totalCost) { alert("ì¬í™” ë¶€ì¡±!"); return; }
        if (type === 'normal') setPoints(getPoints() - totalCost); else setTickets(getTickets() - totalCost);

        document.getElementById("gachaPlaceholder").classList.add("hidden");
        const grid = document.getElementById("gachaResultsGrid");
        grid.classList.remove("hidden");
        grid.innerHTML = "";

        const owned = getOwned();
        const dupes = getDupes();

        // ê¸°ë³¸í˜• í¬ì¼“ëª¬ í’€ (DBì—ì„œ ë¡œë“œëœ is_basic:trueì¸ í¬ì¼“ëª¬ë“¤)
        const pool = BASIC_POKEMON_IDS;

        // ì „ì„¤/í™˜ìƒ ì œì™¸í•œ ì¼ë°˜ ê¸°ë³¸í˜• í’€
        const normalPool = pool.filter(id => !LEGENDARY_IDS.includes(id) && !MYTHICAL_IDS.includes(id));
        // ê¸°ë³¸í˜• ì¤‘ ì „ì„¤/í™˜ìƒë§Œ
        const legendaryPool = pool.filter(id => LEGENDARY_IDS.includes(id) || MYTHICAL_IDS.includes(id));

        console.log(`[Gacha] ì¼ë°˜ í’€: ${normalPool.length}ê°œ, ì „ì„¤ í’€: ${legendaryPool.length}ê°œ`);

        for (let i = 0; i < count; i++) {
            let pid;
            if (type === 'special') {
                // ì „ì„¤ ì†Œí™˜: 50% í™•ë¥ ë¡œ ì „ì„¤, ì•„ë‹ˆë©´ ì¼ë°˜ ê¸°ë³¸í˜•
                if (Math.random() < 0.5 && legendaryPool.length > 0) {
                    pid = legendaryPool[Math.floor(Math.random() * legendaryPool.length)];
                } else {
                    pid = normalPool[Math.floor(Math.random() * normalPool.length)];
                }
            } else {
                // ì¼ë°˜ ì†Œí™˜: ê¸°ë³¸í˜•ë§Œ (ì „ì„¤ ì œì™¸)
                pid = normalPool[Math.floor(Math.random() * normalPool.length)];
            }

            const info = getPokeInfo(pid);
            if (owned.has(pid)) {
                dupes[pid] = (dupes[pid] || 0) + 1;
                saveDupes(dupes);
            } else {
                owned.add(pid);
                saveOwned(owned);
            }

            const div = document.createElement("div");
            div.className = `flex flex-col items-center p-2 rounded-xl animate-[bounce_0.5s] ${info.rarity === 'UR' ? 'bg-red-100 border border-red-400' : info.rarity === 'SSR' ? 'bg-orange-100 border-orange-400' : 'bg-slate-700'}`;
            div.innerHTML = `<img src="${info.sprite}" class="w-8 h-8 pixel-art"><div class="text-[8px] font-bold ${['UR','SSR','SR'].includes(info.rarity) ? 'text-black' : 'text-white'} truncate w-full text-center">${info.name}</div>`;
            grid.appendChild(div);
        }
        updateResUI();
        renderCodex();
    }

    /* =========================================
     * BATTLE SYSTEM
     * ========================================= */
    function initAdventure() {
        const pid = getStarterId();
        if (!pid) return;

        const info = getPokeInfo(pid);
        const dupes = getDupes()[pid] || 0;
        const savedData = getCharData()[pid];

        let level = 1 + dupes;
        let xp = 0;

        if (savedData) {
            level = Math.max(savedData.level, 1 + dupes);
            xp = savedData.xp;
        }

        const stats = calcStats(info.base, level);
        const startMoves = getRandomMoves(info.type.name, 2, 'C');

        battleState = {
            mode: "adventure",
            stage: 1,
            player: {
                id: pid, name: info.name, sprite: info.sprite, type: info.type.name,
                level: level, xp: xp,
                maxHp: stats.maxHp, hp: stats.maxHp,
                atk: stats.atk, def: stats.def, spa: stats.spa, spd: stats.spd, spe: stats.spe,
                base: info.base,
                moves: startMoves
            },
            cooldowns: [0, 0]
        };

        startBattleStage();
        document.getElementById("titleScreen").classList.remove("active");
        document.getElementById("codexScreen").classList.remove("active");
        document.getElementById("battleScreen").classList.add("active");
    }

    function startGhostBattle(ghost) {
        const pid = getStarterId();
        if (!pid) {
            showAlert("ìŠ¤íƒ€í„° ì—†ìŒ", "ë¨¼ì € ë‚´ ìŠ¤íƒ€í„°ë¥¼ í•˜ë‚˜ ì„ íƒí•´ ì£¼ì„¸ìš”.");
            return;
        }

        const myInfo = getPokeInfo(pid);
        const myCharData = getCharData()[pid];
        const myDupes = getDupes()[pid] || 0;

        let myLevel = 1 + myDupes;
        let myXp = 0;
        if (myCharData) {
            if (typeof myCharData.level === "number") myLevel = myCharData.level;
            if (typeof myCharData.xp === "number") myXp = myCharData.xp;
        }

        const myStats = calcStats(myInfo.base, myLevel);
        const myMoves = getRandomMoves(myInfo.type.name, 2, "SR");

        const enemyInfo = getPokeInfo(ghost.speciesId || ghost.id || 1);
        const enemyLevel = ghost.level || 1;
        const enemyStats = calcStats(enemyInfo.base, enemyLevel);
        const enemyMoves = getRandomMoves(enemyInfo.type.name, 1, "UR");

        battleState = {
            mode: "ghost",
            stage: 1,
            player: {
                id: pid, name: myInfo.name, sprite: myInfo.sprite, type: myInfo.type.name,
                level: myLevel, xp: myXp,
                maxHp: myStats.maxHp, hp: myStats.maxHp,
                atk: myStats.atk, def: myStats.def, spa: myStats.spa, spd: myStats.spd, spe: myStats.spe,
                base: myInfo.base, moves: myMoves,
            },
            enemy: {
                id: enemyInfo.id, name: ghost.name || enemyInfo.name, sprite: enemyInfo.sprite,
                type: ghost.type || enemyInfo.type.name, level: enemyLevel,
                maxHp: enemyStats.maxHp, hp: enemyStats.maxHp,
                atk: enemyStats.atk, def: enemyStats.def, spa: enemyStats.spa, spd: enemyStats.spd, spe: enemyStats.spe,
                move: enemyMoves[0], isBoss: true,
            },
            cooldowns: [0, 0],
        };

        closeGhostModal();
        document.getElementById("titleScreen").classList.remove("active");
        document.getElementById("lobbyScreen").classList.remove("active");
        document.getElementById("codexScreen").classList.remove("active");
        document.getElementById("battleScreen").classList.add("active");

        updateBattleUI();
        logBattle(`QR ê³ ìŠ¤íŠ¸ ${battleState.enemy.name} (Lv.${battleState.enemy.level})ì—ê²Œ ë„ì „!`, "critical");
    }

    function startBattleStage() {
        const { stage, player } = battleState;

        // ì  ìƒì„± (ê¸°ë³¸í˜• ê¸°ë°˜)
        const pool = BASIC_POKEMON_IDS.length > 0 ? BASIC_POKEMON_IDS : Array.from({length: BASE_DEX_MAX}, (_,i) => i+1);
        let enemyId = pool[Math.floor(Math.random() * pool.length)];

        // ë³´ìŠ¤ íŒì • (5ì˜ ë°°ìˆ˜ ìŠ¤í…Œì´ì§€)
        const isBoss = (stage % 5 === 0);
        if (isBoss) {
            const legendaryPool = LEGENDARY_IDS.filter(id => id <= BASE_DEX_MAX);
            if (legendaryPool.length > 0) {
                enemyId = legendaryPool[Math.floor(Math.random() * legendaryPool.length)];
            }
        }

        const enemyInfo = getPokeInfo(enemyId);
        const enemyLevel = Math.max(1, stage + Math.floor(stage / 3));
        const enemyStats = calcStats(enemyInfo.base, enemyLevel);

        const maxTier = stage < 5 ? 'R' : stage < 10 ? 'SR' : stage < 15 ? 'SSR' : 'UR';
        const enemyMoves = getRandomMoves(enemyInfo.type.name, 1, maxTier);

        battleState.enemy = {
            id: enemyId, name: enemyInfo.name, sprite: enemyInfo.sprite, type: enemyInfo.type.name,
            level: enemyLevel, maxHp: enemyStats.maxHp, hp: enemyStats.maxHp,
            atk: enemyStats.atk, def: enemyStats.def, spa: enemyStats.spa, spd: enemyStats.spd, spe: enemyStats.spe,
            move: enemyMoves[0], isBoss
        };

        updateBattleUI();
        logBattle(isBoss ? `âš ï¸ ë³´ìŠ¤ ${enemyInfo.name} ë“±ì¥!` : `${enemyInfo.name} ë“±ì¥!`);
    }

    function updateBattleUI() {
        const { player, enemy, stage } = battleState;

        document.getElementById("battleStageText").textContent = stage;
        document.getElementById("playerImg").src = player.sprite;
        document.getElementById("playerName").textContent = player.name;
        document.getElementById("playerLevel").textContent = `Lv.${player.level}`;
        document.getElementById("playerHpText").textContent = `${Math.max(0, player.hp)}/${player.maxHp}`;
        document.getElementById("playerHpBar").style.width = `${Math.max(0, (player.hp / player.maxHp) * 100)}%`;

        const xpPercent = (player.xp / (player.level * 100)) * 100;
        document.getElementById("playerExpBar").style.width = `${xpPercent}%`;

        document.getElementById("enemyImg").src = enemy.sprite;
        document.getElementById("enemyName").textContent = enemy.name;
        document.getElementById("enemyLevel").textContent = `Lv.${enemy.level}`;
        document.getElementById("enemyHpBar").style.width = `${Math.max(0, (enemy.hp / enemy.maxHp) * 100)}%`;

        const typeInfo = TYPE_DATA[enemy.type] || TYPE_DATA["ë…¸ë§"];
        const badge = document.getElementById("enemyTypeBadge");
        badge.textContent = enemy.type;
        badge.className = `text-[9px] text-white px-1.5 py-0.5 rounded mb-1 inline-block ${typeInfo.color}`;

        renderMoveButtons();
    }

    function renderMoveButtons() {
        const grid = document.getElementById("moveButtons");
        grid.innerHTML = "";

        battleState.player.moves.forEach((m, idx) => {
            const btn = document.createElement("button");
            const onCooldown = battleState.cooldowns[idx] > 0;

            let cls = "bg-white border-slate-200";
            if (m.t === "UR") cls = "bg-red-50 border-red-300";
            else if (m.t === "SSR") cls = "bg-orange-50 border-orange-300";
            else if (m.t === "SR") cls = "bg-yellow-50 border-yellow-300";
            else if (m.t === "R") cls = "bg-blue-50 border-blue-200";

            btn.className = `py-3 px-2 rounded-xl border-2 ${cls} ${onCooldown ? 'btn-cooldown' : 'hover:brightness-95 active:scale-95'}`;
            btn.innerHTML = `<div class="font-bold text-sm">${m.n}</div><div class="text-[10px] text-slate-500">${m.t} / ìœ„ë ¥ ${m.p}</div>`;

            if (onCooldown) {
                btn.innerHTML += `<div class="text-[9px] text-red-400 mt-1">ì¿¨íƒ€ì„ ${battleState.cooldowns[idx]}</div>`;
                btn.disabled = true;
            } else {
                btn.onclick = () => useMove(idx);
            }
            grid.appendChild(btn);
        });
    }

    function logBattle(msg, type = "normal") {
        const log = document.getElementById("battleLog");
        log.textContent = msg;
        if (type === "critical") log.className = "text-xs text-red-500 mb-3 h-6 overflow-y-hidden text-center font-bold";
        else log.className = "text-xs text-slate-500 mb-3 h-6 overflow-y-hidden text-center italic";
    }

    function useMove(idx) {
        openQuiz((correct) => {
            if (correct) {
                const move = battleState.player.moves[idx];
                battleState.cooldowns[idx] = move.c;

                const isPhysical = PHYSICAL_TYPES.includes(move.type || battleState.player.type);
                const atkStat = isPhysical ? battleState.player.atk : battleState.player.spa;
                const defStat = isPhysical ? battleState.enemy.def : battleState.enemy.spd;

                let damage = Math.floor((((2 * battleState.player.level / 5 + 2) * move.p * atkStat / defStat) / 50) + 2);

                // íƒ€ì… ìƒì„±
                const enemyTypeData = TYPE_DATA[battleState.enemy.type];
                if (enemyTypeData && enemyTypeData.weak.includes(battleState.player.type)) {
                    damage = Math.floor(damage * 1.5);
                    logBattle(`íš¨ê³¼ê°€ êµ‰ì¥í–ˆë‹¤! ${move.n}ë¡œ ${damage} ë°ë¯¸ì§€!`, "critical");
                } else {
                    logBattle(`${move.n}! ${damage} ë°ë¯¸ì§€!`);
                }

                battleState.enemy.hp -= damage;

                // í”Œë ˆì´ì–´ ê³µê²© ì• ë‹ˆë©”ì´ì…˜
                const playerImg = document.getElementById("playerImg");
                playerImg.classList.add("animate-attack-player");
                setTimeout(() => playerImg.classList.remove("animate-attack-player"), 200);

                // ì  ë°ë¯¸ì§€ ì• ë‹ˆë©”ì´ì…˜
                const enemyImg = document.getElementById("enemyImg");
                setTimeout(() => {
                    enemyImg.classList.add("animate-damage");
                    setTimeout(() => enemyImg.classList.remove("animate-damage"), 400);
                }, 150);

                updateBattleUI();

                if (battleState.enemy.hp <= 0) {
                    setTimeout(handleWin, 600);
                } else {
                    setTimeout(enemyTurn, 800);
                }
            } else {
                logBattle("ì˜¤ë‹µ! ê³µê²© ì‹¤íŒ¨...");
                setTimeout(enemyTurn, 500);
            }
        });
    }

    function enemyTurn() {
        const move = battleState.enemy.move || { n: "ëª¸í†µë°•ì¹˜ê¸°", p: 40 };
        const isPhysical = PHYSICAL_TYPES.includes(battleState.enemy.type);
        const atkStat = isPhysical ? battleState.enemy.atk : battleState.enemy.spa;
        const defStat = isPhysical ? battleState.player.def : battleState.player.spd;

        let damage = Math.floor((((2 * battleState.enemy.level / 5 + 2) * move.p * atkStat / defStat) / 50) + 2);

        const playerTypeData = TYPE_DATA[battleState.player.type];
        if (playerTypeData && playerTypeData.weak.includes(battleState.enemy.type)) {
            damage = Math.floor(damage * 1.5);
        }

        battleState.player.hp -= damage;
        logBattle(`${battleState.enemy.name}ì˜ ${move.n}! ${damage} ë°ë¯¸ì§€!`);

        // ì  ê³µê²© ì• ë‹ˆë©”ì´ì…˜
        const enemyImg = document.getElementById("enemyImg");
        enemyImg.classList.add("animate-attack-enemy");
        setTimeout(() => enemyImg.classList.remove("animate-attack-enemy"), 200);

        // í”Œë ˆì´ì–´ ë°ë¯¸ì§€ ì• ë‹ˆë©”ì´ì…˜
        const playerImg = document.getElementById("playerImg");
        setTimeout(() => {
            playerImg.classList.add("animate-damage");
            setTimeout(() => playerImg.classList.remove("animate-damage"), 400);
        }, 150);

        // ì¿¨ë‹¤ìš´ ê°ì†Œ
        battleState.cooldowns = battleState.cooldowns.map(c => Math.max(0, c - 1));

        updateBattleUI();

        if (battleState.player.hp <= 0) {
            setTimeout(handleDefeat, 600);
        }
    }

    function handleWin() {
        const isGhost = battleState.mode === "ghost";
        const s = battleState.stage;

        const bonusLoot = [];
        if (battleState.enemy.isBoss) {
            addTickets(1);
            bonusLoot.push("âœ¨ ì „ì„¤ ë³´ìƒ: í‹°ì¼“ +1");
        }
        if (!isGhost && s > 0 && (s % 5 === 0)) {
            addTickets(1);
            bonusLoot.push(`ğŸŸï¸ ${s}ì¸µ ë³´ìƒ: í‹°ì¼“ +1`);
        }

        const pt = Math.floor(50 + (s * 10) + (s * s * 0.5));
        const xp = 50 + (s * 10);

        battleState.player.xp += xp;

        let lvUp = false;
        let evolutionChain = []; // ì—°ì† ì§„í™” ì²´ì¸

        // ë ˆë²¨ì—… ì²´í¬
        while (battleState.player.xp >= battleState.player.level * 100) {
            battleState.player.xp -= battleState.player.level * 100;
            battleState.player.level++;
            lvUp = true;

            // ì§„í™” ì²´í¬ (í˜„ì¬ ì§„í™” ì²´ì¸ì˜ ë§ˆì§€ë§‰ í¬ì¼“ëª¬ ê¸°ì¤€)
            const currentId = evolutionChain.length > 0
                ? evolutionChain[evolutionChain.length - 1].toId
                : battleState.player.id;
            const possibleEvolve = canEvolve(currentId, battleState.player.level);
            if (possibleEvolve) {
                evolutionChain.push({
                    fromId: currentId,
                    toId: possibleEvolve,
                    level: battleState.player.level
                });
            }
        }

        // ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸
        const newStats = calcStats(battleState.player.base, battleState.player.level);
        battleState.player.maxHp = newStats.maxHp;
        battleState.player.atk = newStats.atk;
        battleState.player.def = newStats.def;
        battleState.player.spa = newStats.spa;
        battleState.player.spd = newStats.spd;
        battleState.player.spe = newStats.spe;

        if (lvUp) {
            battleState.player.hp = battleState.player.maxHp;
        }

        saveCurrentPlayerProgress();

        // ì§„í™” ì²˜ë¦¬ (ì—°ì† ì§„í™” ì§€ì›)
        if (evolutionChain.length > 0) {
            processEvolutionChain(evolutionChain, 0, () => {
                continueWithReward(isGhost, pt, xp, lvUp, bonusLoot, s);
            });
            return;
        }

        continueWithReward(isGhost, pt, xp, lvUp, bonusLoot, s);
    }

    // ì—°ì† ì§„í™” ì²˜ë¦¬ í•¨ìˆ˜
    function processEvolutionChain(chain, index, finalCallback) {
        if (index >= chain.length) {
            finalCallback();
            return;
        }

        const evo = chain[index];
        const stageText = chain.length > 1 ? `(${index + 1}/${chain.length})` : '';
        showEvolveModal(evo.fromId, evo.toId, stageText, () => {
            // ì§„í™” ì™„ë£Œ í›„ ì²˜ë¦¬
            const newPokemonId = doEvolve(evo.fromId);
            if (newPokemonId) {
                // ìºë¦­í„° ë°ì´í„° ì—…ë°ì´íŠ¸
                const charData = getCharData();
                charData[newPokemonId] = {
                    level: battleState.player.level,
                    xp: battleState.player.xp
                };
                saveCharData(charData);

                // ìŠ¤íƒ€í„° ì—…ë°ì´íŠ¸
                setStarterId(newPokemonId);

                // ë°°í‹€ ìŠ¤í…Œì´íŠ¸ ì—…ë°ì´íŠ¸
                const newInfo = getPokeInfo(newPokemonId);
                battleState.player.id = newPokemonId;
                battleState.player.name = newInfo.name;
                battleState.player.sprite = newInfo.sprite;
                battleState.player.type = newInfo.type.name;
                battleState.player.base = newInfo.base;

                // ìŠ¤íƒ¯ ì¬ê³„ì‚°
                const evolvedStats = calcStats(newInfo.base, battleState.player.level);
                battleState.player.maxHp = evolvedStats.maxHp;
                battleState.player.hp = evolvedStats.maxHp;
                battleState.player.atk = evolvedStats.atk;
                battleState.player.def = evolvedStats.def;
                battleState.player.spa = evolvedStats.spa;
                battleState.player.spd = evolvedStats.spd;
                battleState.player.spe = evolvedStats.spe;

                // ê¸°ìˆ  ì—…ë°ì´íŠ¸
                const maxTier = battleState.player.level < 20 ? 'R' : battleState.player.level < 40 ? 'SR' : 'SSR';
                battleState.player.moves = getRandomMoves(newInfo.type.name, 4, maxTier);
                battleState.cooldowns = [0, 0, 0, 0];

                // UI ì—…ë°ì´íŠ¸
                updateBattleUI();
                saveCurrentPlayerProgress();
            }

            // ë‹¤ìŒ ì§„í™” ì²˜ë¦¬ (ë”œë ˆì´ ì¶”ê°€)
            setTimeout(() => {
                processEvolutionChain(chain, index + 1, finalCallback);
            }, 500);
        });
    }

    function showEvolveModal(fromId, toId, stageText, callback) {
        // íŒŒë¼ë¯¸í„° í˜¸í™˜ì„± (stageText ì—†ì´ í˜¸ì¶œëœ ê²½ìš°)
        if (typeof stageText === 'function') {
            callback = stageText;
            stageText = '';
        }

        const fromInfo = getPokeInfo(fromId);
        const toInfo = getPokeInfo(toId);

        document.getElementById("evolveFromImg").src = fromInfo.sprite;
        document.getElementById("evolveFromName").textContent = fromInfo.name;
        document.getElementById("evolveToImg").src = toInfo.sprite;
        document.getElementById("evolveToName").textContent = toInfo.name;
        document.getElementById("evolveMessage").textContent = `${fromInfo.name}ì´(ê°€) ${toInfo.name}(ìœ¼)ë¡œ ì§„í™”í–ˆìŠµë‹ˆë‹¤! ${stageText}`;

        document.getElementById("evolveModal").classList.remove("hidden");
        document.getElementById("evolveModal").classList.add("flex");

        document.getElementById("evolveOkBtn").onclick = () => {
            document.getElementById("evolveModal").classList.add("hidden");
            document.getElementById("evolveModal").classList.remove("flex");
            callback();
        };
    }

    function continueWithReward(isGhost, pt, xp, lvUp, bonusLoot, s) {
        if (isGhost) {
            addHoF({
                kind: "ghost",
                speciesId: battleState.player.id,
                level: battleState.player.level,
                name: battleState.player.name,
                sprite: battleState.player.sprite,
                stage: battleState.stage,
                ghostName: battleState.enemy.name,
                ghostLevel: battleState.enemy.level,
                date: new Date().toLocaleDateString(),
            });

            addPoints(pt);

            alert(
                `ê³ ìŠ¤íŠ¸ ${battleState.enemy.name} (Lv.${battleState.enemy.level})ì—ê²Œ ìŠ¹ë¦¬!\n` +
                `+${pt} P / EXP ${xp}${lvUp ? " (ë ˆë²¨ ì—…!)" : ""}`
            );

            document.getElementById("battleScreen").classList.remove("active");
            document.getElementById("lobbyScreen").classList.add("active");
            updateResUI();
            return;
        }

        document.getElementById("rewardXpVal").textContent = `${xp}${lvUp ? ' & Level Up!' : ''}`;
        const bonusEl = document.getElementById("bonusLootLine");
        if (bonusEl) {
            if (bonusLoot.length > 0) {
                bonusEl.textContent = bonusLoot.join("  ");
                bonusEl.classList.remove("hidden");
            } else {
                bonusEl.textContent = "";
                bonusEl.classList.add("hidden");
            }
        }

        const grid = document.getElementById("rewardButtons");
        grid.innerHTML = "";
        const isFullSlots = battleState.player.moves.length >= 4;

        [
            {
                t: `í¬ì¸íŠ¸ +${pt} P`,
                d: "ê°€ì±  ì¬í™”",
                f: () => { addPoints(pt); nextStage(); },
            },
            {
                t: "ì™„ì „ íšŒë³µ",
                d: "HP 100%",
                f: () => { battleState.player.hp = battleState.player.maxHp; nextStage(); },
            },
            {
                t: "ê¸°ìˆ  ë¨¸ì‹ ",
                d: isFullSlots ? "ìŠ¤í‚¬ 1ê°œ êµì²´" : "ìŠ¤í‚¬ ì¶”ê°€ ìŠµë“",
                f: () => {
                    if (isFullSlots) showSkillReplaceUI();
                    else addNewSkill();
                },
            },
        ].forEach((r) => {
            const btn = document.createElement("button");
            btn.className = "w-full py-3 bg-slate-100 hover:bg-indigo-50 border rounded-xl flex justify-between px-4 items-center";
            btn.innerHTML = `<span class="font-bold text-sm">${r.t}</span><span class="text-xs text-slate-500">${r.d}</span>`;
            btn.onclick = () => {
                if (r.t !== "ê¸°ìˆ  ë¨¸ì‹ ") {
                    document.getElementById("rewardModal").classList.add("hidden");
                }
                r.f();
            };
            grid.appendChild(btn);
        });

        document.getElementById("rewardModal").classList.remove("hidden");
    }

    function addNewSkill() {
        const newMove = getRandomMoves(battleState.player.type, 1)[0];
        battleState.player.moves.push(newMove);
        battleState.cooldowns.push(0);
        document.getElementById("rewardModal").classList.add("hidden");
        alert(`[${newMove.n}] ê¸°ìˆ ì„ ìƒˆë¡œ ë°°ì› ìŠµë‹ˆë‹¤!`);
        nextStage();
    }

    function showSkillReplaceUI() {
        document.getElementById("rewardTitle").textContent = "êµì²´í•  ìŠ¤í‚¬ì„ ì„ íƒí•˜ì„¸ìš”";
        const grid = document.getElementById("rewardButtons");
        grid.innerHTML = "";
        battleState.player.moves.forEach((m, idx) => {
            const btn = document.createElement("button");
            let cls = "bg-white border-slate-200";
            if (m.t === "UR") cls = "bg-red-50 border-red-300";
            else if (m.t === "SSR") cls = "bg-orange-50 border-orange-300";
            else if (m.t === "SR") cls = "bg-yellow-50 border-yellow-300";
            else if (m.t === "R") cls = "bg-blue-50 border-blue-200";
            btn.className = `w-full py-2 ${cls} border rounded-xl hover:brightness-95 flex flex-col items-center`;
            btn.innerHTML = `<span class="font-bold text-sm">${m.n}</span><span class="text-[9px]">${m.t} / ì¿¨íƒ€ì„ ${m.c}</span>`;
            btn.onclick = () => {
                const newMove = getRandomMoves(battleState.player.type, 1)[0];
                battleState.player.moves[idx] = newMove;
                battleState.cooldowns[idx] = 0;
                document.getElementById("rewardModal").classList.add("hidden");
                alert(`[${newMove.n}] ìŠµë“ ì™„ë£Œ!`);
                nextStage();
            };
            grid.appendChild(btn);
        });
    }

    function nextStage() {
        battleState.stage++;
        startBattleStage();
    }

    function handleDefeat() {
        if (battleState.mode === "ghost") {
            alert(`íŒ¨ë°°... ê³ ìŠ¤íŠ¸ ${battleState.enemy.name} (Lv.${battleState.enemy.level})ì—ê²Œ ì¡ŒìŠµë‹ˆë‹¤.\në‹¤ì‹œ ë„ì „í•´ ë³´ì„¸ìš”!`);
        } else {
            addHoF({
                kind: "adventure",
                name: battleState.player.name,
                sprite: battleState.player.sprite,
                speciesId: battleState.player.id,
                level: battleState.player.level,
                stage: battleState.stage,
                date: new Date().toLocaleDateString(),
            });
            alert(`ê²Œì„ ì˜¤ë²„! ìµœì¢… ìŠ¤í…Œì´ì§€: ${battleState.stage}`);
        }

        document.getElementById("battleScreen").classList.remove("active");
        document.getElementById("lobbyScreen").classList.add("active");
        updateResUI();
    }

    /* =========================================
     * QUIZ SYSTEM - quiz.json ì—°ë™
     * ========================================= */
    function openQuiz(cb) {
        quizCallback = cb;

        let qData;
        if (externalQuizList.length > 0 && Math.random() < 0.7) {
            // 70% í™•ë¥ ë¡œ ì™¸ë¶€ í€´ì¦ˆ ì‚¬ìš©
            qData = getExternalQuiz();
        } else {
            // 30% í™•ë¥ ë¡œ êµ¬êµ¬ë‹¨
            qData = generateMath();
        }

        document.getElementById("quizExplain").textContent = qData.explain || "";
        document.getElementById("quizQuestion").textContent = qData.q;

        const grid = document.getElementById("quizChoices");
        grid.innerHTML = "";

        qData.choices.forEach(c => {
            const btn = document.createElement("button");
            btn.className = "bg-slate-100 hover:bg-sky-100 border-2 border-slate-200 font-bold py-4 rounded-xl text-lg";
            btn.textContent = c;
            btn.onclick = () => {
                document.getElementById("quizModal").classList.add("hidden");
                if (quizCallback) quizCallback(c === qData.a);
            };
            grid.appendChild(btn);
        });
        document.getElementById("quizModal").classList.remove("hidden");
    }

    function getExternalQuiz() {
        const rawQ = externalQuizList[Math.floor(Math.random() * externalQuizList.length)];
        const originalChoices = rawQ.choices.map((val, idx) => ({ val: val, isAns: idx === rawQ.answerIndex }));

        // ì…”í”Œ
        for (let i = originalChoices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [originalChoices[i], originalChoices[j]] = [originalChoices[j], originalChoices[i]];
        }

        const shuffledChoices = originalChoices.map(obj => obj.val);
        const newAnswerIndex = originalChoices.findIndex(obj => obj.isAns);

        return {
            q: rawQ.prompt,
            explain: rawQ.promptExplain || "",
            choices: shuffledChoices,
            a: shuffledChoices[newAnswerIndex]
        };
    }

    function generateMath() {
        // 10, 20, 30, ..., 90 ì¤‘ í•˜ë‚˜ë¥¼ ì„ íƒ
        const num1 = (Math.floor(Math.random() * 9) + 1) * 10;
        const num2 = (Math.floor(Math.random() * 9) + 1) * 10;
        const a = num1 * num2; // ì •ë‹µ
        const q = `${num1} Ã— ${num2} = ?`; // ë¬¸ì œ í…ìŠ¤íŠ¸

        let s = new Set([a]);

        while(s.size < 4) {
            let wrong;
            const coinFlip = Math.random();

            if (coinFlip < 0.4) {
                // 1. ì •ë‹µì—ì„œ 100ì´ë‚˜ 200 ì •ë„ ì°¨ì´ ë‚˜ëŠ” ìˆ«ì ìƒì„±
                const offset = (Math.floor(Math.random() * 5) - 2) * 100;
                wrong = a + (offset === 0 ? 100 : offset);
            } else if (coinFlip < 0.7) {
                // 2. ë‹¤ë¥¸ 10ë‹¨ ë‹¨ìœ„ì˜ ë¬´ì‘ìœ„ ê³±ì…ˆ ê²°ê³¼ ìƒì„±
                const w1 = (Math.floor(Math.random() * 9) + 1) * 10;
                const w2 = (Math.floor(Math.random() * 9) + 1) * 10;
                wrong = w1 * w2;
            } else {
                // 3. ìˆ«ìê°€ ë¹„ìŠ·í•´ ë³´ì´ë„ë¡ ì •ë‹µì— 10ì„ ë”í•˜ê±°ë‚˜ ëº€ ê²°ê³¼
                wrong = a + (Math.random() < 0.5 ? 10 : -10);
            }

            if (wrong > 0 && wrong !== a) {
                s.add(wrong);
            }
        }

        // ë³´ê¸° ì„ê¸° ë° ë°°ì—´ ë³€í™˜
        const choices = Array.from(s).sort(() => Math.random() - 0.5);

        return {
            q,
            a,
            explain: "í° ìˆ˜ì˜ ê³±ì…ˆì„ í•´ë³´ì!",
            choices
        };
    }

    /* =========================================
     * GHOST BATTLE SYSTEM
     * ========================================= */
    function buildGhostPayload() {
        const best = getBestAdventureRecord();
        const charData = getCharData();

        if (best) {
            const payloadFromBest = buildGhostPayloadFromHofRecord(best);
            if (payloadFromBest) return payloadFromBest;
        }

        const starterId = getStarterId();
        if (!starterId) {
            showAlert("ê³µìœ í•  ê¸°ë¡ ì—†ìŒ", "ë¨¼ì € ìŠ¤íƒ€í„°ë¥¼ ì„ íƒí•˜ê³  ëª¨í—˜ì„ í•œ ë²ˆ ì´ìƒ í”Œë ˆì´í•´ ì£¼ì„¸ìš”.");
            return null;
        }

        const pid = starterId;
        const info = getPokeInfo(pid);
        const dupes = getDupes()[pid] || 0;
        const cData = charData[pid] || {};
        const level = Math.max(1 + dupes, cData.level || 1);
        const xp = cData.xp || 0;

        let bestStage = 0;
        const hofList = getHoF();
        hofList.forEach((rec) => {
            if (rec.name === info.name && typeof rec.stage === "number" && rec.stage > bestStage) {
                bestStage = rec.stage;
            }
        });

        const ghost = { v: 1, game: "QuizMonPRL", speciesId: pid, name: info.name, level, xp, bestStage, ts: Date.now() };
        const token = toBase64UTF8(ghost);
        const url = `${GHOST_ROOT_URL}?ghost=${encodeURIComponent(token)}`;
        return { ghost, encoded: url };
    }

    function buildGhostPayloadFromHofRecord(rec) {
        if (!rec) return null;
        let pid = rec.speciesId;

        if (!pid && rec.sprite) {
            try {
                const m = rec.sprite.match(/\/(\d+)\.(png|gif|jpg|jpeg)$/);
                if (m) pid = parseInt(m[1], 10);
            } catch (e) {}
        }

        if (!pid && rec.name) {
            const idx = POKE_NAMES.indexOf(rec.name);
            if (idx >= 0) pid = idx + 1;
        }

        if (!pid) return null;

        const info = getPokeInfo(pid);
        if (!info) return null;

        const level = typeof rec.level === "number" && rec.level > 0 ? rec.level : 1;
        const xp = 0;
        const bestStage = rec.stage || 0;

        const ghost = { v: 1, game: "QuizMonPRL", speciesId: pid, name: rec.name || info.name, level, xp, bestStage, ts: Date.now() };
        const token = toBase64UTF8(ghost);
        const url = `${GHOST_ROOT_URL}?ghost=${encodeURIComponent(token)}`;
        return { ghost, encoded: url };
    }

    function openGhostModal() {
        const modal = document.getElementById("ghostModal");
        if (!modal) return;

        switchGhostTab("my");

        const payload = buildGhostPayload();
        if (payload) {
            const summaryEl = document.getElementById("ghostMySummary");
            const canvas = document.getElementById("ghostQrCanvas");

            summaryEl.textContent = `${payload.ghost.name} Lv.${payload.ghost.level} (ìµœê³  ìŠ¤í…Œì´ì§€: ${payload.ghost.bestStage || "-"})`;

            if (window.QRCode && typeof QRCode.toCanvas === "function") {
                QRCode.toCanvas(canvas, payload.encoded, { width: 220, margin: 1 }, (err) => {
                    if (err) console.error("[Ghost QR] ìƒì„± ì˜¤ë¥˜", err);
                });
            }
        }

        modal.classList.remove("hidden");
        modal.classList.add("flex");
    }

    function openGhostModalFromHof(rec) {
        if (!rec) return;

        const payload = buildGhostPayloadFromHofRecord(rec);
        if (!payload) {
            alert("ì´ ê¸°ë¡ì—ëŠ” í¬ì¼“ëª¬ ì •ë³´ê°€ ì—†ì–´ QRì„ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const { ghost, encoded } = payload;
        const modal = document.getElementById("ghostModal");
        const summaryEl = document.getElementById("ghostMySummary");
        const canvas = document.getElementById("ghostQrCanvas");
        if (!modal || !summaryEl || !canvas) return;

        switchGhostTab("my");
        summaryEl.textContent = `ëª…ì˜ˆì˜ ì „ë‹¹ ê¸°ë¡: ${ghost.name} Lv.${ghost.level} (ìµœì¢… ìŠ¤í…Œì´ì§€ ${rec.stage || "-"})`;

        if (window.QRCode && typeof QRCode.toCanvas === "function") {
            QRCode.toCanvas(canvas, encoded, { width: 220, margin: 1 }, (err) => {
                if (err) console.error("[Ghost QR] ìƒì„± ì˜¤ë¥˜", err);
            });
        }

        modal.classList.remove("hidden");
        modal.classList.add("flex");
    }

    function closeGhostModal() {
        const modal = document.getElementById("ghostModal");
        if (!modal) return;
        stopGhostScan();
        modal.classList.add("hidden");
        modal.classList.remove("flex");
    }

    function switchGhostTab(tab) {
        const myBtn = document.getElementById("ghostTabMyBtn");
        const scanBtn = document.getElementById("ghostTabScanBtn");
        const myPane = document.getElementById("ghostMyPane");
        const scanPane = document.getElementById("ghostScanPane");

        if (tab === "my") {
            myBtn.className = "flex-1 text-xs font-bold rounded-full px-3 py-2 bg-slate-800 text-white";
            scanBtn.className = "flex-1 text-xs font-bold rounded-full px-3 py-2 bg-slate-100 text-slate-500";
            myPane.classList.remove("hidden");
            scanPane.classList.add("hidden");
            stopGhostScan();
        } else {
            scanBtn.className = "flex-1 text-xs font-bold rounded-full px-3 py-2 bg-slate-800 text-white";
            myBtn.className = "flex-1 text-xs font-bold rounded-full px-3 py-2 bg-slate-100 text-slate-500";
            scanPane.classList.remove("hidden");
            myPane.classList.add("hidden");
        }
    }

    function stopGhostScan() {
        if (ghostScanFrameId) {
            cancelAnimationFrame(ghostScanFrameId);
            ghostScanFrameId = null;
        }
        if (ghostScanStream) {
            ghostScanStream.getTracks().forEach((t) => t.stop());
            ghostScanStream = null;
        }
        const video = document.getElementById("ghostVideo");
        if (video) video.srcObject = null;
    }

    async function startGhostScan() {
        const statusEl = document.getElementById("ghostScanStatus");
        const video = document.getElementById("ghostVideo");

        if (!statusEl || !video) return;

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            statusEl.textContent = "ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¹´ë©”ë¼ ì‚¬ìš©ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
            return;
        }

        try {
            statusEl.textContent = "ì¹´ë©”ë¼ ì¤€ë¹„ ì¤‘...";
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
            ghostScanStream = stream;
            video.srcObject = stream;
            video.setAttribute("playsinline", "true");
            await video.play();
            statusEl.textContent = "QR ì½”ë“œì— ì¹´ë©”ë¼ë¥¼ ê°€ì ¸ê°€ ì£¼ì„¸ìš”.";
            ghostScanFrameId = requestAnimationFrame(tickGhostScan);
        } catch (err) {
            console.error("[Ghost Scan] ì¹´ë©”ë¼ ì˜¤ë¥˜", err);
            statusEl.textContent = "ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨: " + (err.message || err);
        }
    }

    function tickGhostScan() {
        const video = document.getElementById("ghostVideo");
        const canvas = document.getElementById("ghostScanCanvas");
        const statusEl = document.getElementById("ghostScanStatus");

        if (!video || !canvas || !statusEl || !ghostScanStream) return;

        const w = video.videoWidth;
        const h = video.videoHeight;

        if (!w || !h) {
            ghostScanFrameId = requestAnimationFrame(tickGhostScan);
            return;
        }

        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(video, 0, 0, w, h);
        const imageData = ctx.getImageData(0, 0, w, h);

        if (typeof jsQR === "function") {
            const code = jsQR(imageData.data, w, h);
            if (code && code.data) {
                statusEl.textContent = "QR ì¸ì‹ ì™„ë£Œ!";
                handleGhostPayload(code.data);
                stopGhostScan();
                return;
            }
        }

        ghostScanFrameId = requestAnimationFrame(tickGhostScan);
    }

    function parseGhostFromData(data) {
        if (typeof data !== "string") return null;

        try {
            if (data.startsWith("http")) {
                const url = new URL(data);
                const token = url.searchParams.get("ghost");
                if (token) {
                    const base64 = decodeURIComponent(token);
                    const jsonStr = fromBase64UTF8(base64);
                    return JSON.parse(jsonStr);
                }
            }

            if (data.startsWith("QZMGHOST|")) {
                const raw = data.split("|")[1];
                const jsonStr = fromBase64UTF8(raw);
                return JSON.parse(jsonStr);
            }

            return null;
        } catch (err) {
            console.error("[Ghost Payload] parse error", err);
            return null;
        }
    }

    function handleGhostPayload(data) {
        const ghost = parseGhostFromData(data);
        if (!ghost) {
            showAlert("ì¸ì‹ ì‹¤íŒ¨", "í€´ì¦ˆëª¬ ê³ ìŠ¤íŠ¸ QR ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤.");
            return;
        }
        startGhostBattle(ghost);
    }

    function showAlert(t, b) { alert(`${t}\n${b}`); }

    /* =========================================
     * ì´ˆê¸°í™”
     * ========================================= */
    window.onload = async () => {
        const loadingStatus = document.getElementById("loadingStatus");
        const startBtn = document.getElementById("startButton");

        loadingStatus.textContent = "í¬ì¼“ëª¬ ë°ì´í„° ë¡œë”© ì¤‘...";
        const dbLoaded = await loadPokeDb();

        if (dbLoaded) {
            loadingStatus.textContent = "í€´ì¦ˆ ë°ì´í„° ë¡œë”© ì¤‘...";
            await loadQuizData();
            loadingStatus.textContent = `âœ… ë¡œë“œ ì™„ë£Œ! (í¬ì¼“ëª¬ ${POKE_DB.pokemon.length}ê°œ, ê¸°ë³¸í˜• ${BASIC_POKEMON_IDS.length}ê°œ)`;
        } else {
            loadingStatus.textContent = "âš ï¸ DB ë¡œë“œ ì‹¤íŒ¨, ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©";
        }

        startBtn.disabled = false;

        tryImportFromIndex();
        updateResUI();
        updateLobbyPartner();

        document.getElementById("startButton").onclick = () => {
            document.getElementById("titleScreen").classList.remove("active");
            document.getElementById("lobbyScreen").classList.add("active");
        };
        document.getElementById("lobbyCodexBtn").onclick = () => {
            renderCodex();
            document.getElementById("lobbyScreen").classList.remove("active");
            document.getElementById("codexScreen").classList.add("active");
        };
        document.getElementById("codexToLobbyBtn").onclick = () => {
            document.getElementById("codexScreen").classList.remove("active");
            document.getElementById("lobbyScreen").classList.add("active");
        };

        // ë„ê° í˜ì´ì§€ë„¤ì´ì…˜
        document.getElementById("codexPrevBtn").onclick = codexPrevPage;
        document.getElementById("codexNextBtn").onclick = codexNextPage;

        document.getElementById("lobbyGachaBtn").onclick = () => { window.location.href = INDEX_PATCHED_URL; };
        if (GACHA_ENABLED) {
            const gm = document.getElementById("gachaModal");
            if (gm) {
                document.getElementById("gachaClose").onclick = () => gm.classList.add("hidden");
                document.getElementById("gacha1Btn").onclick = () => playGacha('normal');
                document.getElementById("gacha10Btn").onclick = () => playGacha('10x');
                document.getElementById("gachaSpecialBtn").onclick = () => playGacha('special');
            }
        } else {
            const gm = document.getElementById("gachaModal");
            if (gm) gm.classList.add("hidden");
        }

        document.getElementById("startAdventureBtn").onclick = initAdventure;
        document.getElementById("battleBackBtn").onclick = () => { if(confirm("í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) handleDefeat(); };
        document.getElementById("quizCancel").onclick = () => { document.getElementById("quizModal").classList.add("hidden"); if(quizCallback) quizCallback(false); };
        document.getElementById("lobbyHofBtn").onclick = () => { renderHoF(); document.getElementById("hofModal").classList.remove("hidden"); };
        document.getElementById("hofClose").onclick = () => document.getElementById("hofModal").classList.add("hidden");

        // ğŸ‘» ê³ ìŠ¤íŠ¸ ë°°í‹€ ë²„íŠ¼
        const ghostBtn = document.getElementById("lobbyGhostBtn");
        if (ghostBtn) ghostBtn.onclick = () => openGhostModal();

        const ghostClose = document.getElementById("ghostClose");
        if (ghostClose) ghostClose.onclick = () => closeGhostModal();

        const ghostTabMyBtn = document.getElementById("ghostTabMyBtn");
        const ghostTabScanBtn = document.getElementById("ghostTabScanBtn");
        if (ghostTabMyBtn) ghostTabMyBtn.onclick = () => switchGhostTab("my");
        if (ghostTabScanBtn) ghostTabScanBtn.onclick = () => switchGhostTab("scan");

        const ghostScanStartBtn = document.getElementById("ghostScanStartBtn");
        const ghostScanStopBtn = document.getElementById("ghostScanStopBtn");
        if (ghostScanStartBtn) ghostScanStartBtn.onclick = () => startGhostScan();
        if (ghostScanStopBtn) ghostScanStopBtn.onclick = () => stopGhostScan();

        const urlGhost = parseGhostFromData(window.location.href);
        if (urlGhost) {
            window.__pendingGhost = urlGhost;
            alert("ê³ ìŠ¤íŠ¸ ë°°í‹€ ì´ˆëŒ€ ë§í¬ì…ë‹ˆë‹¤!\në¨¼ì € ìŠ¤íƒ€í„°ë¥¼ ì„ íƒí•˜ë©´, ë°”ë¡œ ì´ ê³ ìŠ¤íŠ¸ì—ê²Œ ë„ì „í•  ìˆ˜ ìˆì–´ìš”.");
        }
    };
</script>

</body>
</html>
