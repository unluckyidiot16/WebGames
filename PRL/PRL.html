<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>QuizMon: Ver 7.1 Fix</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; touch-action: manipulation; }
        .view { display: none; }
        .view.active { display: flex; }
        .poke-card { transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .poke-card:active { transform: scale(0.95); }

        /* ë“±ê¸‰ë³„ ìŠ¤íƒ€ì¼ */
        .rarity-UR  { border: 2px solid #ef4444; background: linear-gradient(135deg, #fff0f0 0%, #ffe4e4 100%); box-shadow: 0 0 15px rgba(239, 68, 68, 0.5); }
        .rarity-SSR { border: 2px solid #f97316; background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%); }
        .rarity-SR  { border: 2px solid #eab308; background: #fefce8; }
        .rarity-R   { border: 2px solid #3b82f6; background: #eff6ff; }
        .rarity-C   { border: 1px solid #cbd5e1; background: #ffffff; }

        .modal-backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
        img.pixel-art { image-rendering: pixelated; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        @keyframes damageShake { 0% { transform: translateX(0); } 20% { transform: translateX(-6px) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); } 40% { transform: translateX(6px) rotate(5deg); } 60% { transform: translateX(-3px); } 80% { transform: translateX(3px); } }
        .animate-damage { animation: damageShake 0.4s ease-in-out; }
        .animate-attack-player { animation: attackRight 0.2s ease-out; }
        .animate-attack-enemy { animation: attackLeft 0.2s ease-out; }
        @keyframes attackRight { 0% { transform: translateX(0) scaleX(-1); } 50% { transform: translateX(30px) scaleX(-1); } 100% { transform: translateX(0) scaleX(-1); } }
        @keyframes attackLeft { 0% { transform: translateX(0); } 50% { transform: translateX(-30px); } 100% { transform: translateX(0); } }

        .btn-cooldown { background-color: #f1f5f9 !important; border-color: #cbd5e1 !important; color: #94a3b8 !important; cursor: not-allowed; transform: none !important; box-shadow: none !important; }
        .skill-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 select-none">

<section id="titleScreen" class="view active flex-col items-center justify-center p-6 h-screen">
    <div class="mb-8 relative">
        <div class="absolute -top-10 -left-10 w-20 h-20 bg-purple-500 rounded-full blur-xl opacity-30 animate-pulse"></div>
        <h1 class="text-5xl md:text-6xl font-black text-slate-800 tracking-tighter relative z-10">
            <span class="text-red-500">Quiz</span>Mon
        </h1>
        <div class="text-right text-xs font-bold text-slate-400 mt-1">Ver 7.1 Fix</div>
    </div>
    <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-sm text-center border-4 border-slate-800">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/250.png" class="w-24 h-24 mx-auto pixel-art animate-bounce" alt="Ho-oh">
        <p class="text-slate-500 text-sm mb-6 font-medium">
            10ì—°ì°¨ ê¸°ëŠ¥ ì •ìƒí™”!<br>ê°•ë ¥í•œ ì ë“¤ê³¼ì˜ ìŠ¹ë¶€
        </p>
        <button id="startButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg text-lg transition-colors border-b-4 border-red-700 active:border-b-0 active:translate-y-1">
            ëª¨í—˜ ì‹œì‘í•˜ê¸°
        </button>
    </div>
</section>

<section id="lobbyScreen" class="view flex-col items-center justify-start p-4 min-h-screen overflow-y-auto">
    <div class="w-full max-w-md flex flex-col gap-4 mt-2">
        <div class="flex justify-between items-end px-2">
            <h2 class="text-3xl font-black text-slate-800">LOBBY</h2>
            <div class="flex gap-2">
                <div class="bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200 text-xs font-bold flex items-center gap-1">
                    <span class="text-yellow-500">ğŸ«</span><span id="ticketTextLobby">0</span>
                </div>
                <div class="bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200 text-xs font-bold flex items-center gap-1">
                    <span class="text-blue-500">P</span><span id="pointsTextLobby">0</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button id="lobbyCodexBtn" class="bg-white p-4 rounded-2xl shadow-sm border-2 border-slate-100 flex flex-col items-center gap-2 hover:border-emerald-400 transition-colors group">
                <div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center group-hover:bg-emerald-100"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="w-8 h-8 pixel-art opacity-80"></div>
                <div class="text-center"><div class="font-bold text-slate-700">ìŠ¤íƒ€í„° ì„ íƒ</div><div class="text-[10px] text-slate-400">ëª¨í—˜ ì¤€ë¹„</div></div>
            </button>
            <button id="lobbyGachaBtn" class="bg-white p-4 rounded-2xl shadow-sm border-2 border-slate-100 flex flex-col items-center gap-2 hover:border-indigo-400 transition-colors group">
                <div class="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center group-hover:bg-indigo-100"><img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" class="w-8 h-8 pixel-art opacity-80"></div>
                <div class="text-center"><div class="font-bold text-slate-700">ëª¬ìŠ¤í„° ì†Œí™˜</div><div class="text-[10px] text-slate-400">ë™ë£Œ ì˜ì…</div></div>
            </button>
            <button id="lobbyHofBtn" class="col-span-2 bg-white p-3 rounded-2xl shadow-sm border-2 border-slate-100 flex items-center justify-center gap-3 hover:border-yellow-400 transition-colors group">
                <div class="w-10 h-10 bg-yellow-50 rounded-full flex items-center justify-center group-hover:bg-yellow-100"><span class="text-xl">ğŸ†</span></div>
                <div class="text-left"><div class="font-bold text-slate-700">ëª…ì˜ˆì˜ ì „ë‹¹</div><div class="text-[10px] text-slate-400">ì—­ëŒ€ ìµœê³  ê¸°ë¡ ë³´ê¸°</div></div>
            </button>
        </div>

        <div class="bg-slate-800 rounded-2xl p-5 text-white shadow-lg relative overflow-hidden mt-2">
            <div class="relative z-10 flex justify-between items-center">
                <div>
                    <div class="text-xs text-slate-400 mb-1">ì„ íƒëœ ìŠ¤íƒ€í„°</div>
                    <div id="lobbyPartnerName" class="font-bold text-xl">ì—†ìŒ</div>
                    <div class="text-[10px] text-slate-400 mt-1 bg-slate-700 inline-block px-2 py-1 rounded" id="lobbyStartBonus">
                        ì„ íƒ í•„ìš”
                    </div>
                </div>
                <img id="lobbyPartnerImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="w-16 h-16 pixel-art bg-slate-700 rounded-full">
            </div>
        </div>
    </div>
</section>

<section id="codexScreen" class="view flex-col items-center h-screen bg-slate-50">
    <div class="w-full max-w-3xl flex flex-col h-full">
        <div class="flex-none p-4 bg-white border-b border-slate-200 flex items-center justify-between shadow-sm z-10">
            <h2 class="text-xl font-bold text-slate-800">ìŠ¤íƒ€í„° <span class="text-xs font-normal text-slate-400" id="collectionRate">0/251</span></h2>
            <button id="codexToLobbyBtn" class="text-xs font-bold px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">ë‚˜ê°€ê¸°</button>
        </div>
        <div class="flex-none p-4 bg-white border-t border-slate-200 order-last flex gap-3 items-center">
            <div class="flex-1"><div class="text-xs text-slate-400">ì„ íƒë¨</div><div id="partnerInfo" class="font-bold text-slate-800 text-sm truncate">ì—†ìŒ</div></div>
            <button id="startAdventureBtn" disabled class="bg-emerald-500 hover:bg-emerald-600 disabled:bg-slate-300 text-white font-bold py-3 px-6 rounded-xl shadow-md w-32">ëª¨í—˜ ì‹œì‘</button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
            <div id="codexGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 pb-4"></div>
        </div>
    </div>
</section>

<section id="battleScreen" class="view flex-col items-center justify-between h-screen bg-gradient-to-b from-sky-200 to-sky-100 relative overflow-hidden">
    <div class="absolute bottom-0 w-full h-1/3 bg-emerald-600 rounded-t-[50%] scale-150 translate-y-12 border-t-8 border-emerald-700 opacity-90"></div>
    <div class="w-full max-w-md p-4 flex justify-between items-start z-10">
        <button id="battleBackBtn" class="bg-white/80 backdrop-blur text-slate-700 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm">&larr; í¬ê¸°</button>
        <div class="bg-black/40 backdrop-blur text-white px-4 py-1.5 rounded-full text-xs font-bold">STAGE <span id="battleStageText" class="text-yellow-300 text-base ml-1">1</span></div>
    </div>
    <div class="w-full max-w-md flex-1 relative flex flex-col justify-center px-4 z-10 gap-8">
        <div class="flex flex-col items-end relative">
            <div class="bg-white/90 p-2 rounded-xl shadow-md mb-2 w-40 transform translate-x-2">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="enemyName" class="font-bold text-sm text-slate-800">?</span>
                    <span id="enemyLevel" class="text-[10px] text-slate-500">Lv.1</span>
                </div>
                <div id="enemyTypeBadge" class="text-[9px] text-white px-1.5 py-0.5 rounded mb-1 inline-block bg-gray-400">TYPE</div>
                <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden"><div id="enemyHpBar" class="h-full bg-red-500 transition-all duration-500" style="width: 100%"></div></div>
            </div>
            <img id="enemyImg" src="" class="w-32 h-32 pixel-art animate-bounce-slow drop-shadow-xl filter grayscale-0">
        </div>
        <div class="flex flex-col items-start relative mt-4">
            <img id="playerImg" src="" class="w-40 h-40 pixel-art drop-shadow-2xl scale-x-[-1]">
            <div class="bg-white/90 p-3 rounded-xl shadow-md w-44 -mt-4 z-20 transform -translate-x-2 border-l-4 border-emerald-500">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="playerName" class="font-bold text-sm text-slate-800">?</span>
                    <span id="playerLevel" class="text-[10px] text-slate-500">Lv.1</span>
                </div>
                <div class="flex justify-between text-[10px] text-slate-500 mb-0.5"><span>HP</span><span id="playerHpText">0/0</span></div>
                <div class="w-full h-2.5 bg-slate-200 rounded-full overflow-hidden"><div id="playerHpBar" class="h-full bg-emerald-500 transition-all duration-500" style="width: 100%"></div></div>
                <div class="w-full h-1 bg-slate-100 rounded-full mt-1 overflow-hidden"><div id="playerExpBar" class="h-full bg-sky-400 transition-all" style="width: 0%"></div></div>
            </div>
        </div>
    </div>
    <div class="w-full max-w-md bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-5 z-20">
        <div id="battleLog" class="text-xs text-slate-500 mb-3 h-6 overflow-y-hidden text-center italic">ì „íˆ¬ ì‹œì‘!</div>
        <div id="moveButtons" class="skill-grid"></div>
    </div>
</section>

<div id="hofModal" class="fixed inset-0 bg-slate-900 z-50 hidden flex-col items-center justify-center"><div class="w-full max-w-md bg-white p-6 rounded-2xl shadow-2xl m-4 max-h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-6"><h3 class="text-2xl font-black text-slate-800">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3><button id="hofClose" class="text-slate-400 font-bold">ë‹«ê¸°</button></div><div id="hofList" class="flex-1 overflow-y-auto space-y-3"></div></div></div>

<div id="gachaModal" class="fixed inset-0 bg-slate-900 z-50 hidden flex-col items-center justify-center">
    <div class="w-full max-w-lg p-6 flex flex-col h-full md:h-auto">
        <div class="flex justify-between items-center mb-6 text-white">
            <div><h3 class="text-2xl font-bold">ëª¬ìŠ¤í„° ì†Œí™˜</h3><p class="text-xs opacity-70" id="gachaResDisplay"></p></div>
            <button id="gachaClose" class="bg-white/20 rounded-full p-2">âœ•</button>
        </div>
        <div id="gachaScene" class="flex-1 bg-slate-800 rounded-2xl border border-slate-700 p-4 overflow-y-auto mb-4 min-h-[300px] flex items-center justify-center relative">
            <div id="gachaPlaceholder" class="text-center text-slate-500">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" class="w-24 h-24 mx-auto mb-4 opacity-20 grayscale">
                <p>ì†Œí™˜ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”</p>
            </div>
            <div id="gachaResultsGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-3 w-full hidden"></div>
        </div>
        <div class="grid grid-cols-3 gap-2 mb-2">
            <button id="gacha1Btn" class="bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1 text-xs">
                <span class="block opacity-80">100 P</span>1íšŒ ì†Œí™˜
            </button>
            <button id="gacha10Btn" class="bg-purple-600 hover:bg-purple-500 text-white py-3 rounded-xl shadow-lg border-b-4 border-purple-800 active:border-b-0 active:translate-y-1 text-xs">
                <span class="block opacity-80">900 P</span>10íšŒ ì†Œí™˜
            </button>
            <button id="gachaSpecialBtn" class="bg-yellow-500 hover:bg-yellow-400 text-white py-3 rounded-xl shadow-lg border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1 text-xs relative overflow-hidden">
                <div class="absolute inset-0 bg-white opacity-10 animate-pulse"></div>
                <span class="block opacity-80 font-bold text-yellow-900">ğŸ« í‹°ì¼“ 1</span>ì „ì„¤ ì†Œí™˜
            </button>
        </div>
        <p class="text-center text-[10px] text-slate-400">* ì¤‘ë³µ íšë“ ì‹œ ì‹œì‘ ê²½í—˜ì¹˜(ì ì¬ë ¥)ê°€ ìƒìŠ¹í•©ë‹ˆë‹¤.</p>
    </div>
</div>

<div id="quizModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden"><div class="bg-slate-800 p-4 text-white flex justify-between items-center"><h3 class="font-bold text-lg">ğŸ“ ìˆ˜í•™ í€´ì¦ˆ</h3><span class="text-xs bg-slate-700 px-2 py-1 rounded text-yellow-300">ì •ë‹µ ì‹œ ê³µê²©</span></div><div class="p-6"><div class="text-center mb-6"><p class="text-3xl font-black text-slate-800 tracking-wider" id="quizQuestion">?</p></div><div id="quizChoices" class="grid grid-cols-2 gap-3"></div></div><div class="bg-slate-50 p-3 text-center border-t"><button id="quizCancel" class="text-xs text-slate-400 underline">í¬ê¸°í•˜ê¸°</button></div></div></div>
<div id="rewardModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4"><div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center"><h3 class="text-2xl font-black text-slate-800 mb-2">VICTORY!</h3><div class="text-xs text-sky-600 font-bold mb-4 bg-sky-50 inline-block px-3 py-1 rounded-full">EXP <span id="rewardXpVal">0</span> íšë“!</div><p class="text-sm text-slate-500 mb-2" id="rewardTitle">ë³´ìƒì„ ì„ íƒí•˜ì„¸ìš”</p><div class="grid grid-cols-1 gap-3" id="rewardButtons"></div></div></div>
<div id="messageModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[60] p-6"><div class="bg-white rounded-xl shadow-xl w-full max-w-xs p-5 text-center"><h3 id="messageTitle" class="text-lg font-bold text-slate-800 mb-2">ì•Œë¦¼</h3><p id="messageBody" class="text-sm text-slate-600 mb-4 break-keep"></p><button id="messageOk" class="w-full py-2.5 rounded-lg bg-slate-800 text-white text-sm font-bold">í™•ì¸</button></div></div>

<script>
    /* =========================================
     * DATA & CONSTANTS (UPDATED)
     * ========================================= */
    const POKE_NAMES_STR = "ì´ìƒí•´ì”¨,ì´ìƒí•´í’€,ì´ìƒí•´ê½ƒ,íŒŒì´ë¦¬,ë¦¬ìë“œ,ë¦¬ìëª½,ê¼¬ë¶€ê¸°,ì–´ë‹ˆë¶€ê¸°,ê±°ë¶ì™•,ìºí„°í”¼,ë‹¨ë°ê¸°,ë²„í„°í”Œ,ë¿”ì¶©ì´,ë”±ì¶©ì´,ë…ì¹¨ë¶•,êµ¬êµ¬,í”¼ì£¤,í”¼ì£¤íˆ¬,ê¼¬ë ›,ë ˆíŠ¸ë¼,ê¹¨ë¹„ì°¸,ê¹¨ë¹„ë“œë¦´ì¡°,ì•„ë³´,ì•„ë³´í¬,í”¼ì¹´ì¸„,ë¼ì´ì¸„,ëª¨ë˜ë‘ì§€,ê³ ì§€,ë‹ˆë“œëŸ°â™€,ë‹ˆë“œë¦¬ë‚˜,ë‹ˆë“œí€¸,ë‹ˆë“œëŸ°â™‚,ë‹ˆë“œë¦¬ë…¸,ë‹ˆë“œí‚¹,ì‚ì‚,í”½ì‹œ,ì‹ìŠ¤í…Œì¼,ë‚˜ì¸í…Œì¼,í‘¸ë¦°,í‘¸í¬ë¦°,ì£¼ë±ƒ,ê³¨ë±ƒ,ëšœë²…ìµ¸,ëƒ„ìƒˆê¼¬,ë¼í”Œë ˆì‹œì•„,íŒŒë¼ìŠ¤,íŒŒë¼ì„¹íŠ¸,ì½˜íŒ¡,ë„ë‚˜ë¦¬,ë””ê·¸ë‹¤,ë‹¥íŠ¸ë¦¬ì˜¤,ë‚˜ì˜¹,í˜ë¥´ì‹œì˜¨,ê³ ë¼íŒŒë•,ê³¨ë•,ë§í‚¤,ì„±ì›ìˆ­,ê°€ë””,ìœˆë””,ë°œì±™ì´,ìŠˆë¥™ì±™ì´,ê°•ì±™ì´,ìºì´ì‹œ,ìœ¤ê²”ë¼,í›„ë”˜,ì•Œí†µëª¬,ê·¼ìœ¡ëª¬,ê´´ë ¥ëª¬,ëª¨ë‹¤í”¼,ìš°ì¸ ë™,ìš°ì¸ ë³´íŠ¸,ì™•ëˆˆí•´,ë…íŒŒë¦¬,ê¼¬ë§ˆëŒ,ë°êµ¬ë¦¬,ë”±êµ¬ë¦¬,í¬ë‹ˆíƒ€,ë‚ ìŒ©ë§ˆ,ì•¼ëˆ,ì•¼ë„ë€,ì½”ì¼,ë ˆì–´ì½”ì¼,íŒŒì˜¤ë¦¬,ë‘ë‘,ë‘íŠ¸ë¦¬ì˜¤,ì¥¬ì¥¬,ì¥¬ë ˆê³¤,ì§ˆí½ì´,ì§ˆë»ê¸°,ì…€ëŸ¬,íŒŒë¥´ì…€,ê³ ì˜¤ìŠ¤,ê³ ìš°ìŠ¤íŠ¸,íŒ¬í…€,ë¡±ìŠ¤í†¤,ìŠ¬ë¦¬í”„,ìŠ¬ë¦¬í¼,í¬ë©,í‚¹í¬ë©,ì°Œë¦¬ë¦¬ê³µ,ë¶ë³¼,ì•„ë¼ë¦¬,ë‚˜ì‹œ,íƒ•êµ¬ë¦¬,í……êµ¬ë¦¬,ì‹œë¼ì†Œëª¬,í™ìˆ˜ëª¬,ë‚´ë£¨ë¯¸,ë˜ê°€ìŠ¤,ë˜ë„ê°€ìŠ¤,ë¿”ì¹´ë…¸,ì½”ë¿Œë¦¬,ëŸ­í‚¤,ë©ì¿ ë¦¬,ìº¥ì¹´,ì˜ë“œë¼,ì‹œë“œë¼,ì½˜ì¹˜,ì™•ì½˜ì¹˜,ë³„ê°€ì‚¬ë¦¬,ì•„ì¿ ìŠ¤íƒ€,ë§ˆì„ë§¨,ìŠ¤í„±,ë£¨ì£¼ë¼,ì—ë ˆë¸Œ,ë§ˆê·¸ë§ˆ,ì˜ì‚¬ì´ì €,ì¼„íƒ€ë¡œìŠ¤,ì‰ì–´í‚¹,ê°¸ë¼ë„ìŠ¤,ë¼í”„ë¼ìŠ¤,ë©”íƒ€ëª½,ì´ë¸Œì´,ìƒ¤ë¯¸ë“œ,ì¥¬í”¼ì¬ë”,ë¶€ìŠ¤í„°,í´ë¦¬ê³¤,ì•”ë‚˜ì´íŠ¸,ì•”ìŠ¤íƒ€,íˆ¬êµ¬,íˆ¬êµ¬í‘¸ìŠ¤,í”„í…Œë¼,ì ë§Œë³´,í”„ë¦¬ì ¸,ì¬ë”,íŒŒì´ì–´,ë¯¸ë‡½,ì‹ ë‡½,ë§ë‚˜ë‡½,ë®¤ì¸ ,ë®¤,ì¹˜ì½”ë¦¬íƒ€,ë² ì´ë¦¬í”„,ë©”ê°€ë‹ˆì›€,ë¸Œì¼€ì¸,ë§ˆê·¸ì¼€ì¸,ë¸”ë ˆì´ë²”,ë¦¬ì•„ì½”,ì—˜ë¦¬ê²Œì´,ì¥í¬ë¡œë‹¤ì¼,ê¼¬ë¦¬ì„ ,ë‹¤ê¼¬ë¦¬,ë¶€ìš°ë¶€,ì•¼ë¶€ì—‰,ë ˆë””ë°”,ë ˆë””ì•ˆ,í˜ì´ê²€,ì•„ë¦¬ì•„ë„ìŠ¤,í¬ë¡œë±ƒ,ì´ˆë¼ê¸°,ëœí„´,í”¼ì¸„,ì‚,í‘¸í‘¸ë¦°,í† ê²Œí”¼,í† ê²Œí‹±,ë„¤ì´í‹°,ë„¤ì´í‹°ì˜¤,ë©”ë¦¬í”„,ë³´ì†¡ì†¡,ì „ë£¡,ì•„ë¥´ì½”,ë§ˆë¦´,ë§ˆë¦´ë¦¬,ê¼¬ì§€ëª¨,ì™•êµ¬ë¦¬,í†µí†µì½”,ë‘ì½”,ì†œì†œì½”,ì—ì´íŒœ,í•´ë„ˆì¸ ,í•´ë£¨ë¯¸,ì™•ìë¦¬,ìš°íŒŒ,ëˆ„ì˜¤,ì—ë¸Œì´,ë¸”ë˜í‚¤,ë‹ˆë¡œìš°,ì•¼ë„í‚¹,ë¬´ìš°ë§ˆ,ì•ˆë†,ë§ˆììš©,í‚¤ë§í‚¤,í”¼ì½˜,ì˜ì½˜,ë…¸ê³ ì¹˜,ê¸€ë¼ì´ê±°,ê°•ì² í†¤,ë¸”ë£¨,ê·¸ë‘ë¸”ë£¨,ì¹¨ë°”ë£¨,í•«ì‚¼,ë‹¨ë‹¨ì§€,í—¤ë¼í¬ë¡œìŠ¤,í¬ë‰´ë¼,ê¹œì§€ê³°,ë§ê³°,ë§ˆê·¸ë§ˆê·¸,ë§ˆê·¸ì¹´ë¥´ê³ ,ê¾¸ê¾¸ë¦¬,ë©”ê¾¸ë¦¬,ì½”ì‚°í˜¸,ì´ì–´,ëŒ€í¬ë¬´ë…¸,ë”œë¦¬ë²„ë“œ,ë§Œíƒ€ì¸,ë¬´ì¥ì¡°,ë¸ë¹Œ,í—¬ê°€,í‚¹ë“œë¼,ì½”íŒ,ì½”ë¦¬ê°‘,í´ë¦¬ê³¤2,ë…¸ë¼í‚¤,ë£¨ë¸Œë„,ë°°ë£¨í‚¤,ì¹´í¬ì—ë¼,ë½€ë½€ë¼,ì—ë ˆí‚¤ë“œ,ë§ˆê·¸ë¹„,ë°€íƒ±í¬,í•´í”¼ë„ˆìŠ¤,ë¼ì´ì½”,ì•¤í…Œì´,ìŠ¤ì´ì¿¤,ì• ë²„ë¼ìŠ¤,ë°ê¸°ë¼ìŠ¤,ë§ˆê¸°ë¼ìŠ¤,ë£¨ê¸°ì•„,ì¹ ìƒ‰ì¡°,ì„¸ë ˆë¹„";
    const POKE_NAMES = POKE_NAMES_STR.split(",");

    // [ë³€ê²½] ëª¨ë“  1~251ë²ˆ í¬ì¼“ëª¬ì˜ ì‹¤ì œ ì¢…ì¡±ê°’ ë°ì´í„° (H,A,B,C,D,S ìˆœì„œ)
    // ë°ì´í„° ì••ì¶•ì„ ìœ„í•´ ë°°ì—´ë¡œ ì„ ì–¸
    const ALL_STATS_DB = [
        [45,49,49,65,65,45],[60,62,63,80,80,60],[80,82,83,100,100,80],[39,52,43,60,50,65],[58,64,58,80,65,80],[78,84,78,109,85,100],[44,48,65,50,64,43],[59,63,80,65,80,58],[79,83,100,85,105,78],[45,30,35,20,20,45],
        [50,20,55,25,25,30],[60,45,50,90,80,70],[40,35,30,20,20,50],[45,25,50,25,25,35],[65,90,40,45,80,75],[40,45,40,35,35,56],[63,60,55,50,50,71],[83,80,75,70,70,101],[30,56,35,25,35,72],[55,81,60,50,70,97],
        [40,60,30,31,31,70],[65,90,65,61,61,100],[35,60,44,40,54,55],[60,95,69,65,79,80],[35,55,40,50,50,90],[60,90,55,90,80,110],[50,75,85,20,30,40],[75,100,110,45,55,65],[55,47,52,40,40,41],[70,62,67,55,55,56],
        [90,92,87,75,85,76],[46,57,40,40,40,50],[61,72,57,55,55,65],[81,102,77,85,75,85],[70,45,48,60,65,35],[95,70,73,95,90,60],[38,41,40,50,65,65],[73,76,75,81,100,100],[115,45,20,45,25,20],[140,70,45,85,50,45],
        [40,45,35,30,40,55],[75,80,70,65,75,90],[45,50,55,75,65,30],[60,65,70,85,75,40],[75,80,85,110,90,50],[35,70,55,45,55,25],[60,95,80,60,80,30],[60,55,50,40,55,45],[70,65,60,90,75,90],[10,55,25,35,45,95],
        [35,100,50,50,70,120],[40,45,35,40,40,90],[65,70,60,65,65,115],[50,52,48,65,50,55],[80,82,78,95,80,85],[40,80,35,35,45,70],[65,105,60,60,70,95],[55,70,45,70,50,60],[90,110,80,100,80,95],[40,50,40,40,40,90],
        [65,65,65,50,50,90],[90,95,95,70,90,70],[25,20,15,105,55,90],[40,35,30,120,70,105],[55,50,45,135,95,120],[70,80,50,35,35,35],[80,100,70,50,60,45],[90,130,80,65,85,55],[50,75,35,70,30,40],[65,90,50,85,45,55],
        [80,105,65,100,70,70],[40,40,35,100,100,70],[80,70,65,80,120,100],[40,80,100,30,30,20],[55,95,115,45,45,35],[80,120,130,55,65,45],[50,85,55,65,65,90],[65,100,70,80,80,105],[90,65,65,40,40,15],[95,75,110,100,80,30],
        [25,35,70,95,55,45],[50,60,95,120,70,70],[52,90,55,58,62,60],[35,85,45,35,35,75],[60,110,70,60,60,110],[65,45,55,45,70,45],[90,70,80,70,95,70],[80,80,50,40,50,25],[105,105,75,65,100,50],[30,65,100,45,25,40],
        [50,95,180,85,45,70],[30,35,30,100,35,80],[45,50,45,115,55,95],[60,65,60,130,75,110],[35,45,160,30,45,70],[60,48,45,43,90,42],[85,73,70,73,115,67],[30,105,90,25,25,50],[55,130,115,50,50,75],[40,30,50,55,55,100],
        [60,50,70,80,80,150],[60,40,80,60,45,40],[95,95,85,125,75,55],[50,50,95,40,50,35],[60,80,110,50,80,45],[50,120,53,35,110,87],[50,105,79,35,110,76],[90,55,75,60,75,30],[40,65,95,60,45,35],[65,90,120,85,70,60],
        [80,85,95,30,30,25],[105,130,120,45,45,40],[250,5,5,35,105,50],[65,55,115,100,40,60],[90,95,80,40,80,90],[30,40,70,70,25,60],[55,65,95,95,45,85],[45,67,60,35,50,63],[80,92,65,65,80,68],[30,45,55,70,55,85],
        [60,75,85,100,85,115],[40,45,65,100,120,90],[70,110,70,60,60,70],[65,50,35,115,95,95],[65,83,57,95,85,105],[65,95,57,100,85,93],[65,125,100,55,70,85],[75,100,95,40,70,110],[20,10,55,15,20,80],[95,125,79,60,100,81],
        [130,85,80,85,95,60],[48,48,48,48,48,48],[55,55,50,45,65,55],[130,65,60,110,95,65],[65,65,60,110,95,130],[65,130,60,95,110,65],[65,60,70,85,75,40],[35,40,100,90,55,35],[70,60,125,115,70,55],[30,80,90,55,45,55],
        [60,115,105,65,70,80],[80,105,65,60,75,130],[160,110,65,65,110,30],[90,85,100,95,125,85],[90,90,85,125,90,100],[90,100,90,125,85,90],[41,64,45,50,50,50],[61,84,65,70,70,70],[91,134,95,100,100,80],[106,110,90,154,90,130],
        [100,100,100,100,100,100],[45,49,65,49,65,45],[60,62,80,63,80,60],[80,82,100,83,100,80],[39,52,43,60,50,65],[58,64,58,80,65,80],[78,84,78,109,85,100],[50,65,64,44,48,43],[65,80,80,59,63,58],[85,105,100,79,83,78],
        [35,46,34,35,45,20],[55,76,64,45,55,90],[60,30,30,36,56,50],[100,50,50,86,96,70],[40,35,30,40,80,85],[55,35,50,55,110,85],[40,60,40,40,40,70],[70,90,70,60,60,40],[85,90,80,70,80,130],[75,38,38,56,56,67],[125,58,58,76,76,67],
        [20,40,15,35,35,60],[50,25,28,45,55,15],[90,30,15,40,20,15],[35,20,65,40,65,20],[55,40,85,80,105,40],[40,50,45,70,45,70],[65,75,70,95,70,95],[55,40,40,65,45,35],[70,55,55,80,60,45],[90,75,85,115,90,55],
        [75,80,95,90,100,70],[70,20,50,20,50,40],[100,50,80,60,80,50],[70,100,115,30,65,30],[90,75,75,90,100,70],[35,35,40,35,55,30],[55,55,55,45,65,55],[75,55,70,55,95,110],[55,70,55,40,55,85],[30,30,30,30,30,30],
        [75,75,55,105,85,30],[65,65,45,75,45,95],[55,45,45,25,25,15],[95,85,85,65,65,35],[65,65,60,130,95,110],[95,65,110,60,130,65],[60,85,42,85,42,91],[95,75,80,100,110,30],[60,60,60,85,85,85],[48,35,48,35,48,35],
        [190,33,58,33,58,33],[70,80,65,90,65,60],[50,65,90,35,35,15],[75,90,140,60,60,40],[100,70,70,65,65,45],[65,75,105,35,65,85],[75,85,200,55,65,30],[60,80,50,40,40,30],[90,120,75,60,60,45],[65,95,75,55,55,85],
        [70,130,100,55,80,65],[20,10,230,10,230,5],[80,125,75,40,95,85],[55,95,55,35,75,115],[60,80,50,50,50,40],[90,130,75,75,75,55],[50,50,40,70,40,20],[60,50,120,90,80,30],[50,50,40,30,30,50],[100,100,80,60,60,50],
        [55,55,85,55,85,30],[65,65,45,75,45,75],[75,75,75,105,105,75],[45,55,45,65,45,75],[75,90,50,110,80,95],[65,90,140,70,70,70],[75,95,125,45,75,45],[85,80,90,105,95,60],[90,60,60,40,40,20],[85,105,85,65,65,115],
        [90,120,120,120,120,50],[73,95,62,85,65,85],[55,20,35,20,45,75],[50,95,95,35,110,70],[50,35,35,35,35,50],[45,63,37,65,55,95],[45,75,37,70,55,83],[95,80,105,40,70,100],[255,10,10,75,135,55],[90,85,75,115,100,115],
        [115,115,85,90,75,100],[100,75,115,90,115,85],[50,64,50,45,50,41],[70,84,70,65,70,51],[100,134,110,95,100,61],[106,90,130,90,154,110],[106,130,90,110,154,90],[100,100,100,100,100,100]
    ];

    const LEGENDARY_IDS = [144,145,146,150,243,244,245,249,250];
    const MYTHICAL_IDS = [151, 251];

    // íƒ€ì…ë³„ ë°ì´í„° ë° ìƒì„±
    const TYPE_DATA = {
        "í’€": { color: "bg-green-500", weak: ["ë¶ˆê½ƒ", "ë…", "ì–¼ìŒ", "ë¹„í–‰", "ë²Œë ˆ"], resist: ["ë¬¼", "ì „ê¸°", "í’€", "ë•…"] },
        "ë¶ˆê½ƒ": { color: "bg-red-500", weak: ["ë¬¼", "ë•…", "ë°”ìœ„"], resist: ["ë¶ˆê½ƒ", "í’€", "ì–¼ìŒ", "ë²Œë ˆ", "ê°•ì² "] },
        "ë¬¼": { color: "bg-blue-500", weak: ["ì „ê¸°", "í’€"], resist: ["ë¶ˆê½ƒ", "ë¬¼", "ì–¼ìŒ", "ê°•ì² "] },
        "ì „ê¸°": { color: "bg-yellow-400", weak: ["ë•…"], resist: ["ì „ê¸°", "ë¹„í–‰", "ê°•ì² "] },
        "ë…¸ë§": { color: "bg-stone-400", weak: ["ê²©íˆ¬"], resist: [] },
        "ì—ìŠ¤í¼": { color: "bg-pink-400", weak: ["ë²Œë ˆ", "ê³ ìŠ¤íŠ¸", "ì•…"], resist: ["ê²©íˆ¬", "ì—ìŠ¤í¼"] },
        "ê²©íˆ¬": { color: "bg-orange-600", weak: ["ë¹„í–‰", "ì—ìŠ¤í¼"], resist: ["ë²Œë ˆ", "ë°”ìœ„", "ì•…"] },
        "ë…": { color: "bg-purple-500", weak: ["ë•…", "ì—ìŠ¤í¼"], resist: ["í’€", "ê²©íˆ¬", "ë…", "ë²Œë ˆ"] },
    };
    const TYPE_KEYS = Object.keys(TYPE_DATA);

    // ë¬¼ë¦¬/íŠ¹ìˆ˜ ë¶„ë¥˜
    const PHYSICAL_TYPES = ["ë…¸ë§", "ê²©íˆ¬", "ë…", "ë•…", "ë¹„í–‰", "ë²Œë ˆ", "ë°”ìœ„", "ê³ ìŠ¤íŠ¸", "ê°•ì² "];
    const SPECIAL_TYPES = ["ë¶ˆê½ƒ", "ë¬¼", "í’€", "ì „ê¸°", "ì—ìŠ¤í¼", "ì–¼ìŒ", "ë“œë˜ê³¤", "ì•…"];

    // ê¸°ìˆ  ëª©ë¡
    const RAW_MOVES = {
        "í’€": [ {n:"ë©êµ´ì±„ì°",p:45,a:100}, {n:"ìë‚ ê°€ë¥´ê¸°",p:55,a:95}, {n:"ì—ë„ˆì§€ë³¼",p:90,a:100}, {n:"ê¸°ê°€ë“œë ˆì¸",p:75,a:100}, {n:"ì†”ë¼ë¹”",p:120,a:100}, {n:"ë¦¬í”„ìŠ¤í†°",p:130,a:90}, {n:"í•˜ë“œí”ŒëœíŠ¸",p:150,a:90}, {n:"ìš°ë“œí•´ë¨¸",p:120,a:100} ],
        "ë¶ˆê½ƒ": [ {n:"ë¶ˆê½ƒì„¸ë¡€",p:40,a:100}, {n:"ë¶ˆê½ƒí€ì¹˜",p:75,a:100}, {n:"í™”ì—¼ë°©ì‚¬",p:90,a:100}, {n:"ë¶ˆëŒ€ë¬¸ì",p:110,a:85}, {n:"ì˜¤ë²„íˆíŠ¸",p:130,a:90}, {n:"ë¸”ë¼ìŠ¤íŠ¸ë²ˆ",p:150,a:90}, {n:"í”Œë ˆì–´ë“œë¼ì´ë¸Œ",p:120,a:100}, {n:"ë¶„í™”",p:150,a:100} ],
        "ë¬¼": [ {n:"ë¬¼ëŒ€í¬",p:40,a:100}, {n:"ê±°í’ˆê´‘ì„ ",p:65,a:100}, {n:"íŒŒë„íƒ€ê¸°",p:90,a:100}, {n:"í•˜ì´ë“œë¡œíŒí”„",p:110,a:80}, {n:"í•˜ì´ë“œë¡œìºë…¼",p:150,a:90}, {n:"í•´ì¼",p:110,a:90}, {n:"í­í¬ì˜¤ë¥´ê¸°",p:80,a:100} ],
        "ì „ê¸°": [ {n:"ì „ê¸°ì‡¼í¬",p:40,a:100}, {n:"10ë§Œë³¼íŠ¸",p:90,a:100}, {n:"ë²ˆê°œí€ì¹˜",p:75,a:100}, {n:"ë²ˆê°œ",p:110,a:70}, {n:"ë³¼íŠ¸íƒœí´",p:120,a:100}, {n:"ë¼ì´ì§•ë³¼íŠ¸",p:70,a:100}, {n:"ë‡Œê²©",p:130,a:85} ],
        "ë…¸ë§": [ {n:"ëª¸í†µë°•ì¹˜ê¸°",p:40,a:100}, {n:"ì€í˜œê°šê¸°",p:102,a:100}, {n:"ëˆ„ë¥´ê¸°",p:85,a:100}, {n:"íŒŒê´´ê´‘ì„ ",p:150,a:90}, {n:"ê¸°ê°€ì„íŒ©íŠ¸",p:150,a:90}, {n:"ì´íŒì‚¬íŒíƒœí´",p:120,a:100} ],
        "ì—ìŠ¤í¼": [ {n:"ì—¼ë™ë ¥",p:50,a:100}, {n:"ì‚¬ì´ì½”í‚¤ë„¤ì‹œìŠ¤",p:90,a:100}, {n:"ë¯¸ë˜ì˜ˆì§€",p:120,a:100}, {n:"ê¿ˆë¨¹ê¸°",p:100,a:100}, {n:"ì‚¬ì´ì½”ë¶€ìŠ¤íŠ¸",p:140,a:90}, {n:"ì‚¬ì´ì½”ë¸Œë ˆì´í¬",p:100,a:100} ],
        "ê²©íˆ¬": [ {n:"ë§ˆí•˜í€ì¹˜",p:40,a:100}, {n:"ê¹¨íŠ¸ë¦¬ê¸°",p:75,a:100}, {n:"ì¸íŒŒì´íŠ¸",p:120,a:100}, {n:"ì—„ì²­ë‚œí˜",p:120,a:100}, {n:"ê¸°í•©êµ¬ìŠ¬",p:120,a:70}, {n:"ë¬´ë¦ì°¨ê¸°",p:130,a:90} ],
        "ë…": [ {n:"ë…ì¹¨",p:15,a:100}, {n:"ì˜¤ë¬¼í­íƒ„",p:90,a:100}, {n:"ë”ìŠ¤íŠ¸ìŠˆíŠ¸",p:120,a:80}, {n:"ë…ì°Œë¥´ê¸°",p:80,a:100}, {n:"í¬ë¡œìŠ¤í¬ì´ì¦Œ",p:70,a:100} ]
    };

    function calcMoveTier(m) {
        let t, c;
        if (m.p <= 60) { t="C"; c=0; }
        else if (m.p < 80) { t="R"; c=1; }
        else if (m.p < 110) { t="SR"; c=2; }
        else if (m.p < 140) { t="SSR"; c=3; }
        else { t="UR"; c=4; }
        return { ...m, t, c };
    }

    const MOVE_POOL = {};
    Object.keys(RAW_MOVES).forEach(k => { MOVE_POOL[k] = RAW_MOVES[k].map(m => calcMoveTier(m)); });

    function getMoveCategory(typeName) {
        if (PHYSICAL_TYPES.includes(typeName)) return "Physical";
        return "Special";
    }

    // [ìˆ˜ì •] ëœë¤ ìƒì„± í•¨ìˆ˜ ì œê±°ë¨ -> DB ì¡°íšŒë¡œ í†µí•©

    function getPokeInfo(id) {
        if (id > 251) id = (id % 251) + 1;
        const name = POKE_NAMES[id - 1] || `No.${id}`;

        // íƒ€ì… ê²°ì •
        let typeIdx = 4; // Default Normal
        const grass = [1,2,3,43,44,45,69,70,71,102,103,114, 152,153,154,182,187,188,189,191,192, 165, 166];
        const fire = [4,5,6,37,38,58,59,77,126,136,146, 155,156,157,218,219,228,229,240,244,250];
        const water = [7,8,9,54,55,60,61,62,86,87,90,91,98,99,116,117,118,119,120,121,129,130,131,134, 158,159,160,170,171,183,184,186,194,195,211,223,224,226,245,249];
        const electric = [25,26,81,82,100,101,125,135,145, 172,179,180,181,239,243];
        const psychic = [63,64,65,96,97,122,124,150,151, 177,178,196,199,201,202,203,249,251];
        const fighting = [56,57,66,67,68,106,107, 214,236,237];
        const poison = [13,14,15,23,24,29,30,31,32,33,34,41,42,88,89,109,110, 167,168,169,211];

        if (grass.includes(id)) typeIdx = 0; else if (fire.includes(id)) typeIdx = 1; else if (water.includes(id)) typeIdx = 2; else if (electric.includes(id)) typeIdx = 3; else if (psychic.includes(id)) typeIdx = 5; else if (fighting.includes(id)) typeIdx = 6; else if (poison.includes(id)) typeIdx = 7;

        // [ìˆ˜ì •] ì‹¤ì œ ìŠ¤íƒ¯ DBì—ì„œ ì¡°íšŒ
        const sData = ALL_STATS_DB[id - 1] || [45,45,45,45,45,45]; // Fallback
        const base = {
            h: sData[0], a: sData[1], d: sData[2],
            sa: sData[3], sd: sData[4], s: sData[5]
        };
        const bst = base.h + base.a + base.d + base.sa + base.sd + base.s;

        // ì¢…ì¡±ê°’(BST) ê¸°ë°˜ ë ˆì–´ë„ ì‚°ì • (ì‹¤ì œ ë°ì´í„° ê¸°ì¤€ì´ë¯€ë¡œ ë” ì •í™•í•¨)
        // 600ì¡±(ë§ë‚˜ë‡½, ë§ˆê¸°ë¼ìŠ¤ ë“±) -> UR
        // ì „ì„¤ -> UR
        // ìŠ¤íƒ€íŒ… ìµœì¢…ì§„í™”(ë¦¬ìëª½ ë“±) -> SSR
        let rarity = "C";
        if (bst >= 580) rarity = "UR";       // ì „ì„¤ ë° 600ì¡±
        else if (bst >= 500) rarity = "SSR"; // ë©”ì´ì € ìµœì¢… ì§„í™”ì²´
        else if (bst >= 400) rarity = "SR";  // ì¼ë°˜ì ì¸ ì§„í™”ì²´
        else if (bst >= 300) rarity = "R";   // ì´ˆê¸° ì§„í™”ì²´
        // 300 ë¯¸ë§Œì€ C (ë¯¸ì§„í™”ì²´ ë“±)

        const typeName = TYPE_KEYS[typeIdx];
        return { id, name, rarity, type: { name: typeName, ...TYPE_DATA[typeName] }, sprite: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`, base };
    }

    const TIER_ORDER = ['C', 'R', 'SR', 'SSR', 'UR'];

    function getRandomMoves(typeName, count, maxTierStr = 'UR') {
        const pool = MOVE_POOL[typeName] || MOVE_POOL["ë…¸ë§"];

        // [ìˆ˜ì •] maxTierStrë³´ë‹¤ ë‚®ê±°ë‚˜ ê°™ì€ ë“±ê¸‰ì˜ ê¸°ìˆ ë§Œ í•„í„°ë§
        const maxIdx = TIER_ORDER.indexOf(maxTierStr);
        const filtered = pool.filter(m => TIER_ORDER.indexOf(m.t) <= maxIdx);

        const res = [];
        if (filtered.length === 0) return res; // ì•ˆì „ì¥ì¹˜

        for(let i=0; i<count; i++) {
            // ëœë¤ ì„ íƒ
            res.push(filtered[Math.floor(Math.random() * filtered.length)]);
        }
        return res;
    }

    // [ìˆ˜ì •] ë³¸ê°€ ê³µì‹ ì°¸ì¡° ìŠ¤íƒ¯ ê³„ì‚° (IV=31, EV=0 ê°€ì •)
    // HP = ((2*Base + 31)*Lv)/100 + Lv + 10
    // Others = ((2*Base + 31)*Lv)/100 + 5
    function calcStats(base, level) {
        const calc = (b, isHp) => Math.floor(((2 * b + 31) * level) / 100) + (isHp ? level + 10 : 5);
        return {
            maxHp: calc(base.h, true),
            atk: calc(base.a, false),
            def: calc(base.d, false),
            spa: calc(base.sa, false),
            spd: calc(base.sd, false),
            spe: calc(base.s, false),
        };
    }

    /* =========================================
     * STATE & LOGIC
     * ========================================= */
    /* STATE & LOGIC ë¶€ë¶„ì˜ LS_KEY ìˆ˜ì • ë° í•¨ìˆ˜ ì¶”ê°€ */
    const LS_KEY = {
        POINTS: "qz_p_v72",
        OWNED: "qz_o_v72",
        PARTNER: "qz_st_v72",
        HOF: "qz_hof_v72",
        TICKETS: "qz_t_v72",
        DUPES: "qz_d_v72",
        CHAR_DATA: "qz_c_prog_v72" // [ì¶”ê°€] ìºë¦­í„°ë³„ ì„±ì¥ ë°ì´í„° ì €ì¥ í‚¤
    };

    // [ì¶”ê°€] ìºë¦­í„° ì„±ì¥ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    function getCharData() {
        try { return JSON.parse(localStorage.getItem(LS_KEY.CHAR_DATA) || "{}"); }
        catch { return {}; }
    }

    // [ì¶”ê°€] ìºë¦­í„° ì„±ì¥ ë°ì´í„° ì €ì¥í•˜ê¸°
    function saveCharData(data) {
        localStorage.setItem(LS_KEY.CHAR_DATA, JSON.stringify(data));
    }

    // [ì¶”ê°€] í˜„ì¬ í”Œë ˆì´ì–´ ìƒíƒœ(ë ˆë²¨, XP) ì €ì¥ í•¨ìˆ˜
    function saveCurrentPlayerProgress() {
        if (!battleState || !battleState.player) return;
        const allData = getCharData();

        // ìŠ¤í‚¬ì€ ì €ì¥í•˜ì§€ ì•ŠìŒ(ë¡œê·¸ë¼ì´íŠ¸: ë¹Œë“œ ì´ˆê¸°í™”), ë ˆë²¨ê³¼ XPë§Œ ì €ì¥
        allData[battleState.player.id] = {
            level: battleState.player.level,
            xp: battleState.player.xp
        };
        saveCharData(allData);
    }
    
    let battleState = null;
    let quizCallback = null;

    function getPoints() { return parseInt(localStorage.getItem(LS_KEY.POINTS) || "1000", 10); }
    function setPoints(n) { localStorage.setItem(LS_KEY.POINTS, Math.max(0, n)); updateResUI(); }
    function addPoints(n) { setPoints(getPoints() + n); }
    function getTickets() { return parseInt(localStorage.getItem(LS_KEY.TICKETS) || "0", 10); }
    function setTickets(n) { localStorage.setItem(LS_KEY.TICKETS, Math.max(0, n)); updateResUI(); }
    function addTickets(n) { setTickets(getTickets() + n); }
    function getOwned() { try { return new Set(JSON.parse(localStorage.getItem(LS_KEY.OWNED) || "[]")); } catch { return new Set(); } }
    function saveOwned(set) { localStorage.setItem(LS_KEY.OWNED, JSON.stringify([...set])); }
    function getDupes() { try { return JSON.parse(localStorage.getItem(LS_KEY.DUPES) || "{}"); } catch { return {}; } }
    function saveDupes(d) { localStorage.setItem(LS_KEY.DUPES, JSON.stringify(d)); }
    function getStarterId() { return parseInt(localStorage.getItem(LS_KEY.PARTNER) || "0"); }
    function setStarterId(id) { localStorage.setItem(LS_KEY.PARTNER, id); updateLobbyPartner(); }
    function getHoF() { try { return JSON.parse(localStorage.getItem(LS_KEY.HOF) || "[]"); } catch { return []; } }
    function addHoF(record) {
        const list = getHoF(); list.push(record); list.sort((a,b) => b.stage - a.stage);
        localStorage.setItem(LS_KEY.HOF, JSON.stringify(list.slice(0, 5)));
    }

    function updateResUI() {
        const p = getPoints().toLocaleString(), t = getTickets().toLocaleString();
        document.getElementById("pointsTextLobby").textContent = p;
        document.getElementById("ticketTextLobby").textContent = t;
        document.getElementById("gachaResDisplay").textContent = `P: ${p} / ğŸ«: ${t}`;
    }

    function updateLobbyPartner() {
        const pid = getStarterId();
        if (pid > 0) {
            const info = getPokeInfo(pid);
            const dupes = getDupes()[pid] || 0;
            const savedData = getCharData()[pid];

            // ì €ì¥ëœ ë ˆë²¨ì´ ìˆìœ¼ë©´ í‘œì‹œ, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’(1+ì¤‘ë³µ)
            const currentLv = savedData ? savedData.level : (1 + dupes);

            document.getElementById("lobbyPartnerName").textContent = info.name;
            document.getElementById("lobbyPartnerImg").src = info.sprite;
            document.getElementById("partnerInfo").textContent = info.name;

            // [ë³€ê²½] í˜„ì¬ ë ˆë²¨ ì •ë³´ í‘œì‹œ
            document.getElementById("lobbyStartBonus").textContent = `í˜„ì¬ Lv.${currentLv} (ì¤‘ë³µ +${dupes})`;
            document.getElementById("startAdventureBtn").disabled = false;
        } else {
            document.getElementById("lobbyPartnerName").textContent = "ì—†ìŒ";
            document.getElementById("partnerInfo").textContent = "ì„ íƒ í•„ìš”";
            document.getElementById("lobbyStartBonus").textContent = "ì„ íƒ í•„ìš”";
            document.getElementById("startAdventureBtn").disabled = true;
        }
    }

    function renderCodex() {
        const grid = document.getElementById("codexGrid"); grid.innerHTML = "";
        const owned = getOwned(), pid = getStarterId(), dupes = getDupes();
        let count = 0;
        for (let i = 1; i <= 251; i++) {
            const info = getPokeInfo(i);
            if(owned.has(i)) count++;
            const el = document.createElement("div");
            el.className = `poke-card relative rounded-xl p-2 flex flex-col items-center cursor-pointer rarity-${info.rarity}`;
            if (!owned.has(i)) el.classList.add("opacity-50", "grayscale");
            if (pid === i) el.classList.add("ring-4", "ring-emerald-400");
            const dupeCount = dupes[i] || 0;
            el.innerHTML = `<div class="absolute top-1 left-1 text-[9px] font-bold text-slate-400">#${String(i).padStart(3,'0')}</div>${dupeCount > 0 ? `<div class="absolute top-1 right-1 bg-red-500 text-white text-[8px] px-1 rounded-full">+${dupeCount}</div>` : ''}<div class="w-12 h-12 mt-2"><img src="${owned.has(i) ? info.sprite : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png'}" class="w-full h-full pixel-art object-contain ${!owned.has(i)?'opacity-20':''}"></div><div class="text-[10px] font-bold truncate mt-1">${owned.has(i) ? info.name : '???'}</div><div class="text-[8px] font-bold mt-0.5 ${info.rarity==='UR'?'text-red-500':info.rarity==='SSR'?'text-orange-500':'text-slate-400'}">${info.rarity}</div>`;
            el.onclick = () => { if(!owned.has(i)) { showAlert("ë¯¸ë³´ìœ ", "ê°€ì± ë¡œ ë¨¼ì € íšë“í•˜ì„¸ìš”."); return; } setStarterId(i); renderCodex(); };
            grid.appendChild(el);
        }
        document.getElementById("collectionRate").textContent = `${count}/251`;
    }

    function renderHoF() {
        const list = getHoF(), container = document.getElementById("hofList"); container.innerHTML = "";
        if(list.length === 0) { container.innerHTML = '<p class="text-center text-slate-400 py-10">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
        list.forEach((rec, idx) => {
            const div = document.createElement("div");
            div.className = "hof-item border-2 rounded-xl p-3 flex items-center gap-3 relative";
            div.innerHTML = `<div class="font-black text-2xl w-8 text-center text-slate-400 italic">#${idx+1}</div><img src="${rec.sprite}" class="w-12 h-12 pixel-art bg-white rounded-full border border-slate-200"><div class="flex-1"><div class="font-bold text-slate-800">${rec.name} <span class="text-xs font-normal text-slate-500">(${rec.date})</span></div><div class="text-xs text-slate-600">ìµœì¢… ìŠ¤í…Œì´ì§€: <span class="text-red-500 font-bold text-base">${rec.stage}</span></div></div>`;
            container.appendChild(div);
        });
    }

    /* =========================================
     * BATTLE SYSTEM (Updated)
     * ========================================= */
    function initAdventure() {
        const pid = getStarterId(); if (!pid) return;
        const info = getPokeInfo(pid);
        const dupes = getDupes()[pid] || 0;
        const savedData = getCharData()[pid];

        // [ë³€ê²½] ì €ì¥ëœ ë ˆë²¨ì´ ìˆìœ¼ë©´ ë¶ˆëŸ¬ì˜¤ê³ , ì—†ìœ¼ë©´ (1 + ì¤‘ë³µìˆ˜)ë¡œ ì‹œì‘
        let level = 1 + dupes;
        let xp = 0;

        if (savedData) {
            // ì €ì¥ëœ ë ˆë²¨ì´ ì¤‘ë³µ ë³´ë„ˆìŠ¤ë³´ë‹¤ ë‚®ì„ ê²½ìš°(ê±°ì˜ ì—†ê² ì§€ë§Œ) ë³´ì •
            level = Math.max(savedData.level, 1 + dupes);
            xp = savedData.xp;
        }

        // í•´ë‹¹ ë ˆë²¨ì— ë§ëŠ” ìŠ¤íƒ¯ ê³„ì‚°
        const stats = calcStats(info.base, level);

        // [ë¡œê·¸ë¼ì´íŠ¸ íŠ¹ì§•] ìŠ¤í‚¬ì€ ì´ˆê¸°í™” (ëœë¤ 2ê°œ) -> ë§¤ íŒ ìƒˆë¡œìš´ ì¡°í•© ì¬ë¯¸
        const startMoves = getRandomMoves(info.type.name, 2, 'C');

        battleState = {
            stage: 1, // ìŠ¤í…Œì´ì§€ëŠ” 1ë¶€í„° ë‹¤ì‹œ ì‹œì‘
            player: {
                id: pid, name: info.name, sprite: info.sprite, type: info.type.name,
                level: level, xp: xp,
                maxHp: stats.maxHp, hp: stats.maxHp,
                atk: stats.atk, def: stats.def, spa: stats.spa, spd: stats.spd, spe: stats.spe,
                base: info.base,
                moves: startMoves
            },
            cooldowns: [0, 0]
        };
        startBattleStage();
        document.getElementById("titleScreen").classList.remove("active");
        document.getElementById("codexScreen").classList.remove("active");
        document.getElementById("battleScreen").classList.add("active");
    }

    function startBattleStage() {
        const { stage, player } = battleState;

        // [ë³€ê²½] ì  ë ˆë²¨ ìŠ¤ì¼€ì¼ë§ ì¡°ì •
        // ìŠ¤í…Œì´ì§€ 1 -> Lv.1
        // ìŠ¤í…Œì´ì§€ 10 -> Lv.13
        // ìŠ¤í…Œì´ì§€ 30 -> Lv.40
        const eLevel = Math.floor(stage + (stage / 3));

        let enemyId;

        // [ì¶”ê°€] 5% í™•ë¥ ë¡œ ì „ì„¤ ë˜ëŠ” í™˜ìƒ í¬ì¼“ëª¬ ì¡°ìš°
        const isLegendaryEncounter = Math.random() < 0.05;

        if (isLegendaryEncounter) {
            // ì „ì„¤(LEGENDARY_IDS) + í™˜ìƒ(MYTHICAL_IDS) í•©ì¹œ ë°°ì—´ì—ì„œ ëœë¤ ì„ íƒ
            const legends = [...LEGENDARY_IDS, ...MYTHICAL_IDS];
            enemyId = legends[Math.floor(Math.random() * legends.length)];
        } else {
            // [ê¸°ì¡´ ë¡œì§] ì¼ë°˜ì ì¸ ìŠ¤í…Œì´ì§€ë³„ ë“±ê¸‰ ì œí•œ ì ìš©
            let allowedRarities = ['C'];
            if (stage >= 3) allowedRarities.push('R');
            if (stage >= 7) allowedRarities.push('SR');
            if (stage >= 12) allowedRarities.push('SSR');
            // ì „ì„¤ì€ ìœ„ 5% ë¡œì§ì—ì„œ ì²˜ë¦¬ë˜ë¯€ë¡œ ì¼ë°˜ í’€ì—ì„œëŠ” ì œì™¸í•˜ê±°ë‚˜ í™•ë¥  ë‚®ê²Œ ìœ ì§€
            // ì—¬ê¸°ì„œëŠ” 'UR'ì„ allowedRaritiesì— ë„£ì§€ ì•Šì•„, 5% ì°¬ìŠ¤ê°€ ì•„ë‹ˆë©´ ì „ì„¤ì´ ì•ˆ ë‚˜ì˜¤ê²Œ í•¨ (í¬ì†Œì„± ê°•í™”)

            // ë‚œì´ë„ ì¡°ì ˆ: ìŠ¤í…Œì´ì§€ê°€ ì˜¤ë¥´ë©´ ë‚®ì€ ë“±ê¸‰ ì œì™¸
            if (stage >= 10) allowedRarities = allowedRarities.filter(r => r !== 'C');
            if (stage >= 20) allowedRarities = allowedRarities.filter(r => r !== 'R');

            let safe = 0;
            do {
                enemyId = Math.floor(Math.random() * 251) + 1;
                const checkInfo = getPokeInfo(enemyId);
                // ì „ì„¤/í™˜ìƒ IDê°€ ì¼ë°˜ ë½‘ê¸°ì—ì„œ ë‚˜ì˜¤ë©´ ì œì™¸ (5% ì´ë²¤íŠ¸ë¡œë§Œ ë“±ì¥í•˜ê²Œ í•˜ë ¤ë©´)
                if (LEGENDARY_IDS.includes(enemyId) || MYTHICAL_IDS.includes(enemyId)) continue;

                if(allowedRarities.includes(checkInfo.rarity)) break;
                safe++;
            } while(safe < 200);

            // ì•ˆì „ì¥ì¹˜ (ë£¨í”„ ì‹¤íŒ¨ì‹œ ëœë¤)
            if (!enemyId) enemyId = Math.floor(Math.random() * 150) + 1;
        }

        const eInfo = getPokeInfo(enemyId);
        const eStats = calcStats(eInfo.base, eLevel);

        // ì  ìŠ¤í‚¬: ìì‹ ì˜ ë ˆì–´ë„ + 1ë‹¨ê³„ ê¸°ìˆ ê¹Œì§€ ì‚¬ìš©
        const currentTierIdx = TIER_ORDER.indexOf(eInfo.rarity);
        const maxSkillIdx = Math.min(TIER_ORDER.length - 1, currentTierIdx + 1);
        const maxSkillTier = TIER_ORDER[maxSkillIdx];

        const eMoves = getRandomMoves(eInfo.type.name, 1, maxSkillTier);

        battleState.enemy = {
            id: enemyId, name: eInfo.name, sprite: eInfo.sprite, type: eInfo.type.name,
            maxHp: eStats.maxHp, hp: eStats.maxHp,
            atk: eStats.atk, def: eStats.def, spa: eStats.spa, spd: eStats.spd, spe: eStats.spe,
            level: eLevel,
            move: eMoves[0], isBoss: eInfo.rarity === 'UR'
        };
        battleState.cooldowns = battleState.cooldowns.map(c => Math.max(0, c - 1));

        updateBattleUI();

        let msg = `ì•¼ìƒì˜ ${eInfo.name} (Lv.${eLevel}) ë“±ì¥!`;
        let type = 'normal';

        if (eInfo.rarity === 'UR') {
            // 5% ë‹¹ì²¨ ì‹œ ë©”ì‹œì§€ ê°•ì¡°
            msg = `âš¡ ì „ì„¤ì˜ í¬ì¼“ëª¬ ${eInfo.name} ì¶œí˜„!!`;
            type = 'critical';
        } else if (eInfo.rarity === 'SSR') {
            msg = `ê°•ì ! ${eInfo.name} (Lv.${eLevel}) ë“±ì¥!`;
            type = 'weak';
        }

        logBattle(msg, type);
    }

    function updateBattleUI() {
        const { player, enemy } = battleState;
        document.getElementById("battleStageText").textContent = battleState.stage;
        document.getElementById("playerName").textContent = player.name;
        document.getElementById("playerLevel").textContent = `Lv.${player.level}`;
        document.getElementById("playerImg").src = player.sprite;
        document.getElementById("playerHpText").textContent = `${Math.ceil(player.hp)}/${Math.ceil(player.maxHp)}`;
        document.getElementById("playerHpBar").style.width = `${Math.max(0, (player.hp/player.maxHp)*100)}%`;
        document.getElementById("playerExpBar").style.width = `${Math.min(100, (player.xp/(player.level*100))*100)}%`;

        document.getElementById("enemyName").textContent = enemy.name;
        document.getElementById("enemyLevel").textContent = `Lv.${enemy.level}`;
        document.getElementById("enemyImg").src = enemy.sprite;
        document.getElementById("enemyHpBar").style.width = `${Math.max(0, (enemy.hp/enemy.maxHp)*100)}%`;
        document.getElementById("enemyTypeBadge").textContent = enemy.type;
        document.getElementById("enemyTypeBadge").className = `text-[9px] text-white px-1.5 py-0.5 rounded mb-1 inline-block ${TYPE_DATA[enemy.type].color}`;

        const btnGrid = document.getElementById("moveButtons"); btnGrid.innerHTML = "";
        player.moves.forEach((m, idx) => {
            const btn = document.createElement("button");
            const cd = battleState.cooldowns[idx];
            const cat = getMoveCategory(player.type); // ìì‹ ì˜ íƒ€ì…ì— ë§ëŠ” ê¸°ìˆ ë§Œ ìˆë‹¤ê³  ê°€ì • (ë‹¨ìˆœí™”)
            let cls = "bg-white border-slate-200";
            let tColor = "text-slate-500";
            if(m.t === "UR") { cls = "bg-red-50 border-red-300"; tColor = "text-red-600"; }
            else if(m.t === "SSR") { cls = "bg-orange-50 border-orange-300"; tColor = "text-orange-600"; }
            else if(m.t === "SR") { cls = "bg-yellow-50 border-yellow-300"; tColor = "text-yellow-600"; }
            else if(m.t === "R") { cls = "bg-blue-50 border-blue-200"; tColor = "text-blue-600"; }

            if(cd > 0) cls = "btn-cooldown";
            btn.className = `${cls} border-b-4 rounded-xl py-2 flex flex-col items-center justify-center transition-all h-16 ${cd===0 ? 'hover:brightness-95 active:border-b-0 active:translate-y-1' : ''}`;

            // ë¬¼ë¦¬/íŠ¹ìˆ˜ í‘œê¸° ì¶”ê°€
            const isPhys = getMoveCategory(player.type) === "Physical"; // *ì£¼ì˜: í˜„ì¬ëŠ” í”Œë ˆì´ì–´ íƒ€ì… ê¸°ì¤€ìœ¼ë¡œ ê¸°ìˆ  ì¹´í…Œê³ ë¦¬ ê²°ì • (ë°ì´í„° í•œê³„ìƒ)
            // ë” ì •í™•íˆëŠ” ê¸°ìˆ ë³„ë¡œ ì§€ì •í•´ì•¼ í•˜ì§€ë§Œ, RAW_MOVES êµ¬ì¡°ìƒ í‚¤(Type)ë¡œ êµ¬ë¶„ ê°€ëŠ¥.
            // ì—¬ê¸°ì„  í¸ì˜ìƒ Move ë²„íŠ¼ ê·¸ë¦´ ë•Œ, í•´ë‹¹ ê¸°ìˆ ì˜ íƒ€ì…ì„ ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ(ê°ì²´ì— íƒ€ì… ì •ë³´ ëˆ„ë½ë¨) í”Œë ˆì´ì–´ íƒ€ì… ë”°ë¼ê°.
            // *ê°œì„ *: RAW_MOVES íŒŒì‹± ì‹œ typeì„ ë„£ì—ˆì–´ì•¼ í•¨. -> ì¼ë‹¨ í”Œë ˆì´ì–´ íƒ€ì… ê¸°ë°˜ìœ¼ë¡œ ì²˜ë¦¬.

            btn.innerHTML = `<span class="font-bold text-xs truncate w-full text-center">${m.n}</span><span class="text-[9px] ${cd > 0 ? 'text-slate-400' : tColor}">${cd > 0 ? `ì¿¨íƒ€ì„ ${cd}` : `${m.t}/${m.p} `}</span>`;
            btn.disabled = cd > 0;
            btn.onclick = () => handlePlayerMove(m, idx);
            btnGrid.appendChild(btn);
        });
    }

    function logBattle(msg, type="normal") {
        const log = document.getElementById("battleLog"); log.textContent = msg;
        log.className = `text-xs font-bold mb-3 h-6 text-center overflow-hidden ${type==='critical'?'text-red-500 animate-pulse': type==='weak'?'text-blue-500':'text-slate-500 italic'}`;
    }

    // ë°ë¯¸ì§€ ê³„ì‚° ê³µì‹ ì ìš©
    function calculateDamage(attacker, defender, move, moveType) {
        // 1. ì¹´í…Œê³ ë¦¬(ë¬¼ë¦¬/íŠ¹ìˆ˜) ê²°ì •
        const cat = getMoveCategory(moveType);

        // 2. ê³µê²©/ë°©ì–´ ìŠ¤íƒ¯ ê²°ì •
        let A, D;
        if (cat === "Physical") { A = attacker.atk; D = defender.def; }
        else { A = attacker.spa; D = defender.spd; }

        // 3. ë°ë¯¸ì§€ ê³µì‹ (ë³¸ê°€ 4ì„¸ëŒ€ ì´í›„ ê¸°ì¤€ ë³€í˜•)
        // Damage = ( ((2*Lv/5 + 2) * Power * A/D) / 50 + 2 ) * Modifiers
        let dmg = Math.floor( (( (2 * attacker.level / 5 + 2) * move.p * (A / D) ) / 50 + 2) );

        // 4. ìƒì„± ê³„ì‚°
        const typeInfo = TYPE_DATA[defender.type];
        let eff = 1.0;
        if (typeInfo.weak.includes(moveType)) eff = 2.0; // 2ë°°
        if (typeInfo.resist.includes(moveType)) eff = 0.5; // ë°˜ê°

        // 5. ìì† ë³´ì • (STAB)
        if (attacker.type === moveType) dmg *= 1.5;

        // 6. ëœë¤ ë‚œìˆ˜ (0.85 ~ 1.0)
        dmg = Math.floor(dmg * eff * (0.85 + Math.random() * 0.15));

        return { dmg, eff, cat };
    }

    function handlePlayerMove(move, idx) {
        openQuiz((isCorrect) => {
            if(!isCorrect) { logBattle("í€´ì¦ˆ ì˜¤ë‹µ! ê³µê²© ì‹¤íŒ¨!"); setTimeout(enemyTurn, 800); return; }
            battleState.cooldowns[idx] = move.c + 1;
            const el = document.getElementById("playerImg"); el.classList.remove("animate-attack-player"); void el.offsetWidth; el.classList.add("animate-attack-player");

            // í”Œë ˆì´ì–´ ê³µê²© (í”Œë ˆì´ì–´ íƒ€ì…ì˜ ê¸°ìˆ ë¡œ ê°„ì£¼)
            const { dmg, eff, cat } = calculateDamage(battleState.player, battleState.enemy, move, battleState.player.type);

            setTimeout(() => {
                battleState.enemy.hp -= dmg;
                const eImg = document.getElementById("enemyImg"); eImg.classList.remove("animate-damage"); void eImg.offsetWidth; eImg.classList.add("animate-damage");

                let msg = eff > 1 ? `ê¸‰ì†Œ! íš¨ê³¼ê°€ êµ‰ì¥í–ˆë‹¤! (${dmg})` : (eff < 1 ? `íš¨ê³¼ê°€ ë³„ë¡œë‹¤... (${dmg})` : `ëª…ì¤‘! (${dmg})`);
                logBattle(msg, eff > 1 ? 'critical' : (eff < 1 ? 'weak' : 'normal'));

                battleState.cooldowns = battleState.cooldowns.map(c => Math.max(0, c - 1));
                updateBattleUI();
                if(battleState.enemy.hp <= 0) setTimeout(handleWin, 800);
                else setTimeout(enemyTurn, 1000);
            }, 200);
        });
    }

    function enemyTurn() {
        if(battleState.enemy.hp <= 0) return;
        const eImg = document.getElementById("enemyImg"); eImg.classList.remove("animate-attack-enemy"); void eImg.offsetWidth; eImg.classList.add("animate-attack-enemy");

        const move = battleState.enemy.move;
        // ì  ê³µê²© (ì  íƒ€ì…ì˜ ê¸°ìˆ ë¡œ ê°„ì£¼)
        const { dmg, eff, cat } = calculateDamage(battleState.enemy, battleState.player, move, battleState.enemy.type);

        if(Math.random()*100 > 90) { setTimeout(() => { logBattle("ì ì˜ ê³µê²©ì´ ë¹—ë‚˜ê°”ë‹¤!"); }, 300); return; }

        setTimeout(() => {
            battleState.player.hp -= dmg;
            const pImg = document.getElementById("playerImg"); pImg.classList.remove("animate-damage"); void pImg.offsetWidth; pImg.classList.add("animate-damage");
            logBattle(`ì ì˜ ${move.n}! (${dmg})`);
            updateBattleUI();
            if(battleState.player.hp <= 0) setTimeout(handleDefeat, 800);
        }, 200);
    }

    function handleWin() {
        if(battleState.enemy.isBoss) { addTickets(1); alert("âœ¨ ì „ì„¤ ìŠ¹ë¦¬! [í™©ê¸ˆ í‹°ì¼“] íšë“!"); }
        const s = battleState.stage;
        const pt = Math.floor(50 + (s * 10) + (s * s * 0.5));
        const xp = 50 + (s * 10);

        addPoints(pt);
        battleState.player.xp += xp;

        let lvUp = false;
        if(battleState.player.xp >= battleState.player.level * 100) {
            battleState.player.xp -= battleState.player.level * 100;
            battleState.player.level++;

            // ë ˆë²¨ì—… ì‹œ ìŠ¤íƒ¯ ì¬ê³„ì‚°
            const newStats = calcStats(battleState.player.base, battleState.player.level);
            battleState.player.maxHp = newStats.maxHp;
            battleState.player.atk = newStats.atk;
            battleState.player.def = newStats.def;
            battleState.player.spa = newStats.spa;
            battleState.player.spd = newStats.spd;
            battleState.player.spe = newStats.spe;

            battleState.player.hp = battleState.player.maxHp;
            lvUp = true;
        }

        // [ì¶”ê°€] ìŠ¹ë¦¬í•  ë•Œë§ˆë‹¤ ë ˆë²¨/XP ì§„í–‰ìƒí™© ì˜êµ¬ ì €ì¥
        saveCurrentPlayerProgress();

        document.getElementById("rewardXpVal").textContent = `${xp}${lvUp?' & Level Up!':''}`;
        const grid = document.getElementById("rewardButtons"); grid.innerHTML = "";
        const isFullSlots = battleState.player.moves.length >= 4;

        [{ t: `í¬ì¸íŠ¸ +${pt} P`, d: "ê°€ì±  ì¬í™”", f: () => { nextStage(); }},
            { t: "ì™„ì „ íšŒë³µ", d: "HP 100%", f: () => { battleState.player.hp = battleState.player.maxHp; nextStage(); }},
            { t: "ê¸°ìˆ  ë¨¸ì‹ ", d: isFullSlots ? "ìŠ¤í‚¬ 1ê°œ êµì²´" : "ìŠ¤í‚¬ ì¶”ê°€ ìŠµë“", f: () => { if(isFullSlots) showSkillReplaceUI(); else addNewSkill(); }}]
            .forEach(r => {
                const btn = document.createElement("button");
                btn.className = "w-full py-3 bg-slate-100 hover:bg-indigo-50 border rounded-xl flex justify-between px-4 items-center";
                btn.innerHTML = `<span class="font-bold text-sm">${r.t}</span><span class="text-xs text-slate-500">${r.d}</span>`;
                btn.onclick = () => { if(r.t !== "ê¸°ìˆ  ë¨¸ì‹ ") document.getElementById("rewardModal").classList.add("hidden"); r.f(); };
                grid.appendChild(btn);
            });
        document.getElementById("rewardModal").classList.remove("hidden");
    }

    function addNewSkill() {
        const newMove = getRandomMoves(battleState.player.type, 1)[0];
        battleState.player.moves.push(newMove);
        battleState.cooldowns.push(0);
        document.getElementById("rewardModal").classList.add("hidden");
        alert(`[${newMove.n}] ê¸°ìˆ ì„ ìƒˆë¡œ ë°°ì› ìŠµë‹ˆë‹¤!`);
        nextStage();
    }

    function showSkillReplaceUI() {
        document.getElementById("rewardTitle").textContent = "êµì²´í•  ìŠ¤í‚¬ì„ ì„ íƒí•˜ì„¸ìš”";
        const grid = document.getElementById("rewardButtons"); grid.innerHTML = "";
        battleState.player.moves.forEach((m, idx) => {
            const btn = document.createElement("button");
            let cls = "bg-white border-slate-200";
            if(m.t === "UR") cls = "bg-red-50 border-red-300"; else if(m.t === "SSR") cls = "bg-orange-50 border-orange-300"; else if(m.t === "SR") cls = "bg-yellow-50 border-yellow-300"; else if(m.t === "R") cls = "bg-blue-50 border-blue-200";
            btn.className = `w-full py-2 ${cls} border rounded-xl hover:brightness-95 flex flex-col items-center`;
            btn.innerHTML = `<span class="font-bold text-sm">${m.n}</span><span class="text-[9px]">${m.t} / ì¿¨íƒ€ì„ ${m.c}</span>`;
            btn.onclick = () => {
                const newMove = getRandomMoves(battleState.player.type, 1)[0];
                battleState.player.moves[idx] = newMove;
                battleState.cooldowns[idx] = 0;
                document.getElementById("rewardModal").classList.add("hidden");
                alert(`[${newMove.n}] ìŠµë“ ì™„ë£Œ!`);
                nextStage();
            };
            grid.appendChild(btn);
        });
    }

    function nextStage() { battleState.stage++; startBattleStage(); }
    function handleDefeat() {
        addHoF({ name: battleState.player.name, sprite: battleState.player.sprite, stage: battleState.stage, date: new Date().toLocaleDateString() });
        alert(`ê²Œì„ ì˜¤ë²„! ìµœì¢… ìŠ¤í…Œì´ì§€: ${battleState.stage}`);
        document.getElementById("battleScreen").classList.remove("active");
        document.getElementById("lobbyScreen").classList.add("active");
        updateResUI();
    }

    function openQuiz(cb) {
        quizCallback = cb;
        const qData = generateMath();
        document.getElementById("quizQuestion").textContent = qData.q;
        const grid = document.getElementById("quizChoices"); grid.innerHTML = "";
        qData.choices.forEach(c => {
            const btn = document.createElement("button");
            btn.className = "bg-slate-100 hover:bg-sky-100 border-2 border-slate-200 font-bold py-4 rounded-xl text-lg";
            btn.textContent = c;
            btn.onclick = () => { document.getElementById("quizModal").classList.add("hidden"); if(quizCallback) quizCallback(c===qData.a); };
            grid.appendChild(btn);
        });
        document.getElementById("quizModal").classList.remove("hidden");
    }

    function generateMath() {
        // ì²« ë²ˆì§¸ ìˆ«ì (ë‹¨)ëŠ” 3~9 (2ë‹¨ ì œì™¸)
        // Math.random() * 7 ì€ 0.0 ~ 6.99... ì´ë¯€ë¡œ, + 3 í•˜ë©´ 3.0 ~ 9.99...
        const n1 = Math.floor(Math.random() * 7) + 3;

        // ë‘ ë²ˆì§¸ ìˆ«ì (ê³±í•´ì§€ëŠ” ìˆ˜)ëŠ” 1~9
        // Math.random() * 9 ëŠ” 0.0 ~ 8.99... ì´ë¯€ë¡œ, + 1 í•˜ë©´ 1.0 ~ 9.99...
        const n2 = Math.floor(Math.random() * 9) + 1;

        const a = n1 * n2;
        const q = `${n1} Ã— ${n2} = ?`;

        // ì •ë‹µì„ í¬í•¨í•œ 4ê°œì˜ ì„ íƒì§€ ìƒì„±
        const s = new Set([a]);
        while (s.size < 4) {
            // ì •ë‹µ ê·¼ì²˜ì˜ ì˜¤ë‹µ ìƒì„± (-4 ~ +4 ë²”ìœ„ì—ì„œ 0 ì œì™¸)
            let offset;
            do {
                // Math.floor(Math.random() * 9) - 4 ëŠ” -4ë¶€í„° 4ê¹Œì§€ì˜ ì •ìˆ˜ë¥¼ ìƒì„±
                offset = Math.floor(Math.random() * 9) - 4;
            } while (offset === 0);

            let f = a + offset;

            // ì •ë‹µì´ ì•„ë‹ˆë©°, ê²°ê³¼ê°€ 0ë³´ë‹¤ í° ê²½ìš°ë§Œ ì„ íƒì§€ë¡œ ì¶”ê°€
            if (f > 0 && f !== a) {
                s.add(f);
            }
        }

        // ë¬´ì‘ìœ„ë¡œ ì„ì¸ ì„ íƒì§€ ë°˜í™˜
        return {
            q,
            a,
            choices: Array.from(s).sort(() => Math.random() - 0.5)
        };
    }

    function playGacha(type) {
        let count = 1;
        if (type === '10x') { type = 'normal'; count = 10; }

        const costPer = type==='normal' ? 100 : 1;
        const totalCost = count === 10 ? 900 : costPer * count;
        const cur = type==='normal' ? getPoints() : getTickets();

        if(cur < totalCost){ alert("ì¬í™” ë¶€ì¡±!"); return; }
        if(type==='normal') setPoints(getPoints()-totalCost); else setTickets(getTickets()-totalCost);

        document.getElementById("gachaPlaceholder").classList.add("hidden");
        const grid = document.getElementById("gachaResultsGrid"); grid.classList.remove("hidden"); grid.innerHTML="";

        const owned = getOwned();
        const dupes = getDupes();

        for(let i=0; i<count; i++) {
            let pid;
            if(type==='special') pid = Math.random()<0.5 ? LEGENDARY_IDS[Math.floor(Math.random()*LEGENDARY_IDS.length)] : Math.floor(Math.random()*251)+1;
            else { do { pid = Math.floor(Math.random()*251)+1; } while(LEGENDARY_IDS.includes(pid)); }
            if(pid>251) pid=251;

            const info = getPokeInfo(pid);
            if (owned.has(pid)) { dupes[pid] = (dupes[pid] || 0) + 1; saveDupes(dupes); }
            else { owned.add(pid); saveOwned(owned); }

            const div = document.createElement("div");
            div.className = `flex flex-col items-center p-2 rounded-xl animate-[bounce_0.5s] ${info.rarity==='UR'?'bg-red-100 border border-red-400': info.rarity==='SSR'?'bg-orange-100 border-orange-400' : 'bg-slate-700'}`;
            div.innerHTML = `<img src="${info.sprite}" class="w-8 h-8 pixel-art"><div class="text-[8px] font-bold ${['UR','SSR','SR'].includes(info.rarity)?'text-black':'text-white'} truncate w-full text-center">${info.name}</div>`;
            grid.appendChild(div);
        }
        updateResUI(); renderCodex();
    }

    function showAlert(t,b){ alert(`${t}\n${b}`); }

    window.onload = () => {
        updateResUI();
        updateLobbyPartner();

        document.getElementById("startButton").onclick = () => { document.getElementById("titleScreen").classList.remove("active"); document.getElementById("lobbyScreen").classList.add("active"); };
        document.getElementById("lobbyCodexBtn").onclick = () => { renderCodex(); document.getElementById("lobbyScreen").classList.remove("active"); document.getElementById("codexScreen").classList.add("active"); };
        document.getElementById("codexToLobbyBtn").onclick = () => { document.getElementById("codexScreen").classList.remove("active"); document.getElementById("lobbyScreen").classList.add("active"); };

        document.getElementById("lobbyGachaBtn").onclick = () => document.getElementById("gachaModal").classList.remove("hidden");
        document.getElementById("gachaClose").onclick = () => document.getElementById("gachaModal").classList.add("hidden");

        document.getElementById("gacha1Btn").onclick = () => playGacha('normal');
        document.getElementById("gacha10Btn").onclick = () => playGacha('10x');
        document.getElementById("gachaSpecialBtn").onclick = () => playGacha('special');

        document.getElementById("startAdventureBtn").onclick = initAdventure;
        document.getElementById("battleBackBtn").onclick = () => { if(confirm("í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) handleDefeat(); };
        document.getElementById("quizCancel").onclick = () => { document.getElementById("quizModal").classList.add("hidden"); if(quizCallback) quizCallback(false); };
        document.getElementById("lobbyHofBtn").onclick = () => { renderHoF(); document.getElementById("hofModal").classList.remove("hidden"); };
        document.getElementById("hofClose").onclick = () => document.getElementById("hofModal").classList.add("hidden");
    };
</script>
</body>
</html>