<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>QuizMon: Roguelike 3.0</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Apple SD Gothic Neo", "Malgun Gothic", sans-serif; touch-action: manipulation; }
        .view { display: none; }
        .view.active { display: flex; }
        .poke-card { transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .poke-card:active { transform: scale(0.95); }

        /* ë“±ê¸‰ë³„ ìŠ¤íƒ€ì¼ */
        .rarity-SR { background: linear-gradient(135deg, #fff 0%, #fff7ed 100%); border: 2px solid #f59e0b; box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }
        .rarity-R  { border: 2px solid #60a5fa; background: #f0f9ff; }
        .rarity-C  { border: 1px solid #e2e8f0; background: #ffffff; }

        .modal-backdrop { background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        img.pixel-art { image-rendering: pixelated; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes damageShake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-6px) rotate(-5deg); filter: brightness(2) sepia(1) hue-rotate(-50deg) saturate(5); }
            40% { transform: translateX(6px) rotate(5deg); }
            60% { transform: translateX(-3px); }
            80% { transform: translateX(3px); }
        }
        .animate-damage { animation: damageShake 0.4s ease-in-out; }

        @keyframes attackRight { 0% { transform: translateX(0) scaleX(-1); } 50% { transform: translateX(30px) scaleX(-1); } 100% { transform: translateX(0) scaleX(-1); } }
        .animate-attack-player { animation: attackRight 0.2s ease-out; }

        @keyframes attackLeft { 0% { transform: translateX(0); } 50% { transform: translateX(-30px); } 100% { transform: translateX(0); } }
        .animate-attack-enemy { animation: attackLeft 0.2s ease-out; }

        .animate-bounce-slow { animation: bounce 2s infinite; }

        /* ëª…ì˜ˆì˜ ì „ë‹¹ ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .hof-item:nth-child(1) { border-color: #f59e0b; background: #fffbeb; } /* 1ë“± ê³¨ë“œ */
        .hof-item:nth-child(2) { border-color: #94a3b8; background: #f8fafc; } /* 2ë“± ì‹¤ë²„ */
        .hof-item:nth-child(3) { border-color: #b45309; background: #fff7ed; } /* 3ë“± ë¸Œë¡ ì¦ˆ */
    </style>
</head>
<body class="bg-slate-100 min-h-screen text-slate-800 select-none">

<section id="titleScreen" class="view active flex-col items-center justify-center p-6 h-screen">
    <div class="mb-8 relative">
        <div class="absolute -top-10 -left-10 w-20 h-20 bg-purple-500 rounded-full blur-xl opacity-30 animate-pulse"></div>
        <h1 class="text-5xl md:text-6xl font-black text-slate-800 tracking-tighter relative z-10">
            <span class="text-red-500">Quiz</span>Mon
        </h1>
        <div class="text-right text-xs font-bold text-slate-400 mt-1">Ver 3.0 Roguelike</div>
    </div>
    <div class="bg-white p-6 rounded-3xl shadow-xl w-full max-w-sm text-center border-4 border-slate-800">
        <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/25.png" class="w-24 h-24 mx-auto pixel-art animate-bounce" alt="Pikachu">
        <p class="text-slate-500 text-sm mb-6 font-medium">
            ë§¤ë²ˆ ìƒˆë¡œìš´ ëª¨í—˜!<br>
            ìµœê³  ìŠ¤í…Œì´ì§€ì— ë„ì „í•˜ì„¸ìš”.
        </p>
        <button id="startButton" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-4 rounded-xl shadow-lg text-lg transition-colors border-b-4 border-red-700 active:border-b-0 active:translate-y-1">
            ëª¨í—˜ ì‹œì‘í•˜ê¸°
        </button>
    </div>
</section>

<section id="lobbyScreen" class="view flex-col items-center justify-start p-4 min-h-screen overflow-y-auto">
    <div class="w-full max-w-md flex flex-col gap-4 mt-2">
        <div class="flex justify-between items-end px-2">
            <h2 class="text-3xl font-black text-slate-800">LOBBY</h2>
            <div class="flex gap-2">
                <div class="bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200 text-xs font-bold flex items-center gap-1">
                    <span class="text-yellow-500">ğŸ«</span>
                    <span id="ticketTextLobby">0</span>
                </div>
                <div class="bg-white px-3 py-1 rounded-full shadow-sm border border-slate-200 text-xs font-bold flex items-center gap-1">
                    <span class="text-blue-500">P</span>
                    <span id="pointsTextLobby">0</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button id="lobbyCodexBtn" class="bg-white p-4 rounded-2xl shadow-sm border-2 border-slate-100 flex flex-col items-center gap-2 hover:border-emerald-400 transition-colors group">
                <div class="w-12 h-12 bg-emerald-50 rounded-full flex items-center justify-center group-hover:bg-emerald-100">
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png" class="w-8 h-8 pixel-art opacity-80">
                </div>
                <div class="text-center">
                    <div class="font-bold text-slate-700">ìŠ¤íƒ€í„° ì„ íƒ</div>
                    <div class="text-[10px] text-slate-400">ëª¨í—˜ ì¤€ë¹„</div>
                </div>
            </button>

            <button id="lobbyGachaBtn" class="bg-white p-4 rounded-2xl shadow-sm border-2 border-slate-100 flex flex-col items-center gap-2 hover:border-indigo-400 transition-colors group">
                <div class="w-12 h-12 bg-indigo-50 rounded-full flex items-center justify-center group-hover:bg-indigo-100">
                    <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" class="w-8 h-8 pixel-art opacity-80">
                </div>
                <div class="text-center">
                    <div class="font-bold text-slate-700">ëª¬ìŠ¤í„° ì†Œí™˜</div>
                    <div class="text-[10px] text-slate-400">ë™ë£Œ ì˜ì…</div>
                </div>
            </button>

            <button id="lobbyHofBtn" class="col-span-2 bg-white p-3 rounded-2xl shadow-sm border-2 border-slate-100 flex items-center justify-center gap-3 hover:border-yellow-400 transition-colors group">
                <div class="w-10 h-10 bg-yellow-50 rounded-full flex items-center justify-center group-hover:bg-yellow-100">
                    <span class="text-xl">ğŸ†</span>
                </div>
                <div class="text-left">
                    <div class="font-bold text-slate-700">ëª…ì˜ˆì˜ ì „ë‹¹</div>
                    <div class="text-[10px] text-slate-400">ì—­ëŒ€ ìµœê³  ê¸°ë¡ ë³´ê¸°</div>
                </div>
            </button>
        </div>

        <div class="bg-slate-800 rounded-2xl p-5 text-white shadow-lg relative overflow-hidden mt-2">
            <div class="relative z-10 flex justify-between items-center">
                <div>
                    <div class="text-xs text-slate-400 mb-1">ì„ íƒëœ ìŠ¤íƒ€í„°</div>
                    <div id="lobbyPartnerName" class="font-bold text-xl">ì—†ìŒ</div>
                    <div class="text-[10px] text-slate-400 mt-1 bg-slate-700 inline-block px-2 py-1 rounded">
                        âš  ë§¤ íŒ Lv.1 ë¡œ ì´ˆê¸°í™”ë©ë‹ˆë‹¤
                    </div>
                </div>
                <img id="lobbyPartnerImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="w-16 h-16 pixel-art bg-slate-700 rounded-full">
            </div>
        </div>
    </div>
</section>

<section id="codexScreen" class="view flex-col items-center h-screen bg-slate-50">
    <div class="w-full max-w-3xl flex flex-col h-full">
        <div class="flex-none p-4 bg-white border-b border-slate-200 flex items-center justify-between shadow-sm z-10">
            <h2 class="text-xl font-bold text-slate-800">ìŠ¤íƒ€í„° ì„ íƒ <span class="text-xs font-normal text-slate-400" id="collectionRate">0/151</span></h2>
            <button id="codexToLobbyBtn" class="text-xs font-bold px-3 py-2 rounded-lg bg-slate-100 hover:bg-slate-200">ë‚˜ê°€ê¸°</button>
        </div>
        <div class="flex-none p-4 bg-white border-t border-slate-200 order-last flex gap-3 items-center">
            <div class="flex-1">
                <div class="text-xs text-slate-400">ì„ íƒë¨</div>
                <div id="partnerInfo" class="font-bold text-slate-800 text-sm truncate">ì—†ìŒ</div>
            </div>
            <button id="startAdventureBtn" disabled class="bg-emerald-500 hover:bg-emerald-600 disabled:bg-slate-300 text-white font-bold py-3 px-6 rounded-xl shadow-md w-32">
                ëª¨í—˜ ì‹œì‘
            </button>
        </div>
        <div class="flex-1 overflow-y-auto p-4 bg-slate-50">
            <div id="codexGrid" class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-5 gap-3 pb-4"></div>
        </div>
    </div>
</section>

<section id="battleScreen" class="view flex-col items-center justify-between h-screen bg-gradient-to-b from-sky-200 to-sky-100 relative overflow-hidden">
    <div class="absolute bottom-0 w-full h-1/3 bg-emerald-600 rounded-t-[50%] scale-150 translate-y-12 border-t-8 border-emerald-700 opacity-90"></div>
    <div class="w-full max-w-md p-4 flex justify-between items-start z-10">
        <button id="battleBackBtn" class="bg-white/80 backdrop-blur text-slate-700 px-3 py-1.5 rounded-full text-xs font-bold shadow-sm">&larr; í¬ê¸°</button>
        <div class="bg-black/40 backdrop-blur text-white px-4 py-1.5 rounded-full text-xs font-bold">STAGE <span id="battleStageText" class="text-yellow-300 text-base ml-1">1</span></div>
    </div>
    <div class="w-full max-w-md flex-1 relative flex flex-col justify-center px-4 z-10 gap-8">
        <div class="flex flex-col items-end relative">
            <div class="bg-white/90 p-2 rounded-xl shadow-md mb-2 w-40 transform translate-x-2">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="enemyName" class="font-bold text-sm text-slate-800">?</span>
                    <span id="enemyLevel" class="text-[10px] text-slate-500">Lv.1</span>
                </div>
                <div id="enemyTypeBadge" class="text-[9px] text-white px-1.5 py-0.5 rounded mb-1 inline-block bg-gray-400">TYPE</div>
                <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden"><div id="enemyHpBar" class="h-full bg-red-500 transition-all duration-500" style="width: 100%"></div></div>
            </div>
            <img id="enemyImg" src="" class="w-32 h-32 pixel-art animate-bounce-slow drop-shadow-xl filter grayscale-0">
        </div>
        <div class="flex flex-col items-start relative mt-4">
            <img id="playerImg" src="" class="w-40 h-40 pixel-art drop-shadow-2xl scale-x-[-1]">
            <div class="bg-white/90 p-3 rounded-xl shadow-md w-44 -mt-4 z-20 transform -translate-x-2 border-l-4 border-emerald-500">
                <div class="flex justify-between items-baseline mb-1">
                    <span id="playerName" class="font-bold text-sm text-slate-800">?</span>
                    <span id="playerLevel" class="text-[10px] text-slate-500">Lv.1</span>
                </div>
                <div class="flex justify-between text-[10px] text-slate-500 mb-0.5"><span>HP</span><span id="playerHpText">0/0</span></div>
                <div class="w-full h-2.5 bg-slate-200 rounded-full overflow-hidden"><div id="playerHpBar" class="h-full bg-emerald-500 transition-all duration-500" style="width: 100%"></div></div>
                <div class="w-full h-1 bg-slate-100 rounded-full mt-1 overflow-hidden"><div id="playerExpBar" class="h-full bg-sky-400 transition-all" style="width: 0%"></div></div>
            </div>
        </div>
    </div>
    <div class="w-full max-w-md bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] p-5 z-20">
        <div id="battleLog" class="text-xs text-slate-500 mb-3 h-6 overflow-y-hidden text-center italic">ì „íˆ¬ ì‹œì‘!</div>
        <div id="moveButtons" class="grid grid-cols-2 gap-3"></div>
    </div>
</section>

<div id="hofModal" class="fixed inset-0 bg-slate-900 z-50 hidden flex-col items-center justify-center">
    <div class="w-full max-w-md bg-white p-6 rounded-2xl shadow-2xl m-4 max-h-[80vh] flex flex-col">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-black text-slate-800">ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</h3>
            <button id="hofClose" class="text-slate-400 hover:text-slate-600 font-bold">ë‹«ê¸°</button>
        </div>
        <div id="hofList" class="flex-1 overflow-y-auto space-y-3">
            <p class="text-center text-slate-400 py-10">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ëª¨í—˜ì„ ë– ë‚˜ë³´ì„¸ìš”!</p>
        </div>
    </div>
</div>

<div id="gachaModal" class="fixed inset-0 bg-slate-900 z-50 hidden flex-col items-center justify-center">
    <div class="w-full max-w-lg p-6 flex flex-col h-full md:h-auto">
        <div class="flex justify-between items-center mb-6 text-white">
            <div><h3 class="text-2xl font-bold">ëª¬ìŠ¤í„° ì†Œí™˜</h3><p class="text-xs opacity-70" id="gachaResDisplay"></p></div>
            <button id="gachaClose" class="bg-white/20 hover:bg-white/30 rounded-full p-2"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
        </div>
        <div id="gachaScene" class="flex-1 bg-slate-800 rounded-2xl border border-slate-700 p-4 overflow-y-auto mb-4 min-h-[300px] flex items-center justify-center relative">
            <div id="gachaPlaceholder" class="text-center text-slate-500">
                <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" class="w-24 h-24 mx-auto mb-4 opacity-20 grayscale"><p>ì†Œí™˜ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”</p>
            </div>
            <div id="gachaResultsGrid" class="grid grid-cols-3 sm:grid-cols-4 gap-3 w-full hidden"></div>
        </div>
        <div class="flex gap-3 mb-2">
            <button id="gachaNormalBtn" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1">
                <span class="block text-xs opacity-80">100 P</span>ì¼ë°˜ ì†Œí™˜
            </button>
            <button id="gachaSpecialBtn" class="flex-1 bg-yellow-500 hover:bg-yellow-400 text-white py-3 rounded-xl shadow-lg border-b-4 border-yellow-700 active:border-b-0 active:translate-y-1 relative overflow-hidden">
                <div class="absolute inset-0 bg-white opacity-10 animate-pulse"></div>
                <span class="block text-xs opacity-80 font-bold text-yellow-900">ğŸ« í™©ê¸ˆ í‹°ì¼“ 1ì¥</span>
                <span class="font-bold text-yellow-900">ì „ì„¤ ì†Œí™˜</span>
            </button>
        </div>
        <p class="text-center text-[10px] text-slate-400">* ì „ì„¤ ì†Œí™˜: 50% í™•ë¥ ë¡œ SR(ì „ì„¤/í™˜ìƒ) íšë“</p>
    </div>
</div>

<div id="quizModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm overflow-hidden transform transition-all scale-100">
        <div class="bg-slate-800 p-4 text-white flex justify-between items-center">
            <h3 class="font-bold text-lg">ğŸ“ ìˆ˜í•™ í€´ì¦ˆ</h3><span class="text-xs bg-slate-700 px-2 py-1 rounded text-yellow-300">ì •ë‹µ ì‹œ ê³µê²©</span>
        </div>
        <div class="p-6">
            <div class="text-center mb-6"><p class="text-3xl font-black text-slate-800 tracking-wider" id="quizQuestion">?</p></div>
            <div id="quizChoices" class="grid grid-cols-2 gap-3"></div>
        </div>
        <div class="bg-slate-50 p-3 text-center border-t"><button id="quizCancel" class="text-xs text-slate-400 hover:text-slate-600 underline">í¬ê¸°í•˜ê¸°</button></div>
    </div>
</div>

<div id="rewardModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 text-center">
        <h3 class="text-2xl font-black text-slate-800 mb-2">VICTORY!</h3>
        <div class="text-xs text-sky-600 font-bold mb-4 bg-sky-50 inline-block px-3 py-1 rounded-full">EXP <span id="rewardXpVal">0</span> íšë“!</div>
        <p class="text-sm text-slate-500 mb-2" id="rewardTitle">ë³´ìƒì„ ì„ íƒí•˜ì„¸ìš”</p>
        <div class="grid grid-cols-1 gap-3" id="rewardButtons"></div>
    </div>
</div>

<div id="messageModal" class="fixed inset-0 modal-backdrop hidden items-center justify-center z-[60] p-6">
    <div class="bg-white rounded-xl shadow-xl w-full max-w-xs p-5 text-center">
        <h3 id="messageTitle" class="text-lg font-bold text-slate-800 mb-2">ì•Œë¦¼</h3>
        <p id="messageBody" class="text-sm text-slate-600 mb-4 break-keep"></p>
        <button id="messageOk" class="w-full py-2.5 rounded-lg bg-slate-800 text-white text-sm font-bold">í™•ì¸</button>
    </div>
</div>

<script>
    /* =========================================
     * DATA
     * ========================================= */
    const POKE_NAMES_STR = "ì´ìƒí•´ì”¨,ì´ìƒí•´í’€,ì´ìƒí•´ê½ƒ,íŒŒì´ë¦¬,ë¦¬ìë“œ,ë¦¬ìëª½,ê¼¬ë¶€ê¸°,ì–´ë‹ˆë¶€ê¸°,ê±°ë¶ì™•,ìºí„°í”¼,ë‹¨ë°ê¸°,ë²„í„°í”Œ,ë¿”ì¶©ì´,ë”±ì¶©ì´,ë…ì¹¨ë¶•,êµ¬êµ¬,í”¼ì£¤,í”¼ì£¤íˆ¬,ê¼¬ë ›,ë ˆíŠ¸ë¼,ê¹¨ë¹„ì°¸,ê¹¨ë¹„ë“œë¦´ì¡°,ì•„ë³´,ì•„ë³´í¬,í”¼ì¹´ì¸„,ë¼ì´ì¸„,ëª¨ë˜ë‘ì§€,ê³ ì§€,ë‹ˆë“œëŸ°â™€,ë‹ˆë“œë¦¬ë‚˜,ë‹ˆë“œí€¸,ë‹ˆë“œëŸ°â™‚,ë‹ˆë“œë¦¬ë…¸,ë‹ˆë“œí‚¹,ì‚ì‚,í”½ì‹œ,ì‹ìŠ¤í…Œì¼,ë‚˜ì¸í…Œì¼,í‘¸ë¦°,í‘¸í¬ë¦°,ì£¼ë±ƒ,ê³¨ë±ƒ,ëšœë²…ìµ¸,ëƒ„ìƒˆê¼¬,ë¼í”Œë ˆì‹œì•„,íŒŒë¼ìŠ¤,íŒŒë¼ì„¹íŠ¸,ì½˜íŒ¡,ë„ë‚˜ë¦¬,ë””ê·¸ë‹¤,ë‹¥íŠ¸ë¦¬ì˜¤,ë‚˜ì˜¹,í˜ë¥´ì‹œì˜¨,ê³ ë¼íŒŒë•,ê³¨ë•,ë§í‚¤,ì„±ì›ìˆ­,ê°€ë””,ìœˆë””,ë°œì±™ì´,ìŠˆë¥™ì±™ì´,ê°•ì±™ì´,ìºì´ì‹œ,ìœ¤ê²”ë¼,í›„ë”˜,ì•Œí†µëª¬,ê·¼ìœ¡ëª¬,ê´´ë ¥ëª¬,ëª¨ë‹¤í”¼,ìš°ì¸ ë™,ìš°ì¸ ë³´íŠ¸,ì™•ëˆˆí•´,ë…íŒŒë¦¬,ê¼¬ë§ˆëŒ,ë°êµ¬ë¦¬,ë”±êµ¬ë¦¬,í¬ë‹ˆíƒ€,ë‚ ìŒ©ë§ˆ,ì•¼ëˆ,ì•¼ë„ë€,ì½”ì¼,ë ˆì–´ì½”ì¼,íŒŒì˜¤ë¦¬,ë‘ë‘,ë‘íŠ¸ë¦¬ì˜¤,ì¥¬ì¥¬,ì¥¬ë ˆê³¤,ì§ˆí½ì´,ì§ˆë»ê¸°,ì…€ëŸ¬,íŒŒë¥´ì…€,ê³ ì˜¤ìŠ¤,ê³ ìš°ìŠ¤íŠ¸,íŒ¬í…€,ë¡±ìŠ¤í†¤,ìŠ¬ë¦¬í”„,ìŠ¬ë¦¬í¼,í¬ë©,í‚¹í¬ë©,ì°Œë¦¬ë¦¬ê³µ,ë¶ë³¼,ì•„ë¼ë¦¬,ë‚˜ì‹œ,íƒ•êµ¬ë¦¬,í……êµ¬ë¦¬,ì‹œë¼ì†Œëª¬,í™ìˆ˜ëª¬,ë‚´ë£¨ë¯¸,ë˜ê°€ìŠ¤,ë˜ë„ê°€ìŠ¤,ë¿”ì¹´ë…¸,ì½”ë¿Œë¦¬,ëŸ­í‚¤,ë©ì¿ ë¦¬,ìº¥ì¹´,ì˜ë“œë¼,ì‹œë“œë¼,ì½˜ì¹˜,ì™•ì½˜ì¹˜,ë³„ê°€ì‚¬ë¦¬,ì•„ì¿ ìŠ¤íƒ€,ë§ˆì„ë§¨,ìŠ¤í„±,ë£¨ì£¼ë¼,ì—ë ˆë¸Œ,ë§ˆê·¸ë§ˆ,ì˜ì‚¬ì´ì €,ì¼„íƒ€ë¡œìŠ¤,ì‰ì–´í‚¹,ê°¸ë¼ë„ìŠ¤,ë¼í”„ë¼ìŠ¤,ë©”íƒ€ëª½,ì´ë¸Œì´,ìƒ¤ë¯¸ë“œ,ì¥¬í”¼ì¬ë”,ë¶€ìŠ¤í„°,í´ë¦¬ê³¤,ì•”ë‚˜ì´íŠ¸,ì•”ìŠ¤íƒ€,íˆ¬êµ¬,íˆ¬êµ¬í‘¸ìŠ¤,í”„í…Œë¼,ì ë§Œë³´,í”„ë¦¬ì ¸,ì¬ë”,íŒŒì´ì–´,ë¯¸ë‡½,ì‹ ë‡½,ë§ë‚˜ë‡½,ë®¤ì¸ ,ë®¤";
    const POKE_NAMES = POKE_NAMES_STR.split(",");

    const LEGENDARY_IDS = [144,145,146,150,151]; // í”„ë¦¬ì ¸, ì¬ë”, íŒŒì´ì–´, ë®¤ì¸ , ë®¤

    const TYPE_DATA = {
        "í’€": { color: "bg-green-500", weak: ["ë¶ˆê½ƒ", "ë…", "ì–¼ìŒ", "ë¹„í–‰", "ë²Œë ˆ"], resist: ["ë¬¼", "ì „ê¸°", "í’€", "ë•…"] },
        "ë¶ˆê½ƒ": { color: "bg-red-500", weak: ["ë¬¼", "ë•…", "ë°”ìœ„"], resist: ["ë¶ˆê½ƒ", "í’€", "ì–¼ìŒ", "ë²Œë ˆ", "ê°•ì² ", "í˜ì–´ë¦¬"] },
        "ë¬¼": { color: "bg-blue-500", weak: ["ì „ê¸°", "í’€"], resist: ["ë¶ˆê½ƒ", "ë¬¼", "ì–¼ìŒ", "ê°•ì² "] },
        "ì „ê¸°": { color: "bg-yellow-400", weak: ["ë•…"], resist: ["ì „ê¸°", "ë¹„í–‰", "ê°•ì² "] },
        "ë…¸ë§": { color: "bg-stone-400", weak: ["ê²©íˆ¬"], resist: [] },
        "ì—ìŠ¤í¼": { color: "bg-pink-400", weak: ["ë²Œë ˆ", "ê³ ìŠ¤íŠ¸", "ì•…"], resist: ["ê²©íˆ¬", "ì—ìŠ¤í¼"] },
        "ê²©íˆ¬": { color: "bg-orange-600", weak: ["ë¹„í–‰", "ì—ìŠ¤í¼", "í˜ì–´ë¦¬"], resist: ["ë²Œë ˆ", "ë°”ìœ„", "ì•…"] },
        "ë…": { color: "bg-purple-500", weak: ["ë•…", "ì—ìŠ¤í¼"], resist: ["í’€", "ê²©íˆ¬", "ë…", "ë²Œë ˆ", "í˜ì–´ë¦¬"] },
    };
    const TYPE_KEYS = Object.keys(TYPE_DATA);

    const MOVE_POOL = {
        "í’€": [{n:"ë©êµ´ì±„ì°", p:45, a:100, t:1}, {n:"ìë‚ ê°€ë¥´ê¸°", p:55, a:95, t:1}, {n:"ì—ë„ˆì§€ë³¼", p:90, a:100, t:2}, {n:"ì†”ë¼ë¹”", p:120, a:100, t:3}],
        "ë¶ˆê½ƒ": [{n:"ë¶ˆê½ƒì„¸ë¡€", p:40, a:100, t:1}, {n:"ë‹ˆíŠ¸ë¡œì°¨ì§€", p:50, a:100, t:1}, {n:"í™”ì—¼ë°©ì‚¬", p:90, a:100, t:2}, {n:"ë¶ˆëŒ€ë¬¸ì", p:110, a:85, t:3}],
        "ë¬¼": [{n:"ë¬¼ëŒ€í¬", p:40, a:100, t:1}, {n:"ë¬¼ì˜íŒŒë™", p:60, a:100, t:1}, {n:"íŒŒë„íƒ€ê¸°", p:90, a:100, t:2}, {n:"í•˜ì´ë“œë¡œíŒí”„", p:110, a:80, t:3}],
        "ì „ê¸°": [{n:"ì „ê¸°ì‡¼í¬", p:40, a:100, t:1}, {n:"ì „ê´‘ì„í™”", p:40, a:100, t:1}, {n:"10ë§Œë³¼íŠ¸", p:90, a:100, t:2}, {n:"ë²ˆê°œ", p:110, a:70, t:3}],
        "ë…¸ë§": [{n:"ëª¸í†µë°•ì¹˜ê¸°", p:40, a:100, t:1}, {n:"í• í€´ê¸°", p:40, a:100, t:1}, {n:"ëˆ„ë¥´ê¸°", p:85, a:100, t:2}, {n:"íŒŒê´´ê´‘ì„ ", p:150, a:90, t:3}],
        "ì—ìŠ¤í¼": [{n:"ì—¼ë™ë ¥", p:50, a:100, t:1}, {n:"í™˜ìƒë¹”", p:65, a:100, t:1}, {n:"ì‚¬ì´ì½”í‚¤ë„¤ì‹œìŠ¤", p:90, a:100, t:2}, {n:"ë¯¸ë˜ì˜ˆì§€", p:120, a:100, t:3}],
        "ê²©íˆ¬": [{n:"ë°”ìœ„ê¹¨ê¸°", p:40, a:100, t:1}, {n:"ì•ˆë‹¤ë¦¬ê±¸ê¸°", p:60, a:100, t:1}, {n:"ì§€ì˜¥ì˜ë°”í€´", p:80, a:80, t:2}, {n:"ì¸íŒŒì´íŠ¸", p:120, a:100, t:3}],
        "ë…": [{n:"ìš©í•´ì•¡", p:40, a:100, t:1}, {n:"ë…ì¹¨", p:15, a:100, t:1}, {n:"ì˜¤ë¬¼í­íƒ„", p:90, a:100, t:2}, {n:"ë”ìŠ¤íŠ¸ìŠˆíŠ¸", p:120, a:80, t:3}]
    };

    function getPokeInfo(id) {
        if (id > 151) id = (id % 151) + 1;
        const name = POKE_NAMES[id - 1] || `No.${id}`;
        let rarity = "C";
        if (LEGENDARY_IDS.includes(id)) rarity = "SR";
        else if (id % 10 === 0 || [3,6,9,130,131,143,149].includes(id)) rarity = "R";

        let typeIdx = 4;
        if ([1,2,3,43,44,45,69,70,71].includes(id)) typeIdx = 0;
        else if ([4,5,6,37,38,58,59,77].includes(id)) typeIdx = 1;
        else if ([7,8,9,54,55,60,61,62].includes(id)) typeIdx = 2;
        else if ([25,26,81,82,100,101].includes(id)) typeIdx = 3;
        else if ([63,64,65,96,97,150,151].includes(id)) typeIdx = 5;
        else if ([56,57,66,67,68].includes(id)) typeIdx = 6;
        else if ([13,14,15,23,24,29,30,31].includes(id)) typeIdx = 7;

        const typeName = TYPE_KEYS[typeIdx];
        return { id, name, rarity, type: { name: typeName, ...TYPE_DATA[typeName] }, sprite: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png` };
    }

    function getRandomMoves(typeName, maxTier = 3) {
        const pool = MOVE_POOL[typeName] || MOVE_POOL["ë…¸ë§"];
        const filtered = pool.filter(m => m.t <= maxTier);
        if (filtered.length < 2) return filtered.concat(filtered);
        const moves = [];
        const idx1 = Math.floor(Math.random() * filtered.length);
        let idx2 = Math.floor(Math.random() * filtered.length);
        while(idx1 === idx2 && filtered.length > 1) idx2 = Math.floor(Math.random() * filtered.length);
        return [filtered[idx1], filtered[idx2]];
    }

    /* =========================================
     * STATE & LOGIC
     * ========================================= */
    const LS_KEY = { POINTS: "qz_p_v3", OWNED: "qz_o_v3", PARTNER: "qz_st_v3", HOF: "qz_hof_v3", TICKETS: "qz_t_v3" };

    let battleState = null;
    let quizCallback = null;

    // Global Save Data
    function getPoints() { return parseInt(localStorage.getItem(LS_KEY.POINTS) || "500", 10); }
    function setPoints(n) { localStorage.setItem(LS_KEY.POINTS, Math.max(0, n)); updateResUI(); }
    function addPoints(n) { setPoints(getPoints() + n); }

    function getTickets() { return parseInt(localStorage.getItem(LS_KEY.TICKETS) || "0", 10); }
    function setTickets(n) { localStorage.setItem(LS_KEY.TICKETS, Math.max(0, n)); updateResUI(); }
    function addTickets(n) { setTickets(getTickets() + n); }

    function getOwned() { try { return new Set(JSON.parse(localStorage.getItem(LS_KEY.OWNED) || "[]")); } catch { return new Set(); } }
    function saveOwned(set) { localStorage.setItem(LS_KEY.OWNED, JSON.stringify([...set])); }

    function getStarterId() { return parseInt(localStorage.getItem(LS_KEY.PARTNER) || "0"); }
    function setStarterId(id) { localStorage.setItem(LS_KEY.PARTNER, id); updateLobbyPartner(); }

    function getHoF() { try { return JSON.parse(localStorage.getItem(LS_KEY.HOF) || "[]"); } catch { return []; } }
    function addHoF(record) {
        const list = getHoF();
        list.push(record);
        list.sort((a,b) => b.stage - a.stage);
        localStorage.setItem(LS_KEY.HOF, JSON.stringify(list.slice(0, 5)));
    }

    function updateResUI() {
        const p = getPoints().toLocaleString();
        const t = getTickets().toLocaleString();
        document.getElementById("pointsTextLobby").textContent = p;
        document.getElementById("ticketTextLobby").textContent = t;
        document.getElementById("gachaResDisplay").textContent = `P: ${p} / ğŸ«: ${t}`;
    }

    function updateLobbyPartner() {
        const pid = getStarterId();
        if (pid > 0) {
            const info = getPokeInfo(pid);
            document.getElementById("lobbyPartnerName").textContent = info.name;
            document.getElementById("lobbyPartnerImg").src = info.sprite;
            document.getElementById("partnerInfo").textContent = info.name;
            document.getElementById("startAdventureBtn").disabled = false;
        } else {
            document.getElementById("lobbyPartnerName").textContent = "ì—†ìŒ";
            document.getElementById("partnerInfo").textContent = "ì„ íƒ í•„ìš”";
            document.getElementById("startAdventureBtn").disabled = true;
        }
    }

    function renderCodex() {
        const grid = document.getElementById("codexGrid");
        grid.innerHTML = "";
        const owned = getOwned();
        const pid = getStarterId();
        let count = 0;
        for (let i = 1; i <= 151; i++) {
            const info = getPokeInfo(i);
            if(owned.has(i)) count++;
            const el = document.createElement("div");
            el.className = `poke-card relative rounded-xl p-2 flex flex-col items-center cursor-pointer rarity-${info.rarity}`;
            if (!owned.has(i)) el.classList.add("opacity-50", "grayscale");
            if (pid === i) el.classList.add("ring-4", "ring-emerald-400");

            el.innerHTML = `
                <div class="absolute top-1 left-1 text-[9px] font-bold text-slate-400">#${String(i).padStart(3,'0')}</div>
                <div class="w-12 h-12 mt-2"><img src="${owned.has(i) ? info.sprite : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png'}" class="w-full h-full pixel-art object-contain ${!owned.has(i)?'opacity-20':''}"></div>
                <div class="text-[10px] font-bold truncate mt-1">${owned.has(i) ? info.name : '???'}</div>
            `;
            el.onclick = () => {
                if(!owned.has(i)) { showAlert("ë¯¸ë³´ìœ ", "ê°€ì± ë¡œ ë¨¼ì € íšë“í•˜ì„¸ìš”."); return; }
                setStarterId(i); renderCodex();
            };
            grid.appendChild(el);
        }
        document.getElementById("collectionRate").textContent = `${count}/151`;
    }

    function renderHoF() {
        const list = getHoF();
        const container = document.getElementById("hofList");
        container.innerHTML = "";
        if(list.length === 0) {
            container.innerHTML = '<p class="text-center text-slate-400 py-10">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        list.forEach((rec, idx) => {
            const div = document.createElement("div");
            div.className = "hof-item border-2 rounded-xl p-3 flex items-center gap-3 relative";
            div.innerHTML = `
                <div class="font-black text-2xl w-8 text-center text-slate-400 italic">#${idx+1}</div>
                <img src="${rec.sprite}" class="w-12 h-12 pixel-art bg-white rounded-full border border-slate-200">
                <div class="flex-1">
                    <div class="font-bold text-slate-800">${rec.name} <span class="text-xs font-normal text-slate-500">(${rec.date})</span></div>
                    <div class="text-xs text-slate-600">ìµœì¢… ìŠ¤í…Œì´ì§€: <span class="text-red-500 font-bold text-base">${rec.stage}</span></div>
                    <div class="text-[10px] text-slate-400 mt-1">ê¸°ìˆ : ${rec.moves.map(m=>m.n).join(", ")}</div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    /* =========================================
     * ROGUELIKE BATTLE SYSTEM
     * ========================================= */
    function initAdventure() {
        const pid = getStarterId();
        if (!pid) return;

        // [ë¡œê·¸ë¼ì´í¬ í•µì‹¬] ë§¤ íŒ ìƒˆë¡œ ìƒì„±
        const info = getPokeInfo(pid);
        let baseStat = 20;
        if (info.rarity === 'R') baseStat = 25;
        if (info.rarity === 'SR') baseStat = 35;

        battleState = {
            stage: 1,
            player: {
                id: pid, name: info.name, sprite: info.sprite, type: info.type.name,
                level: 1, xp: 0,
                maxHp: baseStat * 4, hp: baseStat * 4, atk: baseStat,
                moves: getRandomMoves(info.type.name, 1) // 1í‹°ì–´ ìŠ¤í‚¬ë¡œ ì´ˆê¸°í™”
            }
        };

        startBattleStage();
        document.getElementById("titleScreen").classList.remove("active");
        document.getElementById("codexScreen").classList.remove("active");
        document.getElementById("battleScreen").classList.add("active");
    }

    function startBattleStage() {
        const { stage, player } = battleState;

        // [ì „ì„¤ ë‚œì… ì‹œìŠ¤í…œ] 5% í™•ë¥ ë¡œ ì „ì„¤ ë“±ì¥
        let enemyId;
        let isLegendaryEncounter = Math.random() < 0.05;

        if (isLegendaryEncounter) enemyId = LEGENDARY_IDS[Math.floor(Math.random() * LEGENDARY_IDS.length)];
        else enemyId = Math.floor(Math.random() * 151) + 1;

        const eInfo = getPokeInfo(enemyId);
        const eLevel = stage + Math.floor(player.level * 0.5);
        const isBoss = eInfo.rarity === 'SR';

        const eMaxHp = (30 + eLevel * 5) * (isBoss ? 2.0 : 1.0); // ë³´ìŠ¤ëŠ” ì²´ë ¥ 2ë°°
        const eAtk = (5 + eLevel * 1.5) * (isBoss ? 1.2 : 1.0);
        const eMoves = getRandomMoves(eInfo.type.name, 1);

        battleState.enemy = {
            id: enemyId, name: eInfo.name, sprite: eInfo.sprite, type: eInfo.type.name,
            maxHp: eMaxHp, hp: eMaxHp, atk: eAtk, level: eLevel, move: eMoves[0],
            isBoss: isBoss
        };

        updateBattleUI();
        logBattle(isBoss ? `âš ï¸ ì•¼ìƒì˜ ì „ì„¤ ${eInfo.name} ë“±ì¥!!` : `ì•¼ìƒì˜ ${eInfo.name} (Lv.${eLevel}) ë“±ì¥!`, isBoss ? 'critical' : 'normal');
    }

    function updateBattleUI() {
        const { player, enemy } = battleState;
        document.getElementById("battleStageText").textContent = battleState.stage;

        document.getElementById("playerName").textContent = player.name;
        document.getElementById("playerLevel").textContent = `Lv.${player.level}`;
        document.getElementById("playerImg").src = player.sprite;
        document.getElementById("playerHpText").textContent = `${Math.ceil(player.hp)}/${Math.ceil(player.maxHp)}`;
        document.getElementById("playerHpBar").style.width = `${Math.max(0, (player.hp/player.maxHp)*100)}%`;
        document.getElementById("playerExpBar").style.width = `${Math.min(100, (player.xp/(player.level*100))*100)}%`;

        document.getElementById("enemyName").textContent = enemy.name;
        document.getElementById("enemyLevel").textContent = `Lv.${enemy.level}`;
        document.getElementById("enemyImg").src = enemy.sprite;
        document.getElementById("enemyHpBar").style.width = `${Math.max(0, (enemy.hp/enemy.maxHp)*100)}%`;

        const eType = TYPE_DATA[enemy.type];
        const badge = document.getElementById("enemyTypeBadge");
        badge.textContent = enemy.type;
        badge.className = `text-[9px] text-white px-1.5 py-0.5 rounded mb-1 inline-block ${eType.color}`;

        const btnGrid = document.getElementById("moveButtons");
        btnGrid.innerHTML = "";
        player.moves.forEach((m, idx) => {
            const btn = document.createElement("button");
            let cls = "bg-white border-slate-200";
            if(m.t === 2) cls = "bg-blue-50 border-blue-200";
            if(m.t === 3) cls = "bg-yellow-50 border-yellow-300";

            btn.className = `${cls} border-b-4 active:border-b-0 active:translate-y-1 rounded-xl py-3 flex flex-col items-center justify-center hover:brightness-95 transition-all`;
            btn.innerHTML = `<span class="font-bold text-sm">${m.n}</span><span class="text-[10px] text-slate-500">ìœ„ë ¥ ${m.p} / ëª…ì¤‘ ${m.a}</span>`;
            btn.onclick = () => handlePlayerMove(m);
            btnGrid.appendChild(btn);
        });
    }

    function logBattle(msg, type="normal") {
        const log = document.getElementById("battleLog");
        log.textContent = msg;
        log.className = `text-xs font-bold mb-3 h-6 text-center overflow-hidden ${type==='critical'?'text-red-500 animate-pulse': type==='weak'?'text-blue-500':'text-slate-500 italic'}`;
    }

    function handlePlayerMove(move) {
        openQuiz((isCorrect) => {
            if(!isCorrect) {
                logBattle("í€´ì¦ˆ ì˜¤ë‹µ! ê³µê²© ì‹¤íŒ¨!");
                setTimeout(enemyTurn, 800);
                return;
            }

            // í”Œë ˆì´ì–´ ê³µê²©
            const el = document.getElementById("playerImg");
            el.classList.remove("animate-attack-player");
            void el.offsetWidth; el.classList.add("animate-attack-player");

            const hit = Math.random() * 100 <= move.a;
            const mult = hit ? 2.0 : 0.5;

            // ìƒì„±
            const typeInfo = TYPE_DATA[battleState.enemy.type];
            let eff = 1.0;
            if (typeInfo.weak.includes(battleState.player.type)) eff = 1.5;
            if (typeInfo.resist.includes(battleState.player.type)) eff = 0.8;

            let dmg = Math.floor((battleState.player.atk * move.p / 40) * eff * mult);
            dmg = Math.floor(dmg * (0.9 + Math.random()*0.2));

            setTimeout(() => {
                battleState.enemy.hp -= dmg;
                const eImg = document.getElementById("enemyImg");
                eImg.classList.remove("animate-damage");
                void eImg.offsetWidth; eImg.classList.add("animate-damage");

                let msg = "";
                if(hit) msg = eff > 1 ? `ê¸‰ì†Œ! íš¨ê³¼ê°€ êµ‰ì¥í–ˆë‹¤! (${dmg})` : `ëª…ì¤‘! (${dmg})`;
                else msg = `ë¹—ë§ìŒ... (${dmg})`;

                logBattle(msg, hit && eff > 1 ? 'critical' : (!hit ? 'weak' : 'normal'));
                updateBattleUI();

                if(battleState.enemy.hp <= 0) setTimeout(handleWin, 800);
                else setTimeout(enemyTurn, 1000);
            }, 200);
        });
    }

    function enemyTurn() {
        if(battleState.enemy.hp <= 0) return;
        const move = battleState.enemy.move;

        const eImg = document.getElementById("enemyImg");
        eImg.classList.remove("animate-attack-enemy");
        void eImg.offsetWidth; eImg.classList.add("animate-attack-enemy");

        const typeInfo = TYPE_DATA[battleState.player.type];
        let eff = 1.0;
        if (typeInfo.weak.includes(battleState.enemy.type)) eff = 1.5;
        if (typeInfo.resist.includes(battleState.enemy.type)) eff = 0.8;

        let dmg = Math.floor((battleState.enemy.atk * move.p / 50) * eff);
        if(Math.random()*100 > 85) { // ì ì€ 15% í™•ë¥ ë¡œ ë¹—ë‚˜ê° (ë‹¨ìˆœí™”)
            setTimeout(() => logBattle("ì ì˜ ê³µê²©ì´ ë¹—ë‚˜ê°”ë‹¤!"), 300);
            return;
        }

        setTimeout(() => {
            battleState.player.hp -= dmg;
            const pImg = document.getElementById("playerImg");
            pImg.classList.remove("animate-damage");
            void pImg.offsetWidth; pImg.classList.add("animate-damage");

            logBattle(`ì ì˜ ${move.n}! (${dmg})`);
            updateBattleUI();

            if(battleState.player.hp <= 0) setTimeout(handleDefeat, 800);
        }, 200);
    }

    function handleWin() {
        // ì „ì„¤ ì²˜ì¹˜ ì‹œ í‹°ì¼“ ë“œë¡­
        if(battleState.enemy.isBoss) {
            addTickets(1);
            alert("âœ¨ ì „ì„¤ì˜ í¬ì¼“ëª¬ì„ ì“°ëŸ¬ëœ¨ë ¤ [í™©ê¸ˆ í‹°ì¼“]ì„ íšë“í–ˆìŠµë‹ˆë‹¤!");
        }

        const xp = 30 + (battleState.stage * 10);
        const pt = 30 + (battleState.stage * 5);
        addPoints(pt);
        battleState.player.xp += xp;

        let lvUp = false;
        if(battleState.player.xp >= battleState.player.level * 100) {
            battleState.player.xp -= battleState.player.level * 100;
            battleState.player.level++;
            battleState.player.maxHp += 10; battleState.player.hp += 10;
            battleState.player.atk += 3;
            lvUp = true;
        }
        // íšŒë³µ
        battleState.player.hp = Math.min(battleState.player.maxHp, battleState.player.hp + Math.floor(battleState.player.maxHp * 0.5));

        document.getElementById("rewardXpVal").textContent = `${xp}${lvUp?' & Level Up!':''}`;
        document.getElementById("rewardTitle").textContent = "ë³´ìƒì„ ì„ íƒí•˜ì„¸ìš”";
        const grid = document.getElementById("rewardButtons");
        grid.innerHTML = "";

        // ë³´ìƒ ëª©ë¡
        const rewards = [
            { t: "í¬ì¸íŠ¸", d: "+100 P", f: () => { addPoints(100); nextStage(); } },
            { t: "ì™„ì „ íšŒë³µ", d: "HP 100%", f: () => { battleState.player.hp = battleState.player.maxHp; nextStage(); } },
            { t: "ê¸°ìˆ  ë¨¸ì‹ ", d: "ìŠ¤í‚¬ êµì²´/ê°•í™”", f: () => showSkillReplaceUI() }
        ];

        rewards.forEach(r => {
            const btn = document.createElement("button");
            btn.className = "w-full py-3 bg-slate-100 hover:bg-indigo-50 border rounded-xl";
            btn.innerHTML = `<b>${r.t}</b> <span class="text-xs text-slate-500">${r.d}</span>`;
            btn.onclick = () => {
                if(r.t !== "ê¸°ìˆ  ë¨¸ì‹ ") document.getElementById("rewardModal").classList.add("hidden");
                r.f();
            };
            grid.appendChild(btn);
        });
        document.getElementById("rewardModal").classList.remove("hidden");
    }

    // [ë²„ê·¸ ìˆ˜ì •] ê¸°ìˆ  êµì²´ ë¡œì§
    function showSkillReplaceUI() {
        document.getElementById("rewardTitle").textContent = "êµì²´í•  ìŠ¤í‚¬ ìŠ¬ë¡¯ì„ ì„ íƒí•˜ì„¸ìš” (í´ë¦­ ì‹œ ì¦‰ì‹œ ë³€ê²½)";
        const grid = document.getElementById("rewardButtons");
        grid.innerHTML = "";

        battleState.player.moves.forEach((m, idx) => {
            const btn = document.createElement("button");
            let cls = "bg-white border-slate-200";
            if(m.t === 2) cls = "bg-blue-50 border-blue-200";
            if(m.t === 3) cls = "bg-yellow-50 border-yellow-300";

            btn.className = `w-full py-4 ${cls} border rounded-xl hover:brightness-95 flex flex-col items-center`;
            btn.innerHTML = `<span class="font-bold">${m.n}</span><span class="text-xs">Tier ${m.t}</span>`;

            btn.onclick = () => {
                // ì¦‰ì‹œ êµì²´ ë° ì§„í–‰
                const newMoves = getRandomMoves(battleState.player.type, 3);
                const otherMove = battleState.player.moves[idx===0?1:0];
                let pick = newMoves[0].n === otherMove.n ? newMoves[1] : newMoves[0]; // ì¤‘ë³µ íšŒí”¼

                battleState.player.moves[idx] = pick;

                // ëª¨ë‹¬ ë‹«ê¸° ë° ìŠ¤í…Œì´ì§€ ì´ë™ (ìˆœì°¨ ì²˜ë¦¬)
                document.getElementById("rewardModal").classList.add("hidden");
                alert(`[${pick.n}] ê¸°ìˆ ì„ ë°°ì› ìŠµë‹ˆë‹¤!`);
                nextStage();
            };
            grid.appendChild(btn);
        });
    }

    function nextStage() {
        battleState.stage++;
        startBattleStage();
    }

    function handleDefeat() {
        // ëª…ì˜ˆì˜ ì „ë‹¹ ë“±ë¡
        addHoF({
            name: battleState.player.name,
            sprite: battleState.player.sprite,
            stage: battleState.stage,
            moves: battleState.player.moves,
            date: new Date().toLocaleDateString()
        });

        alert(`ê²Œì„ ì˜¤ë²„!\nìµœì¢… ìŠ¤í…Œì´ì§€: ${battleState.stage}`);
        document.getElementById("battleScreen").classList.remove("active");
        document.getElementById("lobbyScreen").classList.add("active");
        updateResUI();
    }

    /* =========================================
     * GACHA SYSTEM
     * ========================================= */
    function playGacha(type) { // 'normal' or 'special'
        const cost = type === 'normal' ? 100 : 1;
        const currency = type === 'normal' ? getPoints() : getTickets();

        if(currency < cost) {
            showAlert("ì¬í™” ë¶€ì¡±", type === 'normal' ? "í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤." : "í™©ê¸ˆ í‹°ì¼“ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
            return;
        }

        if(type === 'normal') setPoints(getPoints() - cost);
        else setTickets(getTickets() - cost);

        document.getElementById("gachaPlaceholder").classList.add("hidden");
        const grid = document.getElementById("gachaResultsGrid");
        grid.classList.remove("hidden");
        grid.innerHTML = "";

        const owned = getOwned();
        // [íŠ¹ìˆ˜ ê°€ì±  ë¡œì§]
        // normal: 1~151 ëœë¤
        // special: 50% í™•ë¥ ë¡œ LEGENDARY_IDS, 50% í™•ë¥ ë¡œ ì¼ë°˜
        let pickId;
        if (type === 'special') {
            if (Math.random() < 0.5) {
                pickId = LEGENDARY_IDS[Math.floor(Math.random() * LEGENDARY_IDS.length)];
            } else {
                pickId = Math.floor(Math.random() * 151) + 1;
            }
        } else {
            pickId = Math.floor(Math.random() * 151) + 1;
        }

        const pInfo = getPokeInfo(pickId);
        const isNew = !owned.has(pickId);
        owned.add(pickId);
        saveOwned(owned);

        const item = document.createElement("div");
        item.className = `flex flex-col items-center p-3 rounded-xl animate-bounce ${pInfo.rarity==='SR'?'bg-yellow-100 border-2 border-yellow-500':'bg-slate-700'}`;
        item.innerHTML = `
            <div class="w-16 h-16 bg-slate-600 rounded-full flex items-center justify-center mb-2 relative">
                <img src="${pInfo.sprite}" class="w-12 h-12 pixel-art">
                ${isNew ? '<span class="absolute -top-1 -right-1 bg-red-500 text-white text-[9px] px-1 rounded font-bold">NEW</span>' : ''}
            </div>
            <div class="text-[10px] ${pInfo.rarity==='SR'?'text-yellow-800 font-black':'text-white'} font-bold text-center">${pInfo.name}</div>
        `;
        grid.appendChild(item);
        updateResUI();
        renderCodex(); // ë„ê° ê°±ì‹ 
    }

    /* =========================================
     * UTILS
     * ========================================= */
    function openQuiz(cb) {
        quizCallback = cb;
        const qData = generateMath();
        document.getElementById("quizQuestion").textContent = qData.q;
        const grid = document.getElementById("quizChoices");
        grid.innerHTML = "";
        qData.choices.forEach(c => {
            const btn = document.createElement("button");
            btn.className = "bg-slate-100 hover:bg-sky-100 border-2 border-slate-200 font-bold py-4 rounded-xl text-lg";
            btn.textContent = c;
            btn.onclick = () => { document.getElementById("quizModal").classList.add("hidden"); if(quizCallback) quizCallback(c===qData.a); };
            grid.appendChild(btn);
        });
        document.getElementById("quizModal").classList.remove("hidden");
    }

    function generateMath() {
        // 0~20 ë²”ìœ„
        const t = Math.floor(Math.random()*3);
        let q="", a=0;
        if(t===0) { const n1=r(20), n2=r(20-n1); a=n1+n2; q=`${n1} + ${n2} = ?`; }
        else if(t===1) { const n1=r(20), n2=r(n1); a=n1-n2; q=`${n1} - ${n2} = ?`; }
        else { const target=r(20), n1=r(target); a=target-n1; q=`${n1} + â–¡ = ${target}`; }

        const s = new Set([a]);
        while(s.size<4) { const f = a + (r(9)-4); if(f>=0 && f<=25 && f!==a) s.add(f); }
        return {q, a, choices: Array.from(s).sort(()=>Math.random()-0.5)};
    }
    function r(n) { return Math.floor(Math.random()*(n+1)); }

    function showAlert(t, b) {
        document.getElementById("messageTitle").textContent = t;
        document.getElementById("messageBody").textContent = b;
        document.getElementById("messageModal").classList.remove("hidden");
        document.getElementById("messageOk").onclick = () => document.getElementById("messageModal").classList.add("hidden");
    }

    /* =========================================
     * INIT
     * ========================================= */
    window.onload = () => {
        updateResUI(); updateLobbyPartner();

        // Navigation
        document.getElementById("startButton").onclick = () => {
            document.getElementById("titleScreen").classList.remove("active");
            document.getElementById("lobbyScreen").classList.add("active");
        };
        document.getElementById("lobbyCodexBtn").onclick = () => { renderCodex(); document.getElementById("lobbyScreen").classList.remove("active"); document.getElementById("codexScreen").classList.add("active"); };
        document.getElementById("codexToLobbyBtn").onclick = () => { document.getElementById("codexScreen").classList.remove("active"); document.getElementById("lobbyScreen").classList.add("active"); };

        // Gacha
        document.getElementById("lobbyGachaBtn").onclick = () => document.getElementById("gachaModal").classList.remove("hidden");
        document.getElementById("gachaClose").onclick = () => document.getElementById("gachaModal").classList.add("hidden");
        document.getElementById("gachaNormalBtn").onclick = () => playGacha('normal');
        document.getElementById("gachaSpecialBtn").onclick = () => playGacha('special');

        // Adventure
        document.getElementById("startAdventureBtn").onclick = initAdventure;
        document.getElementById("battleBackBtn").onclick = () => { if(confirm("í¬ê¸°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) handleDefeat(); };
        document.getElementById("quizCancel").onclick = () => { document.getElementById("quizModal").classList.add("hidden"); if(quizCallback) quizCallback(false); };

        // Hall of Fame
        document.getElementById("lobbyHofBtn").onclick = () => { renderHoF(); document.getElementById("hofModal").classList.remove("hidden"); };
        document.getElementById("hofClose").onclick = () => document.getElementById("hofModal").classList.add("hidden");
    };
</script>
</body>
</html>